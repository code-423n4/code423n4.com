{
  "circa": {
    "title": "Mochi contest",
    "sponsor": "Mochi",
    "slug": "2021-10-mochi",
    "date": "2021-11-23",
    "findings": "https://github.com/code-423n4/2021-10-mochi-findings/issues",
    "contest": 42
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of the Mochi smart contract system written in Solidity. The code contest took place between October 21—October 27 2021.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>16 Wardens contributed reports to the Mochi code contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/jonah1005w\">jonah1005</a></li>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li>harleythedog</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li><a href=\"http://twitter.com/_nikitastupin\">nikitastupin</a></li>\n<li><a href=\"https://twitter.com/loop_225\">loop</a></li>\n<li>pants</li>\n<li>0x0x0x</li>\n<li>hyh</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/Ghoulsol\">Ghoul.sol</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/CloudEllie1\">CloudEllie</a> and <a href=\"https://twitter.com/money_lego\">moneylegobatman</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 38 unique vulnerabilities and 89 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 13 received a risk rating in the category of HIGH severity, 15 received a risk rating in the category of MEDIUM severity, and 10 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 18 non-critical recommendations and 33 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-10-mochi\">C4 Mochi contest repository</a>, and is composed of 70 smart contracts written in the Solidity programming language and includes 3,828 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-13\" style=\"position:relative;\"><a href=\"#high-risk-findings-13\" aria-label=\"high risk findings 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (13)</h1>\n<h2 id=\"h-01-vault-fails-to-track-debt-correctly-that-leads-to-bad-debt\" style=\"position:relative;\"><a href=\"#h-01-vault-fails-to-track-debt-correctly-that-leads-to-bad-debt\" aria-label=\"h 01 vault fails to track debt correctly that leads to bad debt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/72\">[H-01] Vault fails to track debt correctly that leads to bad debt</a></h2>\n<p><em>Submitted by jonah1005, also found by WatchPug</em></p>\n<h4 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>It’s similar to the issue “misuse amount as increasing debt in the vault contract”.\nSimilar issue in a different place that leads to different exploit patterns and severity.</p>\n<p>When users borrow usdm from a vault, the debt increases by the amount * 1.005.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">increasingDebt</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1005</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>However, when the contract records the total debt it uses <code>_amount</code> instead of <code>increasingDebt</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">details</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debtIndex</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">details</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debtIndex</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">totalDebt</span><span class=\"mtk1\">)) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">details</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">details</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalDebt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">details</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Status</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Active</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">debts</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol#L242-L249\">MochiVault.sol L242-L249</a></p>\n<p>The contract’s debt is inconsistent with the total sum of all users’ debt. The bias increases overtime and would break the vault at the end.</p>\n<p>For simplicity, we assume there’s only one user in the vault.\nExample:</p>\n<ol>\n<li>User deposits 1.2 M worth of BTC and borrows 1M USDM.</li>\n<li>The user’s debt (<code>details[_id].debt</code>) would be 1.005 M as there’s a .5 percent fee.</li>\n<li>The contract’s debt is 1M.</li>\n<li>BTC price decrease by 20 percent</li>\n<li>The liquidator tries to liquidate the position.</li>\n<li>The liquidator repays 1.005 M and the contract tries to sub the debt by 1.005 M</li>\n<li>The transaction is reverted as <code>details[_id].debt -= _usdm;</code> would raise exception.</li>\n</ol>\n<p>inaccurate accounting would lead to serious issues. I consider this a high-risk issue.</p>\n<h4 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>This is a web3.py script that a liquidation may fail.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">deposit_amount = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">big_deposit = deposit_amount * </span><span class=\"mtk7\">100000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">minter.functions.mint(user, big_deposit).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dai.functions.approve(vault.address, big_deposit + deposit_amount).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># create two positions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault.functions.mint(user, zero_address).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault.functions.mint(user, zero_address).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># # borrow max amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault.functions.increase(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, big_deposit, big_deposit, zero_address, </span><span class=\"mtk8\">&#39;&#39;</span><span class=\"mtk1\">).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault.functions.increase(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, deposit_amount, deposit_amount, zero_address, </span><span class=\"mtk8\">&#39;&#39;</span><span class=\"mtk1\">).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault_debt = vault.functions.debts().call()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ## This would clear out all debt in vault.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">repay_amount = vault_debt + </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">usdm.functions.approve(vault.address, repay_amount).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault.functions.repay(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">, repay_amount).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">print</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;debt left:&#39;</span><span class=\"mtk1\">, vault.functions.debts().call())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># ## All the positions would not be liquidated from now on</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">dai_price = cssr_factory.functions.getPrice(dai.address).call()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">cssr_factory.functions.setPrice(dai.address, dai_price[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] // </span><span class=\"mtk7\">10</span><span class=\"mtk1\">).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">## this would revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">liquidator.functions.triggerLiquidation(dai.address, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">).transact()</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>I believe this is a mistake. Recommend to check the contract to make sure <code>increasingDebt</code> is used consistently.</p>\n<h2 id=\"h-02-feepoolv0soldistributemochi-will-unexpectedly-flush-treasuryshare-causing-the-protocol-fee-cannot-be-properly-accounted-for-and-collected\" style=\"position:relative;\"><a href=\"#h-02-feepoolv0soldistributemochi-will-unexpectedly-flush-treasuryshare-causing-the-protocol-fee-cannot-be-properly-accounted-for-and-collected\" aria-label=\"h 02 feepoolv0soldistributemochi will unexpectedly flush treasuryshare causing the protocol fee cannot be properly accounted for and collected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/114\">[H-02] <code>FeePoolV0.sol#distributeMochi()</code> will unexpectedly flush <code>treasuryShare</code>, causing the protocol fee cannot be properly accounted for and collected</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><code>distributeMochi()</code> will call <code>_buyMochi()</code> to convert <code>mochiShare</code> to Mochi token and call <code>_shareMochi()</code> to send Mochi to vMochi Vault and veCRV Holders. It wont touch the <code>treasuryShare</code>.</p>\n<p>However, in the current implementation, <code>treasuryShare</code> will be reset to <code>0</code>. This is unexpected and will cause the protocol fee can not be properly accounted for and collected.</p>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/8458209a52565875d8b2cefcb611c477cefb9253/projects/mochi-core/contracts/feePool/FeePoolV0.sol#L79-L95\"><code>FeePoolV0.sol#L79</code> L95</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_shareMochi</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IMochi</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mochi</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mochi</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mochiBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">mochi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// send Mochi to vMochi Vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mochi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vMochi</span><span class=\"mtk1\">()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">mochiBalance</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">vMochiRatio</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// send Mochi to veCRV Holders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mochi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">crvVoterRewardPool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">mochiBalance</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">vMochiRatio</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// flush mochiShare</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mochiShare</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">treasuryShare</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h5 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h5>\n<p>Anyone can call <code>distributeMochi()</code> and reset <code>treasuryShare</code> to <code>0</code>, and then call <code>updateReserve()</code> to allocate part of the wrongfuly resetted <code>treasuryShare</code> to <code>mochiShare</code> and call <code>distributeMochi()</code>.</p>\n<p>Repeat the steps above and the <code>treasuryShare</code> will be consumed to near zero, profits the vMochi Vault holders and veCRV Holders. The protocol suffers the loss of funds.</p>\n<h5 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h5>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_buyMochi</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IUSDM</span><span class=\"mtk1\"> </span><span class=\"mtk12\">usdm</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">usdm</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">path</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">path</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">path</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mochi</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uniswapRouter</span><span class=\"mtk1\">), </span><span class=\"mtk12\">mochiShare</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uniswapRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapExactTokensForTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">mochiShare</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">path</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// flush mochiShare</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mochiShare</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_shareMochi</span><span class=\"mtk1\">() </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IMochi</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mochi</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mochi</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mochiBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">mochi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// send Mochi to vMochi Vault</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mochi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">vMochi</span><span class=\"mtk1\">()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">mochiBalance</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">vMochiRatio</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// send Mochi to veCRV Holders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mochi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">crvVoterRewardPool</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">mochiBalance</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">vMochiRatio</span><span class=\"mtk1\">)) / </span><span class=\"mtk7\">1e18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/114\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-03-referralfeepoolv0solclaimrewardasmochi-array-out-of-bound-exception\" style=\"position:relative;\"><a href=\"#h-03-referralfeepoolv0solclaimrewardasmochi-array-out-of-bound-exception\" aria-label=\"h 03 referralfeepoolv0solclaimrewardasmochi array out of bound exception permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/97\">[H-03] <code>ReferralFeePoolV0.sol#claimRewardAsMochi()</code> Array out of bound exception</a></h2>\n<p><em>Submitted by WatchPug, also found by pauliax</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/8458209a52565875d8b2cefcb611c477cefb9253/projects/mochi-core/contracts/feePool/ReferralFeePoolV0.sol#L28-L42\"><code>ReferralFeePoolV0.sol#L28</code> L42</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimRewardAsMochi</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IUSDM</span><span class=\"mtk1\"> </span><span class=\"mtk12\">usdm</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">usdm</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">path</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">path</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">path</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">uniswapRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">WETH</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">path</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mochi</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uniswapRouter</span><span class=\"mtk1\">), </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// we are going to ingore the slippages here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uniswapRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">swapExactTokensForTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">reward</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">path</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<p>In <code>ReferralFeePoolV0.sol#claimRewardAsMochi()</code>, <code>path</code> is defined as an array of length 2 while it should be length 3.</p>\n<p>As a result, at L33, an out-of-bound exception will be thrown and revert the transaction.</p>\n<h5 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h5>\n<p><code>claimRewardAsMochi()</code> will not work as expected so that all the referral fees cannot be claimed but stuck in the contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/97\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-04-registerasset-can-overwrite-_assetclass-value\" style=\"position:relative;\"><a href=\"#h-04-registerasset-can-overwrite-_assetclass-value\" aria-label=\"h 04 registerasset can overwrite _assetclass value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/20\">[H-04] <code>registerAsset()</code> can <code>overwrite _assetClass</code> value</a></h2>\n<p><em>Submitted by gpersoon, also found by jonah1005 and leastwood</em></p>\n<h4 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Everyone can call the function <code>registerAsset()</code> of MochiProfileV0.sol\nAssuming the liquidity for the asset is sufficient, <code>registerAsset()</code> will reset the _assetClass of an already registered asset to <code>AssetClass.Sigma</code>.</p>\n<p>When the _assetClass is changed to <code>AssetClass.Sigma</code> then <code>liquidationFactor()</code>, <code>riskFactor()</code>, <code>maxCollateralFactor()</code>, <code>liquidationFee()</code> <code>keeperFee()</code> <code>maxFee()</code> will also return a different value.\nThen the entire vault will behave differently.\nThe threshold for liquidation will also be different, possibly leading to a liquidation that isn’t supposed to happen.</p>\n<h4 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add the following in function <code>registerAsset()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(\\</span><span class=\"mtk12\">_assetClass</span><span class=\"mtk1\">\\[\\</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">] ==</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span><span class=\"mtk8\">&quot;Already exists&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/20\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-05-debts-calculation-is-not-accurate\" style=\"position:relative;\"><a href=\"#h-05-debts-calculation-is-not-accurate\" aria-label=\"h 05 debts calculation is not accurate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/25\">[H-05] <code>debts</code> calculation is not accurate</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<h4 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The value of the global variable <code>debts</code> in the contract <code>MochiVault.sol</code> is calculated in an inconsistent way.</p>\n<p>In the function <code>borrow()</code> the variable <code>debts</code> is increased with a value excluding the fee.\nHowever in <code>repay()</code> and <code>liquidate()</code> it is decreased with the same value as <code>details\\[\\_id].debt</code> is decreased, which is including the fee.</p>\n<p>This would mean that <code>debts</code> will end up in a negative value when all debts are repay-ed. Luckily the function <code>repay()</code> prevents this from happening.</p>\n<p>In the meantime the value of <code>debts</code> isn’t accurate.\nThis value is used directly or indirectly in:</p>\n<ul>\n<li><code>utilizationRatio()</code>,<code>stabilityFee()</code> <code>calculateFeeIndex()</code> of <code>MochiProfileV0.sol</code></li>\n<li><code>liveDebtIndex()</code>, <code>accrueDebt()</code>, <code>currentDebt()</code> of <code>MochiVault.sol</code></li>\n</ul>\n<p>This means the entire debt and claimable calculations are slightly off.</p>\n<h4 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol\"><code>vault/MochiVault</code> sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">borrow</span><span class=\"mtk1\">(..)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">details</span><span class=\"mtk1\">\\[\\</span><span class=\"mtk11\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk11\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalDebt</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// includes the fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">debts</span><span class=\"mtk1\"> += \\</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;     </span><span class=\"mtk3\">// excludes the fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">repay</span><span class=\"mtk1\">(..)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">debts</span><span class=\"mtk1\"> -= \\</span><span class=\"mtk11\">_amount</span><span class=\"mtk1\">;\\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">details</span><span class=\"mtk1\">\\[\\</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> -= \\</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">liquidate</span><span class=\"mtk1\">(..)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">debts</span><span class=\"mtk1\"> -= \\</span><span class=\"mtk11\">_usdm</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">details</span><span class=\"mtk1\">\\[\\</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> -= \\</span><span class=\"mtk12\">_usdm</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>see <a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/25\">issue page</a> for referenced code.</p>\n<h4 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>In function <code>borrow()</code>:\nreplace\n<code>debts += \\_amount;</code>\nwith\n<code>debts += totalDebt</code></p>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/25\">ryuheimat (Mochi) confirmed</a></p>\n<h2 id=\"h-06-referrer-can-drain-referralfeepoolv0\" style=\"position:relative;\"><a href=\"#h-06-referrer-can-drain-referralfeepoolv0\" aria-label=\"h 06 referrer can drain referralfeepoolv0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/55\">[H-06] Referrer can drain <code>ReferralFeePoolV0</code></a></h2>\n<p><em>Submitted by gzeon</em></p>\n<h4 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>function <code>claimRewardAsMochi</code> in <code>ReferralFeePoolV0.sol</code> did not reduce user reward balance, allowing referrer to claim the same reward repeatedly and thus draining the fee pool.</p>\n<h4 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Did not reduce user reward balance at L28-47 in <a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/ReferralFeePoolV0.sol\">ReferralFeePoolV0.sol</a></p>\n<h4 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add the following lines</p>\n<blockquote>\n<p>rewards -= reward[msg.sender];\nreward[msg.sender] = 0;</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/55\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-07-liquidation-will-never-work-with-non-zero-discounts\" style=\"position:relative;\"><a href=\"#h-07-liquidation-will-never-work-with-non-zero-discounts\" aria-label=\"h 07 liquidation will never work with non zero discounts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/66\">[H-07] Liquidation will never work with non-zero discounts</a></h2>\n<p><em>Submitted by harleythedog</em></p>\n<h4 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Right now, there is only one discount profile in the github repo: the ”<code>NoDiscountProfile</code>” which does not discount the debt at all. This specific discount profile works correctly, but I claim that any other discount profile will result in liquidation never working.</p>\n<p>Suppose that we instead have a discount profile where <code>discount()</code> returns any value strictly larger than 0. Now, suppose someone wants to trigger a liquidation on a position. First, <code>triggerLiquidation</code> will be called (within <code>DutchAuctionLiquidator.sol</code>). The variable “debt” is initialized as equal to <code>vault.currentDebt(\\_nftId)</code>. Notice that <code>currentDebt(\\_ndfId)</code> (within <code>MochiVault.sol</code>) simply scales the current debt of the position using the <code>liveDebtIndex()</code> function, but there is no discounting being done within the function - this will be important.</p>\n<p>Back within the <code>triggerLiquidation</code> function, the variable “collateral” is  simply calculated as the total collateral of the position. Then, the function calls <code>vault.liquidate(\\_nftId, collateral, debt)</code>, and I claim that this will never work due to underflow.  Indeed, the liquidate function will first update the debt of the position (due to the <code>updateDebt(\\_id)</code> modifier). The debt of the position is thus updated using lines 99-107 in <code>MochiVault.sol</code>. We can see that the <code>details\\[\\_id].debt</code> is updated in the exact same way as the calculations for <code>currentDebt(\\_nftId)</code>, however, there is the extra subtraction of the <code>discountedDebt</code> on line 107.</p>\n<p>Eventually we will reach line 293 in <code>MochiVault.sol</code>. However, since we discounted the debt in the calculation of <code>details\\[\\_id].debt</code>, but we did not discount the debt for the passed in parameter _usdm (and thus is strictly larger in value), line 293 will always error due to an underflow. In summary, any discount profile that actually discounts the debt of the position will result in all liquidations erroring out due to this underflow. Since no positions will be liquidatable, this represents a major flaw in the contract as then no collateral can be liquidated so the entire functionality of the contract is compromised.</p>\n<h4 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol#:~:text=function-,liquidate,-\">Liquidate function in <code>MochiVault.sol</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/liquidator/DutchAuctionLiquidator.sol#:~:text=function-,triggerLiquidation,-address%20_asset%2C%20uint256\"><code>triggerLiquidation</code> function in <code>DutchAuctionLiquidator.sol</code></a></li>\n</ul>\n<p>Retracing the steps as I have described above, we can see that any call to <code>triggerLiquidation</code> will result in:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">details</span><span class=\"mtk1\">\\[\\</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">].</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> -= \\</span><span class=\"mtk12\">_usdm</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>throwing an error since _usdm will be larger than <code>details\\[\\_id].debt</code>.</p>\n<h4 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>An easy fix is to simply change:</p>\n<p><code>details\\[\\_id].debt -= \\_usdm;</code></p>\n<p>to be:</p>\n<p><code>details\\[\\_id].debt = 0;</code></p>\n<p>as liquidating a position should probably just be equivalent to repaying all of the debt in the position.</p>\n<p>Side Note: If there are no other discount profiles planned to be added other than ”<code>NoDiscountProfile</code>”, then I would recommend deleting all of the discount logic entirely, since <code>NoDiscountProfile</code> doesn’t actually do anything.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/66\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-08-anyone-can-extend-withdraw-wait-period-by-depositing-zero-collateral\" style=\"position:relative;\"><a href=\"#h-08-anyone-can-extend-withdraw-wait-period-by-depositing-zero-collateral\" aria-label=\"h 08 anyone can extend withdraw wait period by depositing zero collateral permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/69\">[H-08] Anyone can extend withdraw wait period by depositing zero collateral</a></h2>\n<p><em>Submitted by harleythedog, also found by WatchPug</em></p>\n<h4 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>In <code>MochiVault.sol</code>, the deposit function allows anyone to deposit collateral into any position. A malicious user can call this function with amount = 0, which would reset the amount of time the owner has to wait before they can withdraw their collateral from their position. This is especially troublesome with longer delays, as a malicious user would only have to spend a little gas to lock out all other users from being able to withdraw from their positions, compromising the functionality of the contract altogether.</p>\n<h4 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>the <code>deposit</code> function <a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol#:~:text=function-,deposit,-uint256%20_id%2C%20uint256\">here</a></p>\n<p>Notice that calling this function with amount = 0 is not disallowed. This overwrites <code>lastDeposit\\[\\_id]</code>, extending the wait period before a withdraw is allowed.</p>\n<h4 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>I would recommend adding:</p>\n<p><code>require(amount > 0, \"zero\")</code></p>\n<p>at the start of the function, as depositing zero collateral does not seem to be a necessary use case to support.</p>\n<p>It may also be worthwhile to consider only allowing the owner of a position to deposit collateral.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/69\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-09-treasury-is-vulnerable-to-sandwich-attack\" style=\"position:relative;\"><a href=\"#h-09-treasury-is-vulnerable-to-sandwich-attack\" aria-label=\"h 09 treasury is vulnerable to sandwich attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/60\">[H-09] treasury is vulnerable to sandwich attack</a></h2>\n<p><em>Submitted by jonah1005</em></p>\n<h4 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>There’s a permissionless function <code>veCRVlock</code> in <code>MochiTreasury</code>. Since everyone can trigger this function, the attacker can launch a sandwich attack with flashloan to steal the funds.\n<a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/treasury/MochiTreasuryV0.sol#L73-L94\">MochiTreasuryV0.sol#L73-L94</a></p>\n<p>Attackers can possibly steal all the funds in the treasury. I consider this is a high-risk issue.</p>\n<h4 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/treasury/MochiTreasuryV0.sol#L73-L94\">MochiTreasuryV0.sol#L73-L94</a></p>\n<p>Here’s an exploit pattern</p>\n<ol>\n<li>Flashloan and buy CRV the uniswap pool</li>\n<li>Trigger <code>veCRVlock()</code></li>\n<li>The treasury buys CRV at a very high price.</li>\n<li>Sell CRV and pay back the loan.</li>\n</ol>\n<h4 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Recommend to add <code>onlyOwner</code> modifier.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/60\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-10-changing-nft-contract-in-the-mochiengine-would-break-the-protocol\" style=\"position:relative;\"><a href=\"#h-10-changing-nft-contract-in-the-mochiengine-would-break-the-protocol\" aria-label=\"h 10 changing nft contract in the mochiengine would break the protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/63\">[H-10] Changing NFT contract in the <code>MochiEngine</code> would break the protocol</a></h2>\n<p><em>Submitted by jonah1005</em></p>\n<h4 id=\"impact-9\" style=\"position:relative;\"><a href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><code>MochiEngine</code> allows the operator to change the NFT contract in <a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/MochiEngine.sol#L91-L93\">MochiEngine.sol#L91-L93</a></p>\n<p>All the vaults would point to a different NFT address. As a result, users would not be access their positions. The entire protocol would be broken.</p>\n<p>IMHO, A function that would break the entire protocol shouldn’t exist.</p>\n<p>I consider this is a high-risk issue.</p>\n<h4 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/MochiEngine.sol#L91-L93\">MochiEngine.sol#L91-L93</a></p>\n<h4 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Remove the function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/63\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-11-treasuryshare-is-overwritten-in-feepoolv0_sharemochi\" style=\"position:relative;\"><a href=\"#h-11-treasuryshare-is-overwritten-in-feepoolv0_sharemochi\" aria-label=\"h 11 treasuryshare is overwritten in feepoolv0_sharemochi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/89\">[H-11] <code>treasuryShare</code> is Overwritten in <code>FeePoolV0._shareMochi()</code></a></h2>\n<p><em>Submitted by leastwood</em></p>\n<h4 id=\"impact-10\" style=\"position:relative;\"><a href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>FeePoolV0.sol</code> contract accrues fees upon the liquidation of undercollaterised positions. These fees are split between treasury and <code>vMochi</code> contracts. However, when <code>distributeMochi()</code> is called to distribute <code>mochi</code> tokens to <code>veCRV</code> holders, both <code>mochiShare</code> and <code>treasuryShare</code> is flushed from the contract when there are still <code>usdm</code> tokens in the contract.</p>\n<h4 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Consider the following scenario:</p>\n<ul>\n<li>The <code>FeePoolV0.sol</code> contract contains 100 <code>usdm</code> tokens at an exchange rate of 1:1 with <code>mochi</code> tokens.</li>\n<li><code>updateReserve()</code> is called to set the split of <code>usdm</code> tokens such that <code>treasuryShare</code> has claim on 20 <code>usdm</code> tokens and <code>mochiShare</code> has claim on the other 80 tokens.</li>\n<li>A <code>veCRV</code> holder seeks to increase their earnings by calling <code>distributeMochi()</code> before <code>sendToTreasury()</code> has been called.</li>\n<li>As a result, 80 <code>usdm</code> tokens are converted to <code>mochi</code> tokens and  locked in a curve rewards pool.</li>\n<li>Consequently, <code>mochiShare</code> and <code>treasuryShare</code> is set to <code>0</code> (aka flushed).</li>\n<li>The same user calls <code>updateReserve()</code> to split the leftover 20 <code>usdm</code> tokens between <code>treasuryShare</code> and <code>mochiShare</code>.</li>\n<li><code>mochiShare</code> is now set to 16 <code>usdm</code> tokens.</li>\n<li>The above process is repeated to distribute <code>mochi</code> tokens to <code>veCRV</code> holders again and again.</li>\n<li>The end result is that <code>veCRV</code> holders have been able to receive all tokens that were intended to be distributed to the treasury.</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/FeePoolV0.sol#L94\"><code>FeePoolV0.sol</code> L94</a></p>\n<h4 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<ul>\n<li>Manual code review</li>\n<li>Discussions with the Mochi team.</li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider removing the line in <code>FeePoolV0.sol</code> (mentioned above), where <code>treasuryShare</code> is flushed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/89\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"h-12-feepool-is-vulnerable-to-sandwich-attack\" style=\"position:relative;\"><a href=\"#h-12-feepool-is-vulnerable-to-sandwich-attack\" aria-label=\"h 12 feepool is vulnerable to sandwich attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/65\">[H-12] feePool is vulnerable to sandwich attack.</a></h2>\n<p><em>Submitted by jonah1005</em></p>\n<h4 id=\"impact-11\" style=\"position:relative;\"><a href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>There’s a permissionless function <code>distributeMochi</code> in <a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/FeePoolV0.sol#L55-L62\">FeePoolV0.sol L55-L62</a>. Since everyone can trigger this function, an attacker can launch a sandwich attack with flashloan to steal the funds.</p>\n<p>The devs have mentioned this concern in the comment. An attacker can steal the funds with a flash loan attack.</p>\n<p>Attackers can steal all the funds in the pool. I consider this is a high-risk issue.</p>\n<h4 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/FeePoolV0.sol#L55-L62\">FeePoolV0.sol#L55-L62</a></p>\n<p>Please refer to <a href=\"https://peckshield.medium.com/the-ydai-incident-analysis-forced-investment-2b8ac6058eb5\">yDai Incident</a> to check the severity of a <code>harvest</code> function without slippage control.</p>\n<p>Please refer to <a href=\"https://medium.com/immunefi/mushrooms-finance-theft-of-yield-bug-fix-postmortem-16bd6961388f\">Mushrooms-finance-theft</a> to check how likely this kind of attack might happen.</p>\n<h4 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>If the dev wants to make this a permissionless control, the contract should calculate a min return based on TWAP and check the slippage.</p>\n<h3 id=\"comments\" style=\"position:relative;\"><a href=\"#comments\" aria-label=\"comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments:</h3>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/65#issuecomment-953031170\">ryuheimat (Mochi) disputed</a>:</strong></p>\n<blockquote>\n<p>I think this is same case as <a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/60\">https://github.com/code-423n4/2021-10-mochi-findings/issues/60</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/65#issuecomment-957027904\">ghoul-sol (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The same attack, different part of the code. I’ll keep them both.</p>\n</blockquote>\n<h2 id=\"h-13-tokens-can-be-stolen-by-frontrunning-vestedrewardpoolvest-and-vestedrewardpoollock\" style=\"position:relative;\"><a href=\"#h-13-tokens-can-be-stolen-by-frontrunning-vestedrewardpoolvest-and-vestedrewardpoollock\" aria-label=\"h 13 tokens can be stolen by frontrunning vestedrewardpoolvest and vestedrewardpoollock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/92\">[H-13] Tokens Can Be Stolen By Frontrunning <code>VestedRewardPool.vest()</code> and <code>VestedRewardPool.lock()</code></a></h2>\n<p><em>Submitted by leastwood</em></p>\n<h4 id=\"impact-12\" style=\"position:relative;\"><a href=\"#impact-12\" aria-label=\"impact 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>VestedRewardPool.sol</code> contract is a public facing contract aimed at vesting tokens for a minimum of 90 days before allowing the recipient to withdraw their <code>mochi</code>. The <code>vest()</code> function does not utilise <code>safeTransferFrom()</code> to ensure that vested tokens are correctly allocated to the recipient. As a result, it is possible to frontrun a call to <code>vest()</code> and effectively steal a recipient’s vested tokens. The same issue applies to the <code>lock()</code> function.</p>\n<h4 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/emission/VestedRewardPool.sol#L36-L46\"><code>VestedRewardPool.sol#L36</code> L46</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/emission/VestedRewardPool.sol#L54-L64\"><code>VestedRewardPool.sol#L54</code> L64</a></li>\n</ul>\n<h4 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual code review\nDiscussions with the Mochi team</p>\n<h4 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Ensure that users understand that this function should not be interacted directly as this could result in lost <code>mochi</code> tokens. Additionally, it might be worthwhile creating a single externally facing function which calls <code>safeTransferFrom()</code>, <code>vest()</code> and <code>lock()</code> in a single transaction.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/92\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h1 id=\"medium-risk-findings-15\" style=\"position:relative;\"><a href=\"#medium-risk-findings-15\" aria-label=\"medium risk findings 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (15)</h1>\n<h2 id=\"m-01-liquidation-factor--collateral-factor-for-sigma-type\" style=\"position:relative;\"><a href=\"#m-01-liquidation-factor--collateral-factor-for-sigma-type\" aria-label=\"m 01 liquidation factor  collateral factor for sigma type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/126\">[M-01] liquidation factor &#x3C; collateral factor for Sigma type</a></h2>\n<p><em>Submitted by cmichel, also found by gzeon</em></p>\n<p>The <code>MochiProfileV0</code> defines liquidation and collateral factors for different asset types.\nFor the <code>AssetClass.Sigma</code> type, the liquidation factor is <em>less</em> than the collateral factor:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">liquidationFactor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">float</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AssetClass</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">assetClass</span><span class=\"mtk1\">(</span><span class=\"mtk10\">_asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">class</span><span class=\"mtk1\"> == </span><span class=\"mtk10\">AssetClass</span><span class=\"mtk1\">.</span><span class=\"mtk10\">Sigma</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">// } else if (class == AssetClass.Sigma) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">float</span><span class=\"mtk1\">({</span><span class=\"mtk12\">numerator</span><span class=\"mtk1\">: </span><span class=\"mtk7\">40</span><span class=\"mtk1\">, </span><span class=\"mtk12\">denominator</span><span class=\"mtk1\">: </span><span class=\"mtk7\">100</span><span class=\"mtk1\">});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxCollateralFactor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">float</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">AssetClass</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">assetClass</span><span class=\"mtk1\">(</span><span class=\"mtk10\">_asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">class</span><span class=\"mtk1\"> == </span><span class=\"mtk10\">AssetClass</span><span class=\"mtk1\">.</span><span class=\"mtk10\">Sigma</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">float</span><span class=\"mtk1\">({</span><span class=\"mtk12\">numerator</span><span class=\"mtk1\">: </span><span class=\"mtk7\">45</span><span class=\"mtk1\">, </span><span class=\"mtk12\">denominator</span><span class=\"mtk1\">: </span><span class=\"mtk7\">100</span><span class=\"mtk1\">});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This means that one can take a loan of up to 45% of their collateral but then immediately gets liquidated as the liquidation factor is only 40%.\nThere should always be a buffer between these such that taking the max loan does not immediately lead to liquidations:</p>\n<blockquote>\n<p>A safety buffer is maintained between max CF and LF to protect users against liquidations due to normal volatility. <a href=\"https://hackmd.io/@az-/mochi-whitepaper#Collateral-Factor-CF\">Docs</a></p>\n</blockquote>\n<h4 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The max collateral factor for the Sigma type should be higher than its liquidation factor.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/126\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"m-02-regerralfeepool-is-vulnerable-to-mev-searcher\" style=\"position:relative;\"><a href=\"#m-02-regerralfeepool-is-vulnerable-to-mev-searcher\" aria-label=\"m 02 regerralfeepool is vulnerable to mev searcher permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/62\">[M-02] <code>regerralFeePool</code> is vulnerable to MEV searcher</a></h2>\n<p><em>Submitted by jonah1005, also found by cmichel</em></p>\n<h4 id=\"impact-13\" style=\"position:relative;\"><a href=\"#impact-13\" aria-label=\"impact 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><code>claimRewardAsMochi</code> in the <code>ReferralFeePoolV0</code> ignores slippage. This is not a desirable design. There are a lot of MEV searchers in the current network. Swapping assets with no slippage control would get rekted. Please refer to <a href=\"https://github.com/flashbots/pm\">https://github.com/flashbots/pm</a>.</p>\n<p>Given the current state of the Ethereum network, users would likely be sandwiched. I consider this is a high-risk issue.</p>\n<h4 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/ReferralFeePoolV0.sol#L28-L48\">ReferralFeePoolV0.sol#L28-L48</a>\nPlease refer to  <a href=\"https://medium.com/immunefi/mushrooms-finance-theft-of-yield-bug-fix-postmortem-16bd6961388f\">Mushrooms Finance Theft of Yield Bug Fix Postmortem | by Immunefi | Immunefi | Medium</a> to see a possible attack pattern.</p>\n<h4 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>I recommend adding <code>minReceivedAmount</code> as a parameter.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimRewardAsMochi</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minReceivedAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// original logic here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mochi</span><span class=\"mtk1\">().</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) &gt; </span><span class=\"mtk12\">_minReceivedAmount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;!min&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mochi</span><span class=\"mtk1\">().</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">engine</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mochi</span><span class=\"mtk1\">().</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Also, the front-end should calculate the min amount with the current price.</p>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/62\">ryuheimat (Mochi) confirmed</a></p>\n<h2 id=\"m-03-a-malicious-user-can-potentially-escape-liquidation-by-creating-a-dust-amount-position-and-trigger-the-liquidation-by-themself\" style=\"position:relative;\"><a href=\"#m-03-a-malicious-user-can-potentially-escape-liquidation-by-creating-a-dust-amount-position-and-trigger-the-liquidation-by-themself\" aria-label=\"m 03 a malicious user can potentially escape liquidation by creating a dust amount position and trigger the liquidation by themself permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/127\">[M-03] A malicious user can potentially escape liquidation by creating a dust amount position and trigger the liquidation by themself</a></h2>\n<p><em>Submitted by WatchPug, also found by jonah1005</em></p>\n<p>In the current implementation, a liquidated position can be used for depositing and borrowing again.</p>\n<p>However, if there is a liquidation auction ongoing, even if the position is now <code>liquidatable</code>, the call of <code>triggerLiquidation()</code> will still fail.</p>\n<p>The liquidator must <code>settleLiquidation</code> first.</p>\n<p>If the current auction is not profitable for the liquidator, say the value of the collateral can not even cover the gas cost, the liquidator may be tricked and not liquidate the new loan at all.</p>\n<p>Considering if the liquidator bot is not as small to handle this situation (take the profit of the new liquidation and the gas cost loss of the current auction into consideration), a malicious user can create a dust amount position trigger the liquidation by themself.</p>\n<p>Since the collateral of this position is so small that it can not even cover the gas cost, liquidators will most certainly ignore this auction.</p>\n<p>The malicious user will then deposit borrow the actual loan.</p>\n<p>When this loan becomes <code>liquidatable</code>, liquidators may:</p>\n<ol>\n<li>confuse the current dust auction with the <code>liquidatable</code> position;</li>\n<li>unable to proceed with such a complex liquidation.</li>\n</ol>\n<p>As a result, the malicious user can potentially escape liquidation.</p>\n<h5 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h5>\n<p>Consider making liquidated positions unable to be used (for depositing and borrowing) again.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/127\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"m-04-unchecked-erc20-transfer-calls\" style=\"position:relative;\"><a href=\"#m-04-unchecked-erc20-transfer-calls\" aria-label=\"m 04 unchecked erc20 transfer calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/75\">[M-04] Unchecked ERC20 transfer calls</a></h2>\n<p><em>Submitted by loop, also found by cmichel, defsec, gzeon, leastwood, nikitastupin, pants, and WatchPug</em></p>\n<p>ERC20 <code>transfer</code> and <code>transferFrom</code> calls normally return <code>true</code> on a succesful transfer. In DutchAuctionLiquidator the call <code>asset.transfer(msg.sender, _collateral);</code> is made. <code>asset</code> refers to whichever ERC20 asset is used for the vault of that auction. If <code>asset</code> is an ERC20 token which does not comply with the EIP-20 standard it might return <code>false</code> on a failed transaction rather than revert. In this case it would count as a valid transaction even though it is not. If a vault would be making use of USDT the transfer call would always revert as USDT returns <code>void</code> on transfers.</p>\n<p>There are a few more transfer(From) calls which are unchecked, these are however all on a predetermined asset (mochi, usdM and crv) and unlikely to cause problems.</p>\n<h4 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>See <a href=\"https://github.com/code-423n4/reports/blob/mochi/mochi/2021-10-mochi-findings-DRAFT.md\">issue page</a> for referenced code.</p>\n<h4 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Slither</p>\n<h4 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>In other contracts the functions <code>cheapTransfer</code> and <code>cheapTransferFrom</code> are used which are part of the mochifi cheapERC20 library. These functions do check for a return value and could be used rather than <code>transfer</code> and <code>transferFrom</code>.</p>\n<h3 id=\"comments-1\" style=\"position:relative;\"><a href=\"#comments-1\" aria-label=\"comments 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Comments:</h3>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/75#issuecomment-952083361\">ryuheimat (Mochi) confirmed</a>:</strong></p>\n<blockquote>\n<p><code>transferFrom</code> and <code>transfer</code> functions are used for mochi and usdm tokens which are standard EIP-20 tokens.</p>\n</blockquote>\n<h2 id=\"m-05-chainlinks-latestrounddata-might-return-stale-or-incorrect-results\" style=\"position:relative;\"><a href=\"#m-05-chainlinks-latestrounddata-might-return-stale-or-incorrect-results\" aria-label=\"m 05 chainlinks latestrounddata might return stale or incorrect results permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/87\">[M-05] Chainlink’s <code>latestRoundData</code> might return stale or incorrect results</a></h2>\n<p><em>Submitted by nikitastupin, also found by cmichel, defsec, leastwood, and WatchPug</em></p>\n<h4 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/8458209a52565875d8b2cefcb611c477cefb9253/projects/mochi-cssr/contracts/adapter/ChainlinkAdapter.sol#L49\"><code>ChainlinkAdapter.sol</code> L49</a></p>\n<p>The <code>ChainlinkAdapter</code> calls out to a Chainlink oracle receiving the <code>latestRoundData()</code>. If there is a problem with Chainlink starting a new round and finding consensus on the new value for the oracle (e.g. Chainlink nodes abandon the oracle, chain congestion, vulnerability/attacks on the chainlink system) consumers of this contract may continue using outdated stale or incorrect data (if oracles are unable to submit no new round is started).</p>\n<h4 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Recommend adding the following checks:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ( </span><span class=\"mtk12\">roundId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rawPrice</span><span class=\"mtk1\">, , </span><span class=\"mtk12\">updateTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">answeredInRound</span><span class=\"mtk1\"> ) = </span><span class=\"mtk11\">AggregatorV3Interface</span><span class=\"mtk1\">(</span><span class=\"mtk12\">XXXXX</span><span class=\"mtk1\">).</span><span class=\"mtk11\">latestRoundData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rawPrice</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Chainlink price &lt;= 0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">updateTime</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incomplete round&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">answeredInRound</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">roundId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Stale price&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h4 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h4>\n<ul>\n<li><a href=\"https://consensys.net/diligence/audits/2021/09/fei-protocol-v2-phase-1/#chainlinkoraclewrapper-latestrounddata-might-return-stale-results\">https://consensys.net/diligence/audits/2021/09/fei-protocol-v2-phase-1/#chainlinkoraclewrapper-latestrounddata-might-return-stale-results</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-05-fairside-findings/issues/70\">https://github.com/code-423n4/2021-05-fairside-findings/issues/70</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/87\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"m-06-debt-accrual-is-path-dependant-and-inaccurate\" style=\"position:relative;\"><a href=\"#m-06-debt-accrual-is-path-dependant-and-inaccurate\" aria-label=\"m 06 debt accrual is path dependant and inaccurate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/129\">[M-06] Debt accrual is path-dependant and inaccurate</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The total <code>debt</code> in <code>MochiVault.accrueDebt</code> increases by the current <code>debt</code> times the debt index growth.\nThis is correct but the total <code>debt</code> is then <em>reduced</em> again by the calling <em>user’s</em> discounted debt, meaning, the total debt depends on which specific user performs the debt accrual.</p>\n<p>This should not be the case.</p>\n<h4 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h4>\n<p>Assume we have a total debt of <code>2000</code>, two users A and B, where A has a debt of 1000, and B has a debt of 100.\nThe (previous) <code>debtIndex = 1.0</code> and accruing it now would increase it to <code>1.1</code>.</p>\n<p>There’s a difference if user A or B first does the accrual.</p>\n<h6 id=\"user-a-accrues-first\" style=\"position:relative;\"><a href=\"#user-a-accrues-first\" aria-label=\"user a accrues first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>User A accrues first</h6>\n<p>User A calls <code>accrueDebt</code>: <code>increased = 2000 * 1.1/1.0 - 2000 = 200</code>. Thus <code>debts</code> is first set to <code>2200</code>. The user’s <code>increasedDebt = 1000 * 1.1 / 1.0 - 1000 = 100</code> and assume a discount of <code>10%</code>, thus <code>discountedDebt = 100 * 10% = 10</code>.\nThen <code>debts = 2200 - 10 = 2190</code>.</p>\n<p>The next accrual will work with a total debt of <code>2190</code>.</p>\n<h6 id=\"user-b-accruess-first\" style=\"position:relative;\"><a href=\"#user-b-accruess-first\" aria-label=\"user b accruess first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>User B accruess first</h6>\n<p>User B calls <code>accrueDebt</code>: <code>increased = 2000 * 1.1/1.0 - 2000 = 200</code>. Thus <code>debts</code> is first set to <code>2200</code>. The user’s <code>increasedDebt = 100 * 1.1 / 1.0 - 100 = 10</code> and assume a discount of <code>10%</code>, thus <code>discountedDebt = 10 * 10% = 1</code>.\nThen <code>debts = 2200 - 1 = 2199</code>.</p>\n<p>The next accrual will work with a total debt of <code>2199</code>, leading to more debt overall.</p>\n<h4 id=\"impact-14\" style=\"position:relative;\"><a href=\"#impact-14\" aria-label=\"impact 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The total debt of a system depends on who performs the accruals which should ideally not be the case.\nThe discrepancy compounds and can grow quite large if a whale always does the accrual compared to someone with almost no debt or no discount.</p>\n<h4 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Don’t use the discounts or track the weighted average discount across all users that is subtracted from the increased total debt each time, i.e., reduce it by the discount of <strong>all users</strong> (instead of current caller only) when accruing to correctly track the debt.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/129\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"m-07-changing-enginenft-contract-breaks-vaults\" style=\"position:relative;\"><a href=\"#m-07-changing-enginenft-contract-breaks-vaults\" aria-label=\"m 07 changing enginenft contract breaks vaults permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/130\">[M-07] Changing engine.nft contract breaks vaults</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>Governance can change the <code>engine.nft</code> address which is used by vaults to represent collateralized debt positions (CDP).\nWhen minting a vault using <code>MochiVault.mint</code> the address returned ID will be used and overwrite the state of an existing debt position and set its status to <code>Idle</code>.</p>\n<h4 id=\"impact-15\" style=\"position:relative;\"><a href=\"#impact-15\" aria-label=\"impact 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Changing the NFT address will allow overwriting existing CDPs.</p>\n<h4 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Disallow setting a new NFT address. or ensure that the new NFT’s IDs start at the old NFT’s IDs.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/130\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"m-08-uniswapv2sushiwaplpadapter-update-the-wrong-token\" style=\"position:relative;\"><a href=\"#m-08-uniswapv2sushiwaplpadapter-update-the-wrong-token\" aria-label=\"m 08 uniswapv2sushiwaplpadapter update the wrong token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/134\">[M-08] <code>UniswapV2/SushiwapLPAdapter</code> update the wrong token</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>UniswapV2LPAdapter/SushiswapV2LPAdapter.update</code> function retrieves the <code>underlying</code> from the LP token pair (<code>_asset</code>) but then calls <code>router.update(_asset, _proof)</code> which is the LP token itself again.\nThis will end up with the router calling this function again recursively.</p>\n<h4 id=\"impact-16\" style=\"position:relative;\"><a href=\"#impact-16\" aria-label=\"impact 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>This function fails as there’s an infinite recursion and eventually runs out of gas.</p>\n<h4 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h4>\n<p>The idea was most likely to update the <code>underlying</code> price which is used in <code>_getPrice</code> as <code>uint256 eAvg = cssr.getExchangeRatio(_underlying, weth);</code>.</p>\n<p>Call <code>router.update(underlying, _proof)</code> instead. Note that the <code>_proof</code> does not necessarily update the <code>underlying &#x3C;> WETH</code> pair, it could be any <code>underlying &#x3C;> keyAsset</code> pair.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/134\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"m-09-uniswapv2tokenadapter-does-not-support-sushiswap-only-assets\" style=\"position:relative;\"><a href=\"#m-09-uniswapv2tokenadapter-does-not-support-sushiswap-only-assets\" aria-label=\"m 09 uniswapv2tokenadapter does not support sushiswap only assets permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/135\">[M-09] <code>UniswapV2TokenAdapter</code> does not support Sushiswap-only assets</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>UniswapV2TokenAdapter.supports</code> function calls its <code>aboveLiquidity</code> function which returns the UniswapV2 liquidity if the pair exists.\nIf this is below <code>minimumLiquidity</code>, the <code>supports</code> function will return <code>false</code>.</p>\n<p>However, it could be that the <code>Sushiswap</code> pair has lots of liquidity and could be used.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uniswapCSSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairedWith</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liq</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">float</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cssrRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairedWith</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit this returns early. if it&#39;s false it should check sushiswap first</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToValue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liq</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk12\">minimumLiquidity</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sushiCSSR</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getLiquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_pairedWith</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liq</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">float</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cssrRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_pairedWith</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToValue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liq</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk12\">minimumLiquidity</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h4 id=\"impact-17\" style=\"position:relative;\"><a href=\"#impact-17\" aria-label=\"impact 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Suppose the <code>UniswapV2TokenAdapter</code> wants to be used as an adapter for a Sushiswap pool.\nAn attacker creates a UniswapV2 pool for the same pair and does not provide liquidity.\nThe <code>Router.setPriceSource</code> calls <code>UniswapV2TokenAdapter.supports</code> and returns false as the Uniswap liquidity is too low, without checking the Sushiswap liquidity.</p>\n<h4 id=\"recommendation-3\" style=\"position:relative;\"><a href=\"#recommendation-3\" aria-label=\"recommendation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h4>\n<p>In <code>aboveLiquidity</code>, if the UniswapV2 liquidity is <em>less</em> than the minimum liquidity, instead of returning, compare the Sushiswap liquidity against this threshold.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/135\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"m-10-griefing-attack-to-block-withdraws\" style=\"position:relative;\"><a href=\"#m-10-griefing-attack-to-block-withdraws\" aria-label=\"m 10 griefing attack to block withdraws permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/21\">[M-10] griefing attack to block withdraws</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<h4 id=\"impact-18\" style=\"position:relative;\"><a href=\"#impact-18\" aria-label=\"impact 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Every time you deposit some assets in the vault (via <code>deposit()</code> of <code>MochiVault.sol</code>) then “lastDeposit[_id]” is set to <code>block.timestamp</code>.\nThe modifier <code>wait()</code> checks this value and makes sure you cannot withdraw for ”<code>delay()</code>” blocks.\nThe default value for <code>delay()</code> is 3 minutes.</p>\n<p>Knowing this delay you can do a griefing attack:\nOn chains with low gas fees: every 3 minutes deposit a tiny amount for a specific NFT-id (which has a large amount of assets).\nOn chains with high gas fees: monitor the mempool for a <code>withdraw()</code> transaction and frontrun it with a <code>deposit()</code></p>\n<p>This way the owner of the NFT-id can never withdraw the funds.</p>\n<h4 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/806ebf2a364c01ff54d546b07d1bdb0e928f42c6/projects/mochi-core/contracts/vault/MochiVault.sol#L47-L54\"><code>MochiVault.sol#L47</code> L54</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/806ebf2a364c01ff54d546b07d1bdb0e928f42c6/projects/mochi-core/contracts/vault/MochiVault.sol#L171\"><code>vault/MochiVault.sol</code> L171</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/806ebf2a364c01ff54d546b07d1bdb0e928f42c6/projects/mochi-core/contracts/profile/MochiProfileV0.sol#L33\"><code>profile/MochiProfileV0.sol</code> L33</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Create a mechanism where you only block the withdraw of recently deposited funds</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/21#issuecomment-952886314\">ryuheimat (Mochi) confirmed</a>:</strong></p>\n<blockquote>\n<p>Will update deposit function to allow only NFT owner to deposit</p>\n</blockquote>\n<h2 id=\"m-11-borrow-function-will-borrow-max-cf-when-trying-to-borrow--cf\" style=\"position:relative;\"><a href=\"#m-11-borrow-function-will-borrow-max-cf-when-trying-to-borrow--cf\" aria-label=\"m 11 borrow function will borrow max cf when trying to borrow  cf permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/45\">[M-11] borrow function will borrow max cf when trying to borrow > cf</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<h4 id=\"impact-19\" style=\"position:relative;\"><a href=\"#impact-19\" aria-label=\"impact 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Borrow function in <code>MochiVault</code> will borrow to max cf when trying to borrow > cf instead of revert with “>cf” as specified in the supplied test. The difference in behavior may cause user to borrow at dangerous collateral level, and receive less than the amount requested.</p>\n<h4 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol\"><code>MochiVault</code> sol</a></li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Revert if <code>details\\[\\_id].debt</code> + <code>\\_amount</code> > <code>maxMinted</code> with “>cf”</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/45\">ryuheimat (Mochi) conirmed</a></strong></p>\n<h2 id=\"m-12-anyone-can-create-a-vault-by-directly-calling-the-factory\" style=\"position:relative;\"><a href=\"#m-12-anyone-can-create-a-vault-by-directly-calling-the-factory\" aria-label=\"m 12 anyone can create a vault by directly calling the factory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/80\">[M-12] anyone can create a vault by directly calling the factory</a></h2>\n<p><em>Submitted by jonah1005</em></p>\n<h4 id=\"impact-20\" style=\"position:relative;\"><a href=\"#impact-20\" aria-label=\"impact 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>In <a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVaultFactory.sol#L26-L37\">MochiVaultFactory.sol#L26-L37</a>, there’s no permission control in the <code>vaultFactory</code>. Anyone can create a vault. The transaction would be reverted when the government tries to deploy such an asset.</p>\n<p>As the protocol checks whether the vault is a valid vault by comparing the contract’s address with the computed address, the protocol would recognize the random vault as a valid one.</p>\n<p>I consider this is a medium-risk issue.</p>\n<h4 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Here’s a web3.py script to trigger the bug.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"py\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">vault_factory.functions.deployVault(usdt.address).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">## this tx would be reverted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">profile.functions.registerAssetByGov([usdt.address], [</span><span class=\"mtk7\">3</span><span class=\"mtk1\">]).transact()</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Recommend to add a check.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">engine</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;!engine&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/80\">ryuheimat (Mochi) confirmed</a></p>\n<h2 id=\"m-13-improper-validation-of-create2-return-value\" style=\"position:relative;\"><a href=\"#m-13-improper-validation-of-create2-return-value\" aria-label=\"m 13 improper validation of create2 return value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/155\">[M-13] Improper Validation Of <code>create2</code> Return Value</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<h4 id=\"impact-21\" style=\"position:relative;\"><a href=\"#impact-21\" aria-label=\"impact 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>BeaconProxyDeployer.deploy()</code> function is used to deploy lightweight proxy contracts that act as each asset’s vault. The function does not revert properly if there is a failed contract deployment or revert from the <code>create2</code> opcode as it does not properly check the returned address for bytecode. The <code>create2</code> opcode returns the expected address which will never be the zero address (as is what is currently checked).</p>\n<h4 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-library/contracts/BeaconProxyDeployer.sol#L31\"><code>BeaconProxyDeployer.sol</code> L31</a></li>\n</ul>\n<h4 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<ul>\n<li>Manual code review</li>\n<li>Discussions with the Mochi team</li>\n<li>Discussions with library dev</li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The recommended mitigation was to update <code>iszero(result)</code> to <code>iszero(extcodesize(result))</code> in the line mentioned above. This change has already been made in the corresponding library which can be found <a href=\"https://github.com/Nipol/bean-contracts/pull/13\">here</a>, however, this needs to also be reflected in Mochi’s contracts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/155\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h2 id=\"m-14-mochitreasuryv0withdrawlock-is-callable-when-locking-has-been-toggled\" style=\"position:relative;\"><a href=\"#m-14-mochitreasuryv0withdrawlock-is-callable-when-locking-has-been-toggled\" aria-label=\"m 14 mochitreasuryv0withdrawlock is callable when locking has been toggled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/161\">[M-14] <code>MochiTreasuryV0.withdrawLock()</code> Is Callable When Locking Has Been Toggled</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<h4 id=\"impact-22\" style=\"position:relative;\"><a href=\"#impact-22\" aria-label=\"impact 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><code>withdrawLock()</code> does not prevent users from calling this function when locking has been toggled. As a result, withdraws may be made unexpectedly.</p>\n<h4 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/treasury/MochiTreasuryV0.sol#L40-L42\"><code>MochiTreasuryV0.sol#L40</code> L42</a></li>\n</ul>\n<h4 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual code review</p>\n<h4 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider adding <code>require(lockCrv, \"!lock\");</code> to <code>withdrawLock()</code> to ensure this function is not called unexpectedly. Alternatively if this is intended behaviour, it should be rather checked that the lock has not been toggled, otherwise users could maliciously relock tokens.</p>\n<p><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/161\">ryuheimat (Mochi) confirmed</a></p>\n<h2 id=\"m-15-mochitreasuryv0sol-is-unusable-in-its-current-state\" style=\"position:relative;\"><a href=\"#m-15-mochitreasuryv0sol-is-unusable-in-its-current-state\" aria-label=\"m 15 mochitreasuryv0sol is unusable in its current state permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/168\">[M-15] <code>MochiTreasuryV0.sol</code> Is Unusable In Its Current State</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<h4 id=\"impact-23\" style=\"position:relative;\"><a href=\"#impact-23\" aria-label=\"impact 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><code>MochiTreasuryV0.sol</code> interacts with Curve’s voting escrow contract to lock tokens for 90 days, where it can be later withdrawn by the governance role. However, <code>VotingEscrow.vy</code> does not allow contracts to call the following functions; <code>create_lock()</code>, <code>increase_amount()</code> and <code>increase_unlock_time()</code>. For these functions, <code>msg.sender</code> must be an EOA account or an approved smart wallet. As a result, any attempt to lock tokens will fail in <code>MochiTreasuryV0.sol</code>.</p>\n<h4 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L418\"><code>VotingEscrow.vy</code> L418</a></li>\n<li><a href=\"https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L438\"><code>VotingEscrow.vy</code> L438</a></li>\n<li><a href=\"https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L455\"><code>VotingEscrow.vy</code> L455</a></li>\n</ul>\n<h4 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<ul>\n<li>Manual code review</li>\n<li>Discussions with the Mochi team</li>\n</ul>\n<h4 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider updating this contract to potentially use another escrow service that enables <code>msg.sender</code> to be a contract. Alternatively, this escrow functionality can be replaced with an internal contract which holds <code>usdm</code> tokens instead, removing the need to convert half of the tokens to Curve tokens. Holding Curve tokens for a minimum of 90 days may overly expose the Mochi treasury to Curve token price fluctuations.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/168\">ryuheimat (Mochi) confirmed</a></strong></p>\n<h1 id=\"low-risk-findings-10\" style=\"position:relative;\"><a href=\"#low-risk-findings-10\" aria-label=\"low risk findings 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (10)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/171\">[L-01] <code>MochiVault.flashFee()</code> May Truncate Result</a> <em>Submitted by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/106\">[L-02] <code>FeePoolV0.sol</code> Lack of input validation</a> <em>Submitted by WatchPug, also found by cmichel and pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/105\">[L-03] Minor precision loss</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/122\">[L-04] Key currencies can be double counted</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/123\">[L-05] Mochi fees can be accidentally burned</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/124\">[L-06] Flashloan fee griefing attack for existing approvals</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/128\">[L-07] Unsafe <code>int256</code> casts in <code>accrueDebt</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/76\">[L-08] Unchecked low level call</a> <em>Submitted by loop, also found by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/136\">[L-09] <code>UniswapV2CSSR</code> assumes data was observed when block state was inserted</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/37\">[L-10] FRONT-RUNNABLE INITIALIZERS</a> <em>Submitted by defsec, also found by pants</em></li>\n</ul>\n<h1 id=\"non-critical-findings-18\" style=\"position:relative;\"><a href=\"#non-critical-findings-18\" aria-label=\"non critical findings 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (18)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/32\">[N-01] Missing events for governor only functions that change critical parameters</a> <em>Submitted by defsec, also found by hyh, leastwood, nikitastupin, pants, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/56\">[N-02] borrow function will underflow when total debt > creditCap</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/51\">[N-03] Vault status is not set to Liquidated after liquidation</a> <em>Submitted by gzeon, also found by cmichel, gpersoon, harleythedog, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/162\">[N-04] <code>MochiTreasuryV0.sol</code> Implements <code>receive()</code> Function With No Withdraw Mechanism</a> <em>Submitted by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/163\">[N-05] <code>MochiTreasuryV0.claimOperationCost()</code> Writes State Variable After An External Call Is Made</a> <em>Submitted by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/167\">[N-06] Mochi Protocol Is Lacking Extensive Test Coverage</a> <em>Submitted by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/170\">[N-07] <code>flashLoan()</code> is Lacking Protections Against Reentrancy</a> <em>Submitted by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/31\">[N-08] Lack of input validation of arrays</a> <em>Submitted by gzeon, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/113\">[N-09] Typos</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/36\">[N-10] ERC20 approve method missing return value check</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/26\">[N-11] Not all functions of <code>DutchAuctionLiquidator.sol</code> check the auction state</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/86\">[N-12] Missing zero-address checks</a> <em>Submitted by loop, also found by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/2\">[N-13] flashFee lack of precision</a> <em>Submitted by pants</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/50\">[N-14] Unable to deposit to liquidated vault as specified</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/70\">[N-15] Misspelling: Collaterized should be Collateralized</a> <em>Submitted by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/74\">[N-16] Unlocked pragma version</a> <em>Submitted by loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/138\">[N-17] Comment typos</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/139\">[N-18] Open TODOs/questions</a> <em>Submitted by ye0lde</em></li>\n</ul>\n<h1 id=\"gas-optimizations-33\" style=\"position:relative;\"><a href=\"#gas-optimizations-33\" aria-label=\"gas optimizations 33 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (33)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/159\">[G-01] debts &#x3C;= _amount</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/156\">[G-02] Unchecked math</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/164\">[G-03] Gas optimizations (code simplification, memory variables addition or removal)</a> <em>Submitted by hyh, also found by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/64\">[G-04] Cached length of arrays to avoid loading them repeadetly</a> <em>Submitted by 0x0x0x, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/100\">[G-05] Initialization of <code>pair</code> can be done later to save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/102\">[G-06] <code>VestedRewardPool.sol#checkClaimable()</code> Add <code>vesting[recipient].ends > 0</code> to the condition can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/104\">[G-07] <code>DutchAuctionLiquidator.sol#triggerLiquidation()</code> Adding precondition check can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/88\">[G-08] Variable <code>liquidated</code> in MochiVault is never used</a> <em>Submitted by loop, also found by defsec, gzeon, harleythedog, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/112\">[G-09] Avoid unnecessary storage read can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/115\">[G-10] Simplify <code>sqrt()</code> can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/117\">[G-11] Declaring unnecessary immutable variables as constant can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/119\">[G-12] <code>MochiVault.sol</code> Remove redundant check can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/82\">[G-13] Save Gas With The Unchecked Keyword (MochiVault.sol)</a> <em>Submitted by ye0lde, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/67\">[G-14] multiple inter-contract references in the same function</a> <em>Submitted by jonah1005, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/47\">[G-15] Replace engine.nft().ownerOf(_id) with msg.sender in withdraw function</a> <em>Submitted by harleythedog, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/34\">[G-16] Upgrade pragma to at least 0.8.4</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/38\">[G-17] Gas Optimization on the Public Function</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/27\">[G-18] Gas optimization: Placement of require statements in MochiVault.sol</a> <em>Submitted by gzeon, also found by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/28\">[G-19] Gas optimization: Caching variables</a> <em>Submitted by gzeon, also found by pauliax and ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/30\">[G-20] Gas optimization: Struct layout</a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/54\">[G-21] Gas optimization: Struct layout in <code>DutchAuctionLiquidator.sol</code></a> <em>Submitted by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/42\">[G-22] Unused storage variable in UsdmMinter.sol</a> <em>Submitted by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/71\">[G-23] Unnecessary require in settleLiquidation </a> <em>Submitted by harleythedog</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/83\">[G-24] Calling <code>sushiCSSR.getLiquidity</code> two times leads to increased gas cost without benefits</a> <em>Submitted by nikitastupin</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/150\">[G-25] Improve precision and gas costs in_shareMochi</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/152\">[G-26] Cache the results of duplicate external calls</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/153\">[G-27] Pack structs tightly</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/154\">[G-28] Useless imports</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/158\">[G-29] Duplicate math operations</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/160\">[G-30] Duplicate check of supported token on flash loan</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/41\">[G-31] Long Revert Strings</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/43\">[G-32] Reduce State Variable Use in VestedRewardPool.sol</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-10-mochi-findings/issues/79\">[G-33] Remove extra calls in updateReserve (FeePoolV0.sol)</a> <em>Submitted by ye0lde</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-13\">High Risk Findings (13)</a></p>\n<ul>\n<li><a href=\"#h-01-vault-fails-to-track-debt-correctly-that-leads-to-bad-debt\">[H-01] Vault fails to track debt correctly that leads to bad debt</a></li>\n<li><a href=\"#h-02-feepoolv0soldistributemochi-will-unexpectedly-flush-treasuryshare-causing-the-protocol-fee-cannot-be-properly-accounted-for-and-collected\">[H-02] <code>FeePoolV0.sol#distributeMochi()</code> will unexpectedly flush <code>treasuryShare</code>, causing the protocol fee cannot be properly accounted for and collected</a></li>\n<li><a href=\"#h-03-referralfeepoolv0solclaimrewardasmochi-array-out-of-bound-exception\">[H-03] <code>ReferralFeePoolV0.sol#claimRewardAsMochi()</code> Array out of bound exception</a></li>\n<li><a href=\"#h-04-registerasset-can-overwrite-_assetclass-value\">[H-04] <code>registerAsset()</code> can <code>overwrite _assetClass</code> value</a></li>\n<li><a href=\"#h-05-debts-calculation-is-not-accurate\">[H-05] <code>debts</code> calculation is not accurate</a></li>\n<li><a href=\"#h-06-referrer-can-drain-referralfeepoolv0\">[H-06] Referrer can drain <code>ReferralFeePoolV0</code></a></li>\n<li><a href=\"#h-07-liquidation-will-never-work-with-non-zero-discounts\">[H-07] Liquidation will never work with non-zero discounts</a></li>\n<li><a href=\"#h-08-anyone-can-extend-withdraw-wait-period-by-depositing-zero-collateral\">[H-08] Anyone can extend withdraw wait period by depositing zero collateral</a></li>\n<li><a href=\"#h-09-treasury-is-vulnerable-to-sandwich-attack\">[H-09] treasury is vulnerable to sandwich attack</a></li>\n<li><a href=\"#h-10-changing-nft-contract-in-the-mochiengine-would-break-the-protocol\">[H-10] Changing NFT contract in the <code>MochiEngine</code> would break the protocol</a></li>\n<li><a href=\"#h-11-treasuryshare-is-overwritten-in-feepoolv0_sharemochi\">[H-11] <code>treasuryShare</code> is Overwritten in <code>FeePoolV0._shareMochi()</code></a></li>\n<li><a href=\"#h-12-feepool-is-vulnerable-to-sandwich-attack\">[H-12] feePool is vulnerable to sandwich attack.</a></li>\n<li><a href=\"#h-13-tokens-can-be-stolen-by-frontrunning-vestedrewardpoolvest-and-vestedrewardpoollock\">[H-13] Tokens Can Be Stolen By Frontrunning <code>VestedRewardPool.vest()</code> and <code>VestedRewardPool.lock()</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-15\">Medium Risk Findings (15)</a></p>\n<ul>\n<li><a href=\"#m-01-liquidation-factor--collateral-factor-for-sigma-type\">[M-01] liquidation factor &#x3C; collateral factor for Sigma type</a></li>\n<li><a href=\"#m-02-regerralfeepool-is-vulnerable-to-mev-searcher\">[M-02] <code>regerralFeePool</code> is vulnerable to MEV searcher</a></li>\n<li><a href=\"#m-03-a-malicious-user-can-potentially-escape-liquidation-by-creating-a-dust-amount-position-and-trigger-the-liquidation-by-themself\">[M-03] A malicious user can potentially escape liquidation by creating a dust amount position and trigger the liquidation by themself</a></li>\n<li><a href=\"#m-04-unchecked-erc20-transfer-calls\">[M-04] Unchecked ERC20 transfer calls</a></li>\n<li><a href=\"#m-05-chainlinks-latestrounddata-might-return-stale-or-incorrect-results\">[M-05] Chainlink’s <code>latestRoundData</code> might return stale or incorrect results</a></li>\n<li><a href=\"#m-06-debt-accrual-is-path-dependant-and-inaccurate\">[M-06] Debt accrual is path-dependant and inaccurate</a></li>\n<li><a href=\"#m-07-changing-enginenft-contract-breaks-vaults\">[M-07] Changing engine.nft contract breaks vaults</a></li>\n<li><a href=\"#m-08-uniswapv2sushiwaplpadapter-update-the-wrong-token\">[M-08] <code>UniswapV2/SushiwapLPAdapter</code> update the wrong token</a></li>\n<li><a href=\"#m-09-uniswapv2tokenadapter-does-not-support-sushiswap-only-assets\">[M-09] <code>UniswapV2TokenAdapter</code> does not support Sushiswap-only assets</a></li>\n<li><a href=\"#m-10-griefing-attack-to-block-withdraws\">[M-10] griefing attack to block withdraws</a></li>\n<li><a href=\"#m-11-borrow-function-will-borrow-max-cf-when-trying-to-borrow--cf\">[M-11] borrow function will borrow max cf when trying to borrow > cf</a></li>\n<li><a href=\"#m-12-anyone-can-create-a-vault-by-directly-calling-the-factory\">[M-12] anyone can create a vault by directly calling the factory</a></li>\n<li><a href=\"#m-13-improper-validation-of-create2-return-value\">[M-13] Improper Validation Of <code>create2</code> Return Value</a></li>\n<li><a href=\"#m-14-mochitreasuryv0withdrawlock-is-callable-when-locking-has-been-toggled\">[M-14] <code>MochiTreasuryV0.withdrawLock()</code> Is Callable When Locking Has Been Toggled</a></li>\n<li><a href=\"#m-15-mochitreasuryv0sol-is-unusable-in-its-current-state\">[M-15] <code>MochiTreasuryV0.sol</code> Is Unusable In Its Current State</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-10\">Low Risk Findings (10)</a></li>\n<li><a href=\"#non-critical-findings-18\">Non-Critical Findings (18)</a></li>\n<li><a href=\"#gas-optimizations-33\">Gas Optimizations (33)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of the Mochi smart contract system written in Solidity. The code contest took place between October 21—October 27 2021.\n\n## Wardens\n\n16 Wardens contributed reports to the Mochi code contest:\n\n1. [jonah1005](https://twitter.com/jonah1005w)\n2. [leastwood](https://twitter.com/liam_eastwood13)\n3. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n4. [cmichel](https://twitter.com/cmichelio)\n5. [gpersoon](https://twitter.com/gpersoon)\n6. harleythedog\n7. [gzeon](https://twitter.com/gzeon)\n8. [pauliax](https://twitter.com/SolidityDev)\n9. [defsec](https://twitter.com/defsec_)\n10. [ye0lde](https://twitter.com/_ye0lde)\n11. [nikitastupin](http://twitter.com/_nikitastupin)\n12. [loop](https://twitter.com/loop_225)\n13. pants\n14. 0x0x0x\n15. hyh\n\nThis contest was judged by [Ghoul.sol](https://twitter.com/Ghoulsol).\n\nFinal report assembled by [CloudEllie](https://twitter.com/CloudEllie1) and [moneylegobatman](https://twitter.com/money_lego).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 38 unique vulnerabilities and 89 total findings. All of the issues presented here are linked back to their original finding.\n\nOf these vulnerabilities, 13 received a risk rating in the category of HIGH severity, 15 received a risk rating in the category of MEDIUM severity, and 10 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 18 non-critical recommendations and 33 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 Mochi contest repository](https://github.com/code-423n4/2021-10-mochi), and is composed of 70 smart contracts written in the Solidity programming language and includes 3,828 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (13)\n\n## [[H-01] Vault fails to track debt correctly that leads to bad debt](https://github.com/code-423n4/2021-10-mochi-findings/issues/72)\n_Submitted by jonah1005, also found by WatchPug_\n\n#### Impact\nIt's similar to the issue \"misuse amount as increasing debt in the vault contract\".\nSimilar issue in a different place that leads to different exploit patterns and severity.\n\nWhen users borrow usdm from a vault, the debt increases by the amount \\* 1.005.\n\n```solidity\n    uint256 increasingDebt = (_amount * 1005) / 1000;\n```\n\nHowever, when the contract records the total debt it uses `_amount` instead of `increasingDebt`.\n\n```solidity\ndetails[_id].debtIndex =\n    (details[_id].debtIndex * (totalDebt)) /\n    (details[_id].debt + _amount);\ndetails[_id].debt = totalDebt;\ndetails[_id].status = Status.Active;\ndebts += _amount;\n```\n\n[MochiVault.sol L242-L249](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol#L242-L249)\n\nThe contract's debt is inconsistent with the total sum of all users' debt. The bias increases overtime and would break the vault at the end.\n\nFor simplicity, we assume there's only one user in the vault.\nExample:\n\n1.  User deposits 1.2 M worth of BTC and borrows 1M USDM.\n2.  The user's debt (`details[_id].debt`) would be 1.005 M as there's a .5 percent fee.\n3.  The contract's debt is 1M.\n4.  BTC price decrease by 20 percent\n5.  The liquidator tries to liquidate the position.\n6.  The liquidator repays 1.005 M and the contract tries to sub the debt by 1.005 M\n7.  The transaction is reverted as `details[_id].debt -= _usdm;` would raise exception.\n\ninaccurate accounting would lead to serious issues. I consider this a high-risk issue.\n\n#### Proof of Concept\nThis is a web3.py script that a liquidation may fail.\n\n```python\ndeposit_amount = 10**18\nbig_deposit = deposit_amount * 100000\nminter.functions.mint(user, big_deposit).transact()\n\ndai.functions.approve(vault.address, big_deposit + deposit_amount).transact()\n\n# create two positions\nvault.functions.mint(user, zero_address).transact()\nvault.functions.mint(user, zero_address).transact()\n\n# # borrow max amount\nvault.functions.increase(0, big_deposit, big_deposit, zero_address, '').transact()\nvault.functions.increase(1, deposit_amount, deposit_amount, zero_address, '').transact()\n\nvault_debt = vault.functions.debts().call()\n\n# ## This would clear out all debt in vault.\nrepay_amount = vault_debt + 10**18\nusdm.functions.approve(vault.address, repay_amount).transact()\n\nvault.functions.repay(0, repay_amount).transact()\n\nprint('debt left:', vault.functions.debts().call())\n# ## All the positions would not be liquidated from now on\n\ndai_price = cssr_factory.functions.getPrice(dai.address).call()\ncssr_factory.functions.setPrice(dai.address, dai_price[0] // 10).transact()\n\n## this would revert\nliquidator.functions.triggerLiquidation(dai.address, 1).transact()\n```\n\n#### Recommended Mitigation Steps\nI believe this is a mistake. Recommend to check the contract to make sure `increasingDebt` is used consistently.\n\n## [[H-02] `FeePoolV0.sol#distributeMochi()` will unexpectedly flush `treasuryShare`, causing the protocol fee cannot be properly accounted for and collected](https://github.com/code-423n4/2021-10-mochi-findings/issues/114)\n_Submitted by WatchPug_\n\n`distributeMochi()` will call `_buyMochi()` to convert `mochiShare` to Mochi token and call `_shareMochi()` to send Mochi to vMochi Vault and veCRV Holders. It wont touch the `treasuryShare`.\n\nHowever, in the current implementation, `treasuryShare` will be reset to `0`. This is unexpected and will cause the protocol fee can not be properly accounted for and collected.\n\n[`FeePoolV0.sol#L79` L95](https://github.com/code-423n4/2021-10-mochi/blob/8458209a52565875d8b2cefcb611c477cefb9253/projects/mochi-core/contracts/feePool/FeePoolV0.sol#L79-L95)\n\n```solidity\nfunction _shareMochi() internal {\n    IMochi mochi = engine.mochi();\n    uint256 mochiBalance = mochi.balanceOf(address(this));\n    // send Mochi to vMochi Vault\n    mochi.transfer(\n        address(engine.vMochi()),\n        (mochiBalance * vMochiRatio) / 1e18\n    );\n    // send Mochi to veCRV Holders\n    mochi.transfer(\n        crvVoterRewardPool,\n        (mochiBalance * (1e18 - vMochiRatio)) / 1e18\n    );\n    // flush mochiShare\n    mochiShare = 0;\n    treasuryShare = 0;\n}\n```\n\n##### Impact\nAnyone can call `distributeMochi()` and reset `treasuryShare` to `0`, and then call `updateReserve()` to allocate part of the wrongfuly resetted `treasuryShare` to `mochiShare` and call `distributeMochi()`.\n\nRepeat the steps above and the `treasuryShare` will be consumed to near zero, profits the vMochi Vault holders and veCRV Holders. The protocol suffers the loss of funds.\n\n##### Recommendation\nChange to:\n\n```solidity\nfunction _buyMochi() internal {\n    IUSDM usdm = engine.usdm();\n    address[] memory path = new address[](2);\n    path[0] = address(usdm);\n    path[1] = address(engine.mochi());\n    usdm.approve(address(uniswapRouter), mochiShare);\n    uniswapRouter.swapExactTokensForTokens(\n        mochiShare,\n        1,\n        path,\n        address(this),\n        type(uint256).max\n    );\n    // flush mochiShare\n    mochiShare = 0;\n}\n\nfunction _shareMochi() internal {\n    IMochi mochi = engine.mochi();\n    uint256 mochiBalance = mochi.balanceOf(address(this));\n    // send Mochi to vMochi Vault\n    mochi.transfer(\n        address(engine.vMochi()),\n        (mochiBalance * vMochiRatio) / 1e18\n    );\n    // send Mochi to veCRV Holders\n    mochi.transfer(\n        crvVoterRewardPool,\n        (mochiBalance * (1e18 - vMochiRatio)) / 1e18\n    );\n}\n```\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/114)**\n\n## [[H-03] `ReferralFeePoolV0.sol#claimRewardAsMochi()` Array out of bound exception](https://github.com/code-423n4/2021-10-mochi-findings/issues/97)\n_Submitted by WatchPug, also found by pauliax_\n\n[`ReferralFeePoolV0.sol#L28` L42](https://github.com/code-423n4/2021-10-mochi/blob/8458209a52565875d8b2cefcb611c477cefb9253/projects/mochi-core/contracts/feePool/ReferralFeePoolV0.sol#L28-L42)\n\n```solidity\nfunction claimRewardAsMochi() external {\n    IUSDM usdm = engine.usdm();\n    address[] memory path = new address[](2);\n    path[0] = address(usdm);\n    path[1] = uniswapRouter.WETH();\n    path[2] = address(engine.mochi());\n    usdm.approve(address(uniswapRouter), reward[msg.sender]);\n    // we are going to ingore the slippages here\n    uniswapRouter.swapExactTokensForTokens(\n        reward[msg.sender],\n        1,\n        path,\n        address(this),\n        type(uint256).max\n    );\n```\n\nIn `ReferralFeePoolV0.sol#claimRewardAsMochi()`, `path` is defined as an array of length 2 while it should be length 3.\n\nAs a result, at L33, an out-of-bound exception will be thrown and revert the transaction.\n\n##### Impact\n`claimRewardAsMochi()` will not work as expected so that all the referral fees cannot be claimed but stuck in the contract.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/97)**\n\n## [[H-04] `registerAsset()` can `overwrite _assetClass` value](https://github.com/code-423n4/2021-10-mochi-findings/issues/20)\n_Submitted by gpersoon, also found by jonah1005 and leastwood_\n\n#### Impact\nEveryone can call the function `registerAsset()` of MochiProfileV0.sol\nAssuming the liquidity for the asset is sufficient, `registerAsset()` will reset the \\_assetClass of an already registered asset to `AssetClass.Sigma`.\n\nWhen the \\_assetClass is changed to `AssetClass.Sigma` then `liquidationFactor()`, `riskFactor()`, `maxCollateralFactor()`, `liquidationFee()` `keeperFee()` `maxFee()` will also return a different value.\nThen the entire vault will behave differently.\nThe threshold for liquidation will also be different, possibly leading to a liquidation that isn't supposed to happen.\n\n#### Recommended Mitigation Steps\nAdd the following in function `registerAsset()`:\n```solidity\nrequire(\\_assetClass\\[\\_asset] ==0,\"Already exists\");\n```\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/20)**\n\n## [[H-05] `debts` calculation is not accurate](https://github.com/code-423n4/2021-10-mochi-findings/issues/25)\n_Submitted by gpersoon_\n\n#### Impact\nThe value of the global variable `debts` in the contract `MochiVault.sol` is calculated in an inconsistent way.\n\nIn the function `borrow()` the variable `debts` is increased with a value excluding the fee.\nHowever in `repay()` and `liquidate()` it is decreased with the same value as `details\\[\\_id].debt` is decreased, which is including the fee.\n\nThis would mean that `debts` will end up in a negative value when all debts are repay-ed. Luckily the function `repay()` prevents this from happening.\n\nIn the meantime the value of `debts` isn't accurate.\nThis value is used directly or indirectly in:\n- `utilizationRatio()`,` stabilityFee()` `calculateFeeIndex()` of `MochiProfileV0.sol`\n- `liveDebtIndex()`, `accrueDebt()`, `currentDebt()` of `MochiVault.sol`\n\nThis means the entire debt and claimable calculations are slightly off.\n\n#### Proof of Concept\n[`vault/MochiVault` sol](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol)\n\n```solidity\nfunction borrow(..)\ndetails\\[\\_id].debt = totalDebt; // includes the fee\ndebts += \\_amount;     // excludes the fee\n\nfunction repay(..)\ndebts -= \\_amount;\\\ndetails\\[\\_id].debt -= \\_amount;\n\nfunction liquidate(..)\ndebts -= \\_usdm;\ndetails\\[\\_id].debt -= \\_usdm;\n```\n\nsee [issue page](https://github.com/code-423n4/2021-10-mochi-findings/issues/25) for referenced code.\n\n#### Recommended Mitigation Steps\nIn function `borrow()`:\nreplace\n`debts += \\_amount;`\nwith\n`debts += totalDebt`\n\n[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/25)\n\n## [[H-06] Referrer can drain `ReferralFeePoolV0`](https://github.com/code-423n4/2021-10-mochi-findings/issues/55)\n_Submitted by gzeon_\n\n#### Impact\nfunction `claimRewardAsMochi` in `ReferralFeePoolV0.sol` did not reduce user reward balance, allowing referrer to claim the same reward repeatedly and thus draining the fee pool.\n\n#### Proof of Concept\nDid not reduce user reward balance at L28-47 in [ReferralFeePoolV0.sol](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/ReferralFeePoolV0.sol)\n\n#### Recommended Mitigation Steps\nAdd the following lines\n\n> rewards -= reward\\[msg.sender];\n> reward\\[msg.sender] = 0;\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/55)**\n\n## [[H-07] Liquidation will never work with non-zero discounts](https://github.com/code-423n4/2021-10-mochi-findings/issues/66)\n_Submitted by harleythedog_\n\n#### Impact\nRight now, there is only one discount profile in the github repo: the \"`NoDiscountProfile`\" which does not discount the debt at all. This specific discount profile works correctly, but I claim that any other discount profile will result in liquidation never working.\n\nSuppose that we instead have a discount profile where `discount()` returns any value strictly larger than 0. Now, suppose someone wants to trigger a liquidation on a position. First, `triggerLiquidation` will be called (within `DutchAuctionLiquidator.sol`). The variable \"debt\" is initialized as equal to `vault.currentDebt(\\_nftId)`. Notice that `currentDebt(\\_ndfId)` (within `MochiVault.sol`) simply scales the current debt of the position using the `liveDebtIndex()` function, but there is no discounting being done within the function - this will be important.\n\nBack within the `triggerLiquidation` function, the variable \"collateral\" is  simply calculated as the total collateral of the position. Then, the function calls `vault.liquidate(\\_nftId, collateral, debt)`, and I claim that this will never work due to underflow.  Indeed, the liquidate function will first update the debt of the position (due to the `updateDebt(\\_id)` modifier). The debt of the position is thus updated using lines 99-107 in `MochiVault.sol`. We can see that the `details\\[\\_id].debt` is updated in the exact same way as the calculations for `currentDebt(\\_nftId)`, however, there is the extra subtraction of the `discountedDebt` on line 107.\n\nEventually we will reach line 293 in `MochiVault.sol`. However, since we discounted the debt in the calculation of `details\\[\\_id].debt`, but we did not discount the debt for the passed in parameter \\_usdm (and thus is strictly larger in value), line 293 will always error due to an underflow. In summary, any discount profile that actually discounts the debt of the position will result in all liquidations erroring out due to this underflow. Since no positions will be liquidatable, this represents a major flaw in the contract as then no collateral can be liquidated so the entire functionality of the contract is compromised.\n\n#### Proof of Concept\n- [Liquidate function in `MochiVault.sol`](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol#:~:text=function-,liquidate,-)\n- [`triggerLiquidation` function in `DutchAuctionLiquidator.sol`](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/liquidator/DutchAuctionLiquidator.sol#:~:text=function-,triggerLiquidation,-address%20_asset%2C%20uint256)\n\nRetracing the steps as I have described above, we can see that any call to `triggerLiquidation` will result in:\n\n```solidity\ndetails\\[\\_id].debt -= \\_usdm;\n```\n\nthrowing an error since \\_usdm will be larger than `details\\[\\_id].debt`.\n\n#### Recommended Mitigation Steps\nAn easy fix is to simply change:\n\n`details\\[\\_id].debt -= \\_usdm;`\n\nto be:\n\n`details\\[\\_id].debt = 0;`\n\nas liquidating a position should probably just be equivalent to repaying all of the debt in the position.\n\nSide Note: If there are no other discount profiles planned to be added other than \"`NoDiscountProfile`\", then I would recommend deleting all of the discount logic entirely, since `NoDiscountProfile` doesn't actually do anything.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/66)**\n\n## [[H-08] Anyone can extend withdraw wait period by depositing zero collateral](https://github.com/code-423n4/2021-10-mochi-findings/issues/69)\n_Submitted by harleythedog, also found by WatchPug_\n\n#### Impact\nIn `MochiVault.sol`, the deposit function allows anyone to deposit collateral into any position. A malicious user can call this function with amount = 0, which would reset the amount of time the owner has to wait before they can withdraw their collateral from their position. This is especially troublesome with longer delays, as a malicious user would only have to spend a little gas to lock out all other users from being able to withdraw from their positions, compromising the functionality of the contract altogether.\n\n#### Proof of Concept\n\nthe `deposit` function [here](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol#:~:text=function-,deposit,-uint256%20_id%2C%20uint256)\n\nNotice that calling this function with amount = 0 is not disallowed. This overwrites `lastDeposit\\[\\_id]`, extending the wait period before a withdraw is allowed.\n\n#### Recommended Mitigation Steps\nI would recommend adding:\n\n`require(amount > 0, \"zero\")`\n\nat the start of the function, as depositing zero collateral does not seem to be a necessary use case to support.\n\nIt may also be worthwhile to consider only allowing the owner of a position to deposit collateral.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/69)**\n\n## [[H-09] treasury is vulnerable to sandwich attack](https://github.com/code-423n4/2021-10-mochi-findings/issues/60)\n_Submitted by jonah1005_\n\n#### Impact\nThere's a permissionless function `veCRVlock` in `MochiTreasury`. Since everyone can trigger this function, the attacker can launch a sandwich attack with flashloan to steal the funds.\n[MochiTreasuryV0.sol#L73-L94](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/treasury/MochiTreasuryV0.sol#L73-L94)\n\nAttackers can possibly steal all the funds in the treasury. I consider this is a high-risk issue.\n\n#### Proof of Concept\n[MochiTreasuryV0.sol#L73-L94](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/treasury/MochiTreasuryV0.sol#L73-L94)\n\nHere's an exploit pattern\n\n1.  Flashloan and buy CRV the uniswap pool\n2.  Trigger `veCRVlock()`\n3.  The treasury buys CRV at a very high price.\n4.  Sell CRV and pay back the loan.\n\n#### Recommended Mitigation Steps\nRecommend to add `onlyOwner` modifier.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/60)**\n\n## [[H-10] Changing NFT contract in the `MochiEngine` would break the protocol](https://github.com/code-423n4/2021-10-mochi-findings/issues/63)\n_Submitted by jonah1005_\n\n#### Impact\n`MochiEngine` allows the operator to change the NFT contract in [MochiEngine.sol#L91-L93](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/MochiEngine.sol#L91-L93)\n\nAll the vaults would point to a different NFT address. As a result, users would not be access their positions. The entire protocol would be broken.\n\nIMHO, A function that would break the entire protocol shouldn't exist.\n\nI consider this is a high-risk issue.\n\n#### Proof of Concept\n[MochiEngine.sol#L91-L93](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/MochiEngine.sol#L91-L93)\n\n#### Recommended Mitigation Steps\nRemove the function.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/63)**\n\n## [[H-11] `treasuryShare` is Overwritten in `FeePoolV0._shareMochi()`](https://github.com/code-423n4/2021-10-mochi-findings/issues/89)\n_Submitted by leastwood_\n\n#### Impact\nThe `FeePoolV0.sol` contract accrues fees upon the liquidation of undercollaterised positions. These fees are split between treasury and `vMochi` contracts. However, when `distributeMochi()` is called to distribute `mochi` tokens to `veCRV` holders, both `mochiShare` and `treasuryShare` is flushed from the contract when there are still `usdm` tokens in the contract.\n\n#### Proof of Concept\nConsider the following scenario:\n\n*   The `FeePoolV0.sol` contract contains 100 `usdm` tokens at an exchange rate of 1:1 with `mochi` tokens.\n*   `updateReserve()` is called to set the split of `usdm` tokens such that `treasuryShare` has claim on 20 `usdm` tokens and `mochiShare` has claim on the other 80 tokens.\n*   A `veCRV` holder seeks to increase their earnings by calling `distributeMochi()` before `sendToTreasury()` has been called.\n*   As a result, 80 `usdm` tokens are converted to `mochi` tokens and  locked in a curve rewards pool.\n*   Consequently, `mochiShare` and `treasuryShare` is set to `0` (aka flushed).\n*   The same user calls `updateReserve()` to split the leftover 20 `usdm` tokens between `treasuryShare` and `mochiShare`.\n*   `mochiShare` is now set to 16 `usdm` tokens.\n*   The above process is repeated to distribute `mochi` tokens to `veCRV` holders again and again.\n*   The end result is that `veCRV` holders have been able to receive all tokens that were intended to be distributed to the treasury.\n\n\n[`FeePoolV0.sol` L94](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/FeePoolV0.sol#L94)\n\n#### Tools Used\n- Manual code review\n- Discussions with the Mochi team.\n\n#### Recommended Mitigation Steps\nConsider removing the line in `FeePoolV0.sol` (mentioned above), where `treasuryShare` is flushed.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/89)**\n\n## [[H-12] feePool is vulnerable to sandwich attack.](https://github.com/code-423n4/2021-10-mochi-findings/issues/65)\n_Submitted by jonah1005_\n\n#### Impact\nThere's a permissionless function `distributeMochi` in [FeePoolV0.sol L55-L62](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/FeePoolV0.sol#L55-L62). Since everyone can trigger this function, an attacker can launch a sandwich attack with flashloan to steal the funds.\n\nThe devs have mentioned this concern in the comment. An attacker can steal the funds with a flash loan attack.\n\nAttackers can steal all the funds in the pool. I consider this is a high-risk issue.\n\n#### Proof of Concept\n[FeePoolV0.sol#L55-L62](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/FeePoolV0.sol#L55-L62)\n\nPlease refer to [yDai Incident](https://peckshield.medium.com/the-ydai-incident-analysis-forced-investment-2b8ac6058eb5) to check the severity of a `harvest` function without slippage control.\n\nPlease refer to [Mushrooms-finance-theft](https://medium.com/immunefi/mushrooms-finance-theft-of-yield-bug-fix-postmortem-16bd6961388f) to check how likely this kind of attack might happen.\n\n#### Recommended Mitigation Steps\nIf the dev wants to make this a permissionless control, the contract should calculate a min return based on TWAP and check the slippage.\n\n\n### Comments:\n**[ryuheimat (Mochi) disputed](https://github.com/code-423n4/2021-10-mochi-findings/issues/65#issuecomment-953031170):**\n > I think this is same case as https://github.com/code-423n4/2021-10-mochi-findings/issues/60\n\n**[ghoul-sol (judge) commented](https://github.com/code-423n4/2021-10-mochi-findings/issues/65#issuecomment-957027904):**\n > The same attack, different part of the code. I'll keep them both.\n\n## [[H-13] Tokens Can Be Stolen By Frontrunning `VestedRewardPool.vest()` and `VestedRewardPool.lock()`](https://github.com/code-423n4/2021-10-mochi-findings/issues/92)\n_Submitted by leastwood_\n\n#### Impact\nThe `VestedRewardPool.sol` contract is a public facing contract aimed at vesting tokens for a minimum of 90 days before allowing the recipient to withdraw their `mochi`. The `vest()` function does not utilise `safeTransferFrom()` to ensure that vested tokens are correctly allocated to the recipient. As a result, it is possible to frontrun a call to `vest()` and effectively steal a recipient's vested tokens. The same issue applies to the `lock()` function.\n\n#### Proof of Concept\n- [`VestedRewardPool.sol#L36` L46](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/emission/VestedRewardPool.sol#L36-L46)\n- [`VestedRewardPool.sol#L54` L64](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/emission/VestedRewardPool.sol#L54-L64)\n\n#### Tools Used\nManual code review\nDiscussions with the Mochi team\n\n#### Recommended Mitigation Steps\nEnsure that users understand that this function should not be interacted directly as this could result in lost `mochi` tokens. Additionally, it might be worthwhile creating a single externally facing function which calls `safeTransferFrom()`, `vest()` and `lock()` in a single transaction.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/92)**\n\n# Medium Risk Findings (15)\n\n## [[M-01] liquidation factor < collateral factor for Sigma type](https://github.com/code-423n4/2021-10-mochi-findings/issues/126)\n_Submitted by cmichel, also found by gzeon_\n\nThe `MochiProfileV0` defines liquidation and collateral factors for different asset types.\nFor the `AssetClass.Sigma` type, the liquidation factor is *less* than the collateral factor:\n\n```solidity\nfunction liquidationFactor(address _asset)\n    public\n    view\n    override\n    returns (float memory)\n{\n    AssetClass class = assetClass(_asset);\n    if (class == AssetClass.Sigma) { // } else if (class == AssetClass.Sigma) {\n        return float({numerator: 40, denominator: 100});\n    }\n}\n\nfunction maxCollateralFactor(address _asset)\n    public\n    view\n    override\n    returns (float memory)\n{\n    AssetClass class = assetClass(_asset);\n    if (class == AssetClass.Sigma) {\n        return float({numerator: 45, denominator: 100});\n    }\n}\n```\n\nThis means that one can take a loan of up to 45% of their collateral but then immediately gets liquidated as the liquidation factor is only 40%.\nThere should always be a buffer between these such that taking the max loan does not immediately lead to liquidations:\n\n> A safety buffer is maintained between max CF and LF to protect users against liquidations due to normal volatility. [Docs](https://hackmd.io/@az-/mochi-whitepaper#Collateral-Factor-CF)\n\n#### Recommended Mitigation Steps\nThe max collateral factor for the Sigma type should be higher than its liquidation factor.\n\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/126)**\n\n## [[M-02] `regerralFeePool` is vulnerable to MEV searcher](https://github.com/code-423n4/2021-10-mochi-findings/issues/62)\n_Submitted by jonah1005, also found by cmichel_\n\n#### Impact\n`claimRewardAsMochi` in the `ReferralFeePoolV0` ignores slippage. This is not a desirable design. There are a lot of MEV searchers in the current network. Swapping assets with no slippage control would get rekted. Please refer to <https://github.com/flashbots/pm>.\n\nGiven the current state of the Ethereum network, users would likely be sandwiched. I consider this is a high-risk issue.\n\n#### Proof of Concept\n[ReferralFeePoolV0.sol#L28-L48](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/feePool/ReferralFeePoolV0.sol#L28-L48)\nPlease refer to  [Mushrooms Finance Theft of Yield Bug Fix Postmortem | by Immunefi | Immunefi | Medium](https://medium.com/immunefi/mushrooms-finance-theft-of-yield-bug-fix-postmortem-16bd6961388f) to see a possible attack pattern.\n\n#### Recommended Mitigation Steps\nI recommend adding `minReceivedAmount` as a parameter.\n\n```solidity\nfunction claimRewardAsMochi(uint256 _minReceivedAmount) external {\n    // original logic here\n    require(engine.mochi().balanceOf(address(this)) > _minReceivedAmount, \"!min\");\n    engine.mochi().transfer(\n        msg.sender,\n        engine.mochi().balanceOf(address(this))\n    );\n}\n```\n\nAlso, the front-end should calculate the min amount with the current price.\n\n[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/62)\n\n## [[M-03] A malicious user can potentially escape liquidation by creating a dust amount position and trigger the liquidation by themself](https://github.com/code-423n4/2021-10-mochi-findings/issues/127)\n_Submitted by WatchPug, also found by jonah1005_\n\nIn the current implementation, a liquidated position can be used for depositing and borrowing again.\n\nHowever, if there is a liquidation auction ongoing, even if the position is now `liquidatable`, the call of `triggerLiquidation()` will still fail.\n\nThe liquidator must `settleLiquidation` first.\n\nIf the current auction is not profitable for the liquidator, say the value of the collateral can not even cover the gas cost, the liquidator may be tricked and not liquidate the new loan at all.\n\nConsidering if the liquidator bot is not as small to handle this situation (take the profit of the new liquidation and the gas cost loss of the current auction into consideration), a malicious user can create a dust amount position trigger the liquidation by themself.\n\nSince the collateral of this position is so small that it can not even cover the gas cost, liquidators will most certainly ignore this auction.\n\nThe malicious user will then deposit borrow the actual loan.\n\nWhen this loan becomes `liquidatable`, liquidators may:\n\n1.  confuse the current dust auction with the `liquidatable` position;\n2.  unable to proceed with such a complex liquidation.\n\nAs a result, the malicious user can potentially escape liquidation.\n\n##### Recommendation\nConsider making liquidated positions unable to be used (for depositing and borrowing) again.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/127)**\n\n## [[M-04] Unchecked ERC20 transfer calls](https://github.com/code-423n4/2021-10-mochi-findings/issues/75)\n_Submitted by loop, also found by cmichel, defsec, gzeon, leastwood, nikitastupin, pants, and WatchPug_\n\nERC20 `transfer` and `transferFrom` calls normally return `true` on a succesful transfer. In DutchAuctionLiquidator the call `asset.transfer(msg.sender, _collateral);` is made. `asset` refers to whichever ERC20 asset is used for the vault of that auction. If `asset` is an ERC20 token which does not comply with the EIP-20 standard it might return `false` on a failed transaction rather than revert. In this case it would count as a valid transaction even though it is not. If a vault would be making use of USDT the transfer call would always revert as USDT returns `void` on transfers.\n\nThere are a few more transfer(From) calls which are unchecked, these are however all on a predetermined asset (mochi, usdM and crv) and unlikely to cause problems.\n\n#### Proof of Concept\nSee [issue page](https://github.com/code-423n4/reports/blob/mochi/mochi/2021-10-mochi-findings-DRAFT.md) for referenced code.\n\n\n#### Tools Used\nSlither\n\n#### Recommended Mitigation Steps\nIn other contracts the functions `cheapTransfer` and `cheapTransferFrom` are used which are part of the mochifi cheapERC20 library. These functions do check for a return value and could be used rather than `transfer` and `transferFrom`.\n\n### Comments:\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/75#issuecomment-952083361):**\n > `transferFrom` and `transfer` functions are used for mochi and usdm tokens which are standard EIP-20 tokens.\n>\n\n## [[M-05] Chainlink's `latestRoundData` might return stale or incorrect results](https://github.com/code-423n4/2021-10-mochi-findings/issues/87)\n_Submitted by nikitastupin, also found by cmichel, defsec, leastwood, and WatchPug_\n\n#### Proof of Concept\n[`ChainlinkAdapter.sol` L49](https://github.com/code-423n4/2021-10-mochi/blob/8458209a52565875d8b2cefcb611c477cefb9253/projects/mochi-cssr/contracts/adapter/ChainlinkAdapter.sol#L49)\n\nThe `ChainlinkAdapter` calls out to a Chainlink oracle receiving the `latestRoundData()`. If there is a problem with Chainlink starting a new round and finding consensus on the new value for the oracle (e.g. Chainlink nodes abandon the oracle, chain congestion, vulnerability/attacks on the chainlink system) consumers of this contract may continue using outdated stale or incorrect data (if oracles are unable to submit no new round is started).\n\n#### Recommended Mitigation Steps\nRecommend adding the following checks:\n```solidity\n    ( roundId, rawPrice, , updateTime, answeredInRound ) = AggregatorV3Interface(XXXXX).latestRoundData();\n    require(rawPrice > 0, \"Chainlink price <= 0\");\n    require(updateTime != 0, \"Incomplete round\");\n    require(answeredInRound >= roundId, \"Stale price\");\n```\n#### References\n*   <https://consensys.net/diligence/audits/2021/09/fei-protocol-v2-phase-1/#chainlinkoraclewrapper-latestrounddata-might-return-stale-results>\n*   <https://github.com/code-423n4/2021-05-fairside-findings/issues/70>\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/87)**\n\n## [[M-06] Debt accrual is path-dependant and inaccurate](https://github.com/code-423n4/2021-10-mochi-findings/issues/129)\n_Submitted by cmichel_\n\nThe total `debt` in `MochiVault.accrueDebt` increases by the current `debt` times the debt index growth.\nThis is correct but the total `debt` is then *reduced* again by the calling *user's* discounted debt, meaning, the total debt depends on which specific user performs the debt accrual.\n\nThis should not be the case.\n\n#### POC\nAssume we have a total debt of `2000`, two users A and B, where A has a debt of 1000, and B has a debt of 100.\nThe (previous) `debtIndex = 1.0` and accruing it now would increase it to `1.1`.\n\nThere's a difference if user A or B first does the accrual.\n\n###### User A accrues first\nUser A calls `accrueDebt`: `increased = 2000 * 1.1/1.0 - 2000 = 200`. Thus `debts` is first set to `2200`. The user's `increasedDebt = 1000 * 1.1 / 1.0 - 1000 = 100` and assume a discount of `10%`, thus `discountedDebt = 100 * 10% = 10`.\nThen `debts = 2200 - 10 = 2190`.\n\nThe next accrual will work with a total debt of `2190`.\n\n###### User B accruess first\nUser B calls `accrueDebt`: `increased = 2000 * 1.1/1.0 - 2000 = 200`. Thus `debts` is first set to `2200`. The user's `increasedDebt = 100 * 1.1 / 1.0 - 100 = 10` and assume a discount of `10%`, thus `discountedDebt = 10 * 10% = 1`.\nThen `debts = 2200 - 1 = 2199`.\n\nThe next accrual will work with a total debt of `2199`, leading to more debt overall.\n\n#### Impact\nThe total debt of a system depends on who performs the accruals which should ideally not be the case.\nThe discrepancy compounds and can grow quite large if a whale always does the accrual compared to someone with almost no debt or no discount.\n\n#### Recommended Mitigation Steps\nDon't use the discounts or track the weighted average discount across all users that is subtracted from the increased total debt each time, i.e., reduce it by the discount of **all users** (instead of current caller only) when accruing to correctly track the debt.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/129)**\n\n## [[M-07] Changing engine.nft contract breaks vaults](https://github.com/code-423n4/2021-10-mochi-findings/issues/130)\n_Submitted by cmichel_\n\nGovernance can change the `engine.nft` address which is used by vaults to represent collateralized debt positions (CDP).\nWhen minting a vault using `MochiVault.mint` the address returned ID will be used and overwrite the state of an existing debt position and set its status to `Idle`.\n\n#### Impact\nChanging the NFT address will allow overwriting existing CDPs.\n\n#### Recommended Mitigation Steps\nDisallow setting a new NFT address. or ensure that the new NFT's IDs start at the old NFT's IDs.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/130)**\n\n## [[M-08] `UniswapV2/SushiwapLPAdapter` update the wrong token](https://github.com/code-423n4/2021-10-mochi-findings/issues/134)\n_Submitted by cmichel_\n\nThe `UniswapV2LPAdapter/SushiswapV2LPAdapter.update` function retrieves the `underlying` from the LP token pair (`_asset`) but then calls `router.update(_asset, _proof)` which is the LP token itself again.\nThis will end up with the router calling this function again recursively.\n\n#### Impact\nThis function fails as there's an infinite recursion and eventually runs out of gas.\n\n#### Recommendation\nThe idea was most likely to update the `underlying` price which is used in `_getPrice` as `uint256 eAvg = cssr.getExchangeRatio(_underlying, weth);`.\n\nCall `router.update(underlying, _proof)` instead. Note that the `_proof` does not necessarily update the `underlying <> WETH` pair, it could be any `underlying <> keyAsset` pair.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/134)**\n\n## [[M-09] `UniswapV2TokenAdapter` does not support Sushiswap-only assets](https://github.com/code-423n4/2021-10-mochi-findings/issues/135)\n_Submitted by cmichel_\n\nThe `UniswapV2TokenAdapter.supports` function calls its `aboveLiquidity` function which returns the UniswapV2 liquidity if the pair exists.\nIf this is below `minimumLiquidity`, the `supports` function will return `false`.\n\nHowever, it could be that the `Sushiswap` pair has lots of liquidity and could be used.\n\n```solidity\ntry uniswapCSSR.getLiquidity(_asset, _pairedWith) returns (\n            uint256 liq\n        ) {\n    float memory price = cssrRouter.getPrice(_pairedWith);\n    // @audit this returns early. if it's false it should check sushiswap first\n    return convertToValue(liq, price) >= minimumLiquidity;\n} catch {\n    try sushiCSSR.getLiquidity(_asset, _pairedWith) returns (\n        uint256 liq\n    ) {\n        float memory price = cssrRouter.getPrice(_pairedWith);\n        return convertToValue(liq, price) >= minimumLiquidity;\n    } catch {\n        return false;\n    }\n}\n```\n\n#### Impact\nSuppose the `UniswapV2TokenAdapter` wants to be used as an adapter for a Sushiswap pool.\nAn attacker creates a UniswapV2 pool for the same pair and does not provide liquidity.\nThe `Router.setPriceSource` calls `UniswapV2TokenAdapter.supports` and returns false as the Uniswap liquidity is too low, without checking the Sushiswap liquidity.\n\n#### Recommendation\nIn `aboveLiquidity`, if the UniswapV2 liquidity is *less* than the minimum liquidity, instead of returning, compare the Sushiswap liquidity against this threshold.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/135)**\n\n## [[M-10] griefing attack to block withdraws](https://github.com/code-423n4/2021-10-mochi-findings/issues/21)\n_Submitted by gpersoon_\n\n#### Impact\nEvery time you deposit some assets in the vault (via `deposit()` of `MochiVault.sol`) then \"lastDeposit\\[\\_id]\" is set to `block.timestamp`.\nThe modifier `wait()` checks this value and makes sure you cannot withdraw for \"`delay()`\" blocks.\nThe default value for `delay()` is 3 minutes.\n\nKnowing this delay you can do a griefing attack:\nOn chains with low gas fees: every 3 minutes deposit a tiny amount for a specific NFT-id (which has a large amount of assets).\nOn chains with high gas fees: monitor the mempool for a `withdraw()` transaction and frontrun it with a `deposit()`\n\nThis way the owner of the NFT-id can never withdraw the funds.\n\n#### Proof of Concept\n- [`MochiVault.sol#L47` L54](https://github.com/code-423n4/2021-10-mochi/blob/806ebf2a364c01ff54d546b07d1bdb0e928f42c6/projects/mochi-core/contracts/vault/MochiVault.sol#L47-L54)\n- [`vault/MochiVault.sol` L171](https://github.com/code-423n4/2021-10-mochi/blob/806ebf2a364c01ff54d546b07d1bdb0e928f42c6/projects/mochi-core/contracts/vault/MochiVault.sol#L171)\n- [`profile/MochiProfileV0.sol` L33](https://github.com/code-423n4/2021-10-mochi/blob/806ebf2a364c01ff54d546b07d1bdb0e928f42c6/projects/mochi-core/contracts/profile/MochiProfileV0.sol#L33)\n\n#### Recommended Mitigation Steps\nCreate a mechanism where you only block the withdraw of recently deposited funds\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/21#issuecomment-952886314):**\n > Will update deposit function to allow only NFT owner to deposit\n\n## [[M-11] borrow function will borrow max cf when trying to borrow > cf](https://github.com/code-423n4/2021-10-mochi-findings/issues/45)\n_Submitted by gzeon_\n\n#### Impact\nBorrow function in `MochiVault` will borrow to max cf when trying to borrow > cf instead of revert with \">cf\" as specified in the supplied test. The difference in behavior may cause user to borrow at dangerous collateral level, and receive less than the amount requested.\n\n#### Proof of Concept\n* [`MochiVault` sol](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVault.sol)\n\n#### Recommended Mitigation Steps\nRevert if `details\\[\\_id].debt` + `\\_amount` > `maxMinted` with \">cf\"\n\n\n**[ryuheimat (Mochi) conirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/45)**\n\n## [[M-12] anyone can create a vault by directly calling the factory](https://github.com/code-423n4/2021-10-mochi-findings/issues/80)\n_Submitted by jonah1005_\n\n#### Impact\nIn [MochiVaultFactory.sol#L26-L37](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/vault/MochiVaultFactory.sol#L26-L37), there's no permission control in the `vaultFactory`. Anyone can create a vault. The transaction would be reverted when the government tries to deploy such an asset.\n\nAs the protocol checks whether the vault is a valid vault by comparing the contract's address with the computed address, the protocol would recognize the random vault as a valid one.\n\nI consider this is a medium-risk issue.\n\n#### Proof of Concept\nHere's a web3.py script to trigger the bug.\n\n```py\nvault_factory.functions.deployVault(usdt.address).transact()\n## this tx would be reverted\nprofile.functions.registerAssetByGov([usdt.address], [3]).transact()\n```\n\n#### Recommended Mitigation Steps\nRecommend to add a check.\n\n```solidity\nrequire(msg.sender == engine, \"!engine\");\n```\n\n[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/80)\n\n## [[M-13] Improper Validation Of `create2` Return Value](https://github.com/code-423n4/2021-10-mochi-findings/issues/155)\n_Submitted by leastwood_\n\n#### Impact\nThe `BeaconProxyDeployer.deploy()` function is used to deploy lightweight proxy contracts that act as each asset's vault. The function does not revert properly if there is a failed contract deployment or revert from the `create2` opcode as it does not properly check the returned address for bytecode. The `create2` opcode returns the expected address which will never be the zero address (as is what is currently checked).\n\n#### Proof of Concept\n- [`BeaconProxyDeployer.sol` L31](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-library/contracts/BeaconProxyDeployer.sol#L31)\n\n#### Tools Used\n- Manual code review\n- Discussions with the Mochi team\n- Discussions with library dev\n\n#### Recommended Mitigation Steps\nThe recommended mitigation was to update `iszero(result)` to `iszero(extcodesize(result))` in the line mentioned above. This change has already been made in the corresponding library which can be found [here](https://github.com/Nipol/bean-contracts/pull/13), however, this needs to also be reflected in Mochi's contracts.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/155)**\n\n## [[M-14] `MochiTreasuryV0.withdrawLock()` Is Callable When Locking Has Been Toggled](https://github.com/code-423n4/2021-10-mochi-findings/issues/161)\n_Submitted by leastwood_\n\n#### Impact\n`withdrawLock()` does not prevent users from calling this function when locking has been toggled. As a result, withdraws may be made unexpectedly.\n\n#### Proof of Concept\n- [`MochiTreasuryV0.sol#L40` L42](https://github.com/code-423n4/2021-10-mochi/blob/main/projects/mochi-core/contracts/treasury/MochiTreasuryV0.sol#L40-L42)\n\n#### Tools Used\nManual code review\n\n#### Recommended Mitigation Steps\nConsider adding `require(lockCrv, \"!lock\");` to `withdrawLock()` to ensure this function is not called unexpectedly. Alternatively if this is intended behaviour, it should be rather checked that the lock has not been toggled, otherwise users could maliciously relock tokens.\n\n[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/161)\n\n## [[M-15] `MochiTreasuryV0.sol` Is Unusable In Its Current State](https://github.com/code-423n4/2021-10-mochi-findings/issues/168)\n_Submitted by leastwood_\n\n#### Impact\n`MochiTreasuryV0.sol` interacts with Curve's voting escrow contract to lock tokens for 90 days, where it can be later withdrawn by the governance role. However, `VotingEscrow.vy` does not allow contracts to call the following functions; `create_lock()`, `increase_amount()` and `increase_unlock_time()`. For these functions, `msg.sender` must be an EOA account or an approved smart wallet. As a result, any attempt to lock tokens will fail in `MochiTreasuryV0.sol`.\n\n#### Proof of Concept\n- [`VotingEscrow.vy` L418](https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L418)\n- [`VotingEscrow.vy` L438](https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L438)\n- [`VotingEscrow.vy` L455](https://github.com/curvefi/curve-dao-contracts/blob/master/contracts/VotingEscrow.vy#L455)\n\n\n#### Tools Used\n- Manual code review\n- Discussions with the Mochi team\n\n#### Recommended Mitigation Steps\nConsider updating this contract to potentially use another escrow service that enables `msg.sender` to be a contract. Alternatively, this escrow functionality can be replaced with an internal contract which holds `usdm` tokens instead, removing the need to convert half of the tokens to Curve tokens. Holding Curve tokens for a minimum of 90 days may overly expose the Mochi treasury to Curve token price fluctuations.\n\n**[ryuheimat (Mochi) confirmed](https://github.com/code-423n4/2021-10-mochi-findings/issues/168)**\n\n# Low Risk Findings (10)\n\n- [[L-01] `MochiVault.flashFee()` May Truncate Result](https://github.com/code-423n4/2021-10-mochi-findings/issues/171) _Submitted by leastwood_\n- [[L-02] `FeePoolV0.sol` Lack of input validation](https://github.com/code-423n4/2021-10-mochi-findings/issues/106) _Submitted by WatchPug, also found by cmichel and pauliax_\n- [[L-03] Minor precision loss](https://github.com/code-423n4/2021-10-mochi-findings/issues/105) _Submitted by WatchPug_\n- [[L-04] Key currencies can be double counted](https://github.com/code-423n4/2021-10-mochi-findings/issues/122) _Submitted by cmichel_\n- [[L-05] Mochi fees can be accidentally burned](https://github.com/code-423n4/2021-10-mochi-findings/issues/123) _Submitted by cmichel_\n- [[L-06] Flashloan fee griefing attack for existing approvals](https://github.com/code-423n4/2021-10-mochi-findings/issues/124) _Submitted by cmichel_\n- [[L-07] Unsafe `int256` casts in `accrueDebt`](https://github.com/code-423n4/2021-10-mochi-findings/issues/128) _Submitted by cmichel_\n- [[L-08] Unchecked low level call](https://github.com/code-423n4/2021-10-mochi-findings/issues/76) _Submitted by loop, also found by cmichel_\n- [[L-09] `UniswapV2CSSR` assumes data was observed when block state was inserted](https://github.com/code-423n4/2021-10-mochi-findings/issues/136) _Submitted by cmichel_\n- [[L-10] FRONT-RUNNABLE INITIALIZERS](https://github.com/code-423n4/2021-10-mochi-findings/issues/37) _Submitted by defsec, also found by pants_\n\n# Non-Critical Findings (18)\n\n- [[N-01] Missing events for governor only functions that change critical parameters](https://github.com/code-423n4/2021-10-mochi-findings/issues/32) _Submitted by defsec, also found by hyh, leastwood, nikitastupin, pants, and WatchPug_\n- [[N-02] borrow function will underflow when total debt > creditCap](https://github.com/code-423n4/2021-10-mochi-findings/issues/56) _Submitted by gzeon_\n- [[N-03] Vault status is not set to Liquidated after liquidation](https://github.com/code-423n4/2021-10-mochi-findings/issues/51) _Submitted by gzeon, also found by cmichel, gpersoon, harleythedog, and WatchPug_\n- [[N-04] `MochiTreasuryV0.sol` Implements `receive()` Function With No Withdraw Mechanism](https://github.com/code-423n4/2021-10-mochi-findings/issues/162) _Submitted by leastwood_\n- [[N-05] `MochiTreasuryV0.claimOperationCost()` Writes State Variable After An External Call Is Made](https://github.com/code-423n4/2021-10-mochi-findings/issues/163) _Submitted by leastwood_\n- [[N-06] Mochi Protocol Is Lacking Extensive Test Coverage](https://github.com/code-423n4/2021-10-mochi-findings/issues/167) _Submitted by leastwood_\n- [[N-07] `flashLoan()` is Lacking Protections Against Reentrancy](https://github.com/code-423n4/2021-10-mochi-findings/issues/170) _Submitted by leastwood_\n- [[N-08] Lack of input validation of arrays](https://github.com/code-423n4/2021-10-mochi-findings/issues/31) _Submitted by gzeon, also found by WatchPug_\n- [[N-09] Typos](https://github.com/code-423n4/2021-10-mochi-findings/issues/113) _Submitted by WatchPug_\n- [[N-10] ERC20 approve method missing return value check](https://github.com/code-423n4/2021-10-mochi-findings/issues/36) _Submitted by defsec_\n- [[N-11] Not all functions of `DutchAuctionLiquidator.sol` check the auction state](https://github.com/code-423n4/2021-10-mochi-findings/issues/26) _Submitted by gpersoon_\n- [[N-12] Missing zero-address checks](https://github.com/code-423n4/2021-10-mochi-findings/issues/86) _Submitted by loop, also found by pants_\n- [[N-13] flashFee lack of precision](https://github.com/code-423n4/2021-10-mochi-findings/issues/2) _Submitted by pants_\n- [[N-14] Unable to deposit to liquidated vault as specified](https://github.com/code-423n4/2021-10-mochi-findings/issues/50) _Submitted by gzeon_\n- [[N-15] Misspelling: Collaterized should be Collateralized](https://github.com/code-423n4/2021-10-mochi-findings/issues/70) _Submitted by harleythedog_\n- [[N-16] Unlocked pragma version](https://github.com/code-423n4/2021-10-mochi-findings/issues/74) _Submitted by loop_\n- [[N-17] Comment typos](https://github.com/code-423n4/2021-10-mochi-findings/issues/138) _Submitted by ye0lde_\n- [[N-18] Open TODOs/questions](https://github.com/code-423n4/2021-10-mochi-findings/issues/139) _Submitted by ye0lde_\n\n# Gas Optimizations (33)\n- [[G-01] debts <= _amount](https://github.com/code-423n4/2021-10-mochi-findings/issues/159) _Submitted by pauliax_\n- [[G-02] Unchecked math](https://github.com/code-423n4/2021-10-mochi-findings/issues/156) _Submitted by pauliax_\n- [[G-03] Gas optimizations (code simplification, memory variables addition or removal)](https://github.com/code-423n4/2021-10-mochi-findings/issues/164) _Submitted by hyh, also found by 0x0x0x_\n- [[G-04] Cached length of arrays to avoid loading them repeadetly](https://github.com/code-423n4/2021-10-mochi-findings/issues/64) _Submitted by 0x0x0x, also found by WatchPug_\n- [[G-05] Initialization of `pair` can be done later to save gas](https://github.com/code-423n4/2021-10-mochi-findings/issues/100) _Submitted by WatchPug_\n- [[G-06] `VestedRewardPool.sol#checkClaimable()` Add `vesting[recipient].ends > 0` to the condition can save gas](https://github.com/code-423n4/2021-10-mochi-findings/issues/102) _Submitted by WatchPug_\n- [[G-07] `DutchAuctionLiquidator.sol#triggerLiquidation()` Adding precondition check can save gas](https://github.com/code-423n4/2021-10-mochi-findings/issues/104) _Submitted by WatchPug_\n- [[G-08] Variable `liquidated` in MochiVault is never used](https://github.com/code-423n4/2021-10-mochi-findings/issues/88) _Submitted by loop, also found by defsec, gzeon, harleythedog, and WatchPug_\n- [[G-09] Avoid unnecessary storage read can save gas](https://github.com/code-423n4/2021-10-mochi-findings/issues/112) _Submitted by WatchPug_\n- [[G-10] Simplify `sqrt()` can save gas](https://github.com/code-423n4/2021-10-mochi-findings/issues/115) _Submitted by WatchPug_\n- [[G-11] Declaring unnecessary immutable variables as constant can save gas](https://github.com/code-423n4/2021-10-mochi-findings/issues/117) _Submitted by WatchPug_\n- [[G-12] `MochiVault.sol` Remove redundant check can save gas](https://github.com/code-423n4/2021-10-mochi-findings/issues/119) _Submitted by WatchPug_\n- [[G-13] Save Gas With The Unchecked Keyword (MochiVault.sol)](https://github.com/code-423n4/2021-10-mochi-findings/issues/82) _Submitted by ye0lde, also found by WatchPug_\n- [[G-14] multiple inter-contract references in the same function](https://github.com/code-423n4/2021-10-mochi-findings/issues/67) _Submitted by jonah1005, also found by WatchPug_\n- [[G-15] Replace engine.nft().ownerOf(_id) with msg.sender in withdraw function](https://github.com/code-423n4/2021-10-mochi-findings/issues/47) _Submitted by harleythedog, also found by WatchPug_\n- [[G-16] Upgrade pragma to at least 0.8.4](https://github.com/code-423n4/2021-10-mochi-findings/issues/34) _Submitted by defsec_\n- [[G-17] Gas Optimization on the Public Function](https://github.com/code-423n4/2021-10-mochi-findings/issues/38) _Submitted by defsec_\n- [[G-18] Gas optimization: Placement of require statements in MochiVault.sol](https://github.com/code-423n4/2021-10-mochi-findings/issues/27) _Submitted by gzeon, also found by harleythedog_\n- [[G-19] Gas optimization: Caching variables](https://github.com/code-423n4/2021-10-mochi-findings/issues/28) _Submitted by gzeon, also found by pauliax and ye0lde_\n- [[G-20] Gas optimization: Struct layout](https://github.com/code-423n4/2021-10-mochi-findings/issues/30) _Submitted by gzeon_\n- [[G-21] Gas optimization: Struct layout in `DutchAuctionLiquidator.sol`](https://github.com/code-423n4/2021-10-mochi-findings/issues/54) _Submitted by gzeon_\n- [[G-22] Unused storage variable in UsdmMinter.sol](https://github.com/code-423n4/2021-10-mochi-findings/issues/42) _Submitted by harleythedog_\n- [[G-23] Unnecessary require in settleLiquidation ](https://github.com/code-423n4/2021-10-mochi-findings/issues/71) _Submitted by harleythedog_\n- [[G-24] Calling `sushiCSSR.getLiquidity` two times leads to increased gas cost without benefits](https://github.com/code-423n4/2021-10-mochi-findings/issues/83) _Submitted by nikitastupin_\n- [[G-25] Improve precision and gas costs in_shareMochi](https://github.com/code-423n4/2021-10-mochi-findings/issues/150) _Submitted by pauliax_\n- [[G-26] Cache the results of duplicate external calls](https://github.com/code-423n4/2021-10-mochi-findings/issues/152) _Submitted by pauliax_\n- [[G-27] Pack structs tightly](https://github.com/code-423n4/2021-10-mochi-findings/issues/153) _Submitted by pauliax_\n- [[G-28] Useless imports](https://github.com/code-423n4/2021-10-mochi-findings/issues/154) _Submitted by pauliax_\n- [[G-29] Duplicate math operations](https://github.com/code-423n4/2021-10-mochi-findings/issues/158) _Submitted by pauliax_\n- [[G-30] Duplicate check of supported token on flash loan](https://github.com/code-423n4/2021-10-mochi-findings/issues/160) _Submitted by pauliax_\n- [[G-31] Long Revert Strings](https://github.com/code-423n4/2021-10-mochi-findings/issues/41) _Submitted by ye0lde_\n- [[G-32] Reduce State Variable Use in VestedRewardPool.sol](https://github.com/code-423n4/2021-10-mochi-findings/issues/43) _Submitted by ye0lde_\n- [[G-33] Remove extra calls in updateReserve (FeePoolV0.sol)](https://github.com/code-423n4/2021-10-mochi-findings/issues/79) _Submitted by ye0lde_\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}