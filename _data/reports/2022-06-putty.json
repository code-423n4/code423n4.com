{
  "circa": {
    "title": "Putty contest",
    "sponsor": "Putty",
    "slug": "2022-06-putty",
    "date": "Report published: 2022-08-08. Updated with Mitigation Review: 2022-09-08.",
    "findings": "https://github.com/code-423n4/2022-06-putty-findings/issues",
    "contest": 142
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Putty smart contract system written in Solidity. The audit contest took place between June 29—July 4, 2022.</p>\n<p>Following the C4 audit contest, warden hyh reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit contest report. </p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>144 Wardens contributed reports to the Putty contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li><a href=\"https://www.linkedin.com/in/minhquanym/\">minhquanym</a></li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/berndartmueller\">berndartmueller</a></li>\n<li>xiaoming90</li>\n<li>zzzitron</li>\n<li>IllIllI</li>\n<li>unforgiven</li>\n<li>horsefacts</li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li>Lambda</li>\n<li><a href=\"https://twitter.com/shunduquar\">shung</a></li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>Metatron</li>\n<li><a href=\"https://github.com/0xsanson\">0xsanson</a></li>\n<li>reassor</li>\n<li><a href=\"https://twitter.com/nonfungiblenero\">Kenshin</a></li>\n<li><a href=\"http://seanseefried.org/blog\">sseefried</a></li>\n<li>0xNineDec</li>\n<li>cccz</li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li>PwnedNoMore (<a href=\"https://www.cs.purdue.edu/homes/zhan3299/index.html\">izhuer</a>, ItsNio and papr1ka2)</li>\n<li>auditor0517</li>\n<li>0x52</li>\n<li><a href=\"https://zishansami102.github.io/\">zishansami</a></li>\n<li>sashik_eth</li>\n<li><a href=\"https://twitter.com/Pedroais2/\">pedroais</a></li>\n<li><a href=\"https://github.com/exd0tpy\">exd0tpy</a></li>\n<li>0xc0ffEE</li>\n<li><a href=\"https://twitter.com/treasuresETH\">Treasure-Seeker</a></li>\n<li><a href=\"https://twitter.com/gallodasballo\">Alex the Entreprenerd</a></li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n<li><a href=\"https://twitter.com/nomorebear\">swit</a></li>\n<li>BowTiedWardens (BowTiedHeron, BowTiedPickle, <a href=\"BowTiedETHernal\">m4rio_eth</a>, <a href=\"https://twitter.com/JustDravee\">Dravee</a>, and BowTiedFirefox)</li>\n<li>TrungOre</li>\n<li>0xA5DF</li>\n<li><a href=\"https://twitter.com/thePicodes\">Picodes</a></li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>0x1f8b</li>\n<li>ACai</li>\n<li><a href=\"https://twitter.com/0xheynacho\">ignacio</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li>Critical</li>\n<li>codexploder</li>\n<li><a href=\"https://twitter.com/zer0dots\">zer0dot</a></li>\n<li>dirk_y</li>\n<li><a href=\"https://github.com/antoncoding\">antonttc</a></li>\n<li><a href=\"https://twitter.com/itsmeSTYJ\">itsmeSTYJ</a></li>\n<li>0xDjango</li>\n<li>0xf15ers (remora and twojoy)</li>\n<li>Bnke0x0</li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li><a href=\"https://ericci.dev/\">StErMi</a></li>\n<li>ElKu</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>simon135</li>\n<li>oyc_109</li>\n<li>__141345__</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li>JohnSmith</li>\n<li><a href=\"https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219\">gogo</a></li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>_Adam</li>\n<li>cryptphi</li>\n<li><a href=\"twitter.com/rokinot\">rokinot</a></li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li>Kaiziron</li>\n<li>hake</li>\n<li>robee</li>\n<li>Limbooo</li>\n<li>Waze</li>\n<li>ReyAdmirado</li>\n<li><a href=\"https://twitter.com/wookiemad\">MadWookie</a></li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://github.com/lyciumlee\">durianSausage</a></li>\n<li>datapunk</li>\n<li>delfin454000</li>\n<li><a href=\"https://twitter.com/rajat_beladiya\">rajatbeladiya</a></li>\n<li>Hawkeye (0xwags and 0xmint)</li>\n<li>Yiko</li>\n<li><a href=\"https://twitter.com/Sm4rty_\">Sm4rty</a></li>\n<li><a href=\"https://www.amitnave.com/\">AmitN</a></li>\n<li>0x29A (0x4non and rotcivegaf)</li>\n<li>peritoflores</li>\n<li>samruna</li>\n<li>async</li>\n<li>GimelSec (<a href=\"https://twitter.com/rayn731\">rayn</a> and sces60107)</li>\n<li><a href=\"https://nethermind.io/\">Nethermind</a></li>\n<li><a href=\"https://medium.com/@saneryee-studio\">saneryee</a></li>\n<li><a href=\"https://twitter.com/doddle0x\">doddle0x</a></li>\n<li><a href=\"https://twitter.com/0xSolus\">0xSolus</a></li>\n<li>aysha</li>\n<li><a href=\"https://twitter.com/davidpius10\">David_</a></li>\n<li>Sneakyninja0129</li>\n<li>TerrierLover</li>\n<li>chatch</li>\n<li>0xkatana</li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li>grrwahrr</li>\n<li><a href=\"https://github.com/0xKitsune\">0xKitsune</a></li>\n<li>RedOneN</li>\n<li>UnusualTurtle</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>saian</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>jayfromthe13th</li>\n<li><a href=\"https://github.com/z3s/\">z3s</a></li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n<li>ajtra</li>\n<li>ak1</li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li><a href=\"https://t.me/Road220\">m_Rassska</a></li>\n<li><a href=\"https://twitter.com/mektigboy\">mektigboy</a></li>\n<li><a href=\"https://veranos.io\">mrpathfindr</a></li>\n<li><a href=\"https://twitter.com/natzuu33\">natzuu</a></li>\n<li><a href=\"https://twitter.com/randyyramadhan\">Randyyy</a></li>\n<li>slywaters</li>\n<li>sach1r0</li>\n<li>cRat1st0s</li>\n<li>ladboy233</li>\n<li>zeesaw</li>\n<li>0xHarry</li>\n<li>apostle0x01</li>\n<li>asutorufos</li>\n<li>codetilda</li>\n<li><a href=\"twitter.com/haruxeETH\">Haruxe</a></li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>StyxRave</li>\n<li>dipp</li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/HickupHH3\">hickuphh3</a>.</p>\n<p>Mitigations reviewed by <a href=\"https://twitter.com/0xhyh\">hyh</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 20 unique vulnerabilities. Of these vulnerabilities, 4 received a risk rating in the category of HIGH severity and 16 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 82 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 94 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-06-putty\">C4 Putty contest repository</a>, and is composed of 2 smart contracts written in the Solidity programming language and includes 357 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-4\" style=\"position:relative;\"><a href=\"#high-risk-findings-4\" aria-label=\"high risk findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (4)</h1>\n<h2 id=\"h-01-fee-is-being-deducted-when-put-is-expired-and-not-when-it-is-exercised\" style=\"position:relative;\"><a href=\"#h-01-fee-is-being-deducted-when-put-is-expired-and-not-when-it-is-exercised\" aria-label=\"h 01 fee is being deducted when put is expired and not when it is exercised permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269\">[H-01] Fee is being deducted when Put is expired and not when it is exercised.</a></h2>\n<p><em>Submitted by zishansami, also found by 0x52, 0xsanson, auditor0517, berndartmueller, csanuragjain, and zzzitron</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495-L503\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495-L503</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Fee is being deducted when Put is expired and not when it is exercised in <code>PuttyV2.sol</code>.\nComment section of the <code>setFee()</code> function mentions <code>\"fee rate that is applied on exercise\"</code> which signifies that the fee amount is meant to be deducted from strike only when a position is being exercised (or has been exercised).</p>\n<p>But, in function <code>withdraw()</code> at <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495-L503\">PuttyV2.solL#495-L503</a>  the fee is being deducted even when the Put position is not exercised and has expired.</p>\n<p>Also, in function <code>exercise()</code> there is no fee deduction from the <code>order.strike</code> when the Put position is exercised and the strike is being transferred to the caller (<a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451\">PuttyV2.solL#451</a>).</p>\n<p>This unintended deduction from assets of Put Shorter and the absence of fee deduction from strike when Put is exercised are directly impacting the assets and therefore marked as Medium Risk.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>if</code> condition present at <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495\">PuttyV2.solL#495</a> passes if <code>order.isCall</code> is <code>false</code> and <code>isExercised</code> is false.</p>\n<p><code>feeAmount</code> becomes positive if <code>fee > 0</code> and it gets deducted from the <code>order.strike</code> which gets transferred to <code>msg.sender</code> at line number <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L503\">PuttyV2.solL#503</a>.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Update <code>if</code> condition at <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L498\">PuttyV2.sol#L498</a> with <code>(fee > 0 &#x26;&#x26; order.isCall &#x26;&#x26; isExercised)</code></li>\n<li>Add feeAmount calculation and deduction after put is exercised and strike is transferred at <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451\">PuttyV2.sol#L451</a> as follows:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269#issuecomment-1178999683\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Report: Fees are only applied on puts if they are expired.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269#issuecomment-1179899567\">HickupHH3 (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>Due to incorrect logic, there are 2 consequences of separate severities:</p>\n<ol>\n<li>Expired put option being charged the admin fee. As @berndartmueller mentioned in <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/380\">#380</a>, the fee should be charged on the premium (actually this is another issue, see <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/373\">#373</a>). Since it is possible for the fee amount to be greater than expected, I consider this to be a loss of assets and therefore given a high severity rating.</li>\n<li>Put option not being charged fee upon exercising it. This can be considered to the “protocol leaked value” and thus be given a medium severity rating.</li>\n</ol>\n<p>Issues that mention (1) or both (1) and (2) will be given a high severity rating, those that mention only (2) will be given a medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269#issuecomment-1185405136\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/4\">https://github.com/outdoteth/putty-v2/pull/4</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed by changing the fee base to be <code>order.premium</code> <a href=\"https://github.com/outdoteth/putty-v2/pull/4\"><code>PR#4</code></a>, which is now paid uniformly for all option types on order filling. Utilizing <code>order.strike</code> as the fee base was the root cause for <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/285\">M-04</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/296\">M-06</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/422\">M-11</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/373\">M-15</a>, so the change to <code>order.premium</code> was a shared mitigation for all of them.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-acceptcounteroffer-may-result-in-both-orders-being-filled\" style=\"position:relative;\"><a href=\"#h-02-acceptcounteroffer-may-result-in-both-orders-being-filled\" aria-label=\"h 02 acceptcounteroffer may result in both orders being filled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/44\">[H-02] <code>acceptCounterOffer()</code> May Result In Both Orders Being Filled</a></h2>\n<p><em>Submitted by kirk-baird, also found by csanuragjain, hansfriese, Lambda, and minhquanym</em></p>\n<p>When a user is attempting to accept a counter offer they call the function <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L573-L584\">acceptCounterOffer()</a> with both the <code>originalOrder</code> to be cancelled and the new <code>order</code> to fill. It is possible for an attacker (or any other user who happens to call <code>fillOrder()</code> at the same time) to fill the <code>originalOrder</code> before <code>acceptCounterOffer()</code> cancels it.</p>\n<p>The impact is that both <code>originalOrder</code> and <code>order</code> are filled. The <code>msg.sender</code> of <code>acceptCounterOffer()</code> is twice as leveraged as they intended to be if the required token transfers succeed.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L573-L584\">acceptCounterOffer()</a> calls <code>cancel()</code> on the original order, however it will not revert if the order has already been filled.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">acceptCounterOffer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">originalOrder</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// cancel the original order</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">cancel</span><span class=\"mtk1\">(</span><span class=\"mtk12\">originalOrder</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// accept the counter offer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">fillOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">, </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L526-L535\">cancel()</a> does not revert if an order has already been filled it only prevents future <code>fillOrder()</code> transactions from succeeding.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">cancel</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not your order&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// mark the order as cancelled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">cancelledOrders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CancelledOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Therefore any user may front-run the <code>acceptCounterOffer()</code> transaction with a <code>fillOrder()</code> transaction that fills the original order. As a result the user ends up filling both <code>order</code> and <code>originalOrder</code>. Then <code>acceptCounterOffer()</code> cancels the <code>originalOrder</code> which is essentially a no-op since it’s been filled and continues to fill the new <code>order</code> resulting in both orders being filled.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider having <code>cancel()</code> revert if an order has already been filled. This can be done by adding the following line <code>require(_ownerOf[uint256(orderHash)] == 0)</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/44#issuecomment-1179004913\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Report: It’s possible to fill an order twice by accepting a counter offer for an already filled order.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/44#issuecomment-1185411950\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/2\">https://github.com/outdoteth/putty-v2/pull/2</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed by requiring that order can’t be in the filled state on cancel. This fully adheres to the original logic, but wasn’t controlled for before.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-create-a-short-call-order-with-non-empty-floor-makes-the-option-impossible-to-exercise-and-withdraw\" style=\"position:relative;\"><a href=\"#h-03-create-a-short-call-order-with-non-empty-floor-makes-the-option-impossible-to-exercise-and-withdraw\" aria-label=\"h 03 create a short call order with non empty floor makes the option impossible to exercise and withdraw permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/369\">[H-03] Create a short call order with non empty floor makes the option impossible to exercise and withdraw</a></h2>\n<p><em>Submitted by zzzitron, also found by danb, Kenshin, Metatron, minhquanym, and PwnedNoMore</em></p>\n<p><strong>HIGH</strong> - assets can be lost</p>\n<p>If a short call order is created with non empty floorTokens array, the taker cannot exercise. Also, the maker cannot withdraw after the expiration. The maker will still get premium when the order is filled. If the non empty floorTokens array was included as an accident, it is a loss for both parties: the taker loses premium without possible exercise, the maker loses the locked ERC20s and ERC721s.</p>\n<p>This bug is not suitable for exploitation to get a ‘free’ premium by creating not exercisable options, because the maker will lose the ERC20s and ERC721s without getting any strike. In that sense it is similar but different issue to the <code>Create a short put order with zero tokenAmount makes the option impossible to exercise</code>, therefore reported separately.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li><a href=\"https://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L153-L202\">proof of concept</a></li>\n<li><a href=\"https://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L194-L21://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L204-L226\">reference case</a></li>\n</ul>\n<p>The proof of concept shows a scenario where babe makes an short call order with non empty <code>floorTokens</code> array. Bob filled the order, and now he has long call option NFT. He wants to exercise his option and calls <code>exercise</code>. There are two cases.</p>\n<ul>\n<li>case 1: he calls exercise with empty <code>floorAssetTokenIds</code> array</li>\n<li>case 2: he calls exercise with non-empty <code>floorAssetTokenIds</code> array with matching length to the <code>orders.floorTokens</code></li>\n</ul>\n<p>In the case1, <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L406\">the input <code>floorAssetTokenIds</code> were checked to be empty for put orders</a>, and his call passes this requirement. But eventually <code>_transferFloorsIn</code> was called and he gets <code>Index out of bounds</code> error, because <code>floorTokens</code> is not empty <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627-L629\">which does not match with empty <code>floorAssetTokenIds</code></a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// case 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// PuttyV2.sol: _transferFloorsIn called by exercise</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// The floorTokens and floorTokenIds do not match the lenghts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// floorTokens.length is not zero, while floorTokenIds.length is zero</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       </span><span class=\"mtk11\">ERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">floorTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span></code></pre>\n<p>In the case2, <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L406\">the input <code>floorAssetTokenIds</code> were checked to be empty for put orders</a>, but it is not empty. So it reverts.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// case2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// PuttyV2.sol: exercise</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// non empty floorAssetTokenIds array is passed for put option, it will revert</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        !order.isCall</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ? require(floorAssetTokenIds.length == order.floorTokens.length, &quot;Wrong amount of floor tokenIds&quot;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            : require(floorAssetTokenIds.length == 0, &quot;Invalid floor tokenIds length&quot;);</span></span></code></pre>\n<p>After the option is expired, the maker - babe is trying to withdraw but fails due to the <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L516\">same issue with the case1</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// maker trying to withdraw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// PuttyV2.sol: withdraw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">floorPositionId</span><span class=\"mtk1\">]);</span></span></span></code></pre>\n<p>Note on the PoC:</p>\n<ul>\n<li>The <a href=\"https://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L182-L183\">test for case1 is commented out</a> because foundry could not catch the revert. But by running the test with un-commenting these lines will show that the call reverts with <code>Index out of bounds</code>.</li>\n<li>For the same reason the <a href=\"https://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L199-L200\">withdraw</a> also is commented out</li>\n<li>The reference case just shows that it works as intended when the order does not contain non-empty <code>floorTokens</code>.</li>\n</ul>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It happens because the <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L296-L298\"><code>fillOrder</code> does not ensure</a> the <code>order.floorTokens</code> to be empty when the order is short call.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1174764713\">STYJ (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Note that it is possible to cause loss of funds for others through this.</p>\n<p>Assume that maker (A) creates a long call and taker (B) fills it, transferring floor tokens (XYZ) into putty. </p>\n<p>If maker (C) creates a short call with floorTokens (XYZ), taker (D) is able to fill and exercise his long call since XYZ already resides on Putty. This will however invalidate the options pair that was created between A and B since A cannot exercise and B cannot withdraw.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1178995529\">outdoteth (Putty Finance) commented</a>:</strong></p>\n<blockquote>\n<p>Agree that this should be marked as high severity given the exploit scenario provided by @STYJ above.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1178995764\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Report: Short call with floorTokens will result in a revert when exercising.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1181790939\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agreed, all wardens gave the same scenario that leads to a direct loss of NFTs and premium, but @STYJ’s exploit scenario raises the gravity of the situation since users can be griefed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1185411060\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/1\">https://github.com/outdoteth/putty-v2/pull/1</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed by prohibiting non-empty <code>order.floorTokens</code> for short calls.</p>\n<p>Other option types do need <code>floorTokens</code>: long calls’ taker provides floor tokens on filling, while long put owner brings in the floor tokens on exercise, taking the strike. Short put owner can thereafter retrieve the tokens on withdraw.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-zero-strike-call-options-can-be-systemically-used-to-steal-premium-from-the-taker\" style=\"position:relative;\"><a href=\"#h-04-zero-strike-call-options-can-be-systemically-used-to-steal-premium-from-the-taker\" aria-label=\"h 04 zero strike call options can be systemically used to steal premium from the taker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/418\">[H-04] Zero strike call options can be systemically used to steal premium from the taker</a></h2>\n<p><em>Submitted by hyh, also found by hansfriese</em></p>\n<p>Some non-malicious ERC20 do not allow for zero amount transfers and order.baseAsset can be such an asset. Zero strike calls are valid and common enough derivative type. However, the zero strike calls with such baseAsset will not be able to be exercised, allowing maker to steal from the taker as a malicious maker can just wait for expiry and withdraw the assets, effectively collecting the premium for free. The premium of zero strike calls are usually substantial.</p>\n<p>Marking this as high severity as in such cases malicious maker knowing this specifics can steal from taker the whole premium amount. I.e. such orders will be fully valid for a taker from all perspectives as inability to exercise is a peculiarity of the system which taker in the most cases will not know beforehand.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Currently system do not check the strike value, unconditionally attempting to transfer it:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>As a part of call exercise logic:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L422-L443\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L422-L443</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">exercise</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// -- exercising a call option</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer strike from exerciser to putty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// handle the case where the taker uses native ETH instead of WETH to pay the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weth</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// check enough ETH was sent to cover the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// convert ETH to WETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// we convert the strike ETH to WETH so that the logic in withdraw() works</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// - because withdraw() assumes an ERC20 interface on the base asset.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer assets from putty to exerciser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC20sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC721sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">)]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>Some tokens do not allow zero amount transfers:</p>\n<p><a href=\"https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers\">https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers</a></p>\n<p>This way for such a token and zero strike option the maker can create short call order, receive the premium:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L327-L339\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L327-L339</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weth</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// check enough ETH was sent to cover the premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// convert ETH to WETH and send premium to maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// converting to WETH instead of forwarding native ETH to the maker has two benefits;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// 1) active market makers will mostly be using WETH not native ETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// 2) attack surface for re-entrancy is reduced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>Transfer in the assets:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L366-L371\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L366-L371</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// filling short call: transfer assets from maker to contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC20sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC721sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>And wait for expiration, knowing that all attempts to exercise will revert:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>Then recover her assets:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L508-L519\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L508-L519</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer assets from putty to owner if put is exercised or call is expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) || (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC20sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC721sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// for call options the floor token ids are saved in the long position in fillOrder(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// and for put options the floor tokens ids are saved in the short position in exercise()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorPositionId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">longPositionId</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">floorPositionId</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider checking that strike is positive before transfer in all the cases, for example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+               </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+               }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/418#issuecomment-1174522101\">Alex the Entreprenerd (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Seems contingent on token implementation, however certain ERC20 do revert on 0 transfer and there would be no way to exercise the contract in that case.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/418#issuecomment-1178989277\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Report: Cannot exercise call contract if strike is 0 and baseAsset reverts on 0 transfers.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/418#issuecomment-1182684476\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>There is a pre-requisite for the ERC20 token to revert on 0 amount transfers. However, the warden raised a key point: zero strike calls are common, and their premium is substantial. The information asymmetry of the ERC20 token between the maker and taker is another aggravating factor.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/418#issuecomment-1185410362\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/3\">https://github.com/outdoteth/putty-v2/pull/3</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed by conditioning call’s logic on <code>order.strike > 0</code>. There is no use case for zero strike puts and so this case remains unconditioned, i.e. still always require successful <code>order.strike</code> transfer. </p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-16\" style=\"position:relative;\"><a href=\"#medium-risk-findings-16\" aria-label=\"medium risk findings 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (16)</h1>\n<h2 id=\"m-01-malicious-token-contracts-may-lead-to-locking-orders\" style=\"position:relative;\"><a href=\"#m-01-malicious-token-contracts-may-lead-to-locking-orders\" aria-label=\"m 01 malicious token contracts may lead to locking orders permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/50\">[M-01] Malicious Token Contracts May Lead To Locking Orders</a></h2>\n<p><em>Submitted by kirk-baird, also found by 0xA5DF, cccz, chatch, csanuragjain, Alex the Entreprenerd, hansfriese, hyh, itsmeSTYJ, Kenshin, pedroais, sashik</em>eth, unforgiven, and xiaoming90_</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L79\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L79</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L80\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L80</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L81\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L81</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L72\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L72</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>It is possible to prevent an order from executing <code>exercise()</code> or <code>withdraw()</code> by having a malicious token contract included in the order as part of the any of the following fields.</p>\n<ul>\n<li><code>baseAsset</code></li>\n<li><code>floorTokens[]</code></li>\n<li><code>erc20Assets[]</code></li>\n<li><code>erc721Assets[]</code></li>\n</ul>\n<p>An attacker as a maker may create an order and set one of these addresses to a malicious contract in the attackers control. The attacker allows the user to fill the order then toggles a variable on the malicious contract which always causes it to revert.</p>\n<p>The attacker benefits by preventing orders from being <code>exercise()</code> if they are in an undesirable position (e.g. if they have gone short and the price has gone up). The attacker waits for either the time to expire or the price to go down and allows transfers to occur on their malicious token.</p>\n<p>Similar attacks can also be performed over the <code>withdraw()</code> function since this also makes calls to untrusted external addresses. This would allow an attacker to exercise an option then prevent the other user from claiming any of the NFTs or ERC20 tokens that are owed to them.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Any of the transfers in <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L389-L458\">exercise</a> make external calls to untrusted addresses.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">exercise</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* ~~~ CHECKS ~~~ */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check user owns the position</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">)) == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check position is long</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Can only exercise long positions&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check position has not expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">)], </span><span class=\"mtk8\">&quot;Position has expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check floor asset token ids length is 0 unless the position type is put</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        !</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Wrong amount of floor tokenIds&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid floor tokenIds length&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* ~~~ EFFECTS ~~~ */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// send the long position to 0xdead.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// instead of doing a standard burn by sending to 0x000...000, sending</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// to 0xdead ensures that the same position id cannot be minted again.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xdead</span><span class=\"mtk1\">), </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// mark the position as exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">exercisedPositions</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">)] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExercisedOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* ~~~ INTERACTIONS ~~~ */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// -- exercising a call option</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer strike from exerciser to putty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// handle the case where the taker uses native ETH instead of WETH to pay the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weth</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// check enough ETH was sent to cover the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// convert ETH to WETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// we convert the strike ETH to WETH so that the logic in withdraw() works</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// - because withdraw() assumes an ERC20 interface on the base asset.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer assets from putty to exerciser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC20sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC721sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">)]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// -- exercising a put option</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// save the floor asset token ids to the short position</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortPositionId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">hashOppositeOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">shortPositionId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer strike from putty to exerciser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer assets from exerciser to putty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC20sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC721sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferFloorsIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The attacker must control one of these contracts and have it set as a malicious ERC20 / ERC721 function that fails under attacker controlled conditions.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider whitelisting approved ERC20 token or ERC721 address contracts to prevent users setting malicious token contracts. However, this remediation will have a significant admin input / gas trade-offs.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/50#issuecomment-1177630161\">outdoteth (Putty Finance) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Technically this is a valid finding. However we don’t intend to fix this at the contract level. Instead there will be adequate warnings on the UI to inform a user that they should be vigilant for any tokens that are not verified by putty (in addition, the UI will show the unverified token’s logo as a question mark instead of as the token’s logoURI).</p>\n<p>Report: Setting malicious or invalid erc721Assets, erc20Assets or floorTokens prevents the option from being exercised.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/50#issuecomment-1179463134\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It’s contingent on the external requirement for the attacker to be in control of a malicious ERC20 or NFT. Hence, medium severity is appropriate: <code>2-Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/50#issuecomment-1194894079\">Pedroais (warden) commented</a>:</strong></p>\n<blockquote>\n<p>I will argue why this issue should be high severity instead of medium.  </p>\n<p>“It’s contingent on the external requirement for the attacker to be in control of a malicious ERC20 or NFT. ”</p>\n<p>Anyone can deploy a malicious contract and pass it as an ERC20 or NFT. This is not an external requirement, anyone can do it. Any malicious contract deployed by the attacker will work.</p>\n<p>This issue imposes a risk of asset loss to users without external requirements. The sponsor states unknown tokens will be shown with a question mark in the UI. This is ok but I think the attack is high severity since the user would be reasonable to think if he is accepting an offer for a BAYC (example of an expensive NFT)  and some unknown token that in the worse case he should at least get the BAYC. This attack doesn’t require the user to be dumb or act recklessly but just normal functioning of the protocol. The fake token shouldn’t prevent the user from exercising the real BAYC.</p>\n<p>A user would be reasonable to expect to at least be able to exercise the real NFT in a case with an option that includes a real NFT and a malicious one. The problem is the malicious NFT can block the exercise of the real NFT. An option can be created using  many real and valuable tokens with just 1 malicious token that prevents exercising the real ones.</p>\n<p>I hope the judge can consider these arguments and make his decision.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/50#issuecomment-1198793737\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I should have phrased it better. The external requirement isn’t on the attacker being in control of the malicious ERC20 / NFT. As rightfully pointed out, it can be easily done.</p>\n<p>The external requirement here is the user deciding to fill an option containing malicious assets. Such options can be considered to be honeypots that users should be made aware of (eg. through documentation, PSAs or warnings to the user). There’s only so much the protocol can do to protect users, with tradeoffs against centralisation risks if the suggestion of whitelisting assets is adopted.</p>\n<blockquote>\n<p>This attack doesn’t require the user to be dumb or act recklessly but just normal functioning of the protocol. The fake token shouldn’t prevent the user from exercising the real BAYC.</p>\n</blockquote>\n<p>Partial exercising of options could be a feature, but opens up new attack surfaces and would be a non-trivial to implement. It is a limitation of the protocol that should be clearly communicated to users.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Now addressed on UI/DB level.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-unbounded-loops-may-cause-exercises-and-withdraws-to-fail-\" style=\"position:relative;\"><a href=\"#m-02-unbounded-loops-may-cause-exercises-and-withdraws-to-fail-\" aria-label=\"m 02 unbounded loops may cause exercises and withdraws to fail  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/227\">[M-02] Unbounded loops may cause <code>exercise()</code>s and <code>withdraw()</code>s to fail </a></h2>\n<p><em>Submitted by IllIllI, also found by 0xNineDec, sashik</em>eth, shung, and xiaoming90_</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L636-L640\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L636-L640</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L646-L650\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L646-L650</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L657-L661\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L657-L661</a></p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>There are no bounds on the number of tokens transferred in an order, and gas requirements can change (especially since orders can have a duration of <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L287\">27 years</a>), so orders filled at time T1 may not be exercisable/withdrawable at time T2, or with the provided assets if the assets use a lot of gas during their transfers (e.g. aTokens and cTokens). The buyer of the option will have paid the premium, and will be unable to get the assets they are owed.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>There are no upper bounds on the number of assets being transferred in these loops:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">636</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferERC20sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20Asset</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">637</span><span class=\"mtk1\">           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">638</span><span class=\"mtk1\">               </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">639</span><span class=\"mtk1\">           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">640</span><span class=\"mtk1\">       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L636-L640\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L636-L640</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">646</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferERC721sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC721Asset</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">647</span><span class=\"mtk1\">           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">648</span><span class=\"mtk1\">               </span><span class=\"mtk11\">ERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">649</span><span class=\"mtk1\">           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">650</span><span class=\"mtk1\">       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L646-L650\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L646-L650</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">657</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorTokenIds</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">658</span><span class=\"mtk1\">           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">659</span><span class=\"mtk1\">               </span><span class=\"mtk11\">ERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">floorTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">660</span><span class=\"mtk1\">           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">661</span><span class=\"mtk1\">       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L657-L661\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L657-L661</a></p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Have an upper bound on the number of assets, or allow them to be transferred out one at a time, if necessary</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/227#issuecomment-1177670801\">outdoteth (Putty Finance) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Adding a hardcoded check at the contract level is not a viable fix given that gas costs and limits are subject change over time.\nInstead, there already exists a limit of 30 assets on the frontend/db level.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/227#issuecomment-1179001005\">outdoteth (Putty Finance) commented</a>:</strong></p>\n<blockquote>\n<p>Report: Unbounded loop can prevent put option from being exercised.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/227#issuecomment-1179845396\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Medium severity is justified because, while very unlikely to happen, there could be a loss of assets.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Now addressed on UI/DB level.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-put-option-sellers-can-prevent-exercise-by-specifying-zero-amounts-or-non-existant-tokens\" style=\"position:relative;\"><a href=\"#m-03-put-option-sellers-can-prevent-exercise-by-specifying-zero-amounts-or-non-existant-tokens\" aria-label=\"m 03 put option sellers can prevent exercise by specifying zero amounts or non existant tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/223\">[M-03] Put option sellers can prevent exercise by specifying zero amounts, or non-existant tokens</a></h2>\n<p><em>Submitted by IllIllI, also found by 0xNineDec, exd0tpy, and zzzitron</em></p>\n<p>Put option buyers pay an option premium to the seller for the privilege of being able to ‘put’ assets to the seller and get the strike price for it rather than the current market price. If they’re unable to perform the ‘put’, they’ve paid the premium for nothing, and essentially have had funds stolen from them.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If the put option seller includes in <code>order.erc20Assets</code>, an amount of zero for any of the assets, or specifies an asset that doesn’t currently have any code at its address, the put buyer will be unable to exercise the option, and will have paid the premium for nothing:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">453</span><span class=\"mtk1\">               </span><span class=\"mtk3\">// transfer assets from exerciser to putty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">454</span><span class=\"mtk1\">               </span><span class=\"mtk11\">_transferERC20sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L453-L454\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L453-L454</a></p>\n<p>The function reverts if any amount is equal to zero, or the asset doesn’t exist:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">593</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferERC20sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20Asset</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">594</span><span class=\"mtk1\">           </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">595</span><span class=\"mtk1\">               </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">token</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">596</span><span class=\"mtk1\">               </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">597</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">598</span><span class=\"mtk1\">               </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk12\">code</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERC20: Token is not contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">599</span><span class=\"mtk1\">               </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERC20: Amount too small&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">600</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">601</span><span class=\"mtk1\">               </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">602</span><span class=\"mtk1\">           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">603</span><span class=\"mtk1\">       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L593-L603\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L593-L603</a></p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Verify the asset amounts and addresses during <code>fillOrder()</code>, and allow exercise if the token no longer exists at that point in time.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/223#issuecomment-1177638096\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>At the contract level there exists 2 possible mitigations;</p>\n<ol>\n<li>Remove the zero amount check (not feasible because it will cause another DOS issue for tokens that revert on 0 transfer).</li>\n<li>Check all erc20 assets are valid in <code>fillOrder</code> (gas tradeoff because it requires an O(n) loop to check).</li>\n</ol>\n<p>Instead, the best mitigation imo is to add a check on the frontend/db level to ensure that all erc20 assets have a token amount greater than 0 and that it exists as a contract.</p>\n<p>If users want to go lower level than the db/frontend then they must exercise their own diligence.</p>\n<p>edit: decided to go with a 3rd option instead.</p>\n<p>Simply skip the ERC20 transfer if the amount is 0.<br></p>\n<p>Report: Setting an erc20Asset with a zero amount or with no code at the address will result in a revert when exercising a put option.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/223#issuecomment-1185412355\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/8\">https://github.com/outdoteth/putty-v2/pull/8</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed zero amount part by introducing the noop for zero amount transfers in both <code>_transferERC20sIn</code> and <code>_transferERC20sOut</code> ERC20 transfer functions. The second part of the issue, fake tokens, is similar to <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/50\">M-01</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/227\">M-02</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-put-options-are-free-of-any-fees\" style=\"position:relative;\"><a href=\"#m-04-put-options-are-free-of-any-fees\" aria-label=\"m 04 put options are free of any fees permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/285\">[M-04] Put options are free of any fees</a></h2>\n<p><em>Submitted by berndartmueller, also found by 0xsanson, hubble, Lambda, Metatron, and swit</em></p>\n<p>Fees are expected to be paid whenever an option is exercised (as per the function comment on <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L235\">L235</a>).</p>\n<h4 id=\"put-options\" style=\"position:relative;\"><a href=\"#put-options\" aria-label=\"put options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Put options</h4>\n<p>If a put option is exercised, the exerciser receives the strike price (initially deposited by the short position holder) denominated in <code>order.baseAsset</code>.</p>\n<h4 id=\"call-options\" style=\"position:relative;\"><a href=\"#call-options\" aria-label=\"call options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Call options</h4>\n<p>If a call option is exercised, the exerciser sends the strike price to Putty and the short position holder is able to withdraw the strike amount.</p>\n<p>However, the current protocol implementation is missing to deduct fees for exercised put options. Put options are free of any fees.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The protocol fee is correctly charged for exercised calls:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L494-L506\">PuttyV2.withdraw</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// transfer strike to owner if put is expired or call is exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) || (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// send the fee to the admin/DAO if fee is greater than 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit DoS due to reverting erc20 token transfer (weird erc20 tokens, blacklisted or paused owner; erc777 hook on owner receiver side can prevent transfer hence reverting and preventing withdrawal) - use pull pattern @high  // @audit zero value token transfers can revert. Small strike prices and low fee can lead to rounding down to 0 - check feeAmount &gt; 0 @high  // @audit should not take fees if renounced owner (zero address) as fees can not be withdrawn @medium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit fee should not be paid if strike is simply returned to short owner for expired put @high</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Contrary, put options are free of any fees:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L450-L451\">PuttyV2.sol#L450-L451</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// transfer strike from putty to exerciser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Charge fees also for exercised put options.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/285#issuecomment-1176533283\">outdoteth (Putty Finance) commented</a>:</strong></p>\n<blockquote>\n<p>Fees are only applied on puts if they are expired.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/285#issuecomment-1179907369\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Making this the primary issue for the med severity issue, as per my comment in <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269\">#269</a>:</p>\n<blockquote>\n<p>“Put option not being charged fee upon exercising it. This can be considered to the “protocol leaked value” and thus be given a medium severity rating.”</p>\n</blockquote>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/285#issuecomment-1185411614\">outdoteth (Putty Finance) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/4\">https://github.com/outdoteth/putty-v2/pull/4</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The same fix as in <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269\">H-01</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-fillorder-and-exercise-may-lock-ether-sent-to-the-contract-forever\" style=\"position:relative;\"><a href=\"#m-05-fillorder-and-exercise-may-lock-ether-sent-to-the-contract-forever\" aria-label=\"m 05 fillorder and exercise may lock ether sent to the contract forever permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/226\">[M-05] <code>fillOrder()</code> and <code>exercise()</code> may lock Ether sent to the contract, forever</a></h2>\n<p><em>Submitted by IllIllI, also found by 0x29A, 0xc0ffEE, 0xDjango, AmitN, auditor0517, berndartmueller, BowTiedWardens, cccz, danb, dipp, dirk</em>y, hansfriese, horsefacts, hyh, joestakey, kirk-baird, oyc<em>109, peritoflores, rfa, sashik</em>eth, simon135, sseefried, StErMi, swit, xiaoming90, and zzzitron_</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L338\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L338</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436</a></p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p><code>fillOrder()</code> and <code>exercise()</code> have code paths that require Ether to be sent to them (e.g. using WETH as the base asset, or the provision of the exercise price), and therefore those two functions have the <code>payable</code> modifier. However, there are code paths within those functions that do not require Ether. Ether passed to the functions, when the non-Ether code paths are taken, is locked in the contract forever, and the sender gets nothing extra in return for it.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Ether can’t be pulled from the <code>order.maker</code> during the filling of a long order, so <code>msg.value</code> shouldn’t be provided here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">323</span><span class=\"mtk1\">           </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">324</span><span class=\"mtk1\">               </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">325</span><span class=\"mtk1\">           } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L323-L325\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L323-L325</a></p>\n<p>If the <code>baseAsset</code> isn’t WETH during order fulfillment, <code>msg.value</code> is unused:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">337</span><span class=\"mtk1\">               } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">338</span><span class=\"mtk1\">                   </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">339</span><span class=\"mtk1\">               }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L337-L339\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L337-L339</a></p>\n<p>Same for the exercise of call options:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">435</span><span class=\"mtk1\">               } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">436</span><span class=\"mtk1\">                   </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">437</span><span class=\"mtk1\">               }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437</a></p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a <code>require(0 == msg.value)</code> for the above three conditions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/226#issuecomment-1174516212\">Alex the Entreprenerd (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Why would the caller send ETH when they don’t have to?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/226#issuecomment-1174603678\">sseefried (warden) commented</a>:</strong></p>\n<blockquote>\n<p>User error is one possibility. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/226#issuecomment-1179001561\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Report: Native ETH can be lost if it’s not utilised in exercise and fillOrder.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/226#issuecomment-1185413512\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/5\">https://github.com/outdoteth/putty-v2/pull/5</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed with native funds amount control added to strike transfer logic of <code>fillOrder</code>. Zero strike and zero premium corner cases are yet unhandled as described in <a href=\"#mm-01-weth-zero-strike-call-fillorders-msgvalue-will-be-lost\">M.M-01</a> and <a href=\"#mm-02-zero-premium-short-fillorders-msgvalue-will-be-lost\">M.M-02</a> in the Mitigation Review below.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-denial-of-service-contract-owner-could-block-users-from-withdrawing-their-strike\" style=\"position:relative;\"><a href=\"#m-06-denial-of-service-contract-owner-could-block-users-from-withdrawing-their-strike\" aria-label=\"m 06 denial of service contract owner could block users from withdrawing their strike permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/296\">[M-06] [Denial-of-Service] Contract Owner Could Block Users From Withdrawing Their Strike</a></h2>\n<p><em>Submitted by xiaoming90, also found by berndartmueller</em></p>\n<p>When users withdraw their strike escrowed in Putty contract, Putty will charge a certain amount of fee from the strike amount. The fee will first be sent to the contract owner, and the remaining strike amount will then be sent to the users.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L500\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L500</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// transfer strike to owner if put is expired or call is exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) || (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">// send the fee to the admin/DAO if fee is greater than 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t</span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>There are two methods on how the owner can deny user from withdrawing their strike amount from the contract</p>\n<h4 id=\"method-1---set-the-owner-to-zero-address\" style=\"position:relative;\"><a href=\"#method-1---set-the-owner-to-zero-address\" aria-label=\"method 1   set the owner to zero address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Method #1 - Set the <code>owner()</code> to <code>zero</code> address</h4>\n<p>Many of the token implementations do not allow transfer to <code>zero</code> address (<a href=\"https://github.com/d-xo/weird-erc20#revert-on-transfer-to-the-zero-address\">Reference</a>). Popular ERC20 implementations such as the following Openzeppelin’s ERC20 implementation do not allow transfer to <code>zero</code> address, and will revert immediately if the <code>to</code> address (recipient) points to a <code>zero</code> address during a transfer.</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/5fbf494511fd522b931f7f92e2df87d671ea8b0b/contracts/token/ERC20/ERC20.sol#L226\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/5fbf494511fd522b931f7f92e2df87d671ea8b0b/contracts/token/ERC20/ERC20.sol#L226</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ERC20: transfer from the zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ERC20: transfer to the zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_beforeTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fromBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">from</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromBalance</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERC20: transfer amount exceeds balance&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">from</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">fromBalance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// decrementing then incrementing.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">to</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_afterTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>It is possible for the owner to transfer the ownership to a <code>zero</code> address, thus causing the fee transfer to the contract owner to always revert. When the fee transfer always reverts, no one can withdraw their strike amount from the contract.</p>\n<p>This issue will affect all orders that adopt a <code>baseAsset</code> that reverts when transferring to <code>zero</code> address.</p>\n<h4 id=\"method-2---if-baseasset-is-a-erc777-token\" style=\"position:relative;\"><a href=\"#method-2---if-baseasset-is-a-erc777-token\" aria-label=\"method 2   if baseasset is a erc777 token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Method #2 - If <code>baseAsset</code> is a ERC777 token</h4>\n<blockquote>\n<p>Note: <code>owner()</code> could point to a contract or EOA account. By pointing to a contract, the contract could implement logic to revert whenever someone send tokens to it.</p>\n</blockquote>\n<p>ERC777 contains a <code>tokensReceived</code> hook that will notify the recipient whenever someone sends some tokens to the recipient .</p>\n<p>Assuming that the <code>baseAsset</code> is a ERC77 token, the recipient, which is the <code>owner()</code> in this case, could always revert whenever <code>PuttyV2</code> contract attempts to send the fee to recipient. This will cause the <code>withdraw</code> function to revert too. As a result, no one can withdraw their strike amount from the contract.</p>\n<p>This issue will affect all orders that has ERC777 token as its <code>baseAsset</code>.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>User cannot withdraw their strike amount and their asset will be stuck in the contract.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended to adopt a <a href=\"https://docs.soliditylang.org/en/v0.8.15/common-patterns.html#withdrawal-from-contracts\">withdrawal pattern</a> for retrieving owner fee.</p>\n<p>Instead of transferring the fee directly to owner address during withdrawal, save the amount of fee that the owner is entitled to in a state variable. Then, implement a new function that allows the owner to withdraw the fee from the <code>PuttyV2</code> contract.</p>\n<p>Consider the following implementation. In the following example, there is no way for the owner to perform denial-of-user because the outcome of the fee transfer (succeed or fail) to the owner will not affect the user’s strike withdrawal process.</p>\n<p>This will give users more assurance and confidence about the security of their funds stored within Putty.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ownerFees</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// transfer strike to owner if put is expired or call is exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) || (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// send the fee to the admin/DAO if fee is greater than 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">ownerFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">feeAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ownerFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">ownerFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/296#issuecomment-1177678807\">outdoteth (Putty Finance) disagreed with severity</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/296#issuecomment-1179936225\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The scenarios provided are valid, especially for baseAssets that revert on zero-address transfer.</p>\n<p>While the likelihood is low, assets are lost and cannot be retrieved.<br>\n<code>3 — High: Assets can be stolen/lost/compromised directly (or indirectly if there is a valid attack path that does not have hand-wavy hypotheticals).</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/296#issuecomment-1181754248\">HickupHH3 (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Thinking about it further, the external conditions / requirements needed for the DoS to happen are somewhat strong.</p>\n<ul>\n<li>the ERC777 attack requires <code>owner()</code> or the token to be engineered to be malicious and adopted.</li>\n<li>DoS via revoking ownership requires <code>fee</code> to be non-zero first, which is unlikely to happen. I can classify this as a “user-prone” bug, which would be similar to cases like including ETH when WETH is intended to be used (#226).</li>\n</ul>\n<p>Hence, I think medium severity is more appropriate:\n<code>2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/296#issuecomment-1185411399\">outdoteth (Putty Finance) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/4\">https://github.com/outdoteth/putty-v2/pull/4</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The same fix as in <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269\">H-01</a>: as the platform fee is now transferred on order filling, any owner griefing can only yield a denial of service. There will be no loss of funds as this way position is only about to be created when the fee is transferred.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-an-attacker-can-create-a-short-put-option-order-on-an-nft-that-does-not-support-erc721-like-cryptopunk-and-the-user-can-fulfill-the-order-but-cannot-exercise-the-option\" style=\"position:relative;\"><a href=\"#m-07-an-attacker-can-create-a-short-put-option-order-on-an-nft-that-does-not-support-erc721-like-cryptopunk-and-the-user-can-fulfill-the-order-but-cannot-exercise-the-option\" aria-label=\"m 07 an attacker can create a short put option order on an nft that does not support erc721 like cryptopunk and the user can fulfill the order but cannot exercise the option permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/16\">[M-07] An attacker can create a short put option order on an NFT that does not support ERC721 (like cryptopunk), and the user can fulfill the order, but cannot exercise the option</a></h2>\n<p><em>Submitted by cccz, also found by IllIllI and minhquanym</em></p>\n<p>An attacker can create a short put option on cryptopunk. When the user fulfills the order, the baseAsset will be transferred to the contract. </p>\n<p>However, since cryptopunk does not support ERC721, the user cannot exercise the option because the safeTransferFrom function call fails. Attacker can get premium and get back baseAsset after option expires.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L343-L346\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L343-L346</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L628-L629\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L628-L629</a></p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding a whitelist to nfts in the order, or consider supporting exercising on cryptopunk.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1174823604\">STYJ (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Putty uses solmate’s <code>ERC721.safeTransferFrom</code> which requires that the NFT contract implements <code>onERC721Received</code>. For the case of OG NFTs like punks and rocks, this will fail, <a href=\"https://github.com/Rari-Capital/solmate/blob/main/src/tokens/ERC721.sol#L120\">https://github.com/Rari-Capital/solmate/blob/main/src/tokens/ERC721.sol#L120</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1175910424\">thereksfour (warden) commented</a>:</strong></p>\n<blockquote>\n<p>The user does not need to send cryptopunk to the contract when fulfilling the short put option order, but the user will pay a premium to the order creator. Later, when the user wants to exercise the option, since the cryptopunk does not support safetransferfrom, the user cannot exercise the option.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1176031452\">STYJ (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>The user does not need to send cryptopunk to the contract when fulfilling the short put option order, but the user will pay a premium to the order creator. Later, when the user wants to exercise the option, since the cryptopunk does not support safetransferfrom, the user cannot exercise the option.</p>\n</blockquote>\n<p>Sorry, I did not consider this path. You are correct to say that a maker can create a short put option order with cryptopunks as a token and the holder of the long put option will not be able to exercise since cryptopunks cannot be transferred with <code>safeTransferFrom</code>. From that perspective, this is a valid issue. Thank you for bringing it up. I will defer to the judge for the final decision.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1178923868\">outdoteth (Putty Finance) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>We dont intend to support cryptopunks or cryptokitties.\nIf users wish to use these tokens then they can get wrapped versions (ex: wrapped cryptopunks).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1181762798\">HickupHH3 (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I thought cryptokitties are ERC721? I think they were the ones who popularized the standard actually :p\nProbably meant etherrocks.</p>\n<p>In general, non-compliant ERC-721 NFTs can be supported through wrappers, though some users might be unaware… Downgrading to med severity, similar to <a href=\"https://github.com/code-423n4/2022-02-foundation-findings/issues/74\">this issue from another contest</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Similar to <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/50\">M-01</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/227\">M-02</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-overlap-between-erc721transferfrom-and-erc20transferfrom-allows-ordererc20assets-or-orderbaseasset-to-be-erc721-rather-than-erc20\" style=\"position:relative;\"><a href=\"#m-08-overlap-between-erc721transferfrom-and-erc20transferfrom-allows-ordererc20assets-or-orderbaseasset-to-be-erc721-rather-than-erc20\" aria-label=\"m 08 overlap between erc721transferfrom and erc20transferfrom allows ordererc20assets or orderbaseasset to be erc721 rather than erc20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/52\">[M-08] Overlap Between <code>ERC721.transferFrom()</code> and <code>ERC20.transferFrom()</code> Allows <code>order.erc20Assets</code> or <code>order.baseAsset</code> To Be ERC721 Rather Than ERC20</a></h2>\n<p><em>Submitted by kirk-baird, also found by reassor and sseefried</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L338\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L338</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L344\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L344</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L360\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L360</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L601\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L601</a></p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Both <code>ERC20.transferFrom(address to, address from, uint256 amount)</code> and <code>ERC721.transferFrom(address to, address from, uint256 id)</code> have the same function signature <code>0x23b872dd</code>. The impact of this is it’s possible for <code>baseAsset</code> or <code>erc20Assets</code> to be ERC721 addresses rather than ERC20.</p>\n<p>These functions will successfully transfer the NFT into the protocol however they will fail to transfer the NFT out of the contract. That is because the outgoing transfer is <code>ERC20.safeTransfer()</code> which calls <code>transfer(to, amount)</code> which does not match up with any valid function signatures on ERC721.</p>\n<p>Therefore any ERC721 tokens transferred into the contract in this manner via <code>fillOrder()</code> will be permanently stuck in the contract as neither <code>exercise()</code> nor <code>withdraw()</code> will successfully transfer the tokens out of the contract.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/lib/solmate/src/tokens/ERC721.sol#L82-L86\">ERC721.transferFrom()</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/lib/solmate/src/tokens/ERC20.sol#L90-L94\">ERC20.transferFrom()</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider whitelisting approved ERC721 and ERC20 token contracts. Furthermore, separate these two contracts into different whitelists for ERC20s and ERC721s then ensure each contract is in the right category.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/52#issuecomment-1179004318\">outdoteth (Putty Finance) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Report: If an ERC721 token is used in places where ERC20 assets are supposed to be used then ERC721 tokens can get stuck in withdraw() and exercise().</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Requires asset whitelisting, now addressed on UI/DB level.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-the-contract-serves-as-a-flashloan-pool-without-fee\" style=\"position:relative;\"><a href=\"#m-09-the-contract-serves-as-a-flashloan-pool-without-fee\" aria-label=\"m 09 the contract serves as a flashloan pool without fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/377\">[M-09] The contract serves as a flashloan pool without fee</a></h2>\n<p><em>Submitted by 0xc0ffEE, also found by horsefacts, pedroais, and unforgiven</em></p>\n<p>The malicious user could leverage PuttyV2 contract to flashloan without paying fee the assets to make profit.</p>\n<p>Consider a scenario that maker and taker is the same, and is a contract</p>\n<ol>\n<li>The contract call PuttyV2.<code>fillOrder</code> with a Long Call order that has <code>order.baseAssets</code> references to a contract having custom logic other than standard ERC20. The order also specify <code>erc20Assets</code> to the <code>token</code> and <code>tokenAmount</code> that PuttyV2 contract is owing (similar to <code>erc721Assets</code>)</li>\n<li>When the execution is at <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324</a>, the custom logic could execute on the contract address <code>order.baseAsset</code>.</li>\n<li>The malicious contract then call <code>exercise</code> to exercise the short call position. This call will transfer out the assets specified in the order to the malicious contract by executing logics in <code>_transferERC20sOut, _transferERC721sOut</code></li>\n<li>The contract uses that assets to make profit on other platforms. After that, the execution continues at <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324</a>.</li>\n<li>At the end of <code>fillOrder</code>, the contract just transfers enough assets back to PuttyV2 by executing logics in <code>_transferERC20sIn, _transferERC721sIn</code> to finish the execution.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1174509620\">Alex the Entreprenerd (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Warden is saying that they can flashloan without fee, but any exercised option will pay a 3% fee, additionally the order of operations shown (gain control on base.asset.transfer when receiving premium), would mean that the order ERC20s and NFTs have yet to be transferred in, so a “mid-fillOrder” “exercise” would not only pay the fee, but also revert due to lack of the tokens.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1174999561\">Pedroais (warden) commented</a>:</strong></p>\n<blockquote>\n<p>The 3% will be paid in the fake asset since base asset is an attacker contract so there is no fee to perform the attack. </p>\n<p>This attack is done with assets that are already inside the contract so there is no revert in transfer out.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1175061981\">outdoteth (Putty Finance) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledging that technically this is true.\nAlthough no easy mitigation exists as far as I can see aside from adding nonReentrant to exercise and fillOrder - adding a non-negligible gas overhead.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1175108315\">Alex the Entreprenerd (warden) commented</a>:</strong></p>\n<blockquote>\n<p>I agree that the finding is valid, the fee can be paid in a mintable token to gain temporary ownership of a token underlying which is repaid at the end of <code>fillOrder</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1178994409\">outdoteth (Putty Finance) commented</a>:</strong></p>\n<blockquote>\n<p>Report: It’s possible to flashloan all assets in the contract without paying a protocol fee.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1182823327\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Flash loans from the contract would be a feature, not a bug. However, being able to do so without paying a protocol fee (ie. paying in fake tokens) wouldn’t be great. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-putty-position-tokens-may-be-minted-to-non-erc721-receivers\" style=\"position:relative;\"><a href=\"#m-10-putty-position-tokens-may-be-minted-to-non-erc721-receivers\" aria-label=\"m 10 putty position tokens may be minted to non erc721 receivers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/327\">[M-10] Putty position tokens may be minted to non ERC721 receivers</a></h2>\n<p><em>Submitted by horsefacts, also found by 0xc0ffEE, 0xsanson, berndartmueller, BowTiedWardens, csanuragjain, defsec, IllIllI, joestakey, Kenshin, Picodes, shenwilly, Sm4rty, unforgiven, and xiaoming90</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L302-L308\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L302-L308</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L11-L18\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L11-L18</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>Putty uses ERC721 <code>safeTransfer</code> and <code>safeTransferFrom</code> throughout the codebase to ensure that ERC721 tokens are not transferred to non ERC721 receivers. However, the initial position mint in <code>fillOrder</code> uses <code>_mint</code> rather than <code>_safeMint</code> and does not check that the receiver accepts ERC721 token transfers:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L302-L308\"><code>PuttyV2#fillOrder</code></a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// create long/short position for maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// create opposite long/short position for taker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oppositeOrderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOppositeOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oppositeOrderHash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L11-L18\"><code>PuttyV2Nft#_mint</code></a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;INVALID_RECIPIENT&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_ownerOf</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ALREADY_MINTED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_ownerOf</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">to</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If a maker or taker are a contract unable to receive ERC721 tokens, their options positions may be locked and nontransferable. If the receiving contract does not provide a mechanism for interacting with Putty, they will be unable to exercise their position or withdraw assets.</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider implementing the <code>require</code> check in Solmate’s <code>ERC721#_safeMint</code> in your own mint function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_safeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">code</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC721TokenReceiver</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">).</span><span class=\"mtk11\">onERC721Received</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">) ==</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">ERC721TokenReceiver</span><span class=\"mtk1\">.</span><span class=\"mtk12\">onERC721Received</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;UNSAFE_RECIPIENT&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>However, note that calling <code>_safeMint</code> introduces a reentrancy opportunity! If you make this change, ensure that the mint is treated as an interaction rather than an effect, and consider adding a reentrancy guard:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/*  ~~~ EFFECTS ~~~ */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// create opposite long/short position for taker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oppositeOrderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOppositeOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oppositeOrderHash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// save floorAssetTokenIds if filling a long call order</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">)] = </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// save the long position expiration</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">positionExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\"> ? </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">) : </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">duration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FilledOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* ~~~ INTERACTIONS ~~~ */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_safeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_safeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Alternatively, document the design decision to use <code>_mint</code> and the associated risk for end users.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/327#issuecomment-1176613220\">outdoteth (Putty Finance) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>It’s unlikely a contract will have all the setup required to interact with PuttyV2 but not be able to handle ERC721 tokens. Adding a check via safeMint adds a gas overhead as well as another re-entrancy attack vector so there is a tradeoff (as noted in the issue report^^).</p>\n</blockquote>\n<blockquote>\n<p>Report: Contracts that can’t handle ERC721 tokens will lose their Putty ERC721 position tokens.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/327#issuecomment-1183141452\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>In addition, some contracts may have custom logic in their <code>onERC721Received()</code> implementation that is triggered only by the safe methods and not their “unsafe” counterparts.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-fee-can-change-without-the-consent-of-users\" style=\"position:relative;\"><a href=\"#m-11-fee-can-change-without-the-consent-of-users\" aria-label=\"m 11 fee can change without the consent of users permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/422\">[M-11] <code>fee</code> can change without the consent of users</a></h2>\n<p><em>Submitted by Picodes, also found by 0xNineDec, 0xsanson, antonttc, berndartmueller, BowTiedWardens, catchup, dirk</em>y, Alex the Entreprenerd, horsefacts, Metatron, sseefried, and unforgiven_</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L240\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L240</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L497\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L497</a></p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Fees are applied during <code>withdraw</code>, but can change between the time the order is filled and its terms are agreed upon and the withdrawal time, leading to a loss of the expected funds for the concerned users.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The scenario would be:</p>\n<ul>\n<li>Alice and Bob agrees to fill an order at a time fees are 0.1%</li>\n<li>During the duration of the option, fees are increased to 3%</li>\n<li>At withdrawal they’ll pay 3% of the strike, although they wouldn’t have created the order in the first place with such fees</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Mitigation could be:</p>\n<ul>\n<li>Store the fees in <code>Order</code> and verify that they are correct when the order is filled, so they are hardcoded in the struct</li>\n<li>Add a timestamp: this wouldn’t fully mitigate but would still be better than the current setup</li>\n<li>Keep past fees and fee change timestamps in memory (for example in an array) to be able to retrieve the creation time fees at withdrawal</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/422#issuecomment-1178988085\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Report: Admin can change fee at any time for existing orders.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/422#issuecomment-1185414532\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/4\">https://github.com/outdoteth/putty-v2/pull/4</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The same fix as in <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269\">H-01</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-options-with-a-small-strike-price-will-round-down-to-0-and-can-prevent-assets-to-be-withdrawn\" style=\"position:relative;\"><a href=\"#m-12-options-with-a-small-strike-price-will-round-down-to-0-and-can-prevent-assets-to-be-withdrawn\" aria-label=\"m 12 options with a small strike price will round down to 0 and can prevent assets to be withdrawn permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/283\">[M-12] Options with a small strike price will round down to 0 and can prevent assets to be withdrawn</a></h2>\n<p><em>Submitted by berndartmueller, also found by auditor0517, hansfriese, IllIllI, Lambda, sashik</em>eth, shenwilly, and TrungOre_</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L499-L500\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L499-L500</a></p>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Certain ERC-20 tokens do not support zero-value token transfers and revert. Using such a token as a <code>order.baseAsset</code> for a rather small option strike and a low protocol fee rate can lead to rounding down to 0 and prevent asset withdrawals for those positions.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L499-L500\">PuttyV2.sol#L499-L500</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// send the fee to the admin/DAO if fee is greater than 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit-info zero-value ERC20 token transfers can revert for certain tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Some ERC20 tokens revert for zero-value transfers (e.g. <code>LEND</code>). If used as a <code>order.baseAsset</code> and a small strike price, the fee token transfer will revert. Hence, assets and the strike can not be withdrawn and remain locked in the contract.</p>\n<p>See <a href=\"https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers\">Weird ERC20 Tokens - Revert on Zero Value Transfers</a></p>\n<p><strong>Example:</strong></p>\n<ul>\n<li><code>order.baseAsset</code> is one of those weird ERC-20 tokens</li>\n<li><code>order.strike = 999</code> (depending on the token decimals, a very small option position)</li>\n<li><code>fee = 1</code> (0.1%)</li>\n</ul>\n<p>((999 * 1) / 1000 = 0.999) rounded down to 0 -> zero-value transfer reverting transaction</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a simple check for zero-value token transfers:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// send the fee to the admin/DAO if fee is greater than 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/283#issuecomment-1178998816\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Report: withdraw() can be DOS’d for baseAsset ERC20s that prevent 0 transfers if the calculated feeAmount is 0 due to rounding.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/283#issuecomment-1185413905\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/4\">https://github.com/outdoteth/putty-v2/pull/4</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed along with <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269\">H-01</a> in <a href=\"https://github.com/outdoteth/putty-v2/pull/4\"><code>PR#4</code></a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-order-duration-can-be-set-to-0-by-malicious-maker\" style=\"position:relative;\"><a href=\"#m-13-order-duration-can-be-set-to-0-by-malicious-maker\" aria-label=\"m 13 order duration can be set to 0 by malicious maker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/107\">[M-13] Order duration can be set to 0 by Malicious maker</a></h2>\n<p><em>Submitted by codexploder, also found by ACai, cccz, Critical, horsefacts, ignacio, shenwilly, unforgiven, and xiaoming90</em></p>\n<p>A malicious maker can set a minimum order duration as 0 which means order will instantly expire after filling. Taker will get only the withdraw option and that too with fees on strike price, thus forcing the taker to lose money in this meaningless transaction</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Maker creates an order with zero Order duration</li>\n<li>Taker fills this order but the order instantly expires since duration was 0</li>\n<li>Taker gets the only option to withdraw with fees on strike price</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Enforce at least x days of duration.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/107#issuecomment-1185407029\">outdoteth (Putty Finance) confirmed and resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/7\">https://github.com/outdoteth/putty-v2/pull/7</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed by requiring the minimal order duration of 15 minutes on filling.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-order-cancellation-is-prone-to-frontrunning-and-is-dependent-on-a-centralized-database\" style=\"position:relative;\"><a href=\"#m-14-order-cancellation-is-prone-to-frontrunning-and-is-dependent-on-a-centralized-database\" aria-label=\"m 14 order cancellation is prone to frontrunning and is dependent on a centralized database permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/186\">[M-14] Order cancellation is prone to frontrunning and is dependent on a centralized database</a></h2>\n<p><em>Submitted by shung, also found by unforgiven</em></p>\n<p>Order cancellation requires makers to call <code>cancel()</code>, inputting the order as a function parameter. This is the only cancellation method, and it can cause two issues.</p>\n<p>This first issue is that it is an on-chain signal for MEV users to frontrun the cancellation and fill the order.</p>\n<p>The second issue is the dependency to a centralized service for cancelling the order. As orders are signed off chain, they would be stored in a centralized database. It is unlikely that an end user would locally record all the orders they make. This means that when cancelling an order, maker needs to request the order parameters from the centralized service. If the centralized service goes offline, it could allow malicious parties who have a copy of the order database to fill orders that would have been cancelled otherwise.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Bob signs an order which gets recorded in Putty servers.</li>\n<li>Alice mirrors all the orders using Putty APIs.</li>\n<li>Putty servers go offline.</li>\n<li>Bob wants to cancel his order because changing token prices makes his order less favourable to him.</li>\n<li>Bob cannot cancel his order because Putty servers are down and he does not remember the exact amounts of tokens he used.</li>\n<li>Alice goes through all the orders in her local mirror and fulfills the non-cancelled orders, including Bob’s, with extremely favourable terms for herself.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Aside from the standard order cancellation method, have an extra method to cancel all orders of a caller. This can be achieved using a “minimum valid nonce” state variable, as a mapping from user address to nonce.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">minimumValidNonce</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Allow users to increment their <code>minimumValidNonce</code>. Make sure the incrementation function do not allow incrementing more than <code>2**64</code> such that callers cannot lock themselves out of creating orders by increasing <code>minimumValidNonce</code> to <code>2**256-1</code> by mistake. Then, prevent filling orders if <code>order.nonce &#x3C; minimumValidNonce</code>.</p>\n<p>Another method to achieve bulk cancelling is using counters. For example, Seaport <a href=\"https://github.com/ProjectOpenSea/seaport/blob/171f2cd7faf13b2bf0455851499f1981274977f7/contracts/lib/CounterManager.sol\">uses counters</a>, which is an extra order parameter that has to match the corresponding counter state variable. It allows maker to cancel all his orders by <a href=\"https://github.com/ProjectOpenSea/seaport/blob/171f2cd7faf13b2bf0455851499f1981274977f7/contracts/lib/Consideration.sol#L475-L478\">incrementing the counter state variable by one</a>.</p>\n<p>Either of these extra cancellation methods would enable cancelling orders without signalling to MEV bots, and without a dependency to a centralized database.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/186#issuecomment-1177567080\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Should this be tagged as Med or Low? Funds are not directly at risk unless the centralised order book server goes down and loses all the data. Perhaps there is a non-negligible chance that this <em>could</em> happen. But even then, orders have an “expiration” field attached to them which will render them useless after some set time period. There are also easy fixes on the frontend, such as allowing users to download a txt file with their order/orderHash so that they don’t have to rely on the centralised DB for data availability. </p>\n<p>But will defer to judges.</p>\n<p>Report: Cannot cancel orders without reliance on centralised database.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/186#issuecomment-1184059122\">HickupHH3 (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The sponsor’s point is valid: there is an expiration param that the maker signs as part of the order that marks its validity.</p>\n<p>However, the warden(s) concerns are valid too. While it is an edge case that is very unlikely to happen, there would arguably be a “loss” of assets of the maker because of the protocol’s loss of functionality, as per the scenario described above. Hence, the medium severity rating is justified.</p>\n<p>I recommend implementing the warden’s recommended fix; having a <code>minimumValidNonce</code> would be great in allowing easy on-chain cancellation of an order. It makes the system a little more trust-less and provides a “red button” option for makers to use if necessary.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/186#issuecomment-1185428778\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/10\">https://github.com/outdoteth/putty-v2/pull/10</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed by the introduction of <code>setMinimumValidNonce</code> function and the corresponding control on order filling. See <a href=\"#mm-04-minimumvalidnonce-can-be-reduced-due-to-an-operational-mistake-enabling-old-orders\">M.M-04</a> in the Mitigation Review below.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-zero-strike-call-options-will-avoid-paying-system-fee\" style=\"position:relative;\"><a href=\"#m-15-zero-strike-call-options-will-avoid-paying-system-fee\" aria-label=\"m 15 zero strike call options will avoid paying system fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/373\">[M-15] Zero strike call options will avoid paying system fee</a></h2>\n<p><em>Submitted by hyh, also found by csanuragjain, minhquanym, and Treasure-Seeker</em></p>\n<p>Zero and near zero strike calls are common derivative type. For such derivatives the system will not be receiving fees are the fee is now formulated as a fraction of order strike.</p>\n<p>Also, it can be a problem for OTM call options, when the option itself is nearly worthless, while the fee will be substantial as strike will be big. Say 1k ETH BAYC call doesn’t have much value, but the associated fee will be 10x of usual fee, i.e. substantial, while there is nothing to justify that.</p>\n<p>Marking this as medium severity as that’s a design specifics that can turn off or distort core system fee gathering.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Currently fee is linked to the order strike which makes it vary heavily for different types of orders, for example deep ITM and OTM calls:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L494-L506\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L494-L506</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer strike to owner if put is expired or call is exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) || (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// send the fee to the admin/DAO if fee is greater than 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider linking the fee to option premium as this is option value that cannot be easily manipulated and exactly corresponds to the trading volume of the system.</p>\n<p>i.e. consider moving fee gathering to fillOrder:</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L322-L340\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L322-L340</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer premium to whoever is short from whomever is long</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// handle the case where the user uses native ETH instead of WETH to pay the premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weth</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// check enough ETH was sent to cover the premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// convert ETH to WETH and send premium to maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// converting to WETH instead of forwarding native ETH to the maker has two benefits;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// 1) active market makers will mostly be using WETH not native ETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// 2) attack surface for re-entrancy is reduced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/373#issuecomment-1174511995\">Alex the Entreprenerd (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Zero strike will indeed have a fee of 0.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/373#issuecomment-1178994046\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Report: Charging fees on the strike amount instead of the premium amount can lead to disproportionate fees.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/373#issuecomment-1185414345\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/4\">https://github.com/outdoteth/putty-v2/pull/4</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The same fix as in <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/269\">H-01</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-use-of-solidity-version-0813-which-has-two-known-issues-applicable-to-puttyv2\" style=\"position:relative;\"><a href=\"#m-16-use-of-solidity-version-0813-which-has-two-known-issues-applicable-to-puttyv2\" aria-label=\"m 16 use of solidity version 0813 which has two known issues applicable to puttyv2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/348\">[M-16] Use of Solidity version 0.8.13 which has two known issues applicable to PuttyV2</a></h2>\n<p><em>Submitted by hubble, also found by horsefacts</em></p>\n<p>The solidity version 0.8.13 has below two issues applicable to PuttyV2</p>\n<ol>\n<li>\n<p>Vulnerability related to ABI-encoding.</p>\n<p>ref : <a href=\"https://blog.soliditylang.org/2022/05/18/solidity-0.8.14-release-announcement/\">https://blog.soliditylang.org/2022/05/18/solidity-0.8.14-release-announcement/</a><br>\nThis vulnerability can be misused since the function hashOrder() and hashOppositeOrder() has applicable conditions.<br>\n“…pass a nested array directly to another external function call or use abi.encode on it.”</p>\n</li>\n<li>\n<p>Vulnerability related to ‘Optimizer Bug Regarding Memory Side Effects of Inline Assembly’</p>\n<p>ref : <a href=\"https://blog.soliditylang.org/2022/06/15/solidity-0.8.15-release-announcement/\">https://blog.soliditylang.org/2022/06/15/solidity-0.8.15-release-announcement/</a><br>\nPuttyV2 inherits solidity contracts from openzeppelin and solmate, and both these uses inline assembly, and optimization is enabled while compiling.</p>\n</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use recent Solidity version 0.8.15 which has the fix for these issues.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/348#issuecomment-1176607284\">outdoteth (Putty Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Great catch.</p>\n</blockquote>\n<blockquote>\n<p>Report: Use of Solidity 0.8.13 with known issues in ABI encoding and memory side effects.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/348#issuecomment-1185414140\">outdoteth (Putty Finance) resolved</a>:</strong></p>\n<blockquote>\n<p>PR with fix: <a href=\"https://github.com/outdoteth/putty-v2/pull/6\">https://github.com/outdoteth/putty-v2/pull/6</a>.</p>\n</blockquote>\n<p><strong>hyh (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>Fixed by bumping the solidity version.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 82 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/306\">report highlighted below</a> by <strong>xiaoming90</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/153\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/228\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/212\">sseefried</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/390\">BowTiedWardens</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/58\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/163\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/193\">zer0dot</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/277\">Alex the Entreprenerd</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/31\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/304\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/190\">shung</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/271\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/94\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/428\">hubble</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/199\">StErMi</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/317\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/340\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/378\">zzzitron</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/45\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/429\">Metatron</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/309\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/417\">0xsanson</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/62\">danb</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/412\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/173\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/374\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/102\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/281\">TrungOre</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/81\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/330\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/74\">JohnSmith</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/393\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/73\">AmitN</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/25\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/425\">antonttc</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/264\">async</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/255\">GimelSec</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/125\">hake</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/408\">Kaiziron</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/396\">Nethermind</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/99\">robee</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/195\">rokinot</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/236\">saneryee</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/358\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/261\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/169\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/293\">Limbooo</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/407\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/240\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/235\">MadWookie</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/168\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/188\">doddle0x</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/91\">0xNineDec</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/402\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/307\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/219\">Kenshin</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/238\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/233\">shenwilly</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/279\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/71\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/118\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/435\">JC</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/10\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/178\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/184\">0xSolus</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/38\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/24\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/181\">Hawkeye</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/88\">itsmeSTYJ</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/383\">pedroais</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/338\">peritoflores</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/210\">rajatbeladiya</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/289\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/14\">Yiko</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/137\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/230\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/399\">aysha</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/5\">David_</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/160\">exd0tpy</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/198\">Sneakyninja0129</a>, and <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/18\">Treasure-Seeker</a>.</em></p>\n<h2 id=\"codebase-summary--key-improvement-opportunities\" style=\"position:relative;\"><a href=\"#codebase-summary--key-improvement-opportunities\" aria-label=\"codebase summary  key improvement opportunities permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Codebase Summary &#x26; Key Improvement Opportunities</h2>\n<h3 id=\"key-features\" style=\"position:relative;\"><a href=\"#key-features\" aria-label=\"key features permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Key Features</h3>\n<p>The in-scope system was found to be low in complexity, with the key features being as follows:</p>\n<ul>\n<li>fillOrder - Fills an offchain order</li>\n<li>exercise - Exercise a long order</li>\n<li>withdraw - Withdraws the assets from a short order</li>\n<li>cancel - Cancels an order which prevents it from being filled in the future</li>\n</ul>\n<h3 id=\"code-quality-and-test-coverage\" style=\"position:relative;\"><a href=\"#code-quality-and-test-coverage\" aria-label=\"code quality and test coverage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Quality and Test Coverage</h3>\n<p>In sumamry, the code quality of the PuttyV2 is high. The codes were also found to be well-documented and team took the efforts to document the NatSpec for all the functions within the <code>PuttyV2</code> contract. However, there are still some room of improvement as NatSpec was not documented for the <code>PuttyV2Nft</code> contract. For completeness and readability, it is recommended to document the NatSpec for all the functions in the contracts where feasible.</p>\n<p>To futher improve readability of the codes, additional helper functions could be implemented. Refer to the “4.6 Code Can Be Refactored To Be More Readable” issue.</p>\n<p>Test coverage was found to be high. All the key features have been covered in the test. However, periphery logic functions such as <code>batchFillOrder</code> and <code>acceptCounterOffer</code> that are exposed to the public users were not included in the tests. It is recommended to write proper tests for all functions.</p>\n<h3 id=\"unexpected-token-behaviors\" style=\"position:relative;\"><a href=\"#unexpected-token-behaviors\" aria-label=\"unexpected token behaviors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unexpected Token Behaviors</h3>\n<p>The system did not implement a whitelisting mechanism to ensure that only approved tokens are allowed to be traded within Putty. Thus, users could specify any tokens within an order/option. This permissionless approach increases the attack surface of the system and exposes the system to various attack vectors. Some tokens might be malicious, some tokens might contain hooks, and some tokens might not work as intended. Thus, it is challenging for Putty to guard against all kinds of vulnerabilites that arise due to the need to support large number of tokens. If possible, it is recommended to only allow approved tokens that have been vetted and reviewed by Putty to be traded within the system to minimize the risks during the initial stage. Once the system is more stable, the team can progressively open up to more tokens.</p>\n<h3 id=\"re-entrancy-risks\" style=\"position:relative;\"><a href=\"#re-entrancy-risks\" aria-label=\"re entrancy risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Re-entrancy Risks</h3>\n<p>The key features (e.g. fillOrder, exercise) were found to be following the “Checks Effects Interactions” pattern rigorously, which help to prevent any possible re-entrancy attack. However, further improvement can be made to guard against future re-entrancy attack. As the key features make many external contract calls via token transfers, the risks of re-entrancy attack is significantly higher for Putty compared to other protocols. Thus, it is prudent to implement additional reentrancy prevention wherever possible by utilizing the nonReentrant modifier from <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol\">Openzeppelin Library</a> to block possible re-entrancy as a defense-in-depth measure.</p>\n<h3 id=\"out-of-gasrevert-risks\" style=\"position:relative;\"><a href=\"#out-of-gasrevert-risks\" aria-label=\"out of gasrevert risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Out-of-gas/Revert Risks</h3>\n<p>The order contains many arrays such as <code>whitelist</code>, <code>floorTokens</code>, <code>erc20Assets</code>, and <code>erc721Assets</code>. It was found that the contract did not place an upper limit on the number of elements that can be stored within the array, and proceed to loop through all the elements within an array in many parts of the codes. This might cause out-of-gas error to happen and cause a revert, thus causing the feature to be unusable in certain scenarios. It is recommended for the team to review each of the loop structures involving an array within the contract to determine if it is possible to place an upper limit.</p>\n<h3 id=\"authorisation-controls\" style=\"position:relative;\"><a href=\"#authorisation-controls\" aria-label=\"authorisation controls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Authorisation Controls</h3>\n<p>Robust authorisation controls have been implemented for all the key features to ensure that only authorised and correct actors could call the functions. For instance, only owner of long position could call the <code>exercise</code> function and only owner of short position could call the <code>withdraw</code> function. No authorisation issues were observed during the contest.</p>\n<h2 id=\"summary-of-findings\" style=\"position:relative;\"><a href=\"#summary-of-findings\" aria-label=\"summary of findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary Of Findings</h2>\n<p>The following is a summary of the low and non-critical findings observed during the contest.</p>\n<table>\n<thead>\n<tr>\n<th>No.</th>\n<th>Title</th>\n<th>Risk Rating</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>L-01</td>\n<td>Lack Of Reentrancy Guards On External Functions</td>\n<td>Low</td>\n</tr>\n<tr>\n<td>L-02</td>\n<td>Discontinuity in Exercise Period</td>\n<td>Low</td>\n</tr>\n<tr>\n<td>L-03</td>\n<td>Insufficient Input Validation</td>\n<td>Low</td>\n</tr>\n<tr>\n<td>L-04</td>\n<td>Order Cannot Be Filled Due To Unbounded Whitelist Within An Order</td>\n<td>Low</td>\n</tr>\n<tr>\n<td>L-05</td>\n<td>Order Cannot Be Filled Due To Unbounded floorTokens, ERC20Asset Or ERC721Asset Within An Order</td>\n<td>Low</td>\n</tr>\n<tr>\n<td>L-06</td>\n<td>Order Can Be Cancelled Even After Being Filled</td>\n<td>Low</td>\n</tr>\n<tr>\n<td>L-07</td>\n<td>No Check if onERC721Received Is Implemented</td>\n<td>Low</td>\n</tr>\n<tr>\n<td>N-01</td>\n<td>Omissions in events</td>\n<td>Non-Critical</td>\n</tr>\n<tr>\n<td>N-02</td>\n<td>Draft OpenZeppelin Dependencies</td>\n<td>Non-Critical</td>\n</tr>\n<tr>\n<td>N-03</td>\n<td>Insufficient Tests</td>\n<td>Non-Critical</td>\n</tr>\n<tr>\n<td>N-04</td>\n<td>Owner Can Renounce Ownership</td>\n<td>Non-Critical</td>\n</tr>\n<tr>\n<td>N-05</td>\n<td>Consider two-phase ownership transfer</td>\n<td>Non-Critical</td>\n</tr>\n<tr>\n<td>N-06</td>\n<td>Code Can Be Refactored To Be More Readable</td>\n<td>Non-Critical</td>\n</tr>\n<tr>\n<td>N-07</td>\n<td>Inconsistent use of named return variables</td>\n<td>Non-Critical</td>\n</tr>\n<tr>\n<td>N-08</td>\n<td>Unused imports</td>\n<td>Non-Critical</td>\n</tr>\n<tr>\n<td>N-09</td>\n<td>Incorrect functions visibility</td>\n<td>Non-Critical</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"l-01-lack-of-reentrancy-guards-on-external-functions\" style=\"position:relative;\"><a href=\"#l-01-lack-of-reentrancy-guards-on-external-functions\" aria-label=\"l 01 lack of reentrancy guards on external functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Lack Of Reentrancy Guards On External Functions</h2>\n<p>The following external functions within the <code>PuttyV2</code> contract contain function calls (e.g.  <code>safeTransferFrom</code>, <code>safeTransfer</code>) that pass control to external contracts. Additionally, if ERC777 tokens are being used within an order, it contains various hooks that will pass the execution control to the external party.</p>\n<p>Thus, it might allow an malicious external contract to re-enter to the contract.</p>\n<ul>\n<li><code>PuttyV2.fillorder</code></li>\n<li><code>PuttyV2.exercise</code></li>\n<li><code>PuttyV2.withdraw</code></li>\n<li><code>PuttyV2.batchFillOrder</code></li>\n<li><code>Putty.acceptCounterOffer</code></li>\n</ul>\n<p>No re-entrancy attacks that could lead to loss of assets were observed during the assessment. Thus, this issue is marked as Low.</p>\n<p>The following shows examples of function call being made to an external contract</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451</a></p>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is recommended to follow the good security practices and apply necessary reentrancy prevention by utilizing the nonReentrant modifier from <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol\">Openzeppelin Library</a> to block possible re-entrancy.</p>\n<h2 id=\"l-02-discontinuity-in-exercise-period\" style=\"position:relative;\"><a href=\"#l-02-discontinuity-in-exercise-period\" aria-label=\"l 02 discontinuity in exercise period permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Discontinuity in Exercise Period</h2>\n<p>The position can be exercised if current block timestamp is less than the position’s expiration.</p>\n<p>The position can be withdrawed if current block timestamp is greater than the position’s expiration</p>\n<p>However, when current block timestamp is equal to the position’s expiration (<code>block.timestamp == positionExpirations</code>), the state is unknown (cannot be exercised or withdraw)</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L401\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L401</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">exercise</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// check position has not expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">positionExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">)], </span><span class=\"mtk8\">&quot;Position has expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L481\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L481</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// check long position has either been exercised or is expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">positionExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">longPositionId</span><span class=\"mtk1\">] || </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must be exercised or expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Allow the user to withdraw the position upon expiration.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// check long position has either been exercised or is expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">positionExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">longPositionId</span><span class=\"mtk1\">] || </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must be exercised or expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"l-03-insufficient-input-validation\" style=\"position:relative;\"><a href=\"#l-03-insufficient-input-validation\" aria-label=\"l 03 insufficient input validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Insufficient Input Validation</h2>\n<p>The <code>PuttyV2.fillOrder</code> function does not validate that the <code>msg.sender</code> (order taker) is the same as the order maker, which might potentially lead to unwanted behaviour within the system. Order taker should not be the same as order maker under any circumstances.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L268\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L268</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fillOrder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorAssetTokenIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/* ~~~ CHECKS ~~~ */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check signature is valid using EIP-712</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SignatureChecker</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isValidSignatureNow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Invalid signature&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check order is not cancelled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">cancelledOrders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Order has been cancelled&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check msg.sender is allowed to fill the order</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk11\">isWhitelisted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Not whitelisted&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check duration is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">10_000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Duration too long&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check order has not expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Order has expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check base asset exists</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">.</span><span class=\"mtk12\">code</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;baseAsset is not contract&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommendation-3\" style=\"position:relative;\"><a href=\"#recommendation-3\" aria-label=\"recommendation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Implement the necessary check to ensure that order taker is not the same as order maker.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid order taker&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"l-04-order-cannot-be-filled-due-to-unbounded-whitelist-within-an-order\" style=\"position:relative;\"><a href=\"#l-04-order-cannot-be-filled-due-to-unbounded-whitelist-within-an-order\" aria-label=\"l 04 order cannot be filled due to unbounded whitelist within an order permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Order Cannot Be Filled Due To Unbounded Whitelist Within An Order</h2>\n<p>An order can contain large number of addresses within the <code>whitelist</code> array of an order.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L78\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L78</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maker</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC20Asset</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC721Asset</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>When the <code>PuttyV2.fillOrder</code> function is called, it will attempt to check if the caller is whitelisted by looping through the <code>order.whitelist</code> array. However, if <code>order.whitelist</code> array contains large number of addresses, it will result in out-of-gas error and cause a revert. Thus, this order can never be filled.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L284\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L284</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fillOrder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorAssetTokenIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">// @audit-issue no re-entrancy guard</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// check msg.sender is allowed to fill the order</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk11\">isWhitelisted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Not whitelisted&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L669\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L669</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isWhitelisted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">target</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommendation-4\" style=\"position:relative;\"><a href=\"#recommendation-4\" aria-label=\"recommendation 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is recommended to restrict the number of whitelisted addresses within an order to a upper limit (e.g. 30).</p>\n<p>Although client-side or off-chain might have already verified that the number of whitelisted addresses do not exceed a certain limit within an order, simply relying on client-side and off-chain validations are not sufficient. It is possible for an attacker to bypass the client-side and off-chain validations and interact directly with the contract. Thus, such validation must also be implemented on the on-chain contracts.</p>\n<h2 id=\"l-05-order-cannot-be-filled-due-to-unbounded-floortokens-erc20asset-or-erc721asset-within-an-order\" style=\"position:relative;\"><a href=\"#l-05-order-cannot-be-filled-due-to-unbounded-floortokens-erc20asset-or-erc721asset-within-an-order\" aria-label=\"l 05 order cannot be filled due to unbounded floortokens erc20asset or erc721asset within an order permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Order Cannot Be Filled Due To Unbounded floorTokens, ERC20Asset Or ERC721Asset Within An Order</h2>\n<p>An order can contain large number of tokens within the <code>floorTokens</code>, <code>ERC20Asset</code> or <code>ERC721Asset</code> arrays of an order.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L78\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L78</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maker</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strike</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premium</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expiration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC20Asset</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC721Asset</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>When the <code>PuttyV2.fillOrder</code> function is called, it will attempts to loop through all the <code>floorTokens</code>, <code>ERC20Asset</code> or <code>ERC721Asset</code> arrays of an order to transfer the required assets to <code>PuttyV2</code> contract from the order maker or taker.</p>\n<p>The <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L593\"><code>_transferERC20sIn</code></a>, <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L610\"><code>_transferERC721sIn</code></a>, <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L622\"><code>_transferFloorsIn</code></a> attempt to loop through all the tokens within the array. However, if array contains large number of tokens, it will result in out-of-gas error and cause a revert. Thus, this order can never be filled.</p>\n<p>Following is an example of the vulnerable function.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L593\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L593</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferERC20sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20Asset</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">token</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk12\">code</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERC20: Token is not contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;ERC20: Amount too small&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommendation-5\" style=\"position:relative;\"><a href=\"#recommendation-5\" aria-label=\"recommendation 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is recommended to restrict the number of tokens  within the <code>floorTokens</code>, <code>ERC20Asset</code> or <code>ERC721Asset</code> arrays of an order. (e.g. Maximum of 10 tokens)</p>\n<p>Although client-side or off-chain might have already verified that the number of tokens do not exceed a certain limit within an order, simply relying on client-side and off-chain validations are not sufficient. It is possible for an attacker to bypass the client-side and off-chain validations and interact directly with the contract. Thus, such validation must also be implemented on the on-chain contracts.</p>\n<h2 id=\"l-06-order-can-be-cancelled-even-after-being-filled\" style=\"position:relative;\"><a href=\"#l-06-order-can-be-cancelled-even-after-being-filled\" aria-label=\"l 06 order can be cancelled even after being filled permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Order Can Be Cancelled Even After Being Filled</h2>\n<p>Once an order has been filled, no one should be able to cancel the order or mark the order as <code>Cancelled</code>.</p>\n<p>The following code shows that the order maker can change the status of the order to <code>Cancelled</code> at any point of time.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L526\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L526</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Cancels an order which prevents it from being filled in the future.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">order</span><span class=\"mtk3\"> The order to cancel.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">cancel</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not your order&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// mark the order as cancelled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cancelledOrders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CancelledOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Although changing the status of an order to <code>Cancelled</code> after it has been filled does not cause any lost of funds at the later stages (e.g. when exercising or withdrawing), it might cause unnecessary confusion to the users as it does not accurately reflect the status of an order on-chain.</p>\n<p>Users might fetch the status of an order directly from the <code>cancelledOrders</code> mapping or poll the on-chain for emitted event, and come to a wrong conclusion that since the order has been cancelled, it has not been filled.</p>\n<h3 id=\"recommendation-6\" style=\"position:relative;\"><a href=\"#recommendation-6\" aria-label=\"recommendation 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is recommended to update the <code>cancel</code> function to only allow order maker to call this function only if an order has not been filled.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">cancel</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not your order&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// If an order has been filled, the positionExpirations[orderHash] will be populated.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">positionExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">] == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Order has already been filled. Cannot cancel.&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// mark the order as cancelled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cancelledOrders</span><span class=\"mtk1\">[</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CancelledOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"l-07-no-check-if-onerc721received-is-implemented\" style=\"position:relative;\"><a href=\"#l-07-no-check-if-onerc721received-is-implemented\" aria-label=\"l 07 no check if onerc721received is implemented permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] No Check if onERC721Received Is Implemented</h2>\n<p>The <code>PuttyV2.fillOrder</code> will mint a long position NFT and short position NFT to the order maker and taker. When minting a NFT, the function does not check if a receiving contract implements onERC721Received().</p>\n<p>The intention behind this function is to check if the address receiving the NFT, if it is a contract, implements onERC721Received(). Thus, there is no check whether the receiving address supports ERC-721 tokens and position could be not transferrable in some cases.</p>\n<p>Following shows that <code>_mint</code> is used instead of <code>_safeMint</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L303\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L303</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fillOrder</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorAssetTokenIds</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// create long/short position for maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk3\">// create opposite long/short position for taker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oppositeOrderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOppositeOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">positionId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oppositeOrderHash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span></code></pre>\n<h3 id=\"recommendation-7\" style=\"position:relative;\"><a href=\"#recommendation-7\" aria-label=\"recommendation 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider using <a href=\"https://github.com/Rari-Capital/solmate/blob/3c738133a0c1697096d63d28ef7a8ef298f9af6b/src/tokens/ERC721.sol#L193\"><code>_safeMint</code></a> instead of <a href=\"https://github.com/Rari-Capital/solmate/blob/3c738133a0c1697096d63d28ef7a8ef298f9af6b/src/tokens/ERC721.sol#L157\"><code>_mint</code></a>.</p>\n<h2 id=\"n-01-omissions-in-events\" style=\"position:relative;\"><a href=\"#n-01-omissions-in-events\" aria-label=\"n 01 omissions in events permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Omissions in events</h2>\n<p>Throughout the codebase, events are generally emitted when sensitive changes are made to the contracts. However, some events are missing important parameters</p>\n<h4 id=\"instance-1---missing-old-value\" style=\"position:relative;\"><a href=\"#instance-1---missing-old-value\" aria-label=\"instance 1   missing old value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instance #1 - Missing Old Value</h4>\n<p>When setting a new <code>baseURI</code> and <code>fee</code>, only the new value is emitted within the event.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L228\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L228</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBaseURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_baseURI</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">baseURI</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_baseURI</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewBaseURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_baseURI</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L240\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L240</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">30</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;fee must be less than 3%&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The events should include the new value and old value where possible.</p>\n<h2 id=\"n-02-draft-openzeppelin-dependencies\" style=\"position:relative;\"><a href=\"#n-02-draft-openzeppelin-dependencies\" aria-label=\"n 02 draft openzeppelin dependencies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Draft OpenZeppelin Dependencies</h2>\n<p>The <code>PuttyV2</code> contract utilised <code>draft-EIP712</code> , an OpenZeppelin contract. This contract is still a draft and is not considered ready for mainnet use. OpenZeppelin contracts may be considered draft contracts if they have not received adequate security auditing or are liable to change with future development.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L40\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L40</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;openzeppelin/utils/cryptography/SignatureChecker.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;openzeppelin/utils/cryptography/draft-EIP712.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;openzeppelin/utils/Strings.sol&quot;</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h3 id=\"recommendation-8\" style=\"position:relative;\"><a href=\"#recommendation-8\" aria-label=\"recommendation 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Ensure the development team is aware of the risks of using a draft contract or consider waiting until the contract is finalised.</p>\n<p>Otherwise, make sure that development team are aware of the risks of using a draft OpenZeppelin contract and accept the risk-benefit trade-off.</p>\n<h2 id=\"n-03-insufficient-tests\" style=\"position:relative;\"><a href=\"#n-03-insufficient-tests\" aria-label=\"n 03 insufficient tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Insufficient Tests</h2>\n<p>It is crucial to write tests with possibly 100% coverage for smart contract systems.</p>\n<p>The following functions were found to be not included in the test cases:</p>\n<ul>\n<li><code>PuttyV2.batchFillOrder</code> - <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L546\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L546</a></li>\n<li><code>PuttyV2.acceptCounterOffer</code> - <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L573\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L573</a></li>\n</ul>\n<h3 id=\"recommendation-9\" style=\"position:relative;\"><a href=\"#recommendation-9\" aria-label=\"recommendation 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is recommended to write proper tests for all possible code flows and specially edge cases</p>\n<h2 id=\"n-04-owner-can-renounce-ownership\" style=\"position:relative;\"><a href=\"#n-04-owner-can-renounce-ownership\" aria-label=\"n 04 owner can renounce ownership permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Owner Can Renounce Ownership</h2>\n<p>Typically, the contract’s owner is the account that deploys the contract. As a result, the owner is able to perform certain privileged activities.</p>\n<p>The Openzeppelin’s <code>Ownable</code> used in <code>PuttyV2</code> contract implements <code>renounceOwnership</code>. This can represent a certain risk if the ownership is renounced for any other reason than by design. Renouncing ownership will leave the contract without an owner, thereby removing any functionality that is only available to the owner.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L53\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L53</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@title</span><span class=\"mtk3\"> PuttyV2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@author</span><span class=\"mtk3\"> </span><span class=\"mtk10\">out.eth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> An otc erc721 and erc20 option market.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PuttyV2Nft</span><span class=\"mtk1\">, </span><span class=\"mtk11\">EIP712</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Putty&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;2.0&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ERC721TokenReceiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Ownable</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h3 id=\"recommendation-10\" style=\"position:relative;\"><a href=\"#recommendation-10\" aria-label=\"recommendation 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>We recommend to either reimplement the function to disable it or to clearly specify if it is part of the contract design</p>\n<h2 id=\"n-05-consider-two-phase-ownership-transfer\" style=\"position:relative;\"><a href=\"#n-05-consider-two-phase-ownership-transfer\" aria-label=\"n 05 consider two phase ownership transfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Consider two-phase ownership transfer</h2>\n<p>Admin calls <code>Ownable.transferOwnership</code> function to transfers the ownership to the new address directly. As such, there is a risk that the ownership is transferred to an invalid address, thus causing the contract to be without a owner.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L53\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L53</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PuttyV2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PuttyV2Nft</span><span class=\"mtk1\">, </span><span class=\"mtk11\">EIP712</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Putty&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;2.0&quot;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ERC721TokenReceiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Ownable</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h3 id=\"recommendation-11\" style=\"position:relative;\"><a href=\"#recommendation-11\" aria-label=\"recommendation 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider implementing a two step process where the admin nominates an account and the nominated account needs to call an acceptOwnership() function for the transfer of admin to fully succeed. This ensures the nominated EOA account is a valid and active account.</p>\n<h2 id=\"n-06-code-can-be-refactored-to-be-more-readable\" style=\"position:relative;\"><a href=\"#n-06-code-can-be-refactored-to-be-more-readable\" aria-label=\"n 06 code can be refactored to be more readable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Code Can Be Refactored To Be More Readable</h2>\n<p>In many parts of the <code>PuttyV2</code> contract, it uses the following conditions to check the type of the order being passed into the function:</p>\n<ul>\n<li>order.isLong &#x26;&#x26; order.isCall (equal to long call)</li>\n<li>order.isLong &#x26;&#x26; !order.isCall (equal to long put)</li>\n<li>order.!isLong &#x26;&#x26; order.isCall (equal to short call)</li>\n<li>order.!isLong &#x26;&#x26; order.!isCall (equal to short put)</li>\n</ul>\n<p>These affect the readability of the codes as the readers have to interpret the condition to determine if it is a “long call”, “long put”, “short call” or “short put”. This might increase the risk of mistakes in the future if new developer works on the contracts.</p>\n<h3 id=\"recommendation-12\" style=\"position:relative;\"><a href=\"#recommendation-12\" aria-label=\"recommendation 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider implementing the following functions to improve readability:</p>\n<ul>\n<li>isLongCall(Order order) public view returns (bool)</li>\n<li>isLongPut(Order order) public view returns (bool)</li>\n<li>isShortCall(Order order) public view returns (bool)</li>\n<li>isShortPut(Order order) public view returns (bool)</li>\n</ul>\n<h2 id=\"n-07-inconsistent-use-of-named-return-variables\" style=\"position:relative;\"><a href=\"#n-07-inconsistent-use-of-named-return-variables\" aria-label=\"n 07 inconsistent use of named return variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Inconsistent use of named return variables</h2>\n<p>There is an inconsistent use of named return variables in the <code>PuttyV2</code> contract</p>\n<p>Some functions return named variables, others return explicit values.</p>\n<p>Following function return explicit value</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L669\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L669</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isWhitelisted</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">target</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">whitelist</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Following function return return a named variable</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L683\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L683</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">hashOppositeOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// use decode/encode to get a copy instead of reference</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oppositeOrder</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">), (</span><span class=\"mtk12\">Order</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// get the opposite side of the order (short/long)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">oppositeOrder</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\"> = !</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oppositeOrder</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommendation-13\" style=\"position:relative;\"><a href=\"#recommendation-13\" aria-label=\"recommendation 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider adopting a consistent approach to return values throughout the codebase by removing all named return variables, explicitly declaring them as local variables, and adding the necessary return statements where appropriate. This would improve both the explicitness and readability of the code, and it may also help reduce regressions during future code refactors.</p>\n<h2 id=\"n-08-unused-imports\" style=\"position:relative;\"><a href=\"#n-08-unused-imports\" aria-label=\"n 08 unused imports permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-08] Unused imports</h2>\n<p>To improve readability and avoid confusion, consider removing the following unused imports:</p>\n<p>In the <code>PuttyV2Nft</code> contract:</p>\n<ul>\n<li>openzeppelin/utils/Strings.sol</li>\n</ul>\n<p>Note that the <code>Strings.sol</code> has already been imported in <code>PuttyV2</code> contract. Thus, this import can be safely removed.</p>\n<p>Within the <code>PuttyV2Nft</code> contract, it does not use any of the functions from <code>Strings.sol</code>.</p>\n<h3 id=\"recommendation-14\" style=\"position:relative;\"><a href=\"#recommendation-14\" aria-label=\"recommendation 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider removing the unused import if it is not required.</p>\n<h2 id=\"n-09-incorrect-functions-visibility\" style=\"position:relative;\"><a href=\"#n-09-incorrect-functions-visibility\" aria-label=\"n 09 incorrect functions visibility permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-09] Incorrect functions visibility</h2>\n<p>Whenever a function is not being called internally in the code, it can be easily declared as <code>external</code>, <a href=\"https://github.com/crytic/slither/wiki/Detector-Documentation#description-44\">saving also gas</a>. While the entire code base have explicit visibilities for every function, some of them can be changed to be <code>external</code>.</p>\n<p>Following are some the functions that can be changed to be <code>external</code></p>\n<ul>\n<li><code>PuttyV2.fillorder</code></li>\n<li><code>PuttyV2.exercise</code></li>\n<li><code>PuttyV2.withdraw</code></li>\n<li><code>PuttyV2.batchFillOrder</code></li>\n<li><code>Putty.acceptCounterOffer</code></li>\n</ul>\n<h3 id=\"recommendation-15\" style=\"position:relative;\"><a href=\"#recommendation-15\" aria-label=\"recommendation 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Review the visibility of the affected functions and change visibility of these functions to <code>external</code>.</p>\n<h2 id=\"n-10-natspec-is-missing\" style=\"position:relative;\"><a href=\"#n-10-natspec-is-missing\" aria-label=\"n 10 natspec is missing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-10] NatSpec Is Missing</h2>\n<p>NatSpec if missing for the following function</p>\n<ul>\n<li><code>PuttyV2Nft._mint</code>  - <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L11\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L11</a></li>\n<li><code>PuttyV2Nft.transferFrom</code> - <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L21\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L21</a></li>\n<li><code>PuttyV2Nft.balanceOf</code> - <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L40\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L40</a></li>\n</ul>\n<h3 id=\"recommendation-16\" style=\"position:relative;\"><a href=\"#recommendation-16\" aria-label=\"recommendation 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Implement NatSpec for all functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/306#issuecomment-1178063479\">outdoteth (Putty Finance) commented</a>:</strong></p>\n<blockquote>\n<p>High quality report.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/306#issuecomment-1186102954\">HickupHH3 commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>L-03 Insufficient Input Validation</p>\n</blockquote>\n<p>Disagree, I remember seeing there was a use case for having taker == maker discussed in 1 of the issues somewhere.</p>\n<blockquote>\n<p>L-04 Order Cannot Be Filled Due To Unbounded Whitelist Within An Order</p>\n</blockquote>\n<p>Sort a duplicate of #290.</p>\n<p>Agree that overall it is a very good report! </p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 94 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/280\">report highlighted below</a> by <strong>Alex the Entreprenerd</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/217\">0xA5DF</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/229\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/43\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/381\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/430\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/315\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/100\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/204\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/239\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/162\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/237\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/93\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/424\">0xsanson</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/379\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/213\">grrwahrr</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/75\">JohnSmith</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/270\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/274\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/194\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/59\">0xKitsune</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/413\">Metatron</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/334\">RedOneN</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/313\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/432\">JC</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/182\">rokinot</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/364\">UnusualTurtle</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/272\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/241\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/78\">PwnedNoMore</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/335\">saian</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/26\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/391\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/191\">zer0dot</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/351\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/403\">BowTiedWardens</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/423\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/119\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/344\">jayfromthe13th</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/292\">Limbooo</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/392\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/288\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/189\">swit</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/166\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/268\">z3s</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/23\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/70\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/9\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/154\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/337\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/92\">0xNineDec</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/420\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/366\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/84\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/177\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/343\">Fitraldys</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/411\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/331\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/220\">Kenshin</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/41\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/398\">mektigboy</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/180\">mrpathfindr</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/385\">natzuu</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/329\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/187\">slywaters</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/320\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/200\">StErMi</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/384\">Kaiziron</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/234\">MadWookie</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/42\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/142\">ACai</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/314\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/146\">cRat1st0s</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/111\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/46\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/214\">rajatbeladiya</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/147\">zeesaw</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/409\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/419\">datapunk</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/179\">Hawkeye</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/2\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/262\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/32\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/167\">0xHarry</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/86\">apostle0x01</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/312\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/218\">codetilda</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/159\">exd0tpy</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/126\">hake</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/103\">Haruxe</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/98\">robee</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/150\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/415\">StyxRave</a>, and <a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/15\">Yiko</a>.</em></p>\n<h2 id=\"executive-summary\" style=\"position:relative;\"><a href=\"#executive-summary\" aria-label=\"executive summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Executive Summary</h2>\n<p>The codebase is already pretty well thought out, by extending the idea of using ERC721 IDs as identifiers, we can save massive amount of gas for day to day operations, we can also apply a few basic logic transformations as well as basic gas saving tips to reduce the total gas for the average operation by over 20k gas</p>\n<p>The first few refactoring will offer strong gas savings with minimal work (20k+ gas), the remaining findings are minor and I expect most other wardens to also be suggesting them</p>\n<h3 id=\"massive-gas-savings-in-exercise-by-removing-exercisedpositions---around-20k-gas-on-every-exercise-17k-to-23k-from-foundry-tests\" style=\"position:relative;\"><a href=\"#massive-gas-savings-in-exercise-by-removing-exercisedpositions---around-20k-gas-on-every-exercise-17k-to-23k-from-foundry-tests\" aria-label=\"massive gas savings in exercise by removing exercisedpositions   around 20k gas on every exercise 17k to 23k from foundry tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Massive Gas Savings in <code>exercise</code> by removing <code>exercisedPositions</code> - Around 20k gas on every <code>exercise</code> (17k to 23k from foundry tests)</h3>\n<p>It seems like <code>exercisedPositions</code> is used exclusively for <code>withdraw</code>, however through the cleverly designed “send to 0xdead” system, we can replace the <code>exercisedPositions</code> function with the following</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function exercisedPositions(uint256 id) external view returns(bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return ownerOf(id) == address(0xdead);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>In fact, a position was exercised if it was transfered to 0xdead, as such there’s no need to store a mapping in storage.</p>\n<p>We can delete every mention of <code>exercisedPositions</code> as well as the storage mapping</p>\n<p>This single change will reduce almost 20k gas from <code>exercise</code></p>\n<p>To make <code>withdraw</code> work we can write the following</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Inlined is even cheaper (8 gas for the JUMP)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">longPositionId</span><span class=\"mtk1\">)) == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xdead</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>And we can delete the <code>exercisedPositions</code> mapping from the contract</p>\n<p>You can use the function above so the test still passes, in case you need a way to verify if a position was exercised, otherwise you can just use the <code>isExercised</code> line and delete very other mention of <code>exercisedPositions</code></p>\n<h4 id=\"gas-math\" style=\"position:relative;\"><a href=\"#gas-math\" aria-label=\"gas math permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Math</h4>\n<p>BEFORE\nexercise                   ┆ 5759            ┆ 55920  ┆ 68002  ┆ 133534 ┆ 18<br>\nwithdraw                   ┆ 3075            ┆ 27840  ┆ 24545  ┆ 71168  ┆ 10</p>\n<p>AFTER\nexercise                   ┆ 5759            ┆ 42356  ┆ 45806  ┆ 115777 ┆ 18\nwithdraw                   ┆ 3075            ┆ 26968  ┆ 23807  ┆ 70836  ┆ 10</p>\n<h4 id=\"diff\" style=\"position:relative;\"><a href=\"#diff\" aria-label=\"diff permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Diff</h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"bash\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">155c155,157</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;     mapping(uint256 =&gt; bool) public exercisedPositions;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">exercisedPositions(uint256</span><span class=\"mtk1\"> id) external view returns(bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> ownerOf(id) == address(0xdead);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">415,417d416</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;         // mark the position as exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;         exercisedPositions[uint256(orderHash)] = </span><span class=\"mtk11\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">478c477</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&lt;         bool isExercised = exercisedPositions[longPositionId];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">&gt;         bool isExercised = ownerOf(longPositionId) == address(0xdead);</span></span></span></code></pre>\n<h3 id=\"avoid-a-sload-optimistically---21k-gas-saved\" style=\"position:relative;\"><a href=\"#avoid-a-sload-optimistically---21k-gas-saved\" aria-label=\"avoid a sload optimistically   21k gas saved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Avoid a SLOAD optimistically - 2.1k gas saved</h3>\n<p>Because you already computed <code>isExercised</code>, you can save an SLOAD (2.1k gas) if you check for <code>isExercised</code> first.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L481-L482\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L481-L482</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">positionExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">longPositionId</span><span class=\"mtk1\">] || </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must be exercised or expired&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>You could also refactor to the reverse check (if you expect the majority of positions to expire worthless), either way the short circuit can be used to save a SLOAD, whicever priority you give it</p>\n<h4 id=\"change-to\" style=\"position:relative;\"><a href=\"#change-to\" aria-label=\"change to permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Change to</h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">positionExpirations</span><span class=\"mtk1\">[</span><span class=\"mtk12\">longPositionId</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Must be exercised or expired&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>To save 2.1k gas if the option was exercised</p>\n<h3 id=\"double-sload---94-gas-saved\" style=\"position:relative;\"><a href=\"#double-sload---94-gas-saved\" aria-label=\"double sload   94 gas saved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Double SLOAD - 94 gas saved</h3>\n<p>Everytime a Storage Variable is loaded twice, (SLOAD), it would be cheaper to use a supporting memory variable\nThe cost of a Second SLOAD is 100 gas, the cost of an MSTORE is 3 and and MLOAD another 3 gas.</p>\n<p>Using a supporting variable will save 94 gas on the second read, and 97 gas for each subsquent MSTORE</p>\n<p>In the case of <code>fee</code> this can save 94 gas</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L498-L499\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L498-L499</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h3 id=\"storage-pointer-to-floortokenids-will-save-gas-avoid-copying-whole-storage-to-memory---between-400-and-2k-gas-saved-on-withdraw-and-exercise---400--2k--2-gas-saved\" style=\"position:relative;\"><a href=\"#storage-pointer-to-floortokenids-will-save-gas-avoid-copying-whole-storage-to-memory---between-400-and-2k-gas-saved-on-withdraw-and-exercise---400--2k--2-gas-saved\" aria-label=\"storage pointer to floortokenids will save gas avoid copying whole storage to memory   between 400 and 2k gas saved on withdraw and exercise   400  2k  2 gas saved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Storage Pointer to <code>floorTokenIds</code> will save gas (avoid copying whole storage to memory) - Between 400 and 2k gas saved on Withdraw and Exercise - 400 / 2k * 2 gas saved</h3>\n<p>If you pass a <code>storage</code> pointer as argument to a <code>memory</code> typed function like <a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L657-L658\"><code>_transferFloorsOut</code></a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorTokenIds</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>You are copying the storage values to memory and then reading them and looping through that copy, this incurs an overhead and is equivalent to looping over storage, copying into memory and then passing the memory variable.</p>\n<p>This is one of the few cases where a storage declaration (passing the storage pointer) will save gas</p>\n<h4 id=\"refactor-to\" style=\"position:relative;\"><a href=\"#refactor-to\" aria-label=\"refactor to permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refactor to</h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorTokenIds</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h4 id=\"gas-math-1\" style=\"position:relative;\"><a href=\"#gas-math-1\" aria-label=\"gas math 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Math</h4>\n<h5 id=\"before\" style=\"position:relative;\"><a href=\"#before\" aria-label=\"before permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Before</h5>\n<p>exercise                   ┆ 5759            ┆ 55920  ┆ 68002  ┆ 133534 ┆ 18\nwithdraw                   ┆ 3075            ┆ 27840  ┆ 24545  ┆ 71168  ┆ 10</p>\n<p>#### After\nexercise                   ┆ 5759            ┆ 55176  ┆ 65795  ┆ 133534 ┆ 18<br>\nwithdraw                   ┆ 3075            ┆ 27365  ┆ 24545  ┆ 71003  ┆ 10</p>\n<h3 id=\"save-gas-by-avoiding-not---saves-6-gas-sometimes\" style=\"position:relative;\"><a href=\"#save-gas-by-avoiding-not---saves-6-gas-sometimes\" aria-label=\"save gas by avoiding not   saves 6 gas sometimes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Save gas by avoiding NOT - Saves 6 gas sometimes</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L403-L406\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L403-L406</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check floor asset token ids length is 0 unless the position type is put</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        !</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Wrong amount of floor tokenIds&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid floor tokenIds length&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Because the logic is fully known, it would be cheaper to swap the if else to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ? </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid floor tokenIds length&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            : </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">floorAssetTokenIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Wrong amount of floor tokenIds&quot;</span><span class=\"mtk1\">) </span></span></span></code></pre>\n<p>As that would avoid the extra <code>NOT</code></p>\n<h3 id=\"check-msgvalue-first---1-gas-per-instance---3-gas-total\" style=\"position:relative;\"><a href=\"#check-msgvalue-first---1-gas-per-instance---3-gas-total\" aria-label=\"check msgvalue first   1 gas per instance   3 gas total permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Check msg.value first - 1 gas per instance - 3 gas total</h3>\n<p>Reading msg.value costs 2 gas, while reading from memory costs 3, this will save 1 gas with no downside</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L327\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L327</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">weth</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p>Change to</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">weth</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<h3 id=\"common-gas-savings\" style=\"position:relative;\"><a href=\"#common-gas-savings\" aria-label=\"common gas savings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Common Gas Savings</h3>\n<p>Below are a bunch of basic gas saving tips you probably will receive in most competent submissions added below for the sake of completeness</p>\n<h4 id=\"save-3-gas-by-not-reading-orderslength---3-gas-per-instance---27-gas-saved\" style=\"position:relative;\"><a href=\"#save-3-gas-by-not-reading-orderslength---3-gas-per-instance---27-gas-saved\" aria-label=\"save 3 gas by not reading orderslength   3 gas per instance   27 gas saved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Save 3 gas by not reading <code>orders.length</code> - 3 gas per instance - 27 gas saved</h4>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L551-L552\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L551-L552</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">signatures</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Length mismatch in input&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><code>orders.length</code> is read multiple times, because of that, especially for the loop, you should cache it in a memory variable to save 3 gas per instance</p>\n<p>Refactor to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ordersLength</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">orders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">signatures</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Length mismatch in input&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742</a></p>\n<h4 id=\"avoid-default-assignment---3-gas-per-instance---27-gas-saved\" style=\"position:relative;\"><a href=\"#avoid-default-assignment---3-gas-per-instance---27-gas-saved\" aria-label=\"avoid default assignment   3 gas per instance   27 gas saved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Avoid default assignment - 3 gas per instance - 27 gas saved</h4>\n<p>Declaring <code>uint256 i = 0;</code> means doing an MSTORE of the value 0\nInstead you could just declare <code>uint256 i</code> to declare the variable without assigning it’s default value, saving 3 gas per declaration</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L556-L557\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L556-L557</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">orders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p>Instances:\n<a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742</a></p>\n<h4 id=\"cheaper-for-loops---25-to-80-gas-per-instance---9-instances\" style=\"position:relative;\"><a href=\"#cheaper-for-loops---25-to-80-gas-per-instance---9-instances\" aria-label=\"cheaper for loops   25 to 80 gas per instance   9 instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cheaper For Loops - 25 to 80 gas per instance - 9 instances</h4>\n<p>You can get cheaper for loops (at least 25 gas, however can be up to 80 gas under certain conditions), by rewriting:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">orders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk3\">/** NOTE: Removed i++ **/</span><span class=\"mtk1\"> ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Do the thing</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// Unchecked pre-increment is cheapest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> { ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }       </span></span></span></code></pre>\n<p>Instances:\n<a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742</a></p>\n<h4 id=\"simplify-value-comparison---saves-some-bytecode-and-makes-logic-leaner\" style=\"position:relative;\"><a href=\"#simplify-value-comparison---saves-some-bytecode-and-makes-logic-leaner\" aria-label=\"simplify value comparison   saves some bytecode and makes logic leaner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Simplify Value Comparison - Saves some bytecode and makes logic leaner</h4>\n<p><a href=\"https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495-L496\">https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495-L496</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) || (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span></code></pre>\n<p>Can be refactored with</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer strike to owner if put is expired or call is exercised</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p>As in both case they were both true or both false</p>\n<h4 id=\"consequence-of-smart-comparison-above---saves-20-to-80-gas-avg-is-60\" style=\"position:relative;\"><a href=\"#consequence-of-smart-comparison-above---saves-20-to-80-gas-avg-is-60\" aria-label=\"consequence of smart comparison above   saves 20 to 80 gas avg is 60 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Consequence of Smart Comparison Above - Saves 20 to 80 gas (avg is 60)</h4>\n<p>Because of the gas save above we can refactor the entire block to an if / else</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) || (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// send the fee to the admin/DAO if fee is greater than 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer assets from putty to owner if put is exercised or call is expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">) || (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC20sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC721sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// for call options the floor token ids are saved in the long position in fillOrder(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// and for put options the floor tokens ids are saved in the short position in exercise()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorPositionId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">longPositionId</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">floorPositionId</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>Becomes</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">isExercised</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// transfer assets from putty to owner if put is exercised or call is expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// send the fee to the admin/DAO if fee is greater than 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// transfer assets from putty to owner if put is exercised or call is expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_transferERC20sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_transferERC721sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// for call options the floor token ids are saved in the long position in fillOrder(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// and for put options the floor tokens ids are saved in the short position in exercise()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">floorPositionId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">longPositionId</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">floorPositionId</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>Which reduces bytecode size, and saves gas in most situations as you’re avoiding up to 3 extra comparisons</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-putty-findings/issues/280#issuecomment-1178176775\">outdoteth commented</a>:</strong></p>\n<blockquote>\n<p>Cool idea with relying on 0xdead to see if an option is exercised or not. Unfortunately this doesnt work because a user can intentionally “burn” their NFT to 0xdead which then messes up the logic in withdraw. This can be mitigated, but requires too many changes.</p>\n<p>High quality report though.</p>\n</blockquote>\n<hr>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review</h1>\n<p><em>Mitigation review by <a href=\"https://twitter.com/0xhyh\">hyh</a></em></p>\n<p>Project repository: <a href=\"https://github.com/outdoteth/putty-v2/tree/master/src\">https://github.com/outdoteth/putty-v2/tree/master/src</a></p>\n<p>Review commit: 6df33b2f20e8ddc1bf3dadde4feb834333b2c218</p>\n<h2 id=\"intro\" style=\"position:relative;\"><a href=\"#intro\" aria-label=\"intro permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intro</h2>\n<p>The following is a review of mitigations originated from Code4rena (C4) audit contest that took place between June 29 and July 4, 2022.</p>\n<h2 id=\"disclaimer\" style=\"position:relative;\"><a href=\"#disclaimer\" aria-label=\"disclaimer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclaimer</h2>\n<p>This mitigation review does not guarantee the absence of any further vulnerabilities, being, however, the result of exercising reviewer’s best efforts. Also, it focuses on the resolved issues and the resulting code base, leaving out of scope all the acknowledged issues from the original report.</p>\n<h2 id=\"mitigation-overview\" style=\"position:relative;\"><a href=\"#mitigation-overview\" aria-label=\"mitigation overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Overview</h2>\n<p>The following is a high-level overview of the core changes introduced as the mitigation <a href=\"https://github.com/outdoteth/putty-v2/pulls?q=is%3Apr+is%3Aclosed\"><code>PR#1-10</code></a>, arranged per original report findings.</p>\n<ul>\n<li>[H-01] Fixed by changing the fee base to be <code>order.premium</code> <a href=\"https://github.com/outdoteth/putty-v2/pull/4\"><code>PR#4</code></a>, which is now paid uniformly for all option types on order filling. Utilizing <code>order.strike</code> as the fee base was the root cause for [M-04], [M-06], [M-11], [M-15], so the change to <code>order.premium</code> was a shared mitigation for all of them.</li>\n<li>[H-02] Fixed by requiring that order can’t be in the filled state on cancel. This fully adheres to the original logic, but wasn’t controlled for before.</li>\n<li>[H-03] Fixed by prohibiting non-empty <code>order.floorTokens</code> for short calls.\nOther option types do need <code>floorTokens</code>: long calls’ taker provides floor tokens on filling, while long put owner brings in the floor tokens on exercise, taking the strike. Short put owner can thereafter retrieve the tokens on withdraw.</li>\n<li>[H-04] Fixed by conditioning call’s logic on <code>order.strike > 0</code>. There is no use case for zero strike puts and so this case remains unconditioned, i.e. still always require successful <code>order.strike</code> transfer.</li>\n<li>[M-01, M-02] Acknowledged, now addressed on UI/DB level.</li>\n<li>[M-03] Fixed zero amount part by introducing the noop for zero amount transfers in both <code>_transferERC20sIn</code> and <code>_transferERC20sOut</code> ERC20 transfer functions. The second part of the issue, fake tokens, is similar to [M-01], [M-02].</li>\n<li>[M-04] The same fix as in [H-01].</li>\n<li>[M-05] Fixed with native funds amount control added to strike transfer logic of <code>fillOrder</code>. Zero strike and zero premium corner cases are yet unhandled as described below in <a href=\"#mm-01-weth-zero-strike-call-fillorders-msgvalue-will-be-lost\">M.M-01</a> and <a href=\"#mm-02-zero-premium-short-fillorders-msgvalue-will-be-lost\">M.M-02</a>.</li>\n<li>[M-06] The same fix as in [H-01]: as the platform fee is now transferred on order filling, any owner griefing can only yield a denial of service. There will be no loss of funds as this way position is only about to be created when the fee is transferred.</li>\n<li>[M-07] Acknowledged, similar to [M-01], [M-02].</li>\n<li>[M-08] Acknowledged, requires asset whitelisting, now addressed on UI/DB level.</li>\n<li>[M-09] Acknowledged.</li>\n<li>[M-10] Acknowledged.</li>\n<li>[M-11] The same fix as in [H-01].</li>\n<li>[M-12] Fixed along with [H-01] in <a href=\"https://github.com/outdoteth/putty-v2/pull/4\"><code>PR#4</code></a>.</li>\n<li>[M-13] Fixed by requiring the minimal order duration of 15 minutes on filling.</li>\n<li>[M-14] Fixed by the introduction of <code>setMinimumValidNonce</code> function and the corresponding control on order filling. See <a href=\"#mm-04-minimumvalidnonce-can-be-reduced-due-to-an-operational-mistake-enabling-old-orders\">M.M-04</a> below.</li>\n<li>[M-15] The same fix as in [H-01].</li>\n<li>[M-16] Fixed by bumping the solidity version.</li>\n</ul>\n<h2 id=\"findings\" style=\"position:relative;\"><a href=\"#findings\" aria-label=\"findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h2>\n<p>Findings are referenced as <code>M.S-N</code>, <code>Mitigation.Severity-Number</code>.</p>\n<p>Source means the source of the latest relevant change, not necessary the issue itself, as some of them existed in the snapshot used in the original audit.</p>\n<h3 id=\"mm-01-weth-zero-strike-call-fillorders-msgvalue-will-be-lost\" style=\"position:relative;\"><a href=\"#mm-01-weth-zero-strike-call-fillorders-msgvalue-will-be-lost\" aria-label=\"mm 01 weth zero strike call fillorders msgvalue will be lost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"#mm-01-weth-zero-strike-call-fillorders-msgvalue-will-be-lost\">M.M-01</a> WETH zero strike call fillOrder’s msg.value will be lost</h3>\n<p>If there is any <code>msg.value</code> mistakenly attached to fillOrder() for a WETH based zero strike call, it will be lost for a caller. The same happens in exercise().</p>\n<p>That’s asset freezing due to user’s mistake impact in both cases.</p>\n<h4 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Namely, when <code>order.baseAsset == address(weth)</code>, <code>order.isCall</code> and <code>order.strike == 0</code>, the native funds attached to the fillOrder() call aren’t controlled and can be lost:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L504-L505\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L504-L505</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check native eth is only used if baseAsset is weth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Cannot use native ETH&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L527-L553\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L527-L553</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// -- exercising a call option</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer strike from exerciser to putty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// handle the case where the taker uses native ETH instead of WETH to pay the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// check enough ETH was sent to cover the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// convert ETH to WETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// we convert the strike ETH to WETH so that the logic in withdraw() works</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// - because withdraw() assumes an ERC20 interface on the base asset.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer assets from putty to exerciser</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC20sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC721sOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferFloorsOut</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">floorTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">positionFloorAssetTokenIds</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">orderHash</span><span class=\"mtk1\">)]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// -- exercising a put option</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// exercising a put never needs native ETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Puts can&#39;t use native ETH&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The same approach is used in exercise(), and the same WETH zero strike call’s <code>msg.value</code> isn’t controlled and can be lost:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L504-L505\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L504-L505</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check native eth is only used if baseAsset is weth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Cannot use native ETH&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L527-L544\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L527-L544</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// -- exercising a call option</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer strike from exerciser to putty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// handle the case where the taker uses native ETH instead of WETH to pay the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// check enough ETH was sent to cover the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// convert ETH to WETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// we convert the strike ETH to WETH so that the logic in withdraw() works</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// - because withdraw() assumes an ERC20 interface on the base asset.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>Such ETH funds will be permanently frozen on the contract balance as there is no mechanics to retrieve them.</p>\n<h4 id=\"source\" style=\"position:relative;\"><a href=\"#source\" aria-label=\"source permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Source</h4>\n<p><a href=\"https://github.com/outdoteth/putty-v2/pull/3\"><code>PR#3</code></a></p>\n<h4 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider checking that nothing is attached to the zero strike call:</p>\n<p>fillOrder()</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L530-L544\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L530-L544</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer strike from exerciser to putty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// handle the case where the taker uses native ETH instead of WETH to pay the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// check enough ETH was sent to cover the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// convert ETH to WETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// we convert the strike ETH to WETH so that the logic in withdraw() works</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// - because withdraw() assumes an ERC20 interface on the base asset.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+               </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;0 strike calls can&#39;t use ETH&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           }</span></span></span></code></pre>\n<p>exercise()</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L530-L544\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L530-L544</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// transfer strike from exerciser to putty</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// handle the case where the taker uses native ETH instead of WETH to pay the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// check enough ETH was sent to cover the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// convert ETH to WETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// we convert the strike ETH to WETH so that the logic in withdraw() works</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// - because withdraw() assumes an ERC20 interface on the base asset.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+               </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;0 strike calls can&#39;t use ETH&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           }</span></span></span></code></pre>\n<h3 id=\"mm-02-zero-premium-short-fillorders-msgvalue-will-be-lost\" style=\"position:relative;\"><a href=\"#mm-02-zero-premium-short-fillorders-msgvalue-will-be-lost\" aria-label=\"mm 02 zero premium short fillorders msgvalue will be lost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"#mm-02-zero-premium-short-fillorders-msgvalue-will-be-lost\">M.M-02</a> Zero premium short fillOrder’s msg.value will be lost</h3>\n<p>If there is any native funds mistakenly attached to fillOrder() for a zero premium short option, <code>msg.value</code> will be lost for a caller. As an example, zero premiums can correspond to the case when option is settled off-chain and access is managed with <code>order.whitelist</code>.</p>\n<p>The impact is asset freezing due to user’s mistake. The freeze is permanent as there is no mechanics to retrieve native funds from the contract.</p>\n<h4 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Similarly, when <code>!order.isLong</code> and <code>order.premium == 0</code>, the native funds attached to the fillOrder() call aren’t controlled and can be lost as the checks reside in the <code>if (order.premium > 0) {</code> block:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L408-L442\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L408-L442</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer premium to whoever is short from whomever is long</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// transfer premium to taker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// collect fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// handle the case where the user uses native ETH instead of WETH to pay the premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// check enough ETH was sent to cover the premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// convert ETH to WETH and send premium to maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// converting to WETH instead of forwarding native ETH to the maker has two benefits;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// 1) active market makers will mostly be using WETH not native ETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// 2) attack surface for re-entrancy is reduced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// collect fees and transfer to premium to maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// transfer premium to maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// collect fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>After that short option cases only transfer the assets (<code>!order.isLong &#x26;&#x26; !order.isCall</code> and <code>!order.isLong &#x26;&#x26; order.isCall</code>):</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L444-L464\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L444-L464</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// filling short put: transfer strike from maker to contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// filling long put: transfer strike from taker to contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// handle the case where the taker uses native ETH instead of WETH to deposit the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// check enough ETH was sent to cover the strike</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// convert ETH to WETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// we convert the strike ETH to WETH so that the logic in exercise() works</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// - because exercise() assumes an ERC20 interface on the base asset.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">strike</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isCall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// filling short call: transfer assets from maker to contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC20sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc20Assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_transferERC721sIn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">erc721Assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>It’s enough to add the similar check for <code>!order.isLong</code> case when main logic is avoided:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L408-L442\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L408-L442</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// transfer premium to whoever is short from whomever is long</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// transfer premium to taker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// collect fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk3\">// handle the case where the user uses native ETH instead of WETH to pay the premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// check enough ETH was sent to cover the premium</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Incorrect ETH amount sent&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// convert ETH to WETH and send premium to maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// converting to WETH instead of forwarding native ETH to the maker has two benefits;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// 1) active market makers will mostly be using WETH not native ETH</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// 2) attack surface for re-entrancy is reduced</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\">}();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// collect fees and transfer to premium to maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">weth</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// transfer premium to maker</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">maker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk3\">// collect fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-       }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+           </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">isLong</span><span class=\"mtk1\">) </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;0 premium shorts can&#39;t use ETH&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       }</span></span></span></code></pre>\n<h3 id=\"mm-03-unsafe-transfer-of-an-arbitrary-token-is-used-by-withdrawfees-for-the-cumulative-fee-retrieval\" style=\"position:relative;\"><a href=\"#mm-03-unsafe-transfer-of-an-arbitrary-token-is-used-by-withdrawfees-for-the-cumulative-fee-retrieval\" aria-label=\"mm 03 unsafe transfer of an arbitrary token is used by withdrawfees for the cumulative fee retrieval permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"#mm-03-unsafe-transfer-of-an-arbitrary-token-is-used-by-withdrawfees-for-the-cumulative-fee-retrieval\">M.M-03</a> Unsafe transfer of an arbitrary token is used by withdrawFees() for the cumulative fee retrieval</h3>\n<p>withdrawFees() will not revert on the transfer call failure and will be inaccessible for tokens not fully compliant with Solmate’s ERC20 (say, USDT).</p>\n<p>One issue is that when a token do not revert, but instead returns false, this will go unnoticed. As <code>unclaimedFees</code> will be reset to <code>0</code> without actual transfer, this means that the cumulative <code>asset</code> denominated fee that PuttyV2 instance had at that moment will become frozen within the contract.</p>\n<p>Another is that ERC20 compliance is expected by using <code>ERC20(asset).transfer</code>, while it is not always the case and such <code>assets</code> will not be retrievable by withdrawFees() as the call will fail due to function signature mismatch. The corresponding cumulative fee will also be frozen on the balance.</p>\n<h4 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>withdrawFees() uses plain <code>transfer</code> call while the <code>asset</code>, being <code>order.baseAsset</code>, can be arbitrary:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">unclaimedFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// reset the fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unclaimedFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WithdrewFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// send the fees to the recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/Rari-Capital/solmate/blob/25015a1d18e75921f8cb1bacd4beb9f364e788a9/src/tokens/ERC20.sol#L76\">https://github.com/Rari-Capital/solmate/blob/25015a1d18e75921f8cb1bacd4beb9f364e788a9/src/tokens/ERC20.sol#L76</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<h4 id=\"source-1\" style=\"position:relative;\"><a href=\"#source-1\" aria-label=\"source 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Source</h4>\n<p><a href=\"https://github.com/outdoteth/putty-v2/pull/4\"><code>PR#4</code></a></p>\n<h4 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider using Solmate’s safeTransfer that performs lower level call with result check:</p>\n<p><a href=\"https://github.com/Rari-Capital/solmate/blob/ca96d493e0b061cccccf02b2fd9f5c6fe08826df/src/utils/SafeTransferLib.sol#L63-L92\">https://github.com/Rari-Capital/solmate/blob/ca96d493e0b061cccccf02b2fd9f5c6fe08826df/src/utils/SafeTransferLib.sol#L63-L92</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span></code></pre>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">unclaimedFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// reset the fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unclaimedFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WithdrewFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// send the fees to the recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-       </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"mm-04-minimumvalidnonce-can-be-reduced-due-to-an-operational-mistake-enabling-old-orders\" style=\"position:relative;\"><a href=\"#mm-04-minimumvalidnonce-can-be-reduced-due-to-an-operational-mistake-enabling-old-orders\" aria-label=\"mm 04 minimumvalidnonce can be reduced due to an operational mistake enabling old orders permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"#mm-04-minimumvalidnonce-can-be-reduced-due-to-an-operational-mistake-enabling-old-orders\">M.M-04</a> minimumValidNonce can be reduced due to an operational mistake, enabling old orders</h3>\n<p><code>setMinimumValidNonce()</code>, introduced as the mitigation for <code>M-14</code>, allows user to both decrease and increase personal nonce. The regular operation here is nonce increase, which invalidates outdated orders.</p>\n<p>Nonce decrease operation, on the other hand, has no regular use case and is a subject to an operational mistakes that can easily lead to loss of funds as outdated orders were set to inactive state by nonce increased most likely in result of becoming non-market and so enabling them will allow an attacker, who can track the setMinimumValidNonce() calls, to immediately fill such orders in the case they indeed are now off the market and were enabled by mistake.</p>\n<p>Maker’s allowances for the assets in question can remain open as other similar, but currently marked to market, same maker’s orders can be live on Putty or elsewhere.</p>\n<p>This way, an ability to decrease the nonce provides a surface for user mistakes with highly probable loss of funds: most of orders are invalidated as out of the market, while some allowances can realistically remain, which gives medium overall probability of a loss given erroneous nonce decrease by a user. As user has to track the nonces and so such a decrease is conditional only on user failing to do so, which isn’t a negligible event.</p>\n<p>Impact this way is loss of funds conditional on user operational mistake with both events having medium probability.</p>\n<h4 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>setMinimumValidNonce()</code> allows setting any nonce, including one that’s significantly lower than current:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L700-L709\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L700-L709</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Sets the minimum valid nonce for a user. Any unfilled orders with a nonce </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">                smaller than this minimum will no longer be valid and will unable to be filled.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_minimumValidNonce</span><span class=\"mtk3\"> The new minimum valid nonce.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setMinimumValidNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minimumValidNonce</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">minimumValidNonce</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_minimumValidNonce</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SetMinimumValidNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_minimumValidNonce</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h4 id=\"source-2\" style=\"position:relative;\"><a href=\"#source-2\" aria-label=\"source 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Source</h4>\n<p><a href=\"https://github.com/outdoteth/putty-v2/pull/10\"><code>PR#10</code></a></p>\n<h4 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider requiring new nonce to be strictly higher than the old one or, more preferrably, restrict the function to exactly one step increase:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L700-L709\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L700-L709</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-       </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Sets the minimum valid nonce for a user. Any unfilled orders with a nonce </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">+       </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Increments the minimum valid nonce for a user. Any unfilled orders with a nonce </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">                smaller than this minimum will no longer be valid and will unable to be filled.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">-       </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_minimumValidNonce</span><span class=\"mtk3\"> The new minimum valid nonce.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setMinimumValidNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minimumValidNonce</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">incrementMinimumValidNonce</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-       </span><span class=\"mtk12\">minimumValidNonce</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_minimumValidNonce</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SetMinimumValidNonce</span><span class=\"mtk1\">(++</span><span class=\"mtk12\">minimumValidNonce</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"ml-01-fee-limit-remain-the-same-after-fee-mechanics-base-has-changed\" style=\"position:relative;\"><a href=\"#ml-01-fee-limit-remain-the-same-after-fee-mechanics-base-has-changed\" aria-label=\"ml 01 fee limit remain the same after fee mechanics base has changed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"#ml-01-fee-limit-remain-the-same-after-fee-mechanics-base-has-changed\">M.L-01</a> Fee limit remain the same after fee mechanics base has changed</h3>\n<p>The 3% limit stayed the same after fee mechanics change. 3% of a premium and 3% of a strike can be vastly different as average strike is about 1-2 magnitudes higher than average premium (i.e. the crude evaluation that most options are priced at 1-10% of their strikes isn’t too incorrect).</p>\n<p>This way, while 3% of the strike was rather high, being more than the whole premium in some cases, 3% of the premium can be too restrictive as a limit. Anyway, lesser fees are good for protocol adoption, so this is just a matter of reevaluation, not necessary change.</p>\n<h4 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>setFee()</code> uses <code>30 / 1000</code> limit as it was in the <code>order.strike</code> based fee mechanics:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L288-L294\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L288-L294</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">30</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;fee must be less than 3%&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Now it’s <code>order.premium</code> based:</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L401-L406\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L401-L406</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate the fee amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">premium</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">unclaimedFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseAsset</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Review the fee limit taking the account changed magnitude of the average base amount </p>\n<h3 id=\"mn-01-unnecessary-payable-functions\" style=\"position:relative;\"><a href=\"#mn-01-unnecessary-payable-functions\" aria-label=\"mn 01 unnecessary payable functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"#mn-01-unnecessary-payable-functions\">M.N-01</a> Unnecessary payable functions</h3>\n<p>Administrative functions have payable modifiers that aren’t used as no fund transfers are involved, while enabling Owner’s operational mistakes surface.</p>\n<p>There is only a small gas cost for checking zero <code>msg.value</code>, while any native funds sent over with such functions will be frozen permanently.</p>\n<h4 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>setBaseURI():</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L276-L280\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L276-L280</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBaseURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_baseURI</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">baseURI</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_baseURI</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewBaseURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_baseURI</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>setFee():</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L288-L294\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L288-L294</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">30</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;fee must be less than 3%&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>withdrawFees():</p>\n<p><a href=\"https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311\">https://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">unclaimedFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// reset the fees</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unclaimedFees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WithdrewFees</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">, </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// send the fees to the recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<p><code>msg.value</code> check costs about 25 gas:</p>\n<p><a href=\"https://coinsbench.com/solidity-payable-vs-regular-functions-a-gas-usage-comparison-b4a387fe860d\">https://coinsbench.com/solidity-payable-vs-regular-functions-a-gas-usage-comparison-b4a387fe860d</a></p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As there operations are rare and gas increase is low consider removing <code>payable</code> modifiers</p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-4\">High Risk Findings (4)</a></p>\n<ul>\n<li><a href=\"#h-01-fee-is-being-deducted-when-put-is-expired-and-not-when-it-is-exercised\">[H-01] Fee is being deducted when Put is expired and not when it is exercised.</a></li>\n<li><a href=\"#h-02-acceptcounteroffer-may-result-in-both-orders-being-filled\">[H-02] <code>acceptCounterOffer()</code> May Result In Both Orders Being Filled</a></li>\n<li><a href=\"#h-03-create-a-short-call-order-with-non-empty-floor-makes-the-option-impossible-to-exercise-and-withdraw\">[H-03] Create a short call order with non empty floor makes the option impossible to exercise and withdraw</a></li>\n<li><a href=\"#h-04-zero-strike-call-options-can-be-systemically-used-to-steal-premium-from-the-taker\">[H-04] Zero strike call options can be systemically used to steal premium from the taker</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-16\">Medium Risk Findings (16)</a></p>\n<ul>\n<li><a href=\"#m-01-malicious-token-contracts-may-lead-to-locking-orders\">[M-01] Malicious Token Contracts May Lead To Locking Orders</a></li>\n<li><a href=\"#m-02-unbounded-loops-may-cause-exercises-and-withdraws-to-fail-\">[M-02] Unbounded loops may cause <code>exercise()</code>s and <code>withdraw()</code>s to fail </a></li>\n<li><a href=\"#m-03-put-option-sellers-can-prevent-exercise-by-specifying-zero-amounts-or-non-existant-tokens\">[M-03] Put option sellers can prevent exercise by specifying zero amounts, or non-existant tokens</a></li>\n<li><a href=\"#m-04-put-options-are-free-of-any-fees\">[M-04] Put options are free of any fees</a></li>\n<li><a href=\"#m-05-fillorder-and-exercise-may-lock-ether-sent-to-the-contract-forever\">[M-05] <code>fillOrder()</code> and <code>exercise()</code> may lock Ether sent to the contract, forever</a></li>\n<li><a href=\"#m-06-denial-of-service-contract-owner-could-block-users-from-withdrawing-their-strike\">[M-06] [Denial-of-Service] Contract Owner Could Block Users From Withdrawing Their Strike</a></li>\n<li><a href=\"#m-07-an-attacker-can-create-a-short-put-option-order-on-an-nft-that-does-not-support-erc721-like-cryptopunk-and-the-user-can-fulfill-the-order-but-cannot-exercise-the-option\">[M-07] An attacker can create a short put option order on an NFT that does not support ERC721 (like cryptopunk), and the user can fulfill the order, but cannot exercise the option</a></li>\n<li><a href=\"#m-08-overlap-between-erc721transferfrom-and-erc20transferfrom-allows-ordererc20assets-or-orderbaseasset-to-be-erc721-rather-than-erc20\">[M-08] Overlap Between <code>ERC721.transferFrom()</code> and <code>ERC20.transferFrom()</code> Allows <code>order.erc20Assets</code> or <code>order.baseAsset</code> To Be ERC721 Rather Than ERC20</a></li>\n<li><a href=\"#m-09-the-contract-serves-as-a-flashloan-pool-without-fee\">[M-09] The contract serves as a flashloan pool without fee</a></li>\n<li><a href=\"#m-10-putty-position-tokens-may-be-minted-to-non-erc721-receivers\">[M-10] Putty position tokens may be minted to non ERC721 receivers</a></li>\n<li><a href=\"#m-11-fee-can-change-without-the-consent-of-users\">[M-11] <code>fee</code> can change without the consent of users</a></li>\n<li><a href=\"#m-12-options-with-a-small-strike-price-will-round-down-to-0-and-can-prevent-assets-to-be-withdrawn\">[M-12] Options with a small strike price will round down to 0 and can prevent assets to be withdrawn</a></li>\n<li><a href=\"#m-13-order-duration-can-be-set-to-0-by-malicious-maker\">[M-13] Order duration can be set to 0 by Malicious maker</a></li>\n<li><a href=\"#m-14-order-cancellation-is-prone-to-frontrunning-and-is-dependent-on-a-centralized-database\">[M-14] Order cancellation is prone to frontrunning and is dependent on a centralized database</a></li>\n<li><a href=\"#m-15-zero-strike-call-options-will-avoid-paying-system-fee\">[M-15] Zero strike call options will avoid paying system fee</a></li>\n<li><a href=\"#m-16-use-of-solidity-version-0813-which-has-two-known-issues-applicable-to-puttyv2\">[M-16] Use of Solidity version 0.8.13 which has two known issues applicable to PuttyV2</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#codebase-summary--key-improvement-opportunities\">Codebase Summary &#x26; Key Improvement Opportunities</a></li>\n<li><a href=\"#summary-of-findings\">Summary Of Findings</a></li>\n<li><a href=\"#l-01-lack-of-reentrancy-guards-on-external-functions\">L-01 Lack Of Reentrancy Guards On External Functions</a></li>\n<li><a href=\"#l-02-discontinuity-in-exercise-period\">L-02 Discontinuity in Exercise Period</a></li>\n<li><a href=\"#l-03-insufficient-input-validation\">L-03 Insufficient Input Validation</a></li>\n<li><a href=\"#l-04-order-cannot-be-filled-due-to-unbounded-whitelist-within-an-order\">L-04 Order Cannot Be Filled Due To Unbounded Whitelist Within An Order</a></li>\n<li><a href=\"#l-05-order-cannot-be-filled-due-to-unbounded-floortokens-erc20asset-or-erc721asset-within-an-order\">L-05 Order Cannot Be Filled Due To Unbounded floorTokens, ERC20Asset Or ERC721Asset Within An Order</a></li>\n<li><a href=\"#l-06-order-can-be-cancelled-even-after-being-filled\">L-06 Order Can Be Cancelled Even After Being Filled</a></li>\n<li><a href=\"#l-07-no-check-if-onerc721received-is-implemented\">L-07 No Check if onERC721Received Is Implemented</a></li>\n<li><a href=\"#n-01-omissions-in-events\">N-01 Omissions in events</a></li>\n<li><a href=\"#n-02-draft-openzeppelin-dependencies\">N-02 Draft OpenZeppelin Dependencies</a></li>\n<li><a href=\"#n-03-insufficient-tests\">N-03 Insufficient Tests</a></li>\n<li><a href=\"#n-04-owner-can-renounce-ownership\">N-04 Owner Can Renounce Ownership</a></li>\n<li><a href=\"#n-05-consider-two-phase-ownership-transfer\">N-05 Consider two-phase ownership transfer</a></li>\n<li><a href=\"#n-06-code-can-be-refactored-to-be-more-readable\">N-06 Code Can Be Refactored To Be More Readable</a></li>\n<li><a href=\"#n-07-inconsistent-use-of-named-return-variables\">N-07 Inconsistent use of named return variables</a></li>\n<li><a href=\"#n-08-unused-imports\">N-08 Unused imports</a></li>\n<li><a href=\"#n-09-incorrect-functions-visibility\">N-09 Incorrect functions visibility</a></li>\n<li><a href=\"#n-10-natspec-is-missing\">N-10 NatSpec Is Missing</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#executive-summary\">Executive Summary</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#mitigation-review\">Mitigation Review</a></p>\n<ul>\n<li><a href=\"#intro\">Intro</a></li>\n<li><a href=\"#disclaimer\">Disclaimer</a></li>\n<li><a href=\"#mitigation-overview\">Mitigation Overview</a></li>\n<li><a href=\"#findings\">Findings</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Putty smart contract system written in Solidity. The audit contest took place between June 29—July 4, 2022.\n\nFollowing the C4 audit contest, warden hyh reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit contest report. \n\n## Wardens\n\n144 Wardens contributed reports to the Putty contest:\n\n  1. [hansfriese](https://twitter.com/hansfriese)\n  1. [hyh](https://twitter.com/0xhyh)\n  1. [minhquanym](https://www.linkedin.com/in/minhquanym/)\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. [berndartmueller](https://twitter.com/berndartmueller)\n  1. xiaoming90\n  1. zzzitron\n  1. IllIllI\n  1. unforgiven\n  1. horsefacts\n  1. [kirk-baird](https://twitter.com/kirkthebaird)\n  1. Lambda\n  1. [shung](https://twitter.com/shunduquar)\n  1. hubble (ksk2345 and shri4net)\n  1. Metatron\n  1. [0xsanson](https://github.com/0xsanson)\n  1. reassor\n  1. [Kenshin](https://twitter.com/nonfungiblenero)\n  1. [sseefried](http://seanseefried.org/blog)\n  1. 0xNineDec\n  1. cccz\n  1. [danb](https://twitter.com/danbinnun)\n  1. PwnedNoMore ([izhuer](https://www.cs.purdue.edu/homes/zhan3299/index.html), ItsNio and papr1ka2)\n  1. auditor0517\n  1. 0x52\n  1. [zishansami](https://zishansami102.github.io/)\n  1. sashik_eth\n  1. [pedroais](https://twitter.com/Pedroais2/)\n  1. [exd0tpy](https://github.com/exd0tpy)\n  1. 0xc0ffEE\n  1. [Treasure-Seeker](https://twitter.com/treasuresETH)\n  1. [Alex the Entreprenerd](https://twitter.com/gallodasballo)\n  1. [shenwilly](https://twitter.com/shenwilly_)\n  1. [swit](https://twitter.com/nomorebear)\n  1. BowTiedWardens (BowTiedHeron, BowTiedPickle, [m4rio_eth](BowTiedETHernal), [Dravee](https://twitter.com/JustDravee), and BowTiedFirefox)\n  1. TrungOre\n  1. 0xA5DF\n  1. [Picodes](https://twitter.com/thePicodes)\n  1. [joestakey](https://twitter.com/JoeStakey)\n  1. 0x1f8b\n  1. ACai\n  1. [ignacio](https://twitter.com/0xheynacho)\n  1. [defsec](https://twitter.com/defsec_)\n  1. [catchup](https://twitter.com/catchup22)\n  1. Critical\n  1. codexploder\n  1. [zer0dot](https://twitter.com/zer0dots)\n  1. dirk_y\n  1. [antonttc](https://github.com/antoncoding)\n  1. [itsmeSTYJ](https://twitter.com/itsmeSTYJ)\n  1. 0xDjango\n  1. 0xf15ers (remora and twojoy)\n  1. Bnke0x0\n  1. [Chom](https://chom.dev)\n  1. [StErMi](https://ericci.dev/)\n  1. ElKu\n  1. [0xNazgul](https://twitter.com/0xNazgul)\n  1. simon135\n  1. oyc_109\n  1. &#95;&#95;141345&#95;&#95;\n  1. [MiloTruck](https://milotruck.github.io/)\n  1. [TomJ](https://mobile.twitter.com/tomj_bb)\n  1. JohnSmith\n  1. [gogo](https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219)\n  1. [Funen](https://instagram.com/vanensurya)\n  1. _Adam\n  1. cryptphi\n  1. [rokinot](twitter.com/rokinot)\n  1. [JC](https://twitter.com/sm4rtcontr4ct)\n  1. Kaiziron\n  1. hake\n  1. robee\n  1. Limbooo\n  1. Waze\n  1. ReyAdmirado\n  1. [MadWookie](https://twitter.com/wookiemad)\n  1. [fatherOfBlocks](https://twitter.com/father0fBl0cks)\n  1. [durianSausage](https://github.com/lyciumlee)\n  1. datapunk\n  1. delfin454000\n  1. [rajatbeladiya](https://twitter.com/rajat_beladiya)\n  1. Hawkeye (0xwags and 0xmint)\n  1. Yiko\n  1. [Sm4rty](https://twitter.com/Sm4rty_)\n  1. [AmitN](https://www.amitnave.com/)\n  1. 0x29A (0x4non and rotcivegaf)\n  1. peritoflores\n  1. samruna\n  1. async\n  1. GimelSec ([rayn](https://twitter.com/rayn731) and sces60107)\n  1. [Nethermind](https://nethermind.io/)\n  1. [saneryee](https://medium.com/@saneryee-studio)\n  1. [doddle0x](https://twitter.com/doddle0x)\n  1. [0xSolus](https://twitter.com/0xSolus)\n  1. aysha\n  1. [David_](https://twitter.com/davidpius10)\n  1. Sneakyninja0129\n  1. TerrierLover\n  1. chatch\n  1. 0xkatana\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. grrwahrr\n  1. [0xKitsune](https://github.com/0xKitsune)\n  1. RedOneN\n  1. UnusualTurtle\n  1. [Aymen0909](https://github.com/Aymen1001)\n  1. saian\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. [c3phas](https://twitter.com/c3ph_)\n  1. jayfromthe13th\n  1. [z3s](https://github.com/z3s/)\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n  1. ajtra\n  1. ak1\n  1. [Fitraldys](https://twitter.com/fitraldys)\n  1. [m_Rassska](https://t.me/Road220)\n  1. [mektigboy](https://twitter.com/mektigboy)\n  1. [mrpathfindr](https://veranos.io)\n  1. [natzuu](https://twitter.com/natzuu33)\n  1. [Randyyy](https://twitter.com/randyyramadhan)\n  1. slywaters\n  1. sach1r0\n  1. cRat1st0s\n  1. ladboy233\n  1. zeesaw\n  1. 0xHarry\n  1. apostle0x01\n  1. asutorufos\n  1. codetilda\n  1. [Haruxe](twitter.com/haruxeETH)\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. StyxRave\n  1. dipp\n\nThis contest was judged by [hickuphh3](https://github.com/HickupHH3).\n\nMitigations reviewed by [hyh](https://twitter.com/0xhyh).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 20 unique vulnerabilities. Of these vulnerabilities, 4 received a risk rating in the category of HIGH severity and 16 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 82 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 94 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Putty contest repository](https://github.com/code-423n4/2022-06-putty), and is composed of 2 smart contracts written in the Solidity programming language and includes 357 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (4)\n## [[H-01] Fee is being deducted when Put is expired and not when it is exercised.](https://github.com/code-423n4/2022-06-putty-findings/issues/269)\n_Submitted by zishansami, also found by 0x52, 0xsanson, auditor0517, berndartmueller, csanuragjain, and zzzitron_\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495-L503>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451>\n\n### Impact\n\nFee is being deducted when Put is expired and not when it is exercised in `PuttyV2.sol`.\nComment section of the `setFee()` function mentions `\"fee rate that is applied on exercise\"` which signifies that the fee amount is meant to be deducted from strike only when a position is being exercised (or has been exercised).\n\nBut, in function `withdraw()` at [PuttyV2.solL#495-L503](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495-L503)  the fee is being deducted even when the Put position is not exercised and has expired.\n\nAlso, in function `exercise()` there is no fee deduction from the `order.strike` when the Put position is exercised and the strike is being transferred to the caller ([PuttyV2.solL#451](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451)).\n\nThis unintended deduction from assets of Put Shorter and the absence of fee deduction from strike when Put is exercised are directly impacting the assets and therefore marked as Medium Risk.\n\n### Proof of Concept\n\n`if` condition present at [PuttyV2.solL#495](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495) passes if `order.isCall` is `false` and `isExercised` is false.\n\n`feeAmount` becomes positive if `fee > 0` and it gets deducted from the `order.strike` which gets transferred to `msg.sender` at line number [PuttyV2.solL#503](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L503).\n\n### Recommended Mitigation Steps\n\n1.  Update `if` condition at [PuttyV2.sol#L498](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L498) with `(fee > 0 && order.isCall && isExercised)`\n\n2.  Add feeAmount calculation and deduction after put is exercised and strike is transferred at [PuttyV2.sol#L451](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451) as follows:\n\n```solidity\nuint256 feeAmount = 0;\nif (fee > 0) {\n    feeAmount = (order.strike * fee) / 1000;\n    ERC20(order.baseAsset).safeTransfer(owner(), feeAmount);\n}\nERC20(order.baseAsset).safeTransfer(msg.sender, order.strike - feeAmount);\n```\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/269#issuecomment-1178999683):**\n > Report: Fees are only applied on puts if they are expired.\n\n**[HickupHH3 (judge) increased severity to High and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/269#issuecomment-1179899567):**\n > Due to incorrect logic, there are 2 consequences of separate severities:\n> \n> 1) Expired put option being charged the admin fee. As @berndartmueller mentioned in [#380](https://github.com/code-423n4/2022-06-putty-findings/issues/380), the fee should be charged on the premium (actually this is another issue, see [#373](https://github.com/code-423n4/2022-06-putty-findings/issues/373)). Since it is possible for the fee amount to be greater than expected, I consider this to be a loss of assets and therefore given a high severity rating.\n> \n> 2) Put option not being charged fee upon exercising it. This can be considered to the \"protocol leaked value\" and thus be given a medium severity rating.\n> \n> Issues that mention (1) or both (1) and (2) will be given a high severity rating, those that mention only (2) will be given a medium.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/269#issuecomment-1185405136):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/4.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed by changing the fee base to be `order.premium` [`PR#4`](https://github.com/outdoteth/putty-v2/pull/4), which is now paid uniformly for all option types on order filling. Utilizing `order.strike` as the fee base was the root cause for [M-04](https://github.com/code-423n4/2022-06-putty-findings/issues/285), [M-06](https://github.com/code-423n4/2022-06-putty-findings/issues/296), [M-11](https://github.com/code-423n4/2022-06-putty-findings/issues/422), [M-15](https://github.com/code-423n4/2022-06-putty-findings/issues/373), so the change to `order.premium` was a shared mitigation for all of them.\n\n\n***\n\n## [[H-02] `acceptCounterOffer()` May Result In Both Orders Being Filled](https://github.com/code-423n4/2022-06-putty-findings/issues/44)\n_Submitted by kirk-baird, also found by csanuragjain, hansfriese, Lambda, and minhquanym_\n\nWhen a user is attempting to accept a counter offer they call the function [acceptCounterOffer()](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L573-L584) with both the `originalOrder` to be cancelled and the new `order` to fill. It is possible for an attacker (or any other user who happens to call `fillOrder()` at the same time) to fill the `originalOrder` before `acceptCounterOffer()` cancels it.\n\nThe impact is that both `originalOrder` and `order` are filled. The `msg.sender` of `acceptCounterOffer()` is twice as leveraged as they intended to be if the required token transfers succeed.\n\n### Proof of Concept\n\n[acceptCounterOffer()](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L573-L584) calls `cancel()` on the original order, however it will not revert if the order has already been filled.\n\n```solidity\n    function acceptCounterOffer(\n        Order memory order,\n        bytes calldata signature,\n        Order memory originalOrder\n    ) public payable returns (uint256 positionId) {\n        // cancel the original order\n        cancel(originalOrder);\n\n\n        // accept the counter offer\n        uint256[] memory floorAssetTokenIds = new uint256[](0);\n        positionId = fillOrder(order, signature, floorAssetTokenIds);\n    }\n```\n\n[cancel()](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L526-L535) does not revert if an order has already been filled it only prevents future `fillOrder()` transactions from succeeding.\n\n```solidity\n    function cancel(Order memory order) public {\n        require(msg.sender == order.maker, \"Not your order\");\n\n\n        bytes32 orderHash = hashOrder(order);\n\n\n        // mark the order as cancelled\n        cancelledOrders[orderHash] = true;\n\n\n        emit CancelledOrder(orderHash, order);\n    }\n```\n\nTherefore any user may front-run the `acceptCounterOffer()` transaction with a `fillOrder()` transaction that fills the original order. As a result the user ends up filling both `order` and `originalOrder`. Then `acceptCounterOffer()` cancels the `originalOrder` which is essentially a no-op since it's been filled and continues to fill the new `order` resulting in both orders being filled.\n\n### Recommended Mitigation Steps\n\nConsider having `cancel()` revert if an order has already been filled. This can be done by adding the following line `require(_ownerOf[uint256(orderHash)] == 0)`.\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/44#issuecomment-1179004913):**\n > Report: It’s possible to fill an order twice by accepting a counter offer for an already filled order.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/44#issuecomment-1185411950):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/2.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed by requiring that order can't be in the filled state on cancel. This fully adheres to the original logic, but wasn't controlled for before.\n\n\n***\n\n## [[H-03] Create a short call order with non empty floor makes the option impossible to exercise and withdraw](https://github.com/code-423n4/2022-06-putty-findings/issues/369)\n_Submitted by zzzitron, also found by danb, Kenshin, Metatron, minhquanym, and PwnedNoMore_\n\n**HIGH** - assets can be lost\n\nIf a short call order is created with non empty floorTokens array, the taker cannot exercise. Also, the maker cannot withdraw after the expiration. The maker will still get premium when the order is filled. If the non empty floorTokens array was included as an accident, it is a loss for both parties: the taker loses premium without possible exercise, the maker loses the locked ERC20s and ERC721s.\n\nThis bug is not suitable for exploitation to get a 'free' premium by creating not exercisable options, because the maker will lose the ERC20s and ERC721s without getting any strike. In that sense it is similar but different issue to the `Create a short put order with zero tokenAmount makes the option impossible to exercise`, therefore reported separately.\n\n### Proof of Concept\n\n*   [proof of concept](https://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L153-L202)\n*   [reference case](https://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L194-L21://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L204-L226)\n\nThe proof of concept shows a scenario where babe makes an short call order with non empty `floorTokens` array. Bob filled the order, and now he has long call option NFT. He wants to exercise his option and calls `exercise`. There are two cases.\n\n*   case 1: he calls exercise with empty `floorAssetTokenIds` array\n*   case 2: he calls exercise with non-empty `floorAssetTokenIds` array with matching length to the `orders.floorTokens`\n\nIn the case1, [the input `floorAssetTokenIds` were checked to be empty for put orders](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L406), and his call passes this requirement. But eventually `_transferFloorsIn` was called and he gets `Index out of bounds` error, because `floorTokens` is not empty [which does not match with empty `floorAssetTokenIds`](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627-L629).\n\n```solidity\n// case 1\n  // PuttyV2.sol: _transferFloorsIn called by exercise\n  // The floorTokens and floorTokenIds do not match the lenghts\n  // floorTokens.length is not zero, while floorTokenIds.length is zero\n\n       ERC721(floorTokens[i]).safeTransferFrom(from, address(this), floorTokenIds[i]);\n```\n\nIn the case2, [the input `floorAssetTokenIds` were checked to be empty for put orders](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L406), but it is not empty. So it reverts.\n\n    // case2\n    // PuttyV2.sol: exercise\n    // non empty floorAssetTokenIds array is passed for put option, it will revert\n\n            !order.isCall\n                ? require(floorAssetTokenIds.length == order.floorTokens.length, \"Wrong amount of floor tokenIds\")\n                : require(floorAssetTokenIds.length == 0, \"Invalid floor tokenIds length\");\n\nAfter the option is expired, the maker - babe is trying to withdraw but fails due to the [same issue with the case1](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L516).\n\n```solidity\n// maker trying to withdraw\n// PuttyV2.sol: withdraw\n\n  _transferFloorsOut(order.floorTokens, positionFloorAssetTokenIds[floorPositionId]);\n```\n\nNote on the PoC:\n\n*   The [test for case1 is commented out](https://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L182-L183) because foundry could not catch the revert. But by running the test with un-commenting these lines will show that the call reverts with `Index out of bounds`.\n*   For the same reason the [withdraw](https://gist.github.com/zzzitron/9f83516255fa6153a4deb04f2163a0b3#file-2022-07-puttyv2-t-sol-L199-L200) also is commented out\n*   The reference case just shows that it works as intended when the order does not contain non-empty `floorTokens`.\n\n### Tools Used\n\nFoundry.\n\n### Recommended Mitigation Steps\n\nIt happens because the [`fillOrder` does not ensure](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L296-L298) the `order.floorTokens` to be empty when the order is short call.\n\n**[STYJ (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1174764713):**\n > Note that it is possible to cause loss of funds for others through this.\n> \n> Assume that maker (A) creates a long call and taker (B) fills it, transferring floor tokens (XYZ) into putty. \n> \n> If maker (C) creates a short call with floorTokens (XYZ), taker (D) is able to fill and exercise his long call since XYZ already resides on Putty. This will however invalidate the options pair that was created between A and B since A cannot exercise and B cannot withdraw.\n\n**[outdoteth (Putty Finance) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1178995529):**\n > Agree that this should be marked as high severity given the exploit scenario provided by @STYJ above.\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1178995764):**\n > Report: Short call with floorTokens will result in a revert when exercising.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1181790939):**\n > Agreed, all wardens gave the same scenario that leads to a direct loss of NFTs and premium, but @STYJ's exploit scenario raises the gravity of the situation since users can be griefed.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/369#issuecomment-1185411060):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/1.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed by prohibiting non-empty `order.floorTokens` for short calls.\n >\n > Other option types do need `floorTokens`: long calls' taker provides floor tokens on filling, while long put owner brings in the floor tokens on exercise, taking the strike. Short put owner can thereafter retrieve the tokens on withdraw.\n\n\n***\n\n## [[H-04] Zero strike call options can be systemically used to steal premium from the taker](https://github.com/code-423n4/2022-06-putty-findings/issues/418)\n_Submitted by hyh, also found by hansfriese_\n\nSome non-malicious ERC20 do not allow for zero amount transfers and order.baseAsset can be such an asset. Zero strike calls are valid and common enough derivative type. However, the zero strike calls with such baseAsset will not be able to be exercised, allowing maker to steal from the taker as a malicious maker can just wait for expiry and withdraw the assets, effectively collecting the premium for free. The premium of zero strike calls are usually substantial.\n\nMarking this as high severity as in such cases malicious maker knowing this specifics can steal from taker the whole premium amount. I.e. such orders will be fully valid for a taker from all perspectives as inability to exercise is a peculiarity of the system which taker in the most cases will not know beforehand.\n\n### Proof of Concept\n\nCurrently system do not check the strike value, unconditionally attempting to transfer it:\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437>\n\n```solidity\n            } else {\n                ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n            }\n```\n\nAs a part of call exercise logic:\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L422-L443>\n\n```solidity\n    function exercise(Order memory order, uint256[] calldata floorAssetTokenIds) public payable {\n        ...\n\n        if (order.isCall) {\n            // -- exercising a call option\n\n            // transfer strike from exerciser to putty\n            // handle the case where the taker uses native ETH instead of WETH to pay the strike\n            if (weth == order.baseAsset && msg.value > 0) {\n                // check enough ETH was sent to cover the strike\n                require(msg.value == order.strike, \"Incorrect ETH amount sent\");\n\n                // convert ETH to WETH\n                // we convert the strike ETH to WETH so that the logic in withdraw() works\n                // - because withdraw() assumes an ERC20 interface on the base asset.\n                IWETH(weth).deposit{value: msg.value}();\n            } else {\n                ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n            }\n\n            // transfer assets from putty to exerciser\n            _transferERC20sOut(order.erc20Assets);\n            _transferERC721sOut(order.erc721Assets);\n            _transferFloorsOut(order.floorTokens, positionFloorAssetTokenIds[uint256(orderHash)]);\n        }\n```\n\nSome tokens do not allow zero amount transfers:\n\n<https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers>\n\nThis way for such a token and zero strike option the maker can create short call order, receive the premium:\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L327-L339>\n\n```solidity\n            if (weth == order.baseAsset && msg.value > 0) {\n                // check enough ETH was sent to cover the premium\n                require(msg.value == order.premium, \"Incorrect ETH amount sent\");\n\n                // convert ETH to WETH and send premium to maker\n                // converting to WETH instead of forwarding native ETH to the maker has two benefits;\n                // 1) active market makers will mostly be using WETH not native ETH\n                // 2) attack surface for re-entrancy is reduced\n                IWETH(weth).deposit{value: msg.value}();\n                IWETH(weth).transfer(order.maker, msg.value);\n            } else {\n                ERC20(order.baseAsset).safeTransferFrom(msg.sender, order.maker, order.premium);\n            }\n```\n\nTransfer in the assets:\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L366-L371>\n\n```solidity\n        // filling short call: transfer assets from maker to contract\n        if (!order.isLong && order.isCall) {\n            _transferERC20sIn(order.erc20Assets, order.maker);\n            _transferERC721sIn(order.erc721Assets, order.maker);\n            return positionId;\n        }\n```\n\nAnd wait for expiration, knowing that all attempts to exercise will revert:\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437>\n\n```solidity\n            } else {\n                ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n            }\n```\n\nThen recover her assets:\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L508-L519>\n\n```solidity\n        // transfer assets from putty to owner if put is exercised or call is expired\n        if ((order.isCall && !isExercised) || (!order.isCall && isExercised)) {\n            _transferERC20sOut(order.erc20Assets);\n            _transferERC721sOut(order.erc721Assets);\n\n            // for call options the floor token ids are saved in the long position in fillOrder(),\n            // and for put options the floor tokens ids are saved in the short position in exercise()\n            uint256 floorPositionId = order.isCall ? longPositionId : uint256(orderHash);\n            _transferFloorsOut(order.floorTokens, positionFloorAssetTokenIds[floorPositionId]);\n\n            return;\n        }\n```\n\n### Recommended Mitigation Steps\n\nConsider checking that strike is positive before transfer in all the cases, for example:\n\n```solidity\n            } else {\n+               if (order.strike > 0) {\n                    ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n+               }\n            }\n```\n\n**[Alex the Entreprenerd (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/418#issuecomment-1174522101):**\n > Seems contingent on token implementation, however certain ERC20 do revert on 0 transfer and there would be no way to exercise the contract in that case.\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/418#issuecomment-1178989277):**\n > Report: Cannot exercise call contract if strike is 0 and baseAsset reverts on 0 transfers.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/418#issuecomment-1182684476):**\n > There is a pre-requisite for the ERC20 token to revert on 0 amount transfers. However, the warden raised a key point: zero strike calls are common, and their premium is substantial. The information asymmetry of the ERC20 token between the maker and taker is another aggravating factor.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/418#issuecomment-1185410362):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/3.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed by conditioning call's logic on `order.strike > 0`. There is no use case for zero strike puts and so this case remains unconditioned, i.e. still always require successful `order.strike` transfer. \n\n***\n\n \n# Medium Risk Findings (16)\n## [[M-01] Malicious Token Contracts May Lead To Locking Orders](https://github.com/code-423n4/2022-06-putty-findings/issues/50)\n_Submitted by kirk-baird, also found by 0xA5DF, cccz, chatch, csanuragjain, Alex the Entreprenerd, hansfriese, hyh, itsmeSTYJ, Kenshin, pedroais, sashik_eth, unforgiven, and xiaoming90_\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L79>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L80>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L81>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L72>\n\n### Impact\n\nIt is possible to prevent an order from executing `exercise()` or `withdraw()` by having a malicious token contract included in the order as part of the any of the following fields.\n\n*   `baseAsset`\n*   `floorTokens[]`\n*   `erc20Assets[]`\n*   `erc721Assets[]`\n\nAn attacker as a maker may create an order and set one of these addresses to a malicious contract in the attackers control. The attacker allows the user to fill the order then toggles a variable on the malicious contract which always causes it to revert.\n\nThe attacker benefits by preventing orders from being `exercise()` if they are in an undesirable position (e.g. if they have gone short and the price has gone up). The attacker waits for either the time to expire or the price to go down and allows transfers to occur on their malicious token.\n\nSimilar attacks can also be performed over the `withdraw()` function since this also makes calls to untrusted external addresses. This would allow an attacker to exercise an option then prevent the other user from claiming any of the NFTs or ERC20 tokens that are owed to them.\n\n### Proof of Concept\n\nAny of the transfers in [exercise](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L389-L458) make external calls to untrusted addresses.\n\n```solidity\n    function exercise(Order memory order, uint256[] calldata floorAssetTokenIds) public payable {\n        /* ~~~ CHECKS ~~~ */\n\n\n        bytes32 orderHash = hashOrder(order);\n\n\n        // check user owns the position\n        require(ownerOf(uint256(orderHash)) == msg.sender, \"Not owner\");\n\n\n        // check position is long\n        require(order.isLong, \"Can only exercise long positions\");\n\n\n        // check position has not expired\n        require(block.timestamp < positionExpirations[uint256(orderHash)], \"Position has expired\");\n\n\n        // check floor asset token ids length is 0 unless the position type is put\n        !order.isCall\n            ? require(floorAssetTokenIds.length == order.floorTokens.length, \"Wrong amount of floor tokenIds\")\n            : require(floorAssetTokenIds.length == 0, \"Invalid floor tokenIds length\");\n\n\n        /* ~~~ EFFECTS ~~~ */\n\n\n        // send the long position to 0xdead.\n        // instead of doing a standard burn by sending to 0x000...000, sending\n        // to 0xdead ensures that the same position id cannot be minted again.\n        transferFrom(msg.sender, address(0xdead), uint256(orderHash));\n\n\n        // mark the position as exercised\n        exercisedPositions[uint256(orderHash)] = true;\n\n\n        emit ExercisedOrder(orderHash, floorAssetTokenIds, order);\n\n\n        /* ~~~ INTERACTIONS ~~~ */\n\n\n        if (order.isCall) {\n            // -- exercising a call option\n\n\n            // transfer strike from exerciser to putty\n            // handle the case where the taker uses native ETH instead of WETH to pay the strike\n            if (weth == order.baseAsset && msg.value > 0) {\n                // check enough ETH was sent to cover the strike\n                require(msg.value == order.strike, \"Incorrect ETH amount sent\");\n\n\n                // convert ETH to WETH\n                // we convert the strike ETH to WETH so that the logic in withdraw() works\n                // - because withdraw() assumes an ERC20 interface on the base asset.\n                IWETH(weth).deposit{value: msg.value}();\n            } else {\n                ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n            }\n\n\n            // transfer assets from putty to exerciser\n            _transferERC20sOut(order.erc20Assets);\n            _transferERC721sOut(order.erc721Assets);\n            _transferFloorsOut(order.floorTokens, positionFloorAssetTokenIds[uint256(orderHash)]);\n        } else {\n            // -- exercising a put option\n\n\n            // save the floor asset token ids to the short position\n            uint256 shortPositionId = uint256(hashOppositeOrder(order));\n            positionFloorAssetTokenIds[shortPositionId] = floorAssetTokenIds;\n\n\n            // transfer strike from putty to exerciser\n            ERC20(order.baseAsset).safeTransfer(msg.sender, order.strike);\n\n\n            // transfer assets from exerciser to putty\n            _transferERC20sIn(order.erc20Assets, msg.sender);\n            _transferERC721sIn(order.erc721Assets, msg.sender);\n            _transferFloorsIn(order.floorTokens, floorAssetTokenIds, msg.sender);\n        }\n    }\n```\n\nThe attacker must control one of these contracts and have it set as a malicious ERC20 / ERC721 function that fails under attacker controlled conditions.\n\n### Recommended Mitigation Steps\n\nConsider whitelisting approved ERC20 token or ERC721 address contracts to prevent users setting malicious token contracts. However, this remediation will have a significant admin input / gas trade-offs.\n\n**[outdoteth (Putty Finance) acknowledged and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/50#issuecomment-1177630161):**\n > Technically this is a valid finding. However we don't intend to fix this at the contract level. Instead there will be adequate warnings on the UI to inform a user that they should be vigilant for any tokens that are not verified by putty (in addition, the UI will show the unverified token's logo as a question mark instead of as the token's logoURI).\n>\n > Report: Setting malicious or invalid erc721Assets, erc20Assets or floorTokens prevents the option from being exercised.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/50#issuecomment-1179463134):**\n > It's contingent on the external requirement for the attacker to be in control of a malicious ERC20 or NFT. Hence, medium severity is appropriate: `2-Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.`\n\n**[Pedroais (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/50#issuecomment-1194894079):**\n > I will argue why this issue should be high severity instead of medium.  \n> \n> \"It's contingent on the external requirement for the attacker to be in control of a malicious ERC20 or NFT. \"\n> \n> Anyone can deploy a malicious contract and pass it as an ERC20 or NFT. This is not an external requirement, anyone can do it. Any malicious contract deployed by the attacker will work.\n> \n> This issue imposes a risk of asset loss to users without external requirements. The sponsor states unknown tokens will be shown with a question mark in the UI. This is ok but I think the attack is high severity since the user would be reasonable to think if he is accepting an offer for a BAYC (example of an expensive NFT)  and some unknown token that in the worse case he should at least get the BAYC. This attack doesn't require the user to be dumb or act recklessly but just normal functioning of the protocol. The fake token shouldn't prevent the user from exercising the real BAYC.\n> \n> A user would be reasonable to expect to at least be able to exercise the real NFT in a case with an option that includes a real NFT and a malicious one. The problem is the malicious NFT can block the exercise of the real NFT. An option can be created using  many real and valuable tokens with just 1 malicious token that prevents exercising the real ones.\n> \n> I hope the judge can consider these arguments and make his decision.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/50#issuecomment-1198793737):**\n> I should have phrased it better. The external requirement isn't on the attacker being in control of the malicious ERC20 / NFT. As rightfully pointed out, it can be easily done.\n> \n> The external requirement here is the user deciding to fill an option containing malicious assets. Such options can be considered to be honeypots that users should be made aware of (eg. through documentation, PSAs or warnings to the user). There's only so much the protocol can do to protect users, with tradeoffs against centralisation risks if the suggestion of whitelisting assets is adopted.\n> \n> > This attack doesn't require the user to be dumb or act recklessly but just normal functioning of the protocol. The fake token shouldn't prevent the user from exercising the real BAYC.\n> \n> Partial exercising of options could be a feature, but opens up new attack surfaces and would be a non-trivial to implement. It is a limitation of the protocol that should be clearly communicated to users.\n\n**hyh (warden) reviewed mitigation:**\n > Now addressed on UI/DB level.\n\n***\n\n## [[M-02] Unbounded loops may cause `exercise()`s and `withdraw()`s to fail ](https://github.com/code-423n4/2022-06-putty-findings/issues/227)\n_Submitted by IllIllI, also found by 0xNineDec, sashik_eth, shung, and xiaoming90_\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L636-L640>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L646-L650>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L657-L661>\n\n### Impact\n\nThere are no bounds on the number of tokens transferred in an order, and gas requirements can change (especially since orders can have a duration of [27 years](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L287)), so orders filled at time T1 may not be exercisable/withdrawable at time T2, or with the provided assets if the assets use a lot of gas during their transfers (e.g. aTokens and cTokens). The buyer of the option will have paid the premium, and will be unable to get the assets they are owed.\n\n### Proof of Concept\n\nThere are no upper bounds on the number of assets being transferred in these loops:\n\n```solidity\nFile: contracts/src/PuttyV2.sol   #1\n\n636       function _transferERC20sOut(ERC20Asset[] memory assets) internal {\n637           for (uint256 i = 0; i < assets.length; i++) {\n638               ERC20(assets[i].token).safeTransfer(msg.sender, assets[i].tokenAmount);\n639           }\n640       }\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L636-L640>\n\n```solidity\nFile: contracts/src/PuttyV2.sol   #2\n\n646       function _transferERC721sOut(ERC721Asset[] memory assets) internal {\n647           for (uint256 i = 0; i < assets.length; i++) {\n648               ERC721(assets[i].token).safeTransferFrom(address(this), msg.sender, assets[i].tokenId);\n649           }\n650       }\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L646-L650>\n\n```solidity\nFile: contracts/src/PuttyV2.sol   #3\n\n657       function _transferFloorsOut(address[] memory floorTokens, uint256[] memory floorTokenIds) internal {\n658           for (uint256 i = 0; i < floorTokens.length; i++) {\n659               ERC721(floorTokens[i]).safeTransferFrom(address(this), msg.sender, floorTokenIds[i]);\n660           }\n661       }\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L657-L661>\n\n### Recommended Mitigation Steps\n\nHave an upper bound on the number of assets, or allow them to be transferred out one at a time, if necessary\n\n**[outdoteth (Putty Finance) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/227#issuecomment-1177670801):**\n > Adding a hardcoded check at the contract level is not a viable fix given that gas costs and limits are subject change over time.\n> Instead, there already exists a limit of 30 assets on the frontend/db level.\n\n**[outdoteth (Putty Finance) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/227#issuecomment-1179001005):**\n > Report: Unbounded loop can prevent put option from being exercised.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/227#issuecomment-1179845396):**\n > Medium severity is justified because, while very unlikely to happen, there could be a loss of assets.\n\n**hyh (warden) reviewed mitigation:**\n > Now addressed on UI/DB level.\n\n***\n\n## [[M-03] Put option sellers can prevent exercise by specifying zero amounts, or non-existant tokens](https://github.com/code-423n4/2022-06-putty-findings/issues/223)\n_Submitted by IllIllI, also found by 0xNineDec, exd0tpy, and zzzitron_\n\nPut option buyers pay an option premium to the seller for the privilege of being able to 'put' assets to the seller and get the strike price for it rather than the current market price. If they're unable to perform the 'put', they've paid the premium for nothing, and essentially have had funds stolen from them.\n\n### Proof of Concept\n\nIf the put option seller includes in `order.erc20Assets`, an amount of zero for any of the assets, or specifies an asset that doesn't currently have any code at its address, the put buyer will be unable to exercise the option, and will have paid the premium for nothing:\n\n```solidity\nFile: contracts/src/PuttyV2.sol   #1\n\n453               // transfer assets from exerciser to putty\n454               _transferERC20sIn(order.erc20Assets, msg.sender);\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L453-L454>\n\nThe function reverts if any amount is equal to zero, or the asset doesn't exist:\n\n```solidity\nFile: contracts/src/PuttyV2.sol   #2\n\n593       function _transferERC20sIn(ERC20Asset[] memory assets, address from) internal {\n594           for (uint256 i = 0; i < assets.length; i++) {\n595               address token = assets[i].token;\n596               uint256 tokenAmount = assets[i].tokenAmount;\n597   \n598               require(token.code.length > 0, \"ERC20: Token is not contract\");\n599               require(tokenAmount > 0, \"ERC20: Amount too small\");\n600   \n601               ERC20(token).safeTransferFrom(from, address(this), tokenAmount);\n602           }\n603       }\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L593-L603>\n\n### Recommended Mitigation Steps\n\nVerify the asset amounts and addresses during `fillOrder()`, and allow exercise if the token no longer exists at that point in time.\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/223#issuecomment-1177638096):**\n > At the contract level there exists 2 possible mitigations;\n> \n> 1) Remove the zero amount check (not feasible because it will cause another DOS issue for tokens that revert on 0 transfer).\n> 2) Check all erc20 assets are valid in `fillOrder` (gas tradeoff because it requires an O(n) loop to check).\n> \n> Instead, the best mitigation imo is to add a check on the frontend/db level to ensure that all erc20 assets have a token amount greater than 0 and that it exists as a contract.\n> \n> If users want to go lower level than the db/frontend then they must exercise their own diligence.\n> \n> edit: decided to go with a 3rd option instead.\n> \n> Simply skip the ERC20 transfer if the amount is 0.<br>\n>\n> Report: Setting an erc20Asset with a zero amount or with no code at the address will result in a revert when exercising a put option.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/223#issuecomment-1185412355):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/8.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed zero amount part by introducing the noop for zero amount transfers in both `_transferERC20sIn` and `_transferERC20sOut` ERC20 transfer functions. The second part of the issue, fake tokens, is similar to [M-01](https://github.com/code-423n4/2022-06-putty-findings/issues/50), [M-02](https://github.com/code-423n4/2022-06-putty-findings/issues/227).\n\n***\n\n## [[M-04] Put options are free of any fees](https://github.com/code-423n4/2022-06-putty-findings/issues/285)\n_Submitted by berndartmueller, also found by 0xsanson, hubble, Lambda, Metatron, and swit_\n\nFees are expected to be paid whenever an option is exercised (as per the function comment on [L235](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L235)).\n\n#### Put options\n\nIf a put option is exercised, the exerciser receives the strike price (initially deposited by the short position holder) denominated in `order.baseAsset`.\n\n#### Call options\n\nIf a call option is exercised, the exerciser sends the strike price to Putty and the short position holder is able to withdraw the strike amount.\n\nHowever, the current protocol implementation is missing to deduct fees for exercised put options. Put options are free of any fees.\n\n### Proof of Concept\n\nThe protocol fee is correctly charged for exercised calls:\n\n[PuttyV2.withdraw](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L494-L506)\n\n```solidity\n// transfer strike to owner if put is expired or call is exercised\nif ((order.isCall && isExercised) || (!order.isCall && !isExercised)) {\n    // send the fee to the admin/DAO if fee is greater than 0%\n    uint256 feeAmount = 0;\n    if (fee > 0) {\n        feeAmount = (order.strike * fee) / 1000;\n        ERC20(order.baseAsset).safeTransfer(owner(), feeAmount); // @audit DoS due to reverting erc20 token transfer (weird erc20 tokens, blacklisted or paused owner; erc777 hook on owner receiver side can prevent transfer hence reverting and preventing withdrawal) - use pull pattern @high  // @audit zero value token transfers can revert. Small strike prices and low fee can lead to rounding down to 0 - check feeAmount > 0 @high  // @audit should not take fees if renounced owner (zero address) as fees can not be withdrawn @medium\n    }\n\n    ERC20(order.baseAsset).safeTransfer(msg.sender, order.strike - feeAmount); // @audit fee should not be paid if strike is simply returned to short owner for expired put @high\n\n    return;\n}\n```\n\nContrary, put options are free of any fees:\n\n[PuttyV2.sol#L450-L451](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L450-L451)\n\n```solidity\n// transfer strike from putty to exerciser\nERC20(order.baseAsset).safeTransfer(msg.sender, order.strike);\n```\n\n### Recommended Mitigation Steps\n\nCharge fees also for exercised put options.\n\n**[outdoteth (Putty Finance) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/285#issuecomment-1176533283):**\n > Fees are only applied on puts if they are expired.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/285#issuecomment-1179907369):**\n > Making this the primary issue for the med severity issue, as per my comment in [#269](https://github.com/code-423n4/2022-06-putty-findings/issues/269):\n> > \"Put option not being charged fee upon exercising it. This can be considered to the \"protocol leaked value\" and thus be given a medium severity rating.\"\n\n**[outdoteth (Putty Finance) confirmed and resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/285#issuecomment-1185411614):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/4.\n\n**hyh (warden) reviewed mitigation:**\n > The same fix as in [H-01](https://github.com/code-423n4/2022-06-putty-findings/issues/269).\n\n***\n\n## [[M-05] `fillOrder()` and `exercise()` may lock Ether sent to the contract, forever](https://github.com/code-423n4/2022-06-putty-findings/issues/226)\n_Submitted by IllIllI, also found by 0x29A, 0xc0ffEE, 0xDjango, AmitN, auditor0517, berndartmueller, BowTiedWardens, cccz, danb, dipp, dirk_y, hansfriese, horsefacts, hyh, joestakey, kirk-baird, oyc_109, peritoflores, rfa, sashik_eth, simon135, sseefried, StErMi, swit, xiaoming90, and zzzitron_\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L338>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436>\n\n### Impact\n\n`fillOrder()` and `exercise()` have code paths that require Ether to be sent to them (e.g. using WETH as the base asset, or the provision of the exercise price), and therefore those two functions have the `payable` modifier. However, there are code paths within those functions that do not require Ether. Ether passed to the functions, when the non-Ether code paths are taken, is locked in the contract forever, and the sender gets nothing extra in return for it.\n\n### Proof of Concept\n\nEther can't be pulled from the `order.maker` during the filling of a long order, so `msg.value` shouldn't be provided here:\n\n```solidity\nFile: contracts/src/PuttyV2.sol   #1\n\n323           if (order.isLong) {\n324               ERC20(order.baseAsset).safeTransferFrom(order.maker, msg.sender, order.premium);\n325           } else {\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L323-L325>\n\nIf the `baseAsset` isn't WETH during order fulfillment, `msg.value` is unused:\n\n```solidity\nFile: contracts/src/PuttyV2.sol   #2\n\n337               } else {\n338                   ERC20(order.baseAsset).safeTransferFrom(msg.sender, order.maker, order.premium);\n339               }\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L337-L339>\n\nSame for the exercise of call options:\n\n```solidity\nFile: contracts/src/PuttyV2.sol   #3\n\n435               } else {\n436                   ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n437               }\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L435-L437>\n\n### Recommended Mitigation Steps\n\nAdd a `require(0 == msg.value)` for the above three conditions.\n\n**[Alex the Entreprenerd (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/226#issuecomment-1174516212):**\n > Why would the caller send ETH when they don't have to?\n\n**[sseefried (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/226#issuecomment-1174603678):**\n > User error is one possibility. \n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/226#issuecomment-1179001561):**\n > Report: Native ETH can be lost if it’s not utilised in exercise and fillOrder.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/226#issuecomment-1185413512):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/5.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed with native funds amount control added to strike transfer logic of `fillOrder`. Zero strike and zero premium corner cases are yet unhandled as described in [M.M-01](#mm-01-weth-zero-strike-call-fillorders-msgvalue-will-be-lost) and [M.M-02](#mm-02-zero-premium-short-fillorders-msgvalue-will-be-lost) in the Mitigation Review below.\n\n***\n\n## [[M-06] [Denial-of-Service] Contract Owner Could Block Users From Withdrawing Their Strike](https://github.com/code-423n4/2022-06-putty-findings/issues/296)\n_Submitted by xiaoming90, also found by berndartmueller_\n\nWhen users withdraw their strike escrowed in Putty contract, Putty will charge a certain amount of fee from the strike amount. The fee will first be sent to the contract owner, and the remaining strike amount will then be sent to the users.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L500>\n\n```solidity\nfunction withdraw(Order memory order) public {\n\t..SNIP..\n\n\t// transfer strike to owner if put is expired or call is exercised\n\tif ((order.isCall && isExercised) || (!order.isCall && !isExercised)) {\n\t\t// send the fee to the admin/DAO if fee is greater than 0%\n\t\tuint256 feeAmount = 0;\n\t\tif (fee > 0) {\n\t\t\tfeeAmount = (order.strike * fee) / 1000;\n\t\t\tERC20(order.baseAsset).safeTransfer(owner(), feeAmount);\n\t\t}\n\n\t\tERC20(order.baseAsset).safeTransfer(msg.sender, order.strike - feeAmount);\n\n\t\treturn;\n\t}\n\t..SNIP..\n}\n```\n\nThere are two methods on how the owner can deny user from withdrawing their strike amount from the contract\n\n#### Method #1 - Set the `owner()` to `zero` address\n\nMany of the token implementations do not allow transfer to `zero` address ([Reference](https://github.com/d-xo/weird-erc20#revert-on-transfer-to-the-zero-address)). Popular ERC20 implementations such as the following Openzeppelin's ERC20 implementation do not allow transfer to `zero` address, and will revert immediately if the `to` address (recipient) points to a `zero` address during a transfer.\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/5fbf494511fd522b931f7f92e2df87d671ea8b0b/contracts/token/ERC20/ERC20.sol#L226>\n\n```solidity\nfunction _transfer(\n    address from,\n    address to,\n    uint256 amount\n) internal virtual {\n    require(from != address(0), \"ERC20: transfer from the zero address\");\n    require(to != address(0), \"ERC20: transfer to the zero address\");\n\n    _beforeTokenTransfer(from, to, amount);\n\n    uint256 fromBalance = _balances[from];\n    require(fromBalance >= amount, \"ERC20: transfer amount exceeds balance\");\n    unchecked {\n        _balances[from] = fromBalance - amount;\n        // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by\n        // decrementing then incrementing.\n        _balances[to] += amount;\n    }\n\n    emit Transfer(from, to, amount);\n\n    _afterTokenTransfer(from, to, amount);\n}\n```\n\nIt is possible for the owner to transfer the ownership to a `zero` address, thus causing the fee transfer to the contract owner to always revert. When the fee transfer always reverts, no one can withdraw their strike amount from the contract.\n\nThis issue will affect all orders that adopt a `baseAsset` that reverts when transferring to `zero` address.\n\n#### Method #2 - If `baseAsset` is a ERC777 token\n\n> Note: `owner()` could point to a contract or EOA account. By pointing to a contract, the contract could implement logic to revert whenever someone send tokens to it.\n\nERC777 contains a `tokensReceived` hook that will notify the recipient whenever someone sends some tokens to the recipient .\n\nAssuming that the `baseAsset` is a ERC77 token, the recipient, which is the `owner()` in this case, could always revert whenever `PuttyV2` contract attempts to send the fee to recipient. This will cause the `withdraw` function to revert too. As a result, no one can withdraw their strike amount from the contract.\n\nThis issue will affect all orders that has ERC777 token as its `baseAsset`.\n\n### Impact\n\nUser cannot withdraw their strike amount and their asset will be stuck in the contract.\n\n### Recommended Mitigation Steps\n\nIt is recommended to adopt a [withdrawal pattern](https://docs.soliditylang.org/en/v0.8.15/common-patterns.html#withdrawal-from-contracts) for retrieving owner fee.\n\nInstead of transferring the fee directly to owner address during withdrawal, save the amount of fee that the owner is entitled to in a state variable. Then, implement a new function that allows the owner to withdraw the fee from the `PuttyV2` contract.\n\nConsider the following implementation. In the following example, there is no way for the owner to perform denial-of-user because the outcome of the fee transfer (succeed or fail) to the owner will not affect the user's strike withdrawal process.\n\nThis will give users more assurance and confidence about the security of their funds stored within Putty.\n\n```solidity\nmapping(address => uint256) public ownerFees;\n\nfunction withdraw(Order memory order) public {\n\t..SNIP..\n    // transfer strike to owner if put is expired or call is exercised\n    if ((order.isCall && isExercised) || (!order.isCall && !isExercised)) {\n        // send the fee to the admin/DAO if fee is greater than 0%\n        uint256 feeAmount = 0;\n        if (fee > 0) {\n            feeAmount = (order.strike * fee) / 1000;\n            ownerFees[order.baseAsset] += feeAmount\n        }\n\n        ERC20(order.baseAsset).safeTransfer(msg.sender, order.strike - feeAmount);\n\n        return;\n    }\n    ..SNIP..\n}\n\nfunction withdrawFee(address baseAsset) public onlyOwner {\n\tuint256 _feeAmount = ownerFees[baseAsset];\n\townerFees[baseAsset] = 0;\n\tERC20(baseAsset).safeTransfer(owner(), _feeAmount);\n}\n```\n**[outdoteth (Putty Finance) disagreed with severity](https://github.com/code-423n4/2022-06-putty-findings/issues/296#issuecomment-1177678807)**\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/296#issuecomment-1179936225):**\n > The scenarios provided are valid, especially for baseAssets that revert on zero-address transfer.\n> \n> While the likelihood is low, assets are lost and cannot be retrieved.<br>\n> `3 — High: Assets can be stolen/lost/compromised directly (or indirectly if there is a valid attack path that does not have hand-wavy hypotheticals).`\n\n**[HickupHH3 (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/296#issuecomment-1181754248):**\n > Thinking about it further, the external conditions / requirements needed for the DoS to happen are somewhat strong.\n> - the ERC777 attack requires `owner()` or the token to be engineered to be malicious and adopted.\n> - DoS via revoking ownership requires `fee` to be non-zero first, which is unlikely to happen. I can classify this as a \"user-prone\" bug, which would be similar to cases like including ETH when WETH is intended to be used (#226).\n> \n> Hence, I think medium severity is more appropriate:\n> `2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.`\n\n**[outdoteth (Putty Finance) confirmed and resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/296#issuecomment-1185411399):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/4.\n\n**hyh (warden) reviewed mitigation:**\n > The same fix as in [H-01](https://github.com/code-423n4/2022-06-putty-findings/issues/269): as the platform fee is now transferred on order filling, any owner griefing can only yield a denial of service. There will be no loss of funds as this way position is only about to be created when the fee is transferred.\n\n***\n\n## [[M-07] An attacker can create a short put option order on an NFT that does not support ERC721 (like cryptopunk), and the user can fulfill the order, but cannot exercise the option](https://github.com/code-423n4/2022-06-putty-findings/issues/16)\n_Submitted by cccz, also found by IllIllI and minhquanym_\n\nAn attacker can create a short put option on cryptopunk. When the user fulfills the order, the baseAsset will be transferred to the contract. \n\nHowever, since cryptopunk does not support ERC721, the user cannot exercise the option because the safeTransferFrom function call fails. Attacker can get premium and get back baseAsset after option expires.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L343-L346>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L628-L629>\n\n### Recommended Mitigation Steps\n\nConsider adding a whitelist to nfts in the order, or consider supporting exercising on cryptopunk.\n\n**[STYJ (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1174823604):**\n > Putty uses solmate's `ERC721.safeTransferFrom` which requires that the NFT contract implements `onERC721Received`. For the case of OG NFTs like punks and rocks, this will fail, https://github.com/Rari-Capital/solmate/blob/main/src/tokens/ERC721.sol#L120\n\n**[thereksfour (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1175910424):**\n > The user does not need to send cryptopunk to the contract when fulfilling the short put option order, but the user will pay a premium to the order creator. Later, when the user wants to exercise the option, since the cryptopunk does not support safetransferfrom, the user cannot exercise the option.\n\n**[STYJ (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1176031452):**\n > > The user does not need to send cryptopunk to the contract when fulfilling the short put option order, but the user will pay a premium to the order creator. Later, when the user wants to exercise the option, since the cryptopunk does not support safetransferfrom, the user cannot exercise the option.\n> \n> Sorry, I did not consider this path. You are correct to say that a maker can create a short put option order with cryptopunks as a token and the holder of the long put option will not be able to exercise since cryptopunks cannot be transferred with `safeTransferFrom`. From that perspective, this is a valid issue. Thank you for bringing it up. I will defer to the judge for the final decision.\n\n**[outdoteth (Putty Finance) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1178923868):**\n > We dont intend to support cryptopunks or cryptokitties.\n> If users wish to use these tokens then they can get wrapped versions (ex: wrapped cryptopunks).\n\n**[HickupHH3 (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/16#issuecomment-1181762798):**\n > I thought cryptokitties are ERC721? I think they were the ones who popularized the standard actually :p \n> Probably meant etherrocks.\n> \n> In general, non-compliant ERC-721 NFTs can be supported through wrappers, though some users might be unaware... Downgrading to med severity, similar to [this issue from another contest](https://github.com/code-423n4/2022-02-foundation-findings/issues/74).\n> \n> \n\n**hyh (warden) reviewed mitigation:**\n > Similar to [M-01](https://github.com/code-423n4/2022-06-putty-findings/issues/50), [M-02](https://github.com/code-423n4/2022-06-putty-findings/issues/227).\n\n***\n\n## [[M-08] Overlap Between `ERC721.transferFrom()` and `ERC20.transferFrom()` Allows `order.erc20Assets` or `order.baseAsset` To Be ERC721 Rather Than ERC20](https://github.com/code-423n4/2022-06-putty-findings/issues/52)\n_Submitted by kirk-baird, also found by reassor and sseefried_\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L338>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L344>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L360>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L601>\n\n### Impact\n\nBoth `ERC20.transferFrom(address to, address  from, uint256 amount)` and `ERC721.transferFrom(address to, address from, uint256 id)` have the same function signature `0x23b872dd`. The impact of this is it's possible for `baseAsset` or `erc20Assets` to be ERC721 addresses rather than ERC20.\n\nThese functions will successfully transfer the NFT into the protocol however they will fail to transfer the NFT out of the contract. That is because the outgoing transfer is `ERC20.safeTransfer()` which calls `transfer(to, amount)` which does not match up with any valid function signatures on ERC721.\n\nTherefore any ERC721 tokens transferred into the contract in this manner via `fillOrder()` will be permanently stuck in the contract as neither `exercise()` nor `withdraw()` will successfully transfer the tokens out of the contract.\n\n### Proof of Concept\n\n[ERC721.transferFrom()](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/lib/solmate/src/tokens/ERC721.sol#L82-L86)\n\n```solidity\n    function transferFrom(\n        address from,\n        address to,\n        uint256 id\n    ) public virtual {\n```\n\n[ERC20.transferFrom()](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/lib/solmate/src/tokens/ERC20.sol#L90-L94)\n\n```solidity\n    function transferFrom(\n        address from,\n        address to,\n        uint256 amount\n    ) public virtual returns (bool) {\n```\n\n### Recommended Mitigation Steps\n\nConsider whitelisting approved ERC721 and ERC20 token contracts. Furthermore, separate these two contracts into different whitelists for ERC20s and ERC721s then ensure each contract is in the right category.\n\n**[outdoteth (Putty Finance) acknowledged and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/52#issuecomment-1179004318):**\n > Report: If an ERC721 token is used in places where ERC20 assets are supposed to be used then ERC721 tokens can get stuck in withdraw() and exercise().\n\n**hyh (warden) reviewed mitigation:**\n > Requires asset whitelisting, now addressed on UI/DB level.\n\n***\n\n## [[M-09] The contract serves as a flashloan pool without fee](https://github.com/code-423n4/2022-06-putty-findings/issues/377)\n_Submitted by 0xc0ffEE, also found by horsefacts, pedroais, and unforgiven_\n\nThe malicious user could leverage PuttyV2 contract to flashloan without paying fee the assets to make profit.\n\nConsider a scenario that maker and taker is the same, and is a contract\n\n1.  The contract call PuttyV2.`fillOrder` with a Long Call order that has `order.baseAssets` references to a contract having custom logic other than standard ERC20. The order also specify `erc20Assets` to the `token` and `tokenAmount` that PuttyV2 contract is owing (similar to `erc721Assets`)\n2.  When the execution is at <https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324>, the custom logic could execute on the contract address `order.baseAsset`.\n3.  The malicious contract then call `exercise` to exercise the short call position. This call will transfer out the assets specified in the order to the malicious contract by executing logics in `_transferERC20sOut, _transferERC721sOut`\n4.  The contract uses that assets to make profit on other platforms. After that, the execution continues at <https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324>.\n5.  At the end of `fillOrder`, the contract just transfers enough assets back to PuttyV2 by executing logics in `_transferERC20sIn, _transferERC721sIn` to finish the execution.\n\n**[Alex the Entreprenerd (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1174509620):**\n> Warden is saying that they can flashloan without fee, but any exercised option will pay a 3% fee, additionally the order of operations shown (gain control on base.asset.transfer when receiving premium), would mean that the order ERC20s and NFTs have yet to be transferred in, so a \"mid-fillOrder\" \"exercise\" would not only pay the fee, but also revert due to lack of the tokens.\n\n**[Pedroais (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1174999561):**\n> The 3% will be paid in the fake asset since base asset is an attacker contract so there is no fee to perform the attack. \n> \n> This attack is done with assets that are already inside the contract so there is no revert in transfer out.\n\n**[outdoteth (Putty Finance) acknowledged and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1175061981):**\n > Acknowledging that technically this is true.\n> Although no easy mitigation exists as far as I can see aside from adding nonReentrant to exercise and fillOrder - adding a non-negligible gas overhead.\n\n**[Alex the Entreprenerd (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1175108315):**\n > I agree that the finding is valid, the fee can be paid in a mintable token to gain temporary ownership of a token underlying which is repaid at the end of `fillOrder`.\n\n**[outdoteth (Putty Finance) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1178994409):**\n > Report: It’s possible to flashloan all assets in the contract without paying a protocol fee.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/377#issuecomment-1182823327):**\n > Flash loans from the contract would be a feature, not a bug. However, being able to do so without paying a protocol fee (ie. paying in fake tokens) wouldn't be great. \n> \n\n***\n\n## [[M-10] Putty position tokens may be minted to non ERC721 receivers](https://github.com/code-423n4/2022-06-putty-findings/issues/327)\n_Submitted by horsefacts, also found by 0xc0ffEE, 0xsanson, berndartmueller, BowTiedWardens, csanuragjain, defsec, IllIllI, joestakey, Kenshin, Picodes, shenwilly, Sm4rty, unforgiven, and xiaoming90_\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L302-L308>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L11-L18>\n\n### Vulnerability Details\n\nPutty uses ERC721 `safeTransfer` and `safeTransferFrom` throughout the codebase to ensure that ERC721 tokens are not transferred to non ERC721 receivers. However, the initial position mint in `fillOrder` uses `_mint` rather than `_safeMint` and does not check that the receiver accepts ERC721 token transfers:\n\n[`PuttyV2#fillOrder`](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L302-L308)\n\n```solidity\n        // create long/short position for maker\n        _mint(order.maker, uint256(orderHash));\n\n        // create opposite long/short position for taker\n        bytes32 oppositeOrderHash = hashOppositeOrder(order);\n        positionId = uint256(oppositeOrderHash);\n        _mint(msg.sender, positionId);\n```\n\n[`PuttyV2Nft#_mint`](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L11-L18)\n\n```solidity\n    function _mint(address to, uint256 id) internal override {\n        require(to != address(0), \"INVALID_RECIPIENT\");\n        require(_ownerOf[id] == address(0), \"ALREADY_MINTED\");\n\n        _ownerOf[id] = to;\n\n        emit Transfer(address(0), to, id);\n    }\n```\n\n### Impact\n\nIf a maker or taker are a contract unable to receive ERC721 tokens, their options positions may be locked and nontransferable. If the receiving contract does not provide a mechanism for interacting with Putty, they will be unable to exercise their position or withdraw assets.\n\n### Recommendation\n\nConsider implementing the `require` check in Solmate's `ERC721#_safeMint` in your own mint function:\n\n```solidity\n    function _safeMint(address to, uint256 id) internal virtual {\n        _mint(to, id);\n\n        require(\n            to.code.length == 0 ||\n                ERC721TokenReceiver(to).onERC721Received(msg.sender, address(0), id, \"\") ==\n                ERC721TokenReceiver.onERC721Received.selector,\n            \"UNSAFE_RECIPIENT\"\n        );\n    }\n```\n\nHowever, note that calling `_safeMint` introduces a reentrancy opportunity! If you make this change, ensure that the mint is treated as an interaction rather than an effect, and consider adding a reentrancy guard:\n\n```solidity\n        /*  ~~~ EFFECTS ~~~ */\n\n        // create opposite long/short position for taker\n        bytes32 oppositeOrderHash = hashOppositeOrder(order);\n        positionId = uint256(oppositeOrderHash);\n\n        // save floorAssetTokenIds if filling a long call order\n        if (order.isLong && order.isCall) {\n            positionFloorAssetTokenIds[uint256(orderHash)] = floorAssetTokenIds;\n        }\n\n        // save the long position expiration\n        positionExpirations[order.isLong ? uint256(orderHash) : positionId] = block.timestamp + order.duration;\n\n        emit FilledOrder(orderHash, floorAssetTokenIds, order);\n\n        /* ~~~ INTERACTIONS ~~~ */\n\n        _safeMint(order.maker, uint256(orderHash));\n        _safeMint(msg.sender, positionId);\n```\n\nAlternatively, document the design decision to use `_mint` and the associated risk for end users.\n\n**[outdoteth (Putty Finance) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/327#issuecomment-1176613220):**\n> It's unlikely a contract will have all the setup required to interact with PuttyV2 but not be able to handle ERC721 tokens. Adding a check via safeMint adds a gas overhead as well as another re-entrancy attack vector so there is a tradeoff (as noted in the issue report^^).\n\n> Report: Contracts that can’t handle ERC721 tokens will lose their Putty ERC721 position tokens.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/327#issuecomment-1183141452):**\n > In addition, some contracts may have custom logic in their `onERC721Received()` implementation that is triggered only by the safe methods and not their \"unsafe\" counterparts.\n\n***\n\n## [[M-11] `fee` can change without the consent of users](https://github.com/code-423n4/2022-06-putty-findings/issues/422)\n_Submitted by Picodes, also found by 0xNineDec, 0xsanson, antonttc, berndartmueller, BowTiedWardens, catchup, dirk_y, Alex the Entreprenerd, horsefacts, Metatron, sseefried, and unforgiven_\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L240>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L497>\n\n### Impact\n\nFees are applied during `withdraw`, but can change between the time the order is filled and its terms are agreed upon and the withdrawal time, leading to a loss of the expected funds for the concerned users.\n\n### Proof of Concept\n\nThe scenario would be:\n\n*   Alice and Bob agrees to fill an order at a time fees are 0.1%\n*   During the duration of the option, fees are increased to 3%\n*   At withdrawal they'll pay 3% of the strike, although they wouldn't have created the order in the first place with such fees\n\n### Recommended Mitigation Steps\n\nMitigation could be:\n\n*   Store the fees in `Order` and verify that they are correct when the order is filled, so they are hardcoded in the struct\n*   Add a timestamp: this wouldn't fully mitigate but would still be better than the current setup\n*   Keep past fees and fee change timestamps in memory (for example in an array) to be able to retrieve the creation time fees at withdrawal\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/422#issuecomment-1178988085):**\n > Report: Admin can change fee at any time for existing orders.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/422#issuecomment-1185414532):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/4.\n\n**hyh (warden) reviewed mitigation:**\n > The same fix as in [H-01](https://github.com/code-423n4/2022-06-putty-findings/issues/269).\n\n***\n\n## [[M-12] Options with a small strike price will round down to 0 and can prevent assets to be withdrawn](https://github.com/code-423n4/2022-06-putty-findings/issues/283)\n_Submitted by berndartmueller, also found by auditor0517, hansfriese, IllIllI, Lambda, sashik_eth, shenwilly, and TrungOre_\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L499-L500>\n\n### Impact\n\nCertain ERC-20 tokens do not support zero-value token transfers and revert. Using such a token as a `order.baseAsset` for a rather small option strike and a low protocol fee rate can lead to rounding down to 0 and prevent asset withdrawals for those positions.\n\n### Proof of Concept\n\n[PuttyV2.sol#L499-L500](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L499-L500)\n\n```solidity\n// send the fee to the admin/DAO if fee is greater than 0%\nuint256 feeAmount = 0;\nif (fee > 0) {\n    feeAmount = (order.strike * fee) / 1000;\n    ERC20(order.baseAsset).safeTransfer(owner(), feeAmount); // @audit-info zero-value ERC20 token transfers can revert for certain tokens\n}\n```\n\nSome ERC20 tokens revert for zero-value transfers (e.g. `LEND`). If used as a `order.baseAsset` and a small strike price, the fee token transfer will revert. Hence, assets and the strike can not be withdrawn and remain locked in the contract.\n\nSee [Weird ERC20 Tokens - Revert on Zero Value Transfers](https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers)\n\n**Example:**\n\n*   `order.baseAsset` is one of those weird ERC-20 tokens\n*   `order.strike = 999` (depending on the token decimals, a very small option position)\n*   `fee = 1` (0.1%)\n\n((999 &ast; 1) / 1000 = 0.999) rounded down to 0 -> zero-value transfer reverting transaction\n\n### Recommended Mitigation Steps\n\nAdd a simple check for zero-value token transfers:\n\n```solidity\n// send the fee to the admin/DAO if fee is greater than 0%\nuint256 feeAmount = 0;\nif (fee > 0) {\n    feeAmount = (order.strike * fee) / 1000;\n\n    if (feeAmount > 0) {\n        ERC20(order.baseAsset).safeTransfer(owner(), feeAmount);\n    }\n}\n```\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/283#issuecomment-1178998816):**\n > Report: withdraw() can be DOS’d for baseAsset ERC20s that prevent 0 transfers if the calculated feeAmount is 0 due to rounding.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/283#issuecomment-1185413905):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/4.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed along with [H-01](https://github.com/code-423n4/2022-06-putty-findings/issues/269) in [`PR#4`](https://github.com/outdoteth/putty-v2/pull/4).\n\n***\n\n## [[M-13] Order duration can be set to 0 by Malicious maker](https://github.com/code-423n4/2022-06-putty-findings/issues/107)\n_Submitted by codexploder, also found by ACai, cccz, Critical, horsefacts, ignacio, shenwilly, unforgiven, and xiaoming90_\n\nA malicious maker can set a minimum order duration as 0 which means order will instantly expire after filling. Taker will get only the withdraw option and that too with fees on strike price, thus forcing the taker to lose money in this meaningless transaction\n\n### Proof of Concept\n\n1. Maker creates an order with zero Order duration\n2. Taker fills this order but the order instantly expires since duration was 0\n3. Taker gets the only option to withdraw with fees on strike price\n\n### Recommended Mitigation Steps\n\nEnforce at least x days of duration.\n\n**[outdoteth (Putty Finance) confirmed and resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/107#issuecomment-1185407029):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/7.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed by requiring the minimal order duration of 15 minutes on filling.\n\n***\n\n## [[M-14] Order cancellation is prone to frontrunning and is dependent on a centralized database](https://github.com/code-423n4/2022-06-putty-findings/issues/186)\n_Submitted by shung, also found by unforgiven_\n\nOrder cancellation requires makers to call `cancel()`, inputting the order as a function parameter. This is the only cancellation method, and it can cause two issues.\n\nThis first issue is that it is an on-chain signal for MEV users to frontrun the cancellation and fill the order.\n\nThe second issue is the dependency to a centralized service for cancelling the order. As orders are signed off chain, they would be stored in a centralized database. It is unlikely that an end user would locally record all the orders they make. This means that when cancelling an order, maker needs to request the order parameters from the centralized service. If the centralized service goes offline, it could allow malicious parties who have a copy of the order database to fill orders that would have been cancelled otherwise.\n\n### Proof of Concept\n\n1.  Bob signs an order which gets recorded in Putty servers.\n2.  Alice mirrors all the orders using Putty APIs.\n3.  Putty servers go offline.\n4.  Bob wants to cancel his order because changing token prices makes his order less favourable to him.\n5.  Bob cannot cancel his order because Putty servers are down and he does not remember the exact amounts of tokens he used.\n6.  Alice goes through all the orders in her local mirror and fulfills the non-cancelled orders, including Bob's, with extremely favourable terms for herself.\n\n### Recommended Mitigation Steps\n\nAside from the standard order cancellation method, have an extra method to cancel all orders of a caller. This can be achieved using a \"minimum valid nonce\" state variable, as a mapping from user address to nonce.\n\n```solidity\nmapping(address => uint256) minimumValidNonce;\n```\n\nAllow users to increment their `minimumValidNonce`. Make sure the incrementation function do not allow incrementing more than `2**64` such that callers cannot lock themselves out of creating orders by increasing `minimumValidNonce` to `2**256-1` by mistake. Then, prevent filling orders if `order.nonce < minimumValidNonce`.\n\nAnother method to achieve bulk cancelling is using counters. For example, Seaport [uses counters](https://github.com/ProjectOpenSea/seaport/blob/171f2cd7faf13b2bf0455851499f1981274977f7/contracts/lib/CounterManager.sol), which is an extra order parameter that has to match the corresponding counter state variable. It allows maker to cancel all his orders by [incrementing the counter state variable by one](https://github.com/ProjectOpenSea/seaport/blob/171f2cd7faf13b2bf0455851499f1981274977f7/contracts/lib/Consideration.sol#L475-L478).\n\nEither of these extra cancellation methods would enable cancelling orders without signalling to MEV bots, and without a dependency to a centralized database.\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/186#issuecomment-1177567080):**\n > Should this be tagged as Med or Low? Funds are not directly at risk unless the centralised order book server goes down and loses all the data. Perhaps there is a non-negligible chance that this *could* happen. But even then, orders have an \"expiration\" field attached to them which will render them useless after some set time period. There are also easy fixes on the frontend, such as allowing users to download a txt file with their order/orderHash so that they don't have to rely on the centralised DB for data availability. \n> \n> But will defer to judges.\n>\n> Report: Cannot cancel orders without reliance on centralised database.\n\n**[HickupHH3 (judge) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/186#issuecomment-1184059122):**\n > The sponsor's point is valid: there is an expiration param that the maker signs as part of the order that marks its validity.\n> \n> However, the warden(s) concerns are valid too. While it is an edge case that is very unlikely to happen, there would arguably be a \"loss\" of assets of the maker because of the protocol's loss of functionality, as per the scenario described above. Hence, the medium severity rating is justified.\n> \n> I recommend implementing the warden's recommended fix; having a `minimumValidNonce` would be great in allowing easy on-chain cancellation of an order. It makes the system a little more trust-less and provides a \"red button\" option for makers to use if necessary.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/186#issuecomment-1185428778):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/10.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed by the introduction of `setMinimumValidNonce` function and the corresponding control on order filling. See [M.M-04](#mm-04-minimumvalidnonce-can-be-reduced-due-to-an-operational-mistake-enabling-old-orders) in the Mitigation Review below.\n\n***\n\n## [[M-15] Zero strike call options will avoid paying system fee](https://github.com/code-423n4/2022-06-putty-findings/issues/373)\n_Submitted by hyh, also found by csanuragjain, minhquanym, and Treasure-Seeker_\n\nZero and near zero strike calls are common derivative type. For such derivatives the system will not be receiving fees are the fee is now formulated as a fraction of order strike.\n\nAlso, it can be a problem for OTM call options, when the option itself is nearly worthless, while the fee will be substantial as strike will be big. Say 1k ETH BAYC call doesn't have much value, but the associated fee will be 10x of usual fee, i.e. substantial, while there is nothing to justify that.\n\nMarking this as medium severity as that's a design specifics that can turn off or distort core system fee gathering.\n\n### Proof of Concept\n\nCurrently fee is linked to the order strike which makes it vary heavily for different types of orders, for example deep ITM and OTM calls:\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L494-L506>\n\n```solidity\n        // transfer strike to owner if put is expired or call is exercised\n        if ((order.isCall && isExercised) || (!order.isCall && !isExercised)) {\n            // send the fee to the admin/DAO if fee is greater than 0%\n            uint256 feeAmount = 0;\n            if (fee > 0) {\n                feeAmount = (order.strike * fee) / 1000;\n                ERC20(order.baseAsset).safeTransfer(owner(), feeAmount);\n            }\n\n            ERC20(order.baseAsset).safeTransfer(msg.sender, order.strike - feeAmount);\n\n            return;\n        }\n```\n\n### Recommended Mitigation Steps\n\nConsider linking the fee to option premium as this is option value that cannot be easily manipulated and exactly corresponds to the trading volume of the system.\n\ni.e. consider moving fee gathering to fillOrder:\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L322-L340>\n\n```solidity\n        // transfer premium to whoever is short from whomever is long\n        if (order.isLong) {\n            ERC20(order.baseAsset).safeTransferFrom(order.maker, msg.sender, order.premium);\n        } else {\n            // handle the case where the user uses native ETH instead of WETH to pay the premium\n            if (weth == order.baseAsset && msg.value > 0) {\n                // check enough ETH was sent to cover the premium\n                require(msg.value == order.premium, \"Incorrect ETH amount sent\");\n\n                // convert ETH to WETH and send premium to maker\n                // converting to WETH instead of forwarding native ETH to the maker has two benefits;\n                // 1) active market makers will mostly be using WETH not native ETH\n                // 2) attack surface for re-entrancy is reduced\n                IWETH(weth).deposit{value: msg.value}();\n                IWETH(weth).transfer(order.maker, msg.value);\n            } else {\n                ERC20(order.baseAsset).safeTransferFrom(msg.sender, order.maker, order.premium);\n            }\n        }\n```\n\n**[Alex the Entreprenerd (warden) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/373#issuecomment-1174511995):**\n > Zero strike will indeed have a fee of 0.\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/373#issuecomment-1178994046):**\n > Report: Charging fees on the strike amount instead of the premium amount can lead to disproportionate fees.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/373#issuecomment-1185414345):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/4.\n\n**hyh (warden) reviewed mitigation:**\n > The same fix as in [H-01](https://github.com/code-423n4/2022-06-putty-findings/issues/269).\n\n***\n\n## [[M-16] Use of Solidity version 0.8.13 which has two known issues applicable to PuttyV2](https://github.com/code-423n4/2022-06-putty-findings/issues/348)\n_Submitted by hubble, also found by horsefacts_\n\nThe solidity version 0.8.13 has below two issues applicable to PuttyV2\n\n1.  Vulnerability related to ABI-encoding.\n\n    ref : <https://blog.soliditylang.org/2022/05/18/solidity-0.8.14-release-announcement/><br>\n    This vulnerability can be misused since the function hashOrder() and hashOppositeOrder() has applicable conditions.<br>\n    \"...pass a nested array directly to another external function call or use abi.encode on it.\"\n\n2.  Vulnerability related to 'Optimizer Bug Regarding Memory Side Effects of Inline Assembly'\n\n    ref : <https://blog.soliditylang.org/2022/06/15/solidity-0.8.15-release-announcement/><br>\n    PuttyV2 inherits solidity contracts from openzeppelin and solmate, and both these uses inline assembly, and optimization is enabled while compiling.\n\n### Recommended Mitigation Steps\n\nUse recent Solidity version 0.8.15 which has the fix for these issues.\n\n**[outdoteth (Putty Finance) confirmed and commented](https://github.com/code-423n4/2022-06-putty-findings/issues/348#issuecomment-1176607284):**\n > Great catch.\n\n > Report: Use of Solidity 0.8.13 with known issues in ABI encoding and memory side effects.\n\n**[outdoteth (Putty Finance) resolved](https://github.com/code-423n4/2022-06-putty-findings/issues/348#issuecomment-1185414140):**\n > PR with fix: https://github.com/outdoteth/putty-v2/pull/6.\n\n**hyh (warden) reviewed mitigation:**\n > Fixed by bumping the solidity version.\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 82 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-06-putty-findings/issues/306) by **xiaoming90** received the top score from the judge.\n\n*The following wardens also submitted reports: [reassor](https://github.com/code-423n4/2022-06-putty-findings/issues/153), [IllIllI](https://github.com/code-423n4/2022-06-putty-findings/issues/228), [sseefried](https://github.com/code-423n4/2022-06-putty-findings/issues/212), [BowTiedWardens](https://github.com/code-423n4/2022-06-putty-findings/issues/390), [0x1f8b](https://github.com/code-423n4/2022-06-putty-findings/issues/58), [joestakey](https://github.com/code-423n4/2022-06-putty-findings/issues/163), [zer0dot](https://github.com/code-423n4/2022-06-putty-findings/issues/193), [Alex the Entreprenerd](https://github.com/code-423n4/2022-06-putty-findings/issues/277), [0xDjango](https://github.com/code-423n4/2022-06-putty-findings/issues/31), [Chom](https://github.com/code-423n4/2022-06-putty-findings/issues/304), [shung](https://github.com/code-423n4/2022-06-putty-findings/issues/190), [&#95;&#95;141345&#95;&#95;](https://github.com/code-423n4/2022-06-putty-findings/issues/271), [0xNazgul](https://github.com/code-423n4/2022-06-putty-findings/issues/94), [hubble](https://github.com/code-423n4/2022-06-putty-findings/issues/428), [StErMi](https://github.com/code-423n4/2022-06-putty-findings/issues/199), [0xf15ers](https://github.com/code-423n4/2022-06-putty-findings/issues/317), [defsec](https://github.com/code-423n4/2022-06-putty-findings/issues/340), [zzzitron](https://github.com/code-423n4/2022-06-putty-findings/issues/378), [Lambda](https://github.com/code-423n4/2022-06-putty-findings/issues/45), [Metatron](https://github.com/code-423n4/2022-06-putty-findings/issues/429), [TomJ](https://github.com/code-423n4/2022-06-putty-findings/issues/309), [0xsanson](https://github.com/code-423n4/2022-06-putty-findings/issues/417), [danb](https://github.com/code-423n4/2022-06-putty-findings/issues/62), [Funen](https://github.com/code-423n4/2022-06-putty-findings/issues/412), [unforgiven](https://github.com/code-423n4/2022-06-putty-findings/issues/173), [cryptphi](https://github.com/code-423n4/2022-06-putty-findings/issues/374), [dirk_y](https://github.com/code-423n4/2022-06-putty-findings/issues/102), [TrungOre](https://github.com/code-423n4/2022-06-putty-findings/issues/281), [catchup](https://github.com/code-423n4/2022-06-putty-findings/issues/81), [horsefacts](https://github.com/code-423n4/2022-06-putty-findings/issues/330), [JohnSmith](https://github.com/code-423n4/2022-06-putty-findings/issues/74), [Picodes](https://github.com/code-423n4/2022-06-putty-findings/issues/393), [AmitN](https://github.com/code-423n4/2022-06-putty-findings/issues/73), [samruna](https://github.com/code-423n4/2022-06-putty-findings/issues/25), [antonttc](https://github.com/code-423n4/2022-06-putty-findings/issues/425), [async](https://github.com/code-423n4/2022-06-putty-findings/issues/264), [GimelSec](https://github.com/code-423n4/2022-06-putty-findings/issues/255), [hake](https://github.com/code-423n4/2022-06-putty-findings/issues/125), [Kaiziron](https://github.com/code-423n4/2022-06-putty-findings/issues/408), [Nethermind](https://github.com/code-423n4/2022-06-putty-findings/issues/396), [robee](https://github.com/code-423n4/2022-06-putty-findings/issues/99), [rokinot](https://github.com/code-423n4/2022-06-putty-findings/issues/195), [saneryee](https://github.com/code-423n4/2022-06-putty-findings/issues/236), [sashik_eth](https://github.com/code-423n4/2022-06-putty-findings/issues/358), [0x29A](https://github.com/code-423n4/2022-06-putty-findings/issues/261), [Bnke0x0](https://github.com/code-423n4/2022-06-putty-findings/issues/169), [Limbooo](https://github.com/code-423n4/2022-06-putty-findings/issues/293), [csanuragjain](https://github.com/code-423n4/2022-06-putty-findings/issues/407), [ElKu](https://github.com/code-423n4/2022-06-putty-findings/issues/240), [MadWookie](https://github.com/code-423n4/2022-06-putty-findings/issues/235), [Waze](https://github.com/code-423n4/2022-06-putty-findings/issues/168), [doddle0x](https://github.com/code-423n4/2022-06-putty-findings/issues/188), [0xNineDec](https://github.com/code-423n4/2022-06-putty-findings/issues/91), [datapunk](https://github.com/code-423n4/2022-06-putty-findings/issues/402), [gogo](https://github.com/code-423n4/2022-06-putty-findings/issues/307), [Kenshin](https://github.com/code-423n4/2022-06-putty-findings/issues/219), [MiloTruck](https://github.com/code-423n4/2022-06-putty-findings/issues/238), [shenwilly](https://github.com/code-423n4/2022-06-putty-findings/issues/233), [simon135](https://github.com/code-423n4/2022-06-putty-findings/issues/279), [fatherOfBlocks](https://github.com/code-423n4/2022-06-putty-findings/issues/71), [hansfriese](https://github.com/code-423n4/2022-06-putty-findings/issues/118), [JC](https://github.com/code-423n4/2022-06-putty-findings/issues/435), [oyc_109](https://github.com/code-423n4/2022-06-putty-findings/issues/10), [delfin454000](https://github.com/code-423n4/2022-06-putty-findings/issues/178), [0xSolus](https://github.com/code-423n4/2022-06-putty-findings/issues/184), [cccz](https://github.com/code-423n4/2022-06-putty-findings/issues/38), [durianSausage](https://github.com/code-423n4/2022-06-putty-findings/issues/24), [Hawkeye](https://github.com/code-423n4/2022-06-putty-findings/issues/181), [itsmeSTYJ](https://github.com/code-423n4/2022-06-putty-findings/issues/88), [pedroais](https://github.com/code-423n4/2022-06-putty-findings/issues/383), [peritoflores](https://github.com/code-423n4/2022-06-putty-findings/issues/338), [rajatbeladiya](https://github.com/code-423n4/2022-06-putty-findings/issues/210), [ReyAdmirado](https://github.com/code-423n4/2022-06-putty-findings/issues/289), [Yiko](https://github.com/code-423n4/2022-06-putty-findings/issues/14), [0x52](https://github.com/code-423n4/2022-06-putty-findings/issues/137), [_Adam](https://github.com/code-423n4/2022-06-putty-findings/issues/230), [aysha](https://github.com/code-423n4/2022-06-putty-findings/issues/399), [David_](https://github.com/code-423n4/2022-06-putty-findings/issues/5), [exd0tpy](https://github.com/code-423n4/2022-06-putty-findings/issues/160), [Sneakyninja0129](https://github.com/code-423n4/2022-06-putty-findings/issues/198), and [Treasure-Seeker](https://github.com/code-423n4/2022-06-putty-findings/issues/18).*\n\n## Codebase Summary & Key Improvement Opportunities\n\n### Key Features\n\nThe in-scope system was found to be low in complexity, with the key features being as follows:\n\n*   fillOrder - Fills an offchain order\n*   exercise - Exercise a long order\n*   withdraw - Withdraws the assets from a short order\n*   cancel - Cancels an order which prevents it from being filled in the future\n\n### Code Quality and Test Coverage\n\nIn sumamry, the code quality of the PuttyV2 is high. The codes were also found to be well-documented and team took the efforts to document the NatSpec for all the functions within the `PuttyV2` contract. However, there are still some room of improvement as NatSpec was not documented for the `PuttyV2Nft` contract. For completeness and readability, it is recommended to document the NatSpec for all the functions in the contracts where feasible.\n\nTo futher improve readability of the codes, additional helper functions could be implemented. Refer to the \"4.6 Code Can Be Refactored To Be More Readable\" issue.\n\nTest coverage was found to be high. All the key features have been covered in the test. However, periphery logic functions such as `batchFillOrder` and `acceptCounterOffer` that are exposed to the public users were not included in the tests. It is recommended to write proper tests for all functions.\n\n### Unexpected Token Behaviors\n\nThe system did not implement a whitelisting mechanism to ensure that only approved tokens are allowed to be traded within Putty. Thus, users could specify any tokens within an order/option. This permissionless approach increases the attack surface of the system and exposes the system to various attack vectors. Some tokens might be malicious, some tokens might contain hooks, and some tokens might not work as intended. Thus, it is challenging for Putty to guard against all kinds of vulnerabilites that arise due to the need to support large number of tokens. If possible, it is recommended to only allow approved tokens that have been vetted and reviewed by Putty to be traded within the system to minimize the risks during the initial stage. Once the system is more stable, the team can progressively open up to more tokens.\n\n### Re-entrancy Risks\n\nThe key features (e.g. fillOrder, exercise) were found to be following the \"Checks Effects Interactions\" pattern rigorously, which help to prevent any possible re-entrancy attack. However, further improvement can be made to guard against future re-entrancy attack. As the key features make many external contract calls via token transfers, the risks of re-entrancy attack is significantly higher for Putty compared to other protocols. Thus, it is prudent to implement additional reentrancy prevention wherever possible by utilizing the nonReentrant modifier from [Openzeppelin Library](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol) to block possible re-entrancy as a defense-in-depth measure.\n\n### Out-of-gas/Revert Risks\n\nThe order contains many arrays such as `whitelist`, `floorTokens`, `erc20Assets`, and `erc721Assets`. It was found that the contract did not place an upper limit on the number of elements that can be stored within the array, and proceed to loop through all the elements within an array in many parts of the codes. This might cause out-of-gas error to happen and cause a revert, thus causing the feature to be unusable in certain scenarios. It is recommended for the team to review each of the loop structures involving an array within the contract to determine if it is possible to place an upper limit.\n\n### Authorisation Controls\n\nRobust authorisation controls have been implemented for all the key features to ensure that only authorised and correct actors could call the functions. For instance, only owner of long position could call the `exercise` function and only owner of short position could call the `withdraw` function. No authorisation issues were observed during the contest.\n\n## Summary Of Findings\n\nThe following is a summary of the low and non-critical findings observed during the contest.\n\n| No. | Title                                                                                          | Risk Rating  |\n| --- | ---------------------------------------------------------------------------------------------- | ------------ |\n| L-01 | Lack Of Reentrancy Guards On External Functions                                                | Low          |\n| L-02 | Discontinuity in Exercise Period                                                               | Low          |\n| L-03 | Insufficient Input Validation                                                                  | Low          |\n| L-04 | Order Cannot Be Filled Due To Unbounded Whitelist Within An Order                              | Low          |\n| L-05 | Order Cannot Be Filled Due To Unbounded floorTokens, ERC20Asset Or ERC721Asset Within An Order | Low          |\n| L-06 | Order Can Be Cancelled Even After Being Filled                                                 | Low          |\n| L-07 | No Check if onERC721Received Is Implemented                                                    | Low          |\n| N-01 | Omissions in events                                                                            | Non-Critical |\n| N-02 | Draft OpenZeppelin Dependencies                                                                | Non-Critical |\n| N-03 | Insufficient Tests                                                                             | Non-Critical |\n| N-04 | Owner Can Renounce Ownership                                                                   | Non-Critical |\n| N-05 | Consider two-phase ownership transfer                                                          | Non-Critical |\n| N-06 | Code Can Be Refactored To Be More Readable                                                     | Non-Critical |\n| N-07 | Inconsistent use of named return variables                                                     | Non-Critical |\n| N-08 | Unused imports                                                                                 | Non-Critical |\n| N-09 | Incorrect functions visibility                                                                 | Non-Critical |\n\n## [L-01] Lack Of Reentrancy Guards On External Functions\n\nThe following external functions within the `PuttyV2` contract contain function calls (e.g.  `safeTransferFrom`, `safeTransfer`) that pass control to external contracts. Additionally, if ERC777 tokens are being used within an order, it contains various hooks that will pass the execution control to the external party.\n\nThus, it might allow an malicious external contract to re-enter to the contract.\n\n*   `PuttyV2.fillorder`\n*   `PuttyV2.exercise`\n*   `PuttyV2.withdraw`\n*   `PuttyV2.batchFillOrder`\n*   `Putty.acceptCounterOffer`\n\nNo re-entrancy attacks that could lead to loss of assets were observed during the assessment. Thus, this issue is marked as Low.\n\nThe following shows examples of function call being made to an external contract\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L324>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L436>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L451>\n\n### Recommendation\n\nIt is recommended to follow the good security practices and apply necessary reentrancy prevention by utilizing the nonReentrant modifier from [Openzeppelin Library](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol) to block possible re-entrancy.\n\n## [L-02] Discontinuity in Exercise Period\n\nThe position can be exercised if current block timestamp is less than the position's expiration.\n\nThe position can be withdrawed if current block timestamp is greater than the position's expiration\n\nHowever, when current block timestamp is equal to the position's expiration (`block.timestamp == positionExpirations`), the state is unknown (cannot be exercised or withdraw)\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L401>\n\n```solidity\nfunction exercise(Order memory order, uint256[] calldata floorAssetTokenIds) public payable {\n    ..SNIP..\n    // check position has not expired\n    require(block.timestamp < positionExpirations[uint256(orderHash)], \"Position has expired\");\n    ..SNIP..\n}\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L481>\n\n```solidity\nfunction withdraw(Order memory order) public {\n    ..SNIP..\n    // check long position has either been exercised or is expired\n    require(block.timestamp > positionExpirations[longPositionId] || isExercised, \"Must be exercised or expired\");\n    ..SNIP..\n}\n```\n\n### Recommendation\n\nAllow the user to withdraw the position upon expiration.\n\n```solidity\nfunction withdraw(Order memory order) public {\n    ..SNIP..\n    // check long position has either been exercised or is expired\n    require(block.timestamp >= positionExpirations[longPositionId] || isExercised, \"Must be exercised or expired\");\n    ..SNIP..\n}\n```\n\n## [L-03] Insufficient Input Validation\n\nThe `PuttyV2.fillOrder` function does not validate that the `msg.sender` (order taker) is the same as the order maker, which might potentially lead to unwanted behaviour within the system. Order taker should not be the same as order maker under any circumstances.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L268>\n\n```solidity\n    function fillOrder(\n        Order memory order,\n        bytes calldata signature,\n        uint256[] memory floorAssetTokenIds\n    ) public payable returns (uint256 positionId) {\n        /* ~~~ CHECKS ~~~ */\n\n        bytes32 orderHash = hashOrder(order);\n\n        // check signature is valid using EIP-712\n        require(SignatureChecker.isValidSignatureNow(order.maker, orderHash, signature), \"Invalid signature\");\n\n        // check order is not cancelled\n        require(!cancelledOrders[orderHash], \"Order has been cancelled\");\n\n        // check msg.sender is allowed to fill the order\n        require(order.whitelist.length == 0 || isWhitelisted(order.whitelist, msg.sender), \"Not whitelisted\");\n\n        // check duration is valid\n        require(order.duration < 10_000 days, \"Duration too long\");\n\n        // check order has not expired\n        require(block.timestamp < order.expiration, \"Order has expired\");\n\n        // check base asset exists\n        require(order.baseAsset.code.length > 0, \"baseAsset is not contract\");\n```\n\n### Recommendation\n\nImplement the necessary check to ensure that order taker is not the same as order maker.\n\n```solidity\nrequire(msg.sender != order.maker, \"Invalid order taker\");\n```\n\n## [L-04] Order Cannot Be Filled Due To Unbounded Whitelist Within An Order\n\nAn order can contain large number of addresses within the `whitelist` array of an order.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L78>\n\n```solidity\nstruct Order {\n    address maker;\n    bool isCall;\n    bool isLong;\n    address baseAsset;\n    uint256 strike;\n    uint256 premium;\n    uint256 duration;\n    uint256 expiration;\n    uint256 nonce;\n    address[] whitelist;\n    address[] floorTokens;\n    ERC20Asset[] erc20Assets;\n    ERC721Asset[] erc721Assets;\n}\n```\n\nWhen the `PuttyV2.fillOrder` function is called, it will attempt to check if the caller is whitelisted by looping through the `order.whitelist` array. However, if `order.whitelist` array contains large number of addresses, it will result in out-of-gas error and cause a revert. Thus, this order can never be filled.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L284>\n\n```solidity\nfunction fillOrder(\n    Order memory order,\n    bytes calldata signature,\n    uint256[] memory floorAssetTokenIds\n) public payable returns (uint256 positionId) { // @audit-issue no re-entrancy guard\n\t..SNIP..\n    // check msg.sender is allowed to fill the order\n    require(order.whitelist.length == 0 || isWhitelisted(order.whitelist, msg.sender), \"Not whitelisted\");\n\t..SNIP..\n}\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L669>\n\n```solidity\nfunction isWhitelisted(address[] memory whitelist, address target) public pure returns (bool) {\n    for (uint256 i = 0; i < whitelist.length; i++) {\n        if (target == whitelist[i]) return true;\n    }\n\n    return false;\n}\n```\n\n### Recommendation\n\nIt is recommended to restrict the number of whitelisted addresses within an order to a upper limit (e.g. 30).\n\nAlthough client-side or off-chain might have already verified that the number of whitelisted addresses do not exceed a certain limit within an order, simply relying on client-side and off-chain validations are not sufficient. It is possible for an attacker to bypass the client-side and off-chain validations and interact directly with the contract. Thus, such validation must also be implemented on the on-chain contracts.\n\n## [L-05] Order Cannot Be Filled Due To Unbounded floorTokens, ERC20Asset Or ERC721Asset Within An Order\n\nAn order can contain large number of tokens within the `floorTokens`, `ERC20Asset` or `ERC721Asset` arrays of an order.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L78>\n\n```solidity\nstruct Order {\n    address maker;\n    bool isCall;\n    bool isLong;\n    address baseAsset;\n    uint256 strike;\n    uint256 premium;\n    uint256 duration;\n    uint256 expiration;\n    uint256 nonce;\n    address[] whitelist;\n    address[] floorTokens;\n    ERC20Asset[] erc20Assets;\n    ERC721Asset[] erc721Assets;\n}\n```\n\nWhen the `PuttyV2.fillOrder` function is called, it will attempts to loop through all the `floorTokens`, `ERC20Asset` or `ERC721Asset` arrays of an order to transfer the required assets to `PuttyV2` contract from the order maker or taker.\n\nThe [`_transferERC20sIn`](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L593), [`_transferERC721sIn`](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L610), [`_transferFloorsIn`](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L622) attempt to loop through all the tokens within the array. However, if array contains large number of tokens, it will result in out-of-gas error and cause a revert. Thus, this order can never be filled.\n\nFollowing is an example of the vulnerable function.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L593>\n\n```solidity\nfunction _transferERC20sIn(ERC20Asset[] memory assets, address from) internal {\n    for (uint256 i = 0; i < assets.length; i++) {\n        address token = assets[i].token;\n        uint256 tokenAmount = assets[i].tokenAmount;\n\n        require(token.code.length > 0, \"ERC20: Token is not contract\");\n        require(tokenAmount > 0, \"ERC20: Amount too small\");\n\n        ERC20(token).safeTransferFrom(from, address(this), tokenAmount);\n    }\n}\n```\n\n### Recommendation\n\nIt is recommended to restrict the number of tokens  within the `floorTokens`, `ERC20Asset` or `ERC721Asset` arrays of an order. (e.g. Maximum of 10 tokens)\n\nAlthough client-side or off-chain might have already verified that the number of tokens do not exceed a certain limit within an order, simply relying on client-side and off-chain validations are not sufficient. It is possible for an attacker to bypass the client-side and off-chain validations and interact directly with the contract. Thus, such validation must also be implemented on the on-chain contracts.\n\n## [L-06] Order Can Be Cancelled Even After Being Filled\n\nOnce an order has been filled, no one should be able to cancel the order or mark the order as `Cancelled`.\n\nThe following code shows that the order maker can change the status of the order to `Cancelled` at any point of time.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L526>\n\n```solidity\n/**\n    @notice Cancels an order which prevents it from being filled in the future.\n    @param order The order to cancel.\n */\nfunction cancel(Order memory order) public {\n    require(msg.sender == order.maker, \"Not your order\");\n\n    bytes32 orderHash = hashOrder(order);\n\n    // mark the order as cancelled\n    cancelledOrders[orderHash] = true;\n\n    emit CancelledOrder(orderHash, order);\n}\n```\n\nAlthough changing the status of an order to `Cancelled` after it has been filled does not cause any lost of funds at the later stages (e.g. when exercising or withdrawing), it might cause unnecessary confusion to the users as it does not accurately reflect the status of an order on-chain.\n\nUsers might fetch the status of an order directly from the `cancelledOrders` mapping or poll the on-chain for emitted event, and come to a wrong conclusion that since the order has been cancelled, it has not been filled.\n\n### Recommendation\n\nIt is recommended to update the `cancel` function to only allow order maker to call this function only if an order has not been filled.\n\n```solidity\nfunction cancel(Order memory order) public {\n    require(msg.sender == order.maker, \"Not your order\");\n\n    bytes32 orderHash = hashOrder(order);\n    \n    // If an order has been filled, the positionExpirations[orderHash] will be populated.\n    require(positionExpirations[orderHash] == 0, \"Order has already been filled. Cannot cancel.\")\n\n    // mark the order as cancelled\n    cancelledOrders[orderHash] = true;\n\n    emit CancelledOrder(orderHash, order);\n}\n```\n\n## [L-07] No Check if onERC721Received Is Implemented\n\nThe `PuttyV2.fillOrder` will mint a long position NFT and short position NFT to the order maker and taker. When minting a NFT, the function does not check if a receiving contract implements onERC721Received().\n\nThe intention behind this function is to check if the address receiving the NFT, if it is a contract, implements onERC721Received(). Thus, there is no check whether the receiving address supports ERC-721 tokens and position could be not transferrable in some cases.\n\nFollowing shows that `_mint` is used instead of `_safeMint`.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L303>\n\n```solidity\nfunction fillOrder(\n\tOrder memory order,\n\tbytes calldata signature,\n\tuint256[] memory floorAssetTokenIds\n) public payable returns (uint256 positionId) {\n\t..SNIP..\n\t// create long/short position for maker\n\t_mint(order.maker, uint256(orderHash));\n\n\t// create opposite long/short position for taker\n\tbytes32 oppositeOrderHash = hashOppositeOrder(order);\n\tpositionId = uint256(oppositeOrderHash);\n\t_mint(msg.sender, positionId);\n\t..SNIP..\n```\n\n### Recommendation\n\nConsider using [`_safeMint`](https://github.com/Rari-Capital/solmate/blob/3c738133a0c1697096d63d28ef7a8ef298f9af6b/src/tokens/ERC721.sol#L193) instead of [`_mint`](https://github.com/Rari-Capital/solmate/blob/3c738133a0c1697096d63d28ef7a8ef298f9af6b/src/tokens/ERC721.sol#L157).\n\n## [N-01] Omissions in events\n\nThroughout the codebase, events are generally emitted when sensitive changes are made to the contracts. However, some events are missing important parameters\n\n#### Instance #1 - Missing Old Value\n\nWhen setting a new `baseURI` and `fee`, only the new value is emitted within the event.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L228>\n\n```solidity\nfunction setBaseURI(string memory _baseURI) public payable onlyOwner {\n    baseURI = _baseURI;\n    emit NewBaseURI(_baseURI);\n}\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L240>\n\n```solidity\nfunction setFee(uint256 _fee) public payable onlyOwner {\n    require(_fee < 30, \"fee must be less than 3%\");\n    fee = _fee;\n    emit NewFee(_fee);\n}\n```\n\nThe events should include the new value and old value where possible.\n\n## [N-02] Draft OpenZeppelin Dependencies\n\nThe `PuttyV2` contract utilised `draft-EIP712` , an OpenZeppelin contract. This contract is still a draft and is not considered ready for mainnet use. OpenZeppelin contracts may be considered draft contracts if they have not received adequate security auditing or are liable to change with future development.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L40>\n\n```solidity\nimport \"openzeppelin/utils/cryptography/SignatureChecker.sol\";\nimport \"openzeppelin/utils/cryptography/draft-EIP712.sol\";\nimport \"openzeppelin/utils/Strings.sol\";\n```\n\n### Recommendation\n\nEnsure the development team is aware of the risks of using a draft contract or consider waiting until the contract is finalised.\n\nOtherwise, make sure that development team are aware of the risks of using a draft OpenZeppelin contract and accept the risk-benefit trade-off.\n\n## [N-03] Insufficient Tests\n\nIt is crucial to write tests with possibly 100% coverage for smart contract systems.\n\nThe following functions were found to be not included in the test cases:\n\n*   `PuttyV2.batchFillOrder` - <https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L546>\n*   `PuttyV2.acceptCounterOffer` - <https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L573>\n\n### Recommendation\n\nIt is recommended to write proper tests for all possible code flows and specially edge cases\n\n## [N-04] Owner Can Renounce Ownership\n\nTypically, the contract’s owner is the account that deploys the contract. As a result, the owner is able to perform certain privileged activities.\n\nThe Openzeppelin's `Ownable` used in `PuttyV2` contract implements `renounceOwnership`. This can represent a certain risk if the ownership is renounced for any other reason than by design. Renouncing ownership will leave the contract without an owner, thereby removing any functionality that is only available to the owner.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L53>\n\n```solidity\n/**\n    @title PuttyV2\n    @author out.eth\n    @notice An otc erc721 and erc20 option market.\n */\ncontract PuttyV2 is PuttyV2Nft, EIP712(\"Putty\", \"2.0\"), ERC721TokenReceiver, Ownable {\n```\n\n### Recommendation\n\nWe recommend to either reimplement the function to disable it or to clearly specify if it is part of the contract design\n\n## [N-05] Consider two-phase ownership transfer\n\nAdmin calls `Ownable.transferOwnership` function to transfers the ownership to the new address directly. As such, there is a risk that the ownership is transferred to an invalid address, thus causing the contract to be without a owner.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L53>\n\n```solidity\ncontract PuttyV2 is PuttyV2Nft, EIP712(\"Putty\", \"2.0\"), ERC721TokenReceiver, Ownable {\n```\n\n### Recommendation\n\nConsider implementing a two step process where the admin nominates an account and the nominated account needs to call an acceptOwnership() function for the transfer of admin to fully succeed. This ensures the nominated EOA account is a valid and active account.\n\n## [N-06] Code Can Be Refactored To Be More Readable\n\nIn many parts of the `PuttyV2` contract, it uses the following conditions to check the type of the order being passed into the function:\n\n*   order.isLong && order.isCall (equal to long call)\n*   order.isLong && !order.isCall (equal to long put)\n*   order.!isLong && order.isCall (equal to short call)\n*   order.!isLong && order.!isCall (equal to short put)\n\nThese affect the readability of the codes as the readers have to interpret the condition to determine if it is a \"long call\", \"long put\", \"short call\" or \"short put\". This might increase the risk of mistakes in the future if new developer works on the contracts.\n\n### Recommendation\n\nConsider implementing the following functions to improve readability:\n\n*   isLongCall(Order order) public view returns (bool)\n*   isLongPut(Order order) public view returns (bool)\n*   isShortCall(Order order) public view returns (bool)\n*   isShortPut(Order order) public view returns (bool)\n\n## [N-07] Inconsistent use of named return variables\n\nThere is an inconsistent use of named return variables in the `PuttyV2` contract\n\nSome functions return named variables, others return explicit values.\n\nFollowing function return explicit value\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L669>\n\n```solidity\nfunction isWhitelisted(address[] memory whitelist, address target) public pure returns (bool) {\n    for (uint256 i = 0; i < whitelist.length; i++) {\n        if (target == whitelist[i]) return true;\n    }\n\n    return false;\n}\n```\n\nFollowing function return return a named variable\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L683>\n\n```solidity\nfunction hashOppositeOrder(Order memory order) public view returns (bytes32 orderHash) {\n    // use decode/encode to get a copy instead of reference\n    Order memory oppositeOrder = abi.decode(abi.encode(order), (Order));\n\n    // get the opposite side of the order (short/long)\n    oppositeOrder.isLong = !order.isLong;\n    orderHash = hashOrder(oppositeOrder);\n}\n```\n\n### Recommendation\n\nConsider adopting a consistent approach to return values throughout the codebase by removing all named return variables, explicitly declaring them as local variables, and adding the necessary return statements where appropriate. This would improve both the explicitness and readability of the code, and it may also help reduce regressions during future code refactors.\n\n## [N-08] Unused imports\n\nTo improve readability and avoid confusion, consider removing the following unused imports:\n\nIn the `PuttyV2Nft` contract:\n\n*   openzeppelin/utils/Strings.sol\n\nNote that the `Strings.sol` has already been imported in `PuttyV2` contract. Thus, this import can be safely removed.\n\nWithin the `PuttyV2Nft` contract, it does not use any of the functions from `Strings.sol`.\n\n### Recommendation\n\nConsider removing the unused import if it is not required.\n\n## [N-09] Incorrect functions visibility\n\nWhenever a function is not being called internally in the code, it can be easily declared as `external`, [saving also gas](https://github.com/crytic/slither/wiki/Detector-Documentation#description-44). While the entire code base have explicit visibilities for every function, some of them can be changed to be `external`.\n\nFollowing are some the functions that can be changed to be `external`\n\n*   `PuttyV2.fillorder`\n*   `PuttyV2.exercise`\n*   `PuttyV2.withdraw`\n*   `PuttyV2.batchFillOrder`\n*   `Putty.acceptCounterOffer`\n\n### Recommendation\n\nReview the visibility of the affected functions and change visibility of these functions to `external`.\n\n## [N-10] NatSpec Is Missing\n\nNatSpec if missing for the following function\n\n*   `PuttyV2Nft._mint`  - <https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L11>\n*   `PuttyV2Nft.transferFrom` - <https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L21>\n*   `PuttyV2Nft.balanceOf` - <https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2Nft.sol#L40>\n\n### Recommendation\n\nImplement NatSpec for all functions.\n\n**[outdoteth (Putty Finance) commented](https://github.com/code-423n4/2022-06-putty-findings/issues/306#issuecomment-1178063479):**\n > High quality report.\n\n**[HickupHH3 commented](https://github.com/code-423n4/2022-06-putty-findings/issues/306#issuecomment-1186102954):**\n> > L-03 Insufficient Input Validation\n> \n> Disagree, I remember seeing there was a use case for having taker == maker discussed in 1 of the issues somewhere.\n> \n> > L-04 Order Cannot Be Filled Due To Unbounded Whitelist Within An Order\n> \n> Sort a duplicate of #290.\n> \n> Agree that overall it is a very good report! \n\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 94 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-06-putty-findings/issues/280) by **Alex the Entreprenerd** received the top score from the judge.\n\n*The following wardens also submitted reports: [0xA5DF](https://github.com/code-423n4/2022-06-putty-findings/issues/217), [IllIllI](https://github.com/code-423n4/2022-06-putty-findings/issues/229), [0x1f8b](https://github.com/code-423n4/2022-06-putty-findings/issues/43), [defsec](https://github.com/code-423n4/2022-06-putty-findings/issues/381), [TerrierLover](https://github.com/code-423n4/2022-06-putty-findings/issues/430), [0xf15ers](https://github.com/code-423n4/2022-06-putty-findings/issues/315), [Bnke0x0](https://github.com/code-423n4/2022-06-putty-findings/issues/100), [0xkatana](https://github.com/code-423n4/2022-06-putty-findings/issues/204), [ElKu](https://github.com/code-423n4/2022-06-putty-findings/issues/239), [joestakey](https://github.com/code-423n4/2022-06-putty-findings/issues/162), [MiloTruck](https://github.com/code-423n4/2022-06-putty-findings/issues/237), [0xNazgul](https://github.com/code-423n4/2022-06-putty-findings/issues/93), [0xsanson](https://github.com/code-423n4/2022-06-putty-findings/issues/424), [gogo](https://github.com/code-423n4/2022-06-putty-findings/issues/379), [grrwahrr](https://github.com/code-423n4/2022-06-putty-findings/issues/213), [JohnSmith](https://github.com/code-423n4/2022-06-putty-findings/issues/75), [TomJ](https://github.com/code-423n4/2022-06-putty-findings/issues/270), [simon135](https://github.com/code-423n4/2022-06-putty-findings/issues/274), [_Adam](https://github.com/code-423n4/2022-06-putty-findings/issues/194), [0xKitsune](https://github.com/code-423n4/2022-06-putty-findings/issues/59), [Metatron](https://github.com/code-423n4/2022-06-putty-findings/issues/413), [RedOneN](https://github.com/code-423n4/2022-06-putty-findings/issues/334), [sashik_eth](https://github.com/code-423n4/2022-06-putty-findings/issues/313), [JC](https://github.com/code-423n4/2022-06-putty-findings/issues/432), [rokinot](https://github.com/code-423n4/2022-06-putty-findings/issues/182), [UnusualTurtle](https://github.com/code-423n4/2022-06-putty-findings/issues/364), [&#95;&#95;141345&#95;&#95;](https://github.com/code-423n4/2022-06-putty-findings/issues/272), [Aymen0909](https://github.com/code-423n4/2022-06-putty-findings/issues/241), [PwnedNoMore](https://github.com/code-423n4/2022-06-putty-findings/issues/78), [saian](https://github.com/code-423n4/2022-06-putty-findings/issues/335), [Tomio](https://github.com/code-423n4/2022-06-putty-findings/issues/26), [rfa](https://github.com/code-423n4/2022-06-putty-findings/issues/391), [zer0dot](https://github.com/code-423n4/2022-06-putty-findings/issues/191), [0xc0ffEE](https://github.com/code-423n4/2022-06-putty-findings/issues/351), [BowTiedWardens](https://github.com/code-423n4/2022-06-putty-findings/issues/403), [c3phas](https://github.com/code-423n4/2022-06-putty-findings/issues/423), [hansfriese](https://github.com/code-423n4/2022-06-putty-findings/issues/119), [jayfromthe13th](https://github.com/code-423n4/2022-06-putty-findings/issues/344), [Limbooo](https://github.com/code-423n4/2022-06-putty-findings/issues/292), [Picodes](https://github.com/code-423n4/2022-06-putty-findings/issues/392), [ReyAdmirado](https://github.com/code-423n4/2022-06-putty-findings/issues/288), [swit](https://github.com/code-423n4/2022-06-putty-findings/issues/189), [Waze](https://github.com/code-423n4/2022-06-putty-findings/issues/166), [z3s](https://github.com/code-423n4/2022-06-putty-findings/issues/268), [durianSausage](https://github.com/code-423n4/2022-06-putty-findings/issues/23), [fatherOfBlocks](https://github.com/code-423n4/2022-06-putty-findings/issues/70), [oyc_109](https://github.com/code-423n4/2022-06-putty-findings/issues/9), [reassor](https://github.com/code-423n4/2022-06-putty-findings/issues/154), [0v3rf10w](https://github.com/code-423n4/2022-06-putty-findings/issues/337), [0xNineDec](https://github.com/code-423n4/2022-06-putty-findings/issues/92), [ajtra](https://github.com/code-423n4/2022-06-putty-findings/issues/420), [ak1](https://github.com/code-423n4/2022-06-putty-findings/issues/366), [catchup](https://github.com/code-423n4/2022-06-putty-findings/issues/84), [delfin454000](https://github.com/code-423n4/2022-06-putty-findings/issues/177), [Fitraldys](https://github.com/code-423n4/2022-06-putty-findings/issues/343), [Funen](https://github.com/code-423n4/2022-06-putty-findings/issues/411), [horsefacts](https://github.com/code-423n4/2022-06-putty-findings/issues/331), [Kenshin](https://github.com/code-423n4/2022-06-putty-findings/issues/220), [m_Rassska](https://github.com/code-423n4/2022-06-putty-findings/issues/41), [mektigboy](https://github.com/code-423n4/2022-06-putty-findings/issues/398), [mrpathfindr](https://github.com/code-423n4/2022-06-putty-findings/issues/180), [natzuu](https://github.com/code-423n4/2022-06-putty-findings/issues/385), [Randyyy](https://github.com/code-423n4/2022-06-putty-findings/issues/329), [slywaters](https://github.com/code-423n4/2022-06-putty-findings/issues/187), [Sm4rty](https://github.com/code-423n4/2022-06-putty-findings/issues/320), [StErMi](https://github.com/code-423n4/2022-06-putty-findings/issues/200), [Kaiziron](https://github.com/code-423n4/2022-06-putty-findings/issues/384), [MadWookie](https://github.com/code-423n4/2022-06-putty-findings/issues/234), [sach1r0](https://github.com/code-423n4/2022-06-putty-findings/issues/42), [ACai](https://github.com/code-423n4/2022-06-putty-findings/issues/142), [Chom](https://github.com/code-423n4/2022-06-putty-findings/issues/314), [cRat1st0s](https://github.com/code-423n4/2022-06-putty-findings/issues/146), [ladboy233](https://github.com/code-423n4/2022-06-putty-findings/issues/111), [Lambda](https://github.com/code-423n4/2022-06-putty-findings/issues/46), [rajatbeladiya](https://github.com/code-423n4/2022-06-putty-findings/issues/214), [zeesaw](https://github.com/code-423n4/2022-06-putty-findings/issues/147), [cryptphi](https://github.com/code-423n4/2022-06-putty-findings/issues/409), [datapunk](https://github.com/code-423n4/2022-06-putty-findings/issues/419), [Hawkeye](https://github.com/code-423n4/2022-06-putty-findings/issues/179), [ignacio](https://github.com/code-423n4/2022-06-putty-findings/issues/2), [minhquanym](https://github.com/code-423n4/2022-06-putty-findings/issues/262), [0xDjango](https://github.com/code-423n4/2022-06-putty-findings/issues/32), [0xHarry](https://github.com/code-423n4/2022-06-putty-findings/issues/167), [apostle0x01](https://github.com/code-423n4/2022-06-putty-findings/issues/86), [asutorufos](https://github.com/code-423n4/2022-06-putty-findings/issues/312), [codetilda](https://github.com/code-423n4/2022-06-putty-findings/issues/218), [exd0tpy](https://github.com/code-423n4/2022-06-putty-findings/issues/159), [hake](https://github.com/code-423n4/2022-06-putty-findings/issues/126), [Haruxe](https://github.com/code-423n4/2022-06-putty-findings/issues/103), [robee](https://github.com/code-423n4/2022-06-putty-findings/issues/98), [Ruhum](https://github.com/code-423n4/2022-06-putty-findings/issues/150), [StyxRave](https://github.com/code-423n4/2022-06-putty-findings/issues/415), and [Yiko](https://github.com/code-423n4/2022-06-putty-findings/issues/15).*\n\n## Executive Summary\n\nThe codebase is already pretty well thought out, by extending the idea of using ERC721 IDs as identifiers, we can save massive amount of gas for day to day operations, we can also apply a few basic logic transformations as well as basic gas saving tips to reduce the total gas for the average operation by over 20k gas\n\nThe first few refactoring will offer strong gas savings with minimal work (20k+ gas), the remaining findings are minor and I expect most other wardens to also be suggesting them\n\n### Massive Gas Savings in `exercise` by removing `exercisedPositions` - Around 20k gas on every `exercise` (17k to 23k from foundry tests)\n\nIt seems like `exercisedPositions` is used exclusively for `withdraw`, however through the cleverly designed \"send to 0xdead\" system, we can replace the `exercisedPositions` function with the following\n\n        function exercisedPositions(uint256 id) external view returns(bool) {\n            return ownerOf(id) == address(0xdead);\n        }\n\nIn fact, a position was exercised if it was transfered to 0xdead, as such there's no need to store a mapping in storage.\n\nWe can delete every mention of `exercisedPositions` as well as the storage mapping\n\nThis single change will reduce almost 20k gas from `exercise`\n\nTo make `withdraw` work we can write the following\n\n```solidity\n        // Inlined is even cheaper (8 gas for the JUMP)\n        bool isExercised = ownerOf(uint256(longPositionId)) == address(0xdead);\n```\n\nAnd we can delete the `exercisedPositions` mapping from the contract\n\nYou can use the function above so the test still passes, in case you need a way to verify if a position was exercised, otherwise you can just use the `isExercised` line and delete very other mention of `exercisedPositions`\n\n#### Gas Math\n\nBEFORE\nexercise                   ┆ 5759            ┆ 55920  ┆ 68002  ┆ 133534 ┆ 18\\\nwithdraw                   ┆ 3075            ┆ 27840  ┆ 24545  ┆ 71168  ┆ 10\n\nAFTER\nexercise                   ┆ 5759            ┆ 42356  ┆ 45806  ┆ 115777 ┆ 18\nwithdraw                   ┆ 3075            ┆ 26968  ┆ 23807  ┆ 70836  ┆ 10\n\n#### Diff\n\n```bash\n155c155,157\n<     mapping(uint256 => bool) public exercisedPositions;\n---\n>     function exercisedPositions(uint256 id) external view returns(bool) {\n>         return ownerOf(id) == address(0xdead);\n>     }\n415,417d416\n<         // mark the position as exercised\n<         exercisedPositions[uint256(orderHash)] = true;\n< \n478c477\n<         bool isExercised = exercisedPositions[longPositionId];\n---\n>         bool isExercised = ownerOf(longPositionId) == address(0xdead);\n```\n\n### Avoid a SLOAD optimistically - 2.1k gas saved\n\nBecause you already computed `isExercised`, you can save an SLOAD (2.1k gas) if you check for `isExercised` first.\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L481-L482>\n\n```solidity\n        require(block.timestamp > positionExpirations[longPositionId] || isExercised, \"Must be exercised or expired\");\n\n```\n\nYou could also refactor to the reverse check (if you expect the majority of positions to expire worthless), either way the short circuit can be used to save a SLOAD, whicever priority you give it\n\n#### Change to\n\n```solidity\n        require(isExercised || block.timestamp > positionExpirations[longPositionId], \"Must be exercised or expired\");\n```\n\nTo save 2.1k gas if the option was exercised\n\n### Double SLOAD - 94 gas saved\n\nEverytime a Storage Variable is loaded twice, (SLOAD), it would be cheaper to use a supporting memory variable\nThe cost of a Second SLOAD is 100 gas, the cost of an MSTORE is 3 and and MLOAD another 3 gas.\n\nUsing a supporting variable will save 94 gas on the second read, and 97 gas for each subsquent MSTORE\n\nIn the case of `fee` this can save 94 gas\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L498-L499>\n\n```solidity\n            if (fee > 0) {\n                feeAmount = (order.strike * fee) / 1000;\n```\n\n### Storage Pointer to `floorTokenIds` will save gas (avoid copying whole storage to memory) - Between 400 and 2k gas saved on Withdraw and Exercise - 400 / 2k &ast; 2 gas saved\n\nIf you pass a `storage` pointer as argument to a `memory` typed function like [`_transferFloorsOut`](https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L657-L658)\n\n```solidity\n    function _transferFloorsOut(address[] memory floorTokens, uint256[] memory floorTokenIds) internal {\n```\n\nYou are copying the storage values to memory and then reading them and looping through that copy, this incurs an overhead and is equivalent to looping over storage, copying into memory and then passing the memory variable.\n\nThis is one of the few cases where a storage declaration (passing the storage pointer) will save gas\n\n#### Refactor to\n\n```solidity\n    function _transferFloorsOut(address[] memory floorTokens, uint256[] storage floorTokenIds) internal {\n```\n\n#### Gas Math\n\n##### Before\n\nexercise                   ┆ 5759            ┆ 55920  ┆ 68002  ┆ 133534 ┆ 18\nwithdraw                   ┆ 3075            ┆ 27840  ┆ 24545  ┆ 71168  ┆ 10\n\n\\#### After\nexercise                   ┆ 5759            ┆ 55176  ┆ 65795  ┆ 133534 ┆ 18\\\nwithdraw                   ┆ 3075            ┆ 27365  ┆ 24545  ┆ 71003  ┆ 10\n\n### Save gas by avoiding NOT - Saves 6 gas sometimes\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L403-L406>\n\n```solidity\n        // check floor asset token ids length is 0 unless the position type is put\n        !order.isCall\n            ? require(floorAssetTokenIds.length == order.floorTokens.length, \"Wrong amount of floor tokenIds\")\n            : require(floorAssetTokenIds.length == 0, \"Invalid floor tokenIds length\");\n```\n\nBecause the logic is fully known, it would be cheaper to swap the if else to:\n\n```solidity\n        order.isCall\n            ? require(floorAssetTokenIds.length == 0, \"Invalid floor tokenIds length\");\n            : require(floorAssetTokenIds.length == order.floorTokens.length, \"Wrong amount of floor tokenIds\") \n```\n\nAs that would avoid the extra `NOT`\n\n### Check msg.value first - 1 gas per instance - 3 gas total\n\nReading msg.value costs 2 gas, while reading from memory costs 3, this will save 1 gas with no downside\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L327>\n\n```solidity\nif (weth == order.baseAsset && msg.value > 0) {\n```\n\nChange to\n\n```solidity\nif (msg.value > 0 && weth == order.baseAsset) {\n```\n\n### Common Gas Savings\n\nBelow are a bunch of basic gas saving tips you probably will receive in most competent submissions added below for the sake of completeness\n\n#### Save 3 gas by not reading `orders.length` - 3 gas per instance - 27 gas saved\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L551-L552>\n\n```solidity\n        require(orders.length == signatures.length, \"Length mismatch in input\");\n\n```\n\n`orders.length` is read multiple times, because of that, especially for the loop, you should cache it in a memory variable to save 3 gas per instance\n\nRefactor to:\n\n```solidity\n        ordersLength = orders.length;\n        require(orders.length == signatures.length, \"Length mismatch in input\");\n```\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742>\n\n#### Avoid default assignment - 3 gas per instance - 27 gas saved\n\nDeclaring `uint256 i = 0;` means doing an MSTORE of the value 0\nInstead you could just declare `uint256 i` to declare the variable without assigning it's default value, saving 3 gas per declaration\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L556-L557>\n\n```solidity\n        for (uint256 i = 0; i < orders.length; i++) {\n\n```\n\nInstances:\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742>\n\n#### Cheaper For Loops - 25 to 80 gas per instance - 9 instances\n\nYou can get cheaper for loops (at least 25 gas, however can be up to 80 gas under certain conditions), by rewriting:\n\n```solidity\n        for (uint256 i = 0; i < orders.length; /** NOTE: Removed i++ **/ ) {\n                // Do the thing\n\n                // Unchecked pre-increment is cheapest\n                unchecked { ++i; }\n        }       \n```\n\nInstances:\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L670-L671>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L658>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L647>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L637>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L627>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L611>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L594>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L728>\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L742>\n\n#### Simplify Value Comparison - Saves some bytecode and makes logic leaner\n\n<https://github.com/code-423n4/2022-06-putty/blob/3b6b844bc39e897bd0bbb69897f2deff12dc3893/contracts/src/PuttyV2.sol#L495-L496>\n\n```solidity\n        if ((order.isCall && isExercised) || (!order.isCall && !isExercised)) {\n\n```\n\nCan be refactored with\n\n```solidity\n        // transfer strike to owner if put is expired or call is exercised\n        if (order.isCall == isExercised) {\n```\n\nAs in both case they were both true or both false\n\n#### Consequence of Smart Comparison Above - Saves 20 to 80 gas (avg is 60)\n\nBecause of the gas save above we can refactor the entire block to an if / else\n\n```solidity\n        if ((order.isCall && isExercised) || (!order.isCall && !isExercised)) {\n            // send the fee to the admin/DAO if fee is greater than 0%\n            uint256 feeAmount = 0;\n            if (fee > 0) {\n                feeAmount = (order.strike * fee) / 1000;\n                ERC20(order.baseAsset).safeTransfer(owner(), feeAmount);\n            }\n\n            ERC20(order.baseAsset).safeTransfer(msg.sender, order.strike - feeAmount);\n\n            return;\n        }\n\n        // transfer assets from putty to owner if put is exercised or call is expired\n        if ((order.isCall && !isExercised) || (!order.isCall && isExercised)) {\n            _transferERC20sOut(order.erc20Assets);\n            _transferERC721sOut(order.erc721Assets);\n\n            // for call options the floor token ids are saved in the long position in fillOrder(),\n            // and for put options the floor tokens ids are saved in the short position in exercise()\n            uint256 floorPositionId = order.isCall ? longPositionId : uint256(orderHash);\n            _transferFloorsOut(order.floorTokens, positionFloorAssetTokenIds[floorPositionId]);\n\n            return;\n        }\n```\n\nBecomes\n\n```solidity\n        if (order.isCall == isExercised)) {\n                // transfer assets from putty to owner if put is exercised or call is expired\n\n                // send the fee to the admin/DAO if fee is greater than 0%\n                uint256 feeAmount = 0;\n                if (fee > 0) {\n                        feeAmount = (order.strike * fee) / 1000;\n                        ERC20(order.baseAsset).safeTransfer(owner(), feeAmount);\n                }\n\n                ERC20(order.baseAsset).safeTransfer(msg.sender, order.strike - feeAmount);\n        } else {\n                // transfer assets from putty to owner if put is exercised or call is expired\n\n                _transferERC20sOut(order.erc20Assets);\n                _transferERC721sOut(order.erc721Assets);\n\n                // for call options the floor token ids are saved in the long position in fillOrder(),\n                // and for put options the floor tokens ids are saved in the short position in exercise()\n                uint256 floorPositionId = order.isCall ? longPositionId : uint256(orderHash);\n                _transferFloorsOut(order.floorTokens, positionFloorAssetTokenIds[floorPositionId]);\n        }\n```\n\nWhich reduces bytecode size, and saves gas in most situations as you're avoiding up to 3 extra comparisons\n\n**[outdoteth commented](https://github.com/code-423n4/2022-06-putty-findings/issues/280#issuecomment-1178176775):**\n > Cool idea with relying on 0xdead to see if an option is exercised or not. Unfortunately this doesnt work because a user can intentionally \"burn\" their NFT to 0xdead which then messes up the logic in withdraw. This can be mitigated, but requires too many changes.\n> \n> High quality report though.\n\n\n***\n\n# Mitigation Review\n\n*Mitigation review by [hyh](https://twitter.com/0xhyh)*\n\nProject repository: https://github.com/outdoteth/putty-v2/tree/master/src\n\nReview commit: 6df33b2f20e8ddc1bf3dadde4feb834333b2c218\n   \n## Intro\n\nThe following is a review of mitigations originated from Code4rena (C4) audit contest that took place between June 29 and July 4, 2022.\n\n## Disclaimer\n\nThis mitigation review does not guarantee the absence of any further vulnerabilities, being, however, the result of exercising reviewer's best efforts. Also, it focuses on the resolved issues and the resulting code base, leaving out of scope all the acknowledged issues from the original report.\n\n## Mitigation Overview\n\nThe following is a high-level overview of the core changes introduced as the mitigation [`PR#1-10`](https://github.com/outdoteth/putty-v2/pulls?q=is%3Apr+is%3Aclosed), arranged per original report findings.\n\n* [H-01] Fixed by changing the fee base to be `order.premium` [`PR#4`](https://github.com/outdoteth/putty-v2/pull/4), which is now paid uniformly for all option types on order filling. Utilizing `order.strike` as the fee base was the root cause for [M-04], [M-06], [M-11], [M-15], so the change to `order.premium` was a shared mitigation for all of them.\n\n* [H-02] Fixed by requiring that order can't be in the filled state on cancel. This fully adheres to the original logic, but wasn't controlled for before.\n\n* [H-03] Fixed by prohibiting non-empty `order.floorTokens` for short calls.\nOther option types do need `floorTokens`: long calls' taker provides floor tokens on filling, while long put owner brings in the floor tokens on exercise, taking the strike. Short put owner can thereafter retrieve the tokens on withdraw.\n\n* [H-04] Fixed by conditioning call's logic on `order.strike > 0`. There is no use case for zero strike puts and so this case remains unconditioned, i.e. still always require successful `order.strike` transfer.\n\n* [M-01, M-02] Acknowledged, now addressed on UI/DB level.\n\n* [M-03] Fixed zero amount part by introducing the noop for zero amount transfers in both `_transferERC20sIn` and `_transferERC20sOut` ERC20 transfer functions. The second part of the issue, fake tokens, is similar to [M-01], [M-02].\n\n* [M-04] The same fix as in [H-01].\n\n* [M-05] Fixed with native funds amount control added to strike transfer logic of `fillOrder`. Zero strike and zero premium corner cases are yet unhandled as described below in [M.M-01](#mm-01-weth-zero-strike-call-fillorders-msgvalue-will-be-lost) and [M.M-02](#mm-02-zero-premium-short-fillorders-msgvalue-will-be-lost).\n   \n* [M-06] The same fix as in [H-01]: as the platform fee is now transferred on order filling, any owner griefing can only yield a denial of service. There will be no loss of funds as this way position is only about to be created when the fee is transferred.\n\n* [M-07] Acknowledged, similar to [M-01], [M-02].\n\n* [M-08] Acknowledged, requires asset whitelisting, now addressed on UI/DB level.\n\n* [M-09] Acknowledged.\n\n* [M-10] Acknowledged.\n\n* [M-11] The same fix as in [H-01].\n\n* [M-12] Fixed along with [H-01] in [`PR#4`](https://github.com/outdoteth/putty-v2/pull/4).\n\n* [M-13] Fixed by requiring the minimal order duration of 15 minutes on filling.\n\n* [M-14] Fixed by the introduction of `setMinimumValidNonce` function and the corresponding control on order filling. See [M.M-04](#mm-04-minimumvalidnonce-can-be-reduced-due-to-an-operational-mistake-enabling-old-orders) below.\n\n* [M-15] The same fix as in [H-01].\n\n* [M-16] Fixed by bumping the solidity version.\n   \n## Findings\n\nFindings are referenced as `M.S-N`, `Mitigation.Severity-Number`.\n\nSource means the source of the latest relevant change, not necessary the issue itself, as some of them existed in the snapshot used in the original audit.\n\n### [M.M-01](#mm-01-weth-zero-strike-call-fillorders-msgvalue-will-be-lost) WETH zero strike call fillOrder's msg.value will be lost\n\nIf there is any `msg.value` mistakenly attached to fillOrder() for a WETH based zero strike call, it will be lost for a caller. The same happens in exercise().\n\nThat's asset freezing due to user's mistake impact in both cases.\n\n#### Proof of Concept\n\nNamely, when `order.baseAsset == address(weth)`, `order.isCall` and `order.strike == 0`, the native funds attached to the fillOrder() call aren't controlled and can be lost:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L504-L505\n\n```solidity\n        // check native eth is only used if baseAsset is weth\n        require(msg.value == 0 || order.baseAsset == address(weth), \"Cannot use native ETH\");\n```\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L527-L553\n\n```solidity\n        if (order.isCall) {\n            // -- exercising a call option\n\n            // transfer strike from exerciser to putty\n            // handle the case where the taker uses native ETH instead of WETH to pay the strike\n            if (order.strike > 0) {\n                if (msg.value > 0) {\n                    // check enough ETH was sent to cover the strike\n                    require(msg.value == order.strike, \"Incorrect ETH amount sent\");\n\n                    // convert ETH to WETH\n                    // we convert the strike ETH to WETH so that the logic in withdraw() works\n                    // - because withdraw() assumes an ERC20 interface on the base asset.\n                    IWETH(weth).deposit{value: msg.value}();\n                } else {\n                    ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n                }\n            }\n\n            // transfer assets from putty to exerciser\n            _transferERC20sOut(order.erc20Assets);\n            _transferERC721sOut(order.erc721Assets);\n            _transferFloorsOut(order.floorTokens, positionFloorAssetTokenIds[uint256(orderHash)]);\n        } else {\n            // -- exercising a put option\n            // exercising a put never needs native ETH\n            require(msg.value == 0, \"Puts can't use native ETH\");\n```\n\nThe same approach is used in exercise(), and the same WETH zero strike call's `msg.value` isn't controlled and can be lost:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L504-L505\n\n```solidity\n        // check native eth is only used if baseAsset is weth\n        require(msg.value == 0 || order.baseAsset == address(weth), \"Cannot use native ETH\");\n```\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L527-L544\n\n```solidity\n        if (order.isCall) {\n            // -- exercising a call option\n\n            // transfer strike from exerciser to putty\n            // handle the case where the taker uses native ETH instead of WETH to pay the strike\n            if (order.strike > 0) {\n                if (msg.value > 0) {\n                    // check enough ETH was sent to cover the strike\n                    require(msg.value == order.strike, \"Incorrect ETH amount sent\");\n\n                    // convert ETH to WETH\n                    // we convert the strike ETH to WETH so that the logic in withdraw() works\n                    // - because withdraw() assumes an ERC20 interface on the base asset.\n                    IWETH(weth).deposit{value: msg.value}();\n                } else {\n                    ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n                }\n            }\n```\n\nSuch ETH funds will be permanently frozen on the contract balance as there is no mechanics to retrieve them.\n\n#### Source\n\n[`PR#3`](https://github.com/outdoteth/putty-v2/pull/3)\n\n#### Recommended Mitigation Steps\n\nConsider checking that nothing is attached to the zero strike call:\n\nfillOrder()\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L530-L544\n\n```solidity\n            // transfer strike from exerciser to putty\n            // handle the case where the taker uses native ETH instead of WETH to pay the strike\n            if (order.strike > 0) {\n                if (msg.value > 0) {\n                    // check enough ETH was sent to cover the strike\n                    require(msg.value == order.strike, \"Incorrect ETH amount sent\");\n\n                    // convert ETH to WETH\n                    // we convert the strike ETH to WETH so that the logic in withdraw() works\n                    // - because withdraw() assumes an ERC20 interface on the base asset.\n                    IWETH(weth).deposit{value: msg.value}();\n                } else {\n                    ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n                }\n-           }\n+           } else {\n+               require(msg.value == 0, \"0 strike calls can't use ETH\");\n+           }\n```\n\nexercise()\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L530-L544\n\n```solidity\n            // transfer strike from exerciser to putty\n            // handle the case where the taker uses native ETH instead of WETH to pay the strike\n            if (order.strike > 0) {\n                if (msg.value > 0) {\n                    // check enough ETH was sent to cover the strike\n                    require(msg.value == order.strike, \"Incorrect ETH amount sent\");\n\n                    // convert ETH to WETH\n                    // we convert the strike ETH to WETH so that the logic in withdraw() works\n                    // - because withdraw() assumes an ERC20 interface on the base asset.\n                    IWETH(weth).deposit{value: msg.value}();\n                } else {\n                    ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n                }\n-           }\n+           } else {\n+               require(msg.value == 0, \"0 strike calls can't use ETH\");\n+           }\n```\n   \n   \n   \n### [M.M-02](#mm-02-zero-premium-short-fillorders-msgvalue-will-be-lost) Zero premium short fillOrder's msg.value will be lost\n\nIf there is any native funds mistakenly attached to fillOrder() for a zero premium short option, `msg.value` will be lost for a caller. As an example, zero premiums can correspond to the case when option is settled off-chain and access is managed with `order.whitelist`.\n\nThe impact is asset freezing due to user's mistake. The freeze is permanent as there is no mechanics to retrieve native funds from the contract.\n\n#### Proof of Concept\n\nSimilarly, when `!order.isLong` and `order.premium == 0`, the native funds attached to the fillOrder() call aren't controlled and can be lost as the checks reside in the `if (order.premium > 0) {` block:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L408-L442\n\n```solidity\n        // transfer premium to whoever is short from whomever is long\n        if (order.premium > 0) {\n            if (order.isLong) {\n                // transfer premium to taker\n                ERC20(order.baseAsset).safeTransferFrom(order.maker, msg.sender, order.premium - feeAmount);\n\n                // collect fees\n                if (feeAmount > 0) {\n                    ERC20(order.baseAsset).safeTransferFrom(order.maker, address(this), feeAmount);\n                }\n            } else {\n                // handle the case where the user uses native ETH instead of WETH to pay the premium\n                if (msg.value > 0) {\n                    // check enough ETH was sent to cover the premium\n                    require(msg.value == order.premium, \"Incorrect ETH amount sent\");\n\n                    // convert ETH to WETH and send premium to maker\n                    // converting to WETH instead of forwarding native ETH to the maker has two benefits;\n                    // 1) active market makers will mostly be using WETH not native ETH\n                    // 2) attack surface for re-entrancy is reduced\n                    IWETH(weth).deposit{value: order.premium}();\n\n                    // collect fees and transfer to premium to maker\n                    IWETH(weth).transfer(order.maker, order.premium - feeAmount);\n                } else {\n                    // transfer premium to maker\n                    ERC20(order.baseAsset).safeTransferFrom(msg.sender, order.maker, order.premium - feeAmount);\n\n                    // collect fees\n                    if (feeAmount > 0) {\n                        ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), feeAmount);\n                    }\n                }\n            }\n        }\n```\n\nAfter that short option cases only transfer the assets (`!order.isLong && !order.isCall` and `!order.isLong && order.isCall`):\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L444-L464\n\n```solidity\n        if (!order.isLong && !order.isCall) {\n            // filling short put: transfer strike from maker to contract\n            ERC20(order.baseAsset).safeTransferFrom(order.maker, address(this), order.strike);\n        } else if (order.isLong && !order.isCall) {\n            // filling long put: transfer strike from taker to contract\n            // handle the case where the taker uses native ETH instead of WETH to deposit the strike\n            if (msg.value > 0) {\n                // check enough ETH was sent to cover the strike\n                require(msg.value == order.strike, \"Incorrect ETH amount sent\");\n\n                // convert ETH to WETH\n                // we convert the strike ETH to WETH so that the logic in exercise() works\n                // - because exercise() assumes an ERC20 interface on the base asset.\n                IWETH(weth).deposit{value: msg.value}();\n            } else {\n                ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), order.strike);\n            }\n        } else if (!order.isLong && order.isCall) {\n            // filling short call: transfer assets from maker to contract\n            _transferERC20sIn(order.erc20Assets, order.maker);\n            _transferERC721sIn(order.erc721Assets, order.maker);\n```\n\n#### Recommended Mitigation Steps\n\nIt's enough to add the similar check for `!order.isLong` case when main logic is avoided:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L408-L442\n\n```solidity\n        // transfer premium to whoever is short from whomever is long\n        if (order.premium > 0) {\n            if (order.isLong) {\n                // transfer premium to taker\n                ERC20(order.baseAsset).safeTransferFrom(order.maker, msg.sender, order.premium - feeAmount);\n\n                // collect fees\n                if (feeAmount > 0) {\n                    ERC20(order.baseAsset).safeTransferFrom(order.maker, address(this), feeAmount);\n                }\n            } else {\n                // handle the case where the user uses native ETH instead of WETH to pay the premium\n                if (msg.value > 0) {\n                    // check enough ETH was sent to cover the premium\n                    require(msg.value == order.premium, \"Incorrect ETH amount sent\");\n\n                    // convert ETH to WETH and send premium to maker\n                    // converting to WETH instead of forwarding native ETH to the maker has two benefits;\n                    // 1) active market makers will mostly be using WETH not native ETH\n                    // 2) attack surface for re-entrancy is reduced\n                    IWETH(weth).deposit{value: order.premium}();\n\n                    // collect fees and transfer to premium to maker\n                    IWETH(weth).transfer(order.maker, order.premium - feeAmount);\n                } else {\n                    // transfer premium to maker\n                    ERC20(order.baseAsset).safeTransferFrom(msg.sender, order.maker, order.premium - feeAmount);\n\n                    // collect fees\n                    if (feeAmount > 0) {\n                        ERC20(order.baseAsset).safeTransferFrom(msg.sender, address(this), feeAmount);\n                    }\n                }\n            }\n-       }\n+       } else {\n+           if (!order.isLong) require(msg.value == 0, \"0 premium shorts can't use ETH\");\n+       }\n```\n   \n   \n   \n### [M.M-03](#mm-03-unsafe-transfer-of-an-arbitrary-token-is-used-by-withdrawfees-for-the-cumulative-fee-retrieval) Unsafe transfer of an arbitrary token is used by withdrawFees() for the cumulative fee retrieval\n\nwithdrawFees() will not revert on the transfer call failure and will be inaccessible for tokens not fully compliant with Solmate's ERC20 (say, USDT).\n\nOne issue is that when a token do not revert, but instead returns false, this will go unnoticed. As `unclaimedFees` will be reset to `0` without actual transfer, this means that the cumulative `asset` denominated fee that PuttyV2 instance had at that moment will become frozen within the contract.\n\nAnother is that ERC20 compliance is expected by using `ERC20(asset).transfer`, while it is not always the case and such `assets` will not be retrievable by withdrawFees() as the call will fail due to function signature mismatch. The corresponding cumulative fee will also be frozen on the balance.\n\n#### Proof of Concept\n\nwithdrawFees() uses plain `transfer` call while the `asset`, being `order.baseAsset`, can be arbitrary:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311\n\n```solidity\n    function withdrawFees(address asset, address recipient) public payable onlyOwner {\n        uint256 fees = unclaimedFees[asset];\n\n        // reset the fees\n        unclaimedFees[asset] = 0;\n\n        emit WithdrewFees(asset, fees, recipient);\n\n        // send the fees to the recipient\n        ERC20(asset).transfer(recipient, fees);\n    }\n```\n\nhttps://github.com/Rari-Capital/solmate/blob/25015a1d18e75921f8cb1bacd4beb9f364e788a9/src/tokens/ERC20.sol#L76\n\n```solidity\n    function transfer(address to, uint256 amount) public virtual returns (bool) {\n```\n\n#### Source\n\n[`PR#4`](https://github.com/outdoteth/putty-v2/pull/4)\n\n#### Recommended Mitigation Steps\n\nConsider using Solmate's safeTransfer that performs lower level call with result check:\n\nhttps://github.com/Rari-Capital/solmate/blob/ca96d493e0b061cccccf02b2fd9f5c6fe08826df/src/utils/SafeTransferLib.sol#L63-L92\n\n```solidity\n    function safeTransfer(\n    ...\n```\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311\n\n```solidity\n    function withdrawFees(address asset, address recipient) public payable onlyOwner {\n        uint256 fees = unclaimedFees[asset];\n\n        // reset the fees\n        unclaimedFees[asset] = 0;\n\n        emit WithdrewFees(asset, fees, recipient);\n\n        // send the fees to the recipient\n-       ERC20(asset).transfer(recipient, fees);\n+       ERC20(asset).safeTransfer(recipient, fees);\n    }\n```\n   \n   \n   \n### [M.M-04](#mm-04-minimumvalidnonce-can-be-reduced-due-to-an-operational-mistake-enabling-old-orders) minimumValidNonce can be reduced due to an operational mistake, enabling old orders\n\n`setMinimumValidNonce()`, introduced as the mitigation for `M-14`, allows user to both decrease and increase personal nonce. The regular operation here is nonce increase, which invalidates outdated orders.\n\nNonce decrease operation, on the other hand, has no regular use case and is a subject to an operational mistakes that can easily lead to loss of funds as outdated orders were set to inactive state by nonce increased most likely in result of becoming non-market and so enabling them will allow an attacker, who can track the setMinimumValidNonce() calls, to immediately fill such orders in the case they indeed are now off the market and were enabled by mistake.\n\nMaker's allowances for the assets in question can remain open as other similar, but currently marked to market, same maker’s orders can be live on Putty or elsewhere.\n\nThis way, an ability to decrease the nonce provides a surface for user mistakes with highly probable loss of funds: most of orders are invalidated as out of the market, while some allowances can realistically remain, which gives medium overall probability of a loss given erroneous nonce decrease by a user. As user has to track the nonces and so such a decrease is conditional only on user failing to do so, which isn't a negligible event.\n\nImpact this way is loss of funds conditional on user operational mistake with both events having medium probability.\n\n#### Proof of Concept\n\n`setMinimumValidNonce()` allows setting any nonce, including one that's significantly lower than current:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L700-L709\n\n```solidity\n    /**\n        @notice Sets the minimum valid nonce for a user. Any unfilled orders with a nonce \n                smaller than this minimum will no longer be valid and will unable to be filled.\n        @param _minimumValidNonce The new minimum valid nonce.\n     */\n    function setMinimumValidNonce(uint256 _minimumValidNonce) public {\n        minimumValidNonce[msg.sender] = _minimumValidNonce;\n\n        emit SetMinimumValidNonce(_minimumValidNonce);\n    }\n```\n\n#### Source\n\n[`PR#10`](https://github.com/outdoteth/putty-v2/pull/10)\n\n#### Recommended Mitigation Steps\n\nConsider requiring new nonce to be strictly higher than the old one or, more preferrably, restrict the function to exactly one step increase:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L700-L709\n\n```solidity\n    /**\n-       @notice Sets the minimum valid nonce for a user. Any unfilled orders with a nonce \n+       @notice Increments the minimum valid nonce for a user. Any unfilled orders with a nonce \n                smaller than this minimum will no longer be valid and will unable to be filled.\n-       @param _minimumValidNonce The new minimum valid nonce.\n     */\n-   function setMinimumValidNonce(uint256 _minimumValidNonce) public {\n+   function incrementMinimumValidNonce() public {\n-       minimumValidNonce[msg.sender] = _minimumValidNonce;\n\n+       emit SetMinimumValidNonce(++minimumValidNonce[msg.sender]);\n    }\n```\n   \n   \n   \n### [M.L-01](#ml-01-fee-limit-remain-the-same-after-fee-mechanics-base-has-changed) Fee limit remain the same after fee mechanics base has changed\n\nThe 3% limit stayed the same after fee mechanics change. 3% of a premium and 3% of a strike can be vastly different as average strike is about 1-2 magnitudes higher than average premium (i.e. the crude evaluation that most options are priced at 1-10% of their strikes isn't too incorrect).\n\nThis way, while 3% of the strike was rather high, being more than the whole premium in some cases, 3% of the premium can be too restrictive as a limit. Anyway, lesser fees are good for protocol adoption, so this is just a matter of reevaluation, not necessary change.\n\n#### Proof of Concept\n\n`setFee()` uses `30 / 1000` limit as it was in the `order.strike` based fee mechanics:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L288-L294\n\n```solidity\n    function setFee(uint256 _fee) public payable onlyOwner {\n        require(_fee < 30, \"fee must be less than 3%\");\n\n        fee = _fee;\n\n        emit NewFee(_fee);\n    }\n```\n\nNow it's `order.premium` based:\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L401-L406\n\n```solidity\n        // calculate the fee amount\n        uint256 feeAmount = 0;\n        if (fee > 0) {\n            feeAmount = (order.premium * fee) / 1000;\n            unclaimedFees[order.baseAsset] += feeAmount;\n        }\n```\n\n#### Recommended Mitigation Steps\n\nReview the fee limit taking the account changed magnitude of the average base amount \n   \n### [M.N-01](#mn-01-unnecessary-payable-functions) Unnecessary payable functions\n\nAdministrative functions have payable modifiers that aren't used as no fund transfers are involved, while enabling Owner's operational mistakes surface.\n\nThere is only a small gas cost for checking zero `msg.value`, while any native funds sent over with such functions will be frozen permanently.\n\n#### Proof of Concept\n\nsetBaseURI():\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L276-L280\n\n```solidity\n    function setBaseURI(string memory _baseURI) public payable onlyOwner {\n        baseURI = _baseURI;\n\n        emit NewBaseURI(_baseURI);\n    }\n```\n\nsetFee():\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L288-L294\n\n```solidity\n    function setFee(uint256 _fee) public payable onlyOwner {\n        require(_fee < 30, \"fee must be less than 3%\");\n\n        fee = _fee;\n\n        emit NewFee(_fee);\n    }\n```\n\nwithdrawFees():\n\nhttps://github.com/outdoteth/putty-v2/blob/6df33b2f20e8ddc1bf3dadde4feb834333b2c218/src/PuttyV2.sol#L301-L311\n\n```solidity\n    function withdrawFees(address asset, address recipient) public payable onlyOwner {\n        uint256 fees = unclaimedFees[asset];\n\n        // reset the fees\n        unclaimedFees[asset] = 0;\n\n        emit WithdrewFees(asset, fees, recipient);\n\n        // send the fees to the recipient\n        ERC20(asset).transfer(recipient, fees);\n    }\n```\n\n### Reference\n\n`msg.value` check costs about 25 gas:\n\nhttps://coinsbench.com/solidity-payable-vs-regular-functions-a-gas-usage-comparison-b4a387fe860d\n\n### Recommended Mitigation Steps\n\nAs there operations are rare and gas increase is low consider removing `payable` modifiers\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}