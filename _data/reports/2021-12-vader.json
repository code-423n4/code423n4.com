{
  "circa": {
    "title": "Vader Protocol contest",
    "sponsor": "Vader Protocol",
    "slug": "2021-12-vader",
    "date": "2022-05-03",
    "findings": "https://github.com/code-423n4/2021-12-vader-findings/issues",
    "contest": 70
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of the Vader Protocol smart contract system written in Solidity. The code contest took place between December 21—December 25 2021.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>21 Wardens contributed reports to the Vader Protocol contest:</p>\n<ol>\n<li><a href=\"https://github.com/TomAFrench\">TomFrenchBlockchain</a></li>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li><a href=\"https://twitter.com/danbinnun\">danb</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>hyh</li>\n<li>certora</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>robee</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/JustDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/GiveMeTestEther\">GiveMeTestEther</a></li>\n<li>0x1f8b</li>\n<li>cccz</li>\n<li>Critical</li>\n<li>Jujic</li>\n<li>p4st13r4 (<a href=\"https://github.com/0x69e8\">0x69e8</a> and 0xb4bb4)</li>\n<li><a href=\"https://www.amitnave.com/\">AmitN</a></li>\n<li>jayjonah8</li>\n<li><a href=\"https://twitter.com/Meta0xNull\">Meta0xNull</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/jack-the-pug\">Jack the Pug</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 37 unique vulnerabilities and 80 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 14 received a risk rating in the category of HIGH severity, 6 received a risk rating in the category of MEDIUM severity, and 17 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 14 non-critical recommendations and 29 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-12-vader\">C4 Vader Protocol contest repository</a>, and is composed of 4 smart contracts written in the Solidity programming language and includes 1542 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-14\" style=\"position:relative;\"><a href=\"#high-risk-findings-14\" aria-label=\"high risk findings 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (14)</h1>\n<h2 id=\"h-01-vaderpoolv2-minting-synths--fungibles-can-be-frontrun\" style=\"position:relative;\"><a href=\"#h-01-vaderpoolv2-minting-synths--fungibles-can-be-frontrun\" aria-label=\"h 01 vaderpoolv2 minting synths  fungibles can be frontrun permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/147\">[H-01] <code>VaderPoolV2</code> minting synths &#x26; fungibles can be frontrun</a></h2>\n<p><em>Submitted by cmichel, also found by cccz, Critical, danb, leastwood, and TomFrenchBlockchain</em></p>\n<p>The <code>VaderPoolV2</code> <code>mintFungible</code> and <code>mintSynth</code> functions perform an unsafe <code>nativeAsset.safeTransferFrom(from, address(this), nativeDeposit)</code> with a parameter-specified <code>from</code> address.</p>\n<p>Note that these functions are not called by the Router, they are directly called on the pool.\nTherefore, users will usually be required to send two transactions, a first one approving the pool, and then a second one for the actual <code>mintSynth</code>.</p>\n<p>An attacker can frontrun the <code>mintSynth(IERC20 foreignAsset, uint256 nativeDeposit, address from, address to)</code> function, use the same <code>from=victim</code> parameter but change the <code>to</code> parameter to the attacker.</p>\n<h4 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>It’s possible to frontrun victims stealing their native token deposits and receiving synths / fungible tokens.</p>\n<h4 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Remove the <code>from</code> parameter and always perform the <code>safeTransferFrom</code> call with <code>from=msg.sender</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/147\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"h-02-vaderpoolv2-owner-can-steal-all-user-assets-which-are-approved-vaderpoolv2\" style=\"position:relative;\"><a href=\"#h-02-vaderpoolv2-owner-can-steal-all-user-assets-which-are-approved-vaderpoolv2\" aria-label=\"h 02 vaderpoolv2 owner can steal all user assets which are approved vaderpoolv2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/72\">[H-02] <code>VaderPoolV2</code> owner can steal all user assets which are approved <code>VaderPoolV2</code></a></h2>\n<p><em>Submitted by TomFrenchBlockchain</em></p>\n<p>Possible theft of all user assets with an ERC20 approval on VaderPoolV2.</p>\n<h4 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>The owner of <code>VaderPoolV2</code> can call the <code>setTokenSupport</code> function which allows the caller to supply any address from which to take the assets to provide the initial liquidity, the owner can also specify who shall receive the resulting LP NFT and so can take ownership over these assets. This call will succeed for any address which has an ERC20 approval on <code>VaderPoolV2</code> for USDV and <code>foreignAsset</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/dex-v2/pool/VaderPoolV2.sol#L442-L474\">https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/dex-v2/pool/VaderPoolV2.sol#L442-L474</a></p>\n<p>This in effect gives custody over all assets in user wallets which are approved on <code>VaderPoolV2</code> to Vader Protocol governance. This is especially problematic in the case of Vader Protocol as there’s a single entity (i.e. the Council) which can force through a proposal to steal these assets for themselves with only the timelock giving protection to users, for this reason I give this high severity.</p>\n<h4 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Enforce that the initial liquidity is provided by the VaderPoolV2 owner.</p>\n<hr>\n<h2 id=\"h-03-oracle-doesnt-calculate-usdvvader-price-correctly\" style=\"position:relative;\"><a href=\"#h-03-oracle-doesnt-calculate-usdvvader-price-correctly\" aria-label=\"h 03 oracle doesnt calculate usdvvader price correctly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/42\">[H-03] Oracle doesn’t calculate USDV/VADER price correctly</a></h2>\n<p><em>Submitted by TomFrenchBlockchain, also found by danb and leastwood</em></p>\n<p>Invalid values returned from oracle for USDV and VADER prices in situations where the oracle uses more than one foreign asset.</p>\n<h4 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>The USDV price is calculated as so (for simplicity we’ll consider a two pairs):</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/lbt/LiquidityBasedTWAP.sol#L393-L409\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/lbt/LiquidityBasedTWAP.sol#L393-L409</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">totalUSD =  (PriceForeign0InUSD * liquidityWeights[0] + PriceForeign1InUSD * liquidityWeights[1]) / totalUSDVLiquidityWeight;</span></span></code></pre>\n<p><code>totalUSD</code> is then the average price of the foreign assets paired against USDV in terms of USD, weighted by the TVL of the relevant liquidity pool</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">totalUSDV =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  (pairData0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      .nativeTokenPriceAverage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      .mul(pairData0.foreignUnit)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      .decode144() * liquidityWeights[0] +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">   pairData1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      .nativeTokenPriceAverage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      .mul(pairData1.foreignUnit)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      .decode144() * liquidityWeights[1]) /</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  totalUSDVLiquidityWeight;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// in pseudocode for readability</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">totalUSDV = (USDVPriceInForeign0 * liquidityWeights[0] + USDVPriceInForeign1 * liquidityWeights[1]) /  totalUSDVLiquidityWeight</span></span></code></pre>\n<p><code>totalUSDV</code> is then the average price of USDV in terms of each of the foreign assets, weighted by the TVL of the relevant liquidity pool.</p>\n<p>It should be fairly clear that this is the incorrect calculation as all the terms in <code>totalUSDV</code> are in different units - you can’t average the price of USDV in ETH with the price of USDV in BTC and get a meaningful result.</p>\n<p>It appears that the VADER team intended to calculate the price of USDV in terms of USD through a number of different paired assets and then average them at the end based on the liquidity in each pair but have started averaging too early.</p>\n<p>High severity issue as the oracle is crucial for determining the exchange rate between VADER and USDV to be used for IL protection and minting/burning of USDV - an incorrect value will result in the protocol losing significant funds.</p>\n<h4 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Review the algorithm used for calculating the prices of assets and ensure that it’s calculating what you expect.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/42\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"h-04-vader-twap-averages-wrong\" style=\"position:relative;\"><a href=\"#h-04-vader-twap-averages-wrong\" aria-label=\"h 04 vader twap averages wrong permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/148\">[H-04] Vader TWAP averages wrong</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The vader price in <code>LiquidityBasedTWAP.getVaderPrice</code> is computed using the <code>pastLiquidityWeights</code> and <code>pastTotalLiquidityWeight</code> return values of the <code>syncVaderPrice</code>.</p>\n<p>The <code>syncVaderPrice</code> function does not initialize all weights and the total liquidity weight does not equal the sum of the individual weights because it skips initializing the pair with the previous data if the TWAP update window has not been reached yet:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">syncVaderPrice</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pastLiquidityWeights</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pastTotalLiquidityWeight</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalLiquidityWeight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalPairs</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vaderPairs</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pastLiquidityWeights</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">totalPairs</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pastTotalLiquidityWeight</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalLiquidityWeight</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Paths</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VADER</span><span class=\"mtk1\">)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">totalPairs</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IUniswapV2Pair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pair</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vaderPairs</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ExchangePair</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pairData</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twapData</span><span class=\"mtk1\">[</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pair</span><span class=\"mtk1\">)];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit-info lastMeasurement is set in _updateVaderPrice to block.timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeElapsed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">pairData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastMeasurement</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit-info update period depends on pair</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// @audit-issue if update period not reached =&gt; does not initialize pastLiquidityWeights[i]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">timeElapsed</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pairData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">updatePeriod</span><span class=\"mtk1\">) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pastLiquidityEvaluation</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pairData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pastLiquidityEvaluation</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentLiquidityEvaluation</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_updateVaderPrice</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pair</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pairData</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">timeElapsed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pastLiquidityWeights</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">pastLiquidityEvaluation</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pairData</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pastLiquidityEvaluation</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentLiquidityEvaluation</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_totalLiquidityWeight</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">currentLiquidityEvaluation</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">totalLiquidityWeight</span><span class=\"mtk1\">[</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Paths</span><span class=\"mtk1\">.</span><span class=\"mtk12\">VADER</span><span class=\"mtk1\">)] = </span><span class=\"mtk12\">_totalLiquidityWeight</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h6 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h6>\n<p>This bug leads to several different issues. A big one is that an attacker can break the price functions and make them revert.\nObserve what happens if an attacker calls <code>syncVaderPrice</code> twice in the same block:</p>\n<ul>\n<li>The first time any pairs that need to be updated are updated</li>\n<li>On the second call <code>_totalLiquidityWeight</code> is initialized to zero and all pairs have already been updated and thus skipped. <code>_totalLiquidityWeight</code> never increases and the storage variable <code>totalLiquidityWeight[uint256(Paths.VADER)] = _totalLiquidityWeight = 0;</code> is set to zero.</li>\n<li>DoS because calls to <code>getStaleVaderPrice</code> / <code>getVaderPrice</code> will revert in <code>_calculateVaderPrice</code> which divides by <code>totalLiquidityWeight = 0</code>.</li>\n</ul>\n<p>Attacker keeps double-calling <code>syncVaderPrice</code> every time an update window of one of the pairs becomes eligible to be updated.</p>\n<h4 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>This bug leads to using wrong averaging and ignoring entire pairs due to their weights being initialized to zero and never being changed if the update window is not met.\nThis in turn makes it easier to manipulate the price as potentially only a single pair needs to be price-manipulated.</p>\n<p>It’s also possible to always set the <code>totalLiquidityWeight</code> to zero by calling <code>syncVaderPrice</code> twice which in turn reverts all transactions making use of the price because of a division by zero in <code>_caluclateVaderPrice</code>.\nAn attacker can break the <code>USDV.mint</code> minting forever and any router calls to <code>VaderReserve.reimburseImpermanentLoss</code> also fail as they perform a call to the reverting price function.</p>\n<h4 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Even if <code>timeElapsed &#x3C; pairData.updatePeriod</code>, the old pair weight should still contribute to the total liquidity weight and be set in <code>pastLiquidityWeights</code>.\nMove the <code>_totalLiquidityWeight += currentLiquidityEvaluation</code> and the <code>pastLiquidityWeights[i] = pastLiquidityEvaluation</code> assignments before the <code>continue</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/148\">SamSteinGG (Vader) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-05-oracle-returns-an-improperly-scaled-usdvvader-price\" style=\"position:relative;\"><a href=\"#h-05-oracle-returns-an-improperly-scaled-usdvvader-price\" aria-label=\"h 05 oracle returns an improperly scaled usdvvader price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/70\">[H-05] Oracle returns an improperly scaled USDV/VADER price</a></h2>\n<p><em>Submitted by TomFrenchBlockchain</em></p>\n<p>Invalid values returned from oracle in vast majority of situations.</p>\n<h4 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>The LBT oracle does not properly scale values when calculating prices for VADER or USDV. To show this we consider the simplest case where we expect USDV to return a value of $1 and show that the oracle does not return this value.</p>\n<p>Consider the case of the LBT oracle tracking a single USDV-DAI pair where USDV trades 1:1 for DAI and Chainlink reports that DAI is exactly $1. We then work through the lines linked below:</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/lbt/LiquidityBasedTWAP.sol#L393-L409\">https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/lbt/LiquidityBasedTWAP.sol#L393-L409</a></p>\n<p>For L397 we get a value of 1e8 as Chainlink reports the price of DAI with 8 decimals of accuracy.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">foreignPrice = getChainlinkPrice(address(foreignAsset));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">foreignPrice = 1e8</span></span></code></pre>\n<p>We can set <code>liquidityWeights[i]</code> and <code>totalUSDVLiquidityWeight</code> both to 1 as we only consider a single pair so L399-401 becomes</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">totalUSD = foreignPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">totalUSD = 1e8;</span></span></code></pre>\n<p>L403-408 is slightly more complex but from looking at the links below we can calculate <code>totalUSDV</code> as shown\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/dex-v2/pool/VaderPoolV2.sol#L81-L90\">https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/dex-v2/pool/VaderPoolV2.sol#L81-L90</a>\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/external/libraries/FixedPoint.sol#L137-L160\">https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/external/libraries/FixedPoint.sol#L137-L160</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">totalUSDV = pairData</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    .nativeTokenPriceAverage</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    .mul(pairData.foreignUnit)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    .decode144()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// pairData.nativeTokenPriceAverage == 2**112</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// pairData.foreignUnit = 10**18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// decode144(x) = x &gt;&gt; 112</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">totalUSDV = (2**112).mul(10**18).decode144()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">totalUSDV = 10**18</span></span></code></pre>\n<p>Using <code>totalUSD</code> and <code>totalUSDV</code> we can then calculate the return value of <code>_calculateUSDVPrice</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">returnValue = (totalUSD * 1 ether) / totalUSDV;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">returnValue = 1e8 * 1e18 / 1e18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">returnValue = 1e8</span></span></code></pre>\n<p>For the oracle implementation to be correct we then expect that the Vader protocol to treat values of 1e8 from the oracle to mean USDV is worth $1. However from the lines of code linked below we can safely assume that it is intended to be that values of 1e18 represent$1 rather than 1e8.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/tokens/USDV.sol#L76\">https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/tokens/USDV.sol#L76</a>\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/tokens/USDV.sol#L109\">https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/tokens/USDV.sol#L109</a></p>\n<p>High severity issue as the oracle is crucial for determining the exchange rate between VADER and USDV to be used for IL protection and minting/burning of USDV - an incorrect value will result in the protocol losing significant funds.</p>\n<h4 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Go over oracle calculation again to ensure that various scale factors are properly accounted for. Some handling of the difference in the number of decimals between the chainlink oracle and the foreign asset should be added.</p>\n<p>Build a test suite to ensure that the oracle returns the expected values for simple situations.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/70\">SamSteinGG (Vader) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-06-lps-of-vaderpoolv2-can-manipulate-pool-reserves-to-extract-funds-from-the-reserve\" style=\"position:relative;\"><a href=\"#h-06-lps-of-vaderpoolv2-can-manipulate-pool-reserves-to-extract-funds-from-the-reserve\" aria-label=\"h 06 lps of vaderpoolv2 can manipulate pool reserves to extract funds from the reserve permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/55\">[H-06] LPs of <code>VaderPoolV2</code> can manipulate pool reserves to extract funds from the reserve.</a></h2>\n<p><em>Submitted by TomFrenchBlockchain, also found by hyh</em></p>\n<p>Impermanent loss protection can be exploited to drain the reserve.</p>\n<h4 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>In <code>VaderPoolV2.burn</code> we calculate the current losses that the LP has made to impermanent loss.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex-v2/pool/VaderPoolV2.sol#L265-L296\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex-v2/pool/VaderPoolV2.sol#L265-L296</a></p>\n<p>These losses are then refunded to the LP in VADER tokens from the reserve.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex-v2/router/VaderRouterV2.sol#L220\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex-v2/router/VaderRouterV2.sol#L220</a></p>\n<p>This loss is calculated by the current reserves of the pool so if an LP can manipulate the pool’s reserves they can artificially engineer a huge amount of IL in order to qualify for a payout up to the size of their LP position.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex/math/VaderMath.sol#L72-L92\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex/math/VaderMath.sol#L72-L92</a></p>\n<p>The attack is then as follows.</p>\n<ol>\n<li>Be an LP for a reasonable period of time (IL protection scales linearly up to 100% after a year)</li>\n<li>Flashloan a huge amount of one of the pool’s assets.</li>\n<li>Trade against the pool with the flashloaned funds to unbalance it such that your LP position has huge IL.</li>\n<li>Remove your liquidity and receive compensation from the reserve for the IL you have engineered.</li>\n<li>Re-add your liquidity back to the pool.</li>\n<li>Trade against the pool to bring it back into balance.</li>\n</ol>\n<p>The attacker now holds the majority of their flashloaned funds (minus slippage/swap fees) along with a large fraction of the value of their LP position in VADER paid out from the reserve. The value of their LP position is unchanged. Given a large enough LP position, the IL protection funds extracted from the reserve will exceed the funds lost to swap fees and the attacker will be able to repay their flashloan with a profit.</p>\n<p>This is a high risk issue as after a year any large LP is incentivised and able to perform this attack and drain reserve funds.</p>\n<h4 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Use a manipulation resistant oracle for the relative prices of the pool’s assets (TWAP, etc.)</p>\n<hr>\n<h2 id=\"h-07-redemption-value-of-synths-can-be-manipulated-to-drain-vaderpoolv2-of-all-native-assets-in-the-associated-pair\" style=\"position:relative;\"><a href=\"#h-07-redemption-value-of-synths-can-be-manipulated-to-drain-vaderpoolv2-of-all-native-assets-in-the-associated-pair\" aria-label=\"h 07 redemption value of synths can be manipulated to drain vaderpoolv2 of all native assets in the associated pair permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/5\">[H-07] Redemption value of synths can be manipulated to drain <code>VaderPoolV2</code> of all native assets in the associated pair</a></h2>\n<p><em>Submitted by TomFrenchBlockchain, also found by certora</em></p>\n<p>Draining of funds from <code>VaderPoolV2</code>.</p>\n<h4 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>See the <code>VaderPool.mintSynth</code> function:\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex-v2/pool/VaderPoolV2.sol#L153-L194\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex-v2/pool/VaderPoolV2.sol#L153-L194</a></p>\n<p>As the pool’s reserves can be manipulated through flashloans similar to on UniswapV2 (the slip mechanism can be mitigated by splitting the manipulation over a number of trades), an attacker may set the exchange rate between <code>nativeAsset</code> and synths (calculated from the reserves). An attacker can exploit this to drain funds from the pool.</p>\n<ol>\n<li>The attacker first flashloans and sells a huge amount of <code>foreignAsset</code> to the pool. The pool now thinks <code>nativeAsset</code> is extremely valuable.</li>\n<li>The attacker now uses a relatively small amount of <code>nativeAsset</code> to mint synths using <code>VaderPool.mintSynth</code>. As the pool thinks <code>nativeAsset</code> is very valuable the attacker will receive a huge amount of synths.</li>\n<li>The attacker can now manipulate the pool in the opposite direction by buying up the <code>foreignAsset</code> they sold to the pool. <code>nativeAsset</code> is now back at its normal price, or perhaps artificially low if the attacker wishes.</li>\n<li>The attacker now burns all of their synths. As <code>nativeAsset</code> is considered much less valuable than at the point the synths were minted it takes a lot more of <code>nativeAsset</code> in order to pay out for the burned synths.</li>\n</ol>\n<p>For the price of a flashloan and some swap fees, the attacker has now managed to extract a large amount of <code>nativeAsset</code> from the pool. This process can be repeated as long as it is profitable.</p>\n<h4 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Tie the exchange rate use for minting/burning synths to a manipulation resistant oracle.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/5\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"h-08-reserve-does-not-properly-apply-prices-of-vader-and-usdv-tokens\" style=\"position:relative;\"><a href=\"#h-08-reserve-does-not-properly-apply-prices-of-vader-and-usdv-tokens\" aria-label=\"h 08 reserve does not properly apply prices of vader and usdv tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/71\">[H-08] Reserve does not properly apply prices of VADER and USDV tokens</a></h2>\n<p><em>Submitted by TomFrenchBlockchain</em></p>\n<p>Reserve pays out vastly higher (or lower) IL protection than it should.</p>\n<h4 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Consider the lines 98 and 102 as shown on the link below:</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/reserve/VaderReserve.sol#L95-L103\">https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/reserve/VaderReserve.sol#L95-L103</a></p>\n<p>Here we multiply the IL experienced by the LP by a price for USDV or VADER as returned by the LBT. However the price from the oracle is a fixed point number (scaled up by 1e8 or 1e18 depending on the resolution of finding “Oracle returns an improperly scaled USDV/VADER price”) and so a fixed scaling factor should be applied to convert back from a fixed point number to a standard integer.</p>\n<p>As it stands depending on the branch which is executed, the amount to be reimbursed will be 1e18 times too large or too small. Should the “else” branch be executed the reserve will pay out much in terms of IL protection resulting in severe loss of funds. High severity.</p>\n<h4 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Apply similar logic to as displayed here:</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/tokens/USDV.sol#L109\">https://github.com/code-423n4/2021-12-vader/blob/00ed84015d4116da2f9db0c68db6742c89e73f65/contracts/tokens/USDV.sol#L109</a></p>\n<hr>\n<h2 id=\"h-09-usdvsol-mint-and-burn-amounts-are-incorrect\" style=\"position:relative;\"><a href=\"#h-09-usdvsol-mint-and-burn-amounts-are-incorrect\" aria-label=\"h 09 usdvsol mint and burn amounts are incorrect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/164\">[H-09] <code>USDV.sol</code> Mint and Burn Amounts Are Incorrect</a></h2>\n<p><em>Submitted by leastwood, also found by TomFrenchBlockchain</em></p>\n<p>The <code>USDV.mint</code> function queries the price of <code>Vader</code> from the <code>LiquidityBasedTwap</code> contract. The calculation to determine <code>uAmount</code> in <code>mint</code> is actually performed incorrectly. <code>uAmount = (vPrice * vAmount) / 1e18;</code> will return the <code>USD</code> amount for the provided <code>Vader</code> as <code>vPrice</code> is denominated in <code>USD/Vader</code>. This <code>uAmount</code> is subsequently used when minting tokens for the user (locked for a period of time) and fee to the contract owner.</p>\n<p>This same issue also applies to how <code>vAmount = (uPrice * uAmount) / 1e18;</code> is calculated in <code>USDV.burn</code>.</p>\n<p>This is a severe issue, as the <code>mint</code> and <code>burn</code> functions will always use an incorrect amount of tokens, leading to certain loss by either the protocol (if the user profits) or the user (if the user does not profit).</p>\n<h4 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/tokens/USDV.sol#L66-L98\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/tokens/USDV.sol#L66-L98</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function mint(uint256 vAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    onlyWhenNotLocked</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    returns (uint256 uAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 vPrice = lbt.getVaderPrice();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vader.transferFrom(msg.sender, address(this), vAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vader.burn(vAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uAmount = (vPrice * vAmount) / 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (cycleTimestamp &lt;= block.timestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cycleTimestamp = block.timestamp + 24 hours;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cycleMints = uAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cycleMints += uAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            cycleMints &lt;= dailyLimit,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &quot;USDV::mint: 24 Hour Limit Reached&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (exchangeFee != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 fee = (uAmount * exchangeFee) / _MAX_BASIS_POINTS;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uAmount = uAmount - fee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mint(owner(), fee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _mint(address(this), uAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _createLock(LockTypes.USDV, uAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/tokens/USDV.sol#L100-L120\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/tokens/USDV.sol#L100-L120</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function burn(uint256 uAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    onlyWhenNotLocked</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    returns (uint256 vAmount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 uPrice = lbt.getUSDVPrice();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _burn(msg.sender, uAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vAmount = (uPrice * uAmount) / 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (exchangeFee != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 fee = (vAmount * exchangeFee) / _MAX_BASIS_POINTS;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vAmount = vAmount - fee;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vader.mint(owner(), fee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vader.mint(address(this), vAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _createLock(LockTypes.VADER, vAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider utilising both <code>getVaderPrice</code> and <code>getUSDVPrice</code> when calculating the expected <code>uAmount</code> and <code>vAmount</code> to mint or burn. To calculate <code>uAmount</code> in <code>mint</code>, <code>vPrice</code> should be denominated in <code>USDV/Vader</code>. To calculate <code>vAmount</code> in <code>burn</code>, <code>uPrice</code> should be denominated in <code>Vader/USDV</code>. It would be useful to add unit tests to test this explicitly as it is expected that users will interact with the <code>USDV.sol</code> contract frequently.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/164#issuecomment-1001314244\">0xstormtrooper (Vader) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Mint / burn calculation with USD is intentional, modeled after LUNA / UST.</p>\n<p>Mint USDV<br>\n1 USD worth of Vader should mint 1 USDV</p>\n<p>Burn USDV<br>\n1 USDV should mint 1 USD worth of Vader</p>\n<p><a href=\"https://docs.terra.money/Concepts/Protocol.html#expansion-and-contraction\">https://docs.terra.money/Concepts/Protocol.html#expansion-and-contraction</a></p>\n</blockquote>\n<hr>\n<h2 id=\"h-10-previousprices-is-never-updated-upon-syncing-token-price\" style=\"position:relative;\"><a href=\"#h-10-previousprices-is-never-updated-upon-syncing-token-price\" aria-label=\"h 10 previousprices is never updated upon syncing token price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/103\">[H-10] <code>previousPrices</code> Is Never Updated Upon Syncing Token Price</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>The <code>LiquidityBasedTWAP</code> contract attempts to accurately track the price of <code>VADER</code> and <code>USDV</code> while still being resistant to flash loan manipulation and short-term volatility. The <code>previousPrices</code> array is meant to track the last queried price for the two available paths, namely <code>VADER</code> and <code>USDV</code>.</p>\n<p>The <code>setupVader</code> function configures the <code>VADER</code> token by setting <code>previousPrices</code> and adding a token pair. However, <code>syncVaderPrice</code> does not update <code>previousPrices</code> after syncing, causing <code>currentLiquidityEvaluation</code> to be dependent on the initial price for <code>VADER</code>. As a result, liquidity weightings do not accurately reflect the current and most up to date price for <code>VADER</code>.</p>\n<p>This same issue also affects how <code>USDV</code> calculates <code>currentLiquidityEvaluation</code>.</p>\n<p>This issue is of high risk and heavily impacts the accuracy of the TWAP implementation as the set price for <code>VADER/USDV</code> diverges from current market prices. For example, as the Chainlink oracle price and initial price for <code>VADER</code> diverge, <code>currentLiquidityEvaluation</code> will begin to favour either on-chain or off-chain price data depending on which price result is greater. The following calculation for <code>currentLiquidityEvaluation</code> outlines this behaviour.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">currentLiquidityEvaluation =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (reserveNative * previousPrices[uint256(Paths.VADER)]) +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (reserveForeign * getChainlinkPrice(pairData.foreignAsset));</span></span></code></pre>\n<h4 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/lbt/LiquidityBasedTWAP.sol#L150-L189\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/lbt/LiquidityBasedTWAP.sol#L150-L189</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _updateVaderPrice(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IUniswapV2Pair pair,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ExchangePair storage pairData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 timeElapsed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) internal returns (uint256 currentLiquidityEvaluation) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool isFirst = pair.token0() == vader;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 reserve0, uint256 reserve1, ) = pair.getReserves();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 reserveNative, uint256 reserveForeign) = isFirst</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ? (reserve0, reserve1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        : (reserve1, reserve0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 price0Cumulative,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 price1Cumulative,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 currentMeasurement</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) = UniswapV2OracleLibrary.currentCumulativePrices(address(pair));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 nativeTokenPriceCumulative = isFirst</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ? price0Cumulative</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        : price1Cumulative;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pairData.nativeTokenPriceAverage = FixedPoint.uq112x112(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint224(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                (nativeTokenPriceCumulative -</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    pairData.nativeTokenPriceCumulative) / timeElapsed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pairData.nativeTokenPriceCumulative = nativeTokenPriceCumulative;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pairData.lastMeasurement = currentMeasurement;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    currentLiquidityEvaluation =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (reserveNative * previousPrices[uint256(Paths.VADER)]) +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (reserveForeign * getChainlinkPrice(pairData.foreignAsset));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/lbt/LiquidityBasedTWAP.sol#L221-L235\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/lbt/LiquidityBasedTWAP.sol#L221-L235</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function setupVader(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IUniswapV2Pair pair,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IAggregatorV3 oracle,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 updatePeriod,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 vaderPrice</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        previousPrices[uint256(Paths.VADER)] == 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;LBTWAP::setupVader: Already Initialized&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    previousPrices[uint256(Paths.VADER)] = vaderPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _addVaderPair(pair, oracle, updatePeriod);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider updating <code>previousPrices[uint256(Paths.VADER)]</code> and <code>previousPrices[uint256(Paths.USDV)]</code> after syncing the respective prices for the two tokens. This will ensure the most up to date price is used when evaluating liquidity for all available token pairs.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/103\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"h-11-totalliquidityweight-is-updated-when-adding-new-token-pairs-which-skews-price-data-for-getvaderprice-and-getusdvprice\" style=\"position:relative;\"><a href=\"#h-11-totalliquidityweight-is-updated-when-adding-new-token-pairs-which-skews-price-data-for-getvaderprice-and-getusdvprice\" aria-label=\"h 11 totalliquidityweight is updated when adding new token pairs which skews price data for getvaderprice and getusdvprice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/105\">[H-11] <code>totalLiquidityWeight</code> Is Updated When Adding New Token Pairs Which Skews Price Data For <code>getVaderPrice</code> and <code>getUSDVPrice</code></a></h2>\n<p><em>Submitted by leastwood</em></p>\n<p>The <code>_addVaderPair</code> function is called by the <code>onlyOwner</code> role. The relevant data in the <code>twapData</code> mapping is set by querying the respective liquidity pool and Chainlink oracle. <code>totalLiquidityWeight</code> for the <code>VADER</code> path is also incremented by the <code>pairLiquidityEvaluation</code> amount (calculated within <code>_addVaderPair</code>). If a user then calls <code>syncVaderPrice</code>, the recently updated <code>totalLiquidityWeight</code> will be taken into consideration when iterating through all token pairs eligible for price updates to calculate the liquidity weight for each token pair. This data is stored in <code>pastTotalLiquidityWeight</code> and <code>pastLiquidityWeights</code> respectively.</p>\n<p>As a result, newly added token pairs will increase <code>pastTotalLiquidityWeight</code> while leaving <code>pastLiquidityWeights</code> underrepresented. This only occurs if <code>syncVaderPrice</code> is called before the update period for the new token has not been passed.</p>\n<p>This issue also affects how the price for <code>USDV</code> is synced.</p>\n<h4 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/lbt/LiquidityBasedTWAP.sol#L299\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/lbt/LiquidityBasedTWAP.sol#L299</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _addVaderPair(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IUniswapV2Pair pair,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IAggregatorV3 oracle,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 updatePeriod</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        updatePeriod != 0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        &quot;LBTWAP::addVaderPair: Incorrect Update Period&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(oracle.decimals() == 8, &quot;LBTWAP::addVaderPair: Non-USD Oracle&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ExchangePair storage pairData = twapData[address(pair)];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool isFirst = pair.token0() == vader;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (address nativeAsset, address foreignAsset) = isFirst</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ? (pair.token0(), pair.token1())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        : (pair.token1(), pair.token0());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    oracles[foreignAsset] = oracle;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(nativeAsset == vader, &quot;LBTWAP::addVaderPair: Unsupported Pair&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pairData.foreignAsset = foreignAsset;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pairData.foreignUnit = uint96(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        10**uint256(IERC20Metadata(foreignAsset).decimals())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pairData.updatePeriod = updatePeriod;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pairData.lastMeasurement = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pairData.nativeTokenPriceCumulative = isFirst</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ? pair.price0CumulativeLast()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        : pair.price1CumulativeLast();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 reserve0, uint256 reserve1, ) = pair.getReserves();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (uint256 reserveNative, uint256 reserveForeign) = isFirst</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ? (reserve0, reserve1)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        : (reserve1, reserve0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 pairLiquidityEvaluation = (reserveNative *</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        previousPrices[uint256(Paths.VADER)]) +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (reserveForeign * getChainlinkPrice(foreignAsset));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pairData.pastLiquidityEvaluation = pairLiquidityEvaluation;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    totalLiquidityWeight[uint256(Paths.VADER)] += pairLiquidityEvaluation;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vaderPairs.push(pair);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (maxUpdateWindow &lt; updatePeriod) maxUpdateWindow = updatePeriod;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/lbt/LiquidityBasedTWAP.sol#L113-L148\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/lbt/LiquidityBasedTWAP.sol#L113-L148</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function syncVaderPrice()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    public</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    returns (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256[] memory pastLiquidityWeights,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 pastTotalLiquidityWeight</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _totalLiquidityWeight;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 totalPairs = vaderPairs.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pastLiquidityWeights = new uint256[](totalPairs);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pastTotalLiquidityWeight = totalLiquidityWeight[uint256(Paths.VADER)];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for (uint256 i; i &lt; totalPairs; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IUniswapV2Pair pair = vaderPairs[i];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ExchangePair storage pairData = twapData[address(pair)];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 timeElapsed = block.timestamp - pairData.lastMeasurement;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (timeElapsed &lt; pairData.updatePeriod) continue;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 pastLiquidityEvaluation = pairData.pastLiquidityEvaluation;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 currentLiquidityEvaluation = _updateVaderPrice(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pair,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pairData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            timeElapsed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pastLiquidityWeights[i] = pastLiquidityEvaluation;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pairData.pastLiquidityEvaluation = currentLiquidityEvaluation;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _totalLiquidityWeight += currentLiquidityEvaluation;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    totalLiquidityWeight[uint256(Paths.VADER)] = _totalLiquidityWeight;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>As shown above, <code>pastTotalLiquidityWeight = totalLiquidityWeight[uint256(Paths.VADER)]</code> loads in the total liquidity weight which is updated when <code>_addVaderPair</code> is called. However, <code>pastLiquidityWeights</code> is calculated by iterating through each token pair that is eligible to be updated.</p>\n<h4 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider removing the line <code>totalLiquidityWeight[uint256(Paths.VADER)] += pairLiquidityEvaluation;</code> in <code>_addVaderPair</code> so that newly added tokens do not impact upcoming queries for <code>VADER/USDV</code> price data. This should ensure <code>syncVaderPrice</code> and <code>syncUSDVPrice</code> cannot be manipulated when adding new tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/105\">SamSteinGG (Vader) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-12-using-single-total-native-reserve-variable-for-synth-and-non-synth-reserves-of-vaderpoolv2-can-lead-to-losses-for-synth-holders\" style=\"position:relative;\"><a href=\"#h-12-using-single-total-native-reserve-variable-for-synth-and-non-synth-reserves-of-vaderpoolv2-can-lead-to-losses-for-synth-holders\" aria-label=\"h 12 using single total native reserve variable for synth and non synth reserves of vaderpoolv2 can lead to losses for synth holders permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/179\">[H-12] Using single total native reserve variable for synth and non-synth reserves of <code>VaderPoolV2</code> can lead to losses for synth holders</a></h2>\n<p><em>Submitted by hyh, also found by certora</em></p>\n<p>Users that mint synths do provide native assets, increasing native reserve pool, but do not get any liquidity shares issued.\nIn the same time, an exit of non-synth liquidity provider yields releasing a proportion of all current reserves to him.</p>\n<p>Whenever an exit of non-synth LP is substantial enough, the system will have much less native asset regarding the cumulative deposit of synth holders. That is, when a LP entered he provided a share of current reserves, both native and foreign, and got the corresponding liquidity shares in return. Suppose then big enough amounts of synths were minted, providing correspondingly big enough amount of native assets. If the LP now wants to exit, he will obtain a part of total native assets, including a part of the amount that was provided by synth minter. If the exit is big enough there will be substantially less native assets left to reimburse the synth minter than he initially provided. This is not reversible: the synth minters lost their native assets to LP that exited.</p>\n<h4 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>There are three types of mint/burn: NFT, fungible and synths. First two get LP shares, the latter gets synths. Whenever NFT or fungible LP exits, it gets a proportion of combined reserves. That is, some of native reserves were deposited by synth minters, but it is not accounted anyhow, only one total reserve number per asset is used.</p>\n<p>Suppose the following scenario, Alice wants to provide liquidity, while Bob wants to mint synths:</p>\n<ol>\n<li>Alice deposits both sides to a pool, 100 USDV and 100 foreign.</li>\n<li>Bob deposit 100 USDV and mints some foreign Synth.</li>\n<li>LP withdraws 95% of her liquidity shares. As she owns the pool liquidity, she gets 95% of USDV and foreign total reserves, 190 USDV and 95 foreign. Alice received almost all of her and Bob’s USDV.</li>\n<li>If Bob burn his synth and withdraw, he will get a tiny fraction of USDV he deposited (calculated by VaderMath.calculateSwap, we use its terms):</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex/math/VaderMath.sol#L98\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex/math/VaderMath.sol#L98</a>\nx = 100, X = 0.05 * 200 = 10, Y = 0.05 * 100 = 5.\nSwap outcome, how much USDV will Bob get, is x * Y * X / (x + X) ^ 2 = 100 * 5 * 10 / (110^2) = 0.4 (rounded).</p>\n<p>The issue is that synth provided and LP provided USDV aren’t accounted separately, total reserves number if used everywhere instead:</p>\n<p>Synth minters provide native asset, say USDV, to the system:\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L187\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L187</a></p>\n<p>Synth minters get synths and no LP shares, while to account for their deposit, the total USDV balance is increased:\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L187\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L187</a></p>\n<p>When LP enters, it gets liquidity shares proportionally to current reserves (NFT mint, notice the reserveNative, which is BasePoolV2’s pair.reserveNative, total amount of native asset in the Pool):\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/BasePoolV2.sol#L497\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/BasePoolV2.sol#L497</a></p>\n<p>When LP exits, it gets a proportion of current reserves back (NFT burn):\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/BasePoolV2.sol#L223\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/BasePoolV2.sol#L223</a></p>\n<p>The same happens when fungible LP mints (same reserveNative):\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L336\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L336</a>\nAnd burns:\n<a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L401\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L401</a></p>\n<h4 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Account for LP provided liquidity separately from total amount variables, i.e. use only LP provided native reserves variables in LP shares mint and burn calculations.\nThat should suffice as total amount of native assets is still to be used elsewhere, whenever the whole pool is concerned, for example, in rescue function, swap calculations and so forth.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/179\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"h-13-council-veto-protection-does-not-work\" style=\"position:relative;\"><a href=\"#h-13-council-veto-protection-does-not-work\" aria-label=\"h 13 council veto protection does not work permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/44\">[H-13] Council veto protection does not work</a></h2>\n<p><em>Submitted by TomFrenchBlockchain</em></p>\n<p>Council can veto proposals to remove them to remain in power.</p>\n<h4 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>The Vader governance contract has the concept of a “council” which can unilaterally accept or reject a proposal. To prevent a malicious council preventing itself from being replaced by the token holders, the veto function checks the calldata for any proposal action directed at <code>GovernorAlpha</code> to see if it matches the <code>changeCouncil</code> function selector.</p>\n<p>Note this is done by reading from the <code>proposal.calldatas</code> array.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/GovernorAlpha.sol#L568-L603\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/GovernorAlpha.sol#L568-L603</a></p>\n<p>If we look at the structure of a proposal however we can see that the function selector is held (in the form of the signature) in the <code>signatures</code> array rather than being included in the calldata. The <code>calldata</code> array then holds just the function arguments for the call rather than specifying which function to call.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/GovernorAlpha.sol#L71-L72\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/GovernorAlpha.sol#L71-L72</a></p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/GovernorAlpha.sol#L356-L362\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/GovernorAlpha.sol#L356-L362</a></p>\n<p>Indeed if we look at the <code>TimeLock</code> contract we see that the signature is hashed to calculate the function selector and is prepended onto the calldata.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/Timelock.sol#L292-L299\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/Timelock.sol#L292-L299</a></p>\n<p>Looking at the function signature of the <code>changeCouncil</code> we can see that the value that the <code>veto</code> function will check against <code>this.changeCouncil.signature</code> will be the first 4 bytes of an abi encoded address and so will always be zero no matter what function is being called.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/GovernorAlpha.sol#L623\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/governance/GovernorAlpha.sol#L623</a></p>\n<p>High risk as this issue gives the council absolute control over the DAO such that they cannot be removed.</p>\n<h4 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Hash the function signatures to calculate function selectors and then check those rather than the calldata.</p>\n<p>This is something that should be picked up by a test suite however, I’d recommend writing tests to ensure that protections you add to the code have any affect and more broadly check that the code behaves as expected.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/44\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"h-14-denial-of-service\" style=\"position:relative;\"><a href=\"#h-14-denial-of-service\" aria-label=\"h 14 denial of service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/98\">[H-14] Denial of service</a></h2>\n<p><em>Submitted by danb</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L334\">https://github.com/code-423n4/2021-12-vader/blob/main/contracts/dex-v2/pool/VaderPoolV2.sol#L334</a>\non the first deposit, the total liquidity is set to <code>nativeDeposit</code>.\nthis might be a very low number compared to <code>foreignDeposit</code>.\nIt can cause a denial of service of the pair.</p>\n<h4 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>A pair can enter a denial of service state.</p>\n<h4 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>consider the following scenario:\nthe owner of the pool calls <code>setFungibleTokenSupport</code> for a new token, for example weth.\na malicious actor calls <code>mintFungible</code>,  with <code>nativeDeposit == 1</code> and <code>foreignDeposit == 10 ether</code>.\n<code>totalLiquidityUnits</code> will be 1.\nthe pool can be arbitraged, even by the attacker, but <code>totalLiquidityUnits</code> will still be 1.\nthis means that 1 liquidity token is equal to all of the pool reserves, which is a lot of money.\nIt will cause a very high rounding error for anyone trying to mint liquidity.\nthen, anyone who will try to mint liquidity will either:</p>\n<ol>\n<li>fail, because they can’t mint 0 liquidity if their amount is too small.</li>\n<li>get less liquidity tokens than they should, because there is a very high rounding error, and its against new liquidity providers.</li>\n</ol>\n<p>The rounding error losses will increase the pool reserves, which will increase value of liquidity tokens, so the hacker can even profit from this.</p>\n<p>after this is realised, no one will want to provide liquidity, and since the pair cannot be removed or replaced, it will cause denial of service for that token forever.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/98\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"medium-risk-findings-6\" style=\"position:relative;\"><a href=\"#medium-risk-findings-6\" aria-label=\"medium risk findings 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (6)</h1>\n<h2 id=\"m-01-vaderpoolv2mintfungible-exposes-users-to-unlimited-slippage\" style=\"position:relative;\"><a href=\"#m-01-vaderpoolv2mintfungible-exposes-users-to-unlimited-slippage\" aria-label=\"m 01 vaderpoolv2mintfungible exposes users to unlimited slippage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/2\">[M-01] <code>VaderPoolV2.mintFungible</code> exposes users to unlimited slippage</a></h2>\n<p><em>Submitted by TomFrenchBlockchain, also found by pauliax and robee</em></p>\n<p>Frontrunners can extract up to 100% of the value provided by LPs to VaderPoolV2 as fungible liquidity.</p>\n<h4 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Users can provide liquidity to <code>VaderPoolV2</code> through the <code>mintFungible</code> function.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex-v2/pool/VaderPoolV2.sol#L311-L317\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex-v2/pool/VaderPoolV2.sol#L311-L317</a></p>\n<p>This allows users to provide tokens in any ratio and the pool will calculate what fraction of the value in the pool this makes up and mint the corresponding amount of liquidity units as an ERC20.</p>\n<p>However there’s no way for users to specify the minimum number of liquidity units they will accept. As the number of liquidity units minted is calculated from the current reserves, this allows frontrunners to manipulate the pool’s reserves in such a way that the LP receives fewer liquidity units than they should. e.g. LP provides a lot of <code>nativeAsset</code> but very little <code>foreignAsset</code>, the frontrunner can then sell a lot of <code>nativeAsset</code> to the pool to devalue it.</p>\n<p>Once this is done the attacker returns the pool’s reserves back to normal and pockets a fraction of the value which the LP meant to provide as liquidity.</p>\n<h4 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add a user-specified minimum amount of LP tokens to mint.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/2\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/2#issuecomment-1066036603\">Jack the Pug (judge) decreased severity to medium and commented</a>:</strong></p>\n<blockquote>\n<p>I’m downgrading this [from <code>high</code>] to <code>med</code> and merging all the issues related to slippage control into this one.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-adding-pair-of-the-same-foreignasset-would-replace-oracle-of-earlier-entry\" style=\"position:relative;\"><a href=\"#m-02-adding-pair-of-the-same-foreignasset-would-replace-oracle-of-earlier-entry\" aria-label=\"m 02 adding pair of the same foreignasset would replace oracle of earlier entry permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/160\">[M-02] Adding pair of the same <code>foreignAsset</code> would replace oracle of earlier entry</a></h2>\n<p><em>Submitted by gzeon</em></p>\n<p>Oracles are mapped to the <code>foreignAsset</code> but not to the specific pair. Pairs with the same <code>foreignAsset</code> (e.g. UniswapV2 and Sushi) will be forced to use the same oracle. Generally this should be the expected behavior but there are also possibility that while adding a new pair changed the oracle of an older pair unexpectedly.</p>\n<h4 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/9fb7f206eaff1863aeeb8f997e0f21ea74e78b49/contracts/lbt/LiquidityBasedTWAP.sol#L271\">https://github.com/code-423n4/2021-12-vader/blob/9fb7f206eaff1863aeeb8f997e0f21ea74e78b49/contracts/lbt/LiquidityBasedTWAP.sol#L271</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        oracles[foreignAsset] = oracle;</span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Bind the oracle to pair instead</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/160\">SamSteinGG (Vader) confirmed</a></strong></p>\n<hr>\n<h2 id=\"m-03-no-way-to-remove-gasthrottle-from-vaderpool-after-deployment\" style=\"position:relative;\"><a href=\"#m-03-no-way-to-remove-gasthrottle-from-vaderpool-after-deployment\" aria-label=\"m 03 no way to remove gasthrottle from vaderpool after deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/52\">[M-03] No way to remove <code>GasThrottle</code> from <code>VaderPool</code> after deployment</a></h2>\n<p><em>Submitted by TomFrenchBlockchain</em></p>\n<p>Potential DOS on swaps on <code>VaderPool</code>.</p>\n<h4 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>BasePool makes use of a <code>validateGas</code> modifier on swaps which checks that the user’s gas price is below the value returned by <code>_FAST_GAS_ORACLE</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex/pool/BasePool.sol#L292\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex/pool/BasePool.sol#L292</a></p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex/utils/GasThrottle.sol#L8-L22\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/dex/utils/GasThrottle.sol#L8-L22</a></p>\n<p>Should  <code>_FAST_GAS_ORACLE</code> be compromised to always return zero then all swaps will fail. There is no way to recover from this scenario.</p>\n<h4 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Either remove GasThrottle.sol entirely or allow governance to turn it off as is done in VaderPoolV2.sol</p>\n<hr>\n<h2 id=\"m-04-vaderreservereimburseimpermanentloss-improperly-converts-usdv-to-vader\" style=\"position:relative;\"><a href=\"#m-04-vaderreservereimburseimpermanentloss-improperly-converts-usdv-to-vader\" aria-label=\"m 04 vaderreservereimburseimpermanentloss improperly converts usdv to vader permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/7\">[M-04] <code>VaderReserve.reimburseImpermanentLoss</code> improperly converts USDV to VADER</a></h2>\n<p><em>Submitted by TomFrenchBlockchain</em></p>\n<p>IL isn’t properly converted from being in terms of USDV to VADER, resulting in reserve paying out incorrect amount.</p>\n<h4 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>VaderReserve.reimburseImpermanentLoss</code> receives an <code>amount</code> in terms of USDV and converts this to an amount of VADER to send to <code>recipient</code>.</p>\n<p>However as shown in the link if there is a previous price stored for USDV, the amount of VADER tokens to be sent to the <code>recipient</code> is <code>amount / usdvPrice</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/reserve/VaderReserve.sol#L84-L110\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/reserve/VaderReserve.sol#L84-L110</a></p>\n<p><code>usdvPrice</code> is the total USD value of foreign assets divided by the total amount of USDV in a number of pairs. It’s then some measure of the inverse of the price of USDV in USD, nothing to do with converting into VADER.</p>\n<p>The reserve will then improperly calculate the amount of VADER to pay out once there is a single reading of the USDV price.</p>\n<h4 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>It looks like both branches of this if statement are supposed to be run, i.e. convert from USDV to USD and then to VADER but I can’t be sure. Care should be taken so that the calculation being performed is the expected one.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/7\">SamSteinGG (Vader) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-05-users-can-lock-themselves-out-of-being-able-to-convert-veth-becoming-stuck-with-the-deprecated-asset\" style=\"position:relative;\"><a href=\"#m-05-users-can-lock-themselves-out-of-being-able-to-convert-veth-becoming-stuck-with-the-deprecated-asset\" aria-label=\"m 05 users can lock themselves out of being able to convert veth becoming stuck with the deprecated asset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/97\">[M-05] Users can lock themselves out of being able to convert VETH, becoming stuck with the deprecated asset</a></h2>\n<p><em>Submitted by TomFrenchBlockchain</em></p>\n<p>I’ve put this as a medium issue as we’re leaking value as users are stuck with assets which are likely to be worth much less as they are deprecated. It could also be low as it’s not exploitable by outside parties and the loss isn’t taken by the protocol but the user.</p>\n<h4 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Potential for users to lose the right to convert VETH to VADER, being stuck with a deprecated token.</p>\n<h4 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Should a user have a zero allowance of VETH on the converter, no VETH will be taken and no VADER will be paid out as L147 will set the amount to zero.</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/28d3405447f0c3353964ca755a42562840d151c5/contracts/tokens/converter/Converter.sol#L145-L150\">https://github.com/code-423n4/2021-12-vader/blob/28d3405447f0c3353964ca755a42562840d151c5/contracts/tokens/converter/Converter.sol#L145-L150</a></p>\n<p>There is a <code>minVader</code> check on L153 to enforce a minimum output of VADER but should this be improperly set the transaction would succeed with the user receiving much less VADER than they expect.</p>\n<p>Crucially, the merkle proof that was used in this transaction will be marked as invalid so the user will not be able to try again once they have set the proper allowance. Someone can then lose the opportunity to convert their VETH and are left with a worthless deprecated token if they are inattentive.</p>\n<p>It seems like this is trying to handle the case where a user doesn’t have the full amount of VETH as they are entitled to convert (by setting their allowance equal to their balance?). This is a pretty suboptimal way to go about this as it’s extremely implicit so users are liable to make mistakes.</p>\n<p>I’d recommend decoupling the merkle proof from conversion of VETH to VADER:</p>\n<ol>\n<li>Change the merkle proof to set an <code>amountEligibleToConvert</code> value in storage for each user (which would be initially set to <code>amount</code>).</li>\n<li>Allow a user to then convert VETH to VADER up to their <code>amountEligibleToConvert</code> value, subtracting the amount converted from this each time.</li>\n</ol>\n<p>For gas efficiency we can use a sentinel value here to mark a user which has claimed their full quota already distinctly from someone who hasn’t provided a merkle proof yet (to avoid having to track this separately in another storage slot)</p>\n<p>These two steps could be chained in a single transaction to give a similar UX as currently but would also allow users to recover in the case of partial conversions.</p>\n<h4 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>As above. I’d caution against just stating “The frontend will handle this correctly so this isn’t an issue”, there will be users who interact with the contract manually so it’s important to make the interface safe where possible.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/97\">0xstormtrooper (Vader) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-06-oracle-can-be-manipulted-to-consider-only-a-single-pair-for-pricing\" style=\"position:relative;\"><a href=\"#m-06-oracle-can-be-manipulted-to-consider-only-a-single-pair-for-pricing\" aria-label=\"m 06 oracle can be manipulted to consider only a single pair for pricing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/40\">[M-06] Oracle can be manipulted to consider only a single pair for pricing</a></h2>\n<p><em>Submitted by TomFrenchBlockchain</em></p>\n<p>Loss of resilience of oracle to a faulty pricing for a single pair.</p>\n<h4 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>In the oracle we calculate the TVL of each pool by pulling the reserves and multiplying both assets by the result of a supposedly manipulation resistant oracle (the oracle queries its previous value for USDV and pulls the foreign asset from chainlink).</p>\n<p><a href=\"https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/lbt/LiquidityBasedTWAP.sol#L353-L383\">https://github.com/code-423n4/2021-12-vader/blob/fd2787013608438beae361ce1bb6d9ffba466c45/contracts/lbt/LiquidityBasedTWAP.sol#L353-L383</a></p>\n<p>This value can be manipulated by skewing the reserves of the underlying pair with a flashloan attack. An attacker can then make a pool appear with an arbitrarily large <code>currentLiquidityEvaluation</code> which will result in all other pairs contributing negligibly to the final result of the oracle.</p>\n<p>This doesn’t result in loss of funds by itself afaict but should there be an issue for the chainlink price feed for the asset in any pool then an attacker can force the oracle to only use that pool for pricing USDV/VADER</p>\n<p>Medium risk as “Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.” External requirements being a malfunctioning or deprecated chainlink pricefeed for any used asset.</p>\n<p>Calculating TVL of the pool is equivalent to value of all LP tokens so for more information see this post: <a href=\"https://blog.alphafinance.io/fair-lp-token-pricing/\">https://blog.alphafinance.io/fair-lp-token-pricing/</a></p>\n<h4 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Calculate fair reserves using the pool invariant and the fair prices of the two assets.</p>\n<p>The above link contains a mitigates for Uniswap, a similar calculation would have to be performed which is specific for the Vader invariant.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/40#issuecomment-1001506397\">SamSteinGG (Vader) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>The evaluation of liquidity for a particular pair is performed based on the reserves of the previous block rendering a flash loan attack impossible. Can the  warden clarify how he is expecting this to be exploited?</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-findings-17\" style=\"position:relative;\"><a href=\"#low-risk-findings-17\" aria-label=\"low risk findings 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (17)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/41\">[L-01] unsafe cast</a> <em>Submitted by certora</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/110\">[L-02] Out of gas.</a> <em>Submitted by Jujic, also found by jayjonah8, pauliax, and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/4\">[L-03] Core AMM logic is written to give the impression it is working on a different asset than it is.</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/111\">[L-04] SHOULD CHECK RETURN DATA FROM CHAINLINK AGGREGATORS (Timestamp)</a> <em>Submitted by defsec, also found by danb, hyh, Jujic, and TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/106\">[L-05] <code>USDV.claim</code> Does Not Check If Index Is Valid</a> <em>Submitted by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/61\">[L-06] VaderMath:calculateSwapReverse require statement change to &#x3C;= instead of &#x3C;</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/104\">[L-07] No Method To Remove Token Pairs</a> <em>Submitted by leastwood, also found by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/102\">[L-08] <code>_addVaderPair</code> and <code>_addUSDVPair</code> Does Not Check For Duplicate Token Pairs</a> <em>Submitted by leastwood, also found by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/45\">[L-09] USDV minting limit is not applied if <code>cycleTimestamp &#x3C;= block.timestamp</code></a> <em>Submitted by TomFrenchBlockchain, also found by gzeon and pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/142\">[L-10] mintSynth might mint nothing</a> <em>Submitted by danb</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/99\">[L-11] validateGas does nothing</a> <em>Submitted by danb</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/185\">[L-12] _addUSDVPair can also update</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/134\">[L-13] loss of precision</a> <em>Submitted by danb</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/129\">[L-14] Lack of decimal control in StakingRewards</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/137\">[L-15] Lack Of Router Setter Function</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/181\">[L-16] setGasThrottle function should be moved to BasePoolV2</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/139\">[L-17] vader can be initialized twice</a> <em>Submitted by danb</em></li>\n</ul>\n<h1 id=\"non-critical-findings-14\" style=\"position:relative;\"><a href=\"#non-critical-findings-14\" aria-label=\"non critical findings 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (14)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/39\">[N-01] transfer return value of a general ERC20 is ignored</a> <em>Submitted by robee, also found by 0x1f8b, defsec, and jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/183\">[N-02] Open TODOs in Codebase</a> <em>Submitted by pauliax, also found by defsec, Dravee, and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/87\">[N-03] wrong revert message</a> <em>Submitted by certora</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/35\">[N-04] Never used parameters</a> <em>Submitted by robee, also found by jayjonah8</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/43\">[N-05] VaderMath:calculateSlipAdjustment() wrong comments</a> <em>Submitted by GiveMeTestEther</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/140\">[N-06] Lack of address(0) check</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/113\">[N-07] transferOwnership should be two step process</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/31\">[N-08] Solidity compiler versions mismatch</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/128\">[N-09] Lack of check of inputs in StakingRewards</a> <em>Submitted by 0x1f8b</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/178\">[N-10] VaderPoolV2 doesn’t implement queue system yet</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/167\">[N-11] Open Discussion That Hint Potential Security Problem Should be Avoided</a> <em>Submitted by Meta0xNull</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/172\">[N-12] Incorrect descriptions of BasePoolV2’s _onlyRouter and _supportedToken</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/117\">[N-13] USDV LockCreated event should include the index of a created lock</a> <em>Submitted by hyh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/9\">[N-14] wrong comment</a> <em>Submitted by certora</em></li>\n</ul>\n<h1 id=\"gas-optimizations-29\" style=\"position:relative;\"><a href=\"#gas-optimizations-29\" aria-label=\"gas optimizations 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (29)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/120\">[G-01] SafeMath is not needed when using Solidity version 0.8.*</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/122\">[G-02] An array’s length should be cached to save gas in for-loops</a> <em>Submitted by Dravee, also found by defsec and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/15\">[G-03] Storage double reading. Could save SLOAD</a> <em>Submitted by robee, also found by Dravee, Jujic, and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/73\">[G-04] Storage of previous prices and total liquidity weights is suboptimal for gas costs</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/188\">[G-05] Shorter revert messages</a> <em>Submitted by pauliax, also found by Dravee, Jujic, Meta0xNull, and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/25\">[G-06] Upgrade pragma to at least 0.8.4</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/175\">[G-07] Changing function visibility from public to external can save gas</a> <em>Submitted by defsec, also found by Dravee and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/11\">[G-08] Unused imports</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/12\">[G-09] Use bytes32 instead of string to save gas whenever possible</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/13\">[G-10] Unused state variables</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/19\">[G-11] State variables that could be set immutable</a> <em>Submitted by robee, also found by defsec and TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/123\">[G-12] <code>++i</code> costs less gass compared to <code>i++</code></a> <em>Submitted by Dravee, also found by defsec and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/157\">[G-13] <code>uint a = b++;</code> is a confusing syntax and can be gas-optimized</a> <em>Submitted by Dravee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/133\">[G-14] Internal functions can be private if the contract is not herited</a> <em>Submitted by Dravee, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/126\">[G-15] Explicit initialization with zero not required</a> <em>Submitted by Dravee, also found by Meta0xNull and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/8\">[G-16] Redudant 2nd call to lastTimeRewardApplicable in StakingRewards.sol</a> <em>Submitted by AmitN</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/112\">[G-17] <code>> 0</code> can be replaced with <code>!= 0</code> for gas optimization</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/130\">[G-18] Save Gas With The Unchecked Keyword</a> <em>Submitted by Dravee, also found by defsec and Jujic</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/77\">[G-19] Modifier onlyUSDV() and function _onlyUSDV()</a> <em>Submitted by Jujic</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/151\">[G-29] Missing boundary check in USDV.sol</a> <em>Submitted by p4st13r4</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/187\">[G-20] Avoid repeated calculations</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/152\">[G-21] Keccak functions in constants waste gas</a> <em>Submitted by p4st13r4</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/176\">[G-22] Redundant Constant Inheritance</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/115\">[G-23] Less than 256 uints are not gas efficient</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/58\">[G-24] Functions to calculate synth name/symbol should live in factory to reduce bytecode</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/48\">[G-25] Make use of a bitmap for claims to save gas in Converter.sol</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/69\">[G-26] Unnecessary checks on VADER token address in oracle.</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/96\">[G-27] Inclusion of salt and chainId in merkle tree leaves increases gas costs for no reason.</a> <em>Submitted by TomFrenchBlockchain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-vader-findings/issues/74\">[G-28] Unnecessary supportedToken checks on swaps on VaderPoolV2</a> <em>Submitted by TomFrenchBlockchain</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-14\">High Risk Findings (14)</a></p>\n<ul>\n<li><a href=\"#h-01-vaderpoolv2-minting-synths--fungibles-can-be-frontrun\">[H-01] <code>VaderPoolV2</code> minting synths &#x26; fungibles can be frontrun</a></li>\n<li><a href=\"#h-02-vaderpoolv2-owner-can-steal-all-user-assets-which-are-approved-vaderpoolv2\">[H-02] <code>VaderPoolV2</code> owner can steal all user assets which are approved <code>VaderPoolV2</code></a></li>\n<li><a href=\"#h-03-oracle-doesnt-calculate-usdvvader-price-correctly\">[H-03] Oracle doesn’t calculate USDV/VADER price correctly</a></li>\n<li><a href=\"#h-04-vader-twap-averages-wrong\">[H-04] Vader TWAP averages wrong</a></li>\n<li><a href=\"#h-05-oracle-returns-an-improperly-scaled-usdvvader-price\">[H-05] Oracle returns an improperly scaled USDV/VADER price</a></li>\n<li><a href=\"#h-06-lps-of-vaderpoolv2-can-manipulate-pool-reserves-to-extract-funds-from-the-reserve\">[H-06] LPs of <code>VaderPoolV2</code> can manipulate pool reserves to extract funds from the reserve.</a></li>\n<li><a href=\"#h-07-redemption-value-of-synths-can-be-manipulated-to-drain-vaderpoolv2-of-all-native-assets-in-the-associated-pair\">[H-07] Redemption value of synths can be manipulated to drain <code>VaderPoolV2</code> of all native assets in the associated pair</a></li>\n<li><a href=\"#h-08-reserve-does-not-properly-apply-prices-of-vader-and-usdv-tokens\">[H-08] Reserve does not properly apply prices of VADER and USDV tokens</a></li>\n<li><a href=\"#h-09-usdvsol-mint-and-burn-amounts-are-incorrect\">[H-09] <code>USDV.sol</code> Mint and Burn Amounts Are Incorrect</a></li>\n<li><a href=\"#h-10-previousprices-is-never-updated-upon-syncing-token-price\">[H-10] <code>previousPrices</code> Is Never Updated Upon Syncing Token Price</a></li>\n<li><a href=\"#h-11-totalliquidityweight-is-updated-when-adding-new-token-pairs-which-skews-price-data-for-getvaderprice-and-getusdvprice\">[H-11] <code>totalLiquidityWeight</code> Is Updated When Adding New Token Pairs Which Skews Price Data For <code>getVaderPrice</code> and <code>getUSDVPrice</code></a></li>\n<li><a href=\"#h-12-using-single-total-native-reserve-variable-for-synth-and-non-synth-reserves-of-vaderpoolv2-can-lead-to-losses-for-synth-holders\">[H-12] Using single total native reserve variable for synth and non-synth reserves of <code>VaderPoolV2</code> can lead to losses for synth holders</a></li>\n<li><a href=\"#h-13-council-veto-protection-does-not-work\">[H-13] Council veto protection does not work</a></li>\n<li><a href=\"#h-14-denial-of-service\">[H-14] Denial of service</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-6\">Medium Risk Findings (6)</a></p>\n<ul>\n<li><a href=\"#m-01-vaderpoolv2mintfungible-exposes-users-to-unlimited-slippage\">[M-01] <code>VaderPoolV2.mintFungible</code> exposes users to unlimited slippage</a></li>\n<li><a href=\"#m-02-adding-pair-of-the-same-foreignasset-would-replace-oracle-of-earlier-entry\">[M-02] Adding pair of the same <code>foreignAsset</code> would replace oracle of earlier entry</a></li>\n<li><a href=\"#m-03-no-way-to-remove-gasthrottle-from-vaderpool-after-deployment\">[M-03] No way to remove <code>GasThrottle</code> from <code>VaderPool</code> after deployment</a></li>\n<li><a href=\"#m-04-vaderreservereimburseimpermanentloss-improperly-converts-usdv-to-vader\">[M-04] <code>VaderReserve.reimburseImpermanentLoss</code> improperly converts USDV to VADER</a></li>\n<li><a href=\"#m-05-users-can-lock-themselves-out-of-being-able-to-convert-veth-becoming-stuck-with-the-deprecated-asset\">[M-05] Users can lock themselves out of being able to convert VETH, becoming stuck with the deprecated asset</a></li>\n<li><a href=\"#m-06-oracle-can-be-manipulted-to-consider-only-a-single-pair-for-pricing\">[M-06] Oracle can be manipulted to consider only a single pair for pricing</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-17\">Low Risk Findings (17)</a></li>\n<li><a href=\"#non-critical-findings-14\">Non-Critical Findings (14)</a></li>\n<li><a href=\"#gas-optimizations-29\">Gas Optimizations (29)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}