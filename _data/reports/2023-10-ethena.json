{
  "circa": {
    "title": "Ethena Labs",
    "sponsor": "Ethena Labs",
    "slug": "2023-10-ethena",
    "date": "2023-12-21",
    "findings": "https://github.com/code-423n4/2023-10-ethena-findings/issues",
    "contest": 299
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Ethena Labs smart contract system written in Solidity. The audit took place between October 24—October 30 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>158 Wardens contributed reports to Ethena Labs:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@peanuts\">peanuts</a></li>\n<li><a href=\"https://code4rena.com/@Madalad\">Madalad</a></li>\n<li><a href=\"https://code4rena.com/@adeolu\">adeolu</a></li>\n<li><a href=\"https://code4rena.com/@Eeyore\">Eeyore</a></li>\n<li><a href=\"https://code4rena.com/@Shubham\">Shubham</a></li>\n<li><a href=\"https://code4rena.com/@josephdara\">josephdara</a></li>\n<li><a href=\"https://code4rena.com/@jasonxiale\">jasonxiale</a></li>\n<li><a href=\"https://code4rena.com/@Mike_Bello90\">Mike_Bello90</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@d3e4\">d3e4</a></li>\n<li><a href=\"https://code4rena.com/@Yanchuan\">Yanchuan</a></li>\n<li><a href=\"https://code4rena.com/@ayden\">ayden</a></li>\n<li><a href=\"https://code4rena.com/@mert_eren\">mert_eren</a></li>\n<li><a href=\"https://code4rena.com/@pontifex\">pontifex</a></li>\n<li><a href=\"https://code4rena.com/@twcctop\">twcctop</a></li>\n<li><a href=\"https://code4rena.com/@cartlex_\">cartlex_</a></li>\n<li><a href=\"https://code4rena.com/@critical-or-high\">critical-or-high</a></li>\n<li><a href=\"https://code4rena.com/@trachev\">trachev</a></li>\n<li><a href=\"https://code4rena.com/@ciphermarco\">ciphermarco</a></li>\n<li><a href=\"https://code4rena.com/@0xmystery\">0xmystery</a></li>\n<li><a href=\"https://code4rena.com/@Arz\">Arz</a></li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@Limbooo\">Limbooo</a></li>\n<li><a href=\"https://code4rena.com/@RamenPeople\">RamenPeople</a> (<a href=\"https://code4rena.com/@kimchi\">kimchi</a> and <a href=\"https://code4rena.com/@wasabi\">wasabi</a>)</li>\n<li><a href=\"https://code4rena.com/@SovaSlava\">SovaSlava</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@J4X\">J4X</a></li>\n<li><a href=\"https://code4rena.com/@squeaky_cactus\">squeaky_cactus</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@Kaysoft\">Kaysoft</a></li>\n<li><a href=\"https://code4rena.com/@deepkin\">deepkin</a></li>\n<li><a href=\"https://code4rena.com/@pep7siup\">pep7siup</a></li>\n<li><a href=\"https://code4rena.com/@btk\">btk</a></li>\n<li><a href=\"https://code4rena.com/@ast3ros\">ast3ros</a></li>\n<li><a href=\"https://code4rena.com/@0xAlix2\">0xAlix2</a> (<a href=\"https://code4rena.com/@a_kalout\">a_kalout</a> and <a href=\"https://code4rena.com/@ali_shehab\">ali_shehab</a>)</li>\n<li><a href=\"https://code4rena.com/@dirk_y\">dirk_y</a></li>\n<li><a href=\"https://code4rena.com/@Oxsadeeq\">Oxsadeeq</a></li>\n<li><a href=\"https://code4rena.com/@Cosine\">Cosine</a></li>\n<li><a href=\"https://code4rena.com/@Krace\">Krace</a></li>\n<li><a href=\"https://code4rena.com/@0xAadi\">0xAadi</a></li>\n<li><a href=\"https://code4rena.com/@castle_chain\">castle_chain</a></li>\n<li><a href=\"https://code4rena.com/@0xpiken\">0xpiken</a></li>\n<li><a href=\"https://code4rena.com/@radev_sw\">radev_sw</a></li>\n<li><a href=\"https://code4rena.com/@ge6a\">ge6a</a></li>\n<li><a href=\"https://code4rena.com/@Team_Rocket\">Team_Rocket</a> (<a href=\"https://code4rena.com/@AlexCzm\">AlexCzm</a> and <a href=\"https://code4rena.com/@EllipticPoint\">EllipticPoint</a>)</li>\n<li><a href=\"https://code4rena.com/@sorrynotsorry\">sorrynotsorry</a></li>\n<li><a href=\"https://code4rena.com/@tnquanghuy0512\">tnquanghuy0512</a></li>\n<li><a href=\"https://code4rena.com/@lanrebayode77\">lanrebayode77</a></li>\n<li><a href=\"https://code4rena.com/@degensec\">degensec</a></li>\n<li><a href=\"https://code4rena.com/@KIntern_NA\">KIntern_NA</a> (<a href=\"https://code4rena.com/@duc\">duc</a> and <a href=\"https://code4rena.com/@TrungOre\">TrungOre</a>)</li>\n<li><a href=\"https://code4rena.com/@SpicyMeatball\">SpicyMeatball</a></li>\n<li><a href=\"https://code4rena.com/@Beosin\">Beosin</a></li>\n<li><a href=\"https://code4rena.com/@0xVolcano\">0xVolcano</a></li>\n<li><a href=\"https://code4rena.com/@oakcobalt\">oakcobalt</a></li>\n<li><a href=\"https://code4rena.com/@pavankv\">pavankv</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li><a href=\"https://code4rena.com/@Kral01\">Kral01</a></li>\n<li><a href=\"https://code4rena.com/@Al-Qa-qa\">Al-Qa-qa</a></li>\n<li><a href=\"https://code4rena.com/@ZanyBonzy\">ZanyBonzy</a></li>\n<li><a href=\"https://code4rena.com/@0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://code4rena.com/@0xweb3boy\">0xweb3boy</a></li>\n<li><a href=\"https://code4rena.com/@fouzantanveer\">fouzantanveer</a></li>\n<li><a href=\"https://code4rena.com/@albahaca\">albahaca</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@invitedtea\">invitedtea</a></li>\n<li><a href=\"https://code4rena.com/@0xAnah\">0xAnah</a></li>\n<li><a href=\"https://code4rena.com/@niser93\">niser93</a></li>\n<li><a href=\"https://code4rena.com/@JCK\">JCK</a></li>\n<li><a href=\"https://code4rena.com/@K42\">K42</a></li>\n<li><a href=\"https://code4rena.com/@Bauchibred\">Bauchibred</a></li>\n<li><a href=\"https://code4rena.com/@D_Auditor\">D_Auditor</a></li>\n<li><a href=\"https://code4rena.com/@clara\">clara</a></li>\n<li><a href=\"https://code4rena.com/@Bulletprime\">Bulletprime</a></li>\n<li><a href=\"https://code4rena.com/@xiao\">xiao</a></li>\n<li><a href=\"https://code4rena.com/@jauvany\">jauvany</a></li>\n<li><a href=\"https://code4rena.com/@digitizeworx\">digitizeworx</a></li>\n<li><a href=\"https://code4rena.com/@0x11singh99\">0x11singh99</a></li>\n<li><a href=\"https://code4rena.com/@ThreeSigma\">ThreeSigma</a> (<a href=\"https://code4rena.com/@0x73696d616f\">0x73696d616f</a>, <a href=\"https://code4rena.com/@0xCarolina\">0xCarolina</a>, <a href=\"https://code4rena.com/@EduCatarino\">EduCatarino</a>, and <a href=\"https://code4rena.com/@SolidityDev99\">SolidityDev99</a>)</li>\n<li><a href=\"https://code4rena.com/@arjun16\">arjun16</a></li>\n<li><a href=\"https://code4rena.com/@nuthan2x\">nuthan2x</a></li>\n<li><a href=\"https://code4rena.com/@0xhacksmithh\">0xhacksmithh</a></li>\n<li><a href=\"https://code4rena.com/@SAQ\">SAQ</a></li>\n<li><a href=\"https://code4rena.com/@tabriz\">tabriz</a></li>\n<li><a href=\"https://code4rena.com/@petrichor\">petrichor</a></li>\n<li><a href=\"https://code4rena.com/@shamsulhaq123\">shamsulhaq123</a></li>\n<li><a href=\"https://code4rena.com/@Raihan\">Raihan</a></li>\n<li><a href=\"https://code4rena.com/@0xhex\">0xhex</a></li>\n<li><a href=\"https://code4rena.com/@brakelessak\">brakelessak</a></li>\n<li><a href=\"https://code4rena.com/@unique\">unique</a></li>\n<li><a href=\"https://code4rena.com/@0xta\">0xta</a></li>\n<li><a href=\"https://code4rena.com/@thekmj\">thekmj</a></li>\n<li><a href=\"https://code4rena.com/@phenom80\">phenom80</a></li>\n<li><a href=\"https://code4rena.com/@aslanbek\">aslanbek</a></li>\n<li><a href=\"https://code4rena.com/@Rolezn\">Rolezn</a></li>\n<li><a href=\"https://code4rena.com/@yashgoel72\">yashgoel72</a></li>\n<li><a href=\"https://code4rena.com/@0xgrbr\">0xgrbr</a></li>\n<li><a href=\"https://code4rena.com/@SM3_SS\">SM3_SS</a></li>\n<li><a href=\"https://code4rena.com/@evmboi32\">evmboi32</a></li>\n<li><a href=\"https://code4rena.com/@naman1778\">naman1778</a></li>\n<li><a href=\"https://code4rena.com/@ybansal2403\">ybansal2403</a></li>\n<li><a href=\"https://code4rena.com/@0xhunter\">0xhunter</a></li>\n<li><a href=\"https://code4rena.com/@qpzm\">qpzm</a></li>\n<li><a href=\"https://code4rena.com/@erebus\">erebus</a></li>\n<li><a href=\"https://code4rena.com/@adam-idarrha\">adam-idarrha</a></li>\n<li><a href=\"https://code4rena.com/@Avci\">Avci</a> (<a href=\"https://code4rena.com/@0xdanial\">0xdanial</a> and <a href=\"https://code4rena.com/@0xArshia\">0xArshia</a>)</li>\n<li><a href=\"https://code4rena.com/@Breeje\">Breeje</a></li>\n<li><a href=\"https://code4rena.com/@PASCAL\">PASCAL</a></li>\n<li><a href=\"https://code4rena.com/@rotcivegaf\">rotcivegaf</a></li>\n<li><a href=\"https://code4rena.com/@asui\">asui</a></li>\n<li><a href=\"https://code4rena.com/@codynhat\">codynhat</a></li>\n<li><a href=\"https://code4rena.com/@BeliSesir\">BeliSesir</a></li>\n<li><a href=\"https://code4rena.com/@0xG0P1\">0xG0P1</a></li>\n<li><a href=\"https://code4rena.com/@Imlazy0ne\">Imlazy0ne</a></li>\n<li><a href=\"https://code4rena.com/@supersizer0x\">supersizer0x</a></li>\n<li><a href=\"https://code4rena.com/@pipidu83\">pipidu83</a></li>\n<li><a href=\"https://code4rena.com/@cccz\">cccz</a></li>\n<li><a href=\"https://code4rena.com/@cryptonue\">cryptonue</a></li>\n<li><a href=\"https://code4rena.com/@kkkmmmsk\">kkkmmmsk</a></li>\n<li><a href=\"https://code4rena.com/@Rickard\">Rickard</a></li>\n<li><a href=\"https://code4rena.com/@Noro\">Noro</a></li>\n<li><a href=\"https://code4rena.com/@Proxy\">Proxy</a></li>\n<li><a href=\"https://code4rena.com/@ziyou-\">ziyou-</a></li>\n<li><a href=\"https://code4rena.com/@chainsnake\">chainsnake</a></li>\n<li><a href=\"https://code4rena.com/@oxchsyston\">oxchsyston</a></li>\n<li><a href=\"https://code4rena.com/@0xStalin\">0xStalin</a></li>\n<li><a href=\"https://code4rena.com/@Fitro\">Fitro</a></li>\n<li><a href=\"https://code4rena.com/@rokinot\">rokinot</a></li>\n<li><a href=\"https://code4rena.com/@matrix_0wl\">matrix_0wl</a></li>\n<li><a href=\"https://code4rena.com/@Walter\">Walter</a></li>\n<li><a href=\"https://code4rena.com/@young\">young</a></li>\n<li><a href=\"https://code4rena.com/@Zach_166\">Zach_166</a></li>\n<li><a href=\"https://code4rena.com/@Topmark\">Topmark</a></li>\n<li><a href=\"https://code4rena.com/@almurhasan\">almurhasan</a></li>\n<li><a href=\"https://code4rena.com/@csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://code4rena.com/@PENGUN\">PENGUN</a></li>\n<li><a href=\"https://code4rena.com/@zhaojie\">zhaojie</a></li>\n<li><a href=\"https://code4rena.com/@ptsanev\">ptsanev</a></li>\n<li><a href=\"https://code4rena.com/@marchev\">marchev</a></li>\n<li><a href=\"https://code4rena.com/@Strausses\">Strausses</a></li>\n<li><a href=\"https://code4rena.com/@foxb868\">foxb868</a></li>\n<li><a href=\"https://code4rena.com/@max10afternoon\">max10afternoon</a></li>\n<li><a href=\"https://code4rena.com/@DarkTower\">DarkTower</a> (<a href=\"https://code4rena.com/@Gelato_ST\">Gelato_ST</a>, <a href=\"https://code4rena.com/@Maroutis\">Maroutis</a>, <a href=\"https://code4rena.com/@OxTenma\">OxTenma</a>, and <a href=\"https://code4rena.com/@0xrex\">0xrex</a>)</li>\n<li><a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a></li>\n<li><a href=\"https://code4rena.com/@twicek\">twicek</a></li>\n<li><a href=\"https://code4rena.com/@0x_Scar\">0x_Scar</a></li>\n<li><a href=\"https://code4rena.com/@Bughunter101\">Bughunter101</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@0xDjango\">0xDjango</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 4 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 4 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 98 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 41 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-10-ethena\">C4 Ethena Labs repository</a>, and is composed of 6 smart contracts written in the Solidity programming language and includes 588 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>MrsHudson</strong> from warden slvDev, generated the <a href=\"https://gist.github.com/code423n4/58a34c8d4c41d8d15f18cb43a2c71e3e\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"medium-risk-findings-4\" style=\"position:relative;\"><a href=\"#medium-risk-findings-4\" aria-label=\"medium risk findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (4)</h1>\n<h2 id=\"m-01-full_restricted-stakers-can-bypass-restriction-through-approvals\" style=\"position:relative;\"><a href=\"#m-01-full_restricted-stakers-can-bypass-restriction-through-approvals\" aria-label=\"m 01 full_restricted stakers can bypass restriction through approvals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/499\">[M-01] <code>FULL_RESTRICTED</code> Stakers can bypass restriction through approvals</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/499\">josephdara</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/666\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/620\">ge6a</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/438\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/435\">Team_Rocket</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/431\">mert_eren</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/427\">sorrynotsorry</a>, Eeyore (<a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/423\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/421\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/415\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/378\">Limbooo</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/374\">0xmystery</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/365\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/334\">RamenPeople</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/320\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/319\">J4X</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/233\">degensec</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/214\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/172\">0xAadi</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/147\">castle_chain</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/112\">0xpiken</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/102\">SpicyMeatball</a>, and <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/7\">Beosin</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L225-L238\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L225-L238</a><br>\n<a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L245-L248\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L245-L248</a></p>\n<p>The <code>StakedUSDe</code> contract implements a method to <code>SOFTLY</code> or <code>FULLY</code> restrict user address, and either transfer to another user or burn.</p>\n<p>However there is an underlying issue. A fully restricted address is supposed to be unable to withdraw/redeem, however this issue can be walked around via the approve mechanism.</p>\n<p>The openzeppelin <code>ERC4626</code> contract allows approved address to withdraw and redeem on behalf of another address so far there is an approval.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span></span></span></code></pre>\n<p>Blacklisted Users can explore this loophole to redeem their funds fully. This is because in the overridden <code>_withdraw</code> function, the token owner is not checked for restriction.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">caller</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">notZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">notZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">caller</span><span class=\"mtk1\">) || </span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OperationNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Also in the overridden <code>_beforeTokenTransfer</code> there is a clause added to allow burning from restricted addresses:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_beforeTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">from</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OperationNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>All these issues allows a restricted user to simply approve another address and redeem their usde.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is a foundry test that can be run in the <code>StakedUSDe.blacklist.t.sol</code> in the <code>test/foundry/staking</code> directory.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/* solhint-disable private-vars-leading-underscore  */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/* solhint-disable func-name-mixedcase  */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/* solhint-disable var-name-mixedcase  */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">console</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/console.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/Test.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SigUtils</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/SigUtils.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../../contracts/USDe.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../../contracts/StakedUSDe.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../../contracts/interfaces/IUSDe.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../../contracts/interfaces/IERC20Events.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../../contracts/interfaces/ISingleAdminAccessControl.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">StakedUSDeBlacklistTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IERC20Events</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">USDe</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">StakedUSDe</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">SigUtils</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sigUtilsUSDe</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">SigUtils</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sigUtilsStakedUSDe</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">greg</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BLACKLIST_MANAGER_ROLE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">caller</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">caller</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LockedAmountRedistributed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">indexed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountToDistribute</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">USDe</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">alice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;alice&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bob</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;bob&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">greg</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;greg&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setMinter</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">StakedUSDe</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IUSDe</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">)), </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;rewarder&#39;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;FULL_RESTRICTED_STAKER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SOFT_RESTRICTED_STAKER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">BLACKLIST_MANAGER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;BLACKLIST_MANAGER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mintApproveDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectRevert</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sharesBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">expectRevert</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IStakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">OperationNotAllowed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectEmit</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">staker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">staker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sharesAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">staker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">expectRevert</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sharesAfter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sharesBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">assertApproxEqAbs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sharesAfter</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">sharesBefore</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_fullBlacklist_withdraw_pass</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mintApproveDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">grantRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit-issue assert that alice is blacklisted</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isBlacklisted</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isBlacklisted</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">//@audit-issue The staked balance of Alice</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balAliceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit-issue The usde balance of address 56</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bal56Before</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">56</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">56</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//@audit-issue address 56 receives approval and can unstake usde for Alice after a blacklist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">56</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">56</span><span class=\"mtk1\">), </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">//@audit-issue The staked balance of Alice</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balAliceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk3\">//@audit-issue The usde balance of address 56</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bal56After</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">56</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bal56Before</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balAliceAfter</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balAliceBefore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bal56Before</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">balAliceAfter</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bal56After</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Here we use <code>address(56)</code> as the second address, and we see that the user can withdraw their <code>100000000000000000000</code> tokens that was restricted.</p>\n<p>This is my test result showing the  balances.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"shell\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] test_fullBlacklist_withdraw_pass() (gas: 239624)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  100000000000000000000 // Alice staked balance before</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  0 // address(56) USDe balance before</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  0 // Alice staked balance after</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  100000000000000000000 // address(56) USDe balance after</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: ok. 1 passed; 0 failed; 0 skipped; finished in 8.68ms</span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry, Manual review</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check the token owner as well in the <code>_withdraw</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">caller</span><span class=\"mtk1\">) || </span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">) || </span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">) ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OperationNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/666#issuecomment-1802065692\">FJ-Riveros (Ethena) confirmed via duplicate issue #666</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/499#issuecomment-1810441530\">0xDjango (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/499#issuecomment-1811883453\">josephdara (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @0xDjango,  I do believe this is a high severity bug. It does break a major protocol functionality, compromising assets directly.\nAccording to the severity categorization:</p>\n<blockquote>\n<p>3 — High: Assets can be stolen/lost/compromised directly</p>\n</blockquote>\n<p>Thanks!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/499#issuecomment-1815670715\">0xDjango (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@josephdara - I have conversed with the project team, and we have agreed that breaking rules due to legal compliance is medium severity as no funds are at risk.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-soft-restricted-staker-role-can-withdraw-stusde-for-usde\" style=\"position:relative;\"><a href=\"#m-02-soft-restricted-staker-role-can-withdraw-stusde-for-usde\" aria-label=\"m 02 soft restricted staker role can withdraw stusde for usde permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/246\">[M-02] Soft Restricted Staker Role can withdraw stUSDe for USDe</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/246\">squeaky_cactus</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/697\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/677\">Kaysoft</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/651\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/640\">deepkin</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/532\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/530\">Oxsadeeq</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/500\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/497\">Shubham</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/420\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/379\">Limbooo</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/357\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/352\">btk</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/337\">RamenPeople</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/248\">Cosine</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/235\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/208\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/116\">0xAlix2</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/96\">dirk_y</a>, and <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/72\">Krace</a></em></p>\n<p>A requirement is stated that a user with the <code>SOFT_RESTRICTED_STAKER_ROLE</code> is not allowed to withdraw <code>USDe</code> for <code>stUSDe</code>.</p>\n<p>The code does not satisfy that condition, when a holder has the <code>SOFT_RESTRICTED_STAKER_ROLE</code>, they can exchange their <code>stUSDe</code> for <code>USDe</code> using <code>StakedUSDeV2</code>.</p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The Ethena readme has the following decription of legal requirements for the Soft Restricted Staker Role: <br><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/README.md?plain=1#L98\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/README.md?plain=1#L98</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Due to legal requirements, there&#39;s a `SOFT_RESTRICTED_STAKER_ROLE` and `FULL_RESTRICTED_STAKER_ROLE`. </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">The former is for addresses based in countries we are not allowed to provide yield to, for example USA. </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Addresses under this category will be soft restricted. They cannot deposit USDe to get stUSDe or withdraw stUSDe for USDe. </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">However they can participate in earning yield by buying and selling stUSDe on the open market.</span></span></code></pre>\n<p>In summary, legal requires are that a <code>SOFT_RESTRICTED_STAKER_ROLE</code>:</p>\n<ul>\n<li>MUST NOT deposit USDe to get stUSDe</li>\n<li>MUST NOT withdraw USDe for USDe</li>\n<li>MAY earn yield by trading stUSDe on the open market</li>\n</ul>\n<p>As <code>StakedUSDeV2</code> is a <code>ERC4626</code>, the <code>stUSDe</code> is a share on the underlying <code>USDe</code> asset. There are two distinct entrypoints for a user to exchange their share for their claim on the underlying the asset, <code>withdraw</code> and <code>redeem</code>. Each cater for a different input (<code>withdraw</code> being by asset, <code>redeem</code> being by share), however both invoked the same internal <code>_withdraw</code> function, hence both entrypoints are affected.</p>\n<p>There are two cases where a user with <code>SOFT_RESTRICTED_STAKER_ROLE</code> may have acquired <code>stUSDe</code>:</p>\n<ul>\n<li>Brought <code>stUSDe</code> on the open market</li>\n<li>Deposited <code>USDe</code> in <code>StakedUSDeV2</code> before being granted the <code>SOFT_RESTRICTED_STAKER_ROLE</code></li>\n</ul>\n<p>In both cases the user can call either withdraw their holding by calling <code>withdraw</code> or <code>redeem</code> (when cooldown is off), or <code>unstake</code> (if cooldown is on) and successfully exchange their <code>stUSDe</code> for <code>USDe</code>.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following two tests demonstrate the use case of a user staking, then being granted the <code>SOFT_RESTRICTED_STAKER_ROLE</code>, then exchanging their <code>stUSDe</code> for <code>USDe</code> (first using <code>redeem</code> function, the second using <code>withdrawm</code>).</p>\n<p>The use case for acquiring on the open market, only requiring a different setup, however the exchange behaviour is identical and the cooldown enabled <code>cooldownAssets</code> and <code>cooldownShares</code> function still use the same <code>_withdraw</code> as <code>redeem</code> and <code>withdraw</code>, which leads to the same outcome.</p>\n<p>(Place code into <code>StakedUSDe.t.sol</code> and run with <code>forge test</code>)<br>\n<a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/test/foundry/staking/StakedUSDe.t.sol\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/test/foundry/staking/StakedUSDe.t.sol</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SOFT_RESTRICTED_STAKER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BLACKLIST_MANAGER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;BLACKLIST_MANAGER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_redeem_while_soft_restricted</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Set up Bob with 100 stUSDe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mintApproveDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakeOfBob</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Alice becomes a blacklist manager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">grantRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BLACKLIST_MANAGER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Blacklist Bob with the SOFT_RESTRICTED_STAKER_ROLE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addToBlacklist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Assert that Bob has staked and is now has the soft restricted role</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">stakeOfBob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Rewards to StakeUSDe and vest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_transferRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hours</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Assert that only the total assets have increased after vesting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">stakeOfBob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Bob withdraws his stUSDe for USDe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakeOfBob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// End state being while being soft restricted Bob redeemed USDe with rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertApproxEqAbs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">), </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertApproxEqAbs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_withdraw_while_soft_restricted</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Set up Bob with 100 stUSDe</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mintApproveDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakeOfBob</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Alice becomes a blacklist manager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">grantRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BLACKLIST_MANAGER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Blacklist Bob with the SOFT_RESTRICTED_STAKER_ROLE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addToBlacklist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Assert that Bob has staked and is now has the soft restricted role</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">stakeOfBob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Rewards to StakeUSDe and vest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_transferRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hours</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Assert that only the total assets have increased after vesting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">stakeOfBob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Bob withdraws his stUSDe for USDe (-1 as dust is lost in asset to share rounding in ERC4626)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// End state being while being soft restricted Bob redeemed USDe with rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertApproxEqAbs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">), </span><span class=\"mtk12\">initialAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">rewardAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertApproxEqAbs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertTrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual review, Foundry test</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>With the function overriding present, to prevent the <code>SOFT_RESTRICTED_STAKER_ROLE</code> from being able to exchange their <code>stUSDs</code> for <code>USDe</code>, make the following change in <code>StakedUSDe</code></p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L232\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L232</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">caller</span><span class=\"mtk1\">) || </span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">caller</span><span class=\"mtk1\">) || </span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">) || </span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SOFT_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">caller</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OperationNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/246#issuecomment-1810742469\">0xDjango (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/246#issuecomment-1858130415\">kayinnnn (Ethena) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>For this issue, the docs were incorrect to say withdrawal by soft restricted role is not allowed. Only depositing is not allowed.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-users-still-forced-to-follow-previously-set-cooldownduration-even-when-cooldown-is-off-set-to-zero-before-unstaking\" style=\"position:relative;\"><a href=\"#m-03-users-still-forced-to-follow-previously-set-cooldownduration-even-when-cooldown-is-off-set-to-zero-before-unstaking\" aria-label=\"m 03 users still forced to follow previously set cooldownduration even when cooldown is off set to zero before unstaking permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/198\">[M-03] users still forced to follow previously set cooldownDuration even when cooldown is off (set to zero) before unstaking</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/198\">adeolu</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/738\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/737\">Madalad</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/619\">Mike_Bello90</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/540\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/511\">josephdara</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/461\">Eeyore</a>, and <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/424\">Shubham</a></em></p>\n<p>The <code>StakedUSDeV2</code> contract can enforces coolDown periods for users before they are able to unstake/ take out their funds from the silo contract if coolDown is on. Based on the presence of the modifiers <code>ensureCooldownOff</code> and <code>ensureCooldownOn</code>, it is known that the coolDown state of the <code>StakedUSDeV2</code> contract can be toggled on or off.\nIn a scenario where coolDown is on (always turned on by default) and Alice and Bob deposits, two days after Alice wants to withdraw/redeem. Alice is forced to wait for 90 days before completing withdrawal/getting her tokens from the silo contract because Alice must call  coolDownAsset()/coolDownShares() fcns respectively. Bob decides to wait an extra day.</p>\n<p>On the third day, Bob decides to withdraw/redeem. Contract admin also toggles the coolDown off (sets cooldownDuration to 0), meaning there is no longer a coolDown period and all withdrawals should be sent to the users immediately. Bob now calls calls the redeem()/withdraw() fcn to withdraw instantly to his address instead of the silo address since there is no coolDown.</p>\n<p>Alice sees Bob has gotten his tokens but Alice cant use the redeem()/withdraw() because her <code>StakedUSDeV2</code> were already burned and her underlying assets were sent to the silo contract for storage. Alice cannot sucessfully call <code>unstake()</code> because her <code>userCooldown.cooldownEnd</code>  value set to ~ 90 days. Now Alice has to unfairly wait out the 90 days even though coolDowns have been turned off and everyone else has unrestricted access to their assets. Alice only crime is trying to withdraw earlier than Bob. This is a loss to Alice as Alice has no StakedUSDE or the underlying asset for the no longer necessary 90 days as if the assset is volatile, it may lose some fiat value during the unfair and no longer necessary wait period.</p>\n<p>If cooldown is turned off, it should affect all contract processes and as such, withdrawals should become immediate to users. Tokens previously stored in the USDeSilo contract should become accessible to users when the cooldown state is off. Previous withdrawal requests that had a cooldown should no longer be restricted by a coolDown period since coolDown now off and the coolDownDuration of the contract is now 0.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>Since StakedUSDeV2 is ERC4626, user calls <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/94697be8a3f0dfcd95dfb13ffbd39b5973f5c65d/contracts/token/ERC20/extensions/ERC4626.sol#L171C1-L181C6\">deposit()</a> to deposit the underlying token asset and get minted shares that signify the user’s position size in the vault.</li>\n<li>The coolDown duration is set to 90 days on deployment of the <code>StakedUSDeV2</code> contract, meaning coolDown is toggled on by default.</li>\n<li>User cannot redeem/withdraw his funds via <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L52C1-L61C1\">withdraw()</a> and <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L65C1-L73C4\">redeem()</a> because coolDown is on. Both functions have the <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L27C1-L30C4\">ensureCooldownOff</a> modifier which reverts if the coolDownDuration value is not 0.</li>\n<li>\n<p>User tried to exit position, to withdraw when coolDown is on, user must call coolDownAsset()/coolDownShares(). This will cause :</p>\n<ul>\n<li>For the user’s underlyingAmount and cooldownEnd timestamp values to be set in the mapping <code>cooldowns</code>.  cooldownEnd timestamp values is set to 90 days from the present.</li>\n<li>For the user’s <code>StakedUSDeV2</code> ERC4626 position shares to be burnt and the positon underlying asset value to be sent to the USDeSilo contract.</li>\n</ul>\n</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        /// @notice redeem assets and starts a cooldown to claim the converted underlying asset</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /// @param assets assets to redeem</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /// @param owner address to redeem and start cooldown, owner must allowed caller to perform this action</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        function cooldownAssets(uint256 assets, address owner) external ensureCooldownOn returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         if (assets &gt; maxWithdraw(owner)) revert ExcessiveWithdrawAmount();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         uint256 shares = previewWithdraw(assets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         cooldowns[owner].cooldownEnd = uint104(block.timestamp) + cooldownDuration;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         cooldowns[owner].underlyingAmount += assets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         _withdraw(_msgSender(), address(silo), owner, assets, shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         return shares;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /// @notice redeem shares into assets and starts a cooldown to claim the converted underlying asset</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /// @param shares shares to redeem</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /// @param owner address to redeem and start cooldown, owner must allowed caller to perform this action</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        function cooldownShares(uint256 shares, address owner) external ensureCooldownOn returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         if (shares &gt; maxRedeem(owner)) revert ExcessiveRedeemAmount();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         uint256 assets = previewRedeem(shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         cooldowns[owner].cooldownEnd = uint104(block.timestamp) + cooldownDuration;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         cooldowns[owner].underlyingAmount += assets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         _withdraw(_msgSender(), address(silo), owner, assets, shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         return assets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<ul>\n<li>User can only use unstake() to get the assets from the silo contract. unstake enforces that the block.timestamp (present time) is more than the 90 days cooldown period set during the execution of <code>cooldownAssets()</code> and <code>cooldownShares()</code> and reverts if 90 days time has not been reached yet.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">      function unstake(address receiver) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        UserCooldown storage userCooldown = cooldowns[msg.sender];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 assets = userCooldown.underlyingAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &gt;= userCooldown.cooldownEnd) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          userCooldown.cooldownEnd = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          userCooldown.underlyingAmount = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          silo.withdraw(receiver, assets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          revert InvalidCooldown();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span></code></pre>\n<ul>\n<li>If contract admin decides to turn the coolDown period off, by setting the cooldownDuration to 0 via <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L126C1-L135C2\">setCooldownDuration()</a>, user who has his assets under the coolDown in the silo still wont be able to withdraw via <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L78C1-L90C4\">unstake()</a> because the logic in <code>unstake()</code> doesnt allow for the user’s coolDownEnd value which was set under the previous coolDown duration state to be bypassed as coolDowns are now turned off and the StakedUSDeV2 behavior is supposed to be changed to follow ERC4626 standard and allow for the user assets to get to them immediately with no coolDown period still enforced on withdrawals as seen in the comment <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L124C38-L124C135\">here</a>.</li>\n<li>User who initiated withdrawal when the coolDown was toggled on will still continue to be restricted from his tokens/funds even after coolDown is toggled off. This should not be because restrictions are removed, all previous pending withdrawals should be allowed to be completed without wait for 90 days since the coolDownDuration of the contract is now 0.</li>\n</ul>\n<h3 id=\"coded-proof-of-concept\" style=\"position:relative;\"><a href=\"#coded-proof-of-concept\" aria-label=\"coded proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Coded Proof of Concept</h3>\n<p>Run with <code>forge test --mt test_UnstakeUnallowedAfterCooldownIsTurnedOff</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // SPDX-License-Identifier: MIT</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    pragma solidity &gt;=0.8;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /* solhint-disable private-vars-leading-underscore  */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /* solhint-disable var-name-mixedcase  */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /* solhint-disable func-name-mixedcase  */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import &quot;forge-std/console.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import &quot;forge-std/Test.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import {SigUtils} from &quot;forge-std/SigUtils.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import &quot;../../../contracts/USDe.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import &quot;../../../contracts/StakedUSDeV2.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import &quot;../../../contracts/interfaces/IUSDe.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    import &quot;../../../contracts/interfaces/IERC20Events.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    contract StakedUSDeV2CooldownTest is Test, IERC20Events {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      USDe public usdeToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      StakedUSDeV2 public stakedUSDeV2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      SigUtils public sigUtilsUSDe;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      SigUtils public sigUtilsStakedUSDe;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      uint256 public _amount = 100 ether;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address public owner;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address public alice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address public bob;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      address public greg;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      bytes32 SOFT_RESTRICTED_STAKER_ROLE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      bytes32 FULL_RESTRICTED_STAKER_ROLE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      bytes32 DEFAULT_ADMIN_ROLE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      bytes32 BLACKLIST_MANAGER_ROLE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      bytes32 REWARDER_ROLE;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      event Deposit(address indexed caller, address indexed owner, uint256 assets, uint256 shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      event Withdraw(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address indexed caller, address indexed receiver, address indexed owner, uint256 assets, uint256 shares</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      event LockedAmountRedistributed(address indexed from, address indexed to, uint256 amountToDistribute);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      function setUp() public virtual {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        usdeToken = new USDe(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        alice = makeAddr(&quot;alice&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bob = makeAddr(&quot;bob&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        greg = makeAddr(&quot;greg&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        owner = makeAddr(&quot;owner&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        usdeToken.setMinter(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stakedUSDeV2 = new StakedUSDeV2(IUSDe(address(usdeToken)), makeAddr(&#39;rewarder&#39;), owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        FULL_RESTRICTED_STAKER_ROLE = keccak256(&quot;FULL_RESTRICTED_STAKER_ROLE&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        SOFT_RESTRICTED_STAKER_ROLE = keccak256(&quot;SOFT_RESTRICTED_STAKER_ROLE&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        DEFAULT_ADMIN_ROLE = 0x00;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        BLACKLIST_MANAGER_ROLE = keccak256(&quot;BLACKLIST_MANAGER_ROLE&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        REWARDER_ROLE = keccak256(&quot;REWARDER_ROLE&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      function test_UnstakeUnallowedAfterCooldownIsTurnedOff () public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address staker = address(20);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint usdeTokenAmountToMint = 10000*1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        usdeToken.mint(staker, usdeTokenAmountToMint);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //at the deposit coolDownDuration is set to 90 days </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assert(stakedUSDeV2.cooldownDuration() == 90 days);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(staker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        usdeToken.approve(address(stakedUSDeV2), usdeTokenAmountToMint);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stakedUSDeV2.deposit(usdeTokenAmountToMint / 2, staker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.roll(block.number + 1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint assets  = stakedUSDeV2.maxWithdraw(staker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stakedUSDeV2.cooldownAssets(assets , staker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //assert that cooldown for the staker is now set to 90 days from now </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ( uint104 cooldownEnd, ) = stakedUSDeV2.cooldowns(staker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assert(cooldownEnd == uint104( block.timestamp + 90 days));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //toggle coolDown off in the contract </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stakedUSDeV2.setCooldownDuration(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //now try to unstake, </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /** since cooldown duration is now 0 and contract is cooldown state is turned off. </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        it should allow unstake immediately but instead it will revert **/</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.expectRevert(IStakedUSDeCooldown.InvalidCooldown.selector);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(staker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stakedUSDeV2.unstake(staker);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual review, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Modify the code in unstake() fcn to allow for withdrawals from the silo contract when the contract’s coolDownDuration has become 0.</p>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/198#issuecomment-1858131607\">kayinnnn (Ethena) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledge the issue, but revise to low severity finding as it causes minor inconvenience in the rare time we change cooldown period. However, it is still fixed - existing per user cooldown is ignored if the global cooldown is <code>0</code>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-malicious-users-can-front-run-to-cause-a-denial-of-service-dos-for-stakedusde-due-to-minshares-checks\" style=\"position:relative;\"><a href=\"#m-04-malicious-users-can-front-run-to-cause-a-denial-of-service-dos-for-stakedusde-due-to-minshares-checks\" aria-label=\"m 04 malicious users can front run to cause a denial of service dos for stakedusde due to minshares checks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/88\">[M-04] Malicious users can front-run to cause a denial of service (DoS) for StakedUSDe due to MinShares checks</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/88\">ayden</a>, also found by d3e4 (<a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/713\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/712\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/703\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/676\">trachev</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/670\">ciphermarco</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/578\">Madalad</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/571\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/551\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/465\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/462\">cartlex_</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/447\">mert_eren</a>, 0xWaitress (<a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/63\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/60\">2</a>), and <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/32\">critical-or-high</a></em></p>\n<p>Malicious users can transfer <code>USDe</code> token to <code>StakedUSDe</code> protocol directly lead to a denial of service (DoS) for StakedUSDe due to the limit shares check.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>User deposit <code>USDe</code> token to <code>StakedUSDe</code> protocol to get share via invoke external <code>deposit</code> function. Let’s see how share is calculate:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, Math.Rounding </span><span class=\"mtk12\">rounding</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDiv</span><span class=\"mtk1\">(</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk11\">_decimalsOffset</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">() + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rounding</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Since <code>decimalsOffset() == 0</code> and totalAssets equal the balance of <code>USDe</code> in this protocol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n$$\nf(share) = (USDeAmount \\ast totalSupply) / (totalUSDeAssets() + 1)\n$$\n<p>The minimum share is set to 1 ether.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIN_SHARES</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Assuming malicious users transfer 1 ether of <code>USDe</code> into the protocol and receive ZERO shares, how much tokens does the next user need to pay if they want to exceed the minimum share limit of 1 ether? That would be 1 ether times 1 ether, which is a substantial amount.</p>\n<p>I add a test case in <code>StakedUSDe.t.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testMinSharesViolation</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">malicious</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">malicious</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//assume malicious user deposit 1 ether into protocol.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">malicious</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">usdeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//1000 ether can&#39;t exceed the minimum share limit of 1 ether</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IStakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">MinSharesViolation</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">stakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>We can see even Alice deposit a substantial number of tokens but still cannot surpass the 1 ether share limit which will lead to a denial of service (DoS) for StakedUSDe due to MinShares checks.</p>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>vscode</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We can solve this issue by setting a minimum deposit amount.</p>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>DoS</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/32#issuecomment-1805643280\">FJ-Riveros (Ethena) acknowledged, but disagreed with severity and commented via duplicate issue #32</a>:</strong></p>\n<blockquote>\n<p>We acknowledge the potential exploitability of this issue, but we propose marking it as <code>Medium</code> severity. Our rationale is based on the fact that this exploit can only occur during deployment. To mitigate this risk, we plan to fund the smart contract in the next block, ensuring that nobody has access to the ABI or contract source code. We could even use flashbots for this purpose. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/88#issuecomment-1828560633\">0xDjango (judge) commented via duplicate issue #32</a>:</strong></p>\n<blockquote>\n<p>Agree with medium. Several of the duplicate reports vary in their final impacts but mostly consist of:</p>\n<ul>\n<li>Small donation leading to bricked contract</li>\n<li>Large donation can eventually lead to blocked withdrawals</li>\n</ul>\n<p>The small donation impact simply requires a redeploy, though the impact is a valid medium. The large donation has major implications for stakers, but the large amount of capital required downgrades it to medium as well. I will be reviewing each duplicate on a case-by-case basis to ensure that all impacts due to the same bug class fit within medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/88#issuecomment-1806415374\">0xDjango (judge) decreased severity to Medium</a></strong></p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 98 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/602\">report highlighted below</a> by <strong>0xmystery</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/329\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/735\">0xhunter</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/733\">Team_Rocket</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/731\">qpzm</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/729\">erebus</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/728\">ge6a</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/724\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/718\">adam-idarrha</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/711\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/698\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/692\">Avci</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/684\">Arz</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/673\">Breeje</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/662\">PASCAL</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/657\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/636\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/627\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/623\">asui</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/618\">codynhat</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/617\">radev_sw</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/616\">Kaysoft</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/612\">BeliSesir</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/611\">deepkin</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/598\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/590\">ThreeSigma</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/583\">Madalad</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/582\">0xG0P1</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/568\">Imlazy0ne</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/565\">Mike_Bello90</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/561\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/560\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/554\">supersizer0x</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/550\">Shubham</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/545\">0xAadi</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/523\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/520\">pipidu83</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/514\">adeolu</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/502\">Kral01</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/491\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/489\">cccz</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/487\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/486\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/485\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/481\">pavankv</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/471\">Eeyore</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/464\">cartlex_</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/453\">kkkmmmsk</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/452\">arjun16</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/445\">squeaky_cactus</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/442\">Rickard</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/441\">Noro</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/436\">Proxy</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/430\">J4X</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/426\">Al-Qa-qa</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/394\">ziyou-</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/393\">chainsnake</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/385\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/381\">oxchsyston</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/370\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/350\">btk</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/347\">0xStalin</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/340\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/331\">Fitro</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/308\">rokinot</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/294\">matrix_0wl</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/291\">Walter</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/289\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/284\">young</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/260\">Zach_166</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/250\">Topmark</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/238\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/222\">degensec</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/216\">almurhasan</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/210\">nuthan2x</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/209\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/202\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/197\">0xpiken</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/192\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/165\">ptsanev</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/152\">marchev</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/151\">castle_chain</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/146\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/138\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/137\">0xAlix2</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/133\">Strausses</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/120\">foxb868</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/108\">dirk_y</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/103\">max10afternoon</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/89\">DarkTower</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/78\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/64\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/56\">twicek</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/53\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/44\">0x_Scar</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/29\">Bughunter101</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/10\">0xhacksmithh</a>, and <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/4\">critical-or-high</a>.</em></p>\n<h2 id=\"01-use-an-efficient-logic-in-setter-functions\" style=\"position:relative;\"><a href=\"#01-use-an-efficient-logic-in-setter-functions\" aria-label=\"01 use an efficient logic in setter functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] Use an efficient logic in setter functions</h2>\n<p>When intending to emit both the old and new values, there isn’t a need to cache the old value that will only be used once. Simply emit both values before assigning a new value to the state variable. For example, the following setter function may be refactored as follows:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L436-L440\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L436-L440</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function _setMaxMintPerBlock(uint256 _maxMintPerBlock) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    emit MaxMintPerBlockChanged(maxMintPerBlock, _maxMintPerBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 oldMaxMintPerBlock = maxMintPerBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    maxMintPerBlock = _maxMintPerBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    emit MaxMintPerBlockChanged(oldMaxMintPerBlock, maxMintPerBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>All other instances entailed:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L442-L447\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L442-L447</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @notice Sets the max redeemPerBlock limit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setMaxRedeemPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxRedeemPerBlock</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldMaxRedeemPerBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maxRedeemPerBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">maxRedeemPerBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxRedeemPerBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaxRedeemPerBlockChanged</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldMaxRedeemPerBlock</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxRedeemPerBlock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L126-L134\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L126-L134</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setCooldownDuration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_COOLDOWN_DURATION</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidCooldown</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousDuration</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cooldownDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cooldownDuration</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CooldownDurationUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">previousDuration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cooldownDuration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h2 id=\"02-be-consistent-in-the-code-logic-when-emitting-events-in-setter-functions\" style=\"position:relative;\"><a href=\"#02-be-consistent-in-the-code-logic-when-emitting-events-in-setter-functions\" aria-label=\"02 be consistent in the code logic when emitting events in setter functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] Be consistent in the code logic when emitting events in setter functions</h2>\n<p>By convention, it’s recommended emitting the old value followed by the new one in the same event instead of the other way round.</p>\n<p>Here’s one instance found:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/USDe.sol#L23-L26\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/USDe.sol#L23-L26</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function setMinter(address newMinter) external onlyOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    emit MinterUpdated(newMinter, minter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    emit MinterUpdated(minter, newMinter);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    minter = newMinter;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h2 id=\"03-delta-neutrality-caution\" style=\"position:relative;\"><a href=\"#03-delta-neutrality-caution\" aria-label=\"03 delta neutrality caution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] Delta neutrality caution</h2>\n<p>Users should be cautioned about the impermanent losses entailed arising from the delta-neutral stability strategy adopted by the protocol, specifically if the short positions were to encounter hefty losses. Apparently, the users could have held on to their collateral, e.g. <code>stETH or WETH</code>, and ended up a lot richer with the equivalent amount of <code>USDe</code>. I suggest all minting entries to begin with stable coins like <code>USDC, DAI etc</code> that could be converted to <code>stETH</code> to generate yield if need be instead of having users depositing <code>stETH</code> from their wallet reserves. Psychologically, this will make the users feel better as the mentality has been fostered more on preserving the 1:1 peg of <code>USDe</code> at all times. </p>\n<h2 id=\"04-easy-dos-on-big-players-when-minting-and-redeeming-in-ethenamintingsol\" style=\"position:relative;\"><a href=\"#04-easy-dos-on-big-players-when-minting-and-redeeming-in-ethenamintingsol\" aria-label=\"04 easy dos on big players when minting and redeeming in ethenamintingsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] Easy DoS on big players when minting and redeeming in EthenaMinting.sol</h2>\n<p>As indicated on the audit description, users intending to mint/redeem a large amount will need to mint/redeem over several blocks due to <code>maxMintPerBlock</code> or <code>maxRedeemPerBlock</code>. However, these RFQ’s are prone to DoS because <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L98\"><code>mintedPerBlock[block.number] + mintAmount > maxMintPerBlock</code></a> or <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L105\"><code>redeemedPerBlock[block.number] + redeemAmount > maxRedeemPerBlock</code></a> could revert by only 1 wei in excess.</p>\n<p>While these issues could be sorted by the backend to make a full use of <code>maxMintPerBlock</code> or <code>maxRedeemPerBlock</code> per block, it will make the intended logic a lot more efficient by auto reducing the RFQ amount to perfectly fill up the remaining quota for the current block. Better yet, set up a queue system where request amount running in hundreds of thousands or millions may be auto split up with multiple orders via only one signature for batching.</p>\n<h2 id=\"05-inexpedient-code-lines\" style=\"position:relative;\"><a href=\"#05-inexpedient-code-lines\" aria-label=\"05 inexpedient code lines permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] Inexpedient code lines</h2>\n<p>In the function below, the if block already dictates that <code>getUnvestedAmount() == 0</code> manages to avoid a revert. Hence, consider refactoring the following code lines as it makes no sense adding 0 value <code>getUnvestedAmount()</code> of to the addend, <code>amount</code>:   </p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDe.sol#L89-L99\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDe.sol#L89-L99</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function transferInRewards(uint256 amount) external nonReentrant onlyRole(REWARDER_ROLE) notZero(amount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (getUnvestedAmount() &gt; 0) revert StillVesting();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 newVestingAmount = amount + getUnvestedAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    vestingAmount = newVestingAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vestingAmount = amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // The rest of the codes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h2 id=\"06-emission-of-identical-values\" style=\"position:relative;\"><a href=\"#06-emission-of-identical-values\" aria-label=\"06 emission of identical values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] Emission of identical values</h2>\n<p>Under the context of the above/preceding recommendation, <code>transferInRewards()</code> should also have its <code>emit</code> refactored below. Otherwise, you are practically emitting two identical values that defeat the purpose of contrasting the old and the values.</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDe.sol#L89-L99\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDe.sol#L89-L99</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function transferInRewards(uint256 amount) external nonReentrant onlyRole(REWARDER_ROLE) notZero(amount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (getUnvestedAmount() &gt; 0) revert StillVesting();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 newVestingAmount = amount + getUnvestedAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    vestingAmount = newVestingAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    emit RewardsReceived(vestingAmount, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    vestingAmount = amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lastDistributionTimestamp = block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // transfer assets from rewarder to this contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IERC20(asset()).safeTransferFrom(msg.sender, address(this), amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    emit RewardsReceived(amount, newVestingAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h2 id=\"07-typo-mistakes\" style=\"position:relative;\"><a href=\"#07-typo-mistakes\" aria-label=\"07 typo mistakes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] Typo mistakes</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L94\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L94</a><br>\n<a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L110\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L110</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  /// @param owner address to redeem and start cooldown, owner must allowed caller to perform this action</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  /// @param owner address to redeem and start cooldown, owner must allow caller to perform this action</span></span></span></code></pre>\n<h2 id=\"08-functions-should-have-fully-intended-logic\" style=\"position:relative;\"><a href=\"#08-functions-should-have-fully-intended-logic\" aria-label=\"08 functions should have fully intended logic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] Functions should have fully intended logic</h2>\n<p>The function below is meant to be used only for minting. Hence, redeeming has got nothing to do with this view function. Consider refactoring the first if block so <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L171\"><code>mint()</code></a> could revert earlier if need be:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L351-L374\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L351-L374</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  function verifyRoute(Route calldata route, OrderType orderType) public view override returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // routes only used to mint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (orderType == OrderType.REDEEM) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (orderType =! OrderType.MINT) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      return false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    uint256 totalRatio = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (route.addresses.length != route.ratios.length) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      return false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (route.addresses.length == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      return false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    for (uint256 i = 0; i &lt; route.addresses.length; ++i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      if (!_custodianAddresses.contains(route.addresses[i]) || route.addresses[i] == address(0) || route.ratios[i] == 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      totalRatio += route.ratios[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (totalRatio != 10_000) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      return false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h2 id=\"09-unneeded-function-still-not-removed\" style=\"position:relative;\"><a href=\"#09-unneeded-function-still-not-removed\" aria-label=\"09 unneeded function still not removed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] Unneeded function still not removed</h2>\n<p>Per Pashov’s audit report, L-04 mentioned that the unused <code>EthenaMinting::encodeRoute</code> has been removed by Ethena. However, this erroneous function still exists in EthenaMinting.sol. </p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L334-L336\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/EthenaMinting.sol#L334-L336</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  function encodeRoute(Route calldata route) public pure returns (bytes memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    return abi.encode(ROUTE_TYPE, route.addresses, route.ratios);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  }</span></span></span></code></pre>\n<p>Consider removing this controversial function where possible. </p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/602#issuecomment-1804182947\">FJ-Riveros (Ethena) acknowledged</a></strong></p>\n<p><strong><em>Note: the following submissions from the same warden were downgraded from Medium to Low/Non-critical and were also considered by the judge in scoring:</em></strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/367\">[10] Inconsistent Role-Based Checks in <code>redistributeLockedAmount</code> and <code>_beforeTokenTransfer functions</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/371\">[11] Denial-of-Service Vulnerability via Minimum Shares Restriction</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/389\">[12] Inflexible Withdrawal Management in StakedUSDeV2 Contract</a></li>\n</ul>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 41 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/443\">report highlighted below</a> by <strong>0xVolcano</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/652\">0xAnah</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/515\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/348\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/333\">niser93</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/324\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/722\">SAQ</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/715\">tabriz</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/693\">J4X</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/664\">petrichor</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/661\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/659\">shamsulhaq123</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/649\">radev_sw</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/645\">Raihan</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/607\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/600\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/599\">0xAadi</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/580\">ThreeSigma</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/570\">0xhex</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/567\">brakelessak</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/564\">unique</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/555\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/553\">0xta</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/544\">0xpiken</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/542\">arjun16</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/527\">thekmj</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/522\">phenom80</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/498\">aslanbek</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/496\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/493\">yashgoel72</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/482\">0xgrbr</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/480\">pavankv</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/467\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/362\">SM3_SS</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/256\">nuthan2x</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/251\">K42</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/183\">castle_chain</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/143\">evmboi32</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/124\">naman1778</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/81\">ybansal2403</a>, and <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/9\">0xhacksmithh</a>.</em></p>\n<h2 id=\"g-01-use-constants-for-variables-that-dont-change-save-a-storage-slot-2200-gas\" style=\"position:relative;\"><a href=\"#g-01-use-constants-for-variables-that-dont-change-save-a-storage-slot-2200-gas\" aria-label=\"g 01 use constants for variables that dont change save a storage slot 2200 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Use constants for variables that don’t change (Save a storage SLOT: 2200 Gas)</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L22\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L22</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StakedUSDeV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">22</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_COOLDOWN_DURATION</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">90</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The variable <code>MAX_COOLDOWN_DURATION</code> should be declared as a constant variable since it does not change, from the naming, it would seem the intention was to actually make it a constant.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/StakedUSDeV2.sol b/contracts/StakedUSDeV2.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index df2bb48..f8fa980 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/StakedUSDeV2.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/StakedUSDeV2.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -19,7 +19,7 @@ contract StakedUSDeV2 is IStakedUSDeCooldown, StakedUSDe {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   USDeSilo public silo;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  uint24 public MAX_COOLDOWN_DURATION = 90 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  uint24 public constant MAX_COOLDOWN_DURATION = 90 days;</span></span></span></code></pre>\n<h2 id=\"g-02-unnecessary-sloads-inside-the-constructor-save-2-sloads---4200-gas\" style=\"position:relative;\"><a href=\"#g-02-unnecessary-sloads-inside-the-constructor-save-2-sloads---4200-gas\" aria-label=\"g 02 unnecessary sloads inside the constructor save 2 sloads   4200 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Unnecessary SLOADS inside the constructor (Save 2 SLOADS - 4200 Gas)</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L111-L136\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L111-L136</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">EthenaMinting</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">111</span><span class=\"mtk1\">:  </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">IUSDe</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_usde</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_custodians</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_admin</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxMintPerBlock</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">117</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxRedeemPerBlock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:  ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Set the max mint/redeem limits per block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">135</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_setMaxMintPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxMintPerBlock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">_setMaxRedeemPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_maxRedeemPerBlock</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In the constructor, we call <code>_setMaxMintPerBlock()</code> and <code>_setMaxRedeemPerBlock()</code> functions to set <code>maxMintPerBlock</code> and <code>maxRedeemPerBlock</code> respectively.\nThe functions are defined as follows (we only focus on <code>_setMaxMintPerBlock()</code> as they are essentially the same).</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L436-L440\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L436-L440</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">436</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setMaxMintPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxMintPerBlock</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">437</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldMaxMintPerBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maxMintPerBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">438</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">maxMintPerBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxMintPerBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">439</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaxMintPerBlockChanged</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldMaxMintPerBlock</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxMintPerBlock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">440</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>This function will first read the current value of <code>maxMintPerBlock</code> and store in a local variable,however when called inside the constructor, we know the value of <code>maxMintPerBlock</code> is <code>0</code> so we don’t necessarily need to cache it inside the constructor, we just need to set it.</p>\n<p>Caching inside the constructor would just mean we are using an SLOAD(2100 gas) to cache value <code>0</code>.</p>\n<p>I suggest we refactor the constructor as follows which would save us 2 cold SLOADS:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Set the max mint/redeem limits per block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _setMaxMintPerBlock(_maxMintPerBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    _setMaxRedeemPerBlock(_maxRedeemPerBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    maxMintPerBlock = _maxMintPerBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    maxRedeemPerBlock = _maxRedeemPerBlock;</span></span></span></code></pre>\n<p>If we really need to emit events inside the constructor, we can define a new event that would emit the current set value, i.e. <code>_maxMintPerBlock</code> and <code>_maxRedeemPerBlock</code>.</p>\n<h2 id=\"g-03-modifier-makes-it-expensive-since-we-end-up-reading-state-twice-saves-1197-gas-on-average-from-the-tests\" style=\"position:relative;\"><a href=\"#g-03-modifier-makes-it-expensive-since-we-end-up-reading-state-twice-saves-1197-gas-on-average-from-the-tests\" aria-label=\"g 03 modifier makes it expensive since we end up reading state twice saves 1197 gas on average from the tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Modifier makes it expensive since we end up reading state twice (Saves 1197 Gas on average from the tests)</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L162-L174\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L162-L174</a></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Min</th>\n<th>Average</th>\n<th>Median</th>\n<th>Max</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Before</td>\n<td>4657</td>\n<td>81745</td>\n<td>123779</td>\n<td>195520</td>\n</tr>\n<tr>\n<td>After</td>\n<td>4645</td>\n<td>80548</td>\n<td>123639</td>\n<td>195380</td>\n</tr>\n</tbody>\n</table>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">EthenaMinting</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Route</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">route</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Signature</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">163:    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">164:    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">165:    </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">166:    </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">167:    </span><span class=\"mtk11\">belowMaxMintPerBlock</span><span class=\"mtk1\">(order.usde_amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">168:  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">169</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">order_type</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">OrderType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">MINT</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidOrder</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">verifyOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">171</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">verifyRoute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">route</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">order_type</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidRoute</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">172</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_deduplicateOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">benefactor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Duplicate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">173</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Add to the minted amount in this block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">174</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">mintedPerBlock</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usde_amount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The function <code>mint()</code> makes use of the modifier <code>belowMaxMintPerBlock()</code> which has the following implementation:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L97-L100\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L97-L100</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">97</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">belowMaxMintPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">98</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">mintedPerBlock</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">mintAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">maxMintPerBlock</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaxMintPerBlockExceeded</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">99</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>Note, the modifier reads <code>mintedPerBlock[block.number]</code> which is a state varible.</p>\n<p>Our <code>mint()</code> function also does the same SLOAD when adding to the minted amount.</p>\n<p>We can avoid making this two SLOADS by simply in lining this modifier and caching the result of <code>mintedPerBlock[block.number]</code> as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -164,14 +164,15 @@ contract EthenaMinting is IEthenaMinting, SingleAdminAccessControl, ReentrancyGu</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     onlyRole(MINTER_ROLE)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    belowMaxMintPerBlock(order.usde_amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _mintedPerBlock = mintedPerBlock[block.number];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_mintedPerBlock + order.usde_amount &gt; maxMintPerBlock) revert MaxMintPerBlockExceeded();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (order.order_type != OrderType.MINT) revert InvalidOrder();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     verifyOrder(order, signature);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (!verifyRoute(route, order.order_type)) revert InvalidRoute();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (!_deduplicateOrder(order.benefactor, order.nonce)) revert Duplicate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Add to the minted amount in this block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    mintedPerBlock[block.number] += order.usde_amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    mintedPerBlock[block.number] = _mintedPerBlock + order.usde_amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     _transferCollateral(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       order.collateral_amount, order.collateral_asset, order.benefactor, route.addresses, route.ratios</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     );</span></span></span></code></pre>\n<p>Since the modifier was only being used for the function <code>mint()</code>, we can go ahead and delete it.</p>\n<h2 id=\"g-04-reading-same-state-variable-twice-due-to-modifier-usage-save-2040-gas-on-average-from-the-tests\" style=\"position:relative;\"><a href=\"#g-04-reading-same-state-variable-twice-due-to-modifier-usage-save-2040-gas-on-average-from-the-tests\" aria-label=\"g 04 reading same state variable twice due to modifier usage save 2040 gas on average from the tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Reading Same state variable twice due to modifier usage (Save 2040 Gas on average from the tests)</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L194-L205\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L194-L205</a>\n|        | Min    | Average | Median   | Max   |\n| ------ | --- | ------- | ----- | ----- |\n| Before | 6349    | 40053   | 27127 | 81127 |\n| After  | 6337    | 38013   | 20962 | 81017 |</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">EthenaMinting</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">194</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Signature</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">195:    </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">196:    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">197:    </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">198:    </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">REDEEMER_ROLE</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">199:    </span><span class=\"mtk11\">belowMaxRedeemPerBlock</span><span class=\"mtk1\">(order.usde_amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">200:  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">order_type</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">OrderType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">REDEEM</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidOrder</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">202</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">verifyOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">203</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_deduplicateOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">benefactor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">nonce</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Duplicate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">204</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// Add to the redeemed amount in this block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">redeemedPerBlock</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usde_amount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Similar to our previous finding, the function <code>redeem()</code> uses the modifier <code>belowMaxRedeemPerBlock()</code> which is implemented as below:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L104-L107\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L104-L107</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:  </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">belowMaxRedeemPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">redeemAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">redeemedPerBlock</span><span class=\"mtk1\">[</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">redeemAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">maxRedeemPerBlock</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaxRedeemPerBlockExceeded</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>We read the state variable <code>redeemedPerBlock[block.number]</code> which is also read inside the <code>redeem()</code> function. We can inline the modifier which would allow us to cache the call which helps avoid making extra sloads.</p>\n<p>Refactor the code as shown below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -196,13 +191,14 @@ contract EthenaMinting is IEthenaMinting, SingleAdminAccessControl, ReentrancyGu</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     onlyRole(REDEEMER_ROLE)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    belowMaxRedeemPerBlock(order.usde_amount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _redeemedPerBlock = redeemedPerBlock[block.number];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_redeemedPerBlock + order.usde_amount &gt; maxRedeemPerBlock) revert MaxRedeemPerBlockExceeded();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (order.order_type != OrderType.REDEEM) revert InvalidOrder();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     verifyOrder(order, signature);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (!_deduplicateOrder(order.benefactor, order.nonce)) revert Duplicate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Add to the redeemed amount in this block</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    redeemedPerBlock[block.number] += order.usde_amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    redeemedPerBlock[block.number] = _redeemedPerBlock + order.usde_amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     usde.burnFrom(order.benefactor, order.usde_amount);</span></span></span></code></pre>\n<p>Since the modifier was only being used for the function <code>redeem()</code>, we can go ahead and delete it.</p>\n<h2 id=\"g-05-we-can-save-an-entire-sload-2100-gas-by-short-circuiting-the-operations\" style=\"position:relative;\"><a href=\"#g-05-we-can-save-an-entire-sload-2100-gas-by-short-circuiting-the-operations\" aria-label=\"g 05 we can save an entire sload 2100 gas by short circuiting the operations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] We can save an entire SLOAD (2100 Gas) by short circuiting the operations</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L413-L433\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L413-L433</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">EthenaMinting</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">413</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transferCollateral</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">419:  ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">420</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// cannot mint using unsupported asset or native ETH even if it is supported for redemptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">421</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_supportedAssets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">contains</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">) || </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">NATIVE_TOKEN</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">UnsupportedAsset</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>The if statement has two checks <code>!_supportedAssets.contains(asset)</code> and <code>asset == NATIVE_TOKEN</code> where the first check involves making a state read while the second check only compares a constant variable to a function parameter.</p>\n<p>According to the rules of short circuit, if the first check is true, we do not have to do the second check thus in this case, we should make sure the first check is the cheapest to do.</p>\n<p>By reordering as shown below, we can avoid making the state read if <code>asset == NATIVE_TOKEN</code> which would save us ~2100 Gas.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/EthenaMinting.sol b/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 32da3a5..35f4613 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -418,7 +418,7 @@ contract EthenaMinting is IEthenaMinting, SingleAdminAccessControl, ReentrancyGu</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256[] calldata ratios</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   ) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // cannot mint using unsupported asset or native ETH even if it is supported for redemptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (!_supportedAssets.contains(asset) || asset == NATIVE_TOKEN) revert UnsupportedAsset();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (asset == NATIVE_TOKEN || !_supportedAssets.contains(asset) ) revert UnsupportedAsset();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     IERC20 token = IERC20(asset);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 totalTransferred = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     for (uint256 i = 0; i &lt; addresses.length; ++i) {</span></span></span></code></pre>\n<h2 id=\"g-06-we-can-avoid-making-a-function-call-here-by-utilizing-the-short-circuit-rules\" style=\"position:relative;\"><a href=\"#g-06-we-can-avoid-making-a-function-call-here-by-utilizing-the-short-circuit-rules\" aria-label=\"g 06 we can avoid making a function call here by utilizing the short circuit rules permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] We can avoid making a function call here by utilizing the short circuit rules</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L245-L252\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L245-L252</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">245</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_beforeTokenTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">246</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">from</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">247</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OperationNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">248</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">249</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FULL_RESTRICTED_STAKER_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">250</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">OperationNotAllowed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">251</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">252</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/StakedUSDe.sol b/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 0a56a7d..8551478 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -243,7 +243,7 @@ contract StakedUSDe is SingleAdminAccessControl, ReentrancyGuard, ERC20Permit, E</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function _beforeTokenTransfer(address from, address to, uint256) internal virtual override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (hasRole(FULL_RESTRICTED_STAKER_ROLE, from) &amp;&amp; to != address(0)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (to != address(0) &amp;&amp; hasRole(FULL_RESTRICTED_STAKER_ROLE, from)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       revert OperationNotAllowed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (hasRole(FULL_RESTRICTED_STAKER_ROLE, to)) {</span></span></span></code></pre>\n<h2 id=\"g-07-cache-function-calls\" style=\"position:relative;\"><a href=\"#g-07-cache-function-calls\" aria-label=\"g 07 cache function calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] Cache function calls</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L89-L99\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L89-L99</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferInRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">REWARDER_ROLE</span><span class=\"mtk1\">) </span><span class=\"mtk11\">notZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">getUnvestedAmount</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">StillVesting</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">91</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newVestingAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk11\">getUnvestedAmount</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>Note, we are calling <code>getUnvestedAmount()</code> function two times. If we look at the implementation of that function <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L173-L181\">here</a>, we have the following:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">173</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getUnvestedAmount</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">174</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeSinceLastDistribution</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastDistributionTimestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">timeSinceLastDistribution</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">VESTING_PERIOD</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">177</span><span class=\"mtk1\">:      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">178</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">180</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> ((</span><span class=\"mtk12\">VESTING_PERIOD</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">timeSinceLastDistribution</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">vestingAmount</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">VESTING_PERIOD</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">181</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>Note, in this function, we make two state reads(SLOADS) for <code>lastDistributionTimestamp</code> and <code>vestingAmount</code>. As this is the first SLOAD in this transaction, this means the variables are COLD thus we use 2100 Gas per variable. Ie 4200 Gas for the two variables read.</p>\n<p>Calling this function twice would incur a lot of cost (gas). We should cache the results if this call and save them in a local variable as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/StakedUSDe.sol b/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 0a56a7d..0953b2f 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -87,8 +87,9 @@ contract StakedUSDe is SingleAdminAccessControl, ReentrancyGuard, ERC20Permit, E</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    * @param amount The amount of rewards to transfer.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function transferInRewards(uint256 amount) external nonReentrant onlyRole(REWARDER_ROLE) notZero(amount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (getUnvestedAmount() &gt; 0) revert StillVesting();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 newVestingAmount = amount + getUnvestedAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 _unvestedAmount = getUnvestedAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (_unvestedAmount &gt; 0) revert StillVesting();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 newVestingAmount = amount + _unvestedAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     vestingAmount = newVestingAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     lastDistributionTimestamp = block.timestamp;</span></span></span></code></pre>\n<p>Note: <strong>The following finding is somehow related to this one, some confusion on why the devs choose to do the calls.</strong> The next finding will show an alternate optimization.</p>\n<h2 id=\"g-08-unnecessary-function-call-saves-369-gas-on-average\" style=\"position:relative;\"><a href=\"#g-08-unnecessary-function-call-saves-369-gas-on-average\" aria-label=\"g 08 unnecessary function call saves 369 gas on average permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] Unnecessary function call (Saves 369 Gas on average)</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L89-L99\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDe.sol#L89-L99</a>\n|        | Min    | Average | Median   | Max   |\n| ------ | --- | ------- | ----- | ----- |\n| Before | 4359    | 42190   | 44596 | 66916 |\n| After  | 4359    | 41821   | 44065 | 66385 |</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StakedUSDe</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferInRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">REWARDER_ROLE</span><span class=\"mtk1\">) </span><span class=\"mtk11\">notZero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">getUnvestedAmount</span><span class=\"mtk1\">() &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">StillVesting</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">91</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newVestingAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk11\">getUnvestedAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">93</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">vestingAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newVestingAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">94</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">lastDistributionTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">95</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">// transfer assets from rewarder to this contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk11\">asset</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">98</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RewardsReceived</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newVestingAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">99</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>The function <code>getUnvestedAmount()</code> returns <code>uint256</code> which means anything greater than or equal to  <code>0</code>.</p>\n<p>We revert if the return is greater than 0, which means the only way we get to execute the function <code>transferInRewards()</code> is when <code>getUnvestedAmount()</code> returns <code>0</code>. This begs the question, why do we call the function on the second line if we can only get there when <code>getUnvestedAmount() == 0</code>?</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/StakedUSDe.sol b/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 0a56a7d..a378300 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/StakedUSDe.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -88,7 +88,7 @@ contract StakedUSDe is SingleAdminAccessControl, ReentrancyGuard, ERC20Permit, E</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function transferInRewards(uint256 amount) external nonReentrant onlyRole(REWARDER_ROLE) notZero(amount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (getUnvestedAmount() &gt; 0) revert StillVesting();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 newVestingAmount = amount + getUnvestedAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 newVestingAmount = amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     vestingAmount = newVestingAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     lastDistributionTimestamp = block.timestamp;</span></span></span></code></pre>\n<h2 id=\"g-09-validate-function-parameters-before-making-function-calls-or-reading-any-state-variables\" style=\"position:relative;\"><a href=\"#g-09-validate-function-parameters-before-making-function-calls-or-reading-any-state-variables\" aria-label=\"g 09 validate function parameters before making function calls or reading any state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Validate function parameters before making function calls or reading any state variables</h2>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L339-L348\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L339-L348</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">EthenaMinting</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">339</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">verifyOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Signature</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">340</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">taker_order_hash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">hashOrder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">order</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">341</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signer</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ECDSA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">recover</span><span class=\"mtk1\">(</span><span class=\"mtk12\">taker_order_hash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signature</span><span class=\"mtk1\">.</span><span class=\"mtk12\">signature_bytes</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">342</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!(</span><span class=\"mtk12\">signer</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">benefactor</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">delegatedSigner</span><span class=\"mtk1\">[</span><span class=\"mtk12\">signer</span><span class=\"mtk1\">][</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">benefactor</span><span class=\"mtk1\">])) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidSignature</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">343</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">beneficiary</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">344</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">collateral_amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">345</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">usde_amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">346</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">expiry</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SignatureExpired</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">347</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk12\">taker_order_hash</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">348</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/EthenaMinting.sol b/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 32da3a5..cf642d5 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -337,13 +337,13 @@ contract EthenaMinting is IEthenaMinting, SingleAdminAccessControl, ReentrancyGu</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   /// @notice assert validity of signed order</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function verifyOrder(Order calldata order, Signature calldata signature) public view override returns (bool, bytes32) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    bytes32 taker_order_hash = hashOrder(order);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address signer = ECDSA.recover(taker_order_hash, signature.signature_bytes);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    if (!(signer == order.benefactor || delegatedSigner[signer][order.benefactor])) revert InvalidSignature();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (order.beneficiary == address(0)) revert InvalidAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (order.collateral_amount == 0) revert InvalidAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (order.usde_amount == 0) revert InvalidAmount();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     if (block.timestamp &gt; order.expiry) revert SignatureExpired();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    bytes32 taker_order_hash = hashOrder(order);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address signer = ECDSA.recover(taker_order_hash, signature.signature_bytes);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    if (!(signer == order.benefactor || delegatedSigner[signer][order.benefactor])) revert InvalidSignature();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     return (true, taker_order_hash);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h2 id=\"g-10-emit-local-variables-instead-of-state-variable-save-100-gas\" style=\"position:relative;\"><a href=\"#g-10-emit-local-variables-instead-of-state-variable-save-100-gas\" aria-label=\"g 10 emit local variables instead of state variable save 100 gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Emit local variables instead of state variable (Save ~100 Gas)</h2>\n<h3 id=\"emit-_maxmintperblock-instead-of-maxmintperblock\" style=\"position:relative;\"><a href=\"#emit-_maxmintperblock-instead-of-maxmintperblock\" aria-label=\"emit _maxmintperblock instead of maxmintperblock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Emit <code>_maxMintPerBlock</code> instead of <code>maxMintPerBlock</code></h3>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L436-L440\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L436-L440</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">EthenaMinting</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">436</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setMaxMintPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxMintPerBlock</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">437</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldMaxMintPerBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maxMintPerBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">438</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">maxMintPerBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxMintPerBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">439</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaxMintPerBlockChanged</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldMaxMintPerBlock</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxMintPerBlock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">440</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>Since we are setting our state variable <code>maxRedeemPerBlock</code> to the function parameter <code>_maxRedeemPerBlock</code>, we should emit the function parameter as it is cheaper to read compared to the state variable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/EthenaMinting.sol b/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 32da3a5..f569e40 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -436,7 +436,7 @@ contract EthenaMinting is IEthenaMinting, SingleAdminAccessControl, ReentrancyGu</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function _setMaxMintPerBlock(uint256 _maxMintPerBlock) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 oldMaxMintPerBlock = maxMintPerBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     maxMintPerBlock = _maxMintPerBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    emit MaxMintPerBlockChanged(oldMaxMintPerBlock, maxMintPerBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    emit MaxMintPerBlockChanged(oldMaxMintPerBlock, _maxMintPerBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"emit-_maxmintperblock-instead-of-maxmintperblock-1\" style=\"position:relative;\"><a href=\"#emit-_maxmintperblock-instead-of-maxmintperblock-1\" aria-label=\"emit _maxmintperblock instead of maxmintperblock 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Emit <code>_maxMintPerBlock</code> instead of <code>maxMintPerBlock</code></h3>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L443-L447\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/EthenaMinting.sol#L443-L447</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">EthenaMinting</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">443</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_setMaxRedeemPerBlock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxRedeemPerBlock</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">444</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oldMaxRedeemPerBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maxRedeemPerBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">445</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">maxRedeemPerBlock</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_maxRedeemPerBlock</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">446</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaxRedeemPerBlockChanged</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldMaxRedeemPerBlock</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maxRedeemPerBlock</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">447</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<p>Since we are setting our state variable <code>maxRedeemPerBlock</code> to the function parameter <code>_maxRedeemPerBlock</code>, we should emit the function parameter as it is cheaper to read compared to the state variable.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/EthenaMinting.sol b/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 32da3a5..8198a3e 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/EthenaMinting.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -443,7 +443,7 @@ contract EthenaMinting is IEthenaMinting, SingleAdminAccessControl, ReentrancyGu</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function _setMaxRedeemPerBlock(uint256 _maxRedeemPerBlock) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 oldMaxRedeemPerBlock = maxRedeemPerBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     maxRedeemPerBlock = _maxRedeemPerBlock;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    emit MaxRedeemPerBlockChanged(oldMaxRedeemPerBlock, maxRedeemPerBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    emit MaxRedeemPerBlockChanged(oldMaxRedeemPerBlock, _maxRedeemPerBlock);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h3 id=\"emit-duration-instead-of-cooldownduration-save-1-sload\" style=\"position:relative;\"><a href=\"#emit-duration-instead-of-cooldownduration-save-1-sload\" aria-label=\"emit duration instead of cooldownduration save 1 sload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Emit <code>duration</code> instead of <code>cooldownDuration</code> (Save 1 SLOAD)</h3>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L126-L134\">https://github.com/code-423n4/2023-10-ethena/blob/ee67d9b542642c9757a6b826c82d0cae60256509/contracts/StakedUSDeV2.sol#L126-L134</a>\n|        | Min    | Average | Median   | Max   |\n| ------ | --- | ------- | ----- | ----- |\n| Before | 2439    | 3110   | 2439 | 9239 |\n| After  | 2425    | 3097   | 2425 | 9225 |</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">StakedUSDeV2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">126</span><span class=\"mtk1\">:  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setCooldownDuration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">127</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">duration</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_COOLDOWN_DURATION</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">128</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidCooldown</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">:    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">131</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousDuration</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cooldownDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">cooldownDuration</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CooldownDurationUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">previousDuration</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cooldownDuration</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">:  }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/StakedUSDeV2.sol b/contracts/StakedUSDeV2.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index df2bb48..d3f1b29 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/StakedUSDeV2.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/StakedUSDeV2.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -130,6 +130,6 @@ contract StakedUSDeV2 is IStakedUSDeCooldown, StakedUSDe {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint24 previousDuration = cooldownDuration;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     cooldownDuration = duration;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    emit CooldownDurationUpdated(previousDuration, cooldownDuration);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    emit CooldownDurationUpdated(previousDuration, duration);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/443#issuecomment-1804479032\">FJ-Riveros (Ethena) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 25 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/460\">report highlighted below</a> by <strong>radev_sw</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/723\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/708\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/701\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/641\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/637\">Al-Qa-qa</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/539\">J4X</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/503\">Kral01</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/483\">0xweb3boy</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/458\">fouzantanveer</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/425\">albahaca</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/218\">pavankv</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/193\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/185\">invitedtea</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/171\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/695\">D_Auditor</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/668\">clara</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/656\">Bulletprime</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/655\">xiao</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/597\">jauvany</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/586\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/559\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/543\">K42</a>, <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/327\">Bauchibred</a>, and <a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/87\">digitizeworx</a>.</em></p>\n<h2 id=\"1-architecture-overview\" style=\"position:relative;\"><a href=\"#1-architecture-overview\" aria-label=\"1 architecture overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Architecture Overview</h2>\n<h3 id=\"11-protocol-explanation\" style=\"position:relative;\"><a href=\"#11-protocol-explanation\" aria-label=\"11 protocol explanation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1. Protocol Explanation</h3>\n<ul>\n<li><strong>Overview:</strong><br>\nEthena is developing a DeFi ecosystem with a primary goal of offering a permissionless stablecoin, USDe, that allows users to earn yield within the system. This process is a contrast to traditional stablecoins like USDC, where the central authority (e.g., Circle) benefits from the yield. In Ethena’s ecosystem, users can stake their USDe to earn stUSDe, which appreciates over time as the protocol generates yield.</li>\n<li>\n<p><strong>Smart Contract Infrastructure:</strong><br></p>\n<ul>\n<li><code>USDe.sol</code>: The contract for the USDe stablecoin, limited in functionality with controls for minting privileges.</li>\n<li><code>EthenaMinting.sol</code>: This contract mints and redeems USDe in a single, atomic, trustless transaction. Central to user interactions, handling minting and redemption of USDe. It employs EIP712 signatures for transactions, routing collateral through predefined safe channels, and includes security measures against potential compromises by limiting minting and providing emergency roles (GATEKEEPERS) to intervene in suspicious activities.</li>\n<li><code>StakedUSDeV2.sol</code>: Allows USDe holders to stake their tokens for stUSDe, earning yield from the protocol’s profits. It incorporates mechanisms to prevent exploitation of yield payouts and has a cooldown period for unstaking. For legal compliance, it can restrict certain users (based on jurisdiction or law enforcement directives) from staking or freeze their assets, with the provision of fund recovery in extreme cases.</li>\n</ul>\n</li>\n<li>\n<p><strong>Roles in Ethena Ecosystem:</strong><br></p>\n<ul>\n<li><code>USDe</code> minter - can mint any amount of USDe tokens to any address. Expected to be the EthenaMinting contract.</li>\n<li><code>USDe</code> owner - can set token minter and transfer ownership to another address</li>\n<li><code>USDe</code> token holder - can not just transfer tokens but burn them and sign permits for others to spend their balance</li>\n<li><code>StakedUSDe</code> admin - can rescue tokens from the contract and also to redistribute a fully restricted staker’s stUSDe balance, as well as give roles to other addresses (for example the FULL<em>RESTRICTED</em>STAKER_ROLE role)</li>\n<li><code>StakedUSDeV2</code> admin - has all power of “StakedUSDe admin” and can also call the setCooldownDuration method</li>\n<li><code>REWARDER_ROLE</code> - can transfer rewards into the StakedUSDe contract that will be vested over the next 8 hours</li>\n<li><code>BLACKLIST_MANAGER_ROLE</code> - can do/undo full or soft restriction on a holder of stUSDe</li>\n<li><code>SOFT_RESTRICTED_STAKER_ROLE</code> - address with this role can’t stake his USDe tokens or get stUSDe tokens minted to him</li>\n<li><code>FULL_RESTRICTED_STAKER_ROLE</code> - address with this role can’t burn his stUSDe tokens to unstake his USDe tokens, neither to transfer stUSDe tokens. His balance can be manipulated by the admin of StakedUSDe</li>\n<li><code>MINTER_ROLE</code> - can actually mint USDe tokens and also transfer EthenaMinting’s token or ETH balance to a custodian address</li>\n<li><code>REDEEMER_ROLE</code> - can redeem collateral assets for burning USDe</li>\n<li><code>EthenaMinting admin</code> - can set the maxMint/maxRedeem amounts per block and add or remove supported collateral assets and custodian addresses, grant/revoke roles</li>\n<li><code>GATEKEEPER_ROLE</code> - can disable minting/redeeming of USDe and remove MINTER<em>ROLE and REDEEMER</em>ROLE roles from authorized accounts</li>\n</ul>\n</li>\n<li>\n<p><strong>What custodian is? (Chat GPT says)</strong><br></p>\n<ul>\n<li>In the realm of cryptocurrencies and blockchain technology, a “custodian” refers to an entity (company or smart contract) that holds and safeguards an individual’s or institution’s digital assets. The role of a custodian is critical in scenarios where security and proper asset management are paramount. This concept isn’t exclusive to digital assets; traditional financial institutions have custodians as well.</li>\n<li>Within a blockchain environment, an address usually refers to a specific destination where cryptocurrencies are sent. Think of it like an account number in the traditional banking sense.\nIn the context of smart contracts or decentralized applications, <code>custodianAddresses</code> likely refer to the collection of blockchain addresses that are authorized to hold assets on behalf of others.\nThese addresses are controlled by the custodian, which could be a smart contract or a third-party service that maintains the security of the private keys associated with these addresses.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"12-codebase-explanation--examples-scenarios-of-intended-protocol-flow\" style=\"position:relative;\"><a href=\"#12-codebase-explanation--examples-scenarios-of-intended-protocol-flow\" aria-label=\"12 codebase explanation  examples scenarios of intended protocol flow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2. Codebase Explanation &#x26; Examples Scenarios of Intended Protocol Flow</h3>\n<p><strong>All possible Actions and Flows in Ethena Protocol:</strong></p>\n<p><strong>1. Minting USDe:</strong><br>\nUsers provide stETH as collateral to mint USDe. The system gives an RFQ (Request for Quote) detailing how much USDe they can create. Upon agreement, the user signs a transaction, and Ethena mints USDe against the stETH, which is then employed in various yield-generating activities, primarily shorting ETH perpetual futures to maintain a delta-neutral position.</p>\n<p><strong>Additional Explanations Related to the <code>Minting</code>:</strong><br></p>\n<ul>\n<li>So, <code>USDe</code> will be equivalent to using DAI, USDC, USDT (<code>USDe</code> contract is just the ERC20 token for the stablecoin and this token will be the token used in <code>StakedUSDeV2.sol</code> staking contract) where it <code>doesn't have any yield</code> and <code>only the holders of stUSDe</code> will earn the generated yield.</li>\n<li>The <code>EthenaMinting.sol</code> contract is the place where <code>minting</code> is done.</li>\n</ul>\n<p><strong>2. Yield Generating:</strong><br>\nEthena generates yield by taking advantage of the differences in staking returns (3-4% for stETH) and shorting ETH perpetuals (6-8%). Profits are funneled into an insurance fund and later distributed to stakers, enhancing the value of stUSDe relative to USDe.</p>\n<p><strong>3. Maintaining Delta Neutrality:</strong><br>\nEthena employs a strategy involving stETH and short positions in ETH perpetuals, ensuring the value stability of users’ holdings against market volatility.</p>\n<p><strong>Example 1:</strong><br></p>\n<ol>\n<li>\n<p>Initial Setup:</p>\n<ul>\n<li>The user initiates the process by sending 10 stETH to Ethena. The stETH is a token representing staked Ethereum in the Ethereum 2.0 network, allowing holders to earn rewards while keeping liquidity. At the time of the transaction, Ethereum’s price is $2,000; thus, 10 stETH equals $20,000.</li>\n<li>Ethena uses these 10 stETH to mint 20,000 USDe stablecoins for the user, reflecting the stETH’s dollar value.</li>\n<li>Simultaneously, Ethena opens a short position on Ethereum perpetual futures (ETH perps) equivalent to 10 ETH. Given the current Ethereum price of $2,000, this also represents a $20,000 position. This short position means that Ethena is betting on the Ethereum price going down.</li>\n</ul>\n</li>\n<li>\n<p>Market Movement and Its Impact:</p>\n<ul>\n<li>Now, the market faces significant volatility, and the price of Ethereum drops by 90%. As a result, the value of the user’s 10 stETH decreases to $2,000 (reflecting the 90% drop from the original $20,000 value).</li>\n<li>However, because Ethena shorted 10 ETH worth of perps, the decrease in Ethereum’s price is advantageous for this position. The short ETH perps position now has an unrealized profit of $18,000. This profit occurs because Ethena ‘borrowed’ the ETH at a higher price to open the position and can now ‘buy’ it back at a much lower price, pocketing the difference.</li>\n</ul>\n</li>\n<li>\n<p>Redemption Process:</p>\n<ul>\n<li>The user decides to redeem their 20,000 USDe. For Ethena to honor this request, they need to provide the user with the equivalent value in stETH that the USDe represents.</li>\n<li>Ethena closes the short position on the ETH perps, which means they ‘buy’ back the ETH at the current market price, realizing the $18,000 profit due to the price difference from when they opened the short position.</li>\n<li>With the $18,000, Ethena purchases 90 stETH at the current market price ($200 per stETH, as the price has dropped by 90%).</li>\n<li>Ethena then returns the original 10 stETH along with the 90 stETH purchased from the profits of the short position. So, the user receives 100 stETH, which, at the current market price, is worth $20,000.</li>\n</ul>\n</li>\n</ol>\n<p><strong>Example 2:</strong><br></p>\n<ol>\n<li>\n<p>Initial Condition:</p>\n<ul>\n<li>The price of ETH is $2,000.</li>\n<li>The user sends in 10 stETH (equivalent to 10 ETH) to Ethena to mint 20,000 USDe (since 10 ETH at $2,000 per ETH is worth $20,000).</li>\n<li>Ethena takes these 10 stETH and opens a short position on 10 ETH’s worth of perpetual futures (perps) to hedge against the price movement of ETH.</li>\n</ul>\n</li>\n<li>\n<p>Market Movement:</p>\n<ul>\n<li>The market goes up by 50%. Therefore, the price of ETH (and stETH, as it’s pegged to the ETH value) increases to $3,000.</li>\n</ul>\n</li>\n<li>\n<p>Position Analysis:</p>\n<ul>\n<li>The user’s 10 stETH is now worth $30,000 due to the market increase.</li>\n<li>However, Ethena’s short position is now at a notional loss because it was betting on the price of ETH going down, not up. The loss on the short position is $10,000 (the increase in value per ETH is $1,000, and Ethena shorted 10 ETH).</li>\n</ul>\n</li>\n<li>\n<p>Redemption Process:</p>\n<ul>\n<li>If the user decides to redeem their USDe, they will present their 20,000 USDe.</li>\n<li>Considering the market movement, the short position’s loss needs to be covered. Ethena has to close the short position and realize the loss of $10,000.</li>\n<li>After covering the $10,000 loss, there’s $20,000 worth of stETH left (approximately 6.67 stETH at the new rate of $3,000 per stETH) to return to the user.</li>\n</ul>\n</li>\n<li>\n<p>End Result:</p>\n<ul>\n<li>The user initially had assets worth $20,000 (10 stETH). If they hadn’t engaged with Ethena and simply held onto their 10 stETH, their assets would now be worth $30,000 due to the positive market movement.</li>\n<li>By choosing to use Ethena’s hedging mechanism, they’ve forfeited potential gains to safeguard against potential losses. They receive approximately 6.67 stETH (worth $20,000) back after the redemption process, missing out on the additional $10,000 value increase.</li>\n<li>Essentially, the user’s assets remained stable in USDe value, but they did not benefit from ETH’s bullish market. Their asset value didn’t decrease, but they also lost potential profit</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"2-codebase-quality-analysis\" style=\"position:relative;\"><a href=\"#2-codebase-quality-analysis\" aria-label=\"2 codebase quality analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Codebase Quality Analysis</h2>\n<ol>\n<li>\n<p><strong><code>USDe.sol</code></strong>:</p>\n<ul>\n<li>Code Organization:</li>\n<li>The contract is well-organized and follows the best practices for code layout and structure.</li>\n<li>It uses OpenZeppelin contracts, which are widely recognized and audited.</li>\n<li>The constructor initializes the contract and sets the owner/admin.</li>\n<li>It provides functions to set the minter and mint USDe tokens.</li>\n<li>Modifiers:</li>\n<li>The contract uses the <code>Ownable2Step</code> modifier, which enforces two-step ownership transfer.</li>\n<li>The <code>onlyRole</code> modifier is used to restrict certain functions to specific roles, enhancing security.</li>\n<li>Minting:</li>\n<li>The contract allows only the minter to mint new tokens, which is a good security measure.</li>\n<li>It checks if the provided minter is valid.</li>\n<li>Gas Efficiency:</li>\n<li>The contract uses the SafeERC20 library for safe token transfers, ensuring protection against reentrancy attacks.</li>\n<li>Gas-efficient practices are followed throughout the contract.</li>\n<li>Overall, <code>USDe.sol</code> appears to be well-structured and follows best practices for security and code organization.</li>\n</ul>\n</li>\n<li>\n<p><strong><code>EthenaMinting.sol</code></strong>:</p>\n<ul>\n<li>Code Organization:</li>\n<li>It imports external libraries and contracts, including OpenZeppelin contracts.</li>\n<li>The constructor initializes contract parameters and roles.</li>\n<li>It contains functions for minting and redeeming USDe tokens.</li>\n<li>Security Measures:</li>\n<li>The contract enforces access control using role-based access control (RBAC) with different roles for minters, redeemers, and gatekeepers.</li>\n<li>Gas limits for minting and redeeming are enforced to prevent abuse.</li>\n<li>Signature Verification:</li>\n<li>It verifies the signature of orders, ensuring that the orders are signed by authorized parties.</li>\n<li>It uses EIP-712 for signature verification.</li>\n<li>Gas Efficiency:</li>\n<li>Gas-efficient practices are followed, and SafeERC20 is used for token transfers.</li>\n<li>Domain Separator:</li>\n<li>The contract computes the domain separator for EIP-712, enhancing security.</li>\n<li>Deduplication:</li>\n<li>The contract implements deduplication of taker orders to prevent replay attacks.</li>\n<li>Supported Assets:</li>\n<li>The contract maintains a list of supported assets.</li>\n<li>Custodian Addresses:</li>\n<li>It keeps track of custodian addresses and allows transfers to custodian wallets.</li>\n<li>Overall, <code>EthenaMinting.sol</code> is well-structured, secure, and follows best practices for code organization and security.</li>\n</ul>\n</li>\n<li><strong><code>StakedUSDe.sol:</code></strong></li>\n</ol>\n<p>  The contract inherits <strong>Implementation of the ERC4626 “Tokenized Vault Standard” from OZ</strong></p>\n<ul>\n<li>\n<p>Code Organization:</p>\n<ul>\n<li>It imports external libraries and contracts, including OpenZeppelin contracts.</li>\n<li>The constructor initializes contract parameters and roles.</li>\n<li>It contains functions for transferring rewards, managing the blacklist, rescuing tokens, and redistributing locked amounts.</li>\n<li>Public functions are provided to query the total assets and unvested amounts.</li>\n<li>The <code>decimals</code> function is overridden to return the number of decimal places.</li>\n<li>Custom modifiers ensure input validation and role-based access control.</li>\n<li>Hooks and functions are in place to enforce restrictions on specific roles and token transfers.</li>\n</ul>\n</li>\n<li><strong><code>StakedUSDeV2.sol:</code></strong></li>\n<li>\n<p>Code Organization:</p>\n<ul>\n<li>The contract extends <code>StakedUSDe</code> and inherits its code organization structure.</li>\n<li>It introduces additional state variables, including <code>cooldowns</code>, <code>silo</code>, <code>MAX_COOLDOWN_DURATION</code>, and <code>cooldownDuration</code>.</li>\n<li>Custom modifiers, <code>ensureCooldownOff</code> and <code>ensureCooldownOn</code>, are defined to control the execution of functions based on cooldown status.</li>\n<li>The constructor initializes the contract and sets the cooldown duration.</li>\n<li>External functions are provided for withdrawing, redeeming, and performing cooldown actions for assets and shares.</li>\n<li>The contract enforces different behavior based on the cooldown duration, adhering to or breaking the ERC4626 standard.</li>\n<li>The <code>setCooldownDuration</code> function allows the admin to update the cooldown duration.</li>\n</ul>\n</li>\n<li><strong><code>USDeSilo.sol:</code></strong></li>\n<li>The contract is primary goal of <code>USDeSilo.sol</code> is to to <code>hold the funds</code> for the <code>cooldown period</code> whn user initiate <code>unstaking</code>. </li>\n</ul>\n<p>  <strong>General Observations:</strong><br></p>\n<ul>\n<li>Role-based access control is implemented for various functions, enhancing security.</li>\n<li>Gas-efficient practices, such as using SafeERC20, are followed throughout the code.</li>\n<li>The codebase of protocol includes comprehensive comments and region divisions for clarity.</li>\n<li>Note that, The use of EIP-712 for signature verification adds an extra layer of security.</li>\n<li><strong><code>SingleAdminAccessControl.sol:</code></strong></li>\n<li>EthenaMinting uses SingleAdminAccessControl rather than the standard AccessControl.</li>\n</ul>\n<p>In summary, the Ethena Protocol’s codebase appears to be of high quality, with a strong focus on security and code organization.</p>\n<h2 id=\"3-centralization-risks\" style=\"position:relative;\"><a href=\"#3-centralization-risks\" aria-label=\"3 centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Centralization Risks</h2>\n<p>Actually, the <code>Ethena</code> Protocol contains many roles, each with quite a few abilities. This is necessary for the Protocol’s logic and purpose.</p>\n<p>The protocol assigns important roles like “MINTER,” “REWARDER,” and “ADMIN” to specific entities, potentially exposing the system to undue influence or risks if these roles are compromised.</p>\n<p>So, these roles introduce several <strong>centralization risks</strong>. The most significant one is the scenario in which the <strong><code>MINTER</code> role becomes compromised</strong>. An attacker/minter could then <code>mint a billion USDe</code> without collateral and dump them into pools, causing a black swan event that our insurance fund cannot cover.</p>\n<p>However, <code>Ethena</code> <strong>addresses this problem</strong> by enforcing on-chain <strong>mint and redeem limitations of 100k USDe</strong> per block.”</p>\n<p>From the documentation:</p>\n<blockquote>\n<p>Our solution is to enforce an on chain mint and redeem limitation of 100k USDe per block. In addition, we have <code>GATEKEEPER</code> roles with the ability to disable mint/redeems and remove <code>MINTERS</code>,<code>REDEEMERS</code>. <code>GATEKEEPERS</code> acts as a safety layer in case of compromised <code>MINTER</code>/<code>REDEEMER</code>. They will be run in seperate AWS accounts not tied to our organisation, constantly checking each transaction on chain and disable mint/redeems on detecting transactions at prices not in line with the market. In case compromised <code>MINTERS</code> or <code>REDEEMERS</code> after this security implementation, a hacker can at most mint 100k USDe for no collateral, and redeem all the collateral within the contract (we will hold ~$200k max), for a max loss of $300k in a single block, before <code>GATEKEEPER</code> disable mint and redeem. The $300k loss will not materialy affect our operations.</p>\n</blockquote>\n<p>In summary, <code>Ethena</code> actually introduces several centralization risks due to the presence of many different roles in the Protocol. <strong>However, at the same time, the team has done its best to enforce measures that reduce the largest potential attack scenario to a maximum loss of $300k, which will not materially affect the <code>Ethena</code> operations/ecosystem.</strong></p>\n<h2 id=\"4-systemic-risks\" style=\"position:relative;\"><a href=\"#4-systemic-risks\" aria-label=\"4 systemic risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Systemic Risks</h2>\n<p>Here’s an analysis of potential systemic</p>\n<ol>\n<li>Smart Contract Vulnerability Risk:\nSmart contracts can contain <code>vulnerabilities</code> that can be exploited by attackers. If a smart contract has <code>critical security flaws</code>, such as logic problems, this could lead to asset loss or <code>system manipulation</code>. I strongly recommend that, once the protocol is audited, necessary actions be taken to <code>mitigate any issues</code> identified by <code>C4 Wardens</code></li>\n<li>Third-Party Dependency Risk:\nContracts rely on external data sources, such as <code>@openzeppelin/contracts-upgradeable</code>, and there is a risk that if any <code>issues</code> are found with these <code>dependencies</code> in your contracts, the <code>Ethena</code> protocol could also be affected.</li>\n</ol>\n<p>I observed that <code>old versions</code> of <code>OpenZeppelin</code> are used in the project, and these should be updated to the latest version:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;name&quot;: &quot;@openzeppelin/contracts-upgradeable&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;description&quot;: &quot;Secure Smart Contract library for Solidity&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  &quot;version&quot;: &quot;4.9.2&quot;,</span></span></code></pre>\n<p>The latest version is <code>4.9.3</code> (as of July 28, 2023), while the project uses version <code>4.9.2</code>.</p>\n<h2 id=\"5-attack-vectors-discussed-during-the-audit\" style=\"position:relative;\"><a href=\"#5-attack-vectors-discussed-during-the-audit\" aria-label=\"5 attack vectors discussed during the audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Attack Vectors Discussed During the Audit</h2>\n<ol>\n<li>Issues related to Roles (Centralization Risks). Problems with roles changing.</li>\n<li>\n<p>Breaking of Main Protocol Invariants</p>\n<ul>\n<li>EthenaMinting.sol - User’s signed EIP712 order, if executed, must always execute as signed. ie for mint orders, USDe is minted to user and collateral asset is removed from user based on the signed values.</li>\n<li>Max mint per block should never be exceeded.</li>\n<li>USDe.sol - Only the defined minter address can have the ability to mint USDe.</li>\n</ul>\n</li>\n<li>DoS for important protocol functions/flows such as <code>EtehnaMinting.sol#mint()</code> (Minting Flow), <code>EtehnaMinting.sol#redeem()</code> (Redemption Flow), <code>StakedUSDe#deposit()/StakedUSDe#_deposit()</code> (Depositing Flow), <code>StakedUSDeV2#unstake()</code> (Unstaking Flow). </li>\n<li>Token transfer fails.</li>\n<li>Minting more than 100k USDe per block.</li>\n<li>Users cannot unstake/withdraw/redeem.</li>\n<li>Can users withdraw more than they actually are supposed to?</li>\n<li>Minting without providing collateral amount?</li>\n</ol>\n<h2 id=\"6-example-report\" style=\"position:relative;\"><a href=\"#6-example-report\" aria-label=\"6 example report permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. Example Report</h2>\n<p>Example of report that turned out to be invalid after I wrote a <code>really good Explanation and PoC</code>. The report explain the <code>unstaking</code> really well, so you can learn for it.</p>\n<h3 id=\"title-users-will-not-be-able-to-withdrawredeem-their-assetsshares-from-stackedusdev2-contract-inefficient-logic\" style=\"position:relative;\"><a href=\"#title-users-will-not-be-able-to-withdrawredeem-their-assetsshares-from-stackedusdev2-contract-inefficient-logic\" aria-label=\"title users will not be able to withdrawredeem their assetsshares from stackedusdev2 contract inefficient logic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Title: Users will not be able to <code>withdraw/redeem</code> their assets/shares from <code>StackedUSDeV2</code> contract. (Inefficient logic)</h3>\n<h3 id=\"explanation\" style=\"position:relative;\"><a href=\"#explanation\" aria-label=\"explanation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Explanation</h3>\n<p><a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol\"><code>StakedUSDeV2.sol</code></a> is where holders of <code>USDe</code> stablecoin can stake their stablecoin, get <code>stUSDe</code> in return and <code>earn yield</code>. The Etehna Protocol yield is paid out by having a <code>REWARDER</code> role of the staking contract send yield in <code>USDe</code>, increasing the <code>stUSDe</code> value with respect to <code>USDe</code>. This contract is a modification of the <code>ERC4626 standard</code>, with a change to vest in rewards linearly over 8 hours</p>\n<p>When the <code>unstake</code> process is initiated, from the user’s perspective, <code>stUSDe</code> is burnt immediately, and they will be able to invoke the <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L52-L60\"><code>withdraw()</code></a> function after <code>cooldown</code> is up to get their <code>USDe</code> in return. Behind the scenes, on <code>burning of stUSDe</code>, <code>USDe</code> is sent to a seperate <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/USDeSilo.sol\">USDeSilo</a> contract to hold the funds for the <code>cooldown period</code>. And on <code>withdrawal</code>, the staking contract moves user funds from <code>USDeSilo</code> contract out to the <code>user's address</code>.</p>\n<ol>\n<li>Functions respond for <code>redemption</code>, <code>starting of cooldown</code> and <code>transferring of converted underlying asset to USSDeSilo contract</code> are <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L95-L122\">cooldownAssets() and cooldownShares()</a></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">cooldownAssets</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ensureCooldownOn</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExcessiveWithdrawAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">previewWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cooldowns</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk12\">cooldownEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint104</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">cooldownDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cooldowns</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk12\">underlyingAmount</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">silo</span><span class=\"mtk1\">), </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @notice redeem shares into assets and starts a cooldown to claim the converted underlying asset</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @param shares shares to redeem</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @param owner address to redeem and start cooldown, owner must allowed caller to perform this action</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">cooldownShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ensureCooldownOn</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">maxRedeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExcessiveRedeemAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">previewRedeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cooldowns</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk12\">cooldownEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint104</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">cooldownDuration</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cooldowns</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">].</span><span class=\"mtk12\">underlyingAmount</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">silo</span><span class=\"mtk1\">), </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<ol start=\"2\">\n<li>After <code>cooldown</code> is finished, user can call <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L78-L90\"><code>unstake()</code></a> to <code>claim the staking amount after</code>.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">UserCooldown</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userCooldown</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cooldowns</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">userCooldown</span><span class=\"mtk1\">.</span><span class=\"mtk12\">underlyingAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">userCooldown</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cooldownEnd</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">userCooldown</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cooldownEnd</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">userCooldown</span><span class=\"mtk1\">.</span><span class=\"mtk12\">underlyingAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">silo</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidCooldown</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><em>The function check if the cooldown is finished by <code>block.timestamp >= userCooldown.cooldownEnd</code> check.</em><br>\n<em>REMEMBER: The assets are transferred from <code>USDeSilo</code> contract -> <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/USDeSilo.sol#L28-L30\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/USDeSilo.sol#L28-L30</a></em></p>\n<p>Described logic above works only if the cooldown is set to number greater than zero. (aka the cooldown is active)</p>\n<p>The <code>Ethena</code> can decide to <code>disable the cooldown period</code>, so the users to be able <code>unstake without cooldown period</code>. If this is done, the user will be able to call directly <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/StakedUSDeV2.sol#L52-L73\"><code>withdraw()/redeem()</code></a> to unstake:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">virtual</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ensureCooldownOff</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   * </span><span class=\"mtk4\">@dev</span><span class=\"mtk3\"> See {IERC4626-redeem}.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">   */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">virtual</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ensureCooldownOff</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><em>REMEMBER: The assets are transferred from <code>StakedUSDeV2</code> contract -> <a href=\"https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/USDeSilo.sol#L28-L30\">https://github.com/code-423n4/2023-10-ethena/blob/main/contracts/USDeSilo.sol#L28-L30</a></em></p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>So, the problem in Ethena protocol logic aries exactly when <code>Ethena</code> decide to <code>disable the cooldown period</code>.</p>\n<p>Let’s illustrate the following example:</p>\n<p><strong>Scenario</strong></p>\n<ul>\n<li>Cooldown Period: 50 days</li>\n<li>Alice deposit her 10000 <code>USDe</code> tokens in <code>StakedUSDeV2</code> contract.</li>\n<li>Bob also deposit his 20000 <code>USDe</code> tokens in <code>StakedUSDeV2</code> contract.</li>\n<li>After some time Bob decide to unstake and call <code>cooldownAssets()</code> to start of cooldown period and converted underlying asset are transferred to <code>USSDeSilo</code> contract and he redeem his 20000 <code>USDe</code> tokens.</li>\n<li>After 30 days <code>Ethena</code> disable cooldown period.</li>\n<li>Now users are supposed to unstake directly from <code>withdraw()/redeem()</code>.</li>\n<li>But when the Bob tries to call <code>withdraw()/redeem()</code> he will not be able to get his converted underlying asset, because they are in <code>USDeSilo</code> contract.</li>\n<li>Alice call <code>withdraw()/redeem()</code> and get his converted underlying asset.</li>\n</ul>\n<p>After all, I observed that users who have already called <code>cooldownAssets()/cooldownShares()</code> can call the <code>unstake()</code> function again to retrieve their converted underlying asset.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-ethena-findings/issues/460#issuecomment-1804562701\">FJ-Riveros (Ethena) acknowledged</a></strong></p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-4\">Medium Risk Findings (4)</a></p>\n<ul>\n<li><a href=\"#m-01-full_restricted-stakers-can-bypass-restriction-through-approvals\">[M-01] <code>FULL_RESTRICTED</code> Stakers can bypass restriction through approvals</a></li>\n<li><a href=\"#m-02-soft-restricted-staker-role-can-withdraw-stusde-for-usde\">[M-02] Soft Restricted Staker Role can withdraw stUSDe for USDe</a></li>\n<li><a href=\"#m-03-users-still-forced-to-follow-previously-set-cooldownduration-even-when-cooldown-is-off-set-to-zero-before-unstaking\">[M-03] users still forced to follow previously set cooldownDuration even when cooldown is off (set to zero) before unstaking</a></li>\n<li><a href=\"#m-04-malicious-users-can-front-run-to-cause-a-denial-of-service-dos-for-stakedusde-due-to-minshares-checks\">[M-04] Malicious users can front-run to cause a denial of service (DoS) for StakedUSDe due to MinShares checks</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#01-use-an-efficient-logic-in-setter-functions\">01 Use an efficient logic in setter functions</a></li>\n<li><a href=\"#02-be-consistent-in-the-code-logic-when-emitting-events-in-setter-functions\">02 Be consistent in the code logic when emitting events in setter functions</a></li>\n<li><a href=\"#03-delta-neutrality-caution\">03 Delta neutrality caution</a></li>\n<li><a href=\"#04-easy-dos-on-big-players-when-minting-and-redeeming-in-ethenamintingsol\">04 Easy DoS on big players when minting and redeeming in EthenaMinting.sol</a></li>\n<li><a href=\"#05-inexpedient-code-lines\">05 Inexpedient code lines</a></li>\n<li><a href=\"#06-emission-of-identical-values\">06 Emission of identical values</a></li>\n<li><a href=\"#07-typo-mistakes\">07 Typo mistakes</a></li>\n<li><a href=\"#08-functions-should-have-fully-intended-logic\">08 Functions should have fully intended logic</a></li>\n<li><a href=\"#09-unneeded-function-still-not-removed\">09 Unneeded function still not removed</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-use-constants-for-variables-that-dont-change-save-a-storage-slot-2200-gas\">G-01 Use constants for variables that don’t change (Save a storage SLOT: 2200 Gas)</a></li>\n<li><a href=\"#g-02-unnecessary-sloads-inside-the-constructor-save-2-sloads---4200-gas\">G-02 Unnecessary SLOADS inside the constructor (Save 2 SLOADS - 4200 Gas)</a></li>\n<li><a href=\"#g-03-modifier-makes-it-expensive-since-we-end-up-reading-state-twice-saves-1197-gas-on-average-from-the-tests\">G-03 Modifier makes it expensive since we end up reading state twice (Saves 1197 Gas on average from the tests)</a></li>\n<li><a href=\"#g-04-reading-same-state-variable-twice-due-to-modifier-usage-save-2040-gas-on-average-from-the-tests\">G-04 Reading Same state variable twice due to modifier usage (Save 2040 Gas on average from the tests)</a></li>\n<li><a href=\"#g-05-we-can-save-an-entire-sload-2100-gas-by-short-circuiting-the-operations\">G-05 We can save an entire SLOAD (2100 Gas) by short circuiting the operations</a></li>\n<li><a href=\"#g-06-we-can-avoid-making-a-function-call-here-by-utilizing-the-short-circuit-rules\">G-06 We can avoid making a function call here by utilizing the short circuit rules</a></li>\n<li><a href=\"#g-07-cache-function-calls\">G-07 Cache function calls</a></li>\n<li><a href=\"#g-08-unnecessary-function-call-saves-369-gas-on-average\">G-08 Unnecessary function call (Saves 369 Gas on average)</a></li>\n<li><a href=\"#g-09-validate-function-parameters-before-making-function-calls-or-reading-any-state-variables\">G-09 Validate function parameters before making function calls or reading any state variables</a></li>\n<li><a href=\"#g-10-emit-local-variables-instead-of-state-variable-save-100-gas\">G-10 Emit local variables instead of state variable (Save ~100 Gas)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#audit-analysis\">Audit Analysis</a></p>\n<ul>\n<li><a href=\"#1-architecture-overview\">1. Architecture Overview</a></li>\n<li><a href=\"#2-codebase-quality-analysis\">2. Codebase Quality Analysis</a></li>\n<li><a href=\"#3-centralization-risks\">3. Centralization Risks</a></li>\n<li><a href=\"#4-systemic-risks\">4. Systemic Risks</a></li>\n<li><a href=\"#5-attack-vectors-discussed-during-the-audit\">5. Attack Vectors Discussed During the Audit</a></li>\n<li><a href=\"#6-example-report\">6. Example Report</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}