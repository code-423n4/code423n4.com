{
  "circa": {
    "title": "Shell Protocol",
    "sponsor": "Shell Protocol",
    "slug": "2023-11-shellprotocol",
    "date": "2024-01-05",
    "findings": "https://github.com/code-423n4/2023-11-shellprotocol-findings/issues",
    "contest": 308
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Shell Protocol smart contract system written in Solidity. The audit took place between November 30 â€” December 8, 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>22 Wardens contributed reports to Shell Protocol:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@peanuts\">peanuts</a></li>\n<li><a href=\"https://code4rena.com/@oakcobalt\">oakcobalt</a></li>\n<li><a href=\"https://code4rena.com/@EV_om\">EV_om</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@IllIllI\">IllIllI</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@0xmystery\">0xmystery</a></li>\n<li><a href=\"https://code4rena.com/@bin2chen\">bin2chen</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@Myd\">Myd</a></li>\n<li><a href=\"https://code4rena.com/@0x11singh99\">0x11singh99</a></li>\n<li><a href=\"https://code4rena.com/@0xVolcano\">0xVolcano</a></li>\n<li><a href=\"https://code4rena.com/@0xepley\">0xepley</a></li>\n<li><a href=\"https://code4rena.com/@invitedtea\">invitedtea</a></li>\n<li><a href=\"https://code4rena.com/@0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://code4rena.com/@LinKenji\">LinKenji</a></li>\n<li><a href=\"https://code4rena.com/@albahaca\">albahaca</a></li>\n<li><a href=\"https://code4rena.com/@clara\">clara</a></li>\n<li><a href=\"https://code4rena.com/@foxb868\">foxb868</a></li>\n<li><a href=\"https://code4rena.com/@alexbabits\">alexbabits</a></li>\n<li><a href=\"https://code4rena.com/@ZanyBonzy\">ZanyBonzy</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@0xA5DF\">0xA5DF</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/brittfactorC4\">thebrittfactor</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 0 unique vulnerabilities in the HIGH and MEDIUM severity categories.</p>\n<p>Additionally, C4 analysis included 8 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 5 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-11-shellprotocol\">C4 Shell Protocol repository</a>, and is composed of 4 smart contracts written in the Solidity programming language and includes 993 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>The_Madaladinator</strong> from warden Madalad, generated the <a href=\"https://gist.github.com/code423n4/640b27a9b9c209b575ed78aa106bd584\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 8 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/236\">report highlighted below</a> by <strong>peanuts</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/336\">EV_om</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/159\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/99\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/294\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/171\">0xmystery</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/151\">IllIllI</a>, and <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/52\">bin2chen</a>.</em></p>\n<h2 id=\"01-2-address-tokens-will-not-work-properly-on-the-ocean-erc1155-ledger\" style=\"position:relative;\"><a href=\"#01-2-address-tokens-will-not-work-properly-on-the-ocean-erc1155-ledger\" aria-label=\"01 2 address tokens will not work properly on the ocean erc1155 ledger permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] 2 address tokens will not work properly on the Ocean ERC1155 Ledger.</h2>\n<p>ERC20 tokens with multiple entry points (known as double entry tokens or two address tokens) such as Synthetixâ€™s ProxyERC20 contract will not work properly on the ledger. In the ledger, all tokens are given a specific uint256 value, by calling <code>_getSpecifiedToken()</code>, which will call <code>_calculateOceanId()</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 specifiedToken = _getSpecifiedToken(interactionType, externalContract, interaction</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">   function _calculateOceanId(address tokenAddress, uint256 tokenId) internal pure returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return uint256(keccak256(abi.encodePacked(tokenAddress, tokenId)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>If a user uses a two-address token, the two address will be considered different, and the Ocean will create 2 separate ledgers instead of 1.</p>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/adapters/OceanAdapter.sol#L107\">OceanAdapter.sol#L107</a></p>\n<h2 id=\"02-interactions-is-susceptible-to-read-only-reentrancy\" style=\"position:relative;\"><a href=\"#02-interactions-is-susceptible-to-read-only-reentrancy\" aria-label=\"02 interactions is susceptible to read only reentrancy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] Interactions is susceptible to read-only reentrancy</h2>\n<p>The interaction flow in Ocean.sol will complete the interaction first before minting/burning the input/output token.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        (inputToken, inputAmount, outputToken, outputAmount) = _executeInteraction(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                interaction, interactionType, externalContract, specifiedToken, interaction.specifiedAmount, userAddress</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // if _executeInteraction returned a positive value for inputAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // this amount must be deducted from the user&#39;s Ocean balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (inputAmount &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // since uint, same as (inputAmount != 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _burn(userAddress, inputToken, inputAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // if _executeInteraction returned a positive value for outputAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // this amount must be credited to the user&#39;s Ocean balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (outputAmount &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // since uint, same as (outputAmount != 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _mint(userAddress, outputToken, outputAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>Take the Unwrapping ERC721 interaction as an example. The user have an shERC721 and wants to unwrap it to get his ERC721 token back. When the ERC721 token is transferred to the user, the shERC721 is not burned yet. This means that the user has both shERC721 and ERC721 in the state.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _erc721Unwrap(address tokenAddress, uint256 tokenId, address userAddress, uint256 oceanId) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC721(tokenAddress).safeTransferFrom(address(this), userAddress, tokenId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Erc721Unwrap(tokenAddress, tokenId, userAddress, oceanId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>If the Ocean has more interactions in the future like lending/borrowing, the user can call ERC721Unwrap and do a cross-function reentrancy by reentering <code>safeTransferFrom()</code> after getting his ERC721 back but before burning his shERC721. For example, if the lending interaction just needs user to show proof that they have a particular shERC721 on hand, user can do the following:</p>\n<ul>\n<li>WrapERC721 to get shERC721.</li>\n<li>UnwrapERC721.</li>\n<li>After <code>safeTransferFrom</code> is called on ERC721, there is a callback to <code>onERC721Received</code>.</li>\n<li>User codes the <code>ERC721Received</code> to call the lend function.</li>\n<li>Since the lend function only requires the existence of the shERC721, call passes and user gets his loan.</li>\n<li>Callback ends, finishes the execution by burning the shERC721.</li>\n<li>User gets his ERC721 back and his loan.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function onERC721Received(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _sender, address _from, uint256 _tokenId, bytes memory _data)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external returns (bytes4 retval) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(msg.sender == address(victim), &quot;Nope&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Call the loan function</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return victim.onERC721Received.selector;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>This is hypothetical because there is no loan/borrow function on Ocean. However, the existence of a read-only reentrancy and that the user has 2 tokens at a point in the execution is dangerous. Ideally, burn the <code>sh(Tokens)</code> first before interaction. Minting later is fine. At all times, the user should only have 1 token in the state.</p>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/ocean/Ocean.sol#L904\">Ocean.sol#L904</a></p>\n<h2 id=\"03-user-can-escape-fees-on-erc1155-tokens\" style=\"position:relative;\"><a href=\"#03-user-can-escape-fees-on-erc1155-tokens\" aria-label=\"03 user can escape fees on erc1155 tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] User can escape fees on ERC1155 tokens</h2>\n<p>ERC1155 tokens from external sources may have different decimals, but they are not normalized to 18 decimals. The Ocean ledger takes whatever decimals it is and sets it to the corresponding shToken. For example, if a user wants to wrap an ERC1155 token that has 4 decimals, then they will mint a 4 decimal shToken.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _erc1155Wrap(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address tokenAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address userAddress,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 oceanId</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        private</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //@audit Note that there is no `_convertDecimals()` call</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (tokenAddress == address(this)) revert NO_RECURSIVE_WRAPS();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _ERC1155InteractionStatus = INTERACTION;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC1155(tokenAddress).safeTransferFrom(userAddress, address(this), tokenId, amount, &quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _ERC1155InteractionStatus = NOT_INTERACTION;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Erc1155Wrap(tokenAddress, tokenId, amount, userAddress, oceanId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The fee is therefore dependent on the amount of decimals that the ERC1155 token has. If a user wraps 100 tokens with 2 decimal places, eg <code>100e2</code>, they can choose not to pay the fees by calling <code>erc1155Unwrap</code> 5 times instead of unwrapping <code>100e2</code> tokens directly. This is because the <code>unwrapFeeDivisor</code> has a <code>minValue</code> of 2000, so if the user can make the <code>unwrapAmount</code> less than 2000, then they will not need to pay the fees. (Instead of unwrapping 10000 tokens and paying 5 tokens as fee, user unwraps 2000 tokens 5 times).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _calculateUnwrapFee(uint256 unwrapAmount) private view returns (uint256 feeCharged) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        feeCharged = unwrapAmount / unwrapFeeDivisor;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h2 id=\"04-airdrops-will-be-locked-in-the-contract\" style=\"position:relative;\"><a href=\"#04-airdrops-will-be-locked-in-the-contract\" aria-label=\"04 airdrops will be locked in the contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] Airdrops will be locked in the contract</h2>\n<p>There are some collection of ERC721 tokens that will airdrop users tokens if they have proof that they own an ERC721. There are other ERC721 collection that will airdrop tokens to every holder of the token. If the user deposits the ERC721 token which is eligible for an airdrop into the Ocean protocol, and an airdrop happens, the Ocean will receive the airdrop instead.</p>\n<p>Since the ocean contract does not have any way to withdraw random tokens, the airdrop will be locked inside the protocol.</p>\n<p>Not sure about the recommendation, but take note that some ERC721 collections may mint tokens for every holder or may airdrop tokens to holders once in a while. Make sure that these tokens are either not accepted into Ocean, or that the users are warned beforehand that the airdrop will be lost.</p>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/ocean/Ocean.sol#L79\">Ocean.sol#L79</a></p>\n<h2 id=\"05-natspec-on-oceanadapter_convertdecimals-should-be-revised\" style=\"position:relative;\"><a href=\"#05-natspec-on-oceanadapter_convertdecimals-should-be-revised\" aria-label=\"05 natspec on oceanadapter_convertdecimals should be revised permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] NATSPEC on <code>OceanAdapter._convertDecimals</code> should be revised</h2>\n<p>The function <code>_convertDecimals()</code> from OceanAdapter.sol is an exact copy on Ocean.sol. However, the OceanAdapter version does not return the <code>truncatedAmount</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">(OceanAdapter.sol)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function _convertDecimals(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint8 decimalsFrom,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint8 decimalsTo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountToConvert</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pure</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;       returns (uint256 convertedAmount)</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> function _convertDecimals(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint8 decimalsFrom,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint8 decimalsTo,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountToConvert</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pure</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;       returns (uint256 convertedAmount, uint256 truncatedAmount)</span></span></code></pre>\n<p>The comments on OceanAdapter.sol should be revised accordingly to not reference the <code>truncatedAmount</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">     * @dev convert a uint256 from one fixed point decimal basis to another,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     *   returning the truncated amount if a truncation occurs.</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/adapters/OceanAdapter.sol#L129-L130\">OceanAdapter.sol#L129-L130</a></p>\n<h2 id=\"06-minimumoutputamount-in-curveadaptor-can-be-integrated-into-the-curve-functionalities\" style=\"position:relative;\"><a href=\"#06-minimumoutputamount-in-curveadaptor-can-be-integrated-into-the-curve-functionalities\" aria-label=\"06 minimumoutputamount in curveadaptor can be integrated into the curve functionalities permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] <code>minimumOutputAmount</code> in CurveAdaptor can be integrated into the curve functionalities</h2>\n<p>The Curve Adapters interact with curve pool through three functions, <code>exchange()</code>, <code>remove_liquidity_one_coin()</code> and <code>add_liquidity()</code>. The last parameter of these functions are set to zero, which is the slippage parameter.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> ICurveTricrypto(primitive).remove_liquidity_one_coin(rawInputAmount, indexOfOutputAmount, 0);</span></span></code></pre>\n<p>Ocean protocol takes care of it by checking the slippage right at the end, but it can also be integrated right into the curve functions.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (uint256(minimumOutputAmount) &gt; outputAmount) revert SLIPPAGE_LIMIT_EXCEEDED();</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/adapters/CurveTricryptoAdapter.sol#L201-L203\">CurveTricryptoAdapter.sol#L201-L203</a></p>\n<h2 id=\"07-comments-on-erc20wrap-are-misleading\" style=\"position:relative;\"><a href=\"#07-comments-on-erc20wrap-are-misleading\" aria-label=\"07 comments on erc20wrap are misleading permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] Comments on ERC20Wrap are misleading</h2>\n<p>In ERC20Wrap, the <code>amount</code> parameter is supposed to be the amount of shTokens to receive, not the amount of ERC20 tokens to be wrapped.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;    * @param amount amount of the ERC-20 token to be wrapped, in terms of</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     *  18-decimal fixed point</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     * @param userAddress the address of the user who is wrapping the token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;   function _erc20Wrap(address tokenAddress, uint256 amount, address userAddress, uint256 outputToken) private {</span></span></code></pre>\n<p>The <code>outputAmount</code> is the <code>specifiedAmount</code>, which is passed as <code>amount</code> into ERC20Wrap function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else if (interactionType == InteractionType.WrapErc20) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            inputToken = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            inputAmount = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            outputToken = specifiedToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;          outputAmount = specifiedAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;           _erc20Wrap(externalContract, outputAmount, userAddress, outputToken);</span></span></code></pre>\n<p>This <code>outputAmount</code> is then minted as the shToken, which means that the <code>outputAmount</code> must be in the form of shTokens.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (outputAmount &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // since uint, same as (outputAmount != 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _mint(userAddress, outputToken, outputAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>It will be useful if <code>amount</code> is more specific and better explained in the comments. Is <code>amount</code> referring to the token amount to deposit or the corresponding shToken to receive?</p>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/ocean/Ocean.sol#L426-L431\">Ocean.sol#L426-L431</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/236#issuecomment-1858752730\">0xA5DF (judge) commented</a>:</strong></p>\n<blockquote>\n<p>[01] - Low<br>\n[02] - Low<br>\n[03] - Non-Critical<br>\n[04] - Non-Critical<br>\n[05] - Low<br>\n[06] - Refactor<br>\n[07] - Non-Critical</p>\n</blockquote>\n<h2 id=\"08-extreme-edge-case-error-results-in-user-paying-more-fees-than-usual-when-user-decides-to-mint-little-shtokens-with-low-decimals-tokens\" style=\"position:relative;\"><a href=\"#08-extreme-edge-case-error-results-in-user-paying-more-fees-than-usual-when-user-decides-to-mint-little-shtokens-with-low-decimals-tokens\" aria-label=\"08 extreme edge case error results in user paying more fees than usual when user decides to mint little shtokens with low decimals tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/272\">[08] Extreme edge case error results in user paying more fees than usual when user decides to mint little shTokens with low decimals tokens</a></h2>\n<p><em>Note: At the judgeâ€™s request <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/236#issuecomment-1858762123\">here</a>, this downgraded issue from the same warden has been included in this report for completeness.</em></p>\n<h3 id=\"lines-of-code\" style=\"position:relative;\"><a href=\"#lines-of-code\" aria-label=\"lines of code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/ocean/Ocean.sol#L1068-L1109\">https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/ocean/Ocean.sol#L1068-L1109</a></p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The wrapping and unwrapping process is mostly foolproof even with low/high decimal tokens. There is an edge case if a person intends to mint <code>~1e12</code> shTokens with a low decimal token.</p>\n<p>Letâ€™s say that token ABC has 2 decimals and is worth 20000 USDC (<code>1e2 ABC tokens == 20000</code>).</p>\n<p>User wants to mint <code>1e15</code> shABC tokens</p>\n<ul>\n<li><code>convertDecimals</code> (<code>18,2,1e15</code>).</li>\n<li><code>convertedAmount</code> <code>= 0</code>, <code>truncatedAmount</code> <code>= 1000000000000000</code>.</li>\n<li>Since <code>truncatedAmount</code> <code>> 0</code>, Line 1084 is executed.</li>\n<li><code>transferAmount</code> <code>= 1</code>.</li>\n<li><code>converDecimals</code> (<code>2,18,1</code>).</li>\n<li><code>normalizedTransferAmount</code> <code>= 10000000000000000</code>, <code>normalizedTruncatedAmount</code> <code>= 0</code>.</li>\n<li><code>dust =</code> <code>normalizedTransferAmount</code> <code>- 1e15 = 9e15</code>.</li>\n<li><code>transferAmount</code> <code>= 1</code>, <code>dust = 9e15</code>.</li>\n</ul>\n<p>In order to mint <code>1e15</code> shTokens, user has to pay 1 wei token to get <code>1e15</code> tokens. <code>9e15</code> shTokens is paid to the the protocol. By right, 1 wei token should get the user <code>1e16</code> shTokens instead of <code>1e15</code> shTokens.</p>\n<p>Code Reference: </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _determineTransferAmount(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint8 decimals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        private</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pure</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (uint256 transferAmount, uint256 dust)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // if (decimals &lt; 18), then converting 18-decimal amount to decimals</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // transferAmount will likely result in amount being truncated. This</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // case is most likely to occur when a user is wrapping a delta as the</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // final interaction in a transaction.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 truncated;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (transferAmount, truncated) = _convertDecimals(NORMALIZED_DECIMALS, decimals, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (truncated &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Here, FLOORish(x) is not to the nearest integer less than `x`,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // but rather to the nearest value with `decimals` precision less</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // than `x`. Likewise with CEILish(x).</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // When truncating, transferAmount is FLOORish(amount), but to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // fully cover a potential delta, we need to transfer CEILish(amount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // if truncated == 0, FLOORish(amount) == CEILish(amount)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // When truncated &gt; 0, FLOORish(amount) + 1 == CEILish(AMOUNT)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            transferAmount += 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Now that we are transferring enough to cover the delta, we</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // need to determine how much of the token the user is actually</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // wrapping, in terms of 18-decimals.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (uint256 normalizedTransferAmount, uint256 normalizedTruncatedAmount) =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _convertDecimals(decimals, NORMALIZED_DECIMALS, transferAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // If we truncated earlier, converting the other direction is adding</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // precision, which cannot truncate.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            assert(normalizedTruncatedAmount == 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            assert(normalizedTransferAmount &gt; amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            dust = normalizedTransferAmount - amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // if truncated == 0, then we don&#39;t need to do anything fancy to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // determine transferAmount, the result _convertDecimals() returns</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // is correct.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            dust = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>User pays more fees than normal when wrapping tokens with low decimals and minting low amounts of shTokens.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Recommend not allowing minting such a low amount of shTokens and also possibly disallowing extremely low decimal tokens.</p>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/272#issuecomment-1857724011\">0xA5DF (judge) decreased severity to QA</a></strong></p>\n<h2 id=\"09-owner-has-to-perpetually-pay-fees-to-withdraw-fees-resulting-in-dust-amount-left-in-the-contract\" style=\"position:relative;\"><a href=\"#09-owner-has-to-perpetually-pay-fees-to-withdraw-fees-resulting-in-dust-amount-left-in-the-contract\" aria-label=\"09 owner has to perpetually pay fees to withdraw fees resulting in dust amount left in the contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/221\">[09] Owner has to perpetually pay fees to withdraw fees, resulting in dust amount left in the contract</a></h2>\n<p><em>Note: At the judgeâ€™s request <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/236#issuecomment-1858762123\">here</a>, this downgraded issue from the same warden has been included in this report for completeness.</em></p>\n<h3 id=\"lines-of-code-1\" style=\"position:relative;\"><a href=\"#lines-of-code-1\" aria-label=\"lines of code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/ocean/Ocean.sol#L1166-L1171\">https://github.com/code-423n4/2023-11-shellprotocol/blob/485de7383cdf88284ee6bcf2926fb7c19e9fb257/src/ocean/Ocean.sol#L1166-L1171</a></p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The owner gets fees every time <code>_grantFeeToOcean()</code> is invoked, (from unwrapping ether, ERC1155, ERC20 and wrapping ERC20).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _grantFeeToOcean(uint256 oceanId, uint256 amount) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (amount &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // since uint, same as (amount != 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _mintWithoutSafeTransferAcceptanceCheck(owner(), oceanId, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>This fee is usually in the shToken format (except for the ERC1155 fees, which follows the ERC1155 token decimals), so when the owner wants to withdraw his fees in the ERC20 format, he will have to call unwrapERC20 as well.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _erc20Unwrap(address tokenAddress, uint256 amount, address userAddress, uint256 inputToken) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        try IERC20Metadata(tokenAddress).decimals() returns (uint8 decimals) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;           uint256 feeCharged = _calculateUnwrapFee(amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 amountRemaining = amount - feeCharged;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (uint256 transferAmount, uint256 truncated) =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                _convertDecimals(NORMALIZED_DECIMALS, decimals, amountRemaining);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            feeCharged += truncated;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;           _grantFeeToOcean(inputToken, feeCharged);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            SafeERC20.safeTransfer(IERC20(tokenAddress), userAddress, transferAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            emit Erc20Unwrap(tokenAddress, transferAmount, amount, feeCharged, userAddress, inputToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } catch {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert NO_DECIMAL_METHOD();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>When the owner calls the ERC20Unwrap interaction, he will have to pay fees as well. This means that whenever he wants to withdraw a sum of tokens, he will have to pay fees. Then, when he wants to withdraw the fees he paid, he will have to pay fees again. This will lead to a small sum of fees left inside the contract that cannot be withdrawn.</p>\n<p>Eg. Owner has about <code>100e18</code> of shUSDC accumulated from fees that he wants to withdraw. </p>\n<ul>\n<li>He calls <code>_erc20Unwrap()</code> to unwrap <code>100e18</code> shUSDC.</li>\n<li>Assuming <code>unwrapFeeDivisor</code> is 2000, the fees he has to pay is <code>100e18 / 2000 = 5e16</code>.</li>\n<li>He gets <code>99.95e6</code> USDC back but <code>0.05e6</code> USDC is left in the contract.</li>\n<li>He calls <code>_erc20Unwrap()</code> to unwrap <code>5e16</code> shUSDC.</li>\n<li>He has to pay <code>5e16 / 2000</code> fees which is <code>2.5e13</code>.</li>\n<li>He gets a small sum of USDC back but another smaller sum of USDC is left in the contract.</li>\n</ul>\n<p>This goes on perpetually; the owner cannot withdraw all his fees entirely.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Owner will have some fees stuck in the contract.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When calling <code>_grantFeeToOcean()</code>, if the <code>msg.sender</code> is the owner, then skip the function so that the owner doesnâ€™t have to pay his own fees.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function _grantFeeToOcean(uint256 oceanId, uint256 amount) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;       if (amount &gt; 0 &amp;&amp; msg.sender != owner()) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // since uint, same as (amount != 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _mintWithoutSafeTransferAcceptanceCheck(owner(), oceanId, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/221#issuecomment-1857368362\">0xA5DF (judge) decreased severity to QA</a></strong></p>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 5 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/274\">report highlighted below</a> by <strong>hunter_w3b</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/224\">0x11singh99</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/220\">0xVolcano</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/154\">IllIllI</a>, and <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/130\">Sathish9098</a>.</em></p>\n<h2 id=\"g-01-avoid-contract-existence-checks-by-using-low-level-calls\" style=\"position:relative;\"><a href=\"#g-01-avoid-contract-existence-checks-by-using-low-level-calls\" aria-label=\"g 01 avoid contract existence checks by using low level calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Avoid contract existence checks by using low level calls</h2>\n<p><strong>Issue Description</strong> - Prior to Solidity <code>0.8.10</code>, the compiler would insert extra code to check for contract existence before external function calls,\neven if the call had a return value. This wasted gas by performing a check that wasnâ€™t necessary.</p>\n<p><strong>Proposed Optimization</strong> - For functions that make external calls with return values in Solidity <code>&#x3C;0.8.10</code>, optimize the code to use low-level calls instead\nof regular calls. Low-level calls skip the unnecessary contract existence check.</p>\n<p>Example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//Before:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">C</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">f</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">otherContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;func()&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//After:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">C</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">f</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">,) = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">otherContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSignature</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;func()&quot;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">decodeReturnValue</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Estimated Gas Savings</strong> - Each avoided <code>EXTCODESIZE</code> check saves 100 gas. If 10 external calls are made in a common function, this would save 1000 gas\ntotal.</p>\n<p><strong>Code Snippets:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Curve2PoolAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">xTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">xToken</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">xTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">84</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">yToken</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">93</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">lpTokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IOceanInteractions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">).</span><span class=\"mtk11\">doInteraction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">interaction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IOceanInteractions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">).</span><span class=\"mtk11\">doInteraction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">interaction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">                </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">exchange</span><span class=\"mtk1\">(</span><span class=\"mtk12\">indexOfInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexOfOutputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">168</span><span class=\"mtk1\">            </span><span class=\"mtk12\">rawOutputAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">add_liquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">inputAmounts</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">            </span><span class=\"mtk12\">rawOutputAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">remove_liquidity_one_coin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexOfOutputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L78\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L78</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CurveTricryptoAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">86</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">xTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">xToken</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">xTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">92</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">yToken</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">99</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">token</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">lpTokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lpTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">            </span><span class=\"mtk11\">IOceanInteractions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">).</span><span class=\"mtk12\">doInteraction</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">interaction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">            </span><span class=\"mtk11\">IOceanInteractions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">).</span><span class=\"mtk11\">doInteraction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">interaction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">168</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IOceanInteractions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">).</span><span class=\"mtk11\">doInteraction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">interaction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">            </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">add_liquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">inputAmounts</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">[</span><span class=\"mtk12\">zToken</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">                </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">remove_liquidity_one_coin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexOfOutputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">[</span><span class=\"mtk12\">zToken</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">                </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">remove_liquidity_one_coin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexOfOutputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">242</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L86\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L86</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ocean</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">891</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">904</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">931</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC1155</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">968</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC1155</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amountRemaining</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L891\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L891</a></p>\n<h2 id=\"g-02-add-unchecked--for-subtractions-where-the-operands-cant-underflow-because-of-previous-checks\" style=\"position:relative;\"><a href=\"#g-02-add-unchecked--for-subtractions-where-the-operands-cant-underflow-because-of-previous-checks\" aria-label=\"g 02 add unchecked  for subtractions where the operands cant underflow because of previous checks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Add unchecked <code>{}</code> for subtractions where the operands canâ€™t underflow because of previous checks</h2>\n<p><strong>Issue Description</strong> - The subtraction operation <code>dust = normalizedTransferAmount - amount</code>; does not have an unchecked block, even though underflow\nis not possible due to the previous check <code>normalizedTransferAmount > amount</code>. Adding an unchecked block helps avoid unnecessary\nchecks.</p>\n<p><strong>Proposed Optimization</strong> - Add an unchecked block around the subtraction:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">dust</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedTransferAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Estimated Gas Savings</strong> - Adding an unchecked block for a subtraction that cannot underflow due to a previous check saves approximately 3 gas per subtraction.\nWith many such subtractions occurring across interactions, the total gas savings could be significant.</p>\n<p><strong>Code Snippets:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ocean</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1102</span><span class=\"mtk1\">            </span><span class=\"mtk12\">dust</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedTransferAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L1102\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L1102</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OceanAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shift</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** (</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decimalsTo</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">decimalsFrom</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/OceanAdapter.sol#L152\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/OceanAdapter.sol#L152</a></p>\n<h2 id=\"g-03-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g-03-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g 03 state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p><strong>Issue Description</strong> - In the <code>changeUnwrapFee()</code> function, the state variable <code>unwrapFeeDivisor</code> is read directly from storage on line 199 when emitting the event <code>ChangeUnwrapFee</code>. This is inefficient, as it incurs an extra storage read operation that is unnecessary.</p>\n<p><strong>Proposed Optimization</strong> - Cache the current value of <code>unwrapFeeDivisor</code> in a local stack variable before emitting the event and updating storage. This\navoids an unnecessary re-read of the storage.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeUnwrapFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentUnwrapFeeDivisor</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">unwrapFeeDivisor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">MIN_UNWRAP_FEE_DIVISOR</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">) </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ChangeUnwrapFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentUnwrapFeeDivisor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">unwrapFeeDivisor</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>Estimated Gas Savings</strong> - Reading a storage slot costs roughly 200 gas. Caching the value in a local variable avoids this extra read, saving roughly\n200 gas per function call.</p>\n<p><strong>Code Snippet:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ocean</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeUnwrapFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">197</span><span class=\"mtk1\">        </span><span class=\"mtk3\">/// @notice as the divisor gets smaller, the fee charged gets larger</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">198</span><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">MIN_UNWRAP_FEE_DIVISOR</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">) </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">199</span><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ChangeUnwrapFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">unwrapFeeDivisor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit &gt;&gt;&gt; unwrapFeeDivisor is state-variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">200</span><span class=\"mtk1\">        </span><span class=\"mtk12\">unwrapFeeDivisor</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1082</span><span class=\"mtk1\">        (</span><span class=\"mtk12\">transferAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">truncated</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">_convertDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">NORMALIZED_DECIMALS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit &gt;&gt;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1097</span><span class=\"mtk1\">                </span><span class=\"mtk11\">_convertDecimals</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">, </span><span class=\"mtk12\">NORMALIZED_DECIMALS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">transferAmount</span><span class=\"mtk1\">);        </span><span class=\"mtk3\">//@audit &gt;&gt;&gt;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L196-L201\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L196-L201</a></p>\n<h2 id=\"g-04-using-assembly-to-revert-with-an-error-message\" style=\"position:relative;\"><a href=\"#g-04-using-assembly-to-revert-with-an-error-message\" aria-label=\"g 04 using assembly to revert with an error message permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Using assembly to revert with an error message</h2>\n<p><strong>Issue Description</strong> - When reverting in solidity code, it is common practice to use a require or revert statement to revert execution with an error\nmessage. This can in most cases be further optimized by using assembly to revert with the error message.</p>\n<p><strong>Estimated Gas Savings</strong> - Hereâ€™s an example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// calling restrictedAction(2) with a non-owner address: 24042</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SolidityRevert</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">specialNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">restrictedAction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">num</span><span class=\"mtk1\">)  </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;caller is not owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">specialNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">num</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// calling restrictedAction(2) with a non-owner address: 23734</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AssemblyRevert</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">specialNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">restrictedAction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">num</span><span class=\"mtk1\">)  </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sub</span><span class=\"mtk1\">(</span><span class=\"mtk11\">caller</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">sload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slot</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// store offset to where length of revert message is stored</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x13</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// store length (19)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x40</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x63616c6c6572206973206e6f74206f776e657200000000000000000000000000</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// store hex representation of message</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">) </span><span class=\"mtk3\">// revert with data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">specialNumber</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">num</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>From the example above, we can see that we get a gas saving of over 300 gas when reverting with the same error message with assembly against doing so in solidity. This gas savings come from the memory expansion costs and extra type checks the solidity compiler does under the hood.</p>\n<p><strong>Code Snippets:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ocean</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">640</span><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">specifiedAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">INVALID_ERC721_AMOUNT</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">648</span><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">specifiedAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">INVALID_ERC721_AMOUNT</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">840</span><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NO_DECIMAL_METHOD</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">878</span><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NO_DECIMAL_METHOD</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">929</span><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NO_RECURSIVE_WRAPS</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">964</span><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NO_RECURSIVE_UNWRAPS</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L640\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L640</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Curve2PoolAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">175</span><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minimumOutputAmount</span><span class=\"mtk1\">) &gt; </span><span class=\"mtk12\">outputAmount</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SLIPPAGE_LIMIT_EXCEEDED</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">217</span><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">INVALID_COMPUTE_TYPE</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L175\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L175</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CurveTricryptoAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">227</span><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minimumOutputAmount</span><span class=\"mtk1\">) &gt; </span><span class=\"mtk12\">outputAmount</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SLIPPAGE_LIMIT_EXCEEDED</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">287</span><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">INVALID_COMPUTE_TYPE</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L227\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L227</a></p>\n<h2 id=\"g-05-use-assembly-to-reuse-memory-space-when-making-more-than-one-external-call\" style=\"position:relative;\"><a href=\"#g-05-use-assembly-to-reuse-memory-space-when-making-more-than-one-external-call\" aria-label=\"g 05 use assembly to reuse memory space when making more than one external call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Use assembly to reuse memory space when making more than one external call</h2>\n<p><strong>Issue Description</strong> - When making external calls, the solidity compiler has to encode the function signature and arguments in memory. It does not\nclear or reuse memory, so it expands memory each time.</p>\n<p><strong>Proposed Optimization</strong> - Use inline assembly to reuse the same memory space for multiple external calls. Store the function selector and arguments\nwithout expanding memory further.</p>\n<p><strong>Estimated Gas Savings</strong> - Reusing memory can save thousands of gas compared to expanding on each call. The baseline memory expansion per call is 3,000\ngas. With larger arguments or return data, the savings would be even greater.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">See</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">example</span><span class=\"mtk1\"> </span><span class=\"mtk12\">below</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Called</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Solidity</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// cost: 7262</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calledAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Called</span><span class=\"mtk1\"> </span><span class=\"mtk12\">called</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Called</span><span class=\"mtk1\">(</span><span class=\"mtk12\">calledAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">called</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">called</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk7\">3</span><span class=\"mtk1\">, </span><span class=\"mtk7\">4</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">res1</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">res2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// cost: 5281</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calledAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// check that calledAddress has code deployed to it</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">iszero</span><span class=\"mtk1\">(</span><span class=\"mtk11\">extcodesize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">calledAddress</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// first call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">, </span><span class=\"mtk12\">hex</span><span class=\"mtk8\">&quot;771602f7&quot;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x04</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x01</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x24</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x02</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\"> := </span><span class=\"mtk10\">staticcall</span><span class=\"mtk1\">(</span><span class=\"mtk10\">gas</span><span class=\"mtk1\">(), </span><span class=\"mtk10\">calledAddress</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x44</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">iszero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res1</span><span class=\"mtk1\"> := </span><span class=\"mtk10\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// second call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x04</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x03</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x24</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x4</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            success := </span><span class=\"mtk11\">staticcall</span><span class=\"mtk1\">(</span><span class=\"mtk11\">gas</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">calledAddress</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x44</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">iszero</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res2</span><span class=\"mtk1\"> := </span><span class=\"mtk10\">mload</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// add results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">res</span><span class=\"mtk1\"> := </span><span class=\"mtk10\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">res1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">res2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// return data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">mstore</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">, </span><span class=\"mtk12\">res</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x60</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>We save approximately 2,000 gas by using the scratch space to store the function selector and its arguments and also reusing the same memory space for the second call while storing the returned data in the zero slot thus not expanding memory.</p>\n<p>If the arguments of the external function you wish to call is above 64 bytes and if you are making one external call, it wouldnâ€™t save any significant gas writing it in assembly. However, if making more than one call. You can still save gas by reusing the same memory slot for the 2 calls using inline assembly.</p>\n<p><em>Note: Always remember to update the free memory pointer if the offset it points to is already used, to avoid solidity overriding the data stored there or using the value stored there in an unexpected way.</em></p>\n<p>Also note to avoid overwriting the zero slot (<code>0x60</code> memory offset) if you have undefined dynamic memory values within that call stack. An alternative is to explicitly define dynamic memory values or if used, to set the slot back to <code>0x00</code> before exiting the assembly block.</p>\n<p><strong>Code Snippets:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Curve2PoolAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">xTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">xToken</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">xTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">84</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">yToken</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">93</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">lpTokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive_</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">                </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">exchange</span><span class=\"mtk1\">(</span><span class=\"mtk12\">indexOfInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexOfOutputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">168</span><span class=\"mtk1\">            </span><span class=\"mtk12\">rawOutputAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">add_liquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">inputAmounts</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">            </span><span class=\"mtk12\">rawOutputAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurve2Pool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">remove_liquidity_one_coin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexOfOutputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">190</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">191</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L78\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L78</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CurveTricryptoAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">86</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">xTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">xToken</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">xTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">92</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">yToken</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">yTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">99</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">token</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">        </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">lpTokenId</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lpTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">            </span><span class=\"mtk11\">IOceanInteractions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">).</span><span class=\"mtk12\">doInteraction</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">interaction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">138</span><span class=\"mtk1\">            </span><span class=\"mtk11\">IOceanInteractions</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">).</span><span class=\"mtk11\">doInteraction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">interaction</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">            </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk12\">exchange</span><span class=\"mtk1\">{ value: </span><span class=\"mtk12\">inputToken</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">zToken</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\"> : </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> }(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">            </span><span class=\"mtk11\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">inputToken</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">zToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">[</span><span class=\"mtk12\">zToken</span><span class=\"mtk1\">]).</span><span class=\"mtk12\">deposit</span><span class=\"mtk1\">{ </span><span class=\"mtk12\">value:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\"> }();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">            </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">add_liquidity</span><span class=\"mtk1\">(</span><span class=\"mtk12\">inputAmounts</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">                </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wethBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">[</span><span class=\"mtk12\">zToken</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">                </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">remove_liquidity_one_coin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexOfOutputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">                </span><span class=\"mtk11\">IWETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">[</span><span class=\"mtk12\">zToken</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">                    </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">underlying</span><span class=\"mtk1\">[</span><span class=\"mtk12\">zToken</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) - </span><span class=\"mtk12\">wethBalance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">                </span><span class=\"mtk11\">ICurveTricrypto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">).</span><span class=\"mtk11\">remove_liquidity_one_coin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rawInputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">indexOfOutputAmount</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">242</span><span class=\"mtk1\">       </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">243</span><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20Metadata</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">primitive</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L86\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L86</a></p>\n<p>This report discusses how using inline assembly can optimize gas costs when making multiple external calls by reusing memory space, rather than expanding memory separately for each call. This can save thousands of gas compared to the\nsolidity compilerâ€™s default behavior.</p>\n<h2 id=\"g-06-dont-make-variables-public-unless-necessary\" style=\"position:relative;\"><a href=\"#g-06-dont-make-variables-public-unless-necessary\" aria-label=\"g 06 dont make variables public unless necessary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Donâ€™t make variables public unless necessary</h2>\n<p><strong>Issue Description</strong> - Making variables public comes with some overhead costs that can be avoided in many cases. A public variable implicitly creates a public getter function of the same name, increasing the contract size.</p>\n<p><strong>Proposed Optimization</strong> - Only mark variables as public if their values truly need to be readable by external contracts/users. Otherwise, use private\nor internal visibility.</p>\n<p><strong>Estimated Gas Savings</strong> - The savings from avoiding unnecessary public variables are small per transaction, around 5-10 gas. However, this adds up\nover many transactions targeting a contract with public state variables that donâ€™t need to be public.</p>\n<p><strong>Code Snippets:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ocean</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">84</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">WRAPPED_ETHER_ID</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">unwrapFeeDivisor</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L84\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L84</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Curve2PoolAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">56</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">xToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpTokenId</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L56\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L56</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CurveTricryptoAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">xToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">zToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">70</span><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lpTokenId</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L61\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L61</a></p>\n<h2 id=\"g-07-it-is-sometimes-cheaper-to-cache-calldata\" style=\"position:relative;\"><a href=\"#g-07-it-is-sometimes-cheaper-to-cache-calldata\" aria-label=\"g 07 it is sometimes cheaper to cache calldata permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] It is sometimes cheaper to cache calldata</h2>\n<p><strong>Issue Description</strong> - While the <code>calldataload</code> opcode is relatively cheap, directly using it in a loop or multiple times can still result in unnecessary\nbytecode. Caching the loaded calldata first may allow for optimization opportunities.</p>\n<p><strong>Proposed Optimization</strong> - Cache calldata values in a local variable after first load, then reference the local variable instead of repeatedly using\ncalldataload.</p>\n<p><strong>Estimated Gas Savings</strong> - Exact savings vary depending on contract, but caching calldata parameters can save 5-20 gas per usage by avoiding extra <code>calldataload</code> opcodes. Larger functions with many parameter uses see more benefit.</p>\n<p><strong>Code Snippet:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ocean</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">230</span><span class=\"mtk1\">        </span><span class=\"mtk12\">Interaction</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">interactions</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">231</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ids</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">282</span><span class=\"mtk1\">        </span><span class=\"mtk12\">Interaction</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">interactions</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">283</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ids</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">356</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">357</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">446</span><span class=\"mtk1\">        </span><span class=\"mtk12\">Interaction</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">interactions</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">447</span><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ids</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L230-L231\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L230-L231</a></p>\n<h2 id=\"g-08-shorten-arrays-with-inline-assembly\" style=\"position:relative;\"><a href=\"#g-08-shorten-arrays-with-inline-assembly\" aria-label=\"g 08 shorten arrays with inline assembly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] Shorten arrays with inline assembly</h2>\n<p><strong>Issue Description</strong> - When shortening an array in Solidity, it creates a new shorter array and copies the elements over. This wastes gas by duplicating\nstorage.</p>\n<p><strong>Proposed Optimization</strong> - Use inline assembly to shorten the array in place by changing its length slot, avoiding the need to copy elements to a new\narray.</p>\n<p><strong>Estimated Gas Savings</strong> - Shortening a <code>length-n</code> array avoids <code>~n</code> SSTORE operations to copy elements. Benchmarking shows savings of 5000-15000 gas depending on original length.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">shorten</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">array</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newLen</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">sstore</span><span class=\"mtk1\">(</span><span class=\"mtk12\">array_slot</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newLen</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Rather than:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">shorten</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">array</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newLen</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newArray</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">newLen</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">newLen</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">newArray</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">array</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">array</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">array</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newArray</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Using inline assembly allows shortening arrays without copying elements to a new storage slot, providing significant gas savings.</p>\n<p><strong>Code Snippet:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ocean</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">460</span><span class=\"mtk1\">        </span><span class=\"mtk12\">BalanceDelta</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceDeltas</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">BalanceDelta</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">ids</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L460\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L460</a></p>\n<h2 id=\"g-09-use-bytesconcat-instead-of-abiencodepacked-since-this-is-preferred-since-084\" style=\"position:relative;\"><a href=\"#g-09-use-bytesconcat-instead-of-abiencodepacked-since-this-is-preferred-since-084\" aria-label=\"g 09 use bytesconcat instead of abiencodepacked since this is preferred since 084 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Use <code>bytes.concat()</code> instead of <code>abi.encodePacked()</code>, since this is preferred since <code>0.8.4</code></h2>\n<p><strong>Issue Description</strong> - The <code>abi.encodePacked()</code> function is used to concatenate multiple arguments into a byte array prior to <code>0.8.4</code>. However, since <code>0.8.4</code> the <code>bytes.concat()</code> function was introduced which performs the same role but is preferred since it avoids ABI encoding overhead.</p>\n<p><strong>Proposed Optimization</strong> - Replace uses of <code>abi.encodePacked()</code> with <code>bytes.concat()</code> where multiple arguments need to be concatenated into a byte array.</p>\n<p><strong>Estimated Gas Savings</strong> - Using <code>bytes.concat()</code> instead of <code>abi.encodePacked()</code> saves approximately 300-500 gas per concatenation by avoiding ABI encoding.</p>\n<p><strong>Code Snippet:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">OceanAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">109</span><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">)));</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/OceanAdapter.sol#L109\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/OceanAdapter.sol#L109</a></p>\n<h2 id=\"g-10-private-functions-used-once-can-be-inlined\" style=\"position:relative;\"><a href=\"#g-10-private-functions-used-once-can-be-inlined\" aria-label=\"g 10 private functions used once can be inlined permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Private functions used once can be inlined</h2>\n<p><strong>Issue Description</strong> - Private functions that are only used internally in a single caller do not provide any abstraction benefits. The function call overhead is wasted gas in this case.</p>\n<p><strong>Proposed Optimization</strong> - Identify private functions that are only used in a single internal caller, and inline their code directly into the caller\nby copy-pasting the function body. This avoids the unnecessary function call.</p>\n<p><strong>Estimated Gas Savings</strong> - Inlining a private function saves approximately 200-500 gas by removing the function call overhead. This adds up over many\nprivate functions.</p>\n<p><strong>Code Snippets:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">ocean</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Ocean</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">820</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_erc20Wrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">outputToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">864</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_erc20Unwrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">inputToken</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">889</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_erc721Wrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oceanId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">903</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_erc721Unwrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oceanId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">920</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_erc1155Wrap</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">955    </span><span class=\"mtk12\">function</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_erc1155Unwrap</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">978    </span><span class=\"mtk12\">function</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_etherUnwrap</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">1068</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_determineTransferAmount</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L1068\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/ocean/Ocean.sol#L1068</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Curve2PoolAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_determineComputeType</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L201\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/Curve2PoolAdapter.sol#L201</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">adapters</span><span class=\"mtk1\">/</span><span class=\"mtk12\">CurveTricryptoAdapter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">264</span><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_determineComputeType</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L264\">https://github.com/code-423n4/2023-11-shellprotocol/blob/main/src/adapters/CurveTricryptoAdapter.sol#L264</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/274#issuecomment-1858829009\">0xA5DF (judge) commented</a>:</strong></p>\n<blockquote>\n<p>[G-05] - the savings seem to actually be ~450 per instance (when optimization is turned on), and Iâ€™m not sure itâ€™d work for every case there.<br>\n[G-09] -  in bot findings.</p>\n</blockquote>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/274\">here</a>.</em></p>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 13 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/304\">report highlighted below</a> by <strong>Sathish9098</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/219\">Myd</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/332\">0xepley</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/326\">invitedtea</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/311\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/267\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/251\">LinKenji</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/240\">albahaca</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/227\">clara</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/223\">foxb868</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/145\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/102\">alexbabits</a>, and <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/28\">ZanyBonzy</a>.</em></p>\n<h2 id=\"overview-1\" style=\"position:relative;\"><a href=\"#overview-1\" aria-label=\"overview 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h2>\n<p>Shell Protocol is a decentralized finance (DeFi) platform designed to simplify and enhance the DeFi experience for both users and developers</p>\n<p><strong>One-Click Transactions</strong> - Shell Protocol aims to streamline the user experience by offering powerful, one-click transactions. This feature is particularly beneficial for those new to DeFi or those seeking a more efficient and less complex interaction with DeFi services.</p>\n<p><strong>Capital-Efficient Automated Market Makers (AMMs)</strong> - At the heart of Shell Protocol is its set of Automated Market Makers, which are touted for their exceptional capital efficiency. This means that liquidity providers can expect better returns on their assets, and traders can enjoy lower slippage and more stable prices. The AMMs are designed to be robust and flexible, catering to a wide range of financial assets.</p>\n<p><strong>Modular Developer Experience</strong> - Recognizing the diverse needs of DeFi developers, Shell Protocol offers a modular design. This approach allows developers to easily integrate Shellâ€™s features into their projects or to build on top of the platform. The modular design also facilitates customization and scalability, enabling developers to create tailored DeFi solutions.</p>\n<h2 id=\"projects-risk-model\" style=\"position:relative;\"><a href=\"#projects-risk-model\" aria-label=\"projects risk model permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Projectâ€™s risk model</h2>\n<h3 id=\"admin-abuse-risks\" style=\"position:relative;\"><a href=\"#admin-abuse-risks\" aria-label=\"admin abuse risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Admin abuse risks</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">changeUnwrapFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextUnwrapFeeDivisor</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h3 id=\"onlyowner-function-changeunwrapfee\" style=\"position:relative;\"><a href=\"#onlyowner-function-changeunwrapfee\" aria-label=\"onlyowner function changeunwrapfee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>onlyOwner</code> (Function: <code>changeUnwrapFee()</code>):</h3>\n<p>This modifier restricts the execution of the function to the owner of the contract.</p>\n<p><strong>Risk</strong> - If the owner account is compromised, the attacker could manipulate the unwrap fee, potentially causing financial loss to users or destabilizing the protocol. Additionally, even without malicious intent, the owner has significant power to alter contract parameters, which can lead to a lack of trust if changes are made arbitrarily or without community consensus.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">289</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">onlyApprovedForwarder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">userAddress</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3 id=\"onlyapprovedforwarderuseraddress-functions-forwardeddointeraction-and-forwardeddomultipleinteractions\" style=\"position:relative;\"><a href=\"#onlyapprovedforwarderuseraddress-functions-forwardeddointeraction-and-forwardeddomultipleinteractions\" aria-label=\"onlyapprovedforwarderuseraddress functions forwardeddointeraction and forwardeddomultipleinteractions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>onlyApprovedForwarder(userAddress)</code> (Functions: <code>forwardedDoInteraction()</code> and <code>forwardedDoMultipleInteractions()</code>):</h3>\n<p>This modifier likely allows only an approved forwarder address, linked to the <code>userAddress</code>, to execute the function.</p>\n<p><strong>Risk</strong> - The implementation details of how a forwarder is approved are crucial. If the process of approving forwarders is not decentralized or transparent, it can lead to centralization risks where the administrator could favor certain forwarders. Also, if the mechanism for approval is not secure, it might be susceptible to manipulation, allowing unauthorized entities to act as forwarders.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">onlyOcean</span></span></span></code></pre>\n<h3 id=\"onlyocean-functions-computeoutputamount-and-computeinputamount\" style=\"position:relative;\"><a href=\"#onlyocean-functions-computeoutputamount-and-computeinputamount\" aria-label=\"onlyocean functions computeoutputamount and computeinputamount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>onlyOcean</code> (Functions: <code>computeOutputAmount()</code> and <code>computeInputAmount()</code>):</h3>\n<p>This modifier restricts function execution to addresses authorized by the Ocean protocol.</p>\n<p><strong>Risk</strong> - Similar to <code>onlyOwner</code>, this creates a single point of failure. If the Ocean authority is compromised or acts maliciously, they could potentially manipulate these functions for personal gain or disrupt the protocolâ€™s operations. This risk is compounded if the Ocean authority has a broad range of powers over many aspects of the protocol.</p>\n<h3 id=\"mitigation-strategies\" style=\"position:relative;\"><a href=\"#mitigation-strategies\" aria-label=\"mitigation strategies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Strategies</h3>\n<ul>\n<li><strong>Decentralized Governance</strong> - Transitioning from a single owner model to a decentralized governance structure can mitigate risks associated with the <code>onlyOwner</code> modifier. This would involve community members or token holders voting on critical decisions, thus distributing power.</li>\n<li><strong>Transparent Approval Process</strong> - For the <code>onlyApprovedForwarder</code> modifier, ensuring a transparent and secure process for approving forwarders is essential. This might include community oversight or stringent security checks.</li>\n<li><strong>Role Rotation and Multi-Signature Controls</strong> - Implementing multi-signature wallets and regularly rotating the roles responsible for critical functions can reduce risks associated with the <code>onlyOcean</code> modifier. This ensures that no single entity has prolonged, unchecked control.</li>\n</ul>\n<h2 id=\"systemic-risks\" style=\"position:relative;\"><a href=\"#systemic-risks\" aria-label=\"systemic risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Systemic risks</h2>\n<p><strong>Token Wrapping and Unwrapping Risk in Fee Management</strong> - The contract manages fees for wrapping and unwrapping tokens, particularly with ERC-20 and ERC-1155 tokens. Any miscalculation or manipulation in fee management can lead to economic vulnerabilities, affecting user incentives and the protocolâ€™s sustainability.</p>\n<p><strong>Risks in Forwarded Interactions</strong> - The <code>forwardedDoInteraction</code> and <code>forwardedDoMultipleInteractions</code> functions, which use <code>onlyApprovedForwarder</code>, introduce additional risks. If the logic for approving forwarders is flawed or if a forwarder is compromised, it could lead to unauthorized or malicious transactions.</p>\n<p><strong>Risk of Slippage and Price Impact</strong> - The contract checks for slippage limits (<code>SLIPPAGE_LIMIT_EXCEEDED</code>). If the actual output amount of a swap, deposit, or withdrawal is lower than the userâ€™s expected minimum, the transaction is reverted. This mechanism can protect users from high slippage, but if not calibrated correctly, it could also lead to failed transactions during high volatility, impacting the user experience and trust in the protocol.</p>\n<p><strong>ERC20 Token Approval Risks</strong> - The contract grants maximum (<code>type(uint256).max</code>) approval to the ocean and primitive addresses for ERC20 tokens. While this is a common pattern to reduce transaction costs, it also means that if either of these addresses is compromised, it could lead to the loss of user funds.</p>\n<p><strong>Conversion and Rounding Errors</strong> - The contract uses <code>_convertDecimals</code> for normalizing token amounts to the Oceanâ€™s 18-decimal standard. Inaccuracies or rounding errors in these conversions could lead to financial discrepancies, especially for tokens with different decimal standards.</p>\n<h2 id=\"technical-risks\" style=\"position:relative;\"><a href=\"#technical-risks\" aria-label=\"technical risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Technical Risks</h2>\n<p><strong>Complex Token Wrapping/Unwrapping Logic</strong> - The logic for wrapping and unwrapping tokens is intricate, with multiple points of interaction with the contractâ€™s state and external tokens. Bugs or flaws here could lead to incorrect token balances or loss of funds.</p>\n<p><strong>Non-upgradeability Concerns</strong> - The contractâ€™s apparent lack of upgradeability means that addressing any discovered vulnerabilities or design issues could be challenging, posing long-term systemic risks in a rapidly evolving DeFi landscape.</p>\n<p><strong>Gas Usage and Network Load</strong> - The complex operations of the contract may lead to high gas costs, affecting its usability and performance, especially during times of network congestion.</p>\n<p><strong>Complexity in Handling Multiple Token Standards</strong> - The contract interacts with multiple token standards, each with its own set of rules and potential edge cases. This complexity increases the risk of bugs or security vulnerabilities, especially when dealing with the intricacies of each standard, like ERC721 and ERC1155â€™s safe transfer mechanisms.</p>\n<p><strong>Complexity in Compute Type Determination</strong> - The <code>_determineComputeType</code> function determines the action (swap, deposit, withdraw) based on input and output tokens. Incorrect implementation or manipulation of this logic could lead to unintended contract behaviors, affecting liquidity operations and user funds.</p>\n<p><strong>Unanticipated Interactions with Other Protocols</strong> - Given the interconnected nature of DeFi, changes or updates in other protocols that interact with the Curve 2pool could inadvertently affect the adapterâ€™s functionality, leading to systemic risks in the broader ecosystem.</p>\n<p><strong>Dependency on Accurate Token Indexing</strong> - The contract uses <code>indexOf</code> mapping to associate Ocean IDs with their corresponding Curve pool indices. Any incorrect mapping or updates to these indices could result in failed transactions or incorrect swaps, impacting liquidity and user funds.</p>\n<h2 id=\"integration-risks\" style=\"position:relative;\"><a href=\"#integration-risks\" aria-label=\"integration risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Integration risks</h2>\n<h3 id=\"protocol-interoperability\" style=\"position:relative;\"><a href=\"#protocol-interoperability\" aria-label=\"protocol interoperability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Protocol Interoperability</h3>\n<p>Protocol interoperability, especially in the context of the <code>Curve2PoolAdapter</code> and Ocean contracts within the DeFi ecosystem, refers to the ability of these systems to work together seamlessly. Given that DeFi protocols often rely on each otherâ€™s functionalities and data, interoperability is crucial for their collective success and user trust.</p>\n<h3 id=\"technical-aspects-of-protocol-interoperability\" style=\"position:relative;\"><a href=\"#technical-aspects-of-protocol-interoperability\" aria-label=\"technical aspects of protocol interoperability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Technical Aspects of Protocol Interoperability</h3>\n<p><strong>Smart Contract Interface Compatibility:</strong></p>\n<ul>\n<li>The <code>Curve2PoolAdapter</code> and Ocean contracts must adhere to specific interfaces to interact with Curve Financeâ€™s pools and other external protocols.</li>\n<li>These interfaces involve function signatures, return types, and event definitions. Any mismatch in these interfaces can lead to failed transactions or incorrect data interpretation.</li>\n</ul>\n<p><strong>Data Format and Standardization:</strong></p>\n<ul>\n<li>Interacting protocols must agree on data formats, such as the representation of token amounts, addresses, and transaction data.</li>\n<li>For instance, token amounts might need normalization to a standard decimal representation to ensure accurate calculations during swaps or liquidity provisioning.</li>\n</ul>\n<p><strong>Handling Protocol-Specific Logic:</strong></p>\n<ul>\n<li>Curve Finance pools, like the 2pool, have unique mechanics, such as variable fees, slippage calculations, and liquidity dynamics.</li>\n<li>The <code>Curve2PoolAdapter</code> must accurately incorporate these mechanics into its logic to ensure that operations like token swaps or liquidity management reflect the underlying Curve poolâ€™s state.</li>\n<li>\n<p>State Synchronization and Updates:</p>\n<ul>\n<li>The state of one protocol (like liquidity levels in Curve pools) can affect the decisions and operations in another (like optimal routing in the Ocean contract).</li>\n<li>Ensuring real-time or near-real-time synchronization of state information across protocols is vital for maintaining operational accuracy.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"test-suite\" style=\"position:relative;\"><a href=\"#test-suite\" aria-label=\"test suite permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Suite</h2>\n<p>The report highlights a significant discrepancy in test coverage, with certain areas like mock and ocean directories being well-tested, while others like adapters, proteus, and test/fork directories have inadequate testing.</p>\n<p>The lack of testing in key areas such as the adapters and parts of the Proteus directory is a major concern. These untested sections could harbor undetected bugs or vulnerabilities, posing a risk to the protocolâ€™s overall security and functionality.</p>\n<p>The high coverage in certain areas demonstrates a capability for thorough testing, which needs to be extended to the under-tested sections of the codebase.</p>\n<table>\n<thead>\n<tr>\n<th>File</th>\n<th>% Stmts</th>\n<th>% Branch</th>\n<th>% Funcs</th>\n<th>% Lines</th>\n<th>Uncovered Lines</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>adapters\\ </td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>-</td>\n</tr>\n<tr>\n<td>Curve2PoolAdapter.sol</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>â€¦ 213,215,217</td>\n</tr>\n<tr>\n<td>CurveTricryptoAdapter.sol</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>â€¦ 281,285,287</td>\n</tr>\n<tr>\n<td>ICurve2Pool.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>ICurveTricrypto.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>OceanAdapter.sol</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>â€¦ 153,156,157</td>\n</tr>\n<tr>\n<td>forwarder\\ </td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>VestingFractionalizerForwarder.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>mock\\ </td>\n<td>92.16</td>\n<td>70</td>\n<td>90</td>\n<td>95.6</td>\n<td>-</td>\n</tr>\n<tr>\n<td>ConstantSum.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>ERC1155MintsToDeployer.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>ERC20MintsToDeployer.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>ERC721MintsToDeployer.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>Forwarder.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>Interfaces.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>MaliciousPrimitive.sol</td>\n<td>50</td>\n<td>50</td>\n<td>71.43</td>\n<td>75</td>\n<td>59,85</td>\n</tr>\n<tr>\n<td>MockPrimitive.sol</td>\n<td>91.67</td>\n<td>50</td>\n<td>87.5</td>\n<td>95.83</td>\n<td>128</td>\n</tr>\n<tr>\n<td>Receive1155.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>RecursiveMaliciousPrimitive.sol</td>\n<td>92.86</td>\n<td>70</td>\n<td>87.5</td>\n<td>96.55</td>\n<td>139</td>\n</tr>\n<tr>\n<td>ocean\\ </td>\n<td>100</td>\n<td>94.77</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>BalanceDelta.sol</td>\n<td>100</td>\n<td>83.33</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>ERC1155PermitSignatureExtension.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>IOceanFeeChange.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>IOceanPrimitive.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>IOceanToken.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>Interactions.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>Ocean.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>OceanERC1155.sol</td>\n<td>100</td>\n<td>91.3</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>proteus\\ </td>\n<td>58.41</td>\n<td>45</td>\n<td>64.38</td>\n<td>62.83</td>\n<td>-</td>\n</tr>\n<tr>\n<td>EvolvingProteus.sol</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>â€¦ 818,820,823</td>\n</tr>\n<tr>\n<td>ILiquidityPoolImplementation.sol</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>LiquidityPool.sol</td>\n<td>100</td>\n<td>93.33</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>LiquidityPoolProxy.sol</td>\n<td>100</td>\n<td>69.44</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>Proteus.sol</td>\n<td>95.58</td>\n<td>57.84</td>\n<td>95.45</td>\n<td>85.55</td>\n<td>â€¦ 691,695,697</td>\n</tr>\n<tr>\n<td>Slices.sol</td>\n<td>100</td>\n<td>50</td>\n<td>100</td>\n<td>100</td>\n<td>-</td>\n</tr>\n<tr>\n<td>script\\ </td>\n<td>0</td>\n<td>100</td>\n<td>0</td>\n<td>0</td>\n<td>-</td>\n</tr>\n<tr>\n<td>DeployCurve2PoolAdapter.s.sol</td>\n<td>0</td>\n<td>100</td>\n<td>0</td>\n<td>0</td>\n<td>13,15,16</td>\n</tr>\n<tr>\n<td>DeployCurveTricryptoAdapter.s.sol</td>\n<td>0</td>\n<td>100</td>\n<td>0</td>\n<td>0</td>\n<td>13,15,16</td>\n</tr>\n<tr>\n<td>DeployOcean.s.sol</td>\n<td>0</td>\n<td>100</td>\n<td>0</td>\n<td>0</td>\n<td>13,15,16</td>\n</tr>\n<tr>\n<td>test\\fork\\ </td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>-</td>\n</tr>\n<tr>\n<td>TestCurve2PoolAdapter.t.sol</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>â€¦ 225,226,227</td>\n</tr>\n<tr>\n<td>TestCurveTricryptoAdapter.t.sol</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>0</td>\n<td>â€¦ 429,430,431</td>\n</tr>\n<tr>\n<td><strong>All files</strong></td>\n<td>54.76</td>\n<td>51.9</td>\n<td>68.02</td>\n<td>56.39</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"recommendations\" style=\"position:relative;\"><a href=\"#recommendations\" aria-label=\"recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendations</h3>\n<ul>\n<li>Prioritize increasing test coverage in the adapters and proteus directories.</li>\n<li>Review and enhance the tests in the test/fork directory to ensure they are effectively assessing the code.</li>\n<li>Maintain the high level of testing in areas where coverage is already strong, ensuring ongoing robustness and reliability.</li>\n</ul>\n<h2 id=\"architecture-assessment-of-business-logic\" style=\"position:relative;\"><a href=\"#architecture-assessment-of-business-logic\" aria-label=\"architecture assessment of business logic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture assessment of business logic</h2>\n<p>The Ocean contract, as provided, is a comprehensive Solidity contract designed for DeFi applications, primarily focusing on the management and interaction of various token standards</p>\n<p><em>Note: For the provided diagram image, please see the original submission <a href=\"https://github.com/code-423n4/2023-11-shellprotocol-findings/issues/304\">here</a>.</em></p>\n<h3 id=\"core-functionalities\" style=\"position:relative;\"><a href=\"#core-functionalities\" aria-label=\"core functionalities permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Core Functionalities</h3>\n<p><strong>Token Handling</strong> - The contract supports interactions with multiple token types including ERC-20, ERC-721, and ERC-1155. It provides functionalities for wrapping and unwrapping these tokens. Wrapping converts tokens into a standard format within the contract, while unwrapping allows users to extract their original tokens.</p>\n<p><strong>DeFi Interaction Execution</strong> - Functions like <code>doInteraction</code> and <code>doMultipleInteractions</code> allow the contract to process both individual and batch interactions. These interactions involve executing calls to external contracts and updating the contractâ€™s state (like minting and burning tokens) based on these interactions.</p>\n<p><strong>Fee Management for Unwrapping</strong> - The contract includes a mechanism to handle fees, particularly for unwrapping tokens. This is managed through the <code>unwrapFeeDivisor</code>, which calculates the fee for unwrapping operations.</p>\n<p><strong>Design and Structure</strong> - The contract inherits from OceanERC1155 and implements interfaces such as <code>IOceanInteractions</code>, <code>IOceanFeeChange</code>, <code>IERC721Receiver</code>, and <code>IERC1155Receiver</code>. This indicates a modular design approach and compliance with ERC standards. It uses OpenZeppelin contracts for standard functionalities related to ERC token interfaces, indicating a reliance on established and tested implementations.</p>\n<p><strong>Security Mechanisms</strong> - The contract appears to incorporate reentrancy guards, as indicated by the use of constants like <code>NOT_INTERACTION</code> and <code>INTERACTION</code> and related state variables. It includes access control mechanisms, though the specific implementation details are not fully provided in the snippet.</p>\n<p><strong>Events and Modifiers</strong> - Several events are declared, which are crucial for logging and tracking transactions within the contract. Custom modifiers, like <code>onlyApprovedForwarder</code>, are used for controlling access to certain functions.</p>\n<h2 id=\"software-engineering-considerations\" style=\"position:relative;\"><a href=\"#software-engineering-considerations\" aria-label=\"software engineering considerations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Software engineering considerations</h2>\n<p><strong>Modularity and Reusability</strong> - The contract exhibits modularity by inheriting from several interfaces and contracts, suggesting components are designed for reuse and extension. This approach aligns with solid software engineering principles, promoting maintainability and scalability.</p>\n<p><strong>Design Patterns and Best Practices</strong> - Utilization of established design patterns, such as interface-based programming and reentrancy guards, indicates adherence to industry best practices. These patterns enhance the contractâ€™s robustness and security.</p>\n<p><strong>Code Readability and Maintainability</strong> - The contractâ€™s structure, naming conventions, and comments suggest an emphasis on readability and maintainability, crucial for long-term management and updates.</p>\n<p><strong>Security</strong> - Security is a critical aspect, especially given the DeFi context. The contract shows awareness of common vulnerabilities (like reentrancy attacks) and includes mechanisms to mitigate them. Continuous security audits and reviews are essential due to the evolving nature of smart contract exploits.</p>\n<p><strong>Efficiency and Optimization</strong> - Functions like <code>doMultipleInteractions</code> suggest a focus on optimizing transactions, likely to reduce gas costs. However, given the contractâ€™s complexity, thereâ€™s a need for thorough analysis and testing to ensure efficiency, especially in gas usage.</p>\n<p><strong>Error Handling and Input Validation</strong> - The use of custom error messages and checks indicates a proactive approach to error handling and input validation, critical for robustness and user trust.</p>\n<p><strong>Interoperability and Standards Compliance</strong> - Compliance with ERC standards and the ability to interact with multiple token types demonstrate a high level of interoperability, a significant factor in the Ethereum ecosystem.</p>\n<p><strong>Testing and Documentation</strong> - Given the complexity, comprehensive testing (unit tests, integration tests) and detailed documentation are vital for ensuring the contract works as intended and to facilitate future development.</p>\n<p><strong>Upgradeability</strong> - The potential for future upgrades and modifications should be considered, especially in a rapidly evolving domain like DeFi. However, the contract doesnâ€™t explicitly mention upgrade mechanisms.</p>\n<p><strong>Dependency Management</strong> - Reliance on external libraries like OpenZeppelin means the contractâ€™s security and functionality are partly dependent on these external components. Keeping these dependencies updated and secure is crucial.</p>\n<h3 id=\"time-spent\" style=\"position:relative;\"><a href=\"#time-spent\" aria-label=\"time spent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent</h3>\n<p>20 hours</p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#01-2-address-tokens-will-not-work-properly-on-the-ocean-erc1155-ledger\">01 2 address tokens will not work properly on the Ocean ERC1155 Ledger.</a></li>\n<li><a href=\"#02-interactions-is-susceptible-to-read-only-reentrancy\">02 Interactions is susceptible to read-only reentrancy</a></li>\n<li><a href=\"#03-user-can-escape-fees-on-erc1155-tokens\">03 User can escape fees on ERC1155 tokens</a></li>\n<li><a href=\"#04-airdrops-will-be-locked-in-the-contract\">04 Airdrops will be locked in the contract</a></li>\n<li><a href=\"#05-natspec-on-oceanadapter_convertdecimals-should-be-revised\">05 NATSPEC on <code>OceanAdapter._convertDecimals</code> should be revised</a></li>\n<li><a href=\"#06-minimumoutputamount-in-curveadaptor-can-be-integrated-into-the-curve-functionalities\">06 <code>minimumOutputAmount</code> in CurveAdaptor can be integrated into the curve functionalities</a></li>\n<li><a href=\"#07-comments-on-erc20wrap-are-misleading\">07 Comments on ERC20Wrap are misleading</a></li>\n<li><a href=\"#08-extreme-edge-case-error-results-in-user-paying-more-fees-than-usual-when-user-decides-to-mint-little-shtokens-with-low-decimals-tokens\">[08] Extreme edge case error results in user paying more fees than usual when user decides to mint little shTokens with low decimals tokens</a></li>\n<li><a href=\"#09-owner-has-to-perpetually-pay-fees-to-withdraw-fees-resulting-in-dust-amount-left-in-the-contract\">[09] Owner has to perpetually pay fees to withdraw fees, resulting in dust amount left in the contract</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-avoid-contract-existence-checks-by-using-low-level-calls\">G-01 Avoid contract existence checks by using low level calls</a></li>\n<li><a href=\"#g-02-add-unchecked--for-subtractions-where-the-operands-cant-underflow-because-of-previous-checks\">G-02 Add unchecked <code>{}</code> for subtractions where the operands canâ€™t underflow because of previous checks</a></li>\n<li><a href=\"#g-03-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G-03 State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g-04-using-assembly-to-revert-with-an-error-message\">G-04 Using assembly to revert with an error message</a></li>\n<li><a href=\"#g-05-use-assembly-to-reuse-memory-space-when-making-more-than-one-external-call\">G-05 Use assembly to reuse memory space when making more than one external call</a></li>\n<li><a href=\"#g-06-dont-make-variables-public-unless-necessary\">G-06 Donâ€™t make variables public unless necessary</a></li>\n<li><a href=\"#g-07-it-is-sometimes-cheaper-to-cache-calldata\">G-07 It is sometimes cheaper to cache calldata</a></li>\n<li><a href=\"#g-08-shorten-arrays-with-inline-assembly\">G-08 Shorten arrays with inline assembly</a></li>\n<li><a href=\"#g-09-use-bytesconcat-instead-of-abiencodepacked-since-this-is-preferred-since-084\">G-09 Use <code>bytes.concat()</code> instead of <code>abi.encodePacked()</code>, since this is preferred since <code>0.8.4</code></a></li>\n<li><a href=\"#g-10-private-functions-used-once-can-be-inlined\">G-10 Private functions used once can be inlined</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#audit-analysis\">Audit Analysis</a></p>\n<ul>\n<li><a href=\"#overview-1\">Overview</a></li>\n<li><a href=\"#projects-risk-model\">Projectâ€™s risk model</a></li>\n<li><a href=\"#systemic-risks\">Systemic risks</a></li>\n<li><a href=\"#technical-risks\">Technical Risks</a></li>\n<li><a href=\"#integration-risks\">Integration risks</a></li>\n<li><a href=\"#test-suite\">Test Suite</a></li>\n<li><a href=\"#architecture-assessment-of-business-logic\">Architecture assessment of business logic</a></li>\n<li><a href=\"#software-engineering-considerations\">Software engineering considerations</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}