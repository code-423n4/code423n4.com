{
  "circa": {
    "title": "Kuiper contest",
    "sponsor": "Kuiper",
    "slug": "2021-09-defiprotocol",
    "date": "2022-01-26",
    "findings": "https://github.com/code-423n4/2021-09-defiprotocol-findings/issues",
    "contest": 36
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of the Kuiper contest smart contract system written in Solidity. The code contest took place between September 16—September 22 2021.</p>\n<p><em>Note: this audit contest originally ran under the name <code>defiProtocol</code>.</em></p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>30 Wardens contributed reports to the Kuiper contest:</p>\n<ol>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/KenzoAgada\">kenzo</a></li>\n<li><a href=\"https://twitter.com/0xRajeev\">0xRajeev</a></li>\n<li><a href=\"https://twitter.com/itsmeSTYJ\">itsmeSTYJ</a></li>\n<li>goatbug</li>\n<li><a href=\"https://twitter.com/jonah1005w\">jonah1005</a></li>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li><a href=\"https://github.com/0xsanson\">0xsanson</a></li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/_hrkrshnn\">hrkrshnn</a></li>\n<li><a href=\"https://twitter.com/MukeshJ_eth\">JMukesh</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/hack3r_0m\">hack3r-0m</a></li>\n<li><a href=\"https://twitter.com/joey__santoro\">joeysantoro</a></li>\n<li><a href=\"http://twitter.com/_nikitastupin\">nikitastupin</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/jah_s3\">jah</a></li>\n<li><a href=\"https://github.com/bernard-wagner\">bw</a></li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li>aga7hokakological</li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n<li><a href=\"https://twitter.com/0xalpharush\">0xalpharush</a></li>\n<li><a href=\"https://twitter.com/JohnSterlacci\">johnsterlacci</a></li>\n<li><a href=\"https://twitter.com/loop_225\">loop</a></li>\n<li><a href=\"https://twitter.com/transmissions11\">t11s</a></li>\n<li><a href=\"https://github.com/chasemartin01\">chasemartin01</a></li>\n<li><a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a> </li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>. The judge also competed in the contest as a warden, but forfeited their winnings.</p>\n<!-- ❗️Note that the above line is draft only - would love a second set of eyes on it. -->\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a> and <a href=\"https://twitter.com/CloudEllie1\">CloudEllie</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 71 unique vulnerabilities and 156 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity, 23 received a risk rating in the category of MEDIUM severity, and 45 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 39 non-critical recommendations and 46 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-09-defiProtocol\">C4 Kuiper contest repository</a>, and is composed of 11 smart contracts written in the Solidity programming language and includes 528 lines of Solidity code and 460 lines of JavaScript.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-3\" style=\"position:relative;\"><a href=\"#high-risk-findings-3\" aria-label=\"high risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (3)</h1>\n<h2 id=\"h-01-re-entrancy-in-settleauction-allow-stealing-all-funds\" style=\"position:relative;\"><a href=\"#h-01-re-entrancy-in-settleauction-allow-stealing-all-funds\" aria-label=\"h 01 re entrancy in settleauction allow stealing all funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/223\">[H-01] Re-entrancy in <code>settleAuction</code> allow stealing all funds</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>Note that the <code>Basket</code> contract approved the <code>Auction</code> contract with all tokens and the <code>settleAuction</code> function allows the auction bonder to transfer all funds out of the basket to themselves.\nThe only limiting factor is the check afterwards that needs to be abided by. It checks if enough tokens are still in the basket after settlement:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// this is the safety check if basket still has all the tokens after removing arbitrary amounts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensNeeded</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">basketAsERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] * </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pendingTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">tokensNeeded</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The bonder can pass in any <code>inputTokens</code>, even malicious ones they created.\nThis allows them to re-enter the <code>settleAuction</code> multiple times for the same auction.</p>\n<p>Calling this function at the correct time (such that <code>bondTimestamp - auctionStart</code> makes <code>newRatio &#x3C; basket.ibRatio()</code>), the attacker can drain more funds each time, eventually draining the entire basket.</p>\n<h4 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h4>\n<p>Assume that the current <code>basket.ibRatio</code> is <code>1e18</code> (the initial value).\nThe basket publisher calls <code>basket.publishNewIndex</code> with some tokens and weights.\nFor simplicity, assume that the pending <code>tokens</code> are the same as tokens as before, only the weights are different, i.e., this would just rebalance the portfolio.\nThe function call then starts the auction.</p>\n<p>The important step to note is that the <code>tokensNeeded</code> value in <code>settleAuction</code> determines how many tokens need to stay in the <code>basket</code>.\nIf we can continuously lower this value, we can keep removing tokens from the <code>basket</code> until it is empty.</p>\n<p>The <code>tokensNeeded</code> variable is computed as <code>basketAsERC20.totalSupply() * pendingWeights[i] * newRatio / BASE / BASE</code>.\nThe only variable that changes in the computation when re-entering the function is <code>newRatio</code> (no basket tokens are burned, and the pending weights are never cleared).</p>\n<p>Thus if we can show that <code>newRatio</code> decreases on each re-entrant call, we can move out more and more funds each time.</p>\n<h6 id=\"newratio-decreases-on-each-call\" style=\"position:relative;\"><a href=\"#newratio-decreases-on-each-call\" aria-label=\"newratio decreases on each call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>newRatio decreases on each call</h6>\n<p>After some time, the attacker calls <code>bondForRebalance</code>. This determines the <code>bondTimestamp - auctionStart</code> value in <code>settleAuction</code>.\nThe attack is possible as soon as <code>newRatio &#x3C; basket.ibRatio()</code>.\nFor example, using the standard parameters the calculation would be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// a = 2 * ibRatio</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// b = (bondTimestamp - auctionStart) * 1e14</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondTimestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// newRatio = a - b = 2 * ibRatio - (bondTimestamp - auctionStart) * 1e14</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>With our initial assumption of <code>ibRatio = 1e18</code> and calling <code>bondForRebalance</code> after 11,000 seconds (~3 hours) we will get our result that <code>newRatio</code> is less than the initial <code>ibRatio</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">newRatio = a - b = </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> - (</span><span class=\"mtk7\">11000</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">1e14</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2e18</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1.1e18</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0.9e18</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> = basket.ibRatio</span></span></span></code></pre>\n<blockquote>\n<p>This seems to be a reasonable value (when the pending tokens and weights are equal in value to the previous ones) as no other bonder would want to call this earlier such when <code>newRatio > basket.ibRatio</code> as they would put in more total value in tokens as they can take out of the basket.</p>\n</blockquote>\n<h6 id=\"re-enter-on-settleauction\" style=\"position:relative;\"><a href=\"#re-enter-on-settleauction\" aria-label=\"re enter on settleauction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>re-enter on settleAuction</h6>\n<p>The attacker creates a custom token <code>attackerToken</code> that re-enters the <code>Auction.settleAuction</code> function on <code>transferFrom</code> with parameters we will specify.</p>\n<p>They call <code>settleAuction</code> with <code>inputTokens = [attackerToken]</code> to re-enter several times.</p>\n<p>In the inner-most call where <code>newRatio = 0.9e18</code>, they choose the <code>inputTokens</code>/<code>outputTokens</code> parameters in a way to pass the initial <code>require(IERC20(pendingTokens[i]).balanceOf(address(basket)) >= tokensNeeded);</code> check - transferring out any other tokens of <code>basket</code> with <code>outputTokens</code>.</p>\n<p>The function will continue to run and call <code>basket.setNewWeights();</code> and <code>basket.updateIBRatio(newRatio);</code> which will set the new weights (but not clear the pending ones) and set the new <code>basket.ibRatio</code>.</p>\n<p>Execution then jumps to the 2nd inner call after the <code>IERC20(inputTokens[i]=attackerToken).safeTransferFrom(...)</code> and has the chance to transfer out tokens again.\nIt will compute <code>newRatio</code> with the new lowered <code>basket.ibRatio</code> of <code>0.9e18</code>: <code>newRatio = a - b = 2 * 0.9e18 - 1.1e18 = 0.7e18</code>.\nTherefore, <code>tokensNeeded</code> is lowered as well and the attacker was allowed to transfer out more tokens having carefully chosen <code>outputWeights</code>.</p>\n<p>This repeats with <code>newRatio = 0.3</code>.</p>\n<p>The attack is quite complicated and requires carefully precomputing and then setting the parameters, as well as sending back the <code>bondAmount</code> tokens to the <code>auction</code> contract which are then each time transferred back in the function body.\nBut I believe this should work.</p>\n<h4 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The basket funds can be stolen.</p>\n<h4 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add re-entrancy checks (for example, OpenZeppelin’s “locks”) to the <code>settleAuction</code> function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/223\">frank-beard (Kuiper) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/223#issuecomment-997410663\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Let’s dissect the finding to prove whether it’s valid or not.</p>\n<p>First of all, we do have the pre-conditions for re-entrancy:</p>\n<ul>\n<li>Allows any token as input (untrusted input)</li>\n<li>No re-entrancy modifier</li>\n<li>Checks are performed at the beginning, transfers in the middle, and state changes at the end (violation of <code>check effect interaction</code> pattern)</li>\n</ul>\n<p>So in any case this is a report for reEntrancy (medium severity)</p>\n<p>However, the warden is showing a specific attack vector that, if proven, allows to steal the majority of funds from the basket.</p>\n<p>Let’s investigate (with a single re-entrant call example):</p>\n<p>The require checks at the top pass, as we’re rebalancing the basket, we’ll make sure to use an additional inputToken (malicious token), that will call <code>settleAuction</code> again.</p>\n<p>This second call (Call B), will execute as normal, extracting the correct amount of value in return for rebalancing, the new ibRatio is 0.9 as shown by the warden POC.</p>\n<p>Call B ends by setting ibRatio to 0.9, and <code>hasBonded</code> to false (which will cause a revert if you try to perform this without re-entrancy)</p>\n<p>However, we have already entered and Call A can resume, it now has ibRatio set to 0.9 which allows it to further extract value (as <code>tokensNeeded</code> decreases as ibRatio decreases)</p>\n<p>This can be extended to have further re-entrant calls and can be effectively executed until the basket is hollowed out</p>\n<p>This is a Miro Board to highlight the dynamics of the exploit: <a href=\"https://miro.com/app/board/uXjVOZk4gxw=/?invite_link_id=246345621880\">https://miro.com/app/board/uXjVOZk4gxw=/?invite_link_id=246345621880</a></p>\n<p>Huge props to the warden, brilliant find!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/223#issuecomment-997411166\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>For mitigation:</p>\n<ul>\n<li>Adding a re-entrancy check would be the place to start</li>\n<li>Requiring the list of input tokens to match the output can also be useful to avoid any other shenanigans</li>\n<li>Setting the time difference (<code>bondTimestamp</code>, <code>auctionStart</code>) to be 0 would also negate the ability to further manipulate the <code>ibRatio</code></li>\n</ul>\n</blockquote>\n<h2 id=\"h-02-basketsolauctionburn-a-failed-auction-will-freeze-part-of-the-funds\" style=\"position:relative;\"><a href=\"#h-02-basketsolauctionburn-a-failed-auction-will-freeze-part-of-the-funds\" aria-label=\"h 02 basketsolauctionburn a failed auction will freeze part of the funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/134\">[H-02] <code>Basket.sol#auctionBurn()</code> A failed auction will freeze part of the funds</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L102-L108\">https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L102-L108</a></p>\n<p>Given the <code>auctionBurn()</code> function will <code>_burn()</code> the auction bond without updating the <code>ibRatio</code>. Once the bond of a failed auction is burned, the proportional underlying tokens won’t be able to be withdrawn, in other words, being frozen in the contract.</p>\n<h4 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>With the configuration of:</p>\n<p>basket.ibRatio = 1e18\nfactory.bondPercentDiv = 400\nbasket.totalSupply = 400\nbasket.tokens = [BTC, ETH]\nbasket.weights = [1, 1]</p>\n<ol>\n<li>Create an auction;</li>\n<li>Bond with 1 BASKET TOKEN;</li>\n<li>Wait for 24 hrs and call <code>auctionBurn()</code>;</li>\n</ol>\n<p><code>basket.ibRatio</code> remains to be 1e18; basket.totalSupply = 399.</p>\n<p>Burn 1 BASKET TOKEN will only get back 1 BTC and 1 ETH, which means, there are 1 BTC and 1 ETH frozen in the contract.</p>\n<h4 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">auctionBurn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">onlyAuction</span><span class=\"mtk1\"> </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">handleFees</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newIbRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ibRatio</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ibRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newIbRatio</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewIBRatio</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newIbRatio</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Burned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/134\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/134#issuecomment-997303460\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has identified a way for funds to be stuck without a way to recoup them, this is because <code>ibRatio</code> is not updated, while <code>totalSupply</code> is.</p>\n<p>Because this is a specific accounting error, which is effectively a bug in the logic of the protocol, and funds can be irrevocably lost, this is a high severity finding</p>\n</blockquote>\n<h2 id=\"h-03-reentrancy-in-settleauction-malicious-publisher-can-bypass-index-timelock-mechanism-inject-malicious-index-and-rug-the-basket\" style=\"position:relative;\"><a href=\"#h-03-reentrancy-in-settleauction-malicious-publisher-can-bypass-index-timelock-mechanism-inject-malicious-index-and-rug-the-basket\" aria-label=\"h 03 reentrancy in settleauction malicious publisher can bypass index timelock mechanism inject malicious index and rug the basket permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/31\">[H-03] Reentrancy in settleAuction(): malicious publisher can bypass index timelock mechanism, inject malicious index, and rug the basket</a></h2>\n<p><em>Submitted by kenzo, also found by itsmeSTYJ and jonah1005</em></p>\n<p>The <code>settleAuction()</code> function calls <code>withdrawBounty()</code> before setting <code>auctionOngoing = false</code>, thereby allowing reentrancy.</p>\n<h4 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>A malicious publisher can bypass the index timelock mechanism and publish new index which the basket’s users won’t have time to respond to.\nAt worst case, this means setting weights that allow the publisher to withdraw all the basket’s underlying funds for himself, under the guise of a valid new index.</p>\n<h4 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ol>\n<li>\n<p>The publisher (a contract) will propose new valid index and bond the auction.</p>\n<p>To settle the auction, the publisher will execute the following steps in the same transaction:</p>\n</li>\n<li>Add a bounty of an ERC20 contract with a malicious <code>transfer()</code> function.</li>\n<li>Settle the valid new weights correctly (using <code>settleAuction()</code> with the correct parameters, and passing the malicious bounty id).</li>\n<li><code>settleAuction()</code> will call <code>withdrawBounty()</code> which upon transfer will call the publisher’s malicious ERC20 contract.</li>\n<li>The contract will call <code>settleAuction()</code> again, with empty parameters. Since the previous call’s effects have already set all the requirements to be met, <code>settleAuction()</code> will finish correctly and call <code>setNewWeights()</code> which will set the new valid weights and set <code>pendingWeights.pending = false</code>.</li>\n<li>Still inside the malicious ERC20 contract transfer function, the attacker will now call the basket’s <code>publishNewIndex()</code>, with weights that will transfer all the funds to him upon his burning of shares. This call will succeed to set new pending weights as the previous step set <code>pendingWeights.pending = false</code>.</li>\n<li>Now the malicious <code>withdrawBounty()</code> has ended, and the original <code>settleAuction()</code> is resuming, but now with malicious weights in <code>pendingWeights</code> (set in step 6). <code>settleAuction()</code> will now call <code>setNewWeights()</code> which will set the basket’s weights to be the malicious pending weights.</li>\n<li>Now <code>settleAuction</code> has finished, and the publisher (within the same transaction) will <code>burn()</code> all his shares of the basket, thereby transferring all the tokens to himself.</li>\n</ol>\n<p>POC exploit:\nPassword to both files: “exploit”.\nAttackPublisher.sol , to be put under contracts/contracts/Exploit: <a href=\"https://pastebin.com/efHZjstS\">https://pastebin.com/efHZjstS</a>\nExploitPublisher.test.js , to be put under contracts/test: <a href=\"https://pastebin.com/knBtcWkk\">https://pastebin.com/knBtcWkk</a></p>\n<h4 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual analysis, hardhat.</p>\n<h4 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>In <code>settleAuction()</code>, move <code>basketAsERC20.transfer()</code> and <code>withdrawBounty()</code> to the end of the function, conforming with Checks Effects Interactions pattern.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/31\">frank-beard (defiProtocol) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/31#issuecomment-997413099\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is a re-entrancy finding.</p>\n<p>There is no denying that the code is vulnerable to re-entrancy</p>\n<p>The warden identified the way to exploit re-entrancy by using a malicious bounty token.</p>\n<p>I think the finding is valid and the warden has shown how to run re-entrnacy.</p>\n<p>That said the POC the warden shows requires calling <code>publishNewIndex</code> which is a <code>onlyPublisher</code> function.\nThis exploit would be contingent on the publisher rugging the basket.</p>\n<p>The code is:</p>\n<ul>\n<li>Vulnerable to re-entancy</li>\n<li>The warden showed how to trigger it</li>\n</ul>\n<p>Despite the fact that the POC is flawed, I believe this finding highlights a different vector for re-entrancy (bounty token transfers) as such I agree with a high severity</p>\n</blockquote>\n<h1 id=\"medium-risk-findings-23\" style=\"position:relative;\"><a href=\"#medium-risk-findings-23\" aria-label=\"medium risk findings 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (23)</h1>\n<h2 id=\"m-01-use-safetransfer-instead-of-transfer\" style=\"position:relative;\"><a href=\"#m-01-use-safetransfer-instead-of-transfer\" aria-label=\"m 01 use safetransfer instead of transfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/196\">[M-01] Use safeTransfer instead of transfer</a></h2>\n<p><em>Submitted by hack3r-0m, also found by itsmeSTYJ, JMukesh, leastwood, and shenwilly</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L146\">https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L146</a></p>\n<p><code>transfer()</code> might return false instead of reverting, in this case, ignoring return value leads to considering it successful.</p>\n<p>use <code>safeTransfer()</code> or check the return value if length of returned data is > 0.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/196\">frank-beard (Kuiper) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/196#issuecomment-983125327\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with finding, agree with severity given the specific example given as the funds would be stuck in the contract</p>\n</blockquote>\n<h2 id=\"m-02-fee-on-transfer-tokens-can-lead-to-incorrect-approval\" style=\"position:relative;\"><a href=\"#m-02-fee-on-transfer-tokens-can-lead-to-incorrect-approval\" aria-label=\"m 02 fee on transfer tokens can lead to incorrect approval permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/236\">[M-02] Fee on transfer tokens can lead to incorrect approval</a></h2>\n<p><em>Submitted by hrkrshnn, also found by itsmeSTYJ</em></p>\n<h4 id=\"fee-on-transfer-tokens-can-lead-to-incorrect-approval\" style=\"position:relative;\"><a href=\"#fee-on-transfer-tokens-can-lead-to-incorrect-approval\" aria-label=\"fee on transfer tokens can lead to incorrect approval permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fee on transfer tokens can lead to incorrect approval</h4>\n<p>The\n<a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Factory.sol#L106\">createBasket</a>\nfunction does not account for tokens with fee on transfer.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">createBasket</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">idNumber</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">IBasket</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">bProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">weights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">bProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">weights</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBasket</span><span class=\"mtk1\">), </span><span class=\"mtk12\">bProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">weights</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The function <code>safeTransferFrom</code> may not transfer exactly\n<code>bProposal.weights[i]</code> amount of tokens, for tokens with a fee on\ntransfer. This means that the <code>safeApprove</code> call in the next line would\nbe approving more tokens than what was received, leading to accounting\nissues.</p>\n<h5 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h5>\n<p>It is recommended to find the balance of the current contract before and\nafter the <code>transferFrom</code> to see how much tokens were received, and\napprove only what was received.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/236#issuecomment-946911439\">frank-beard (Kuiper) confirmed</a>:</strong></p>\n<blockquote>\n<p>the protocol for now is only expected to work with defi safe, standard erc-20 tokens. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/236#issuecomment-984191431\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This finding is similar to #206 , but in contrast to it, it shows a specific way to brick / grief the protocol, as per the docs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</span></span></code></pre>\n<p>This is an hypothetical attack with stated assumptions</p>\n<p>Will not mark as duplicate and will consider this as a valid finding as it shows a specific vulnerability when paired with <code>feeOnTransfer</code> tokens</p>\n<p>Mitigation can be as simple as never using <code>feeOnTransfer</code> tokens</p>\n</blockquote>\n<h2 id=\"m-03-onlyowner-role-can-unintentionally-influence-settleauction\" style=\"position:relative;\"><a href=\"#m-03-onlyowner-role-can-unintentionally-influence-settleauction\" aria-label=\"m 03 onlyowner role can unintentionally influence settleauction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/192\">[M-03] <code>onlyOwner</code> Role Can Unintentionally Influence <code>settleAuction()</code></a></h2>\n<p><em>Submitted by leastwood</em></p>\n<h4 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>onlyOwner</code> role is able to make changes to the protocol with an immediate affect, while other changes made in <code>Basket.sol</code> and <code>Auction.sol</code> incur a one day timelock. As a result, an <code>onlyOwner</code> role may unintentionally frontrun a <code>settleAuction()</code> transaction by making changes to <code>auctionDecrement</code> and <code>auctionMultiplier</code>, potentially causing the auction bonder to over compensate during a rebalance. Additionally, there is no way for an auction bonder to recover their tokens in the event this does happen.</p>\n<h4 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Factory.sol#L39-L59\">https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Factory.sol#L39-L59</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L99\">https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L99</a></li>\n</ul>\n<h4 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual code review</p>\n<h4 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider adding a timelock delay to all functions affecting protocol execution. Alternatively, <code>bondForRebalance()</code> can set state variables for any external calls made to <code>Factory.sol</code> (i.e. <code>factory.auctionMultiplier()</code> and <code>factory.auctionDecrement()</code>), ensuring that <code>settleAuction()</code> is called according to these expected results.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/192#issuecomment-931571215\">frank-beard (Kuiper) acknowledged</a>:</strong></p>\n<blockquote>\n<p>it is assumed the owner is trustworthy in this version of the protocol, however we will add mitigations and further decentralization in future updates</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/192#issuecomment-997205975\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, users are taking “owner privileges” risks while interacting with the protocol.\nThe warden has identified a specific grief / DOS that the owner can cause</p>\n</blockquote>\n<h2 id=\"m-04-user-can-mint-miniscule-amount-of-shares-later-withdraw-miniscule-more-than-deposited\" style=\"position:relative;\"><a href=\"#m-04-user-can-mint-miniscule-amount-of-shares-later-withdraw-miniscule-more-than-deposited\" aria-label=\"m 04 user can mint miniscule amount of shares later withdraw miniscule more than deposited permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/81\">[M-04] User can mint miniscule amount of shares, later withdraw miniscule more than deposited</a></h2>\n<p><em>Submitted by kenzo</em></p>\n<p>If a user is minting small amount of shares (like 1 - amount depends on baskets weights), the calculated amount of tokens to pull from the user can be less than 1, and therefore no tokens will be pulled. However the shares would still be minted.\nIf the user does this a few times, he could then withdraw the total minted shares and end up with more tokens than he started with - although a miniscule amount.</p>\n<h4 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>User can end up with more tokens than he started with. However, I didn’t find a way for the user to get an amount to make this a feasible attack. He gets dust. However he can still get more than he deserves. If for some reason the basket weights grow in a substantial amount, this could give the user more tokens that he didn’t pay for.</p>\n<h4 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Add the following test to <code>Basket.test.js</code>.\nThe user starts with 5e18 UNI, 1e18 COMP, 1e18 AAVE,\nand ends with 5e18+4, 1e18+4, 1e18+4.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;should give to user more than he deserves&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk12\">UNI_WEIGHT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">COMP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk12\">COMP_WEIGHT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk12\">AAVE_WEIGHT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk12\">UNI_WEIGHT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">COMP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk12\">COMP_WEIGHT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk12\">AAVE_WEIGHT</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1000000</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;User balance before minting:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;UNI balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;COMP balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">COMP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;AAVE balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">div</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\n</span><span class=\"mtk8\">User balance after minting 1 share 5 times:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;UNI balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;COMP balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">COMP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;AAVE balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;</span><span class=\"mtk6\">\\n</span><span class=\"mtk8\">User balance after burning all shares:&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;UNI balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;COMP balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">COMP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;AAVE balance: &quot;</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<h4 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual analysis, hardhat.</p>\n<h4 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add a check to <code>pullUnderlying</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>I think it makes sense that if a user is trying to mint an amount so small that no tokens could be pulled from him, the mint request should be denied.\nPer my tests, for an initial ibRatio, this number (the minimal amount of shares that can be minted) is 2 for weights in magnitude of 1e18, and if the weights are eg. smaller by 100, this number will be 101.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/81\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/81#issuecomment-997206834\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Great find, because this finding shows a clear POC of how to extract value from the system, I agree with medium severity</p>\n</blockquote>\n<h2 id=\"m-05-bonding-mechanism-allows-malicious-user-to-dos-auctions\" style=\"position:relative;\"><a href=\"#m-05-bonding-mechanism-allows-malicious-user-to-dos-auctions\" aria-label=\"m 05 bonding mechanism allows malicious user to dos auctions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/66\">[M-05] Bonding mechanism allows malicious user to DOS auctions</a></h2>\n<p><em>Submitted by kenzo, also found by goatbug</em></p>\n<p>A malicious user can listen to the mempool and immediately bond when an auction starts, without aim of settling the auction. As no one can cancel his bond in less than 24h, this will freeze user funds and auction settlement for 24h until his bond is burned and the new index is deleted. The malicious user can then repeat this when a new auction starts.</p>\n<h4 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Denial of service of the auction mechanism. The malicious user can hold the basket “hostage” and postpone or prevent implementing new index.\nThe only way to mitigate it would be to try to front-run the malicious user, obviously not ideal.</p>\n<h4 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>publishAllIndex:\n<a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L170\">https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L170</a></p>\n<ul>\n<li>The attacker would listen to this function / PublishedNewIndex event and upon catching it, immediately bond the auction.</li>\n<li>The publisher has no way to burn a bond before 24h has passed. But even if he could, it would not really help as the attacker could just bond again (though losing funds in the process).</li>\n</ul>\n<p>settleAuction:\n<a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L79\">https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L79</a></p>\n<ul>\n<li>Only the bonder can settle.</li>\n</ul>\n<p>bondBurn:\n<a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L111\">https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L111</a></p>\n<ul>\n<li>Can only burn 24h after bond.</li>\n</ul>\n<h4 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual analysis, hardhat.</p>\n<h4 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>If we only allow one user to bond, I see no real way to mitigate this attack, because the malicious user could always listen to the mempool and immediately bond when an auction starts and thus lock it.\nSo we can change to a mechanism that allows many people to bond and only one to settle;\nbut at that point, I see no point to the bond mechanism any more. So we might as well remove it and let anybody settle the auction.</p>\n<p>With the bond mechanism, a potential settler would have 2 options:</p>\n<ul>\n<li>Bond early: no one else will be able to bond and settle, but the user would need to leave more tokens in the basket (as newRatio starts large and decreases in time)</li>\n<li>Bond late: the settler might make more money as he will need to leave less tokens in the basket, but he risks that somebody else will bond and settle before him.</li>\n</ul>\n<p>Without a bond mechanism, the potential settler would still have these equivalent 2 options:</p>\n<ul>\n<li>Settle early: take from basket less tokens, but make sure you win the auction</li>\n<li>Settle late: take from basket more tokens, but risk that somebody settles before you</li>\n</ul>\n<p>So that’s really equivalent to the bonding scenario.</p>\n<p>I might be missing something but at the moment I see no detriment to removing the bonding mechanism.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/66#issuecomment-946921252\">frank-beard (Kuiper) acknowledged and marked as duplicate</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/276\">https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/276</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/66#issuecomment-997207653\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I think the fundamental issue here is that there can only be one bonder that rebalances, an elegant solution would be to move to a mapping of bonders that rebalance.</p>\n<p>Allowing anyone to bond and rebalance while still allowing the same dynamic of burning their bonds</p>\n<p>This would be more in line with the idea of offering bonds for discounts (Olympus Pro) to anyone as long as there’s enough underlying</p>\n<p>I agree with the finding and believe the severity is appropriate as this effectively slows down the rebalancing by at least 2 days</p>\n</blockquote>\n<h2 id=\"m-06-basket-becomes-unusable-if-everybody-burns-their-shares\" style=\"position:relative;\"><a href=\"#m-06-basket-becomes-unusable-if-everybody-burns-their-shares\" aria-label=\"m 06 basket becomes unusable if everybody burns their shares permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/64\">[M-06] Basket becomes unusable if everybody burns their shares</a></h2>\n<p><em>Submitted by kenzo</em></p>\n<p>While handling the fees, the contract calculates the new <code>ibRatio</code> by dividing by <code>totalSupply</code>. This can be 0 leading to a division by 0.</p>\n<h4 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>If everybody burns their shares, in the next mint, <code>totalSupply</code> will be 0, <code>handleFees</code> will revert, and so nobody will be able to use the basket anymore.</p>\n<h4 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Vulnerable line:\n<a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L124\">https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L124</a>\nYou can add the following test to Basket.test.js and see that it reverts:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;should divide by 0&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">).</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UNI</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">COMP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AAVE</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<h4 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual analysis, hardhat.</p>\n<h4 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add a check to <code>handleFees</code>: if <code>totalSupply= 0</code>, you can just return, no need to calculate new <code>ibRatio</code> / fees.\nYou might want to reset <code>ibRatio</code> to BASE at this point.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/64\">frank-beard (Kuiper) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/64#issuecomment-997210497\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I feel like this can also happen right after the contract was created\n<a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L76\"><code>mintTo</code></a> will call <code>handleFees</code> which will revert due to division by 0</p>\n<p>Finding is valid</p>\n</blockquote>\n<h2 id=\"m-07-no-minimum-rate-in-the-auction-may-break-the-protocol-under-network-failure\" style=\"position:relative;\"><a href=\"#m-07-no-minimum-rate-in-the-auction-may-break-the-protocol-under-network-failure\" aria-label=\"m 07 no minimum rate in the auction may break the protocol under network failure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/42\">[M-07] No minimum rate in the auction may break the protocol under network failure</a></h2>\n<p><em>Submitted by jonah1005</em></p>\n<h4 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The aution contract decides a new <code>ibRatio</code> in the function <code>settleAuction</code>. <a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L91\">Auction.sol#L89-L91</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondTimestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>There’s a chance that <code>newRatio</code> would be really close to zero. This imposes too much risk on the protocol. The network may not really be healthy all the time. Solana and Arbitrum were down and Ethereum was suffered a forking issue recently. Also, the network may be jammed from time to time. This could cause huge damage to a protocol. Please refer to <a href=\"https://medium.com/@whiterabbit_hq/black-thursday-for-makerdao-8-32-million-was-liquidated-for-0-dai-36b83cac56b6\">Black Thursday for makerdao 8.32 million was liquidated for 0 dai</a></p>\n<p>Given the chance that all user may lose their money, I consider this is a medium-risk issue.</p>\n<h4 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://medium.com/@whiterabbit_hq/black-thursday-for-makerdao-8-32-million-was-liquidated-for-0-dai-36b83cac56b6\">Black Thursfay for makerdao 8.32 million was liquidated for 0 dai</a>\n<a href=\"https://www.theblockcrypto.com/post/115822/bug-impacting-over-50-of-ethereum-clients-leads-to-fork\">bug-impacting-over-50-of-ethereum-clients-leads-to-fork</a></p>\n<h4 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>None</p>\n<h4 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>I recommend setting a minimum <code>ibRatio</code> when a publisher publishes a new index. The auction should be killed if the <code>ibRatio</code> is too low.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/42\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/42#issuecomment-997215459\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree that <code>newRatio</code> decreases over time, if nothing is done it will eventually get close to 0, at which point <code>tokensNeeded</code> will tend to 0, which would mean that the amount of underlying necessary to redeem the bond decreases over time</p>\n<p>This can hypothetically allow to redeem the bond for extremely cheap if not for free</p>\n<p>The bond is denominated in the basketToken which effectively represents the value of the “mixture” of the tokens</p>\n<p>Over time, you’re getting the same bond (basket) for less tokens (tokensNeeded), which also means that the basket itself is loosing value (because you can extra the excess value via bonding)</p>\n<p>Sounds to me like the entire <code>settleAuction</code> mechanism is devaluing the basket over time which arguably is a high severity vulnerability.</p>\n<p>Will continue the judging and may end up getting in touch with the sponsor over some additional risks.</p>\n<p>The finding is valid because it shows that the protocol can break given a specific circumstance, I do believe the warden could have found a higher severity by digging deeper</p>\n</blockquote>\n<h2 id=\"m-08--settleauction-may-be-impossible-if-locked-at-a-wrong-time\" style=\"position:relative;\"><a href=\"#m-08--settleauction-may-be-impossible-if-locked-at-a-wrong-time\" aria-label=\"m 08  settleauction may be impossible if locked at a wrong time permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/41\">[M-08]  settleAuction may be impossible if locked at a wrong time.</a></h2>\n<p><em>Submitted by jonah1005</em></p>\n<h4 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The auction contract decides a new <code>ibRatio</code> in the function <code>settleAuction</code>. <a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L91\">Auction.sol#L89-L91</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondTimestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>In this equation, <code>a</code> would not always be greater than <code>b</code>. The <code>auctionBonder</code> may lock the token in <code>bondForRebalance()</code> at a point that <code>a-b</code> would always revert.</p>\n<p>The contract should not allow users to lock the token at the point that not gonna succeed. Given the possible (huge) loss of the user may suffer, I consider this is a medium-risk issue.</p>\n<h4 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Here’s a web3.py script to trigger this bug.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">basket.functions.publishNewIndex([dai.address], [deposit_amount]).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> </span><span class=\"mtk11\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">4</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">60</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">24</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    w3.provider.make_request(</span><span class=\"mtk8\">&#39;evm_mine&#39;</span><span class=\"mtk1\">, [])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">basket.functions.publishNewIndex([dai.address], [deposit_amount]).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">print</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;auction on going&#39;</span><span class=\"mtk1\">, auction.functions.auctionOngoing().call())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> i </span><span class=\"mtk4\">in</span><span class=\"mtk1\"> </span><span class=\"mtk11\">range</span><span class=\"mtk1\">(</span><span class=\"mtk7\">20000</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    w3.provider.make_request(</span><span class=\"mtk8\">&#39;evm_mine&#39;</span><span class=\"mtk1\">, [])</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">all_token = basket.functions.balanceOf(user).call()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">basket.functions.approve(auction.address, all_token).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">auction.functions.bondForRebalance().transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># error Log</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># {&#39;code&#39;: -32603, &#39;message&#39;: &#39;Error: VM Exception while processing transaction: reverted with panic code 0x11 (Arithmetic operation underflowed or overflowed outside of an unchecked block)&#39;}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">auction.functions.settleAuction([], [], [], [], []).transact()</span></span></span></code></pre>\n<h4 id=\"tools-used-6\" style=\"position:relative;\"><a href=\"#tools-used-6\" aria-label=\"tools used 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>None</p>\n<h4 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Recommend to calculate the new irate in <code>bondForRebalance</code>. I understand the <code>auctionBonder</code> should take the risk to get the profit. However, the contract should protect the user in the first place when this auction is doomed to fail.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/41\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/41#issuecomment-997222428\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I do not believe the users are at risk of a specific loss as they can always redeem their shares for underlying <code>Basket.burn</code>\nHowever, this is still a valid finding, and the external conditions make medium severity appropriate</p>\n</blockquote>\n<h2 id=\"m-09-fee-calculation-is-potentially-incorrect\" style=\"position:relative;\"><a href=\"#m-09-fee-calculation-is-potentially-incorrect\" aria-label=\"m 09 fee calculation is potentially incorrect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/129\">[M-09] Fee calculation is potentially incorrect</a></h2>\n<p><em>Submitted by itsmeSTYJ</em></p>\n<h4 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>More fees are actually charged than intended</p>\n<h4 id=\"mitigation-steps\" style=\"position:relative;\"><a href=\"#mitigation-steps\" aria-label=\"mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Steps</h4>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L118\">Basket.sol line 118</a></p>\n<p>Assume that license fee is 10% i.e. 1e17 and time diff = half a year.</p>\n<p>When you calculate <code>feePct</code>, you expect to get 5e16 since that’s 5% and the actual amount of fee to be charged should be totalSupply * feePct (5) / BASE (100) but on line 118, we are actually dividing by BASE - feePct i.e. 95.</p>\n<p>5 / 95 = 0.052 instead of the intended 0.05.</p>\n<p>Solution is to replace <code>BASE - feePct</code> in the denominator with <code>BASE</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/129\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/129#issuecomment-997228019\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden identified an inconsistency with the math that charged more fees than intended</p>\n</blockquote>\n<h2 id=\"m-10-burn-and-mintto-in-basketsol-vulnerable-to-reentrancy\" style=\"position:relative;\"><a href=\"#m-10-burn-and-mintto-in-basketsol-vulnerable-to-reentrancy\" aria-label=\"m 10 burn and mintto in basketsol vulnerable to reentrancy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/248\">[M-10] <code>burn</code> and <code>mintTo</code> in <code>Basket.sol</code> vulnerable to reentrancy</a></h2>\n<p><em>Submitted by 0xalpharush, also found by hack3r-0m, JMukesh, and johnsterlacci</em></p>\n<h4 id=\"impact-9\" style=\"position:relative;\"><a href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The functions <a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L82\">mintTo</a>\nand <a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L96\">burn</a> make external calls prior to updating the state. If a basket contains an ERC777 token, attackers can mint free basket tokens.</p>\n<h4 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>An attacker could reenter the <code>mintTo</code> function when the contract pulls an ERC777 token from the user and mint more tokens than they deposited.</p>\n<h4 id=\"tools-used-7\" style=\"position:relative;\"><a href=\"#tools-used-7\" aria-label=\"tools used 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Slither</p>\n<h4 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Move external calls after state updates. It is best practice to make external calls after updating state in accordance with the check-effect-interact pattern.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/248#issuecomment-929628079\">frank-beard (Kuiper) acknowledged</a>:</strong></p>\n<blockquote>\n<p>For now we are only concerned with ‘Defi Safe’ tokens that conform to the erc-20 standard. It is expected that publishers and users should do due diligence when adding assets to a basket</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/248#issuecomment-997301870\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the warden finding that the function can be subject to re-entrancy.</p>\n<p>Because the exploit is dependent on the token of choice, this is not a guarantee but rather the possibility of the system being vulnerable.</p>\n<p>I highly recommend the sponsor to add re-entrancy checks.</p>\n<p>As for the finding, because it is conditional on using a vulnerable token, I’ll downgrade to medium severity as it requires an external condition for the re-entrance to be possible</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/248#issuecomment-1001268732\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After re-review I agree with medium severity on reentrancy findings on burn and mint, in contract with the “generic” re-entrancy finding with the additional bounties that lack any poc.</p>\n<p>The findings with specific poc have been rated as separate findings (some of which have high risk) as they show an actual way to exploit the protocol</p>\n</blockquote>\n<h2 id=\"m-11-owner-can-steal-all-basket-funds-during-auction\" style=\"position:relative;\"><a href=\"#m-11-owner-can-steal-all-basket-funds-during-auction\" aria-label=\"m 11 owner can steal all basket funds during auction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/265\">[M-11] Owner can steal all Basket funds during auction</a></h2>\n<p><em>Submitted by 0xsanson</em></p>\n<h4 id=\"impact-10\" style=\"position:relative;\"><a href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The owner of Factory contract can modify the values of <code>auctionMultiplier</code> and <code>auctionDecrement</code> at any time.\nDuring an auction, these values are used to calculate <code>newRatio</code> and thereby <code>tokensNeeded</code>: specifically, it’s easy to set the factory parameters so that <code>tokensNeeded = 0</code> (or close to zero) for every token.\nThis way the owner can participate at an auction, change the parameters, and get the underlying tokens from a Basket without transferring any pending tokens.</p>\n<h4 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L99\">https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L99</a></p>\n<h4 id=\"tools-used-8\" style=\"position:relative;\"><a href=\"#tools-used-8\" aria-label=\"tools used 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>editor</p>\n<h4 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider adding a Timelock to these Factory functions. Otherwise a way to not modify them if an auction is ongoing (maybe Auction saves the values it reads when <code>startAuction</code> is called).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/265#issuecomment-929613048\">frank-beard (Kuiper) confirmed and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>the owner for this is intended to be a dao that acts in support of the protocol, however this is a good point to the centralization concerns for the protocol, we will most likely manage this by adding a timelock to these function</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/265#issuecomment-997302120\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding from the warden, highly recommend the sponsor to add these possibilities in their docs to make it easy for users to understand them.</p>\n<p>That said, a possible remediation would also be to add checks in the setters, to avoid for these specific edge cases.</p>\n<p>Because the exploit is dependent on an external condition (setting to a specific value by governance), the finding is of medium severity</p>\n</blockquote>\n<h2 id=\"m-12-factorysol---lack-of-checks-in-setauctiondecrement-will-cause-reverts-in-auctionsettleauction\" style=\"position:relative;\"><a href=\"#m-12-factorysol---lack-of-checks-in-setauctiondecrement-will-cause-reverts-in-auctionsettleauction\" aria-label=\"m 12 factorysol   lack of checks in setauctiondecrement will cause reverts in auctionsettleauction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/119\">[M-12] Factory.sol - lack of checks in <code>setAuctionDecrement</code> will cause reverts in Auction::settleAuction()</a></h2>\n<p><em>Submitted by Alex the Entreprenerd, also found by goatbug</em></p>\n<h4 id=\"impact-11\" style=\"position:relative;\"><a href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><code>setAuctionDecrement</code> doesn’t check for a min nor a max amount\nThis means we can change <code>auctionDecrement</code> which would allow <code>owner</code> to set <code>auctionDecrement</code> to 0</p>\n<p>This will cause the function <code>settleAuction</code> in Auction.sol to revert</p>\n<p>This allows the owner to block auctions from being settled</p>\n<h4 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><code>setAuctionDecrement(0)</code>\nNow <code>settleAuction</code> will revert due to division by 0</p>\n<h4 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add checks in <code>setAuctionDecrement</code>\nRefactor to</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAuctionDecrement</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newAuctionDecrement</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newAuctionDecrement</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">AMOUNT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newAuctionDecrement</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">AMOUNT</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">_2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">auctionDecrement</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newAuctionDecrement</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/119#issuecomment-929647365\">frank-beard (Kuiper) acknowledged and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>the owner for this is intended to be a dao that acts in support of the protocol, however this is a good point to the centralization concerns for the protocol, we will most likely manage this by adding a timelock to these function</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/119#issuecomment-997302382\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I wrote the finding and in being the contest judge will be forfeiting all winnings.</p>\n<p>After thinking about it, this is a medium severity finding because it is a DOS that relies on a specific condition.\nWhile the argument that the owner can be being always hold up, it is important that protocol users understand the risk, so it’s important to flag up admin privileges</p>\n</blockquote>\n<h2 id=\"m-13-lack-of-checks-in-factorysetbondpercentdiv-allow-owner-to-prevent-bonding-in-auctionbondforrebalance\" style=\"position:relative;\"><a href=\"#m-13-lack-of-checks-in-factorysetbondpercentdiv-allow-owner-to-prevent-bonding-in-auctionbondforrebalance\" aria-label=\"m 13 lack of checks in factorysetbondpercentdiv allow owner to prevent bonding in auctionbondforrebalance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/121\">[M-13] lack of checks in <code>Factory::setBondPercentDiv</code> allow owner to prevent bonding in Auction::bondForRebalance()</a></h2>\n<p><em>Submitted by Alex the Entreprenerd, also found by goatbug</em></p>\n<h4 id=\"impact-12\" style=\"position:relative;\"><a href=\"#impact-12\" aria-label=\"impact 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><code>setBondPercentDiv</code> has no checks for min and max</p>\n<p>Setting <code>bondPercentDiv</code> to 0 will cause <code>Auction::bondForRebalance()</code> to revert</p>\n<p>This allows the owner to prevent bonding by setting the <code>bondPercentDiv</code> to 0</p>\n<h4 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Refactor to</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBondPercentDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBondPercentDiv</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBondPercentDiv</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">AMOUNT</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBondPercentDiv</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">AMOUNT_2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bondPercentDiv</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newBondPercentDiv</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/121#issuecomment-929647297\">frank-beard (Kuiper) acknowledged and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>the owner for this is intended to be a dao that acts in support of the protocol, however this is a good point to the centralization concerns for the protocol, we will most likely manage this by adding a timelock to these function</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/121#issuecomment-997302531\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Similarly to #119 </p>\n<ul>\n<li>Am forfeiting my wins</li>\n<li>Always important to flag up admin privileges so people can use the protocol while being aware of the risks they are undertaking</li>\n<li>Medium severity as depends on a specific config</li>\n</ul>\n</blockquote>\n<h2 id=\"m-14-basketsolhandlefees-could-potentially-cause-disruption-of-minting-and-burning\" style=\"position:relative;\"><a href=\"#m-14-basketsolhandlefees-could-potentially-cause-disruption-of-minting-and-burning\" aria-label=\"m 14 basketsolhandlefees could potentially cause disruption of minting and burning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/79\">[M-14] <code>Basket.sol#handleFees()</code> could potentially cause disruption of minting and burning</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L110-L129\">https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L110-L129</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">handleFees</span><span class=\"mtk1\">() </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">lastFee</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lastFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timeDiff</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">timeDiff</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">licenseFee</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">ONE_YEAR</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feePct</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">publisher</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerSplit</span><span class=\"mtk1\">()) / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">Ownable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">factory</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerSplit</span><span class=\"mtk1\">() / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lastFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newIbRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ibRatio</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">startSupply</span><span class=\"mtk1\"> / </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ibRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newIbRatio</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewIBRatio</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ibRatio</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>timeDiff * licenseFee</code> can be greater than <code>ONE_YEAR</code> when <code>timeDiff</code> and/or <code>licenseFee</code> is large enough, which makes <code>feePct</code> to be greater than <code>BASE</code> so that <code>BASE - feePct</code> will revert on underflow.</p>\n<h4 id=\"impact-13\" style=\"position:relative;\"><a href=\"#impact-13\" aria-label=\"impact 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Minting and burning of the basket token are being disrupted until the publisher update the <code>licenseFee</code>.</p>\n<h4 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ol>\n<li>Create a basket with a <code>licenseFee</code> of <code>1e19</code> or 1000% per year and mint 1 basket token;</li>\n<li>The basket remain inactive (not being minted or burned) for 2 months;</li>\n<li>Calling <code>mint</code> and <code>burn</code> reverts at <code>handleFees()</code>.</li>\n</ol>\n<h4 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Limit the max value of <code>feePct</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/79\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/79#issuecomment-997304574\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The finding is valid, there are conditions that would cause <code>feePct</code> to be greater than <code>BASE</code></p>\n<p>The conditions to trigger this seem to be: </p>\n<ul>\n<li>Wait enough time</li>\n<li>Have a high enough fee</li>\n</ul>\n<p>Because this can happen under specific conditions, I will grade this finding as medium severity:</p>\n<p>I would highly recommend the sponsor to consider the possibility of capping the <code>licenseFee</code> to make it easier to predict cases in which the operation can revert</p>\n</blockquote>\n<h2 id=\"m-15-auctionsolsettleauction-late-auction-bond-could-potentially-not-being-able-to-be-settled-cause-funds-loss-to-bonder\" style=\"position:relative;\"><a href=\"#m-15-auctionsolsettleauction-late-auction-bond-could-potentially-not-being-able-to-be-settled-cause-funds-loss-to-bonder\" aria-label=\"m 15 auctionsolsettleauction late auction bond could potentially not being able to be settled cause funds loss to bonder permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/90\">[M-15] <code>Auction.sol#settleAuction()</code> late auction bond could potentially not being able to be settled, cause funds loss to bonder</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p>The <code>newRatio</code> that determines <code>tokensNeeded</code> to settle the auction is calculated based on <code>auctionMultiplier</code>, <code>bondTimestamp - auctionStart</code> and <code>auctionDecrement</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondTimestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>However, if an auction is bonded late (<code>bondTimestamp - auctionStart</code> is a large number), and/or the <code>auctionMultiplier</code> is small enough, and/or the <code>auctionDecrement</code> is small enough, that makes <code>b</code> to be greater than <code>a</code>, so that <code>uint256 newRatio = a - b;</code> will revert on underflow.</p>\n<p>This might seem to be an edge case issue, but considering that a rebalance auction of a bag of shitcoin to high-value tokens might just end up being bonded at the last minute, with a <code>newRatio</code> near zero. When we take the time between the bonder submits the transaction and it got packed into a block, it’s quite possible that the final <code>bondTimestamp</code> gets large enough to revet <code>a - b</code>.</p>\n<h5 id=\"impact-14\" style=\"position:relative;\"><a href=\"#impact-14\" aria-label=\"impact 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h5>\n<p>An auction successfully bonded by a regular user won’t be able to be settled, and the user will lose the bond.</p>\n<h5 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h5>\n<p>With the configuration of:</p>\n<p>basket.ibRatio = 1e18\nfactory.auctionDecrement = 5760 (Blocks per day)\nfactory.auctionMultiplier = 2</p>\n<ol>\n<li>Create an auction;</li>\n<li>The auction remain inactive (not get bonded) for more than 2 days (>11,520 blocks);</li>\n<li>Call <code>bondForRebalance()</code> and it will succeed;</li>\n<li>Calling <code>settleAuction()</code> will always revert.</li>\n</ol>\n<h5 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h5>\n<p>Calculate and require <code>newRatio > 0</code> in <code>bondForRebalance()</code>, or limit the max value of decrement and make sure newRatio always > 0 in <code>settleAuction()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/90\">frank-beard (Kuiper) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/90#issuecomment-997305014\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Finding is valid, there are cases that can cause a - b to revert</p>\n<p>The finding is reliant on external condition (multiplier being low and / or bonding late) as such I believe this to be a medium severity finding.</p>\n<p>Note for the sponsor: The cause for reverts should get clearer with time (as people use the protocol), you definitely want to model these revert behaviour to avoid edge cases that will make funds stuck</p>\n</blockquote>\n<h2 id=\"m-16-auctionsolsettleauction-mishandling-bounty-state-could-potentially-disrupt-settleauction\" style=\"position:relative;\"><a href=\"#m-16-auctionsolsettleauction-mishandling-bounty-state-could-potentially-disrupt-settleauction\" aria-label=\"m 16 auctionsolsettleauction mishandling bounty state could potentially disrupt settleauction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/136\">[M-16] <code>Auction.sol#settleAuction()</code> Mishandling bounty state could potentially disrupt <code>settleAuction()</code></a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L143\">https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L143</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawBounty</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bountyIds</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// withdraw bounties</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">bountyIds</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Bounty</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bounty</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_bounties</span><span class=\"mtk1\">[</span><span class=\"mtk12\">bountyIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bounty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">active</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bounty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bounty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bounty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">active</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">BountyClaimed</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bounty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bounty</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bountyIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In the <code>withdrawBounty</code> function, <code>bounty.active</code> should be set to <code>false</code> when the bounty is claimed.</p>\n<p>However, since <code>bounty</code> is stored in memory, the state update will not succeed.</p>\n<h5 id=\"impact-15\" style=\"position:relative;\"><a href=\"#impact-15\" aria-label=\"impact 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h5>\n<p>An auction successfully bonded by a regular user won’t be able to be settled if they passed seemly active bountyIds, and the bonder will lose the bond.</p>\n<h5 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h5>\n<ol>\n<li>Create an auction;</li>\n<li>Add a bounty;</li>\n<li>Auction settled with bounty claimed;</li>\n<li>Create a new auction;</li>\n<li>Add a new bounty;</li>\n<li>Calling <code>settleAuction()</code> with the bountyIds of the 2 seemly active bounties always reverts.</li>\n</ol>\n<h5 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h5>\n<p>Change to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Bounty</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bounty</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_bounties</span><span class=\"mtk1\">[</span><span class=\"mtk12\">bountyIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]];</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/136#issuecomment-936623596\">frank-beard (Kuiper) confirmed and marked as duplicate</a>:**</p>\n<blockquote>\n<p>duplicate of <a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168\">https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/136#issuecomment-997414434\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Finding is valid, because the warden didn’t provide a POC of how to steal user funds, the finding is of medium severity</p>\n</blockquote>\n<h2 id=\"m-17-unsafe-approve-would-halt-the-auction-and-burn-the-bond\" style=\"position:relative;\"><a href=\"#m-17-unsafe-approve-would-halt-the-auction-and-burn-the-bond\" aria-label=\"m 17 unsafe approve would halt the auction and burn the bond permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/35\">[M-17] Unsafe approve would halt the auction and burn the bond</a></h2>\n<p><em>Submitted by jonah1005, also found by 0xRajeev, 0xsanson, cmichel, and itsmeSTYJ</em></p>\n<h4 id=\"impact-16\" style=\"position:relative;\"><a href=\"#impact-16\" aria-label=\"impact 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L224-L228\">Basket.sol#L224-L228</a> calls approve that do not handle non-standard erc20 behavior.</p>\n<ol>\n<li>Some token contracts do not return any value.</li>\n<li>Some token contracts revert the transaction when the allowance is not zero.</li>\n</ol>\n<p>Since the auction contract calls <code>setNewWeights</code> in function <code>settleAuction</code>, <code>auctionBonder</code> may lock its bond and never successfully settles the auction. This leads to the <code>auctionBonder</code> loss he’s bond and the basket and the auction becomes suspended.</p>\n<p><code>auctionBonder</code> would lose his bond and the contract would be suspended. I consider this a high-risk issue.</p>\n<h4 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>USDT may be a classic non-standard erc20 token.</p>\n<p>Here’s a short POC.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"python\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">usdt.functions.approve(basket.address, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">).transact()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">## the second tx would be reverted as the allowance is not zero</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">usdt.functions.approve(basket.address, </span><span class=\"mtk7\">50</span><span class=\"mtk1\">).transact()</span></span></span></code></pre>\n<h4 id=\"tools-used-9\" style=\"position:relative;\"><a href=\"#tools-used-9\" aria-label=\"tools used 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>None</p>\n<h4 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Recommend to use <code>safeApprove</code> instead and set the allowance to 0 before calling it.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">approveUnderlying</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">spender</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">weights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">spender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/35#issuecomment-929652005\">frank-beard (Kuiper) marked as duplicate</a>:</strong></p>\n<blockquote>\n<p>duplicate of <a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/260\">https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/260</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/35#issuecomment-997415208\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, because this is contingent on an external condition (token being USDT) the finding is of medium severity</p>\n</blockquote>\n<h2 id=\"m-18-licensefee-can-be-greater-than-base\" style=\"position:relative;\"><a href=\"#m-18-licensefee-can-be-greater-than-base\" aria-label=\"m 18 licensefee can be greater than base permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/104\">[M-18] licenseFee can be greater than BASE</a></h2>\n<p><em>Submitted by itsmeSTYJ</em></p>\n<h4 id=\"impact-17\" style=\"position:relative;\"><a href=\"#impact-17\" aria-label=\"impact 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Worst case - no functions that contains <code>handleFees()</code> can pass because <a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L118\">line 118</a> will always underflow and revert. You only need <code>feePct</code> to be bigger than <code>BASE</code> for the <code>handleFees()</code> function to fail which will result in a lot of gas wasted and potentially bond burnt.</p>\n<p>I did not classify this as high risk because a simple fix would be to simply reduce the licenseFee via <code>changeLicenseFee</code>.</p>\n<h4 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Add these require statement to the following functions:</p>\n<ul>\n<li>\n<p>Basket.changeLicenseFee()</p>\n<ul>\n<li><code>require(newLicenseFee &#x3C;= BASE, \"changeLicenseFee: license fee cannot be greater than 100%\");</code></li>\n</ul>\n</li>\n<li>\n<p>Factory.proposeBasketLicense()</p>\n<ul>\n<li><code>require(licenseFee &#x3C;= BASE, \"proposeBasketLicense: license fee cannot be greater than 100%\");</code></li>\n</ul>\n</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/104\">frank-beard (Kuiper) acknowledged</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/104#issuecomment-997467988\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, the warden highlighted an admin exploit that allows to DOS the basket.\nAdding a check not only prevents the exploit, but gives a security guarantee to the protocol users</p>\n</blockquote>\n<h2 id=\"m-19-scoop-erc20-tokens-from-basket-contract\" style=\"position:relative;\"><a href=\"#m-19-scoop-erc20-tokens-from-basket-contract\" aria-label=\"m 19 scoop erc20 tokens from basket contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/56\">[M-19] Scoop ERC20 tokens from basket contract</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<h4 id=\"impact-18\" style=\"position:relative;\"><a href=\"#impact-18\" aria-label=\"impact 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Suppose some unrelated ERC20 tokens end up in the basket contract  (via an airdrop, a user mistake etc)</p>\n<p>Then anyone can do a <code>bondForRebalance()</code> and <code>settleAuction()</code> to scoop these tokens.</p>\n<p>The function <code>settleAuction()</code> allows you to specify an outputToken, so also completely unrelated tokens.\nThus you can retrieve additional tokens with  <code>settleAuction()</code></p>\n<h4 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L69\">https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L69</a>\nfunction settleAuction(..  address[] memory outputTokens, uint256[] memory outputWeights) public override {\n…\nfor (uint256 i = 0; i &#x3C; outputTokens.length; i++) {\nIERC20(outputTokens[i]).safeTransferFrom(address(basket), msg.sender, outputWeights[i]);\n}</p>\n<h4 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Check outputTokens are part of the previous basket tokens  (e.g. <code>basket.tokens()</code> )</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/56\">frank-beard (Kuiper) acknowledged</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/56#issuecomment-997468442\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>If the Auction contract has any ERC20 that is not checked against the require, those tokens can be taken away for free.\nThe warden didn’t directly mention this, but this can also apply to bounties.\nAny bounty specified in a token that is not protected can be taken without claiming the bounty (as the require won’t check for it)</p>\n<p>I think that the finding has appropriate severity, although the warden didn’t directly mention the ability to steal bounties</p>\n</blockquote>\n<h2 id=\"m-20-auction-multiplier-set-to-zero\" style=\"position:relative;\"><a href=\"#m-20-auction-multiplier-set-to-zero\" aria-label=\"m 20 auction multiplier set to zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/242\">[M-20] Auction multiplier set to zero</a></h2>\n<p><em>Submitted by goatbug</em></p>\n<h4 id=\"impact-19\" style=\"position:relative;\"><a href=\"#impact-19\" aria-label=\"impact 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAuctionMultiplier</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newAuctionMultiplier</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">auctionMultiplier</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newAuctionMultiplier</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>auction multiplier can be set to zero by factory owner. This would stop the auction settling, function would always revert.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondTimestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>causing a safe math error and <code>newRatio</code> to revert.</p>\n<h4 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Provide direct links to all referenced code in GitHub. Add screenshots, logs, or any other relevant proof that illustrates the concept.</p>\n<h4 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/242#issuecomment-931568844\">frank-beard (Kuiper) acknowledged and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>it is assumed the owner is trustworthy in this version of the protocol, however we will add mitigations and further decentralization in future updates</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/242#issuecomment-997469832\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, because the warden showed a specific “admin privilege” that DOSses the protocol, the finding is valid and of medium severity</p>\n</blockquote>\n<h2 id=\"m-21-zero-weighted-baskets-are-allowed-to-steal-funds\" style=\"position:relative;\"><a href=\"#m-21-zero-weighted-baskets-are-allowed-to-steal-funds\" aria-label=\"m 21 zero weighted baskets are allowed to steal funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/21\">[M-21] Zero weighted baskets are allowed to steal funds</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<h4 id=\"impact-20\" style=\"position:relative;\"><a href=\"#impact-20\" aria-label=\"impact 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>It was observed that Publisher is allowed to create a basket with zero token and weight. This can lead to user fund stealing as described in below poc\nThe issue was discovered in <code>validateWeights</code> function of Basket contract</p>\n<h4 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ol>\n<li>User proposes a new Basket with 0 tokens and weights using <code>proposeBasketLicense</code> function in Factory contract</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proposal</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">Proposal</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">licenseFee:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">10</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenName:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">abc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokenSymbol:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aa</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">proposer:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0xabc</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokens:</span><span class=\"mtk1\"> {},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">weights:</span><span class=\"mtk1\"> {},</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">basket:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<ol start=\"2\">\n<li><code>validateWeights</code> function is called and it returns success as the only check performed is <code>\\_tokens.length == \\_weights.length (0=0)</code></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">validateWeights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_weights</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">_weights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenList</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[](</span><span class=\"mtk12\">length</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// check uniqueness of tokens and not token(0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"3\">\n<li>\n<p>A new proposal gets created</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_proposals</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proposal</span><span class=\"mtk1\">);</span></span></span></code></pre>\n</li>\n<li>User creates new Basket with this proposal using <code>createBasket</code> function</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">createBasket</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">idNumber</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">IBasket</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Proposal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bProposal</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_proposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">idNumber</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">basket</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ....</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">bProposal</span><span class=\"mtk1\">.</span><span class=\"mtk12\">weights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBasket</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"5\">\n<li>Since no weights and tokens were in this proposal so no token transfer is required (<code>bProposal.weights.length</code> will be 0 so loop won’t run)</li>\n<li>Basket gets created and user becomes publisher for this basket</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">newBasket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mintTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_proposals</span><span class=\"mtk1\">[</span><span class=\"mtk12\">idNumber</span><span class=\"mtk1\">].</span><span class=\"mtk12\">basket</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBasket</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<ol start=\"7\">\n<li>Publisher owned address calls the mint function with say amount 10 on <code>Basket.sol</code> contract</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mintTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mintTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">pullUnderlying</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"8\">\n<li>Since there is no weights so <code>pullUnderlying</code> function does nothing (weights.length is 0)</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pullUnderlying</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">weights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">weights</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] * </span><span class=\"mtk12\">ibRatio</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"9\">\n<li>Full amount 10 is minted to Publisher owned address setting <code>balanceOf(msg.sender) = 10</code></li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<ol start=\"10\">\n<li>Now Publisher calls the <code>publishNewIndex</code> to set new weights. Since <code>pendingWeights.pending</code> is false, else condition gets executed</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">publishNewIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_weights</span><span class=\"mtk1\">) </span><span class=\"mtk11\">onlyPublisher</span><span class=\"mtk1\"> </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">validateWeights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_weights</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pending</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">block</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">TIMELOCK_DURATION</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionOngoing</span><span class=\"mtk1\">() == </span><span class=\"mtk4\">false</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startAuction</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PublishedNewIndex</span><span class=\"mtk1\">(</span><span class=\"mtk12\">publisher</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">hasBonded</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">killAuction</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">weights</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_weights</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">block</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pending</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokens</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">weights</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_weights</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">block</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ol start=\"11\">\n<li>Publisher calls the <code>publishNewIndex</code> again which starts the Auction. This auction is later settled using the <code>settleAuction</code> function in Auction contract</li>\n<li>Publisher owned address can now call burn and get the amount 10 even though he never made the payment since his <code>balanceOf(msg.sender) = 10</code> (Step 9)</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionOngoing</span><span class=\"mtk1\">() == </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">handleFees</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">pushUnderlying</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Burned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h4 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Change <code>validateWeights</code> to check for 0 length token</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">validateWeights</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_weights</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">&gt;</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/21\">frank-beard (defiProtocol) confirmed</a></strong>  </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/21#issuecomment-997499391\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden identified a way to the publisher to effectively mint a ton of shares by setting weights to zero, for them to then change the weights and use their shares to dilute depositors.</p>\n<p>This may be a potential feature of the protocol at this time as there’s no check for how the ratios relate to themselves</p>\n<p>The implications are actually pretty deep and I highly recommend the sponsor to consider the fact that if weights can be changed at any time by the publisher, they can effectively dilute / re-base the basket at any time very aggressively, to the detriment of users.</p>\n<p>As for the the finding by the warden, they have shown a specific way for the publisher to dilute other depositors, by setting up a basket with zero tokens initially.</p>\n<p>Becasue this is a specific attack that relies on external conditions, I’m downgrading the severity to medium</p>\n</blockquote>\n<h2 id=\"m-22-incorrect-data-location-specifier-can-be-abused-to-cause-dos-and-fund-loss\" style=\"position:relative;\"><a href=\"#m-22-incorrect-data-location-specifier-can-be-abused-to-cause-dos-and-fund-loss\" aria-label=\"m 22 incorrect data location specifier can be abused to cause dos and fund loss permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168\">[M-22] Incorrect data location specifier can be abused to cause DoS and fund loss</a></h2>\n<p><em>Submitted by 0xRajeev, also found by bw and pauliax</em></p>\n<h4 id=\"impact-21\" style=\"position:relative;\"><a href=\"#impact-21\" aria-label=\"impact 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>withdrawBounty()</code> loops through the <code>\\_bounties</code> array looking for active bounties and transferring amounts from active ones. However, the data location specifier used for bounty is memory which makes a copy of the <code>\\_bounties</code> array member instead of a reference. So when bounty.active is set to false, this is changing only the memory copy and not the array element of the storage variable. This results in bounties never being set to inactive, keeping them always active forever and every <code>withdrawBounty()</code> will attempt to transfer bounty amount from the Auction contract to the msg.sender.</p>\n<p>Therefore, while the transfer will work the first time, subsequent attempts to claim this bounty will revert on transfer (because the Auction contract will not have required amount of bounty tokens) causing <code>withdrawBounty()</code> to always revert and therefore preventing settling of any auction.</p>\n<p>A malicious attacker can add a tiny bounty on any/every Auction contract to prevent any reindexing on that contract to happen because it will always revert on auction settling. This can be used to cause DoS on any <code>auctionBonder</code> so as to make them lose their bondAmount because their bonded auction cannot be settled.</p>\n<h4 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L143\">https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L143</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L143-L147\">https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L143-L147</a></li>\n<li><a href=\"https://docs.soliditylang.org/en/v0.8.7/types.html#data-location-and-assignment-behaviour\">https://docs.soliditylang.org/en/v0.8.7/types.html#data-location-and-assignment-behaviour</a></li>\n</ul>\n<h4 id=\"tools-used-10\" style=\"position:relative;\"><a href=\"#tools-used-10\" aria-label=\"tools used 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual Analysis</p>\n<h4 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Recommend changing storage specifier of bounty to “storage” instead of “memory”.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168\">frank-beard (Kuiper) confirmed</a></strong>  </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168#issuecomment-997414247\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Great find, adding the same bounty multiple times can allow the exploiter to drain the entire contract as long as the bounties are denominated in the underlying token</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168#issuecomment-999137782\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Because the warden shows a way to cause DOS, which is contingent on setting it as well as redeeming that bounty (which can be avoided by simply not adding it to the bountiesID calldata), I will rate this finding as Medium Severity</p>\n<p>The DOS is low severity as it can be sidestep very easily, see #82 </p>\n<p>However, the warden has identified a technical issue with the protocol (unflagging of bounty), as such I agree with a medium severity</p>\n</blockquote>\n<h2 id=\"m-23-auction-settler-can-steal-user-funds-if-bond-timestamp-is-high-enough\" style=\"position:relative;\"><a href=\"#m-23-auction-settler-can-steal-user-funds-if-bond-timestamp-is-high-enough\" aria-label=\"m 23 auction settler can steal user funds if bond timestamp is high enough permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45\">[M-23] Auction settler can steal user funds if bond timestamp is high enough</a></h2>\n<p><em>Submitted by kenzo</em></p>\n<p>After an auction has started, as time passes and according to the <code>bondTimestamp</code>, <code>newRatio</code> (which starts at <code>2\\*ibRatio</code>) gets smaller and smaller and therefore less and less tokens need to remain in the basket.\nThis is not capped, and after a while, <code>newRatio</code> can become smaller than current <code>ibRatio</code>.</p>\n<h4 id=\"impact-22\" style=\"position:relative;\"><a href=\"#impact-22\" aria-label=\"impact 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>If for some reason nobody has settled an auction and the publisher didn’t stop it, a malicious user can wait until <code>newRatio &#x3C; ibRatio</code>, or even until <code>newRatio \\~= 0</code> (for an initial <code>ibRatio</code> of ~1e18 this happens after less than 3.5 days after auction started), and then bond and settle and steal user funds.</p>\n<h4 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>These are the vulnerable lines:\n<a href=\"https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L89:#L99\">https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L89:#L99</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionMultiplier</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">basket</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ibRatio</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">bondTimestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">auctionStart</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">auctionDecrement</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">b</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokensNeeded</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">basketAsERC20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() * </span><span class=\"mtk12\">pendingWeights</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] * </span><span class=\"mtk12\">newRatio</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">BASE</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pendingTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">basket</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">tokensNeeded</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The function verifies that <code>pendingTokens[i].balanceOf(basket) >= basketAsERC20.totalSupply() * pendingWeights[i] * newRatio / BASE / BASE</code>. This is the formula that will be used later to mint/burn/withdraw user funds.\nAs bondTimestamp increases, newRatio will get smaller, and there is no check on this.\nAfter a while we’ll arrive at a point where <code>newRatio ~= 0</code>, so <code>tokensNeeded = newRatio*(...) ~= 0</code>, so the attacker could withdraw nearly all the tokens using outputTokens and outputWeights, and leave just scraps in the basket.</p>\n<h4 id=\"tools-used-11\" style=\"position:relative;\"><a href=\"#tools-used-11\" aria-label=\"tools used 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual analysis, hardhat.</p>\n<h4 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Your needed condition/math might be different, and you might also choose to burn the bond while you’re at it, but I think at the minimum you should add a sanity check in settleAuction:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require (newRatio &gt; basket.ibRatio());</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45\">frank-beard (Kuiper) confirmed</a></strong>  </p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45#issuecomment-997472588\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Would need confirmation from the sponsor here (this finding was also submitted on the more recent contest)\nAs discount is part of the protocol (I think)</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45#issuecomment-997499754\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@frank-beard is the discount a feature or a bug?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45#issuecomment-1001265126\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>As per this discussion: <a href=\"https://github.com/code-423n4/2021-10-defiprotocol-findings/issues/51\">https://github.com/code-423n4/2021-10-defiprotocol-findings/issues/51</a></p>\n<p>The finding is valid and of medium severity</p>\n</blockquote>\n<h1 id=\"low-risk-findings-45\" style=\"position:relative;\"><a href=\"#low-risk-findings-45\" aria-label=\"low risk findings 45 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (45)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/73\">[L-01] Not handling approve return value</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/200\">[L-02] licenseFee state variable not checked for maximum value (Basket.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/274\">[L-03] No input validation on parameter changes</a> <em>Submitted by anon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/271\">[L-04] block.timestamp is a better timer than block.number</a> <em>Submitted by anon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/270\">[L-05] Add nonreentrant modifiers to external methods in 2 files</a> <em>Submitted by anon, also found by 0xRajeev, 0xsanson, goatbug, and pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/86\">[L-06] Missing Zero-Address Checks</a> <em>Submitted by shenwilly, also found by 0xRajeev and JMukesh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/206\">[L-07] Check the actual amounts transferred</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/124\">[L-08] Variable assignment has no effect</a> <em>Submitted by nikitastupin</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/193\">[L-09] Lack of Event Logging and Input Validation</a> <em>Submitted by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/58\">[L-10] Inaccurate log emitted at deleteNewIndex</a> <em>Submitted by kenzo</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/30\">[L-11] Cannot change pending while timelocked</a> <em>Submitted by joeysantoro</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/27\">[L-12] DAO is fee recipient / cannot revoke owner</a> <em>Submitted by joeysantoro</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/101\">[L-13] tokensNeeded can potentially be 0</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/235\">[L-14] Proposals can never get created due to reaching <code>block.gaslimit</code></a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/234\">[L-15] Sanity checks when the contract parameters are updated</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/163\">[L-16] Event params are of no practical value</a> <em>Submitted by hack3r-0m</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/52\">[L-17] handleFees() will revert if licenseFee is too high</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/50\">[L-18] initialize of Basket.sol is missing initializer </a> <em>Submitted by gpersoon, also found by 0xRajeev and loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/83\">[L-19] Lack of zero ratio validation</a> <em>Submitted by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/25\">[L-20] Global bounties variable and 0 bounty allow dos in bounty functionality of basket</a> <em>Submitted by csanuragjain</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/224\">[L-21] <code>newIbRatio</code> update math depends on how often it’s called</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/222\">[L-22] Setting wrong publisher cannot be undone</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/219\">[L-23] Re-entrancy in <code>Factory.createBasket</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/218\">[L-24] Wrong constant for <code>ONE_DAY</code></a> <em>Submitted by cmichel, also found by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/115\">[L-25] specs not according to the docs</a> <em>Submitted by JMukesh</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/111\">[L-26] lack of checking of array length</a> <em>Submitted by JMukesh, also found by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/120\">[L-27] lack of checks in Factory.setAuctionMultiplier</a> <em>Submitted by Alex the Entreprenerd</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/118\">[L-28] Factory.sol - lack of checks for setMinLicenseFee</a> <em>Submitted by Alex the Entreprenerd</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/264\">[L-29] <code>handleFees</code> reverts if supply is zero</a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/190\">[L-30] Recognize the risk of using approve</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/189\">[L-31] Resetting partial struct fields is risky</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/185\">[L-32] Publisher role cannot be renounced</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/177\">[L-33] Missing support for (preventing) use of deflationary tokens in baskets</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/176\">[L-34] Risk of duplicate/scam basket token names/symbols may trick users</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/173\">[L-35] Missing sanity/threshold checks on critical contract parameter initializations</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/172\">[L-36] Missing timelocks for critical protocol parameter setters by owner</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/122\">[L-37] Timelock period may be less than 24 hours because it depends on <code>block.number</code> instead of <code>block.timestamp</code></a> <em>Submitted by nikitastupin</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/62\">[L-38] Missing Transfer Ownership Pattern</a> <em>Submitted by leastwood</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/3\">[L-39] initialize function in basket.sol can be front-run</a> <em>Submitted by jah</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/114\">[L-40] use of approve() instead of safeApprove()</a> <em>Submitted by JMukesh, also found by defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/195\">[L-41] block timestamp manipulation can cause fees change</a> <em>Submitted by aga7hokakological</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/82\">[L-42] <code>Auction.sol#settleAuction()</code> addBounty with a fake token could potentially disrupt <code>settleAuction()</code></a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/186\">[L-43]  Incorrectly used new publisher and new licenseFee cannot be changed</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/89\">[L-44] <code>Factory.sol</code> Lack of two-step procedure and/or input validation routines for critical operations leaves them error-prone</a> <em>Submitted by WatchPug, also found by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/55\">[L-45] malicious tokens could be added with addBounty</a> <em>Submitted by gpersoon, also found by jonah1005 and leastwood</em></li>\n</ul>\n<h1 id=\"non-critical-findings-39\" style=\"position:relative;\"><a href=\"#non-critical-findings-39\" aria-label=\"non critical findings 39 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (39)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/149\">[N-01] Using delete to clear variables instead of zero assignment</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/127\">[N-02]  Protocol owner fee limit not verified correctly (Factory.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/217\">[N-03] Style issues</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/205\">[N-04] emit NewIBRatio in function initialize</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/203\">[N-05] Hardcoding numbers is error-prone</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/202\">[N-06] Inconvenient to find bounty ids</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/123\">[N-07] Timelocked functions doesn’t emit proposal events</a> <em>Submitted by nikitastupin, also found by JMukesh and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/71\">[N-08] <code>proposal</code> declared as both a function and a Proposal in Factory</a> <em>Submitted by loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/69\">[N-09] Use of uint rather than uint256</a> <em>Submitted by loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/57\">[N-10] BLOCK_DECREMENT not used</a> <em>Submitted by gpersoon, also found by itsmeSTYJ, kenzo, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/63\">[N-11] Basket will break and lock all user funds if not used in 100 years</a> <em>Submitted by kenzo</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/99\">[N-12] Suggestion for incentive alignment</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/98\">[N-13] Misleading variable names</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/97\">[N-14] Use CEI pattern to align w/ best practices</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/51\">[N-15] More readable constants</a> <em>Submitted by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/80\">[N-16] <code>Auction.sol#bondTimestamp</code> Misleading name</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/126\">[N-17] Settle Time Limit not set correctly (Auction.sol)</a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/68\">[N-18] Code lacking comments/spec</a> <em>Submitted by loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/250\">[N-19] Naming</a> <em>Submitted by goatbug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/18\">[N-20] Uninitialized Implementation Contracts</a> <em>Submitted by bw</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/17\">[N-21] Events not emitted for parameter changes </a> <em>Submitted by bw</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/263\">[N-22] Event BasketLicenseProposed needs an idNumber</a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/261\">[N-23] <code>bondTimestamp</code> is not a timestamp but a blocknumber</a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/258\">[N-24] Lack of revert messages</a> <em>Submitted by 0xsanson, also found by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/191\">[N-25] Max approvals are risky if contract is malicious/compromised</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/178\">[N-26] Missing emission of basket ID and token composition</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/174\">[N-27] Hardcoded constants are risky</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/169\">[N-28] Lack of indexed event parameters will affect offchain monitoring</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/164\">[N-29] Missing interfaces to determine available bounties</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/157\">[N-30] Missing check for auctionOngoing is risky</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/139\">[N-31] Lack of guarded launch approach may be risky</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/5\">[N-32] Lack of input validation in initialize function of Basket.sol </a> <em>Submitted by jah</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/1\">[N-33] Lack of input validation in  initialize function of  Auction.sol</a> <em>Submitted by jah</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/275\">[N-34] Limit on growth size of pool - bond size</a> <em>Submitted by goatbug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/171\">[N-35] Missing events for critical protocol parameter setters by owner</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/188\">[N-36] 2-step change of publisher address and licenseFee does not generate warning event</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/180\">[N-37] Using the latest compiler version may be susceptible to undiscovered bugs</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/257\">[N-38] <code>mintTo</code> arguments order</a> <em>Submitted by 0xsanson</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/162\">[N-39] Malicious tokens can execute arbitrary code</a> <em>Submitted by 0xRajeev</em></li>\n</ul>\n<h1 id=\"gas-optimizations-46\" style=\"position:relative;\"><a href=\"#gas-optimizations-46\" aria-label=\"gas optimizations 46 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (46)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/109\">[G-01] Packing storage variables in Auction would save gas</a> <em>Submitted by t11s, also found by 0xRajeev, jah, JMukesh, kenzo, leastwood, and loop</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/108\">[G-02] settleAuction should be external and arguments should use calldata</a> <em>Submitted by t11s</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/216\">[G-03] Eliminate hasBonded</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/215\">[G-04] newIbRatio is not really useful</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/214\">[G-05] Mint fees can be simplified</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/160\">[G-06] Gas Optimization Wrt. Token Uniqueness</a> <em>Submitted by leastwood, also found by cmichel, csanuragjain, itsmeSTYJ, joeysantoro, kenzo, and pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/240\">[G-07] Set functions to external.</a> <em>Submitted by goatbug, also found by 0xRajeev, 0xsanson, chasemartin01, hack3r-0m, pauliax, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/211\">[G-08] Dead code</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/210\">[G-09] Double division by BASE</a> <em>Submitted by pauliax</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/43\">[G-10] Redundant call to external contract, result can be saved</a> <em>Submitted by kenzo, also found by pauliax and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/230\">[G-11] Replace <code>tokenList.length</code> by existing variable <code>length</code></a> <em>Submitted by hrkrshnn, also found by pauliax, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/40\">[G-12] Restore state to 0 if not needed anymore</a> <em>Submitted by kenzo, also found by gpersoon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/39\">[G-13] Unnecessary initializing of variable to 0</a> <em>Submitted by kenzo, also found by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/7\">[G-14] Some variables type should be changed </a> <em>Submitted by jah</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/4\">[G-15] Gas Saving by changing the visibility of initialize function from public to externa in basket.sol</a> <em>Submitted by jah</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/95\">[G-16] Only validateWeights when it is needed</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/94\">[G-17] set lastFee in initialize() function</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/92\">[G-18] Transfer tokens directly to the basket</a> <em>Submitted by itsmeSTYJ</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/15\">[G-19] Runtime constants not defined as immutable</a> <em>Submitted by bw, also found by 0xRajeev and hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/232\">[G-20] The increment in for loop post condition can be made unchecked</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/229\">[G-21] Use <code>calldata</code> instead of <code>memory</code> for function parameters</a> <em>Submitted by hrkrshnn</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/198\">[G-22] redundant code (unused variables)</a> <em>Submitted by hack3r-0m, also found by goatbug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/53\">[G-23] handleFees() only mint when necessary</a> <em>Submitted by gpersoon, also found by bw and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/253\">[G-24] Same tokens added to bounty</a> <em>Submitted by goatbug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/252\">[G-25] pack structs *3</a> <em>Submitted by goatbug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/245\">[G-26] Unecessary transfer trips</a> <em>Submitted by goatbug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/238\">[G-27] Gas optimation proposal struct</a> <em>Submitted by goatbug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/237\">[G-28] Gas saving: pack struct</a> <em>Submitted by goatbug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/228\">[G-29] Gas: Can save an sload in <code>changeLicenseFee</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/227\">[G-30] Gas: Can save an sload in <code>changePublisher</code></a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/225\">[G-31] Gas: Factory parameter can be removed from Auction</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/75\">[G-32] Use calldata instead of memory in function parameter declarations</a> <em>Submitted by chasemartin01</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/19\">[G-33] Require statement can be moved to start of function</a> <em>Submitted by bw</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/137\">[G-34] <code>Auction.sol#initialize()</code> Use msg.sender rather than factory_ parameter can save gas</a> <em>Submitted by WatchPug, also found by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/135\">[G-35] Adding unchecked directive can save gas</a> <em>Submitted by WatchPug, also found by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/165\">[G-36] Bounty list is never pruned to remove inactive bounties</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/154\">[G-37] Choose either explicit return or named return, not both</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/153\">[G-38] Avoiding unnecessary return can save gas</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/151\">[G-39] Loop can be skipped for i == 0</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/150\">[G-40] Unnecessary initialization of loop index variable</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/147\">[G-41] Caching return values of external calls in local/memory variables avoids CALLs to save gas</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/145\">[G-42] Caching state variables in local/memory variables avoids SLOADs to save gas</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/143\">[G-43] Avoiding state variables in emits saves gas</a> <em>Submitted by 0xRajeev</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/85\">[G-44] Redundant Balance Check</a> <em>Submitted by shenwilly</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/273\">[G-45] Unnecessary require check</a> <em>Submitted by anon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/156\">[G-46] Unused constant</a> <em>Submitted by 0xRajeev</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk6 { color: #D7BA7D; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-3\">High Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#h-01-re-entrancy-in-settleauction-allow-stealing-all-funds\">[H-01] Re-entrancy in <code>settleAuction</code> allow stealing all funds</a></li>\n<li><a href=\"#h-02-basketsolauctionburn-a-failed-auction-will-freeze-part-of-the-funds\">[H-02] <code>Basket.sol#auctionBurn()</code> A failed auction will freeze part of the funds</a></li>\n<li><a href=\"#h-03-reentrancy-in-settleauction-malicious-publisher-can-bypass-index-timelock-mechanism-inject-malicious-index-and-rug-the-basket\">[H-03] Reentrancy in settleAuction(): malicious publisher can bypass index timelock mechanism, inject malicious index, and rug the basket</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-23\">Medium Risk Findings (23)</a></p>\n<ul>\n<li><a href=\"#m-01-use-safetransfer-instead-of-transfer\">[M-01] Use safeTransfer instead of transfer</a></li>\n<li><a href=\"#m-02-fee-on-transfer-tokens-can-lead-to-incorrect-approval\">[M-02] Fee on transfer tokens can lead to incorrect approval</a></li>\n<li><a href=\"#m-03-onlyowner-role-can-unintentionally-influence-settleauction\">[M-03] <code>onlyOwner</code> Role Can Unintentionally Influence <code>settleAuction()</code></a></li>\n<li><a href=\"#m-04-user-can-mint-miniscule-amount-of-shares-later-withdraw-miniscule-more-than-deposited\">[M-04] User can mint miniscule amount of shares, later withdraw miniscule more than deposited</a></li>\n<li><a href=\"#m-05-bonding-mechanism-allows-malicious-user-to-dos-auctions\">[M-05] Bonding mechanism allows malicious user to DOS auctions</a></li>\n<li><a href=\"#m-06-basket-becomes-unusable-if-everybody-burns-their-shares\">[M-06] Basket becomes unusable if everybody burns their shares</a></li>\n<li><a href=\"#m-07-no-minimum-rate-in-the-auction-may-break-the-protocol-under-network-failure\">[M-07] No minimum rate in the auction may break the protocol under network failure</a></li>\n<li><a href=\"#m-08--settleauction-may-be-impossible-if-locked-at-a-wrong-time\">[M-08]  settleAuction may be impossible if locked at a wrong time.</a></li>\n<li><a href=\"#m-09-fee-calculation-is-potentially-incorrect\">[M-09] Fee calculation is potentially incorrect</a></li>\n<li><a href=\"#m-10-burn-and-mintto-in-basketsol-vulnerable-to-reentrancy\">[M-10] <code>burn</code> and <code>mintTo</code> in <code>Basket.sol</code> vulnerable to reentrancy</a></li>\n<li><a href=\"#m-11-owner-can-steal-all-basket-funds-during-auction\">[M-11] Owner can steal all Basket funds during auction</a></li>\n<li><a href=\"#m-12-factorysol---lack-of-checks-in-setauctiondecrement-will-cause-reverts-in-auctionsettleauction\">[M-12] Factory.sol - lack of checks in <code>setAuctionDecrement</code> will cause reverts in Auction::settleAuction()</a></li>\n<li><a href=\"#m-13-lack-of-checks-in-factorysetbondpercentdiv-allow-owner-to-prevent-bonding-in-auctionbondforrebalance\">[M-13] lack of checks in <code>Factory::setBondPercentDiv</code> allow owner to prevent bonding in Auction::bondForRebalance()</a></li>\n<li><a href=\"#m-14-basketsolhandlefees-could-potentially-cause-disruption-of-minting-and-burning\">[M-14] <code>Basket.sol#handleFees()</code> could potentially cause disruption of minting and burning</a></li>\n<li><a href=\"#m-15-auctionsolsettleauction-late-auction-bond-could-potentially-not-being-able-to-be-settled-cause-funds-loss-to-bonder\">[M-15] <code>Auction.sol#settleAuction()</code> late auction bond could potentially not being able to be settled, cause funds loss to bonder</a></li>\n<li><a href=\"#m-16-auctionsolsettleauction-mishandling-bounty-state-could-potentially-disrupt-settleauction\">[M-16] <code>Auction.sol#settleAuction()</code> Mishandling bounty state could potentially disrupt <code>settleAuction()</code></a></li>\n<li><a href=\"#m-17-unsafe-approve-would-halt-the-auction-and-burn-the-bond\">[M-17] Unsafe approve would halt the auction and burn the bond</a></li>\n<li><a href=\"#m-18-licensefee-can-be-greater-than-base\">[M-18] licenseFee can be greater than BASE</a></li>\n<li><a href=\"#m-19-scoop-erc20-tokens-from-basket-contract\">[M-19] Scoop ERC20 tokens from basket contract</a></li>\n<li><a href=\"#m-20-auction-multiplier-set-to-zero\">[M-20] Auction multiplier set to zero</a></li>\n<li><a href=\"#m-21-zero-weighted-baskets-are-allowed-to-steal-funds\">[M-21] Zero weighted baskets are allowed to steal funds</a></li>\n<li><a href=\"#m-22-incorrect-data-location-specifier-can-be-abused-to-cause-dos-and-fund-loss\">[M-22] Incorrect data location specifier can be abused to cause DoS and fund loss</a></li>\n<li><a href=\"#m-23-auction-settler-can-steal-user-funds-if-bond-timestamp-is-high-enough\">[M-23] Auction settler can steal user funds if bond timestamp is high enough</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-45\">Low Risk Findings (45)</a></li>\n<li><a href=\"#non-critical-findings-39\">Non-Critical Findings (39)</a></li>\n<li><a href=\"#gas-optimizations-46\">Gas Optimizations (46)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of the Kuiper contest smart contract system written in Solidity. The code contest took place between September 16—September 22 2021.\n\n_Note: this audit contest originally ran under the name `defiProtocol`._\n\n## Wardens\n\n30 Wardens contributed reports to the Kuiper contest:\n\n1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n1. [cmichel](https://twitter.com/cmichelio)\n1. [kenzo](https://twitter.com/KenzoAgada)\n1. [0xRajeev](https://twitter.com/0xRajeev)\n1. [itsmeSTYJ](https://twitter.com/itsmeSTYJ)\n1. goatbug\n1. [jonah1005](https://twitter.com/jonah1005w)\n1. [leastwood](https://twitter.com/liam_eastwood13)\n1. [gpersoon](https://twitter.com/gpersoon)\n1. [0xsanson](https://github.com/0xsanson)\n1. [csanuragjain](https://twitter.com/csanuragjain)\n1. [hrkrshnn](https://twitter.com/_hrkrshnn)\n1. [JMukesh](https://twitter.com/MukeshJ_eth)\n1. [pauliax](https://twitter.com/SolidityDev)\n1. [hack3r-0m](https://twitter.com/hack3r_0m)\n1. [joeysantoro](https://twitter.com/joey__santoro)\n1. [nikitastupin](http://twitter.com/_nikitastupin)\n1. [defsec](https://twitter.com/defsec_)\n1. [jah](https://twitter.com/jah_s3)\n1. [bw](https://github.com/bernard-wagner)\n1. [ye0lde](https://twitter.com/_ye0lde)\n1. aga7hokakological\n1. [shenwilly](https://twitter.com/shenwilly_)\n1. [0xalpharush](https://twitter.com/0xalpharush)\n1. [johnsterlacci](https://twitter.com/JohnSterlacci)\n1. [loop](https://twitter.com/loop_225)\n1. [t11s](https://twitter.com/transmissions11)\n1. [chasemartin01](https://github.com/chasemartin01)\n1. [Alex the Entreprenerd](https://twitter.com/GalloDaSballo) \n\n\nThis contest was judged by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo). The judge also competed in the contest as a warden, but forfeited their winnings.\n\n<!-- ❗️Note that the above line is draft only - would love a second set of eyes on it. -->\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay) and [CloudEllie](https://twitter.com/CloudEllie1).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 71 unique vulnerabilities and 156 total findings. All of the issues presented here are linked back to their original finding.\n\nOf these vulnerabilities, 3 received a risk rating in the category of HIGH severity, 23 received a risk rating in the category of MEDIUM severity, and 45 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 39 non-critical recommendations and 46 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 Kuiper contest repository](https://github.com/code-423n4/2021-09-defiProtocol), and is composed of 11 smart contracts written in the Solidity programming language and includes 528 lines of Solidity code and 460 lines of JavaScript.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (3)\n## [[H-01] Re-entrancy in `settleAuction` allow stealing all funds](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/223)\n_Submitted by cmichel_\n\nNote that the `Basket` contract approved the `Auction` contract with all tokens and the `settleAuction` function allows the auction bonder to transfer all funds out of the basket to themselves.\nThe only limiting factor is the check afterwards that needs to be abided by. It checks if enough tokens are still in the basket after settlement:\n\n```solidity\n// this is the safety check if basket still has all the tokens after removing arbitrary amounts\nfor (uint256 i = 0; i < pendingWeights.length; i++) {\n    uint256 tokensNeeded = basketAsERC20.totalSupply() * pendingWeights[i] * newRatio / BASE / BASE;\n    require(IERC20(pendingTokens[i]).balanceOf(address(basket)) >= tokensNeeded);\n}\n``` \n\nThe bonder can pass in any `inputTokens`, even malicious ones they created.\nThis allows them to re-enter the `settleAuction` multiple times for the same auction.\n\nCalling this function at the correct time (such that `bondTimestamp - auctionStart` makes `newRatio < basket.ibRatio()`), the attacker can drain more funds each time, eventually draining the entire basket.\n\n#### Proof Of Concept\n\nAssume that the current `basket.ibRatio` is `1e18` (the initial value).\nThe basket publisher calls `basket.publishNewIndex` with some tokens and weights.\nFor simplicity, assume that the pending `tokens` are the same as tokens as before, only the weights are different, i.e., this would just rebalance the portfolio.\nThe function call then starts the auction.\n\nThe important step to note is that the `tokensNeeded` value in `settleAuction` determines how many tokens need to stay in the `basket`.\nIf we can continuously lower this value, we can keep removing tokens from the `basket` until it is empty.\n\nThe `tokensNeeded` variable is computed as `basketAsERC20.totalSupply() * pendingWeights[i] * newRatio / BASE / BASE`.\nThe only variable that changes in the computation when re-entering the function is `newRatio` (no basket tokens are burned, and the pending weights are never cleared).\n\nThus if we can show that `newRatio` decreases on each re-entrant call, we can move out more and more funds each time.\n\n###### newRatio decreases on each call\n\nAfter some time, the attacker calls `bondForRebalance`. This determines the `bondTimestamp - auctionStart` value in `settleAuction`.\nThe attack is possible as soon as `newRatio < basket.ibRatio()`.\nFor example, using the standard parameters the calculation would be:\n\n```solidity\n// a = 2 * ibRatio\nuint256 a = factory.auctionMultiplier() * basket.ibRatio();\n// b = (bondTimestamp - auctionStart) * 1e14\nuint256 b = (bondTimestamp - auctionStart) * BASE / factory.auctionDecrement();\n// newRatio = a - b = 2 * ibRatio - (bondTimestamp - auctionStart) * 1e14\nuint256 newRatio = a - b;\n```\n\nWith our initial assumption of `ibRatio = 1e18` and calling `bondForRebalance` after 11,000 seconds (\\~3 hours) we will get our result that `newRatio` is less than the initial `ibRatio`:\n\n```python\nnewRatio = a - b = 2 * 1e18 - (11000) * 1e14 = 2e18 - 1.1e18 = 0.9e18 < 1e18 = basket.ibRatio\n```\n\n> This seems to be a reasonable value (when the pending tokens and weights are equal in value to the previous ones) as no other bonder would want to call this earlier such when `newRatio > basket.ibRatio` as they would put in more total value in tokens as they can take out of the basket.\n\n###### re-enter on settleAuction\n\nThe attacker creates a custom token `attackerToken` that re-enters the `Auction.settleAuction` function on `transferFrom` with parameters we will specify.\n\nThey call `settleAuction` with `inputTokens = [attackerToken]` to re-enter several times.\n\nIn the inner-most call where `newRatio = 0.9e18`, they choose the `inputTokens`/`outputTokens` parameters in a way to pass the initial `require(IERC20(pendingTokens[i]).balanceOf(address(basket)) >= tokensNeeded);` check - transferring out any other tokens of `basket` with `outputTokens`.\n\nThe function will continue to run and call `basket.setNewWeights();` and `basket.updateIBRatio(newRatio);` which will set the new weights (but not clear the pending ones) and set the new `basket.ibRatio`.\n\nExecution then jumps to the 2nd inner call after the `IERC20(inputTokens[i]=attackerToken).safeTransferFrom(...)` and has the chance to transfer out tokens again.\nIt will compute `newRatio` with the new lowered `basket.ibRatio` of `0.9e18`: `newRatio = a - b = 2 * 0.9e18 - 1.1e18 = 0.7e18`.\nTherefore, `tokensNeeded` is lowered as well and the attacker was allowed to transfer out more tokens having carefully chosen `outputWeights`.\n\nThis repeats with `newRatio = 0.3`.\n\nThe attack is quite complicated and requires carefully precomputing and then setting the parameters, as well as sending back the `bondAmount` tokens to the `auction` contract which are then each time transferred back in the function body.\nBut I believe this should work.\n\n#### Impact\n\nThe basket funds can be stolen.\n\n#### Recommended Mitigation Steps\n\nAdd re-entrancy checks (for example, OpenZeppelin's \"locks\") to the `settleAuction` function.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/223)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/223#issuecomment-997410663):**\n > Let's dissect the finding to prove whether it's valid or not.\n> \n> First of all, we do have the pre-conditions for re-entrancy:\n> - Allows any token as input (untrusted input)\n> - No re-entrancy modifier\n> - Checks are performed at the beginning, transfers in the middle, and state changes at the end (violation of `check effect interaction` pattern)\n> \n> So in any case this is a report for reEntrancy (medium severity)\n> \n> However, the warden is showing a specific attack vector that, if proven, allows to steal the majority of funds from the basket.\n> \n> Let's investigate (with a single re-entrant call example):\n> \n> The require checks at the top pass, as we're rebalancing the basket, we'll make sure to use an additional inputToken (malicious token), that will call `settleAuction` again.\n> \n> This second call (Call B), will execute as normal, extracting the correct amount of value in return for rebalancing, the new ibRatio is 0.9 as shown by the warden POC.\n> \n> Call B ends by setting ibRatio to 0.9, and `hasBonded` to false (which will cause a revert if you try to perform this without re-entrancy)\n> \n> However, we have already entered and Call A can resume, it now has ibRatio set to 0.9 which allows it to further extract value (as `tokensNeeded` decreases as ibRatio decreases)\n> \n> This can be extended to have further re-entrant calls and can be effectively executed until the basket is hollowed out\n> \n> This is a Miro Board to highlight the dynamics of the exploit: https://miro.com/app/board/uXjVOZk4gxw=/?invite_link_id=246345621880\n> \n> Huge props to the warden, brilliant find!\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/223#issuecomment-997411166):**\n > For mitigation:\n> - Adding a re-entrancy check would be the place to start\n> - Requiring the list of input tokens to match the output can also be useful to avoid any other shenanigans\n> - Setting the time difference (`bondTimestamp`, `auctionStart`) to be 0 would also negate the ability to further manipulate the `ibRatio`\n\n\n\n## [[H-02] `Basket.sol#auctionBurn()` A failed auction will freeze part of the funds](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/134)\n_Submitted by WatchPug_\n\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L102-L108>\n\nGiven the `auctionBurn()` function will `_burn()` the auction bond without updating the `ibRatio`. Once the bond of a failed auction is burned, the proportional underlying tokens won't be able to be withdrawn, in other words, being frozen in the contract.\n\n#### Proof of Concept\n\nWith the configuration of:\n\nbasket.ibRatio = 1e18\nfactory.bondPercentDiv = 400\nbasket.totalSupply = 400\nbasket.tokens = \\[BTC, ETH]\nbasket.weights = \\[1, 1]\n\n1.  Create an auction;\n2.  Bond with 1 BASKET TOKEN;\n3.  Wait for 24 hrs and call `auctionBurn()`;\n\n`basket.ibRatio` remains to be 1e18; basket.totalSupply = 399.\n\nBurn 1 BASKET TOKEN will only get back 1 BTC and 1 ETH, which means, there are 1 BTC and 1 ETH frozen in the contract.\n\n#### Recommended Mitigation Steps\n\nChange to:\n\n```solidity\nfunction auctionBurn(uint256 amount) onlyAuction external override {\n    handleFees();\n    uint256 startSupply = totalSupply();\n    _burn(msg.sender, amount);\n\n    uint256 newIbRatio = ibRatio * startSupply / (startSupply - amount);\n    ibRatio = newIbRatio;\n\n    emit NewIBRatio(newIbRatio);\n    emit Burned(msg.sender, amount);\n}\n```\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/134)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/134#issuecomment-997303460):**\n > The warden has identified a way for funds to be stuck without a way to recoup them, this is because `ibRatio` is not updated, while `totalSupply` is.\n> \n> Because this is a specific accounting error, which is effectively a bug in the logic of the protocol, and funds can be irrevocably lost, this is a high severity finding\n\n\n\n## [[H-03] Reentrancy in settleAuction(): malicious publisher can bypass index timelock mechanism, inject malicious index, and rug the basket](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/31)\n_Submitted by kenzo, also found by itsmeSTYJ and jonah1005_\n\nThe `settleAuction()` function calls `withdrawBounty()` before setting `auctionOngoing = false`, thereby allowing reentrancy.\n\n#### Impact\n\nA malicious publisher can bypass the index timelock mechanism and publish new index which the basket's users won't have time to respond to.\nAt worst case, this means setting weights that allow the publisher to withdraw all the basket's underlying funds for himself, under the guise of a valid new index.\n\n#### Proof of Concept\n\n1.  The publisher (a contract) will propose new valid index and bond the auction.\n\n    To settle the auction, the publisher will execute the following steps in the same transaction:\n\n2. Add a bounty of an ERC20 contract with a malicious `transfer()` function.\n\n3. Settle the valid new weights correctly (using `settleAuction()` with the correct parameters, and passing the malicious bounty id).\n\n4. `settleAuction()` will call `withdrawBounty()` which upon transfer will call the publisher's malicious ERC20 contract.\n\n5. The contract will call `settleAuction()` again, with empty parameters. Since the previous call's effects have already set all the requirements to be met, `settleAuction()` will finish correctly and call `setNewWeights()` which will set the new valid weights and set `pendingWeights.pending = false`.\n\n6. Still inside the malicious ERC20 contract transfer function, the attacker will now call the basket's `publishNewIndex()`, with weights that will transfer all the funds to him upon his burning of shares. This call will succeed to set new pending weights as the previous step set `pendingWeights.pending = false`.\n\n7. Now the malicious `withdrawBounty()` has ended, and the original `settleAuction()` is resuming, but now with malicious weights in `pendingWeights` (set in step 6). `settleAuction()` will now call `setNewWeights()` which will set the basket's weights to be the malicious pending weights.\n\n8. Now `settleAuction` has finished, and the publisher (within the same transaction) will `burn()` all his shares of the basket, thereby transferring all the tokens to himself.\n\nPOC exploit:\nPassword to both files: \"exploit\".\nAttackPublisher.sol , to be put under contracts/contracts/Exploit: <https://pastebin.com/efHZjstS>\nExploitPublisher.test.js , to be put under contracts/test: <https://pastebin.com/knBtcWkk>\n\n#### Tools Used\n\nManual analysis, hardhat.\n\n#### Recommended Mitigation Steps\n\nIn `settleAuction()`, move `basketAsERC20.transfer()` and `withdrawBounty()` to the end of the function, conforming with Checks Effects Interactions pattern.\n\n**[frank-beard (defiProtocol) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/31)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/31#issuecomment-997413099):**\n > This is a re-entrancy finding.\n> \n> There is no denying that the code is vulnerable to re-entrancy\n> \n> The warden identified the way to exploit re-entrancy by using a malicious bounty token.\n> \n> I think the finding is valid and the warden has shown how to run re-entrnacy.\n> \n> That said the POC the warden shows requires calling `publishNewIndex` which is a `onlyPublisher` function.\n> This exploit would be contingent on the publisher rugging the basket.\n>  \n> The code is:\n> - Vulnerable to re-entancy\n> - The warden showed how to trigger it\n> \n> Despite the fact that the POC is flawed, I believe this finding highlights a different vector for re-entrancy (bounty token transfers) as such I agree with a high severity\n> \n> \n\n\n\n \n# Medium Risk Findings (23)\n## [[M-01] Use safeTransfer instead of transfer](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/196)\n_Submitted by hack3r-0m, also found by itsmeSTYJ, JMukesh, leastwood, and shenwilly_\n\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L146>\n\n`transfer()` might return false instead of reverting, in this case, ignoring return value leads to considering it successful.\n\nuse `safeTransfer()` or check the return value if length of returned data is > 0.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/196)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/196#issuecomment-983125327):**\n > Agree with finding, agree with severity given the specific example given as the funds would be stuck in the contract\n\n\n\n## [[M-02] Fee on transfer tokens can lead to incorrect approval](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/236)\n_Submitted by hrkrshnn, also found by itsmeSTYJ_\n\n#### Fee on transfer tokens can lead to incorrect approval\n\nThe\n[createBasket](https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Factory.sol#L106)\nfunction does not account for tokens with fee on transfer.\n\n```solidity\nfunction createBasket(uint256 idNumber) external override returns (IBasket) {\n    // ...\n    for (uint256 i = 0; i < bProposal.weights.length; i++) {\n        IERC20 token = IERC20(bProposal.tokens[i]);\n        token.safeTransferFrom(msg.sender, address(this), bProposal.weights[i]);\n        token.safeApprove(address(newBasket), bProposal.weights[i]);\n    }\n    // ...\n}\n```\n\nThe function `safeTransferFrom` may not transfer exactly\n`bProposal.weights[i]` amount of tokens, for tokens with a fee on\ntransfer. This means that the `safeApprove` call in the next line would\nbe approving more tokens than what was received, leading to accounting\nissues.\n\n##### Recommended Mitigation Steps\n\nIt is recommended to find the balance of the current contract before and\nafter the `transferFrom` to see how much tokens were received, and\napprove only what was received.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/236#issuecomment-946911439):**\n > the protocol for now is only expected to work with defi safe, standard erc-20 tokens. \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/236#issuecomment-984191431):**\n > This finding is similar to #206 , but in contrast to it, it shows a specific way to brick / grief the protocol, as per the docs:\n> ```\n> 2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n> ```\n> \n> This is an hypothetical attack with stated assumptions\n> \n> Will not mark as duplicate and will consider this as a valid finding as it shows a specific vulnerability when paired with `feeOnTransfer` tokens\n> \n> Mitigation can be as simple as never using `feeOnTransfer` tokens\n\n\n\n## [[M-03] `onlyOwner` Role Can Unintentionally Influence `settleAuction()`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/192)\n_Submitted by leastwood_\n\n#### Impact\n\nThe `onlyOwner` role is able to make changes to the protocol with an immediate affect, while other changes made in `Basket.sol` and `Auction.sol` incur a one day timelock. As a result, an `onlyOwner` role may unintentionally frontrun a `settleAuction()` transaction by making changes to `auctionDecrement` and `auctionMultiplier`, potentially causing the auction bonder to over compensate during a rebalance. Additionally, there is no way for an auction bonder to recover their tokens in the event this does happen.\n\n#### Proof of Concept\n\n- <https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Factory.sol#L39-L59>\n- <https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L99>\n\n#### Tools Used\n\nManual code review\n\n#### Recommended Mitigation Steps\n\nConsider adding a timelock delay to all functions affecting protocol execution. Alternatively, `bondForRebalance()` can set state variables for any external calls made to `Factory.sol` (i.e. `factory.auctionMultiplier()` and `factory.auctionDecrement()`), ensuring that `settleAuction()` is called according to these expected results.\n\n**[frank-beard (Kuiper) acknowledged](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/192#issuecomment-931571215):**\n > it is assumed the owner is trustworthy in this version of the protocol, however we will add mitigations and further decentralization in future updates\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/192#issuecomment-997205975):**\n > Agree with the finding, users are taking \"owner privileges\" risks while interacting with the protocol.\n> The warden has identified a specific grief / DOS that the owner can cause\n\n\n\n## [[M-04] User can mint miniscule amount of shares, later withdraw miniscule more than deposited](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/81)\n_Submitted by kenzo_\n\nIf a user is minting small amount of shares (like 1 - amount depends on baskets weights), the calculated amount of tokens to pull from the user can be less than 1, and therefore no tokens will be pulled. However the shares would still be minted.\nIf the user does this a few times, he could then withdraw the total minted shares and end up with more tokens than he started with - although a miniscule amount.\n\n#### Impact\n\nUser can end up with more tokens than he started with. However, I didn't find a way for the user to get an amount to make this a feasible attack. He gets dust. However he can still get more than he deserves. If for some reason the basket weights grow in a substantial amount, this could give the user more tokens that he didn't pay for.\n\n#### Proof of Concept\n\nAdd the following test to `Basket.test.js`.\nThe user starts with 5e18 UNI, 1e18 COMP, 1e18 AAVE,\nand ends with 5e18+4, 1e18+4, 1e18+4.\n```js\nit(\"should give to user more than he deserves\", async () => {\n    await UNI.connect(owner).mint(ethers.BigNumber.from(UNI_WEIGHT).mul(1000000));\n    await COMP.connect(owner).mint(ethers.BigNumber.from(COMP_WEIGHT).mul(1000000));\n    await AAVE.connect(owner).mint(ethers.BigNumber.from(AAVE_WEIGHT).mul(1000000));\n\n    await UNI.connect(owner).approve(basket.address, ethers.BigNumber.from(UNI_WEIGHT).mul(1000000));\n    await COMP.connect(owner).approve(basket.address, ethers.BigNumber.from(COMP_WEIGHT).mul(1000000));\n    await AAVE.connect(owner).approve(basket.address, ethers.BigNumber.from(AAVE_WEIGHT).mul(1000000));\n\n    console.log(\"User balance before minting:\");\n    console.log(\"UNI balance: \" + (await UNI.balanceOf(owner.address)).toString());\n    console.log(\"COMP balance: \" + (await COMP.balanceOf(owner.address)).toString());\n    console.log(\"AAVE balance: \" + (await AAVE.balanceOf(owner.address)).toString());\n\n    \n    await basket.connect(owner).mint(ethers.BigNumber.from(1).div(1));\n    await basket.connect(owner).mint(ethers.BigNumber.from(1).div(1));\n    await basket.connect(owner).mint(ethers.BigNumber.from(1).div(1));\n    await basket.connect(owner).mint(ethers.BigNumber.from(1).div(1));\n    await basket.connect(owner).mint(ethers.BigNumber.from(1).div(1));\n\n    console.log(\"\\nUser balance after minting 1 share 5 times:\");\n    console.log(\"UNI balance: \" + (await UNI.balanceOf(owner.address)).toString());\n    console.log(\"COMP balance: \" + (await COMP.balanceOf(owner.address)).toString());\n    console.log(\"AAVE balance: \" + (await AAVE.balanceOf(owner.address)).toString());\n\n    await basket.connect(owner).burn(await basket.balanceOf(owner.address));\n    console.log(\"\\nUser balance after burning all shares:\");\n    console.log(\"UNI balance: \" + (await UNI.balanceOf(owner.address)).toString());\n    console.log(\"COMP balance: \" + (await COMP.balanceOf(owner.address)).toString());\n    console.log(\"AAVE balance: \" + (await AAVE.balanceOf(owner.address)).toString());\n});\n```\n\n#### Tools Used\n\nManual analysis, hardhat.\n\n#### Recommended Mitigation Steps\n\nAdd a check to `pullUnderlying`:\n```solidity\nrequire(tokenAmount > 0);\n```\n\nI think it makes sense that if a user is trying to mint an amount so small that no tokens could be pulled from him, the mint request should be denied.\nPer my tests, for an initial ibRatio, this number (the minimal amount of shares that can be minted) is 2 for weights in magnitude of 1e18, and if the weights are eg. smaller by 100, this number will be 101.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/81)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/81#issuecomment-997206834):**\n > Great find, because this finding shows a clear POC of how to extract value from the system, I agree with medium severity\n\n\n\n## [[M-05] Bonding mechanism allows malicious user to DOS auctions](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/66)\n_Submitted by kenzo, also found by goatbug_\n\nA malicious user can listen to the mempool and immediately bond when an auction starts, without aim of settling the auction. As no one can cancel his bond in less than 24h, this will freeze user funds and auction settlement for 24h until his bond is burned and the new index is deleted. The malicious user can then repeat this when a new auction starts.\n\n#### Impact\n\nDenial of service of the auction mechanism. The malicious user can hold the basket \"hostage\" and postpone or prevent implementing new index.\nThe only way to mitigate it would be to try to front-run the malicious user, obviously not ideal.\n\n#### Proof of Concept\n\npublishAllIndex:\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L170>\n\n*   The attacker would listen to this function / PublishedNewIndex event and upon catching it, immediately bond the auction.\n*   The publisher has no way to burn a bond before 24h has passed. But even if he could, it would not really help as the attacker could just bond again (though losing funds in the process).\n\nsettleAuction:\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L79>\n\n*   Only the bonder can settle.\n\nbondBurn:\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L111>\n\n*   Can only burn 24h after bond.\n\n#### Tools Used\n\nManual analysis, hardhat.\n\n#### Recommended Mitigation Steps\n\nIf we only allow one user to bond, I see no real way to mitigate this attack, because the malicious user could always listen to the mempool and immediately bond when an auction starts and thus lock it.\nSo we can change to a mechanism that allows many people to bond and only one to settle;\nbut at that point, I see no point to the bond mechanism any more. So we might as well remove it and let anybody settle the auction.\n\nWith the bond mechanism, a potential settler would have 2 options:\n\n*   Bond early: no one else will be able to bond and settle, but the user would need to leave more tokens in the basket (as newRatio starts large and decreases in time)\n*   Bond late: the settler might make more money as he will need to leave less tokens in the basket, but he risks that somebody else will bond and settle before him.\n\nWithout a bond mechanism, the potential settler would still have these equivalent 2 options:\n\n*   Settle early: take from basket less tokens, but make sure you win the auction\n*   Settle late: take from basket more tokens, but risk that somebody settles before you\n\nSo that's really equivalent to the bonding scenario.\n\nI might be missing something but at the moment I see no detriment to removing the bonding mechanism.\n\n**[frank-beard (Kuiper) acknowledged and marked as duplicate](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/66#issuecomment-946921252):**\n > https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/276\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/66#issuecomment-997207653):**\n > I think the fundamental issue here is that there can only be one bonder that rebalances, an elegant solution would be to move to a mapping of bonders that rebalance.\n> \n> Allowing anyone to bond and rebalance while still allowing the same dynamic of burning their bonds\n> \n> This would be more in line with the idea of offering bonds for discounts (Olympus Pro) to anyone as long as there's enough underlying\n> \n> I agree with the finding and believe the severity is appropriate as this effectively slows down the rebalancing by at least 2 days\n\n\n\n## [[M-06] Basket becomes unusable if everybody burns their shares](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/64)\n_Submitted by kenzo_\n\nWhile handling the fees, the contract calculates the new `ibRatio` by dividing by `totalSupply`. This can be 0 leading to a division by 0.\n\n#### Impact\n\nIf everybody burns their shares, in the next mint, `totalSupply` will be 0, `handleFees` will revert, and so nobody will be able to use the basket anymore.\n\n#### Proof of Concept\n\nVulnerable line:\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L124>\nYou can add the following test to Basket.test.js and see that it reverts:\n```js\nit(\"should divide by 0\", async () => {\nawait basket.connect(addr1).burn(await basket.balanceOf(addr1.address));\nawait basket.connect(addr2).burn(await basket.balanceOf(addr2.address));\n\n    await UNI.connect(addr1).approve(basket.address, ethers.BigNumber.from(1));\n    await COMP.connect(addr1).approve(basket.address, ethers.BigNumber.from(1));\n    await AAVE.connect(addr1).approve(basket.address, ethers.BigNumber.from(1));\n    await basket.connect(addr1).mint(ethers.BigNumber.from(1));\n});\n```\n\n#### Tools Used\n\nManual analysis, hardhat.\n\n#### Recommended Mitigation Steps\n\nAdd a check to `handleFees`: if `totalSupply= 0`, you can just return, no need to calculate new `ibRatio` / fees.\nYou might want to reset `ibRatio` to BASE at this point.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/64)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/64#issuecomment-997210497):**\n > I feel like this can also happen right after the contract was created\n> [`mintTo`](https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L76) will call `handleFees` which will revert due to division by 0\n> \n> Finding is valid\n\n\n\n## [[M-07] No minimum rate in the auction may break the protocol under network failure](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/42)\n_Submitted by jonah1005_\n\n#### Impact\n\nThe aution contract decides a new `ibRatio` in the function `settleAuction`. [Auction.sol#L89-L91](https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L91)\n\n```solidity\nuint256 a = factory.auctionMultiplier() * basket.ibRatio();\nuint256 b = (bondTimestamp - auctionStart) * BASE / factory.auctionDecrement();\nuint256 newRatio = a - b;\n```\n\nThere's a chance that `newRatio` would be really close to zero. This imposes too much risk on the protocol. The network may not really be healthy all the time. Solana and Arbitrum were down and Ethereum was suffered a forking issue recently. Also, the network may be jammed from time to time. This could cause huge damage to a protocol. Please refer to [Black Thursday for makerdao 8.32 million was liquidated for 0 dai](https://medium.com/@whiterabbit_hq/black-thursday-for-makerdao-8-32-million-was-liquidated-for-0-dai-36b83cac56b6)\n\nGiven the chance that all user may lose their money, I consider this is a medium-risk issue.\n\n#### Proof of Concept\n\n[Black Thursfay for makerdao 8.32 million was liquidated for 0 dai](https://medium.com/@whiterabbit_hq/black-thursday-for-makerdao-8-32-million-was-liquidated-for-0-dai-36b83cac56b6)\n[bug-impacting-over-50-of-ethereum-clients-leads-to-fork](https://www.theblockcrypto.com/post/115822/bug-impacting-over-50-of-ethereum-clients-leads-to-fork)\n\n#### Tools Used\n\nNone\n\n#### Recommended Mitigation Steps\n\nI recommend setting a minimum `ibRatio` when a publisher publishes a new index. The auction should be killed if the `ibRatio` is too low.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/42)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/42#issuecomment-997215459):**\n > Agree that `newRatio` decreases over time, if nothing is done it will eventually get close to 0, at which point `tokensNeeded` will tend to 0, which would mean that the amount of underlying necessary to redeem the bond decreases over time\n> \n> This can hypothetically allow to redeem the bond for extremely cheap if not for free\n> \n> The bond is denominated in the basketToken which effectively represents the value of the \"mixture\" of the tokens\n> \n> Over time, you're getting the same bond (basket) for less tokens (tokensNeeded), which also means that the basket itself is loosing value (because you can extra the excess value via bonding)\n> \n> Sounds to me like the entire `settleAuction` mechanism is devaluing the basket over time which arguably is a high severity vulnerability.\n> \n> Will continue the judging and may end up getting in touch with the sponsor over some additional risks.\n> \n> The finding is valid because it shows that the protocol can break given a specific circumstance, I do believe the warden could have found a higher severity by digging deeper\n\n\n\n## [[M-08]  settleAuction may be impossible if locked at a wrong time.](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/41)\n_Submitted by jonah1005_\n\n#### Impact\n\nThe auction contract decides a new `ibRatio` in the function `settleAuction`. [Auction.sol#L89-L91](https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L91)\n\n```solidity\nuint256 a = factory.auctionMultiplier() * basket.ibRatio();\nuint256 b = (bondTimestamp - auctionStart) * BASE / factory.auctionDecrement();\nuint256 newRatio = a - b;\n```\n\nIn this equation, `a` would not always be greater than `b`. The `  auctionBonder ` may lock the token in `bondForRebalance()` at a point that `a-b` would always revert.\n\nThe contract should not allow users to lock the token at the point that not gonna succeed. Given the possible (huge) loss of the user may suffer, I consider this is a medium-risk issue.\n\n#### Proof of Concept\n\nHere's a web3.py script to trigger this bug.\n\n```python\nbasket.functions.publishNewIndex([dai.address], [deposit_amount]).transact()\n\nfor i in range(4 * 60 * 24):\n    w3.provider.make_request('evm_mine', [])\nbasket.functions.publishNewIndex([dai.address], [deposit_amount]).transact()\n\nprint('auction on going', auction.functions.auctionOngoing().call())\nfor i in range(20000):\n    w3.provider.make_request('evm_mine', [])\n\nall_token = basket.functions.balanceOf(user).call()\nbasket.functions.approve(auction.address, all_token).transact()\nauction.functions.bondForRebalance().transact()\n# error Log\n# {'code': -32603, 'message': 'Error: VM Exception while processing transaction: reverted with panic code 0x11 (Arithmetic operation underflowed or overflowed outside of an unchecked block)'}\nauction.functions.settleAuction([], [], [], [], []).transact()\n```\n\n#### Tools Used\n\nNone\n\n#### Recommended Mitigation Steps\n\nRecommend to calculate the new irate in `bondForRebalance`. I understand the `auctionBonder` should take the risk to get the profit. However, the contract should protect the user in the first place when this auction is doomed to fail.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/41)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/41#issuecomment-997222428):**\n > I do not believe the users are at risk of a specific loss as they can always redeem their shares for underlying `Basket.burn`\n> However, this is still a valid finding, and the external conditions make medium severity appropriate\n\n\n\n## [[M-09] Fee calculation is potentially incorrect](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/129)\n_Submitted by itsmeSTYJ_\n\n#### Impact\n\nMore fees are actually charged than intended\n\n#### Mitigation Steps\n\n[Basket.sol line 118](https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L118)\n\nAssume that license fee is 10% i.e. 1e17 and time diff = half a year.\n\nWhen you calculate `feePct`, you expect to get 5e16 since that's 5% and the actual amount of fee to be charged should be totalSupply \\* feePct (5) / BASE (100) but on line 118, we are actually dividing by BASE - feePct i.e. 95.\n\n5 / 95 = 0.052 instead of the intended 0.05.\n\nSolution is to replace `BASE - feePct` in the denominator with `BASE`.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/129)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/129#issuecomment-997228019):**\n > The warden identified an inconsistency with the math that charged more fees than intended\n\n\n\n## [[M-10] `burn` and `mintTo` in `Basket.sol` vulnerable to reentrancy](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/248)\n_Submitted by 0xalpharush, also found by hack3r-0m, JMukesh, and johnsterlacci_\n\n#### Impact\n\nThe functions [mintTo](https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L82)\nand [burn](https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Basket.sol#L96) make external calls prior to updating the state. If a basket contains an ERC777 token, attackers can mint free basket tokens.\n\n#### Proof of Concept\n\nAn attacker could reenter the `mintTo` function when the contract pulls an ERC777 token from the user and mint more tokens than they deposited.\n\n#### Tools Used\n\nSlither\n\n#### Recommended Mitigation Steps\n\nMove external calls after state updates. It is best practice to make external calls after updating state in accordance with the check-effect-interact pattern.\n\n**[frank-beard (Kuiper) acknowledged](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/248#issuecomment-929628079):**\n > For now we are only concerned with 'Defi Safe' tokens that conform to the erc-20 standard. It is expected that publishers and users should do due diligence when adding assets to a basket\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/248#issuecomment-997301870):**\n > I agree with the warden finding that the function can be subject to re-entrancy.\n> \n> Because the exploit is dependent on the token of choice, this is not a guarantee but rather the possibility of the system being vulnerable.\n> \n> I highly recommend the sponsor to add re-entrancy checks.\n> \n> As for the finding, because it is conditional on using a vulnerable token, I'll downgrade to medium severity as it requires an external condition for the re-entrance to be possible\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/248#issuecomment-1001268732):**\n > After re-review I agree with medium severity on reentrancy findings on burn and mint, in contract with the \"generic\" re-entrancy finding with the additional bounties that lack any poc.\n> \n> The findings with specific poc have been rated as separate findings (some of which have high risk) as they show an actual way to exploit the protocol\n\n\n\n## [[M-11] Owner can steal all Basket funds during auction](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/265)\n_Submitted by 0xsanson_\n\n#### Impact\n\nThe owner of Factory contract can modify the values of `auctionMultiplier` and `auctionDecrement` at any time.\nDuring an auction, these values are used to calculate `newRatio` and thereby `tokensNeeded`: specifically, it's easy to set the factory parameters so that `tokensNeeded = 0` (or close to zero) for every token.\nThis way the owner can participate at an auction, change the parameters, and get the underlying tokens from a Basket without transferring any pending tokens.\n\n#### Proof of Concept\n\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L89-L99>\n\n#### Tools Used\n\neditor\n\n#### Recommended Mitigation Steps\n\nConsider adding a Timelock to these Factory functions. Otherwise a way to not modify them if an auction is ongoing (maybe Auction saves the values it reads when `startAuction` is called).\n\n**[frank-beard (Kuiper) confirmed and disagreed with severity](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/265#issuecomment-929613048):**\n > the owner for this is intended to be a dao that acts in support of the protocol, however this is a good point to the centralization concerns for the protocol, we will most likely manage this by adding a timelock to these function\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/265#issuecomment-997302120):**\n > Agree with the finding from the warden, highly recommend the sponsor to add these possibilities in their docs to make it easy for users to understand them.\n> \n> That said, a possible remediation would also be to add checks in the setters, to avoid for these specific edge cases.\n> \n> Because the exploit is dependent on an external condition (setting to a specific value by governance), the finding is of medium severity\n\n\n\n## [[M-12] Factory.sol - lack of checks in `setAuctionDecrement` will cause reverts in Auction::settleAuction()](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/119)\n_Submitted by Alex the Entreprenerd, also found by goatbug_\n\n#### Impact\n\n`setAuctionDecrement` doesn't check for a min nor a max amount\nThis means we can change `auctionDecrement` which would allow `owner` to set `auctionDecrement` to 0\n\nThis will cause the function `settleAuction` in Auction.sol to revert\n\nThis allows the owner to block auctions from being settled\n\n#### Proof of Concept\n\n`setAuctionDecrement(0)`\nNow `settleAuction` will revert due to division by 0\n\n#### Recommended Mitigation Steps\n\nAdd checks in `setAuctionDecrement`\nRefactor to\n```solidity\nfunction setAuctionDecrement(uint256 newAuctionDecrement) public override onlyOwner {\n    require(newAuctionDecrement > AMOUNT);\n    require(newAuctionDecrement <= AMOUNT\\_2);\n    auctionDecrement = newAuctionDecrement;\n}\n```\n\n**[frank-beard (Kuiper) acknowledged and disagreed with severity](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/119#issuecomment-929647365):**\n > the owner for this is intended to be a dao that acts in support of the protocol, however this is a good point to the centralization concerns for the protocol, we will most likely manage this by adding a timelock to these function\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/119#issuecomment-997302382):**\n > I wrote the finding and in being the contest judge will be forfeiting all winnings.\n> \n> After thinking about it, this is a medium severity finding because it is a DOS that relies on a specific condition.\n> While the argument that the owner can be being always hold up, it is important that protocol users understand the risk, so it's important to flag up admin privileges\n\n\n\n## [[M-13] lack of checks in `Factory::setBondPercentDiv` allow owner to prevent bonding in Auction::bondForRebalance()](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/121)\n_Submitted by Alex the Entreprenerd, also found by goatbug_\n\n#### Impact\n\n`setBondPercentDiv` has no checks for min and max\n\nSetting `bondPercentDiv` to 0 will cause `Auction::bondForRebalance()` to revert\n\nThis allows the owner to prevent bonding by setting the `bondPercentDiv` to 0\n\n#### Recommended Mitigation Steps\n\nRefactor to\n\n```solidity\nfunction setBondPercentDiv(uint256 newBondPercentDiv) public override onlyOwner {\n    require(newBondPercentDiv > AMOUNT);\n    require(newBondPercentDiv <= AMOUNT_2);\n    bondPercentDiv = newBondPercentDiv;\n}\n```\n\n**[frank-beard (Kuiper) acknowledged and disagreed with severity](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/121#issuecomment-929647297):**\n > the owner for this is intended to be a dao that acts in support of the protocol, however this is a good point to the centralization concerns for the protocol, we will most likely manage this by adding a timelock to these function\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/121#issuecomment-997302531):**\n > Similarly to #119 \n> - Am forfeiting my wins\n> - Always important to flag up admin privileges so people can use the protocol while being aware of the risks they are undertaking\n> - Medium severity as depends on a specific config\n\n\n\n## [[M-14] `Basket.sol#handleFees()` could potentially cause disruption of minting and burning](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/79)\n_Submitted by WatchPug_\n\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L110-L129>\n\n```solidity\nfunction handleFees() private {\n    if (lastFee == 0) {\n        lastFee = block.timestamp;\n    } else {\n        uint256 startSupply = totalSupply();\n\n        uint256 timeDiff = (block.timestamp - lastFee);\n        uint256 feePct = timeDiff * licenseFee / ONE_YEAR;\n        uint256 fee = startSupply * feePct / (BASE - feePct);\n\n        _mint(publisher, fee * (BASE - factory.ownerSplit()) / BASE);\n        _mint(Ownable(address(factory)).owner(), fee * factory.ownerSplit() / BASE);\n        lastFee = block.timestamp;\n\n        uint256 newIbRatio = ibRatio * startSupply / totalSupply();\n        ibRatio = newIbRatio;\n\n        emit NewIBRatio(ibRatio);\n    }\n}\n```\n\n`timeDiff * licenseFee` can be greater than `ONE_YEAR` when `timeDiff` and/or `licenseFee` is large enough, which makes `feePct` to be greater than `BASE` so that `BASE - feePct` will revert on underflow.\n\n#### Impact\n\nMinting and burning of the basket token are being disrupted until the publisher update the `licenseFee`.\n\n#### Proof of Concept\n\n1.  Create a basket with a `licenseFee` of `1e19` or 1000% per year and mint 1 basket token;\n2.  The basket remain inactive (not being minted or burned) for 2 months;\n3.  Calling `mint` and `burn` reverts at `handleFees()`.\n\n#### Recommended Mitigation Steps\n\nLimit the max value of `feePct`.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/79)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/79#issuecomment-997304574):**\n > The finding is valid, there are conditions that would cause `feePct` to be greater than `BASE`\n> \n> The conditions to trigger this seem to be: \n> - Wait enough time\n> - Have a high enough fee\n> \n> Because this can happen under specific conditions, I will grade this finding as medium severity:\n> \n> I would highly recommend the sponsor to consider the possibility of capping the `licenseFee` to make it easier to predict cases in which the operation can revert\n\n\n\n## [[M-15] `Auction.sol#settleAuction()` late auction bond could potentially not being able to be settled, cause funds loss to bonder](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/90)\n_Submitted by WatchPug_\n\nThe `newRatio` that determines `tokensNeeded` to settle the auction is calculated based on `auctionMultiplier`, `bondTimestamp - auctionStart` and `auctionDecrement`.\n\n```solidity\nuint256 a = factory.auctionMultiplier() * basket.ibRatio();\nuint256 b = (bondTimestamp - auctionStart) * BASE / factory.auctionDecrement();\nuint256 newRatio = a - b;\n```\n\nHowever, if an auction is bonded late (`bondTimestamp - auctionStart` is a large number), and/or the `auctionMultiplier` is small enough, and/or the `auctionDecrement` is small enough, that makes `b` to be greater than `a`, so that `uint256 newRatio = a - b;` will revert on underflow.\n\nThis might seem to be an edge case issue, but considering that a rebalance auction of a bag of shitcoin to high-value tokens might just end up being bonded at the last minute, with a `newRatio` near zero. When we take the time between the bonder submits the transaction and it got packed into a block, it's quite possible that the final `bondTimestamp` gets large enough to revet `a - b`.\n\n##### Impact\n\nAn auction successfully bonded by a regular user won't be able to be settled, and the user will lose the bond.\n\n##### Proof of Concept\n\nWith the configuration of:\n\nbasket.ibRatio = 1e18\nfactory.auctionDecrement = 5760 (Blocks per day)\nfactory.auctionMultiplier = 2\n\n1.  Create an auction;\n2.  The auction remain inactive (not get bonded) for more than 2 days (>11,520 blocks);\n3.  Call `bondForRebalance()` and it will succeed;\n4.  Calling `settleAuction()` will always revert.\n\n##### Recommended Mitigation Steps\n\nCalculate and require `newRatio > 0` in `bondForRebalance()`, or limit the max value of decrement and make sure newRatio always > 0 in `settleAuction()`.\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/90)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/90#issuecomment-997305014):**\n > Finding is valid, there are cases that can cause a - b to revert\n> \n> The finding is reliant on external condition (multiplier being low and / or bonding late) as such I believe this to be a medium severity finding.\n> \n> Note for the sponsor: The cause for reverts should get clearer with time (as people use the protocol), you definitely want to model these revert behaviour to avoid edge cases that will make funds stuck\n\n\n\n## [[M-16] `Auction.sol#settleAuction()` Mishandling bounty state could potentially disrupt `settleAuction()`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/136)\n_Submitted by WatchPug_\n\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L143>\n\n```solidity\nfunction withdrawBounty(uint256[] memory bountyIds) internal {\n    // withdraw bounties\n    for (uint256 i = 0; i < bountyIds.length; i++) {\n        Bounty memory bounty = _bounties[bountyIds[i]];\n        require(bounty.active);\n\n        IERC20(bounty.token).transfer(msg.sender, bounty.amount);\n        bounty.active = false;\n\n        emit BountyClaimed(msg.sender, bounty.token, bounty.amount, bountyIds[i]);\n    }\n}\n```\n\nIn the `withdrawBounty` function, `bounty.active` should be set to `false` when the bounty is claimed.\n\nHowever, since `bounty` is stored in memory, the state update will not succeed.\n\n##### Impact\n\nAn auction successfully bonded by a regular user won't be able to be settled if they passed seemly active bountyIds, and the bonder will lose the bond.\n\n##### Proof of Concept\n\n1.  Create an auction;\n2.  Add a bounty;\n3.  Auction settled with bounty claimed;\n4.  Create a new auction;\n5.  Add a new bounty;\n6.  Calling `settleAuction()` with the bountyIds of the 2 seemly active bounties always reverts.\n\n##### Recommended Mitigation Steps\n\nChange to:\n\n```solidity\nBounty storage bounty = _bounties[bountyIds[i]];\n```\n\n[frank-beard (Kuiper) confirmed and marked as duplicate](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/136#issuecomment-936623596):**\n > duplicate of https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/136#issuecomment-997414434):**\n > Finding is valid, because the warden didn't provide a POC of how to steal user funds, the finding is of medium severity\n\n\n\n## [[M-17] Unsafe approve would halt the auction and burn the bond](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/35)\n_Submitted by jonah1005, also found by 0xRajeev, 0xsanson, cmichel, and itsmeSTYJ_\n\n#### Impact\n\n[Basket.sol#L224-L228](https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L224-L228) calls approve that do not handle non-standard erc20 behavior.\n\n1.  Some token contracts do not return any value.\n2.  Some token contracts revert the transaction when the allowance is not zero.\n\nSince the auction contract calls `setNewWeights` in function `settleAuction`, `auctionBonder` may lock its bond and never successfully settles the auction. This leads to the `auctionBonder` loss he's bond and the basket and the auction becomes suspended.\n\n`auctionBonder` would lose his bond and the contract would be suspended. I consider this a high-risk issue.\n\n#### Proof of Concept\n\nUSDT may be a classic non-standard erc20 token.\n\nHere's a short POC.\n\n```python\nusdt.functions.approve(basket.address, 100).transact()\n## the second tx would be reverted as the allowance is not zero\nusdt.functions.approve(basket.address, 50).transact()\n```\n\n#### Tools Used\n\nNone\n\n#### Recommended Mitigation Steps\n\nRecommend to use `safeApprove` instead and set the allowance to 0 before calling it.\n\n```solidity\nfunction approveUnderlying(address spender) private {\n    for (uint256 i = 0; i < weights.length; i++) {\n        IERC20(tokens[i]).safeApprove(spender, 0);\n        IERC20(tokens[i]).safeApprove(spender, type(uint256).max);\n    }\n}\n```\n\n**[frank-beard (Kuiper) marked as duplicate](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/35#issuecomment-929652005):**\n > duplicate of https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/260\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/35#issuecomment-997415208):**\n > Agree with the finding, because this is contingent on an external condition (token being USDT) the finding is of medium severity\n\n\n\n## [[M-18] licenseFee can be greater than BASE](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/104)\n_Submitted by itsmeSTYJ_\n\n#### Impact\n\nWorst case - no functions that contains `handleFees()` can pass because [line 118](https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Basket.sol#L118) will always underflow and revert. You only need `feePct` to be bigger than `BASE` for the `handleFees()` function to fail which will result in a lot of gas wasted and potentially bond burnt.\n\nI did not classify this as high risk because a simple fix would be to simply reduce the licenseFee via `changeLicenseFee`.\n\n#### Recommended Mitigation Steps\n\nAdd these require statement to the following functions:\n\n*   Basket.changeLicenseFee()\n    *   `require(newLicenseFee <= BASE, \"changeLicenseFee: license fee cannot be greater than 100%\");`\n*   Factory.proposeBasketLicense()\n    *   `require(licenseFee <= BASE, \"proposeBasketLicense: license fee cannot be greater than 100%\");`\n\n**[frank-beard (Kuiper) acknowledged](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/104)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/104#issuecomment-997467988):**\n > Agree with the finding, the warden highlighted an admin exploit that allows to DOS the basket.\n> Adding a check not only prevents the exploit, but gives a security guarantee to the protocol users\n\n\n\n## [[M-19] Scoop ERC20 tokens from basket contract](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/56)\n_Submitted by gpersoon_\n\n#### Impact\n\nSuppose some unrelated ERC20 tokens end up in the basket contract  (via an airdrop, a user mistake etc)\n\nThen anyone can do a `bondForRebalance()` and `settleAuction()` to scoop these tokens.\n\nThe function `settleAuction()` allows you to specify an outputToken, so also completely unrelated tokens.\nThus you can retrieve additional tokens with  `settleAuction()`\n\n#### Proof of Concept\n\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/main/contracts/contracts/Auction.sol#L69>\nfunction settleAuction(..  address\\[] memory outputTokens, uint256\\[] memory outputWeights) public override {\n...\nfor (uint256 i = 0; i < outputTokens.length; i++) {\nIERC20(outputTokens\\[i]).safeTransferFrom(address(basket), msg.sender, outputWeights\\[i]);\n}\n\n#### Recommended Mitigation Steps\n\nCheck outputTokens are part of the previous basket tokens  (e.g. `basket.tokens()` )\n\n**[frank-beard (Kuiper) acknowledged](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/56)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/56#issuecomment-997468442):**\n > If the Auction contract has any ERC20 that is not checked against the require, those tokens can be taken away for free.\n> The warden didn't directly mention this, but this can also apply to bounties.\n> Any bounty specified in a token that is not protected can be taken without claiming the bounty (as the require won't check for it)\n> \n> I think that the finding has appropriate severity, although the warden didn't directly mention the ability to steal bounties\n\n\n\n## [[M-20] Auction multiplier set to zero](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/242)\n_Submitted by goatbug_\n\n#### Impact\n```solidity\nfunction setAuctionMultiplier(uint256 newAuctionMultiplier) public override onlyOwner {\n    auctionMultiplier = newAuctionMultiplier;\n}\n```\n\nauction multiplier can be set to zero by factory owner. This would stop the auction settling, function would always revert.\n```solidity\nuint256 a = factory.auctionMultiplier() * basket.ibRatio();\n    uint256 b = (bondTimestamp - auctionStart) * BASE / factory.auctionDecrement();\n    uint256 newRatio = a - b;\n```\n\ncausing a safe math error and `newRatio` to revert.\n\n#### Proof of Concept\n\nProvide direct links to all referenced code in GitHub. Add screenshots, logs, or any other relevant proof that illustrates the concept.\n\n#### Recommended Mitigation Steps\n\n**[frank-beard (Kuiper) acknowledged and disagreed with severity](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/242#issuecomment-931568844):**\n > it is assumed the owner is trustworthy in this version of the protocol, however we will add mitigations and further decentralization in future updates\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/242#issuecomment-997469832):**\n > Agree with the finding, because the warden showed a specific \"admin privilege\" that DOSses the protocol, the finding is valid and of medium severity\n\n\n\n## [[M-21] Zero weighted baskets are allowed to steal funds](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/21)\n_Submitted by csanuragjain_\n\n#### Impact\n\nIt was observed that Publisher is allowed to create a basket with zero token and weight. This can lead to user fund stealing as described in below poc\nThe issue was discovered in `validateWeights` function of Basket contract\n\n#### Proof of Concept\n\n1.  User proposes a new Basket with 0 tokens and weights using `proposeBasketLicense` function in Factory contract\n\n```solidity\nProposal memory proposal = Proposal({\n        licenseFee: 10,\n        tokenName: abc,\n        tokenSymbol: aa,\n        proposer: 0xabc,\n        tokens: {},\n        weights: {},\n        basket: address(0)\n});\n```\n\n2.  `validateWeights` function is called and it returns success as the only check performed is `\\_tokens.length == \\_weights.length (0=0)`\n\n```solidity\nfunction validateWeights(address[] memory _tokens, uint256[] memory _weights) public override pure {\n    require(_tokens.length == _weights.length);\n    uint256 length = _tokens.length;\n    address[] memory tokenList = new address[](length);\n\n    // check uniqueness of tokens and not token(0)\n\n    for (uint i = 0; i < length; i++) {\n        ...\n    }\n}\n```\n\n3.  A new proposal gets created\n```solidity\n   _proposals.push(proposal);\n```\n\n4.  User creates new Basket with this proposal using `createBasket` function\n\n```solidity\nfunction createBasket(uint256 idNumber) external override returns (IBasket) {\n    Proposal memory bProposal = _proposals[idNumber];\n    require(bProposal.basket == address(0));\n\n    ....\n\n    for (uint256 i = 0; i < bProposal.weights.length; i++) {\n        ...\n    }\n    ...\n    return newBasket;\n}\n```\n\n5.  Since no weights and tokens were in this proposal so no token transfer is required (`bProposal.weights.length` will be 0 so loop won't run)\n\n6.  Basket gets created and user becomes publisher for this basket\n\n```solidity\nnewBasket.mintTo(BASE, msg.sender);\n_proposals[idNumber].basket = address(newBasket);\n```\n\n7.  Publisher owned address calls the mint function with say amount 10 on `Basket.sol` contract\n\n```solidity\nfunction mint(uint256 amount) public override {\n    mintTo(amount, msg.sender);\n}\n\nfunction mintTo(uint256 amount, address to) public override {\n    ...\n\n    pullUnderlying(amount, msg.sender);\n\n    _mint(to, amount);\n\n    ...\n}\n```\n\n8.  Since there is no weights so `pullUnderlying` function does nothing (weights.length is 0)\n\n```solidity\nfunction pullUnderlying(uint256 amount, address from) private {\n    for (uint256 i = 0; i < weights.length; i++) {\n        uint256 tokenAmount = amount * weights[i] * ibRatio / BASE / BASE;\n        IERC20(tokens[i]).safeTransferFrom(from, address(this), tokenAmount);\n    }\n}\n```\n\n9.  Full amount 10 is minted to Publisher owned address setting `balanceOf(msg.sender) = 10`\n\n```solidity\n_mint(to, amount);\n```\n\n10. Now Publisher calls the `publishNewIndex` to set new weights. Since `pendingWeights.pending` is false, else condition gets executed\n\n```solidity\nfunction publishNewIndex(address[] memory _tokens, uint256[] memory _weights) onlyPublisher public override {\n    validateWeights(_tokens, _weights);\n\n    if (pendingWeights.pending) {\n        require(block.number >= pendingWeights.block + TIMELOCK_DURATION);\n        if (auction.auctionOngoing() == false) {\n            auction.startAuction();\n\n            emit PublishedNewIndex(publisher);\n        } else if (auction.hasBonded()) {\n\n        } else {\n            auction.killAuction();\n\n            pendingWeights.tokens = _tokens;\n            pendingWeights.weights = _weights;\n            pendingWeights.block = block.number;\n        }\n    } else {\n        pendingWeights.pending = true;\n        pendingWeights.tokens = _tokens;\n        pendingWeights.weights = _weights;\n        pendingWeights.block = block.number;\n    }\n}\n```\n\n11. Publisher calls the `publishNewIndex` again which starts the Auction. This auction is later settled using the `settleAuction` function in Auction contract\n\n12. Publisher owned address can now call burn and get the amount 10 even though he never made the payment since his `balanceOf(msg.sender) = 10` (Step 9)\n\n```solidity\nfunction burn(uint256 amount) public override {\n    require(auction.auctionOngoing() == false);\n    require(amount > 0);\n    require(balanceOf(msg.sender) >= amount);\n\n    handleFees();\n\n    pushUnderlying(amount, msg.sender);\n    _burn(msg.sender, amount);\n    \n    emit Burned(msg.sender, amount);\n}\n```\n#### Recommended Mitigation Steps\n\nChange `validateWeights` to check for 0 length token\n\n```solidity\nfunction validateWeights(address[] memory _tokens, uint256[] memory _weights) public override pure {\n    require(_tokens.length>0);\n    ...\n}\n```\n\n**[frank-beard (defiProtocol) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/21)**  \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/21#issuecomment-997499391):**\n > The warden identified a way to the publisher to effectively mint a ton of shares by setting weights to zero, for them to then change the weights and use their shares to dilute depositors.\n> \n> This may be a potential feature of the protocol at this time as there's no check for how the ratios relate to themselves\n> \n> The implications are actually pretty deep and I highly recommend the sponsor to consider the fact that if weights can be changed at any time by the publisher, they can effectively dilute / re-base the basket at any time very aggressively, to the detriment of users.\n> \n> As for the the finding by the warden, they have shown a specific way for the publisher to dilute other depositors, by setting up a basket with zero tokens initially.\n> \n> Becasue this is a specific attack that relies on external conditions, I'm downgrading the severity to medium\n\n\n\n## [[M-22] Incorrect data location specifier can be abused to cause DoS and fund loss](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168)\n_Submitted by 0xRajeev, also found by bw and pauliax_\n\n#### Impact\n\nThe `withdrawBounty()` loops through the `\\_bounties` array looking for active bounties and transferring amounts from active ones. However, the data location specifier used for bounty is memory which makes a copy of the `\\_bounties` array member instead of a reference. So when bounty.active is set to false, this is changing only the memory copy and not the array element of the storage variable. This results in bounties never being set to inactive, keeping them always active forever and every `withdrawBounty()` will attempt to transfer bounty amount from the Auction contract to the msg.sender.\n\nTherefore, while the transfer will work the first time, subsequent attempts to claim this bounty will revert on transfer (because the Auction contract will not have required amount of bounty tokens) causing `withdrawBounty()` to always revert and therefore preventing settling of any auction.\n\nA malicious attacker can add a tiny bounty on any/every Auction contract to prevent any reindexing on that contract to happen because it will always revert on auction settling. This can be used to cause DoS on any `auctionBonder` so as to make them lose their bondAmount because their bonded auction cannot be settled.\n\n#### Proof of Concept\n\n- <https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L143>\n\n- <https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L143-L147>\n\n- <https://docs.soliditylang.org/en/v0.8.7/types.html#data-location-and-assignment-behaviour>\n\n#### Tools Used\n\nManual Analysis\n\n#### Recommended Mitigation Steps\n\nRecommend changing storage specifier of bounty to \"storage\" instead of “memory\".\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168)**  \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168#issuecomment-997414247):**\n > Great find, adding the same bounty multiple times can allow the exploiter to drain the entire contract as long as the bounties are denominated in the underlying token\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/168#issuecomment-999137782):**\n > Because the warden shows a way to cause DOS, which is contingent on setting it as well as redeeming that bounty (which can be avoided by simply not adding it to the bountiesID calldata), I will rate this finding as Medium Severity\n> \n> The DOS is low severity as it can be sidestep very easily, see #82 \n> \n> However, the warden has identified a technical issue with the protocol (unflagging of bounty), as such I agree with a medium severity\n\n\n\n## [[M-23] Auction settler can steal user funds if bond timestamp is high enough](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45)\n_Submitted by kenzo_\n\nAfter an auction has started, as time passes and according to the `bondTimestamp`, `newRatio` (which starts at `2\\*ibRatio`) gets smaller and smaller and therefore less and less tokens need to remain in the basket.\nThis is not capped, and after a while, `newRatio` can become smaller than current `ibRatio`.\n\n#### Impact\n\nIf for some reason nobody has settled an auction and the publisher didn't stop it, a malicious user can wait until `newRatio < ibRatio`, or even until `newRatio \\~= 0` (for an initial `ibRatio` of \\~1e18 this happens after less than 3.5 days after auction started), and then bond and settle and steal user funds.\n\n#### Proof of Concept\n\nThese are the vulnerable lines:\n<https://github.com/code-423n4/2021-09-defiProtocol/blob/52b74824c42acbcd64248f68c40128fe3a82caf6/contracts/contracts/Auction.sol#L89:#L99>\n\n```solidity\nuint256 a = factory.auctionMultiplier() * basket.ibRatio();\nuint256 b = (bondTimestamp - auctionStart) * BASE / factory.auctionDecrement();\nuint256 newRatio = a - b;\n\nfor (uint256 i = 0; i < pendingWeights.length; i++) {\n    uint256 tokensNeeded = basketAsERC20.totalSupply() * pendingWeights[i] * newRatio / BASE / BASE;\n    require(IERC20(pendingTokens[i]).balanceOf(address(basket)) >= tokensNeeded);\n}\n```\n\nThe function verifies that `pendingTokens[i].balanceOf(basket) >= basketAsERC20.totalSupply() * pendingWeights[i] * newRatio / BASE / BASE`. This is the formula that will be used later to mint/burn/withdraw user funds.\nAs bondTimestamp increases, newRatio will get smaller, and there is no check on this.\nAfter a while we'll arrive at a point where `newRatio ~= 0`, so `tokensNeeded = newRatio*(...) ~= 0`, so the attacker could withdraw nearly all the tokens using outputTokens and outputWeights, and leave just scraps in the basket.\n\n#### Tools Used\n\nManual analysis, hardhat.\n\n#### Recommended Mitigation Steps\n\nYour needed condition/math might be different, and you might also choose to burn the bond while you're at it, but I think at the minimum you should add a sanity check in settleAuction:\n\n    require (newRatio > basket.ibRatio());\n\n**[frank-beard (Kuiper) confirmed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45)**  \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45#issuecomment-997472588):**\n > Would need confirmation from the sponsor here (this finding was also submitted on the more recent contest)\n> As discount is part of the protocol (I think)\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45#issuecomment-997499754):**\n > @frank-beard is the discount a feature or a bug?\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/45#issuecomment-1001265126):**\n > As per this discussion: https://github.com/code-423n4/2021-10-defiprotocol-findings/issues/51\n> \n> The finding is valid and of medium severity\n\n# Low Risk Findings (45)\n- [[L-01] Not handling approve return value](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/73) _Submitted by WatchPug_\n- [[L-02] licenseFee state variable not checked for maximum value (Basket.sol)](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/200) _Submitted by ye0lde_\n- [[L-03] No input validation on parameter changes](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/274) _Submitted by anon_\n- [[L-04] block.timestamp is a better timer than block.number](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/271) _Submitted by anon_\n- [[L-05] Add nonreentrant modifiers to external methods in 2 files](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/270) _Submitted by anon, also found by 0xRajeev, 0xsanson, goatbug, and pauliax_\n- [[L-06] Missing Zero-Address Checks](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/86) _Submitted by shenwilly, also found by 0xRajeev and JMukesh_\n- [[L-07] Check the actual amounts transferred](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/206) _Submitted by pauliax_\n- [[L-08] Variable assignment has no effect](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/124) _Submitted by nikitastupin_\n- [[L-09] Lack of Event Logging and Input Validation](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/193) _Submitted by leastwood_\n- [[L-10] Inaccurate log emitted at deleteNewIndex](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/58) _Submitted by kenzo_\n- [[L-11] Cannot change pending while timelocked](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/30) _Submitted by joeysantoro_\n- [[L-12] DAO is fee recipient / cannot revoke owner](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/27) _Submitted by joeysantoro_\n- [[L-13] tokensNeeded can potentially be 0](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/101) _Submitted by itsmeSTYJ_\n- [[L-14] Proposals can never get created due to reaching `block.gaslimit`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/235) _Submitted by hrkrshnn_\n- [[L-15] Sanity checks when the contract parameters are updated](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/234) _Submitted by hrkrshnn_\n- [[L-16] Event params are of no practical value](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/163) _Submitted by hack3r-0m_\n- [[L-17] handleFees() will revert if licenseFee is too high](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/52) _Submitted by gpersoon_\n- [[L-18] initialize of Basket.sol is missing initializer ](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/50) _Submitted by gpersoon, also found by 0xRajeev and loop_\n- [[L-19] Lack of zero ratio validation](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/83) _Submitted by defsec_\n- [[L-20] Global bounties variable and 0 bounty allow dos in bounty functionality of basket](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/25) _Submitted by csanuragjain_\n- [[L-21] `newIbRatio` update math depends on how often it's called](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/224) _Submitted by cmichel_\n- [[L-22] Setting wrong publisher cannot be undone](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/222) _Submitted by cmichel_\n- [[L-23] Re-entrancy in `Factory.createBasket`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/219) _Submitted by cmichel_\n- [[L-24] Wrong constant for `ONE_DAY`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/218) _Submitted by cmichel, also found by 0xRajeev_\n- [[L-25] specs not according to the docs](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/115) _Submitted by JMukesh_\n- [[L-26] lack of checking of array length](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/111) _Submitted by JMukesh, also found by 0xRajeev_\n- [[L-27] lack of checks in Factory.setAuctionMultiplier](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/120) _Submitted by Alex the Entreprenerd_\n- [[L-28] Factory.sol - lack of checks for setMinLicenseFee](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/118) _Submitted by Alex the Entreprenerd_\n- [[L-29] `handleFees` reverts if supply is zero](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/264) _Submitted by 0xsanson_\n- [[L-30] Recognize the risk of using approve](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/190) _Submitted by 0xRajeev_\n- [[L-31] Resetting partial struct fields is risky](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/189) _Submitted by 0xRajeev_\n- [[L-32] Publisher role cannot be renounced](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/185) _Submitted by 0xRajeev_\n- [[L-33] Missing support for (preventing) use of deflationary tokens in baskets](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/177) _Submitted by 0xRajeev_\n- [[L-34] Risk of duplicate/scam basket token names/symbols may trick users](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/176) _Submitted by 0xRajeev_\n- [[L-35] Missing sanity/threshold checks on critical contract parameter initializations](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/173) _Submitted by 0xRajeev_\n- [[L-36] Missing timelocks for critical protocol parameter setters by owner](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/172) _Submitted by 0xRajeev_\n- [[L-37] Timelock period may be less than 24 hours because it depends on `block.number` instead of `block.timestamp`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/122) _Submitted by nikitastupin_\n- [[L-38] Missing Transfer Ownership Pattern](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/62) _Submitted by leastwood_\n- [[L-39] initialize function in basket.sol can be front-run](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/3) _Submitted by jah_\n- [[L-40] use of approve() instead of safeApprove()](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/114) _Submitted by JMukesh, also found by defsec_\n- [[L-41] block timestamp manipulation can cause fees change](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/195) _Submitted by aga7hokakological_\n- [[L-42] `Auction.sol#settleAuction()` addBounty with a fake token could potentially disrupt `settleAuction()`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/82) _Submitted by WatchPug_\n- [[L-43]  Incorrectly used new publisher and new licenseFee cannot be changed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/186) _Submitted by 0xRajeev_\n- [[L-44] `Factory.sol` Lack of two-step procedure and/or input validation routines for critical operations leaves them error-prone](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/89) _Submitted by WatchPug, also found by 0xRajeev_\n- [[L-45] malicious tokens could be added with addBounty](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/55) _Submitted by gpersoon, also found by jonah1005 and leastwood_\n\n# Non-Critical Findings (39)\n- [[N-01] Using delete to clear variables instead of zero assignment](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/149) _Submitted by 0xRajeev_\n- [[N-02]  Protocol owner fee limit not verified correctly (Factory.sol)](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/127) _Submitted by ye0lde_\n- [[N-03] Style issues](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/217) _Submitted by pauliax_\n- [[N-04] emit NewIBRatio in function initialize](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/205) _Submitted by pauliax_\n- [[N-05] Hardcoding numbers is error-prone](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/203) _Submitted by pauliax_\n- [[N-06] Inconvenient to find bounty ids](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/202) _Submitted by pauliax_\n- [[N-07] Timelocked functions doesn't emit proposal events](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/123) _Submitted by nikitastupin, also found by JMukesh and WatchPug_\n- [[N-08] `proposal` declared as both a function and a Proposal in Factory](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/71) _Submitted by loop_\n- [[N-09] Use of uint rather than uint256](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/69) _Submitted by loop_\n- [[N-10] BLOCK_DECREMENT not used](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/57) _Submitted by gpersoon, also found by itsmeSTYJ, kenzo, and WatchPug_\n- [[N-11] Basket will break and lock all user funds if not used in 100 years](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/63) _Submitted by kenzo_\n- [[N-12] Suggestion for incentive alignment](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/99) _Submitted by itsmeSTYJ_\n- [[N-13] Misleading variable names](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/98) _Submitted by itsmeSTYJ_\n- [[N-14] Use CEI pattern to align w/ best practices](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/97) _Submitted by itsmeSTYJ_\n- [[N-15] More readable constants](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/51) _Submitted by gpersoon_\n- [[N-16] `Auction.sol#bondTimestamp` Misleading name](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/80) _Submitted by WatchPug_\n- [[N-17] Settle Time Limit not set correctly (Auction.sol)](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/126) _Submitted by ye0lde_\n- [[N-18] Code lacking comments/spec](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/68) _Submitted by loop_\n- [[N-19] Naming](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/250) _Submitted by goatbug_\n- [[N-20] Uninitialized Implementation Contracts](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/18) _Submitted by bw_\n- [[N-21] Events not emitted for parameter changes ](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/17) _Submitted by bw_\n- [[N-22] Event BasketLicenseProposed needs an idNumber](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/263) _Submitted by 0xsanson_\n- [[N-23] `bondTimestamp` is not a timestamp but a blocknumber](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/261) _Submitted by 0xsanson_\n- [[N-24] Lack of revert messages](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/258) _Submitted by 0xsanson, also found by 0xRajeev_\n- [[N-25] Max approvals are risky if contract is malicious/compromised](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/191) _Submitted by 0xRajeev_\n- [[N-26] Missing emission of basket ID and token composition](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/178) _Submitted by 0xRajeev_\n- [[N-27] Hardcoded constants are risky](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/174) _Submitted by 0xRajeev_\n- [[N-28] Lack of indexed event parameters will affect offchain monitoring](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/169) _Submitted by 0xRajeev_\n- [[N-29] Missing interfaces to determine available bounties](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/164) _Submitted by 0xRajeev_\n- [[N-30] Missing check for auctionOngoing is risky](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/157) _Submitted by 0xRajeev_\n- [[N-31] Lack of guarded launch approach may be risky](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/139) _Submitted by 0xRajeev_\n- [[N-32] Lack of input validation in initialize function of Basket.sol ](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/5) _Submitted by jah_\n- [[N-33] Lack of input validation in  initialize function of  Auction.sol](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/1) _Submitted by jah_\n- [[N-34] Limit on growth size of pool - bond size](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/275) _Submitted by goatbug_\n- [[N-35] Missing events for critical protocol parameter setters by owner](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/171) _Submitted by 0xRajeev_\n- [[N-36] 2-step change of publisher address and licenseFee does not generate warning event](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/188) _Submitted by 0xRajeev_\n- [[N-37] Using the latest compiler version may be susceptible to undiscovered bugs](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/180) _Submitted by 0xRajeev_\n- [[N-38] `mintTo` arguments order](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/257) _Submitted by 0xsanson_\n- [[N-39] Malicious tokens can execute arbitrary code](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/162) _Submitted by 0xRajeev_\n\n# Gas Optimizations (46)\n- [[G-01] Packing storage variables in Auction would save gas](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/109) _Submitted by t11s, also found by 0xRajeev, jah, JMukesh, kenzo, leastwood, and loop_\n- [[G-02] settleAuction should be external and arguments should use calldata](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/108) _Submitted by t11s_\n- [[G-03] Eliminate hasBonded](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/216) _Submitted by pauliax_\n- [[G-04] newIbRatio is not really useful](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/215) _Submitted by pauliax_\n- [[G-05] Mint fees can be simplified](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/214) _Submitted by pauliax_\n- [[G-06] Gas Optimization Wrt. Token Uniqueness](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/160) _Submitted by leastwood, also found by cmichel, csanuragjain, itsmeSTYJ, joeysantoro, kenzo, and pauliax_\n- [[G-07] Set functions to external.](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/240) _Submitted by goatbug, also found by 0xRajeev, 0xsanson, chasemartin01, hack3r-0m, pauliax, and WatchPug_\n- [[G-08] Dead code](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/211) _Submitted by pauliax_\n- [[G-09] Double division by BASE](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/210) _Submitted by pauliax_\n- [[G-10] Redundant call to external contract, result can be saved](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/43) _Submitted by kenzo, also found by pauliax and WatchPug_\n- [[G-11] Replace `tokenList.length` by existing variable `length`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/230) _Submitted by hrkrshnn, also found by pauliax, and WatchPug_\n- [[G-12] Restore state to 0 if not needed anymore](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/40) _Submitted by kenzo, also found by gpersoon_\n- [[G-13] Unnecessary initializing of variable to 0](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/39) _Submitted by kenzo, also found by 0xRajeev_\n- [[G-14] Some variables type should be changed ](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/7) _Submitted by jah_\n- [[G-15] Gas Saving by changing the visibility of initialize function from public to externa in basket.sol](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/4) _Submitted by jah_\n- [[G-16] Only validateWeights when it is needed](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/95) _Submitted by itsmeSTYJ_\n- [[G-17] set lastFee in initialize() function](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/94) _Submitted by itsmeSTYJ_\n- [[G-18] Transfer tokens directly to the basket](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/92) _Submitted by itsmeSTYJ_\n- [[G-19] Runtime constants not defined as immutable](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/15) _Submitted by bw, also found by 0xRajeev and hrkrshnn_\n- [[G-20] The increment in for loop post condition can be made unchecked](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/232) _Submitted by hrkrshnn_\n- [[G-21] Use `calldata` instead of `memory` for function parameters](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/229) _Submitted by hrkrshnn_\n- [[G-22] redundant code (unused variables)](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/198) _Submitted by hack3r-0m, also found by goatbug_\n- [[G-23] handleFees() only mint when necessary](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/53) _Submitted by gpersoon, also found by bw and WatchPug_\n- [[G-24] Same tokens added to bounty](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/253) _Submitted by goatbug_\n- [[G-25] pack structs *3](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/252) _Submitted by goatbug_\n- [[G-26] Unecessary transfer trips](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/245) _Submitted by goatbug_\n- [[G-27] Gas optimation proposal struct](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/238) _Submitted by goatbug_\n- [[G-28] Gas saving: pack struct](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/237) _Submitted by goatbug_\n- [[G-29] Gas: Can save an sload in `changeLicenseFee`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/228) _Submitted by cmichel_\n- [[G-30] Gas: Can save an sload in `changePublisher`](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/227) _Submitted by cmichel_\n- [[G-31] Gas: Factory parameter can be removed from Auction](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/225) _Submitted by cmichel_\n- [[G-32] Use calldata instead of memory in function parameter declarations](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/75) _Submitted by chasemartin01_\n- [[G-33] Require statement can be moved to start of function](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/19) _Submitted by bw_\n- [[G-34] `Auction.sol#initialize()` Use msg.sender rather than factory_ parameter can save gas](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/137) _Submitted by WatchPug, also found by 0xRajeev_\n- [[G-35] Adding unchecked directive can save gas](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/135) _Submitted by WatchPug, also found by 0xRajeev_\n- [[G-36] Bounty list is never pruned to remove inactive bounties](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/165) _Submitted by 0xRajeev_\n- [[G-37] Choose either explicit return or named return, not both](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/154) _Submitted by 0xRajeev_\n- [[G-38] Avoiding unnecessary return can save gas](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/153) _Submitted by 0xRajeev_\n- [[G-39] Loop can be skipped for i == 0](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/151) _Submitted by 0xRajeev_\n- [[G-40] Unnecessary initialization of loop index variable](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/150) _Submitted by 0xRajeev_\n- [[G-41] Caching return values of external calls in local/memory variables avoids CALLs to save gas](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/147) _Submitted by 0xRajeev_\n- [[G-42] Caching state variables in local/memory variables avoids SLOADs to save gas](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/145) _Submitted by 0xRajeev_\n- [[G-43] Avoiding state variables in emits saves gas](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/143) _Submitted by 0xRajeev_\n- [[G-44] Redundant Balance Check](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/85) _Submitted by shenwilly_\n- [[G-45] Unnecessary require check](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/273) _Submitted by anon_\n- [[G-46] Unused constant](https://github.com/code-423n4/2021-09-defiprotocol-findings/issues/156) _Submitted by 0xRajeev_\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}