{
  "circa": {
    "title": "veToken Finance contest",
    "sponsor": "veToken Finance",
    "slug": "2022-05-vetoken",
    "date": "2022-10-25",
    "findings": "https://github.com/code-423n4/2022-05-vetoken-findings/issues",
    "contest": 126
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the veToken Finance smart contract system written in Solidity. The audit contest took place between May 26—June 2 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>76 Wardens contributed reports to the veToken Finance contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>xiaoming90</li>\n<li>unforgiven</li>\n<li><a href=\"https://twitter.com/thePicodes\">Picodes</a></li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li><a href=\"https://twitter.com/shenwilly_\">shenwilly</a></li>\n<li>VAD37</li>\n<li>oyc_109</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>sorrynotsorry</li>\n<li>0x52</li>\n<li><a href=\"https://twitter.com/BowTiedDravee\">Dravee</a></li>\n<li>SmartSek (0xDjango and hake)</li>\n<li>cryptphi</li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"http://seanseefried.org/blog\">sseefried</a></li>\n<li><a href=\"https://www.linkedin.com/in/jonatas-cmartins/\">jonatascm</a></li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/ch13fd357r0y3r\">ch13fd357r0y3r</a></li>\n<li>SecureZeroX</li>\n<li><a href=\"https://twitter.com/WatchPug_\">WatchPug</a> (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li>Kumpa</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>TerrierLover</li>\n<li>reassor</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li><a href=\"https://www.linkedin.com/in/minhquanym/\">minhquanym</a></li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>sashik_eth</li>\n<li>FSchmoede</li>\n<li>_Adam</li>\n<li><a href=\"https://twitter.com/berndartmueller\">berndartmueller</a></li>\n<li>cccz</li>\n<li>robee</li>\n<li><a href=\"https://twitter.com/cogitoergosumsw\">cogitoergosumsw</a></li>\n<li>horsefacts</li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li>0x29A (0x4non and rotcivegaf)</li>\n<li>Hawkeye (0xwags and 0xmint)</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>simon135</li>\n<li>0xf15ers (remora and twojoy)</li>\n<li><a href=\"https://twitter.com/ellahinator\">ellahi</a></li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>delfin454000</li>\n<li>asutorufos</li>\n<li>ElKu</li>\n<li><a href=\"https://github.com/z3s/\">z3s</a></li>\n<li>dipp</li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li><a href=\"https://twitter.com/BouSalman\">BouSalman</a></li>\n<li>GimelSec (<a href=\"https://twitter.com/rayn731\">rayn</a> and sces60107)</li>\n<li>0xDjango</li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li>Koustre</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://github.com/0xKitsune\">0xKitsune</a></li>\n<li>Kaiziron</li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li>0xkatana</li>\n<li>Cityscape</li>\n<li><a href=\"https://twitter.com/randyyramadhan\">Randyyy</a></li>\n<li>RoiEvenHaim</li>\n<li>sach1r0</li>\n<li>saian</li>\n<li>Waze</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>. The judge also competed in the contest as a warden, but forfeited their winnings.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 31 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 30 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 51 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 48 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-05-vetoken\">C4 veToken Finance contest repository</a>, and is composed of 6 smart contracts written in the Solidity programming language and includes 1,602 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-gauge-rewards-stuck-in-voterproxy-contract-when-extrarewardstashv3-is-used-within-angle-deployment\" style=\"position:relative;\"><a href=\"#h-01-gauge-rewards-stuck-in-voterproxy-contract-when-extrarewardstashv3-is-used-within-angle-deployment\" aria-label=\"h 01 gauge rewards stuck in voterproxy contract when extrarewardstashv3 is used within angle deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/209\">[H-01] Gauge Rewards Stuck In <code>VoterProxy</code> Contract When <code>ExtraRewardStashV3</code> Is Used Within Angle Deployment</a></h2>\n<p><em>Submitted by xiaoming90</em></p>\n<blockquote>\n<p>Note: This report aims to discuss the issue encountered when <code>ExtraRewardStashV3</code> is used within Angle Deployment. There is also another issue when <code>ExtraRewardStashV2</code> is used within Angle Deployment, but I will raise it in a separate report since <code>ExtraRewardStashV2</code> and <code>ExtraRewardStashV3</code> operate differently, and the proof-of-concept and mitigation are different too.</p>\n</blockquote>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In this example, assume the following Angle’s gauge setup</p>\n<blockquote>\n<p>Name = Angle sanDAI_EUR Gauge</p>\n<p>Symbol = SsanDAI_EUR</p>\n<p>reward_count = 2</p>\n<p>reward_tokens(0) = ANGLE</p>\n<p>reward_tokens(1) = DAI</p>\n<p>Gauge Contract: <a href=\"https://github.com/AngleProtocol/angle-core/blob/4d854e0d74be703a3707898f26ea2dd4166bc9b6/contracts/staking/LiquidityGaugeV4.vy\">LiquidityGaugeV4.vy</a></p>\n<p>Stash Contract: <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV3.sol\">ExtraRewardStashV3</a></p>\n</blockquote>\n<p>To collect the gauge rewards, users would trigger the <code>Booster._earmarkRewards</code> function to claim veAsset and extra rewards from a gauge.</p>\n<p>Per the code logic, the function will attempt to execute the following two key operations:</p>\n<ol>\n<li>First Operation -  Claim the veAsset by calling <code>VoterProxy.claimVeAsset</code>. Call Flow as follow: <code>VoterProxy.claimVeAsset() > IGauge(_gauge).claim_rewards()</code>.</li>\n<li>Second Operation - Claim extra rewards by calling <code>ExtraRewardStashV3.claimRewards</code>. Call flow as follows: <code>ExtraRewardStashV3.claimRewards > Booster.claimRewards > VoterProxy.claimRewards > IGauge(_gauge).claim_rewards()</code> .</li>\n</ol>\n<p>Note that<code>IGauge(_gauge).claim_rewards()</code> will claim all available reward tokens from the Angle’s gauge.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L495\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L495</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">//claim veAsset and extra rewards and disperse to reward contracts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function _earmarkRewards(uint256 _pid) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    PoolInfo storage pool = poolInfo[_pid];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(pool.shutdown == false, &quot;pool is closed&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address gauge = pool.gauge;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //claim veAsset</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IStaker(staker).claimVeAsset(gauge);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //check if there are extra rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address stash = pool.stash;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (stash != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //claim extra rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IStash(stash).claimRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //process extra rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IStash(stash).processStash();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t..SNIP..</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h4 id=\"first-operation----claim-the-veasset\" style=\"position:relative;\"><a href=\"#first-operation----claim-the-veasset\" aria-label=\"first operation    claim the veasset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First Operation -  Claim the veAsset</h4>\n<p>Since this is a Angle Deployment, when the <code>VoterProxy.claimVeAsset</code> is triggered,  it will go through the if-else logic (<code>escrowModle == IVoteEscrow.EscrowModle.ANGLE</code>) and execute <code>IGauge(_gauge).claim_rewards()</code>, and all rewards tokens will be sent to <code>VoterProxy</code> contract. Assume that <code>100 ANGLE</code> and <code>100 DAI</code> were received.</p>\n<p>Note that in this example, we have two reward tokens (ANGLE and DAI). Additionally, gauge redirection was not configured on the gauge at this point, thus the gauge rewards will be sent to the caller, which is the <code>VoterProxy</code> contract.</p>\n<p>Subsequently, the code <code>IERC20(veAsset).safeTransfer(operator, _balance);</code> will be executed, and veAsset (<code>100 ANGLE</code>) reward tokens will be transferred to the <code>Booster</code> contract for distribution. However, the <code>100 DAI</code> reward tokens will remain stuck in the <code>VoterProxy</code> contract. As such, users will not be able to get any reward tokens (e.g. DAI, WETH) except veAsset (ANGLE) tokens from the gauges.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L224\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L224</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function claimVeAsset(address _gauge) external returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(msg.sender == operator, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _balance = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (escrowModle == IVoteEscrow.EscrowModle.PICKLE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        try IGauge(_gauge).getReward() {} catch {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return _balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        escrowModle == IVoteEscrow.EscrowModle.CURVE ||</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        escrowModle == IVoteEscrow.EscrowModle.RIBBON</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        try ITokenMinter(minter).mint(_gauge) {} catch {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return _balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (escrowModle == IVoteEscrow.EscrowModle.IDLE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        try ITokenMinter(minter).distribute(_gauge) {} catch {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return _balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (escrowModle == IVoteEscrow.EscrowModle.ANGLE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        try IGauge(_gauge).claim_rewards() {} catch {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return _balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _balance = IERC20(veAsset).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IERC20(veAsset).safeTransfer(operator, _balance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return _balance;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Following is Angle’s Gauge Contract for reference:</p>\n<p><a href=\"https://github.com/AngleProtocol/angle-core/blob/4d854e0d74be703a3707898f26ea2dd4166bc9b6/contracts/staking/LiquidityGaugeV4.vy#L344\">https://github.com/AngleProtocol/angle-core/blob/4d854e0d74be703a3707898f26ea2dd4166bc9b6/contracts/staking/LiquidityGaugeV4.vy#L344</a></p>\n<p>(Mainnet Deployed Address: <a href=\"https://etherscan.io/address/0x8E2c0CbDa6bA7B65dbcA333798A3949B07638026\">https://etherscan.io/address/0x8E2c0CbDa6bA7B65dbcA333798A3949B07638026</a>)</p>\n<blockquote>\n<p>Note: Angle Protocol is observed to use LiquidityGaugeV4 contract for all of their gauges. Thus, ExtraRewardStashV3 is utilised during pool creation.</p>\n</blockquote>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">@external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@nonreentrant(&#39;lock&#39;)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">def claim_rewards(_addr: address = msg.sender, _receiver: address = ZERO_ADDRESS):</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;&quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    @notice Claim available reward tokens for `_addr`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    @param _addr Address to claim for</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    @param _receiver Address to transfer rewards to - if set to</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     ZERO_ADDRESS, uses the default reward receiver</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                     for the caller</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;&quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if _receiver != ZERO_ADDRESS:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assert _addr == msg.sender  \\# dev: cannot redirect when claiming for another user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    self._checkpoint_rewards(_addr, self.totalSupply, True, _receiver)</span></span></code></pre>\n<h4 id=\"second-operation---claim-extra-rewards\" style=\"position:relative;\"><a href=\"#second-operation---claim-extra-rewards\" aria-label=\"second operation   claim extra rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Second Operation - Claim extra rewards</h4>\n<p>After the <code>IStaker(staker).claimVeAsset(gauge);</code> code within the <code>Booster._earmarkRewards</code> function is executed, <code>IStash(stash).claimRewards();</code>  and <code>IStash(stash).processStash();</code> functions will be executed next. <code>stash</code> == <code>ExtraRewardStashV3</code>.</p>\n<p>The <code>ExtraRewardStashV3.claimRewards</code> will call the <code>Booster.setGaugeRedirect</code> first so that all the gauge rewards will be redirected to <code>ExtraRewardStashV3</code> stash contract. Subsequently, <code>ExtraRewardStashV3.claimRewards</code> will trigger <code>Booster.claimRewards</code> to claim the gauge rewards from the Angle’s gauge.</p>\n<p>Note that this is the second time the contract attempts to claim gauge rewards from the gauge. Thus, no gauge rewards will be received since we already claimed them earlier. Next, <code>ExtraRewardStashV3</code> will attempt to process all the tokens stored in its contract and send them to the respective reward contracts for distribution to the users. However, the contract does not have any tokens stored in it because the earlier attempt to claim gauge rewards return nothing.</p>\n<p>As we can see, the DAI reward tokens are still stuck in the <code>VoterProxy</code> contract at this point.</p>\n<p><a href=\"https://github.com/AngleProtocol/angle-core/blob/4d854e0d74be703a3707898f26ea2dd4166bc9b6/contracts/staking/LiquidityGaugeV4.vy#L332\">https://github.com/AngleProtocol/angle-core/blob/4d854e0d74be703a3707898f26ea2dd4166bc9b6/contracts/staking/LiquidityGaugeV4.vy#L332</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">def set_rewards_receiver(_receiver: address):</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;&quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    @notice Set the default reward receiver for the caller.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    @dev When set to ZERO_ADDRESS, rewards are sent to the caller</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    @param _receiver Receiver address for any rewards claimed via `claim_rewards`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    &quot;&quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    self.rewards_receiver[msg.sender] = _receiver</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV3.sol#L61\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV3.sol#L61</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">//try claiming if there are reward tokens registered</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function claimRewards() external returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(msg.sender == operator, &quot;!authorized&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //this is updateable from v2 gauges now so must check each time.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    checkForNewRewardTokens();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //make sure we&#39;re redirected</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (!hasRedirected) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IDeposit(operator).setGaugeRedirect(pid);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        hasRedirected = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 length = tokenCount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (length &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //claim rewards on gauge for staker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //using reward_receiver so all rewards will be moved to this stash</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IDeposit(operator).claimRewards(pid, gauge);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>User’s gauge rewards are frozen/stuck in <code>VoterProxy</code> contract. Additionally, there is no method to sweep/collect the reward tokens stuck in the <code>VoterProxy</code> contract.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<blockquote>\n<p>Note: I do not see <code>Booster.setGaugeRedirect</code> being called in the deployment and testing scripts. Thus, it is fair to assume that the team is not aware of the need to trigger <code>Booster.setGaugeRedirect</code> during deployment. If the gauge redirection has been set to the stash contract <code>ExtraRewardStashV3</code> right from the start before anyone triggered the <code>earmarkRewards</code> function, this issue should not occur.</p>\n</blockquote>\n<p>Consider triggering <code>Booster.setGaugeRedirect</code> during the deployment to set gauge redirection to stash contract (<code>ExtraRewardStashV3</code>) so that the Angle’s gauge rewards will not be redirected to <code>VoterProxy</code> contract and get stuck there.</p>\n<p>Alternatively, update the <code>Booster._earmarkRewards</code> to as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">//claim veAsset and extra rewards and disperse to reward contracts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function _earmarkRewards(uint256 _pid) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tPoolInfo storage pool = poolInfo[_pid];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\trequire(pool.shutdown == false, &quot;pool is closed&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\taddress stash = pool.stash;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tif (escrowModle == IVoteEscrow.EscrowModle.ANGLE) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t//claims gauges rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tIStash(stash).claimRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t//process gauges rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tIStash(stash).processStash();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t} else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t//claim veAsset</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IStaker(staker).claimVeAsset(gauge);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //check if there are extra rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address stash = pool.stash;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (stash != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //claim extra rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IStash(stash).claimRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            //process extra rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IStash(stash).processStash();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t//veAsset balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 veAssetBal = IERC20(veAsset).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t..SNIP..</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>There is no need to specifically call <code>VoterProxy.claimVeAsset</code> to fetch ANGLE for Angle Protocol because calling <code>IStash(stash).claimRewards()</code> will fetch both ANGLE and other reward tokens from the gauge anyway. When the stash contract receives the ANGLE tokens, it will automatically transfer all of them back to <code>Booster</code> contract when <code>IStash(stash).processStash()</code> is executed. The <code>IStash(stash).claimRewards()</code> function also performs a sanity check to ensure that the gauge redirection is pointing to itself before claiming the gauge rewards, and automatically configure them if it is not, so it will not cause the reward tokens to get stuck in <code>VoterProxy</code> contract.</p>\n<ul>\n<li>Curve uses an older version of LiquidityGauge contract. Thus, two calls are needed (<code>Minter.mint</code> to claim CRV and <code>LiquidityGauge.claim_rewards</code> to claim other rewards).</li>\n<li>Angle uses newer version of LiquidityGauge (V4) contract that just need one function call (<code>LiquidityGauge.claim_rewards</code> ) to fetch both veAsset and other rewards.</li>\n<li>IDLE uses LiquidityGauge (V3) contract. veAsset (IDLE) is minted by calling <code>DistributorProxy.distribute</code> and gauge rewards are claimed by calling <code>LiquidityGauge.claim_rewards</code>.</li>\n</ul>\n<p>Due to the discrepancies between different protocols in the reward claiming process, additional care must be taken to ensure that the flow of veAsset and gauge rewards are transferred to the appropriate contracts during integration. Otherwise, rewards will be stuck.</p>\n<p>Lastly, I only see test cases written for claiming veAsset from the gauge. For completeness, it is recommended to also write test cases for claiming extra rewards from the gauge apart from veAsset.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/209#issuecomment-1156668018\">solvetony (veToken Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Good catch, this issue is because Angle uses the same function for claim veAsset and extra rewards. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/209#issuecomment-1193419949\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how Angle protocol will break certain invariants as the code assumes that claiming of <code>veAsset</code> to always be separate from claiming of <code>additionalRewards</code>.</p>\n<p>Due to this any additional reward emitted by the Angle Gauge will be stuck in the claiming contract.</p>\n<p>While impact is limited to loss of yield (loss of additional tokens), because the finding has broken the assumptions of the contract, meaning that Angle Protocol should not be integrated without a fix, I believe High Severity to be appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/209#issuecomment-1199815504\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Upon further review, we may raise the concern of the contract being out of scope.</p>\n<p>However, given that:</p>\n<ul>\n<li>The sponsor Confirmed</li>\n<li>The vulnerability would be present in a normal configuration</li>\n</ul>\n<p>I believe the finding is of High Severity.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-30\" style=\"position:relative;\"><a href=\"#medium-risk-findings-30\" aria-label=\"medium risk findings 30 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (30)</h1>\n<h2 id=\"m-01-compromised-owner-can-drain-funds-fromvetokenmintersol\" style=\"position:relative;\"><a href=\"#m-01-compromised-owner-can-drain-funds-fromvetokenmintersol\" aria-label=\"m 01 compromised owner can drain funds fromvetokenmintersol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/69\">[M-01] compromised <code>owner</code> can drain funds from<code>VeTokenMinter.sol</code></a></h2>\n<p><em>Submitted by SmartSek, also found by ch13fd357r0y3r</em></p>\n<p>Compromised <code>owner</code> can <code>withdraw()</code> entire balance of <code>VeTokenMinter.sol</code> to any other account.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L77-L81\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L77-L81</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function withdraw(address _destination, uint256 _amount) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    veToken.safeTransfer(_destination, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit Withdraw(_destination, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The <code>owner</code> can choose any <code>_destination</code> and <code>_amount</code> to send funds to with no delay or limit.\nThese funds could be used to call <code>Booster.deposit()</code> and then <code>Booster.withdraw()</code>(withdraw) the equivalent in <code>lptoken</code>.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider implementing a timelock on <code>VeTokenMinter.withdraw()</code> and changing the <code>destination</code> to an address that <code>owner</code> has no control over.</p>\n<p>Example of similar issues illustrating the severity of the finding can be found <a href=\"https://code4rena.com/reports/2022-01-insure\">here (H-09)</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/69#issuecomment-1156609426\">solvetony (veToken Finance) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Requires compromised owner.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/69#issuecomment-1175569241\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Finding is valid, but contingent on a Malicious or Compromised Admin, Medium Severity is more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-ve3drewardpoolsol-is-incompatible-with-balvebal\" style=\"position:relative;\"><a href=\"#m-02-ve3drewardpoolsol-is-incompatible-with-balvebal\" aria-label=\"m 02 ve3drewardpoolsol is incompatible with balvebal permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/53\">[M-02] VE3DRewardPool.sol is incompatible with Bal/veBal</a></h2>\n<p><em>Submitted by 0x52</em></p>\n<p><code>getReward</code> will become completely unusable if bal is added as an support asset.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>veBal is not staked bal, it is staked 80-20 bal/eth LP. Rewards from gauges are paid in bal NOT 80-20 bal/eth LP. All rewards to this address will be received as bal. If the contract tries to deposit bal directly it will fail, causing getReward to always revert if bal is a supported asset (as all documentation conveys that it will be).</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Exclude veBal/Bal as a supported asset or create a special wrapper for Bal that adds the Bal as one sided liquidity then stakes the LP.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/53#issuecomment-1156605217\">solvetony (veToken Finance) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Out of the scope, Balancer. But we need to consider this, once we start working on these.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/53#issuecomment-1189659591\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The finding shows how the code cannot support veBAL.</p>\n<p>In the specific case of veBAL, the deposit token is 80/20 BAL but the reward is BAL, meaning the function will eventually revert.</p>\n<p>This is conditional on the token being the BAL token, which means the finding cannot be of High Severity (conditional on configuration).</p>\n<p>The sponsor claims that Balancer will not be used, and that may be the case, however the <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/README.md#L20\">README for the contest</a> does include BAL and for that reason I think the finding is Valid and of Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-no-check-for-existing-extrarewards-during-push\" style=\"position:relative;\"><a href=\"#m-03-no-check-for-existing-extrarewards-during-push\" aria-label=\"m 03 no check for existing extrarewards during push permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/89\">[M-03] No check for existing extraRewards during push</a></h2>\n<p><em>Submitted by cryptphi, also found by csanuragjain</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L138\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L138</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DLocker.sol#L156\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DLocker.sol#L156</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Similar to a report I submitted for BaseRewardPool.sol (<a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L126\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L126</a>)</p>\n<p>When adding <code>extraRewards</code> to the extra reward pool in <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L138\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L138</a> , there’s no check for already existing address.</p>\n<p>Assume a particular address takes up 2 slots out of 3, and a user withdraws staked extra rewards, the user will receive double the amount requested in <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L257-L258\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L257-L258</a></p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Assume <code>rewardManager</code> had mistakenly added the same address twice in <code>addExtraReward()</code></li>\n<li>A user calls <code>stake()</code> , linked rewards is staked twice to the same address (unexpected behaviour I guess but not severe issue)</li>\n<li>Now, user calls <code>withdraw()</code> to withdraw linked rewards (this is already 2x in step 2)</li>\n<li>User will receive double the linked rewards due to the iteration in <code>https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L257-L258</code></li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Guess a check for an already existing extraRewards can be added before Line 138</p>\n<h4 id=\"similar-issue\" style=\"position:relative;\"><a href=\"#similar-issue\" aria-label=\"similar issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Similar issue</h4>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DLocker.sol#L156\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DLocker.sol#L156</a> - not so sure of the severity for this.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L126\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L126</a>  - reported in a seperate report</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/89\">jetbrain10 (veToken Finannce) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/89#issuecomment-1189682693\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a misconfiguration error, a leak of value can happen, and other depositors (late withdrawers) would lose the rewards that they are entitled to.</p>\n<p>Mitigation seems to be straightforward (add a duplicate check, or use a enumerableMap), that said, because of the risk of loss contingent on configuration, I agree with Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-user-can-lose-extra-rewards\" style=\"position:relative;\"><a href=\"#m-04-user-can-lose-extra-rewards\" aria-label=\"m 04 user can lose extra rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/15\">[M-04] User can lose extra rewards</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p>rewardManager can at anytime delete the extra Rewards. This impacts the extra rewards earned by existing staker. The existing staker will have no way to claim these extra rewards. Since these extra rewards have been staked for all users making a deposit BaseRewardPool.sol#L215 so basically the extra reward gets locked with no one having access to this fund. Need to be fixed for BaseRewardPool.sol as well</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>rewardManager adds 2 extra reward token A,B using addExtraReward</li>\n<li>User X makes a deposit of amount 1000 using stake function</li>\n<li>This stakes extra rewards A,B for this user</li>\n<li>rewardManager now calls clearExtraRewards which removes extraRewards object</li>\n<li>User X has now no way to retrieve the staked extra rewards A,B of amount 1000</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If rewardManager wants to clear extra rewards then all existing stakes on extra rewards must be withdrawn and claimed so that user extra rewards are not lost.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/15#issuecomment-1156597107\">solvetony (veToken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Not an issue of the user staked fund, but we need to add call at pool factory for <code>clearExtraRewards()</code>. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/15#issuecomment-1190943684\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to admin privilege, extra rewards could stay stuck in the contract.</p>\n<p>Because this is contingent on a malicious admin, I believe Medium Severity to be more appropriate.</p>\n<p>Notice that the rewards would be lost forever as there doesn’t seem to be any <code>sweep</code> function which instead would allow the admin to take the reward tokens.</p>\n<p>My recommendation is to remove the function to <code>clearExtraRewards</code> as it doesn’t seem to help but it can indeed cause issues.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-duplicate-lp-token-could-lead-to-incorrect-deposits\" style=\"position:relative;\"><a href=\"#m-05-duplicate-lp-token-could-lead-to-incorrect-deposits\" aria-label=\"m 05 duplicate lp token could lead to incorrect deposits permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/11\">[M-05] Duplicate LP token could lead to incorrect deposits</a></h2>\n<p><em>Submitted by csanuragjain, also found by kirk-baird and unforgiven</em></p>\n<p>It was observed that addPool function is not checking for duplicate lpToken which allows 2 or more pools to have exact same lpToken. This can cause issue with deposits.</p>\n<p>In case of duplicate lpToken, the first pool calling depositAll will take away all lpToken and deposit them under there own pid. This leaves no balance for 2nd pool.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>PoolManager call addPool function and uses lpToken as A</li>\n<li>PoolManager again call addPool function and mistakenly provides lpToken as A</li>\n<li>Now 2 pools will be created with lpToken as A</li>\n<li>depositAll function is called passing first pool.</li>\n<li>This takes all balance of lpToken A and depsoit it under first pool pid</li>\n<li>This mean no balance is left for second pool now</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a global variable keeping track of all lpToken added for pool. In case of duplicate lpToken addPool function should fail.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/11#issuecomment-1156614001\">jetbrain10 (veToken Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>There is already a validation not allow to add duplicated gauges, pool manager contract, add pool function , but we have to add also a validation for lp token like gauges.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/11#issuecomment-1190948418\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a lack of validation, the assumption that each lpToken is used only on one pool can be broken.\nThis will cause accounting issues.</p>\n<p>For those reasons, I agree with Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-incorrectly-set-_maxtime-to-be-in-line-with-the-locking-maxtime-of-each-vetoken-could-render-the-deposit-of-this-contract-to-be-unfunctional-or-even-freeze-assets-inside-the-contract-\" style=\"position:relative;\"><a href=\"#m-06-incorrectly-set-_maxtime-to-be-in-line-with-the-locking-maxtime-of-each-vetoken-could-render-the-deposit-of-this-contract-to-be-unfunctional-or-even-freeze-assets-inside-the-contract-\" aria-label=\"m 06 incorrectly set _maxtime to be in line with the locking maxtime of each vetoken could render the deposit of this contract to be unfunctional or even freeze assets inside the contract  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/141\">[M-06] Incorrectly set <code>_maxTime</code> to be in line with the locking <code>maxTime</code> of each veToken could render the <code>deposit</code> of this contract to be unfunctional or even freeze assets inside the contract </a></h2>\n<p><em>Submitted by Kumpa, also found by SecureZeroX and unforgiven</em></p>\n<p>Since _maxTime needs to be manually input in the constructor with no other ways of changing it, if the owner inputs the _maxTime that is higher than the capacity of each vaults of veTokens, it will cause <code>IVoteEscrow(escrow).increase_unlock_time(_value);</code> to get rejected.</p>\n<p>In the mild case when a user initially locks the asset during depositing, the contract will simply revert the transaction.</p>\n<p>In the severe case when a user does not lock the asset during depositing, the asset will end up locked in the contract since noone will be able to succesfully call <code>lockVeAsset</code>. This will cause the asset to be locked up with no way of withdrawing it. Even though a user will still get benefits from the minted reward, a contract will not be able to receive any benefits since it can’t utilize the locked asset in <code>VeAssetDepositor</code>.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><img src=\"https://user-images.githubusercontent.com/63941340/171625668-85834a21-f3c2-4837-b49b-4ed5a975132a.jpg\" alt=\"Pic 1 \"></p>\n<p>1.The owner initially sets _maxTime in constructor to be 126489600 (86400<em>366</em>4) instead of 126144000 (86400<em>365</em>4) which is the maximum time that a user can deposit in curve</p>\n<p><img src=\"https://user-images.githubusercontent.com/63941340/171625682-49582795-ed3f-4ae5-8302-57f270376461.jpg\" alt=\"Pic 2\"></p>\n<p>2.A user <code>deposit</code> veAsset but deferring the locking to save gas</p>\n<p>3.The veAsset is transferred from a user to the contract and the contract mint a reward token to the user</p>\n<p><img src=\"https://user-images.githubusercontent.com/63941340/171625696-9d57f982-233e-4f26-8536-a6e8804c6f5e.jpg\" alt=\"Pic 3\"></p>\n<p><img src=\"https://user-images.githubusercontent.com/63941340/171625706-b8ddf803-1bd4-4aba-89c9-354445168eda.jpg\" alt=\"Pic 4\"></p>\n<p><img src=\"https://user-images.githubusercontent.com/63941340/171625711-d8c63db6-c962-4150-867d-d51bb15ea055.jpg\" alt=\"Pic 5\"><br>\n*Above shows that the deposit will get reverted if lockAmount is more than 4 years in curve’s VotingEscrow</p>\n<p>4.The veAsset will not be able to move to the staking contract because when VoterProxy calls <code>increase_unlock_time</code> in the targeted vault, the call will get reverted due to exceeded _value of <code>unlockAt</code></p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The owner should set the value of _maxTime in advance for each veAsset and not relying on manual inputting during the constructoring as the risk of misconfiging ot is high. Otherwise the contract should add an emergency measure that can help change _maxTime but this function needs to be protected with the highest security (eg. with timelock and multisig).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/141#issuecomment-1156645854\">solvetony (veToken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>We can set it by a function instead of a constructor. Middle risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/141#issuecomment-1190967097\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to misconfiguration a lock may not be created, causing tokens to be stuck in the contract. </p>\n<p>We can confirm that a revert would happen by checking <a href=\"https://etherscan.io/address/0x5f3b5dfeb7b28cdbd7faba78963ee202a494e2a2#code#L426\"><code>VotingEscrow</code></a></p>\n<p>Because this is contingent on a wrong configuration I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-ve3drewardpool-and-ve3dlocker-adds-to-an-unbounded-array-which-may-potentially-lock-all-rewards-in-the-contract\" style=\"position:relative;\"><a href=\"#m-07-ve3drewardpool-and-ve3dlocker-adds-to-an-unbounded-array-which-may-potentially-lock-all-rewards-in-the-contract\" aria-label=\"m 07 ve3drewardpool and ve3dlocker adds to an unbounded array which may potentially lock all rewards in the contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/136\">[M-07] <code>VE3DRewardPool</code> and <code>VE3DLocker</code> adds to an unbounded array which may potentially lock all rewards in the contract</a></h2>\n<p><em>Submitted by kirk-baird, also found by csanuragjain, Dravee, gzeon, IllIllI, Koustre, Ruhum, unforgiven, VAD37, and xiaoming90</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L102-L112\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L102-L112</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L145-L172\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L145-L172</a></p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The function <code>addReward()</code> allows the owner to add a new reward token to the list <code>rewardTokens</code>.</p>\n<p>However, this is an unbounded list that when appended to cannot be shortened. The impact is it is possible to reach a state where the list is so long it cannot be iterated through due to the gas cost being larger than the block gas limit. This would cause a state where all transactions which iterate over this list will revert.</p>\n<p>Since the modifier <code>updateReward()</code> iterates over this list it is possible that there will reach a state where the we are unable to call any functions with this modifier. The list includes</p>\n<ul>\n<li><code>stake()</code></li>\n<li><code>stakeAll()</code></li>\n<li><code>stakeFor()</code></li>\n<li><code>withdraw()</code></li>\n<li><code>withdrawAll()</code></li>\n<li><code>getReward()</code></li>\n<li><code>notifyRewardAmount()</code></li>\n</ul>\n<p>As a result it would therefore be impossible to withdraw any rewards from this contract.</p>\n<p>The same issue exists in <code>VE3DLocker</code>.  Where rewards can be added by either <code>Booster</code> or the owner.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function addReward(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _rewardToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _veAssetDeposits,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _ve3TokenRewards,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _ve3Token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokenInfo[_rewardToken].veAssetDeposits = _veAssetDeposits;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokenInfo[_rewardToken].ve3TokenRewards = _ve3TokenRewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokenInfo[_rewardToken].ve3Token = _ve3Token;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokens.add(_rewardToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function addReward(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _rewardsToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _veAssetDeposits,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _ve3Token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _ve3TokenStaking,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _distributor,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool _isVeAsset</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(_msgSender() == owner() || operators.contains(_msgSender()), &quot;!Auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(rewardData[_rewardsToken].lastUpdateTime == 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(_rewardsToken != address(stakingToken));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokens.push(_rewardsToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardData[_rewardsToken].lastUpdateTime = uint40(block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardData[_rewardsToken].periodFinish = uint40(block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardDistributors[_rewardsToken][_distributor] = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardData[_rewardsToken].isVeAsset = _isVeAsset;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // if reward is veAsset</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_isVeAsset) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(_ve3Token != address(0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(_ve3TokenStaking != address(0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(_veAssetDeposits != address(0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardData[_rewardsToken].ve3Token = _ve3Token;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardData[_rewardsToken].ve3TokenStaking = _ve3TokenStaking;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardData[_rewardsToken].veAssetDeposits = _veAssetDeposits;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider having some method for removing old reward tokens which are no longer in use.</p>\n<p>Alternatively set a hard limit on the number of reward tokens that can be added.</p>\n<p>A different option is to allow rewards to be iterated and distributed on a per token bases rather than all tokens at once.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/136#issuecomment-1156705919\">jetbrain10 (veToken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>we’re going to add a bound,  same as <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/222\">#222</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/125\">#125</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/136#issuecomment-1190946773\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<img width=\"210\" alt=\"Screenshot 2022-07-21 at 03 49 56\" src=\"https://user-images.githubusercontent.com/13383782/180112223-805eab5a-75c8-4f3d-be41-f27fc64e610a.png\">\n<p>My guesstimate of the math is that each reward would add 100k gas to the <code>updateReward</code> modifier, meaning we’d need 120 reward tokens before any consideration about running out of gas would happen.</p>\n<p>You also don’t seem to be able to add a second one (provided someone has used the contract at least once after an addition).</p>\n<p>I’ll think about it but am thinking Medium is stretching it.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/136#issuecomment-1193393769\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Likelyhood is very low, however per the rules if enough rewards are added then claiming and withdrawing can be bricked permanently.</p>\n<p>I’d recommend end users to ensure the unlikely number of 120 rewards is never reached.</p>\n<p>Marking the finding as Valid and of Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-not-updating-totalweight-when-operator-is-removed-in-vetokenminter\" style=\"position:relative;\"><a href=\"#m-08-not-updating-totalweight-when-operator-is-removed-in-vetokenminter\" aria-label=\"m 08 not updating totalweight when operator is removed in vetokenminter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/120\">[M-08] Not updating <code>totalWeight</code> when operator is removed in <code>VeTokenMinter</code></a></h2>\n<p><em>Submitted by sseefried, also found by shenwilly</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L36-L38\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L36-L38</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L41-L4\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L41-L4</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598-L614\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598-L614</a></p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>totalWeight</code> state variable of the <code>VeTokenMinter</code> contract is used to work out the amount of <code>veAsset</code> earned when the <code>Booster.rewardClaimed</code> function is called.</p>\n<p>However, while <code>totalWeight</code> is modified inside the <code>VeTokenMinter</code> contract when function <code>updateveAssetWeight</code> is called, the <code>totalWeight</code> is not similarly reduced when function <code>removeOperator</code> is called.</p>\n<p>The impact is that remaining operators do not receive a fair share of the total rewards and a portion of the rewards are not given out at all.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>Operator 1 is added with weight 9</li>\n<li>Operator 2 is added with weight 1</li>\n</ul>\n<p>The <code>totalWeight</code> is now 10.</p>\n<p>This means that Operator 1 receives 90% of the amount while Operator 2 receives 10%.</p>\n<p>If we then call <code>removeOperator</code> on Operator 1 then 90% of the reward is no longer minted and distributed. This is unfair to the remaining operators.</p>\n<p>The can be seen on lines <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L607-L608\">607 - 608</a> of the <code>Booster</code> contract. Function <code>rewardClaimed</code> will never be called for (removed) Operator 1. But for Operator 2 they will still receive 10% of the rewards even though Operator 1 is no longer registered in the system.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>totalWeight</code> should be reduced so that the remaining operators receive a fair share of the total rewards.</p>\n<p>Using just method calls from <code>VeTokenMinter</code> one could rectify this situation by</p>\n<ul>\n<li>adding the removed operator with <code>addOperator</code></li>\n<li>setting the weight to <code>0</code> using <code>updateveAssetWeight</code>. This will have the effect of reducing the <code>totalWeight</code> by the right amount.</li>\n<li>removing the operator again using <code>removeOperator</code></li>\n</ul>\n<p>However, the <code>removeOperator</code> function should just be rewritten to be as follows:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function removeOperator(address _operator) public onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    totalWeight -= veAssetWeights[_operator];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    veAssetWeights[_operator] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    operators.remove(_operator);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>You might also want to modify <code>addOperator</code> so that a weight can be provided as an extra argument. This saves having to call <code>addOperator</code> and then <code>updateveAssetWeight</code> which could save on gas.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/120#issuecomment-1156643912\">solvetony (veToken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Confirmed. But this should be a middle risk. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/120#issuecomment-1193397795\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a privileged call, removing an operator, the weight used to distribute rewards will not be updated fairly.\nThis will cause an improper distribution of rewards.</p>\n<p>Because the finding is limited to Loss of Yield, due to Admin Configuration, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-in-notifyrewardamount-of-ve3drewardpool-and-baserewardpool-some-tokes-will-be-locked-and-not-distributed-becasue-of-rounding-error\" style=\"position:relative;\"><a href=\"#m-09-in-notifyrewardamount-of-ve3drewardpool-and-baserewardpool-some-tokes-will-be-locked-and-not-distributed-becasue-of-rounding-error\" aria-label=\"m 09 in notifyrewardamount of ve3drewardpool and baserewardpool some tokes will be locked and not distributed becasue of rounding error permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/165\">[M-09] in notifyRewardAmount() of VE3DRewardPool and BaseRewardPool some tokes will be locked and not distributed becasue of rounding error</a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L327-L345\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L327-L345</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L367-L384\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L367-L384</a></p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Function <code>notifyRewardAmount()</code> calculates <code>rewardRate</code> for reward token/s in <code>VE3DRewardPool</code> and <code>BaseRewardPool</code>. to calculate <code>rewardRate</code> it divides <code>reward</code> amount to <code>duration</code> but because of the rounding error in division, some of <code>reward</code> amount wouldn’t get distributed and stuck in contract (<code>rewardRate * duration &#x3C; reward</code>). and contract don’t redistributes them or don’t have any mechanism to recover them. This bug can be more damaging if the precision of <code>rewardToken</code> is low or token price is high.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>notifyRewardAmount()</code> code in <code>BaseRewardPool</code>: (contract <code>VE3DRewardPool</code> is similar)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function notifyRewardAmount(uint256 reward) internal updateReward(address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        historicalRewards = historicalRewards.add(reward);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &gt;= periodFinish) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardRate = reward.div(duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 remaining = periodFinish.sub(block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 leftover = remaining.mul(rewardRate);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            reward = reward.add(leftover);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardRate = reward.div(duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        currentRewards = reward;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lastUpdateTime = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        periodFinish = block.timestamp.add(duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RewardAdded(reward);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it sets <code>rewardRate = reward.div(duration);</code> and this is where the rounding error happens. and even if contract distributes all in all the duration it will distribute <code>rewardRate * duration</code> which can be lower than <code>reward</code> and the extra reward amount will stuck in contract. This is <code>queueNewRewards()</code> code which calls <code>notifyRewardAmount()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function queueNewRewards(uint256 _rewards) external returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(msg.sender == operator, &quot;!authorized&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _rewards = _rewards.add(queuedRewards);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &gt;= periodFinish) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            notifyRewardAmount(_rewards);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            queuedRewards = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //et = now - (finish-duration)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 elapsedTime = block.timestamp.sub(periodFinish.sub(duration));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //current at now: rewardRate * elapsedTime</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 currentAtNow = rewardRate * elapsedTime;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 queuedRatio = currentAtNow.mul(1000).div(_rewards);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //uint256 queuedRatio = currentRewards.mul(1000).div(_rewards);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (queuedRatio &lt; newRewardRatio) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            notifyRewardAmount(_rewards);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            queuedRewards = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            queuedRewards = _rewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it queues <code>rewardToken</code>  and when the reward amount reach some point it calls <code>notifyRewardAmount()</code> and set <code>queuedRewards</code>  to <code>0x0</code>. <code>notifyRewardAmount()</code> will set <code>rewardRate</code> based on <code>reward amount</code> but because of the rounding error some of the reward token <code>0 =&#x3C; unused &#x3C; duration</code> will stuck in contract and pool will not distribute it. if the token has low precision or has higher price then this amount value can be very big because <code>notifyRewardAmount()</code> can be called multiple times.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>add extra amount to <code>queuedRewards</code> so it would be distributed on next <code>notifyRewardAmount()</code> or add other mechanism to recover it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/165#issuecomment-1156647102\">solvetony (veToken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Will be fixed by two solutions, adding precision and by adding another function. Middle risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/165#issuecomment-1193398878\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to rounding errors, <code>rewardRate</code> may round down and cause a certain amount of tokens not to be distributed.</p>\n<p>In lack of a way for the <code>operator</code> to re-queue the undistributed rewards, those tokens will be lost.</p>\n<p>Because we know <code>duration</code> is <code>604800</code> we can see that the <code>rewardRate</code> max loss is <code>604799</code>.</p>\n<p>Meaning the potential max dust due to rounding down can be upwards of a number with 12 decimals<br>\n<img width=\"239\" alt=\"Screenshot 2022-07-24 at 23 38 33\" src=\"https://user-images.githubusercontent.com/13383782/180666870-ce02ff32-84d5-4d8c-9dc1-cc0bf9d5ef9b.png\"></p>\n<p>Because the finding is limited to loss of Yield, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-unable-to-get-rewards-if-admin-withdraws-ve3d-tokens-from-vetokenminter-contract\" style=\"position:relative;\"><a href=\"#m-10-unable-to-get-rewards-if-admin-withdraws-ve3d-tokens-from-vetokenminter-contract\" aria-label=\"m 10 unable to get rewards if admin withdraws ve3d tokens from vetokenminter contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/202\">[M-10] Unable To Get Rewards If Admin Withdraws $VE3D tokens From <code>VeTokenMinter</code> Contract</a></h2>\n<p><em>Submitted by xiaoming90, also found by 0x1f8b, and VAD37</em></p>\n<p>It was observed that users will not be able to get their rewards from the reward contract at certain point of time if admin withdraws $VE3D token from the <code>VeTokenMinter</code> contract.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Based on the deployment script, it was understood that at the start of the project deployment, 30 million $VE3D tokens will be pre-minted for the <code>VeTokenMinter</code> contract. Thus, the <code>veToken.balanceOf(VeTokenMinter.address)</code> will be 30 million $VE3D tokens after the deployment.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/2_deploy_basic_contracts.js#L18\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/2_deploy_basic_contracts.js#L18</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// vetoken minter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deployer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">VeTokenMinter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">veTokenAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vetokenMinter</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VeTokenMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deployed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">addContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;system&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;vetokenMinter&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vetokenMinter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">global</span><span class=\"mtk1\">.</span><span class=\"mtk12\">created</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//mint vetoke to minter contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vetoken</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VeToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">at</span><span class=\"mtk1\">(</span><span class=\"mtk12\">veTokenAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vetoken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">vetokenMinter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk12\">web3</span><span class=\"mtk1\">.</span><span class=\"mtk12\">utils</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toWei</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;30000000&quot;</span><span class=\"mtk1\">), { </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vetokenOperator</span><span class=\"mtk1\"> });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">addContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;system&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;vetoken&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">veTokenAddress</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In the <code>VeTokenMinter</code> contract, there is a function called <code>VeTokenMinter.withdraw</code> that allows the admin to withdraw $VE3D tokens from the contract. Noted that this withdraw function only perform the transfer, but did not update any of the state variables (e.g. totalSupply, maxSupply) in the contract.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L77\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L77</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function withdraw(address _destination, uint256 _amount) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    veToken.safeTransfer(_destination, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit Withdraw(_destination, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Assuming that an admin withdrawed 29 million $VE3D tokens from the <code>VoteProxy</code> with the appropriate approval from the DAO or community for some valid purposes. The <code>veToken.balanceOf(VeTokenMinter.address)</code> will be 1 million $VE3D tokens after the withdrawal.</p>\n<p>At this point, notice that <code>veToken.balanceOf(VeTokenMinter.address)</code> is 1 million, while the <code>VeTokenMinter.maxSupply</code> constant is 30 million. Therefore, there exists a discrepency between the actual amount of $VE3D tokens (1 million) stored in the contact versus the max supply (30 million).</p>\n<p>This discrepency will cause an issue in the <code>VeTokenMinter.mint</code> function because the calculation of the amount of $VE3D tokens to be transferred is based on the fact that 30 million $VE3D tokens is always sitting in the <code>VeTokenMinter</code> contract, and thus there is always sufficient $VE3D tokens available in the <code>VeTokenMinter</code> contract to send to its users.</p>\n<p>The <code>uint256 amtTillMax = maxSupply.sub(supply);</code> code shows that the calculation is based on <code>maxSupply</code> constant, which is 30 million.</p>\n<p>Assume that <code>mint(0x001, 10 million)</code> is called, and the value of the state variables when stepping through this function are as follows:</p>\n<ul>\n<li><code>maxSupply</code> constant = 30 million</li>\n<li><code>veToken.balanceOf(VeTokenMinter.address)</code> = 1 million</li>\n<li><code>supply</code> &#x26; <code>totalSupply</code> = 20 million</li>\n<li><code>totalCliffs</code> = 1000</li>\n<li><code>reductionPerCliff</code> = 30,000 (maxSupply / totalCliffs)</li>\n<li><code>cliff</code> = 666 (supply/reductionPerCliff)</li>\n<li><code>reduction</code> = 1000 - 666 = 334</li>\n<li><code>_amount</code> = 10 million * (334/1000) = 3.340 million</li>\n<li><code>amtTillMax</code> = 10 million (maxSupply - supply) (Over here the contract assume that it still has 10 million VE3D tokens more to reach the max supply)</li>\n<li><code>(_amount > amtTillMax)</code> = <code>False</code> (since “3.340 million > 10 million” = false )</li>\n<li><code>veToken.safeTransfer(0x001, 3.340 million)</code> (This will revert. Insufficent balance)</li>\n</ul>\n<p>The <code>veToken.safeTransfer(0x001, 3.340 million</code> will fail and revert because <code>VeTokenMinter</code> contract does not hold sufficent amount of $VE3D tokens to transfer out.<code>veToken.balanceOf(VeTokenMinter.address)</code> = 1 million, while the contract was attempting to send out 3.340 million.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L48\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L48</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function mint(address _to, uint256 _amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(operators.contains(_msgSender()), &quot;not an operator&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 supply = totalSupply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //use current supply to gauge cliff</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //this will cause a bit of overflow into the next cliff range</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //but should be within reasonable levels.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //requires a max supply check though</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 cliff = supply.div(reductionPerCliff);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //mint if below total cliffs</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (cliff &lt; totalCliffs) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //for reduction% take inverse of current cliff</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 reduction = totalCliffs.sub(cliff);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //reduce</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _amount = _amount.mul(reduction).div(totalCliffs);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //supply cap check</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amtTillMax = maxSupply.sub(supply);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_amount &gt; amtTillMax) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _amount = amtTillMax;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //mint</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        veToken.safeTransfer(_to, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        totalSupply += _amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The failure/revert of <code>VeTokenMinter.mint</code> function will cascade up to <code>Booster.rewardClaimed</code>, and futher cascade up to <code>BaseRewardPool.getReward</code>. Thus, <code>BaseRewardPool.getReward</code> will stop working. As a result, the users will not be able to get any rewards from the reward contracts.</p>\n<p>This issue will affect all projects (Curve, Pickle, Ribbon, Idle, Angle, Balancer) because <code>VeTokenMinter</code> contract is deployed once, and referenced by all the projects. Thus, the impact could be quite widespread if this occurs, and many users would be affected.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function rewardClaimed(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _pid,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _address,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) external returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address rewardContract = poolInfo[_pid].veAssetRewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(msg.sender == rewardContract || msg.sender == lockRewards, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITokenMinter veTokenMinter = ITokenMinter(minter);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //calc the amount of veAssetEarned</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _veAssetEarned = _amount.mul(veTokenMinter.veAssetWeights(address(this))).div(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        veTokenMinter.totalWeight()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //mint reward tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ITokenMinter(minter).mint(_address, _veAssetEarned);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L267\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L267</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function getReward(address _account, bool _claimExtras)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    public</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    updateReward(_account)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    returns (bool)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 reward = earned(_account);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (reward &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewards[_account] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardToken.safeTransfer(_account, reward);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IDeposit(operator).rewardClaimed(pid, _account, reward);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RewardPaid(_account, reward);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //also get rewards from linked rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_claimExtras) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; extraRewards.length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IRewards(extraRewards[i]).getReward(_account);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Remove the <code>VeTokenMinter.withdraw</code> function if possible. Otherwise, update the internal accounting of <code>VeTokenMinter</code> contract during withdrawal so that the actual balance of the $VE3D tokens is taken into consideration within the <code>VeTokenMinter.mint</code>, and the contract will not attempt to transfer more tokens than what it has.</p>\n<p>On a side note, <a href=\"https://github.com/convex-eth/platform/blob/main/contracts/contracts/Cvx.sol\">Convex’s Minter contract</a>, will mint the <code>CRX</code> gov tokens to the users on the fly. See <a href=\"https://github.com/convex-eth/platform/blob/1f11027d429e454dacc4c959502687eaeffdb74a/contracts/contracts/Cvx.sol#L76\">https://github.com/convex-eth/platform/blob/1f11027d429e454dacc4c959502687eaeffdb74a/contracts/contracts/Cvx.sol#L76</a>. Thus, there will not be a case where there is not sufficient <code>CRV</code> tokens in the contract to send to it users.</p>\n<p>However, in VeToken Protocol, it attempts to transfer the portion of pre-minted $VE3D tokens (30 millions) to the users. See <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L72\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L72</a>. Thus, it is possible that there is not enough $VE3D tokens to send to its users if the admin withdraw the pre-minted $VE3D tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/202#issuecomment-1156661445\">solvetony (veToken Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We might need to withdraw, so we need to fix it.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/202#issuecomment-1193401315\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I have to acknowledge that <code>mint</code> can fail if not enough token is present, however I must disagree with the finding.</p>\n<p>The warden is saying that <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L73\"><code>totalSupply</code></a> is going to be a big number, while the number is updated exclusively after minting happens.</p>\n<p>For this reason I think the report is mostly invalid. No math issues will happen due to minting to the contract and then withdrawing as the variables will not be set in unrealistic values.</p>\n<p>However, it is true that <code>mint</code>ing an amount greater than what the contract hold will brick the system.\nFor that reason I’ll consider the report as valid and Medium, however I believe the POC for the high severity finding to be incorrect.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-misconfiguration-of-fees-incentive-might-cause-tokens-to-be-stuck-in-booster-contract\" style=\"position:relative;\"><a href=\"#m-11-misconfiguration-of-fees-incentive-might-cause-tokens-to-be-stuck-in-booster-contract\" aria-label=\"m 11 misconfiguration of fees incentive might cause tokens to be stuck in booster contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/215\">[M-11] Misconfiguration of Fees Incentive Might Cause Tokens To Be Stuck In <code>Booster</code> Contract</a></h2>\n<p><em>Submitted by xiaoming90, also found by 0xNazgul, berndartmueller, cccz, FSchmoede, Funen, kirk-baird, Kumpa, and VAD37</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L193\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L193</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L576\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L576</a></p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>Booster.setFeeInfo</code> function is responsible for setting the allocation of gauge fees between lockers and $VE3D stakers.  <code>lockFeesIncentive</code> and <code>stakerLockFeesIncentive</code> should add up to <code>10000</code> , which is equivalent to <code>100%</code>.</p>\n<p>However, there is no validation check to ensure that that <code>_lockFeesIncentive</code> and <code>_stakerLockFeesIncentive</code> add up to <code>10000</code>. Thus, it entirely depends on the developer to get these two values right.</p>\n<p>As such, it is possible to set <code>lockFeesIncentive + takerLockFeesIncentive</code> to be less than <code>100%</code>. This might happen due to human error. For instance, a typo (forget a few zero) or newly joined developer might not be aware of the fee denomination and called <code>setFeeInfo(40, 60)</code> instead of <code>setFeeInfo(4000, 6000)</code>.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L193\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L193</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 public constant FEE_DENOMINATOR = 10000;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Set reward token and claim contract, get from Curve&#39;s registry</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function setFeeInfo(uint256 _lockFeesIncentive, uint256 _stakerLockFeesIncentive) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(msg.sender == feeManager, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    lockFeesIncentive = _lockFeesIncentive;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    stakerLockFeesIncentive = _stakerLockFeesIncentive;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ..SNIP..</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Assume that <code>setFeeInfo(40, 60)</code> is called instead of of <code>setFeeInfo(4000, 6000)</code>, only <code>1%</code> of the fee collected will be transferred to the users and the remaining <code>99%</code> of the fee collected will be stuck in the <code>Booster</code> contract.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L576\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L576</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function earmarkFees() external returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //claim fee rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IStaker(staker).claimFees(feeDistro, feeToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //send fee rewards to reward contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _balance = IERC20(feeToken).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _lockFeesIncentive = _balance.mul(lockFeesIncentive).div(FEE_DENOMINATOR);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _stakerLockFeesIncentive = _balance.mul(stakerLockFeesIncentive).div(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        FEE_DENOMINATOR</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_lockFeesIncentive &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20(feeToken).safeTransfer(lockFees, _lockFeesIncentive);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IRewards(lockFees).queueNewRewards(_lockFeesIncentive);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (_stakerLockFeesIncentive &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20(feeToken).safeTransfer(stakerLockRewards, _stakerLockFeesIncentive);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IRewards(stakerLockRewards).queueNewRewards(feeToken, _stakerLockFeesIncentive);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h4 id=\"can-we-retrieve-or-save-the-tokens-stuck-in-booster-contract\" style=\"position:relative;\"><a href=\"#can-we-retrieve-or-save-the-tokens-stuck-in-booster-contract\" aria-label=\"can we retrieve or save the tokens stuck in booster contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Can we retrieve or “save” the tokens stuck in <code>Booster</code> contract?</h4>\n<p>Any veAsset (e.g. CRV, ANGLE) sitting on the <code>Booster</code> contract is claimable. However, in this case, the <code>feeToken</code> is likely not a veAsset, thus the remaining gauge fee will be stuck in the <code>Booster</code> contract perpetually. For instance, in Curve, the gauge fee is paid out in 3CRV, the LP token for the TriPool. (<a href=\"https://resources.curve.fi/crv-token/understanding-crv#staking-trading-fees\">Source</a>)</p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Users will lost their gauge fee if this happens.</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement validation check to ensure that <code>lockFeesIncentive</code> and <code>takerLockFeesIncentive</code> add up to 100% to eliminate any risk of misconfiguration.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 public constant FEE_DENOMINATOR = 10000;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Set reward token and claim contract, get from Curve&#39;s registry</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function setFeeInfo(uint256 _lockFeesIncentive, uint256 _stakerLockFeesIncentive) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(msg.sender == feeManager, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(_lockFeesIncentive + _stakerLockFeesIncentive == FEE_DENOMINATOR, &quot;Invalid fees&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    lockFeesIncentive = _lockFeesIncentive;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    stakerLockFeesIncentive = _stakerLockFeesIncentive;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ..SNIP..</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/215#issuecomment-1156735713\">solvetony (veToken Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Will try to provide a fix based on recommendation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/215#issuecomment-1193402631\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown that, due to a lack of checks, a misconfiguration can happen that will cause tokens to be stuck (although temporarily) in the <code>Booster</code>.</p>\n<p>I believe a simple check to ensure:</p>\n<ul>\n<li>Caller incentive is not unfairly high (e.g. 100%)</li>\n<li>Total sums up to 100%</li>\n</ul>\n<p>Would be a great way to give additional guarantees to the contract.</p>\n<p>Agree with Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-malicious-operator-can-rug-pull\" style=\"position:relative;\"><a href=\"#m-12-malicious-operator-can-rug-pull\" aria-label=\"m 12 malicious operator can rug pull permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/4\">[M-12] Malicious operator can rug pull</a></h2>\n<p><em>Submitted by oyc</em>109_</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L138-L143\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L138-L143</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L274-L285\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L274-L285</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>A compromised or malicious operator can withdraw all tokens by calling the function withdrawAll</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">/2022-05-vetoken/contracts/VoterProxy.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">138:     function withdrawAll(address _token, address _gauge) external returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">139:         require(msg.sender == operator, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">140:         uint256 amount = balanceOfPool(_gauge).add(IERC20(_token).balanceOf(address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">141:         withdraw(_token, _gauge, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">142:         return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">143:     }</span></span></code></pre>\n<p>The operator can also call an arbitary address with any value</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">/2022-05-vetoken/contracts/VoterProxy.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">274:     function execute(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">275:         address _to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">276:         uint256 _value,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">277:         bytes calldata _data</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">278:     ) external returns (bool, bytes memory) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">279:         require(msg.sender == operator, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">280: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">281:         (bool success, bytes memory result) = _to.call{value: _value}(_data);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">282:         require(success, &quot;!success&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">283: </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">284:         return (success, result);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">285:     }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/4#issuecomment-1156603061\">jetbrain10 (veToken Finance) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>The operator will be the multi-sig wallet. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/4#issuecomment-1193404020\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown a risk for depositors in that the <code>operator</code> can sweep all tokens out of the contract.</p>\n<p>While this comment is longer than the report, the finding is valid and of medium severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-unused-rewardsbecause-of-totalsupply0-for-some-period-will-be-locked-forever-in-ve3drewardpool-and-baserewardpool\" style=\"position:relative;\"><a href=\"#m-13-unused-rewardsbecause-of-totalsupply0-for-some-period-will-be-locked-forever-in-ve3drewardpool-and-baserewardpool\" aria-label=\"m 13 unused rewardsbecause of totalsupply0 for some period will be locked forever in ve3drewardpool and baserewardpool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/168\">[M-13] Unused rewards(because of totalSupply()==0 for some period) will be locked forever in VE3DRewardPool and BaseRewardPool</a></h2>\n<p><em>Submitted by unforgiven, also found by csanuragjain</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L152-L162\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L152-L162</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L170-L183\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L170-L183</a></p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>VE3DRewardPool</code> and <code>BaseRewardPool</code> contract is supposed to distribute rewards to stackers, but if in some period, <code>totalSupply()</code> was equal to <code>0</code>, then for that time period, rewards will not added to <code>rewardPerTokenStored</code> and those period rewards would not distribute to any address and those rewards will stuck in contract forever.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>notifyRewardAmount()</code> code in <code>BaseRewardPool</code> contract: (<code>VE3DRewardPool</code> code is similar)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">      function notifyRewardAmount(uint256 reward) internal updateReward(address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        historicalRewards = historicalRewards.add(reward);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (block.timestamp &gt;= periodFinish) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardRate = reward.div(duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 remaining = periodFinish.sub(block.timestamp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 leftover = remaining.mul(rewardRate);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            reward = reward.add(leftover);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardRate = reward.div(duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        currentRewards = reward;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lastUpdateTime = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        periodFinish = block.timestamp.add(duration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RewardAdded(reward);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see, in the line <code>rewardRate = reward.div(duration);</code> the value of <code>rewardRate</code> has been set to the division of available <code>reward</code> to <code>duration</code>. so if we distribute <code>rewardRate</code> amount in every second between stackers, then all rewards will be used by contract. contract uses <code>updateReward()</code> modifier to update <code>rewardPerTokenStored</code> (this variable keeps track of distributed tokens) and this modifier uses  <code>rewardPerToken()</code> to update <code>BaseRewardPool</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">      modifier updateReward(address account) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardPerTokenStored = rewardPerToken();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lastUpdateTime = lastTimeRewardApplicable();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (account != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewards[account] = earned(account);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            userRewardPerTokenPaid[account] = rewardPerTokenStored;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit RewardUpdated(account, rewards[account], rewardPerTokenStored, lastUpdateTime);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>This is <code>rewardPerToken()</code> code in <code>BaseRewardPool</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function rewardPerToken() public view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (totalSupply() == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return rewardPerTokenStored;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardPerTokenStored.add(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                lastTimeRewardApplicable().sub(lastUpdateTime).mul(rewardRate).mul(1e18).div(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    totalSupply()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>If for some period <code>totalSupply()</code> was <code>0</code> then contract won’t increase <code>rewardPerTokenStored</code> and those periods reward stuck in contract forever, because there is no mechanism to calculate them and withdraw them in contract.\nFor example if <code>operator</code> deploy and initialize the pool immediately before others having a chance of stacking their tokens, and use <code>queueNewRewards()</code> to queue the rewards then The rewards for early period of pool will be locked forever.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add some mechanism to recalculate <code>rewardRate</code> or calculated undistributed rewards(calculated undistributed reward based on <code>rewardRate</code> and when <code>totalSupply()</code> is <code>0</code>).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/168#issuecomment-1156648983\">solvetony (veToken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Recover function would solve this issue. Middle risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/168#issuecomment-1193413011\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has found a valid problem, however a coded POC would have gone a long way.</p>\n<p>In order to judge the issue I had to code it for myself to be able to demonstrate the problem.</p>\n<p>Anyhow this is a Brownie dump of me setting up the contract (removing transferFrom to get it done rapidly)\nShowing how skipping 1/3 of reward duration will cause a loss of 1/3 of the yield.</p>\n<p>Meaning that the accumulator used for rewards is not redistributing the old rewards</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.lastTimeRewardApplicable()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.queueNewRewards(1e18, {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x0b959c886d959038396aa0a9a82cef39c6bc817e4e48026068b242b0a46df81f</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.queueNewRewards confirmed   Block: 15208165   Gas used: 46822 (0.39%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0x0b959c886d959038396aa0a9a82cef39c6bc817e4e48026068b242b0a46df81f&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.lastTimeRewardApplicable()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1658703966</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.time()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1658703975</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; 1658703966 - 1658703975</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.lastTimeRewardApplicable()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1658703966</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.lastUpdateTime()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1658703966</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.periodFinish()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1659308766</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; 1658703966 - 1659308766</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-604800</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.sleep(604800 // 3) \\#\\# Sleep for third of time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.time()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1658905644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; 1658905644- 1659308766</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-403122</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.stake(1e18, {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x4899faa962b45d2f746db4f045b9858fdd506185cecab019516f4b9cae4bfd37</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 6</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.stake confirmed   Block: 15208166   Gas used: 73201 (0.61%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0x4899faa962b45d2f746db4f045b9858fdd506185cecab019516f4b9cae4bfd37&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.balanceOf(a[0])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1000000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.earned(a[0])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.sleep(x.duration())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.earned(a[0])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.getReward(a[0], False)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0xba12fac5aa76e59d51fa277245cd96db53d7ca2685bdf97abdee734550f102e8</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 7</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.getReward confirmed   Block: 15208167   Gas used: 57623 (0.48%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0xba12fac5aa76e59d51fa277245cd96db53d7ca2685bdf97abdee734550f102e8&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; history[-1].return_value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">666502976190414339</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt;</span></span></code></pre>\n<p>Which means, that the warden has found a valid vulnerability and any time spent with a totalSupply of 0 will cause those rewards to be lost.</p>\n<p>Because this is contingent on:</p>\n<ul>\n<li>No deposits before adding rewards</li>\n<li>Lasts only until a deposit has happened</li>\n<li>Is related to loss of yield</li>\n</ul>\n<p>I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-deposited-staking-tokens-can-be-lost-if-rewards-token-info-added-by-mistake-in-addreward-in-ve3drewardpool-and-there-is-no-checking-to-ensure-this-would-not-happen-ve3token-for-one-reward-was-equal-to-stacking-token\" style=\"position:relative;\"><a href=\"#m-14-deposited-staking-tokens-can-be-lost-if-rewards-token-info-added-by-mistake-in-addreward-in-ve3drewardpool-and-there-is-no-checking-to-ensure-this-would-not-happen-ve3token-for-one-reward-was-equal-to-stacking-token\" aria-label=\"m 14 deposited staking tokens can be lost if rewards token info added by mistake in addreward in ve3drewardpool and there is no checking to ensure this would not happen ve3token for one reward was equal to stacking token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/172\">[M-14] Deposited staking tokens can be lost if rewards token info added by mistake in addReward() in VE3DRewardPool and there is no checking to ensure this would not happen (ve3Token for one reward was equal to stacking token)</a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L102-L112\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L102-L112</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L297-L318\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L297-L318</a></p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If <code>owner</code> by mistake or bad intention add a reward token that <code>ve3Token</code> of <code>new reward</code> token was equal to <code>old reward</code> token address then <code>old reward</code> token balance of <code>VE3DRewardPool</code> can be lost by calling <code>getReward(account, _claimExtras=False,_stake=False)</code> because of the line <code>314</code> which is <code>IERC20(rewardTokenInfo[_rewardToken].ve3Token).safeTransfer(_account,ve3TokenBalance);</code></p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>addReward()</code> code in <code>VE3DRewardPool</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function addReward(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _rewardToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _veAssetDeposits,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _ve3TokenRewards,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _ve3Token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokenInfo[_rewardToken].veAssetDeposits = _veAssetDeposits;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokenInfo[_rewardToken].ve3TokenRewards = _ve3TokenRewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokenInfo[_rewardToken].ve3Token = _ve3Token;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokens.add(_rewardToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see there is no check for values and it sets new <code>rewardToken</code> parameters. This is <code>getReward()</code> code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getReward(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _account,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool _claimExtras,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool _stake</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public updateReward(_account) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _rewardToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint256 i = 0; i &lt; rewardTokens.length(); i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _rewardToken = rewardTokens.at(i);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 reward = earnedReward(_rewardToken, _account);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (reward &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                rewardTokenInfo[_rewardToken].rewards[_account] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IERC20(_rewardToken).safeApprove(rewardTokenInfo[_rewardToken].veAssetDeposits, 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IERC20(_rewardToken).safeApprove(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    rewardTokenInfo[_rewardToken].veAssetDeposits,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    reward</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IVeAssetDeposit(rewardTokenInfo[_rewardToken].veAssetDeposits).deposit(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    reward,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    false</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                uint256 ve3TokenBalance = IERC20(rewardTokenInfo[_rewardToken].ve3Token).balanceOf(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    address(this)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                if (_stake) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    IERC20(rewardTokenInfo[_rewardToken].ve3Token).safeApprove(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        rewardTokenInfo[_rewardToken].ve3TokenRewards,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    IERC20(rewardTokenInfo[_rewardToken].ve3Token).safeApprove(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        rewardTokenInfo[_rewardToken].ve3TokenRewards,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        ve3TokenBalance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    IRewards(rewardTokenInfo[_rewardToken].ve3TokenRewards).stakeFor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        _account,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        ve3TokenBalance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    IERC20(rewardTokenInfo[_rewardToken].ve3Token).safeTransfer(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        _account,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        ve3TokenBalance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                emit RewardPaid(_account, ve3TokenBalance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //also get rewards from linked rewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_claimExtras) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 length = extraRewards.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            for (uint256 i = 0; i &lt; length; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IRewards(extraRewards[i]).getReward(_account);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it loops through all <code>rewardTokens</code> and in line <code>314</code> it transfers all balance of <code>rewardTokenInfo[_rewardToken].ve3Token</code> of contract to <code>account</code> address. So if <code>owner</code> by mistake or bad intention add a new <code>rewardToken</code> that <code>rewardTokenInfo[newRewardToken].ve3Token == oldRewardToken</code> then by calling <code>getReward(account, False, False)</code> contract will loop through all reward tokens and when it reaches the <code>newRewardToken</code> it will transfer all the balance of contract in <code>rewardTokenInfo[newRewardToken].ve3Token</code> address to account address and <code>rewardTokenInfo[newRewardToken].ve3Token</code> is <code>oldRewardToken</code>, so it will transfer all the <code>oldRewardToken</code> balance of contract(which was supposed to be distributed among all stackers) to account address. This is like a backdoor that gives <code>owner</code> the ability to withdraw rewards tokens and if owner makes a simple mistake then one can easily withdraw that contract balance of reward token.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In <code>addReward()</code> check that there is no mistake or any malicious values added to rewards.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/172#issuecomment-1156653388\">solvetony (veToken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>We would try to decrease chance of that, most likely by implementing validation, to reduce manual check for owner.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/172#issuecomment-1193415095\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how due to misconfiguration all rewards could be sent to the first claimer, because this is contingent on a misconfiguration, I believe Medium Severity to be more appropriate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/172#issuecomment-1193416081\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While this report and <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/179\">#179</a> can be grouped as similar, I believe the warden has shown two different potential risks and at this time am choosing to leave the two findings as separate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-owner-should-be-allowed-to-change-feemanager\" style=\"position:relative;\"><a href=\"#m-15-owner-should-be-allowed-to-change-feemanager\" aria-label=\"m 15 owner should be allowed to change feemanager permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/99\">[M-15] Owner should be allowed to change feeManager</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p>Once Fee Manager has been set initially by owner, then owner has no power to change it. Owner should be allowed to change fees manager in case if he feels current fee manager is behaving maliciously</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Observe the setFeeManager function and see that only feeManager is allowed to change it once set initially</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function setFeeManager(address _feeM) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(msg.sender == feeManager, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        feeManager = _feeM;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit FeeManagerUpdated(_feeM);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the setFeeManager function like below. Same can be done with other important functionality involving setArbitrator and setVoteDelegate</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(msg.sender == owner, &quot;!auth&quot;);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/99\">jetbrain10 (veToken Finance) confirmed, but disagreed with severity</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/99#issuecomment-1193425185\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I agree with the finding, the feeManager can also potentially funnel funds away so it’s best to allow governance to replace them if need be.</p>\n<p>Due to the finding being tied to admin privilege, I agree with Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-admin-privilege-in-minting-to-arbitrary-address-allows-operator-to-dilute-tokens\" style=\"position:relative;\"><a href=\"#m-16-admin-privilege-in-minting-to-arbitrary-address-allows-operator-to-dilute-tokens\" aria-label=\"m 16 admin privilege in minting to arbitrary address allows operator to dilute tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/108\">[M-16] Admin Privilege in minting to arbitrary address allows operator to dilute tokens</a></h2>\n<p><em>Submitted by Alex the Entreprenerd, also found by IllIllI</em></p>\n<p><code>veTokenMinter</code> allows any operator to mint new tokens, that’s fine in the context of it being used for:</p>\n<ul>\n<li>having <code>VeAssetDepositor</code> deposit for the user and mint</li>\n<li>Having the <code>Booster</code> mint reward tokens</li>\n</ul>\n<p>However because of the open ended system that allows any address to be set as <code>operator</code>, the system allows the admin to set themselves as the operator and to mint an excess amount of tokens, diluting other users.</p>\n<p>Because this seems to be used exclusively by the <code>VeAssetDepositor</code> and the <code>Booster</code> hardcoding these two addresses would provide stronger security guarantees.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>addOperator(malicious, {“from”: gov})</p>\n<p>mint(malicious, AMOUNT, {“from”: malicious})</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Set the minters as immutable to provide stronger security guarantees.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/108#issuecomment-1156697130\">jetbrain10 (veToken Finance) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Admin will be controlled by DAO to prevent this happen.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/108#issuecomment-1193431886\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Because am judging the contest am forfeiting any winnings.</p>\n<p>I do believe that the system would be best if the minters where hardcoded (it would also save gas).</p>\n</blockquote>\n<hr>\n<h2 id=\"m-17-missing-sane-bounds-on-asset-weights\" style=\"position:relative;\"><a href=\"#m-17-missing-sane-bounds-on-asset-weights\" aria-label=\"m 17 missing sane bounds on asset weights permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/192\">[M-17] Missing sane bounds on asset weights</a></h2>\n<p><em>Submitted by IllIllI</em></p>\n<p>The admin may fat-finger a change, or be malicious, and have the weights be extreme - ranging from zero to <code>type(uint256).max</code>, which would cause the booster to pay out unexpected amounts</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>No bounds checks in the update function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/VeTokenMinter.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">41       function updateveAssetWeight(address veAssetOperator, uint256 newWeight) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">42           require(operators.contains(veAssetOperator), &quot;not an veAsset operator&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">43           totalWeight -= veAssetWeights[veAssetOperator];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">44           veAssetWeights[veAssetOperator] = newWeight;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">45           totalWeight += newWeight;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">46       }</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L41-L46\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L41-L46</a></p>\n<p>The value is used by the reward contract to determine how much to mint:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/Booster.sol   \\#2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">598       function rewardClaimed(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">599           uint256 _pid,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">600           address _address,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">601           uint256 _amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">602       ) external returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">603           address rewardContract = poolInfo[_pid].veAssetRewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">604           require(msg.sender == rewardContract || msg.sender == lockRewards, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">605           ITokenMinter veTokenMinter = ITokenMinter(minter);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">606           //calc the amount of veAssetEarned</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">607           uint256 _veAssetEarned = _amount.mul(veTokenMinter.veAssetWeights(address(this))).div(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">608               veTokenMinter.totalWeight()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">609           );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">610           //mint reward tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">611           ITokenMinter(minter).mint(_address, _veAssetEarned);</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598-L611\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598-L611</a></p>\n<p>Wrong values will lead to excessive inflation/deflation.</p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Have sane upper/lower limits on the values.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/192#issuecomment-1156727045\">solvetony  (veToken Finance) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>We may consider adding this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/192#issuecomment-1193438892\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how due to a lack of checks certain assets may provide a disproportionate amount of rewards.</p>\n<p>Because this is contingent on an admin mistake, and the impact would be loss or gain of Yield; I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-governance-can-arbitrarily-burn-vetoken-from-any-address\" style=\"position:relative;\"><a href=\"#m-18-governance-can-arbitrarily-burn-vetoken-from-any-address\" aria-label=\"m 18 governance can arbitrarily burn vetoken from any address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/233\">[M-18] Governance can arbitrarily burn VeToken from any address</a></h2>\n<p><em>Submitted by shenwilly</em></p>\n<p>Governance can burn any amount of <code>VeToken</code> from any address.</p>\n<p>Unlike <code>VE3Token</code> which is minted when users deposit veAsset and burned when users withdraw, the <code>burn</code> function in the governance token <code>VeToken.sol</code> is unnecessary and open up the risk of malicious/compromised governance burning user’s token.</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider removing the function, or modify the burn function so it only allows <code>msg.sender</code> to burn the token:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function burn(uint256 _amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _burn(msg.sender, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/233#issuecomment-1156744206\">solvetony (veToken Finance) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We might update readme on that case.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/233#issuecomment-1193449708\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how the operator, which may be the DAO or a privileged Multisig, can burn any tokens.</p>\n<p>While the functionality is part of the system for VE3Token as the system uses it to track underlying ownership, burning of balances from arbitrary addresses is a dangerous form of admin privilege.</p>\n<p>I’d recommend deleting the burn function.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-19-ve3drewardpool-claim-in-loop-depend-on-pausable-token\" style=\"position:relative;\"><a href=\"#m-19-ve3drewardpool-claim-in-loop-depend-on-pausable-token\" aria-label=\"m 19 ve3drewardpool claim in loop depend on pausable token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/166\">[M-19] <code>VE3DRewardPool</code> claim in loop depend on pausable token</a></h2>\n<p><em>Submitted by VAD37</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L296-L299\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L296-L299</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/1be2f03670e407908f175c08cf8cc0ce96c55baf/contracts/VeAssetDepositor.sol#L134-L152\">https://github.com/code-423n4/2022-05-vetoken/blob/1be2f03670e407908f175c08cf8cc0ce96c55baf/contracts/VeAssetDepositor.sol#L134-L152</a></p>\n<h3 id=\"vulnerability-details-1\" style=\"position:relative;\"><a href=\"#vulnerability-details-1\" aria-label=\"vulnerability details 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>Project veToken is supposed to be a generalized version of Convex for non-Curve token.\nThere is only one contract for all rewards token in the platform.</p>\n<p>All ve3Token rewards are bundled together inside <code>ve3DLocker</code> and <code>ve3DRewardPool</code> in a loop. Instead of having its own unique contract like <code>VeAssetDepositer</code> or <code>VoterProxy</code> for each token.</p>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If one token has pausable transfer, user cannot claim rewards or withdraw if they have multiple rewards include that pause token.</p>\n<p>Right now the project intends to support only 6 tokens, including Ribbon token which has <a href=\"https://etherscan.io/address/0x6123b0049f904d730db3c36a31167d9d4121fa6b#code#L810\">pausable transfer</a> controlled by Ribbon DAO.</p>\n<p>Normally, this would not be an issue in Convex where only a few pools would be affected by single coin. Since, veAsset are bundled together into single reward pool, it becomes a major problem.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li>Token like Ribbon pause token transfer by DAO due to an unfortunate event.</li>\n<li><code>VE3DRewardPool</code> try call <code>getReward()</code>, <code>VeAssetDepositor</code> <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L296-L299\">try deposit token from earned rewards</a> does not work anymore because <code>IERC20.transfer</code> <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/1be2f03670e407908f175c08cf8cc0ce96c55baf/contracts/VeAssetDepositor.sol#L134-L152\">is blocked</a>. This effectively reverts current function if user have this token reward > 0.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It would be a better practice if we had a second <code>getReward()</code> function that accepts an array of token that we would like to interact with.</p>\n<p>It saves gas and only requires some extra work on frontend website.\nInstead of current implementation, withdraw all token bundles together.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/166#issuecomment-1156706193\">solvetony (veToken Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>It might happen rarely, but we might fix that.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/166#issuecomment-1194847379\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, in certain cases, because a reward token could be pausable, this can cause the entire claim process to break as <code>getReward</code> doesn’t allow the caller to specify which tokens to receive.</p>\n<p>I have to agree that the odds are low, however the finding is valid and because it’s reliant on external conditions I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-20-contracts-should-be-robust-to-upgrades-of-underlying-gauges-and-eventually-changes-of-the-underlying-tokens\" style=\"position:relative;\"><a href=\"#m-20-contracts-should-be-robust-to-upgrades-of-underlying-gauges-and-eventually-changes-of-the-underlying-tokens\" aria-label=\"m 20 contracts should be robust to upgrades of underlying gauges and eventually changes of the underlying tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/50\">[M-20] Contracts should be robust to upgrades of underlying gauges and eventually changes of the underlying tokens</a></h2>\n<p><em>Submitted by Picodes</em></p>\n<p>For some veAsset project (for example Angle’s <a href=\"https://github.com/AngleProtocol/angle-core/blob/main/contracts/staking/LiquidityGaugeV4UpgradedToken.vy\">gauges</a>, gauge contracts are upgradable, so interfaces and underlying LP tokens are subject to change, blocking and freezing the system. Note that this is not hypothetic as it happened a few weeks ago: see this <a href=\"https://snapshot.org/#/anglegovernance.eth/proposal/0x1adb0a958220b3dcb54d2cb426ca19110486a598a41a75b3b37c51bfbd299513\">snapshot vote</a>. Therefore, the system should be robust to a change in the pair gauge / token.</p>\n<p>Note that is doable in the current setup for the veToken team to rescue the funds in such case, hence it is only a medium issue.\nYou’d have to do as follow: a painful shutdown of the <code>Booster</code> (which would lead to an horrible situation where you’d have to preserve backwards compatibility for LPs to save their funds in the new Booster), an operator change in <code>VoterProxy</code> to be able to call <code>execute</code>.</p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To deal with upgradeable contracts, either the <code>VoterProxy</code> needs to be upgradable to deal with any situation that may arise, either you need to add upgradeable “intermediate” contracts between the <code>staker</code> and the gauge that could be changed to preserve the logic.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/50#issuecomment-1156647119\">jetbrain10 (veToken Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Same as answer <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/49\">#49</a>  for angle Voter Proxy, will make it upgrade able and make all future VoterProxy can be upgrade able as well if veAsset project agrees.  </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/50#issuecomment-1194878444\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to integrating with underlying upgradeable contracts, the Sponsors Contracts could get bricked or forced into a shutdown.</p>\n<p>I believe the finding to be equivalent to showing how the system could end up being attached to a bad gauge, and the warden has shown historical proof that this has happened and could happen again.</p>\n<p>For those reasons, as well as the Sponsor Confirming, I believe the finding to be valid and of Medium Severity.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-21-voterproxy-incorrectly-assumes-a-1-1-mapping-between-the-gauge-and-the-lp-tokens\" style=\"position:relative;\"><a href=\"#m-21-voterproxy-incorrectly-assumes-a-1-1-mapping-between-the-gauge-and-the-lp-tokens\" aria-label=\"m 21 voterproxy incorrectly assumes a 1 1 mapping between the gauge and the lp tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/51\">[M-21] <code>VoterProxy</code> incorrectly assumes a 1-1 mapping between the gauge and the LP tokens.</a></h2>\n<p><em>Submitted by Picodes</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L270\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L270</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L140\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L140</a></p>\n<h3 id=\"impact-9\" style=\"position:relative;\"><a href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When calling <code>withdrawAll</code>, to compute the amount to withdraw, the contract checks the balance of gauge tokens and assume that <code>1 gauge token = 1 LP token</code> by doing <code>uint256 amount = balanceOfPool(_gauge).add(IERC20(_token).balanceOf(address(this)));</code>. Overall this assumption may not hold and this would lead to a loss of funds when calling <code>withdrawAll</code>.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Indeed this is false in some cases, check for example <a href=\"https://etherscan.io/address/0x3785Ce82be62a342052b9E5431e9D3a839cfB581\">https://etherscan.io/address/0x3785Ce82be62a342052b9E5431e9D3a839cfB581</a> where the total supply is not the same as the balance of LP tokens held by the contract. You can also check the contract code where you can see there is a <code>staking_factor</code> between the balance and the underlying LP token balance.</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use the total supply of <code>pool.token</code> which is a better proxy to know how much to withdraw when withdrawing all.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/51#issuecomment-1156648009\">jetbrain10 (veToken Finance) commented</a>:</strong></p>\n<blockquote>\n<p>Are you referring we need to calc the staking _factor by ourself?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/51#issuecomment-1193441785\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@jetbrain10 the warden says that some Deposits will not return the same amount of Lp Tokens.</p>\n<p>See this example from the contract linked by the Warden:\n<a href=\"https://etherscan.io/tx/0xd3eab573697d4fb92ebe4d91d35b03795d384ac45f7a723b321c98f6da2420cb\">https://etherscan.io/tx/0xd3eab573697d4fb92ebe4d91d35b03795d384ac45f7a723b321c98f6da2420cb</a></p>\n<p>I think this means the contracts may break when integrating with Angle Protocol.</p>\n<p>As far as I’m aware CRV, Balancer will return a 1-1 between the Deposit Token and the Gauge Token.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/51#issuecomment-1194879916\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown evidence of the GaugeLP-Token being “rebased” from the “usual” 1-1 to a ratio (assuming due to cost / increasing in value in underlying).</p>\n<p>Because:</p>\n<ul>\n<li>The Sponsor system is meant to integrate with multiple protocols</li>\n<li>The warden has shown a specific example (ANGLE) of the math bring broken</li>\n</ul>\n<p>Considering that this is contingent on the sponsor launching an integration with the Angle Protocol, using Gauges that “rebase”, I believe the finding to be Valid and of Medium Severity.</p>\n<p>Most likely remediation will require poking the gauge for exchange rates and also checking available tokens after withdrawing.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/51\">jetbrain10 (veToken Finance) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-22-ve3drewardpool-allows-the-same-reward-address-to-be-added-multiple-times-to-the-extrarewards-array\" style=\"position:relative;\"><a href=\"#m-22-ve3drewardpool-allows-the-same-reward-address-to-be-added-multiple-times-to-the-extrarewards-array\" aria-label=\"m 22 ve3drewardpool allows the same reward address to be added multiple times to the extrarewards array permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/55\">[M-22] VE3DRewardPool allows the same reward address to be added multiple times to the <code>extraRewards</code> array</a></h2>\n<p><em>Submitted by Ruhum</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L134-L139\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L134-L139</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L214-L216\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L214-L216</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L121\">https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L121</a></p>\n<h3 id=\"impact-10\" style=\"position:relative;\"><a href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>When the same address is included twice it might cause issues depending on the contract. I checked the current convex contract to see which addresses were added to the <code>extraRewards</code> array. For <a href=\"https://etherscan.io/address/0x3Fe65692bfCD0e6CF84cB1E7d24108E434A7587e#readContract\">cvxCRV Rewards</a> there’s only <a href=\"https://etherscan.io/address/0x7091dbb7fcbA54569eF1387Ac89Eb2a5C9F6d2EA#code\">0x7091dbb7fcbA54569eF1387Ac89Eb2a5C9F6d2EA</a> which is the VirtualBalanceRewardPool contract.</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li><code>rewardManager</code> adds the same address twice through <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L134-L139\"><code>addExtraReward()</code></a></li>\n<li>VE3DRewardPool calls <a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L209-L226\"><code>stake()</code></a> twice with the same amount:</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateReward</span><span class=\"mtk1\">(msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;RewardPool : Cannot stake 0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//also stake to linked rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">extraRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IRewards</span><span class=\"mtk1\">(</span><span class=\"mtk12\">extraRewards</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//add supply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//add to sender balance sheet</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">].</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//take tokens from sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Staked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Prevent the same addresses from being added multiple times to the <code>extraRewards</code> array.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/55#issuecomment-1156650189\">jetbrain10 (vetoken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Will add code to check if this is same reward address.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/55#issuecomment-1194880451\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a misconfiguration, rewards could be disbursed twice, breaking protocol invariants.</p>\n<p>Because this is contingent on admin privilege, I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-23-baserewardpools-rewardpertokenstored-can-be-inflated-and-rewards-can-be-stolen\" style=\"position:relative;\"><a href=\"#m-23-baserewardpools-rewardpertokenstored-can-be-inflated-and-rewards-can-be-stolen\" aria-label=\"m 23 baserewardpools rewardpertokenstored can be inflated and rewards can be stolen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/201\">[M-23] BaseRewardPool’s <code>rewardPerTokenStored</code> can be inflated and rewards can be stolen</a></h2>\n<p><em>Submitted by sorrynotsorry</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L180\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L180</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L137-L142\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L137-L142</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L157-L159\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L157-L159</a></p>\n<h3 id=\"impact-11\" style=\"position:relative;\"><a href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The first user who calls BaseRewardPool’s <code>stake()</code> function with 1 wei can inflate the <code>rewardPerTokenStored</code>. And the same user can call <code>withdraw</code> and drain the rewards.</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>When a user call <code>stake()</code> with 1 wei,  it updates the <code>_totalSupply</code> as 1 wei  and the <code>rewards</code> through <code>updateReward</code> modifier.\nThis modifier calls <code>rewardPerToken()</code> to assign the return to <code>rewardPerTokenStored</code> and assigns it to the account via <code>userRewardPerTokenPaid[account] = rewardPerTokenStored;</code>\n<code>rewardPerToken()</code> formula is as below;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function rewardPerToken() public view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (totalSupply() == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return rewardPerTokenStored;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardPerTokenStored.add(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                lastTimeRewardApplicable().sub(lastUpdateTime).mul(rewardRate).mul(1e18).div(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    totalSupply()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Since it depends on the denominator  as totalSupply(), the whole multiplying will be divided by 1 wei which will inflate the <code>rewardPerTokenStored</code> astronomically.\nAnd there is no obstacle for the user to withdraw it in the withdraw function.</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L180\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L180</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L137-L142\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L137-L142</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L157-L159\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L157-L159</a></p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The team might consider to add boundries to reward the stakers to be consistent inside the limits.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/201#issuecomment-1156660229\">solvetony (veToken Finance) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is the rare case when only one staker in the pool.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/201#issuecomment-1196128779\">Alex the Entreprenerd (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>This report would have heavily benefited by a coded POC.</p>\n<p>I’m pasting my raw data from terminal (typos and stuff included)</p>\n<h2 id=\"compare-for-unfairness\" style=\"position:relative;\"><a href=\"#compare-for-unfairness\" aria-label=\"compare for unfairness permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compare for unfairness</h2>\n<p>Seems to be unfair toward the early depositor, but not too crazily</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x = BaseRewardPool.deploy(1, ETH_ADDRESS, ETH_ADDRESS, a[0], a[0], {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x981137ae6eead737b5a56a58f03046f184b9482c7b85307c3eba140a401a92f5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 4</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.constructor confirmed   Block: 15221212   Gas used: 863738 (7.20%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool deployed at: 0xe0aA552A10d7EC8760Fc6c246D391E698a82dDf9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.stake(1, {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x03971a1e78ab54979f834746436488f1cb49c5a483957f0ce01f409124bd38d5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.stake confirmed   Block: 15221213   Gas used: 79754 (0.66%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0x03971a1e78ab54979f834746436488f1cb49c5a483957f0ce01f409124bd38d5&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.queueNewRewards(1e18, {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0xb88fe369ed4b49f8043d67354f3429f41a403fa98b4e74a82a2a773ae00186d9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 6</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.queueNewRewards confirmed   Block: 15221214   Gas used: 39180 (0.33%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0xb88fe369ed4b49f8043d67354f3429f41a403fa98b4e74a82a2a773ae00186d9&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.sleep(x.duration() // 10)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;bound method Chain.time of &lt;Chain object (chainid=1, height=15221214)&gt;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.time()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1658940912</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.sleep(x.duration() // 10)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.time()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">1659001396</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.stake(1, {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0xea095333668d2f89979e55bfd7252e6c117d875bfbb628ee853383a3da3064e5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 7</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.stake confirmed   Block: 15221215   Gas used: 74391 (0.62%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0xea095333668d2f89979e55bfd7252e6c117d875bfbb628ee853383a3da3064e5&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.stake(10, {&quot;from&quot;: a[1]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x85f2de5caee675c9c9889533804c65cb6b337f3dcb714af718fec70bc33a34d6</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.stake confirmed   Block: 15221216   Gas used: 100191 (0.83%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0x85f2de5caee675c9c9889533804c65cb6b337f3dcb714af718fec70bc33a34d6&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; chain.sleep(x.duration())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; first = x.getReward({&quot;from&quot;: a[0]).return_value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  File &quot;&lt;console&gt;&quot;, line 1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    first = x.getReward({&quot;from&quot;: a[0]).return_value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                     ^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SyntaxError: closing parenthesis &#39;)&#39; does not match opening parenthesis &#39;{&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; first = x.getReward({&quot;from&quot;: a[0]).return_value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  File &quot;&lt;console&gt;&quot;, line 1,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    first = x.getReward({&quot;from&quot;: a[0]).return_value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                                     ^</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SyntaxError: closing parenthesis &#39;)&#39; does not match opening parenthesis &#39;{&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; first = x.getReward({&quot;from&quot;: a[0]}).return_value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x6cd0057d7a1c9586b6bb75324d1871fbce02b661c2bd957ee4d58adee58799d2</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 8</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.getReward confirmed   Block: 15221217   Gas used: 56876 (0.47%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; second = x.getReward({&quot;from&quot;: a[1]}).return_value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x2fc7122fe33c2b332d32c1bc634ef9ec5d94133fc41168408cbdec954e5bc8ad</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 6</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.getReward confirmed   Block: 15221218   Gas used: 48476 (0.40%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; first</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">True</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; second</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">True</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.userRewardPerTokenPaid(a[0])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">266715305335072250583333333333333333</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.userRewardPerTokenPaid(a[1])</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">266715305335072250583333333333333333</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\\#\\# Second User (10 deposited)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; history[-1].events</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{&#39;RewardUpdated&#39;: [OrderedDict([(&#39;user&#39;, &#39;0x33A4622B82D4c04a53e170c638B944ce27cffce3&#39;), (&#39;reward&#39;, 666615685626040430), (&#39;rewardPerTokenStored&#39;, 266715305335072250583333333333333333), (&#39;lastUpdateTime&#39;, 1659485217)])]}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\\#\\# First user 2 deposited (early 1 /10th of time)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; history[-2].events</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{&#39;RewardUpdated&#39;: [OrderedDict([(&#39;user&#39;, &#39;0x66aB6D9362d4F35596279692F0251Db635165871&#39;), (&#39;reward&#39;, 333384314373866769), (&#39;rewardPerTokenStored&#39;, 266715305335072250583333333333333333), (&#39;lastUpdateTime&#39;, 1659485217)])]}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt;</span></span></code></pre>\n<p>## Deposit, front-run rewards and withdraw</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.stake(1, {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x03971a1e78ab54979f834746436488f1cb49c5a483957f0ce01f409124bd38d5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.stake confirmed   Block: 15221254   Gas used: 79754 (0.66%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0x03971a1e78ab54979f834746436488f1cb49c5a483957f0ce01f409124bd38d5&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.queueNewRewards(1e18, {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0xb88fe369ed4b49f8043d67354f3429f41a403fa98b4e74a82a2a773ae00186d9</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 6</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.queueNewRewards confirmed   Block: 15221255   Gas used: 39180 (0.33%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0xb88fe369ed4b49f8043d67354f3429f41a403fa98b4e74a82a2a773ae00186d9&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; x.withdraw(1, False, {&quot;from&quot;: a[0]})</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Transaction sent: 0x28e3687fb982c9473cd4c79e5a04e66f90cc1ab7182d6d55c6a790716d3aeddf</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 7</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  BaseRewardPool.withdraw confirmed   Block: 15221256   Gas used: 44611 (0.37%)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&lt;Transaction &#39;0x28e3687fb982c9473cd4c79e5a04e66f90cc1ab7182d6d55c6a790716d3aeddf&#39;&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; history[-1].events</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{&#39;RewardUpdated&#39;: [OrderedDict([(&#39;user&#39;, &#39;0x66aB6D9362d4F35596279692F0251Db635165871&#39;), (&#39;reward&#39;, 46296296296292), (&#39;rewardPerTokenStored&#39;, 46296296296292000000000000000000), (&#39;lastUpdateTime&#39;, 1658880907)])]}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt; 46296296296292 / 1e18</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">4.6296296296292e-05</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&gt;&gt;&gt;</span></span></code></pre>\n<p>Let’s compare against a more non-malicious realistic deposit of 1e18\n(Same as above but stake and withdraw for 1e18)</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">{&#39;RewardUpdated&#39;: [OrderedDict([(&#39;user&#39;, &#39;0x66aB6D9362d4F35596279692F0251Db635165871&#39;), (&#39;reward&#39;, 14880952380951), (&#39;rewardPerTokenStored&#39;, 14880952380951), (&#39;lastUpdateTime&#39;, 1658880998)])]}</span></span></code></pre>\n<p>Seems to receive 3 times less rewards</p>\n<p>I think there may be a lot more to uncover, and this finding would have benefitted by more time invested in coding a POC.</p>\n<p>With the information that I have, it does seem like, due to the supply math, that early depositors can inflate the amount of rewards they receive by depositing a small amount.</p>\n<p>It may be advisable to discuss this with the Synthetix team to see historically how this can be griefed, and it may be ideal to require an initial deposit of at least 1e18 tokens on the first deposit.</p>\n<p>Because the finding is:</p>\n<ul>\n<li>Limited to loss of yield</li>\n<li>Lacks Coded POC showing how to steal all rewards (my due diligence denies that statement)</li>\n</ul>\n<p>I think Medium Severity is more appropriate</p>\n</blockquote>\n<hr>\n<h2 id=\"m-24-user-can-lose-funds\" style=\"position:relative;\"><a href=\"#m-24-user-can-lose-funds\" aria-label=\"m 24 user can lose funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/13\">[M-24] User can lose funds</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p>If <code>\\_rewardToken</code> is set as <code>\\_stakingToken</code> by mistake then user funds would get lost (staking token will get sent as reward token). Need to be fixed for BaseRewardPool.sol as well.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>User A and B makes deposit of amount 100 each</li>\n<li>Owner calls addReward and queueNewRewards to add 1 reward amount with _rewardToken as stakingToken (by mistake)</li>\n<li>After some time reward is calculated as 5 for User A (total reward amount is same as staking amount which is 100+100+1).</li>\n<li>User A makes the withdraw and obtains 105 amount and now User B is stuck since contract does not have enough funds</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add below check in constructor</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(_stakingToken!=_rewardToken, &quot;Incorrect reward token&quot;);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/13#issuecomment-1156617737\">jetbrain10 (veToken Finance) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>It’s set by owner, so there is no issue, but it is nice to have and it is a quick fix.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/13#issuecomment-1196137029\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a misconfiguration, the deposit token <code>stakingToken</code> could be transferred away to early withdrawers.</p>\n<p>For end users the basic due diligence would be to ensure that the <code>stakingToken</code> is not added as reward.</p>\n<p>Because the finding is contingent on a malicious admin / misconfiguration, I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-25-consistently-check-account-balance-before-and-after-transfers-for-fee-on-transfer-discrepancies\" style=\"position:relative;\"><a href=\"#m-25-consistently-check-account-balance-before-and-after-transfers-for-fee-on-transfer-discrepancies\" aria-label=\"m 25 consistently check account balance before and after transfers for fee on transfer discrepancies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/190\">[M-25] Consistently check account balance before and after transfers for Fee-On-Transfer discrepancies</a></h2>\n<p><em>Submitted by Dravee, also found by pauliax</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L356\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L356</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L337\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L337</a></p>\n<h3 id=\"vulnerability-details-2\" style=\"position:relative;\"><a href=\"#vulnerability-details-2\" aria-label=\"vulnerability details 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>As arbitrary ERC20 tokens can be passed, the amount here should be calculated every time to take into consideration a possible fee-on-transfer or deflation.</p>\n<p>Also, it’s a good practice for the future of the solution.</p>\n<p>Affected code:</p>\n<ul>\n<li>File: Booster.sol</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">345:     function deposit(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">346:         uint256 _pid,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">347:         uint256 _amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">348:         bool _stake</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">349:     ) public returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">356:         IERC20(lptoken).safeTransferFrom(msg.sender, staker, _amount); //@audit medium: not compatible with Fee On Transfer Tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">372:             ITokenMinter(token).mint(address(this), _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">374:             IERC20(token).safeApprove(rewardContract, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">375:             IRewards(rewardContract).stakeFor(msg.sender, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">378:             ITokenMinter(token).mint(msg.sender, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">381:         emit Deposited(msg.sender, _pid, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span></code></pre>\n<ul>\n<li>File: VE3DRewardPool.sol</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">336:     function donate(address _rewardToken, uint256 _amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">337:         IERC20(_rewardToken).safeTransferFrom(msg.sender, address(this), _amount); //@audit medium: not compatible with Fee On Transfer Tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">338:         rewardTokenInfo[_rewardToken].queuedRewards += _amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">339:     }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use the balance before and after the transfer to calculate the received amount instead of assuming that it would be equal to the amount passed as a parameter.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/190#issuecomment-1156725976\">solvetony (veToken Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Confirmed in donate function, we are have to add a check for the reward token list\nHowever, I don’t think we do anything with lp token as we already use the exact lp token address</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/190#issuecomment-1196138241\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While I think the scenario is highly unlikely, the warden has shown how, in the case of a <code>feeOnTransfer</code> token being added as reward, the claiming of reward could be potentially broken.</p>\n<p>Remediation can be as simple as checking for the actual transferred amount in the <code>donate</code> function, or simply not allowing the tokens.</p>\n<p>However, because the warden has shown how the system could be bricked due to a configuration issue, I believe Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-26-ve3dlockersol-wrong-implementation-of-inversely-traverse-for-loops-always-reverts\" style=\"position:relative;\"><a href=\"#m-26-ve3dlockersol-wrong-implementation-of-inversely-traverse-for-loops-always-reverts\" aria-label=\"m 26 ve3dlockersol wrong implementation of inversely traverse for loops always reverts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/150\">[M-26] <code>VE3DLocker.sol</code> Wrong implementation of inversely traverse for loops always reverts</a></h2>\n<p><em>Submitted by WatchPug, also found by Dravee, gzeon, and TerrierLover</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L305-L329\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L305-L329</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L349-L373\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L349-L373</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L376-L396\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L376-L396</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L399-L415\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L399-L415</a></p>\n<h3 id=\"vulnerability-details-3\" style=\"position:relative;\"><a href=\"#vulnerability-details-3\" aria-label=\"vulnerability details 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function totalSupplyAtEpoch(uint256 _epoch) external view returns (uint256 supply) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 epochStart = uint256(epochs[_epoch].date).div(rewardsDuration).mul(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardsDuration</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 cutoffEpoch = epochStart.sub(lockDuration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //traverse inversely to make more current queries more gas efficient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    for (uint256 i = _epoch; i + 1 != 0; i--) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Epoch storage e = epochs[i];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (uint256(e.date) &lt;= cutoffEpoch) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            break;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        supply = supply.add(epochs[i].supply);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return supply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>In <code>VE3DLocker.sol</code>, there are multiple instances in which an inversely traverse for loop is used “to make more current queries more gas efficient”.</p>\n<p>For example:</p>\n<ul>\n<li><code>totalSupplyAtEpoch()</code></li>\n<li><code>balanceAtEpochOf()</code></li>\n<li><code>pendingLockAtEpochOf()</code></li>\n<li><code>totalSupply()</code></li>\n</ul>\n<p>The implementation of the inversely traverse for loop is inherited from Convex’s original version: <a href=\"https://github.com/convex-eth/platform/blob/main/contracts/contracts/CvxLockerV2.sol#L333-L334\">https://github.com/convex-eth/platform/blob/main/contracts/contracts/CvxLockerV2.sol#L333-L334</a></p>\n<p>However, Convex’s locker contract is using Solidity 0.6.12, in which the arithmetic operations will overflow/underflow without revert.</p>\n<p>As the solidity version used in the current implementation of <code>VE3DLocker.sol</code> is <code>0.8.7</code>, and there are some breaking changes in Solidity v0.8.0, including:</p>\n<blockquote>\n<p>Arithmetic operations revert on underflow and overflow.</p>\n</blockquote>\n<p>Ref: <a href=\"https://docs.soliditylang.org/en/v0.8.7/080-breaking-changes.html#silent-changes-of-the-semantics\">https://docs.soliditylang.org/en/v0.8.7/080-breaking-changes.html#silent-changes-of-the-semantics</a></p>\n<p>Which makes the current implementation of inversely traverse for loops always reverts.</p>\n<p>More specifically:</p>\n<ol>\n<li><code>for (uint i = locks.length - 1; i + 1 != 0; i--) {</code> will revert when <code>locks.length == 0</code> at <code>locks.length - 1</code> due to underflow;</li>\n<li><code>for (uint256 i = _epoch; i + 1 != 0; i--) {</code> will loop until <code>i == 0</code> and reverts at <code>i--</code> due to underflow.</li>\n</ol>\n<p>As a result, all these functions will be malfunctioning and all the internal and external usage of these function will always revert.</p>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change <code>VE3DLocker.sol#L315</code> to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i = locks.length; i &gt; 0; i--) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 lockEpoch = uint256(locks[i - 1].unlockTime).sub(lockDuration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //lock epoch must be less or equal to the epoch we&#39;re basing from.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (lockEpoch &lt;= epochTime) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (lockEpoch &gt; cutoffEpoch) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            amount = amount.add(locks[i - 1].amount);</span></span></code></pre>\n<p>Change <code>VE3DLocker.sol#L360</code> to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i = locks.length; i &gt; 0; i--) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 lockEpoch = uint256(locks[i - 1].unlockTime).sub(lockDuration);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //return the next epoch balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (lockEpoch == nextEpoch) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return locks[i - 1].amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (lockEpoch &lt; nextEpoch) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //no need to check anymore</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        break;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Change <code>VE3DLocker.sol#L387</code> to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i = epochindex; i &gt; 0; i--) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Epoch storage e = epochs[i - 1];</span></span></code></pre>\n<p>Change <code>VE3DLocker.sol#L406</code> to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i = _epoch + 1; i &gt; 0; i--) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Epoch storage e = epochs[i - 1];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (uint256(e.date) &lt;= cutoffEpoch) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        break;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    supply = supply.add(e.supply);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/150#issuecomment-1156684581\">solvetony (veToken Finance) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Looks valid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/150#issuecomment-1196144415\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shed light into a underflow that will cause a few functions which logic was ported over from 0.6.12, to revert due to new checks introduced in a more recent version of solidity.</p>\n<p>While the bug is easily fixable, the functions are broken.</p>\n<p>Normally I would be conflicted between a Low and Medium severity as these functions are mostly <code>view</code> and seem to have no particular impact.</p>\n<p>However, due to my familiarity with other Lockers, and the CVX Voting Strategy used I believe the finding implications are that:</p>\n<ul>\n<li>Integrating strategies (tokenizedLocks of the VE3DLocker) would be bricked</li>\n<li>Snapshot wouldn’t be usable as it would need to know the balance of a user at a specific epoch</li>\n</ul>\n<p>So am confident in a Medium Severity and have contemplated raising to High, as impact is pretty dramatic.</p>\n<p>Personally am very confident governance couldn’t work without some of the <code>view</code> functions impacted, however, considering that the Warden (and other dups) did not bring in any mention of governance, I think Medium Severity is appropriate.</p>\n<p>I highly recommend the sponsor ensures their governance-related function don’t revert as that would be very problematic.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-27-boosters-shutdownpool-can-freeze-user-funds\" style=\"position:relative;\"><a href=\"#m-27-boosters-shutdownpool-can-freeze-user-funds\" aria-label=\"m 27 boosters shutdownpool can freeze user funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/35\">[M-27] Booster’s shutdownPool can freeze user funds</a></h2>\n<p><em>Submitted by hyh, also found by jonatascm</em></p>\n<p><code>shutdownPool()</code> marks shutdown successful even if it’s not (i.e. when withdrawAll() call wasn’t successful). As withdrawing logic expect that the pool in shutdown has already provided the funds, and makes no additional attempts to retrieve them, user funds will be frozen permanently as there are no mechanics in place to turn shutdown off for a pool.</p>\n<p>Setting severity to medium as that’s user principal funds freeze scenario conditional on any issues in withdrawAll().</p>\n<h3 id=\"proof-of-concept-22\" style=\"position:relative;\"><a href=\"#proof-of-concept-22\" aria-label=\"proof of concept 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the case of unsuccessful withdrawAll() call the pool nevertheless will be marked as shutdown:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L312-L320\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L312-L320</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        //withdraw from gauge</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        try IStaker(staker).withdrawAll(pool.lptoken, pool.gauge) {} catch {}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pool.shutdown = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        gaugeMap[pool.gauge] = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit PoolShuttedDown(_pid);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>It will block the withdrawals as there will be not enough funds to fulfil the claim:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L408-L422\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L408-L422</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        //pull from gauge if not shutdown</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // if shutdown tokens will be in this contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (!pool.shutdown) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IStaker(staker).withdraw(lptoken, gauge, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //some gauges claim rewards when withdrawing, stash them in a seperate contract until next claim</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //do not call if shutdown since stashes wont have access</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address stash = pool.stash;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (stash != address(0) &amp;&amp; !isShutdown &amp;&amp; !pool.shutdown) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IStash(stash).stashRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //return lp tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20(lptoken).safeTransfer(_to, _amount);</span></span></code></pre>\n<p>This way user funds will be frozen as the system will not attempt to withdraw from the pool, while there will be no funds to transfer to the user and _withdraw() will be reverting on L422 safeTransfer call.</p>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The shutdownPool logic can to be updated:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L307-L320\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L307-L320</a></p>\n<p>Consider unifying the logic with shutdownSystem() and marking the pool shutdown only if withdraw was successful, for example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">//shutdown pool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function shutdownPool(uint256 _pid, bool forced) external returns (bool){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(msg.sende == poolManager, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    PoolInfo storage pool = poolInfo[_pid];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool withdrawSuccess = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //withdraw from gauge</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    try IStaker(staker).withdrawAll(pool.lptoken,pool.gauge){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    \twithdrawSuccess = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } catch {}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (withdrawSuccess || forced) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    pool.shutdown = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t    gaugeMap[pool.gauge] = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit PoolShuttedDown(_pid);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    \treturn true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/35#issuecomment-1156634327\">jetbrain10 (veToken Finance) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Convex has the same, and we may need force shutdown. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/35#issuecomment-1193437919\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>My issue with the submission is that it makes the following statement:\n<code>Setting severity to medium as that's user principal funds freeze scenario conditional on any issues in withdrawAll().</code></p>\n<p>Without mentioning any possible scenario in which <code>withdrawAll</code> could fail</p>\n<p>Given the information that I have we could have reverts if:</p>\n<ul>\n<li>Token is paused (e.g. Tether Blacklist)</li>\n<li>Gauge breaks (not much you can do there, pausing probably won’t help recover funds)</li>\n<li>Misterious bugs in the code, none were mentioned above.</li>\n</ul>\n<p>Will think about severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/35#issuecomment-1196149442\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After reviewing the rest of the contest, I remember marking a finding about Paused tokens with Medium Severity, so while I think the submission could have been made stronger by providing real-world examples of how the tokens could be stuck, to maintain consistency I’ll mark this finding as valid as well.</p>\n<p>As while it’s unspecified how a revert could happen, the try catch irreversible system does mean that a failed rescue bricks the tokens, perhaps a governance only secondary rescue system may be helpful for emergency scenarios.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-28-extrarewardstashv2s-stashrewards-can-become-unavailable\" style=\"position:relative;\"><a href=\"#m-28-extrarewardstashv2s-stashrewards-can-become-unavailable\" aria-label=\"m 28 extrarewardstashv2s stashrewards can become unavailable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/36\">[M-28] ExtraRewardStashV2’s stashRewards can become unavailable</a></h2>\n<p><em>Submitted by hyh</em></p>\n<p>There is no check for the reward token amount to be transferred out in stashRewards(). As reward token list is external (controlled with <code>IGauge(gauge).reward_tokens</code>), and an arbitrary token can end up there, in the case when such token doesn’t allow for zero amount transfers, the stashRewards() managed extra rewards retrieval can become unavailable.</p>\n<p>I.e. stashRewards() can be blocked for even an extended period of time, so all other extra rewards gathering will not be possible. This cannot be controlled by the system as pool reward token list is external.</p>\n<p>Setting the severity to medium as reward gathering is a base functionality of the system and its availability is affected.</p>\n<h3 id=\"proof-of-concept-23\" style=\"position:relative;\"><a href=\"#proof-of-concept-23\" aria-label=\"proof of concept 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>stashRewards()</code> attempts to send the <code>amount</code> to rewardArbitrator() without checking:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV2.sol#L193-L203\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV2.sol#L193-L203</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (activeCount &gt; 1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //take difference of before/after(only send new tokens)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount = IERC20(token).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amount = amount.sub(before);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //send to arbitrator</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address arb = IDeposit(operator).rewardArbitrator();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (arb != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IERC20(token).safeTransfer(arb, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>If <code>IStaker(staker).withdraw()</code> produced no new tokens for any reason, the <code>amount = amount.sub(before)</code> above can be zero:</p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV2.sol#L188-L189\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV2.sol#L188-L189</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 before = IERC20(token).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IStaker(staker).withdraw(token);</span></span></code></pre>\n<p>As reward <code>token</code> can be arbitrary, it can also be reverting on an attempt to transfer zero amounts:</p>\n<p><a href=\"https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers\">https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers</a></p>\n<p>If this be the case then the whole stashRewards() call will be failing until <code>IStaker(staker).withdraw()</code> manage to withdraw some <code>tokens</code> or such <code>token</code> be removed from gauge’s reward token list. Both events aren’t directly controllable by the system.</p>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider running the transfer only when amount is positive:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">-   if (activeCount &gt; 1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+   if (amount &gt; 0 &amp;&amp; activeCount &gt; 1) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //take difference of before/after(only send new tokens)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount = IERC20(token).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        amount = amount.sub(before);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //send to arbitrator</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address arb = IDeposit(operator).rewardArbitrator();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (arb != address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IERC20(token).safeTransfer(arb, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/36\">jetbrain10 (veToken Finance) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/36#issuecomment-1196153811\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a lack of check for zero-transfer, for specific tokens, the <code>stashRewads</code> function can be made to revert, causing it not to process any reward token</p>\n<p>Because this is contingent on the token having zero-balance and reverting, I think Medium Severity to be appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-29-centralisation-risk-voterproxy-owner-may-set-the-operate-to-an-address-they-own-and-drain-all-token-balances\" style=\"position:relative;\"><a href=\"#m-29-centralisation-risk-voterproxy-owner-may-set-the-operate-to-an-address-they-own-and-drain-all-token-balances\" aria-label=\"m 29 centralisation risk voterproxy owner may set the operate to an address they own and drain all token balances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/82\">[M-29] Centralisation RIsk: <code>VoterProxy</code> owner may set the <code>operate</code> to an address they own and drain all token balances</a></h2>\n<p><em>Submitted by kirk-baird</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L274-L285\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L274-L285</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L123-L143\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L123-L143</a></p>\n<h3 id=\"impact-12\" style=\"position:relative;\"><a href=\"#impact-12\" aria-label=\"impact 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>owner</code> of <code>VoterProxy</code> is able to call <code>setOperator()</code> (if the previous operator is shutdown). This allows them to then call <code>execute()</code>, <code>withdraw()</code> or <code>withdrawAll()</code>.</p>\n<p>Execute makes a call to any arbitrary contract with arbitrary data. This may therefore call any ERC20 token, and gauge or the <code>VoterEscrow</code> account and withdraw protocol funds.</p>\n<p>The functions <code>withdraw()</code> and <code>withdrawAll()</code> can also be abused to take all funds deposited in the gauges and transfer them to the owner’s malicious address.</p>\n<p>This poses a significant centralisation risk if the owner private key is compromised or the owner decides to rug pull.</p>\n<h3 id=\"proof-of-concept-24\" style=\"position:relative;\"><a href=\"#proof-of-concept-24\" aria-label=\"proof of concept 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>After the owner has updated the <code>operator</code> via <code>setOperator()</code> they are able to call <code>VoterProxy.execute()</code> to execute any call to any smart contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function execute(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _value,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes calldata _data</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) external returns (bool, bytes memory) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(msg.sender == operator, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (bool success, bytes memory result) = _to.call{value: _value}(_data);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(success, &quot;!success&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return (success, result);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Similarly, for <code>withdraw()</code> and <code>withdrawAll()</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function withdraw(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address _gauge,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(msg.sender == operator, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _balance = IERC20(_token).balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_balance &lt; _amount) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _amount = _withdrawSome(_gauge, _amount.sub(_balance));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _amount = _amount.add(_balance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20(_token).safeTransfer(msg.sender, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function withdrawAll(address _token, address _gauge) external returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(msg.sender == operator, &quot;!auth&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount = balanceOfPool(_gauge).add(IERC20(_token).balanceOf(address(this)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        withdraw(_token, _gauge, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This issue may be mitigated removing the ability for the <code>owner</code> to change the operator in <code>VoterProxy</code>.</p>\n<p>If the functionality is require ensure it is behind a time lock and multisig / dao.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/82#issuecomment-1156665133\">jetbrain10 (veToken Finance) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Admin will be controlled by DAO and muti-sig wallet.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/82#issuecomment-1196155412\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how, due to a couple of permissioned functions, funds may be swept out of the <code>VoterProxy</code>.</p>\n<p>Because this is contingent on a malicious admin, I believe Medium severity to be appropriate.</p>\n<p>For end users I highly recommend making sure that not only the multi-sig is strong (high threshold), but also that is behind a time-lock to ensure you have time to react in case of emergency.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-30-incorrect-deployment-parameters\" style=\"position:relative;\"><a href=\"#m-30-incorrect-deployment-parameters\" aria-label=\"m 30 incorrect deployment parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/52\">[M-30] Incorrect deployment parameters</a></h2>\n<p><em>Submitted by Picodes</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/25_deploy_angle_pools.js#L68\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/25_deploy_angle_pools.js#L68</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/25_deploy_angle_pools.js#L80\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/25_deploy_angle_pools.js#L80</a></p>\n<h3 id=\"impact-13\" style=\"position:relative;\"><a href=\"#impact-13\" aria-label=\"impact 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The address of G-Uni tokens in the deployment scripts are not up to date.</p>\n<h3 id=\"proof-of-concept-25\" style=\"position:relative;\"><a href=\"#proof-of-concept-25\" aria-label=\"proof of concept 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>For example for agEUR/USDC it is 0xedecb43233549c51cc3268b5de840239787ad56c and not 0x2bD9F7974Bc0E4Cb19B8813F8Be6034F3E772add.</p>\n<h3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>For safety why not fetching directly the LP token from the staking contract?</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/52\">jetbrain10 (veToken Finance) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/52#issuecomment-1200279065\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The warden has shown how a configuration file shows that the settings for the project are using an old address.</p>\n<p>While the finding pertains to a setup script (generally out of scope), given that:</p>\n<ul>\n<li>The sponsor has confirmed</li>\n<li>The finding is valid in that using older deployments will cause at the very least a loss of yield</li>\n<li>We already had an instance of bringing an out-of-scope file into scope via Sponsor-Confirming (See: <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/209\">#209</a>)</li>\n</ul>\n<p>With the information I have, I believe the finding to be of Medium Severity and believe the sponsor will mitigate by updating to the Warden suggested addresses.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 51 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/183\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/132\">kirk-baird</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/259\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/159\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/122\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/186\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/75\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/268\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/264\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/103\">SecureZeroX</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/130\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/118\">sseefried</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/223\">xiaoming90</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/58\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/17\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/218\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/125\">berndartmueller</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/221\">dipp</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/177\">Hawkeye</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/139\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/184\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/231\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/63\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/39\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/38\">robee</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/228\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/134\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/241\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/90\">FSchmoede</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/254\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/229\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/9\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/162\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/269\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/232\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/42\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/27\">BouSalman</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/115\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/29\">cogitoergosumsw</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/148\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/193\">GimelSec</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/234\">shenwilly</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/199\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/213\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/48\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/126\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/175\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/2\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/261\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/207\">Chom</a>, and <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/121\">z3s</a>.</em></p>\n<h2 id=\"low-risk-issues\" style=\"position:relative;\"><a href=\"#low-risk-issues\" aria-label=\"low risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>L‑01</td>\n<td align=\"left\"><code>getAPY()</code> returns the wrong answer during leap years</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>L‑02</td>\n<td align=\"left\">Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</td>\n<td align=\"center\">26</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 27 instances over 2 issues</p>\n<h2 id=\"l-01-getapy-returns-the-wrong-answer-during-leap-years\" style=\"position:relative;\"><a href=\"#l-01-getapy-returns-the-wrong-answer-during-leap-years\" aria-label=\"l 01 getapy returns the wrong answer during leap years permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] <code>getAPY()</code> returns the wrong answer during leap years</h2>\n<p>There are more blocks in a year during a leap year. Using a static value for the number of blocks in a year will eventually lead to the wrong answer</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/BaseRewardPool.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">343      function getAPY() external view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">344          return rewardRate.mul(BLOCKS_PER_YEAR).mul(1e18).div(totalSupply());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">345:     }</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L343-L345\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L343-L345</a></p>\n<h2 id=\"l-02-missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\" style=\"position:relative;\"><a href=\"#l-02-missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\" aria-label=\"l 02 missing checks for address0x0 when assigning values to address state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</h2>\n<p><em>There are 26 instances of this issue. (For in-depth details on this and all further low &#x26; non-critical issues with multiple instances, see the warden’s <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/183\">full report</a>.</em></p>\n<h2 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-critical Issues</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>N‑01</td>\n<td align=\"left\">Adding a <code>return</code> statement when the function defines a named return variable, is redundant</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N‑02</td>\n<td align=\"left\"><code>public</code> functions not called by the contract should be declared <code>external</code> instead</td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td>N‑03</td>\n<td align=\"left\"><code>constant</code>s should be defined rather than using magic numbers</td>\n<td align=\"center\">10</td>\n</tr>\n<tr>\n<td>N‑04</td>\n<td align=\"left\">Numeric values having to do with time should use time units for readability</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N‑05</td>\n<td align=\"left\">Large multiples of ten should use scientific notation (e.g. <code>1e6</code>) rather than decimal literals (e.g. <code>1000000</code>), for readability</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N‑06</td>\n<td align=\"left\">Missing event for critical parameter change</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>N‑07</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td>N‑08</td>\n<td align=\"left\">Constant redefined elsewhere</td>\n<td align=\"center\">10</td>\n</tr>\n<tr>\n<td>N‑09</td>\n<td align=\"left\">Inconsistent spacing in comments</td>\n<td align=\"center\">17</td>\n</tr>\n<tr>\n<td>N‑10</td>\n<td align=\"left\">Typos</td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td>N‑11</td>\n<td align=\"left\">File is missing NatSpec</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>N‑12</td>\n<td align=\"left\">NatSpec is incomplete</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N‑13</td>\n<td align=\"left\">Avoid the use of sensitive terms</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N‑14</td>\n<td align=\"left\"><code>safeApprove()</code> is deprecated</td>\n<td align=\"center\">12</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 84 instances over 14 issues</p>\n<h2 id=\"n-01-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\" style=\"position:relative;\"><a href=\"#n-01-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\" aria-label=\"n 01 adding a return statement when the function defines a named return variable is redundant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Adding a <code>return</code> statement when the function defines a named return variable, is redundant</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/VoterProxy.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">119:          return balance;</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L119\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L119</a></p>\n<h2 id=\"n-02-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" style=\"position:relative;\"><a href=\"#n-02-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" aria-label=\"n 02 public functions not called by the contract should be declared external instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] <code>public</code> functions not called by the contract should be declared <code>external</code> instead</h2>\n<p>Contracts <a href=\"https://docs.soliditylang.org/en/latest/contracts.html#function-overriding\">are allowed</a> to override their parents’ functions and change the visibility from <code>external</code> to <code>public</code>.</p>\n<p><em>There are 8 instances of this issue.</em></p>\n<h2 id=\"n-03-constants-should-be-defined-rather-than-using-magic-numbers\" style=\"position:relative;\"><a href=\"#n-03-constants-should-be-defined-rather-than-using-magic-numbers\" aria-label=\"n 03 constants should be defined rather than using magic numbers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] <code>constant</code>s should be defined rather than using magic numbers</h2>\n<p><em>There are 10 instances of this issue.</em></p>\n<h2 id=\"n-04-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\" style=\"position:relative;\"><a href=\"#n-04-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\" aria-label=\"n 04 numeric values having to do with time should use time units for readability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Numeric values having to do with time should use time units for readability</h2>\n<p>There are <a href=\"https://docs.soliditylang.org/en/latest/units-and-global-variables.html#time-units\">units</a> for seconds, minutes, hours, days, and weeks</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/VeAssetDepositor.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/// @audit 86400</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">18:       uint256 private constant WEEK = 7 * 86400;</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeAssetDepositor.sol#L18\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeAssetDepositor.sol#L18</a></p>\n<h2 id=\"n-05-large-multiples-of-ten-should-use-scientific-notation-eg-1e6-rather-than-decimal-literals-eg-1000000-for-readability\" style=\"position:relative;\"><a href=\"#n-05-large-multiples-of-ten-should-use-scientific-notation-eg-1e6-rather-than-decimal-literals-eg-1000000-for-readability\" aria-label=\"n 05 large multiples of ten should use scientific notation eg 1e6 rather than decimal literals eg 1000000 for readability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Large multiples of ten should use scientific notation (e.g. <code>1e6</code>) rather than decimal literals (e.g. <code>1000000</code>), for readability</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/VeTokenMinter.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">15:       uint256 public constant maxSupply = 30 * 1000000 * 1e18; //30mil</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L15\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L15</a></p>\n<h2 id=\"n-06-missing-event-for-critical-parameter-change\" style=\"position:relative;\"><a href=\"#n-06-missing-event-for-critical-parameter-change\" aria-label=\"n 06 missing event for critical parameter change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Missing event for critical parameter change</h2>\n<p><em>There are 5 instances of this issue.</em></p>\n<h2 id=\"n-07-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#n-07-use-a-more-recent-version-of-solidity\" aria-label=\"n 07 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.13 to get the ability to use <code>using for</code> with a list of free functions</p>\n<p><em>There are 6 instances of this issue.</em></p>\n<h2 id=\"n-08-constant-redefined-elsewhere\" style=\"position:relative;\"><a href=\"#n-08-constant-redefined-elsewhere\" aria-label=\"n 08 constant redefined elsewhere permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-08] Constant redefined elsewhere</h2>\n<p>Consider defining in only one contract so that values cannot become out of sync when only one location is updated. A <a href=\"https://medium.com/coinmonks/gas-cost-of-solidity-library-functions-dbe0cedd4678\">cheap way</a> to store constants in a single location is to create an <code>internal constant</code> in a <code>library</code>. If the variable is a local cache of another contract’s value, consider making the cache variable internal or private, which will require external users to query the contract with the source of truth, so that callers don’t get out of sync.</p>\n<p><em>There are 10 instances of this issue.</em></p>\n<h2 id=\"n-09-inconsistent-spacing-in-comments\" style=\"position:relative;\"><a href=\"#n-09-inconsistent-spacing-in-comments\" aria-label=\"n 09 inconsistent spacing in comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-09] Inconsistent spacing in comments</h2>\n<p>Some lines use <code>// x</code> and some use <code>//x</code>. The instances below point out the usages that don’t follow the majority, within each file</p>\n<p><em>There are 17 instances of this issue.</em></p>\n<h2 id=\"n-10-typos\" style=\"position:relative;\"><a href=\"#n-10-typos\" aria-label=\"n 10 typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-10] Typos</h2>\n<p><em>There are 8 instances of this issue.</em></p>\n<h2 id=\"n-11-file-is-missing-natspec\" style=\"position:relative;\"><a href=\"#n-11-file-is-missing-natspec\" aria-label=\"n 11 file is missing natspec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-11] File is missing NatSpec</h2>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"n-12-natspec-is-incomplete\" style=\"position:relative;\"><a href=\"#n-12-natspec-is-incomplete\" aria-label=\"n 12 natspec is incomplete permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-12] NatSpec is incomplete</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/VoterProxy.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/// @audit Missing: &#39;@param bytes&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">191       /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">192        * @notice  Verifies that the hash is valid</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">193        * @dev     Snapshot Hub will call this function when a vote is submitted using</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">194        *          snapshot.js on behalf of this contract. Snapshot Hub will call this</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">195        *          function with the hash and the signature of the vote that was cast.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">196        * @param _hash Hash of the message that was sent to Snapshot Hub to cast a vote</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">197        * @return EIP1271 magic value if the signature is value</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">198        */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">199:      function isValidSignature(bytes32 _hash, bytes memory) public view returns (bytes4) {</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L191-L199\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L191-L199</a></p>\n<h2 id=\"n-13-avoid-the-use-of-sensitive-terms\" style=\"position:relative;\"><a href=\"#n-13-avoid-the-use-of-sensitive-terms\" aria-label=\"n 13 avoid the use of sensitive terms permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-13] Avoid the use of sensitive terms</h2>\n<p>Use <a href=\"https://www.zdnet.com/article/mysql-drops-master-slave-and-blacklist-whitelist-terminology/\">alternative variants</a>, e.g. allowlist/denylist instead of whitelist/blacklist</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/VE3DRewardPool.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">204:         //fees dont apply until whitelist+veVeAsset lock begins so will report</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L204\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L204</a></p>\n<h2 id=\"n-14-safeapprove-is-deprecated\" style=\"position:relative;\"><a href=\"#n-14-safeapprove-is-deprecated\" aria-label=\"n 14 safeapprove is deprecated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-14] <code>safeApprove()</code> is deprecated</h2>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/bfff03c0d2a59bcd8e2ead1da9aed9edf0080d05/contracts/token/ERC20/utils/SafeERC20.sol#L38-L45\">Deprecated</a> in favor of <code>safeIncreaseAllowance()</code> and <code>safeDecreaseAllowance()</code>. If only setting the initial allowance to the value that means infinite, <code>safeIncreaseAllowance()</code> can be used instead</p>\n<p><em>There are 12 instances of this issue.</em></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/183#issuecomment-1156948705\">jetbrain10 (veToken Finance) commented</a>:</strong></p>\n<blockquote>\n<p>High quality.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/183#issuecomment-1179581972\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>2L, 5R, 7NC</p>\n</blockquote>\n<blockquote>\n<p><em>(Note: See <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/183\">original submission</a> for judge’s full commentary.)</em></p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 48 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/181\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/8\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/138\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/182\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/129\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/230\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/153\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/65\">jonatascm</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/37\">robee</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/30\">cogitoergosumsw</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/104\">SecureZeroX</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/158\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/76\">SmartSek</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/135\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/33\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/91\">FSchmoede</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/114\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/59\">0xKitsune</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/167\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/248\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/109\">GalloDaSballo</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/219\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/163\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/57\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/208\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/173\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/113\">Kaiziron</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/171\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/86\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/41\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/43\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/178\">Cityscape</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/147\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/240\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/64\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/180\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/1\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/271\">pauliax</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/272\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/251\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/169\">RoiEvenHaim</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/40\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/174\">saian</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/131\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/146\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/119\">z3s</a>, <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/111\">Hawkeye</a>, and <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/61\">Ruhum</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>G‑01</td>\n<td align=\"left\">Update to state var should only happen once in a function</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>G‑02</td>\n<td align=\"left\">Multiple <code>address</code> mappings can be combined into a single <code>mapping</code> of an <code>address</code> to a <code>struct</code>, where appropriate</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>G‑03</td>\n<td align=\"left\">State variables only set in the constructor should be declared <code>immutable</code></td>\n<td align=\"center\">11</td>\n</tr>\n<tr>\n<td>G‑04</td>\n<td align=\"left\">Avoid contract existence checks by using solidity version 0.8.10 or later</td>\n<td align=\"center\">124</td>\n</tr>\n<tr>\n<td>G‑05</td>\n<td align=\"left\">State variables should be cached in stack variables rather than re-reading them from storage</td>\n<td align=\"center\">39</td>\n</tr>\n<tr>\n<td>G‑06</td>\n<td align=\"left\">Multiple accesses of a mapping/array should use a local variable cache</td>\n<td align=\"center\">30</td>\n</tr>\n<tr>\n<td>G‑07</td>\n<td align=\"left\"><code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>G‑08</td>\n<td align=\"left\"><code>internal</code> functions only called once can be inlined to save gas</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>G‑09</td>\n<td align=\"left\"><code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>G‑10</td>\n<td align=\"left\"><code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</td>\n<td align=\"center\">13</td>\n</tr>\n<tr>\n<td>G‑11</td>\n<td align=\"left\"><code>keccak256()</code> should only need to be called on a specific string literal once</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>G‑12</td>\n<td align=\"left\">Using <code>bool</code>s for storage incurs overhead</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>G‑13</td>\n<td align=\"left\">Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>G‑14</td>\n<td align=\"left\">It costs more gas to initialize variables to zero than to let the default of zero be applied</td>\n<td align=\"center\">14</td>\n</tr>\n<tr>\n<td>G‑15</td>\n<td align=\"left\"><code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</td>\n<td align=\"center\">13</td>\n</tr>\n<tr>\n<td>G‑16</td>\n<td align=\"left\">Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>G‑17</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>G‑18</td>\n<td align=\"left\">Don’t compare boolean expressions to boolean literals</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>G‑19</td>\n<td align=\"left\">Don’t use <code>SafeMath</code> once the solidity version is 0.8.0 or greater</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td>G‑20</td>\n<td align=\"left\">Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</td>\n<td align=\"center\">15</td>\n</tr>\n<tr>\n<td>G‑21</td>\n<td align=\"left\"><code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>G‑22</td>\n<td align=\"left\">Empty blocks should be removed or emit something</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>G‑23</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save deployment gas</td>\n<td align=\"center\">67</td>\n</tr>\n<tr>\n<td>G‑24</td>\n<td align=\"left\">Functions guaranteed to revert when called by normal users can be marked <code>payable</code></td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>G‑25</td>\n<td align=\"left\">Don’t use <code>_msgSender()</code> if not supporting EIP-2771</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 391 instances over 25 issues</p>\n<h2 id=\"g-01-update-to-state-var-should-only-happen-once-in-a-function\" style=\"position:relative;\"><a href=\"#g-01-update-to-state-var-should-only-happen-once-in-a-function\" aria-label=\"g 01 update to state var should only happen once in a function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Update to state var should only happen once in a function</h2>\n<p>The assignment of <code>totalWeight</code> can be optimized by summing the old and new weights</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/VeTokenMinter.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">43           totalWeight -= veAssetWeights[veAssetOperator];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">44           veAssetWeights[veAssetOperator] = newWeight;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">45:          totalWeight += newWeight;</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L43-L45\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L43-L45</a></p>\n<h2 id=\"g-02-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\" style=\"position:relative;\"><a href=\"#g-02-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\" aria-label=\"g 02 multiple address mappings can be combined into a single mapping of an address to a struct where appropriate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Multiple <code>address</code> mappings can be combined into a single <code>mapping</code> of an <code>address</code> to a <code>struct</code>, where appropriate</h2>\n<p>Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (<strong>20000 gas</strong>) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save <strong>~42 gas per access</strong> due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - <strong>30 gas</strong>) and that calculation’s associated stack operations.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/BaseRewardPool.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">75        mapping(address =&gt; uint256) public userRewardPerTokenPaid;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">76        mapping(address =&gt; uint256) public rewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">77:       mapping(address =&gt; uint256) private _balances;</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L75-L77\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L75-L77</a></p>\n<h2 id=\"g-03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\" style=\"position:relative;\"><a href=\"#g-03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\" aria-label=\"g 03 state variables only set in the constructor should be declared immutable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] State variables only set in the constructor should be declared <code>immutable</code></h2>\n<p>Avoids a Gsset (<strong>20000 gas</strong>) in the constructor, and replaces each Gwarmacces (<strong>100 gas</strong>) with a <code>PUSH32</code> (<strong>3 gas</strong>).</p>\n<p><em>There are 11 instances of this issue. (For in-depth details on this and all further gas optimizations with multiple instances, see the warden’s <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/181\">full report</a>.)</em></p>\n<h2 id=\"g-04-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\" style=\"position:relative;\"><a href=\"#g-04-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\" aria-label=\"g 04 avoid contract existence checks by using solidity version 0810 or later permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Avoid contract existence checks by using solidity version 0.8.10 or later</h2>\n<p>Prior to 0.8.10 the compiler inserted extra code, including <code>EXTCODESIZE</code> (<strong>700 gas</strong>), to check for contract existence for external calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value</p>\n<p><em>There are 124 instances of this issue.</em></p>\n<h2 id=\"g-05-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g-05-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g 05 state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p>The instances below point to the second+ access of a state variable within a function. Caching of a state variable replace each Gwarmaccess (<strong>100 gas</strong>) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.</p>\n<p><em>There are 39 instances of this issue.</em></p>\n<h2 id=\"g-06-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" style=\"position:relative;\"><a href=\"#g-06-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" aria-label=\"g 06 multiple accesses of a mappingarray should use a local variable cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Multiple accesses of a mapping/array should use a local variable cache</h2>\n<p>The instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping’s value in a local <code>storage</code> variable when the value is accessed <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">multiple times</a>, saves <strong>~42 gas per access</strong> due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - <strong>30 gas</strong>) and that calculation’s associated stack operations. Caching an array’s struct avoids recalculating the array offsets into memory</p>\n<p><em>There are 30 instances of this issue.</em></p>\n<h2 id=\"g-07-x--y-costs-more-gas-than-x--x--y-for-state-variables\" style=\"position:relative;\"><a href=\"#g-07-x--y-costs-more-gas-than-x--x--y-for-state-variables\" aria-label=\"g 07 x  y costs more gas than x  x  y for state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</h2>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"g-08-internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g-08-internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"g 08 internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] <code>internal</code> functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs <strong>20 to 40 gas</strong> because of two extra <code>JUMP</code> instructions and additional stack operations needed for function calls.</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g-09-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" style=\"position:relative;\"><a href=\"#g-09-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" aria-label=\"g 09 arraylength should not be looked up in every loop of a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</h2>\n<p>The overheads outlined below are <em>PER LOOP</em>, excluding the first loop</p>\n<ul>\n<li>storage arrays incur a Gwarmaccess (<strong>100 gas</strong>)</li>\n<li>memory arrays use <code>MLOAD</code> (<strong>3 gas</strong>)</li>\n<li>calldata arrays use <code>CALLDATALOAD</code> (<strong>3 gas</strong>)</li>\n</ul>\n<p>Caching the length changes each of these to a <code>DUP&#x3C;N></code> (<strong>3 gas</strong>), and gets rid of the extra <code>DUP&#x3C;N></code> needed to store the stack offset</p>\n<p><em>There are 7 instances of this issue.</em></p>\n<h2 id=\"g-10-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" style=\"position:relative;\"><a href=\"#g-10-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" aria-label=\"g 10 ii should be uncheckediuncheckedi when it is not possible for them to overflow as is the case when used in for  and while loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</h2>\n<p>The <code>unchecked</code> keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves <strong>30-40 gas <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked\">per loop</a></strong></p>\n<p><em>There are 13 instances of this issue.</em></p>\n<h2 id=\"g-11-keccak256-should-only-need-to-be-called-on-a-specific-string-literal-once\" style=\"position:relative;\"><a href=\"#g-11-keccak256-should-only-need-to-be-called-on-a-specific-string-literal-once\" aria-label=\"g 11 keccak256 should only need to be called on a specific string literal once permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] <code>keccak256()</code> should only need to be called on a specific string literal once</h2>\n<p>It should be saved to an immutable variable, and the variable used instead. If the hash is being used as a part of a function selector, the cast to <code>bytes4</code> should also only be done once</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">File: contracts/Booster.sol   \\#1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">488:              bytes4(keccak256(&quot;set_rewards_receiver(address)&quot;)),</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L488\">https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L488</a></p>\n<h2 id=\"g-12-using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-12-using-bools-for-storage-incurs-overhead\" aria-label=\"g 12 using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Using <code>bool</code>s for storage incurs overhead</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Booleans are more expensive than uint256 or any type that takes up a full</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // word because each write operation emits an extra SLOAD to first read the</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // back. This is the compiler&#39;s defense against contract upgrades and</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // pointer aliasing, and it cannot be disabled.</span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a><br>\nUse <code>uint256(1)</code> and <code>uint256(2)</code> for true/false to avoid a Gwarmaccess (<strong><a href=\"https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058\">100 gas</a></strong>), and to avoid Gsset (<strong>20000 gas</strong>) when changing from ‘false’ to ‘true’, after having been ‘true’ in the past</p>\n<p><em>There are 5 instances of this issue.</em></p>\n<h2 id=\"g-13-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\" style=\"position:relative;\"><a href=\"#g-13-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\" aria-label=\"g 13 using  0 costs more gas than  0 when used on a uint in a require statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</h2>\n<p>This change saves <strong><a href=\"https://aws1.discourse-cdn.com/business6/uploads/zeppelin/original/2X/3/363a367d6d68851f27d2679d10706cd16d788b96.png\">6 gas</a></strong> per instance</p>\n<p><em>There are 7 instances of this issue.</em></p>\n<h2 id=\"g-14-it-costs-more-gas-to-initialize-variables-to-zero-than-to-let-the-default-of-zero-be-applied\" style=\"position:relative;\"><a href=\"#g-14-it-costs-more-gas-to-initialize-variables-to-zero-than-to-let-the-default-of-zero-be-applied\" aria-label=\"g 14 it costs more gas to initialize variables to zero than to let the default of zero be applied permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-14] It costs more gas to initialize variables to zero than to let the default of zero be applied</h2>\n<p><em>There are 14 instances of this issue.</em></p>\n<h2 id=\"g-15-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#g-15-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"g 15 i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-15] <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves <strong>6 gas per loop</strong></p>\n<p><em>There are 13 instances of this issue.</em></p>\n<h2 id=\"g-16-splitting-require-statements-that-use--saves-gas\" style=\"position:relative;\"><a href=\"#g-16-splitting-require-statements-that-use--saves-gas\" aria-label=\"g 16 splitting require statements that use  saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-16] Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</h2>\n<p>See <a href=\"https://github.com/code-423n4/2022-01-xdefi-findings/issues/128\">this issue</a> which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g-17-using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g-17-using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g 17 using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-17] Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the value can be read from the verified contract source code. Savings are due to the compiler not having to create non-payable getter functions for deployment calldata, and not adding another entry to the method ID table</p>\n<p><em>There are 9 instances of this issue.</em></p>\n<h2 id=\"g-18-dont-compare-boolean-expressions-to-boolean-literals\" style=\"position:relative;\"><a href=\"#g-18-dont-compare-boolean-expressions-to-boolean-literals\" aria-label=\"g 18 dont compare boolean expressions to boolean literals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-18] Don’t compare boolean expressions to boolean literals</h2>\n<p><code>if (&#x3C;x> == true)</code> => <code>if (&#x3C;x>)</code>, <code>if (&#x3C;x> == false)</code> => <code>if (!&#x3C;x>)</code></p>\n<p><em>There are 7 instances of this issue.</em></p>\n<h2 id=\"g-19-dont-use-safemath-once-the-solidity-version-is-080-or-greater\" style=\"position:relative;\"><a href=\"#g-19-dont-use-safemath-once-the-solidity-version-is-080-or-greater\" aria-label=\"g 19 dont use safemath once the solidity version is 080 or greater permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-19] Don’t use <code>SafeMath</code> once the solidity version is 0.8.0 or greater</h2>\n<p>Version 0.8.0 introduces internal overflow checks, so using <code>SafeMath</code> is redundant and adds overhead</p>\n<p><em>There are 6 instances of this issue.</em></p>\n<h2 id=\"g-20-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\" style=\"position:relative;\"><a href=\"#g-20-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\" aria-label=\"g 20 duplicated requirerevert checks should be refactored to a modifier or function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-20] Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</h2>\n<p>Saves deployment costs</p>\n<p><em>There are 15 instances of this issue.</em></p>\n<h2 id=\"g-21-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" style=\"position:relative;\"><a href=\"#g-21-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" aria-label=\"g 21 require or revert statements that check input arguments should be at the top of the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-21] <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</h2>\n<p>Checks that involve constants should come before checks that involve state variables</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"g-22-empty-blocks-should-be-removed-or-emit-something\" style=\"position:relative;\"><a href=\"#g-22-empty-blocks-should-be-removed-or-emit-something\" aria-label=\"g 22 empty blocks should be removed or emit something permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-22] Empty blocks should be removed or emit something</h2>\n<p>The code should be refactored such that they no longer exist, or the block should do something useful, such as emitting an event or reverting. If the contract is meant to be extended, the contract should be <code>abstract</code> and the function signatures be added without any default implementation. If the block is an empty if-statement block to avoid doing subsequent checks in the else-if/else conditions, the else-if/else conditions should be nested under the negation of the if-statement, because they involve different classes of checks, which may lead to the introduction of errors when the code is later modified (<code>if(x){}else if(y){...}else{...}</code> => <code>if(!x){if(y){...}else{...}}</code>)</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"g-23-use-custom-errors-rather-than-revertrequire-strings-to-save-deployment-gas\" style=\"position:relative;\"><a href=\"#g-23-use-custom-errors-rather-than-revertrequire-strings-to-save-deployment-gas\" aria-label=\"g 23 use custom errors rather than revertrequire strings to save deployment gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-23] Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save deployment gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. The instances below match or exceed that version</p>\n<p><em>There are 67 instances of this issue.</em></p>\n<h2 id=\"g-24-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g-24-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g 24 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-24] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n<code>CALLVALUE</code>(2),<code>DUP1</code>(3),<code>ISZERO</code>(3),<code>PUSH2</code>(3),<code>JUMPI</code>(10),<code>PUSH1</code>(3),<code>DUP1</code>(3),<code>REVERT</code>(0),<code>JUMPDEST</code>(1),<code>POP</code>(2), which costs an average of about <strong>21 gas per call</strong> to the function, in addition to the extra deployment cost</p>\n<p><em>There are 7 instances of this issue.</em></p>\n<h2 id=\"g-25-dont-use-_msgsender-if-not-supporting-eip-2771\" style=\"position:relative;\"><a href=\"#g-25-dont-use-_msgsender-if-not-supporting-eip-2771\" aria-label=\"g 25 dont use _msgsender if not supporting eip 2771 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-25] Don’t use <code>_msgSender()</code> if not supporting EIP-2771</h2>\n<p>Use <code>msg.sender</code> if the code does not implement <a href=\"https://eips.ethereum.org/EIPS/eip-2771\">EIP-2771 trusted forwarder</a> support</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/181#issuecomment-1183897399\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Most thorough submission, would like for the warden to add:</p>\n<ul>\n<li>Total Gas Saved per finding next to headline</li>\n<li>POC for some of the contentious stuff (refactor storage, pack, use bool), because some of the advice while generally sound, requires a refactoring that leverages the concept.</li>\n</ul>\n<p>Overall best report for the contest</p>\n</blockquote>\n<blockquote>\n<p>Total Gas Saved\n46633</p>\n</blockquote>\n<blockquote>\n<p><em>(Note: See <a href=\"https://github.com/code-423n4/2022-05-vetoken-findings/issues/181\">original submission</a> for judge’s full commentary.)</em></p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-gauge-rewards-stuck-in-voterproxy-contract-when-extrarewardstashv3-is-used-within-angle-deployment\">[H-01] Gauge Rewards Stuck In <code>VoterProxy</code> Contract When <code>ExtraRewardStashV3</code> Is Used Within Angle Deployment</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-30\">Medium Risk Findings (30)</a></p>\n<ul>\n<li><a href=\"#m-01-compromised-owner-can-drain-funds-fromvetokenmintersol\">[M-01] compromised <code>owner</code> can drain funds from<code>VeTokenMinter.sol</code></a></li>\n<li><a href=\"#m-02-ve3drewardpoolsol-is-incompatible-with-balvebal\">[M-02] VE3DRewardPool.sol is incompatible with Bal/veBal</a></li>\n<li><a href=\"#m-03-no-check-for-existing-extrarewards-during-push\">[M-03] No check for existing extraRewards during push</a></li>\n<li><a href=\"#m-04-user-can-lose-extra-rewards\">[M-04] User can lose extra rewards</a></li>\n<li><a href=\"#m-05-duplicate-lp-token-could-lead-to-incorrect-deposits\">[M-05] Duplicate LP token could lead to incorrect deposits</a></li>\n<li><a href=\"#m-06-incorrectly-set-_maxtime-to-be-in-line-with-the-locking-maxtime-of-each-vetoken-could-render-the-deposit-of-this-contract-to-be-unfunctional-or-even-freeze-assets-inside-the-contract-\">[M-06] Incorrectly set <code>_maxTime</code> to be in line with the locking <code>maxTime</code> of each veToken could render the <code>deposit</code> of this contract to be unfunctional or even freeze assets inside the contract </a></li>\n<li><a href=\"#m-07-ve3drewardpool-and-ve3dlocker-adds-to-an-unbounded-array-which-may-potentially-lock-all-rewards-in-the-contract\">[M-07] <code>VE3DRewardPool</code> and <code>VE3DLocker</code> adds to an unbounded array which may potentially lock all rewards in the contract</a></li>\n<li><a href=\"#m-08-not-updating-totalweight-when-operator-is-removed-in-vetokenminter\">[M-08] Not updating <code>totalWeight</code> when operator is removed in <code>VeTokenMinter</code></a></li>\n<li><a href=\"#m-09-in-notifyrewardamount-of-ve3drewardpool-and-baserewardpool-some-tokes-will-be-locked-and-not-distributed-becasue-of-rounding-error\">[M-09] in notifyRewardAmount() of VE3DRewardPool and BaseRewardPool some tokes will be locked and not distributed becasue of rounding error</a></li>\n<li><a href=\"#m-10-unable-to-get-rewards-if-admin-withdraws-ve3d-tokens-from-vetokenminter-contract\">[M-10] Unable To Get Rewards If Admin Withdraws $VE3D tokens From <code>VeTokenMinter</code> Contract</a></li>\n<li><a href=\"#m-11-misconfiguration-of-fees-incentive-might-cause-tokens-to-be-stuck-in-booster-contract\">[M-11] Misconfiguration of Fees Incentive Might Cause Tokens To Be Stuck In <code>Booster</code> Contract</a></li>\n<li><a href=\"#m-12-malicious-operator-can-rug-pull\">[M-12] Malicious operator can rug pull</a></li>\n<li><a href=\"#m-13-unused-rewardsbecause-of-totalsupply0-for-some-period-will-be-locked-forever-in-ve3drewardpool-and-baserewardpool\">[M-13] Unused rewards(because of totalSupply()==0 for some period) will be locked forever in VE3DRewardPool and BaseRewardPool</a></li>\n<li><a href=\"#m-14-deposited-staking-tokens-can-be-lost-if-rewards-token-info-added-by-mistake-in-addreward-in-ve3drewardpool-and-there-is-no-checking-to-ensure-this-would-not-happen-ve3token-for-one-reward-was-equal-to-stacking-token\">[M-14] Deposited staking tokens can be lost if rewards token info added by mistake in addReward() in VE3DRewardPool and there is no checking to ensure this would not happen (ve3Token for one reward was equal to stacking token)</a></li>\n<li><a href=\"#m-15-owner-should-be-allowed-to-change-feemanager\">[M-15] Owner should be allowed to change feeManager</a></li>\n<li><a href=\"#m-16-admin-privilege-in-minting-to-arbitrary-address-allows-operator-to-dilute-tokens\">[M-16] Admin Privilege in minting to arbitrary address allows operator to dilute tokens</a></li>\n<li><a href=\"#m-17-missing-sane-bounds-on-asset-weights\">[M-17] Missing sane bounds on asset weights</a></li>\n<li><a href=\"#m-18-governance-can-arbitrarily-burn-vetoken-from-any-address\">[M-18] Governance can arbitrarily burn VeToken from any address</a></li>\n<li><a href=\"#m-19-ve3drewardpool-claim-in-loop-depend-on-pausable-token\">[M-19] <code>VE3DRewardPool</code> claim in loop depend on pausable token</a></li>\n<li><a href=\"#m-20-contracts-should-be-robust-to-upgrades-of-underlying-gauges-and-eventually-changes-of-the-underlying-tokens\">[M-20] Contracts should be robust to upgrades of underlying gauges and eventually changes of the underlying tokens</a></li>\n<li><a href=\"#m-21-voterproxy-incorrectly-assumes-a-1-1-mapping-between-the-gauge-and-the-lp-tokens\">[M-21] <code>VoterProxy</code> incorrectly assumes a 1-1 mapping between the gauge and the LP tokens.</a></li>\n<li><a href=\"#m-22-ve3drewardpool-allows-the-same-reward-address-to-be-added-multiple-times-to-the-extrarewards-array\">[M-22] VE3DRewardPool allows the same reward address to be added multiple times to the <code>extraRewards</code> array</a></li>\n<li><a href=\"#m-23-baserewardpools-rewardpertokenstored-can-be-inflated-and-rewards-can-be-stolen\">[M-23] BaseRewardPool’s <code>rewardPerTokenStored</code> can be inflated and rewards can be stolen</a></li>\n<li><a href=\"#m-24-user-can-lose-funds\">[M-24] User can lose funds</a></li>\n<li><a href=\"#m-25-consistently-check-account-balance-before-and-after-transfers-for-fee-on-transfer-discrepancies\">[M-25] Consistently check account balance before and after transfers for Fee-On-Transfer discrepancies</a></li>\n<li><a href=\"#m-26-ve3dlockersol-wrong-implementation-of-inversely-traverse-for-loops-always-reverts\">[M-26] <code>VE3DLocker.sol</code> Wrong implementation of inversely traverse for loops always reverts</a></li>\n<li><a href=\"#m-27-boosters-shutdownpool-can-freeze-user-funds\">[M-27] Booster’s shutdownPool can freeze user funds</a></li>\n<li><a href=\"#m-28-extrarewardstashv2s-stashrewards-can-become-unavailable\">[M-28] ExtraRewardStashV2’s stashRewards can become unavailable</a></li>\n<li><a href=\"#m-29-centralisation-risk-voterproxy-owner-may-set-the-operate-to-an-address-they-own-and-drain-all-token-balances\">[M-29] Centralisation RIsk: <code>VoterProxy</code> owner may set the <code>operate</code> to an address they own and drain all token balances</a></li>\n<li><a href=\"#m-30-incorrect-deployment-parameters\">[M-30] Incorrect deployment parameters</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk-issues\">Low Risk Issues</a></li>\n<li><a href=\"#l-01-getapy-returns-the-wrong-answer-during-leap-years\">L-01 <code>getAPY()</code> returns the wrong answer during leap years</a></li>\n<li><a href=\"#l-02-missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\">L-02 Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</a></li>\n<li><a href=\"#non-critical-issues\">Non-critical Issues</a></li>\n<li><a href=\"#n-01-adding-a-return-statement-when-the-function-defines-a-named-return-variable-is-redundant\">N-01 Adding a <code>return</code> statement when the function defines a named return variable, is redundant</a></li>\n<li><a href=\"#n-02-public-functions-not-called-by-the-contract-should-be-declared-external-instead\">N-02 <code>public</code> functions not called by the contract should be declared <code>external</code> instead</a></li>\n<li><a href=\"#n-03-constants-should-be-defined-rather-than-using-magic-numbers\">N-03 <code>constant</code>s should be defined rather than using magic numbers</a></li>\n<li><a href=\"#n-04-numeric-values-having-to-do-with-time-should-use-time-units-for-readability\">N-04 Numeric values having to do with time should use time units for readability</a></li>\n<li><a href=\"#n-05-large-multiples-of-ten-should-use-scientific-notation-eg-1e6-rather-than-decimal-literals-eg-1000000-for-readability\">N-05 Large multiples of ten should use scientific notation (e.g. <code>1e6</code>) rather than decimal literals (e.g. <code>1000000</code>), for readability</a></li>\n<li><a href=\"#n-06-missing-event-for-critical-parameter-change\">N-06 Missing event for critical parameter change</a></li>\n<li><a href=\"#n-07-use-a-more-recent-version-of-solidity\">N-07 Use a more recent version of solidity</a></li>\n<li><a href=\"#n-08-constant-redefined-elsewhere\">N-08 Constant redefined elsewhere</a></li>\n<li><a href=\"#n-09-inconsistent-spacing-in-comments\">N-09 Inconsistent spacing in comments</a></li>\n<li><a href=\"#n-10-typos\">N-10 Typos</a></li>\n<li><a href=\"#n-11-file-is-missing-natspec\">N-11 File is missing NatSpec</a></li>\n<li><a href=\"#n-12-natspec-is-incomplete\">N-12 NatSpec is incomplete</a></li>\n<li><a href=\"#n-13-avoid-the-use-of-sensitive-terms\">N-13 Avoid the use of sensitive terms</a></li>\n<li><a href=\"#n-14-safeapprove-is-deprecated\">N-14 <code>safeApprove()</code> is deprecated</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#g-01-update-to-state-var-should-only-happen-once-in-a-function\">G-01 Update to state var should only happen once in a function</a></li>\n<li><a href=\"#g-02-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate\">G-02 Multiple <code>address</code> mappings can be combined into a single <code>mapping</code> of an <code>address</code> to a <code>struct</code>, where appropriate</a></li>\n<li><a href=\"#g-03-state-variables-only-set-in-the-constructor-should-be-declared-immutable\">G-03 State variables only set in the constructor should be declared <code>immutable</code></a></li>\n<li><a href=\"#g-04-avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\">G-04 Avoid contract existence checks by using solidity version 0.8.10 or later</a></li>\n<li><a href=\"#g-05-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G-05 State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g-06-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\">G-06 Multiple accesses of a mapping/array should use a local variable cache</a></li>\n<li><a href=\"#g-07-x--y-costs-more-gas-than-x--x--y-for-state-variables\">G-07 <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</a></li>\n<li><a href=\"#g-08-internal-functions-only-called-once-can-be-inlined-to-save-gas\">G-08 <code>internal</code> functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#g-09-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\">G-09 <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for</code>-loop</a></li>\n<li><a href=\"#g-10-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\">G-10 <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</a></li>\n<li><a href=\"#g-11-keccak256-should-only-need-to-be-called-on-a-specific-string-literal-once\">G-11 <code>keccak256()</code> should only need to be called on a specific string literal once</a></li>\n<li><a href=\"#g-12-using-bools-for-storage-incurs-overhead\">G-12 Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#g-13-using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\">G-13 Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</a></li>\n<li><a href=\"#g-14-it-costs-more-gas-to-initialize-variables-to-zero-than-to-let-the-default-of-zero-be-applied\">G-14 It costs more gas to initialize variables to zero than to let the default of zero be applied</a></li>\n<li><a href=\"#g-15-i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">G-15 <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#g-16-splitting-require-statements-that-use--saves-gas\">G-16 Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</a></li>\n<li><a href=\"#g-17-using-private-rather-than-public-for-constants-saves-gas\">G-17 Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g-18-dont-compare-boolean-expressions-to-boolean-literals\">G-18 Don’t compare boolean expressions to boolean literals</a></li>\n<li><a href=\"#g-19-dont-use-safemath-once-the-solidity-version-is-080-or-greater\">G-19 Don’t use <code>SafeMath</code> once the solidity version is 0.8.0 or greater</a></li>\n<li><a href=\"#g-20-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function\">G-20 Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</a></li>\n<li><a href=\"#g-21-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\">G-21 <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</a></li>\n<li><a href=\"#g-22-empty-blocks-should-be-removed-or-emit-something\">G-22 Empty blocks should be removed or emit something</a></li>\n<li><a href=\"#g-23-use-custom-errors-rather-than-revertrequire-strings-to-save-deployment-gas\">G-23 Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save deployment gas</a></li>\n<li><a href=\"#g-24-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G-24 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n<li><a href=\"#g-25-dont-use-_msgsender-if-not-supporting-eip-2771\">G-25 Don’t use <code>_msgSender()</code> if not supporting EIP-2771</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the veToken Finance smart contract system written in Solidity. The audit contest took place between May 26—June 2 2022.\n\n## Wardens\n\n76 Wardens contributed reports to the veToken Finance contest:\n\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. xiaoming90\n  1. unforgiven\n  1. [Picodes](https://twitter.com/thePicodes)\n  1. IllIllI\n  1. [kirk-baird](https://twitter.com/kirkthebaird)\n  1. [hyh](https://twitter.com/0xhyh)\n  1. [shenwilly](https://twitter.com/shenwilly_)\n  1. VAD37\n  1. oyc_109\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. sorrynotsorry\n  1. 0x52\n  1. [Dravee](https://twitter.com/BowTiedDravee)\n  1. SmartSek (0xDjango and hake)\n  1. cryptphi\n  1. [pauliax](https://twitter.com/SolidityDev)\n  1. [sseefried](http://seanseefried.org/blog)\n  1. [jonatascm](https://www.linkedin.com/in/jonatas-cmartins/)\n  1. 0x1f8b\n  1. [ch13fd357r0y3r](https://twitter.com/ch13fd357r0y3r)\n  1. SecureZeroX\n  1. [WatchPug](https://twitter.com/WatchPug_) ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. Kumpa\n  1. [gzeon](https://twitter.com/gzeon)\n  1. TerrierLover\n  1. reassor\n  1. [MiloTruck](https://milotruck.github.io/)\n  1. [Funen](https://instagram.com/vanensurya)\n  1. [minhquanym](https://www.linkedin.com/in/minhquanym/)\n  1. [0xNazgul](https://twitter.com/0xNazgul)\n  1. sashik_eth\n  1. FSchmoede\n  1. _Adam\n  1. [berndartmueller](https://twitter.com/berndartmueller)\n  1. cccz\n  1. robee\n  1. [cogitoergosumsw](https://twitter.com/cogitoergosumsw)\n  1. horsefacts\n  1. [catchup](https://twitter.com/catchup22)\n  1. 0x29A (0x4non and rotcivegaf)\n  1. Hawkeye (0xwags and 0xmint)\n  1. [hansfriese](https://twitter.com/hansfriese)\n  1. simon135\n  1. 0xf15ers (remora and twojoy)\n  1. [ellahi](https://twitter.com/ellahinator)\n  1. [c3phas](https://twitter.com/c3ph_)\n  1. delfin454000\n  1. asutorufos\n  1. ElKu\n  1. [z3s](https://github.com/z3s/)\n  1. dipp\n  1. [Deivitto](https://twitter.com/Deivitto)\n  1. [BouSalman](https://twitter.com/BouSalman)\n  1. GimelSec ([rayn](https://twitter.com/rayn731) and sces60107)\n  1. 0xDjango\n  1. [Chom](https://chom.dev)\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. Koustre\n  1. [fatherOfBlocks](https://twitter.com/father0fBl0cks)\n  1. [0xKitsune](https://github.com/0xKitsune)\n  1. Kaiziron\n  1. [TomJ](https://mobile.twitter.com/tomj_bb)\n  1. 0xkatana\n  1. Cityscape\n  1. [Randyyy](https://twitter.com/randyyramadhan)\n  1. RoiEvenHaim\n  1. sach1r0\n  1. saian\n  1. Waze\n\nThis contest was judged by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo). The judge also competed in the contest as a warden, but forfeited their winnings.\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 31 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 30 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 51 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 48 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 veToken Finance contest repository](https://github.com/code-423n4/2022-05-vetoken), and is composed of 6 smart contracts written in the Solidity programming language and includes 1,602 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (1)\n## [[H-01] Gauge Rewards Stuck In `VoterProxy` Contract When `ExtraRewardStashV3` Is Used Within Angle Deployment](https://github.com/code-423n4/2022-05-vetoken-findings/issues/209)\n_Submitted by xiaoming90_\n\n> Note: This report aims to discuss the issue encountered when `ExtraRewardStashV3` is used within Angle Deployment. There is also another issue when `ExtraRewardStashV2` is used within Angle Deployment, but I will raise it in a separate report since `ExtraRewardStashV2` and `ExtraRewardStashV3` operate differently, and the proof-of-concept and mitigation are different too.\n\n### Proof of Concept\n\nIn this example, assume the following Angle's gauge setup\n\n> Name = Angle sanDAI_EUR Gauge\n>\n> Symbol = SsanDAI_EUR\n>\n> reward_count = 2\n>\n> reward_tokens(0) = ANGLE\n>\n> reward_tokens(1) = DAI\n>\n> Gauge Contract: [LiquidityGaugeV4.vy](https://github.com/AngleProtocol/angle-core/blob/4d854e0d74be703a3707898f26ea2dd4166bc9b6/contracts/staking/LiquidityGaugeV4.vy)\n>\n> Stash Contract: [ExtraRewardStashV3](https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV3.sol)\n\nTo collect the gauge rewards, users would trigger the `Booster._earmarkRewards` function to claim veAsset and extra rewards from a gauge.\n\nPer the code logic, the function will attempt to execute the following two key operations:\n\n1.  First Operation -  Claim the veAsset by calling `VoterProxy.claimVeAsset`. Call Flow as follow: `VoterProxy.claimVeAsset() > IGauge(_gauge).claim_rewards()`.\n2.  Second Operation - Claim extra rewards by calling `ExtraRewardStashV3.claimRewards`. Call flow as follows: `ExtraRewardStashV3.claimRewards > Booster.claimRewards > VoterProxy.claimRewards > IGauge(_gauge).claim_rewards()` .\n\nNote that`IGauge(_gauge).claim_rewards()` will claim all available reward tokens from the Angle's gauge.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L495>\n\n```\n//claim veAsset and extra rewards and disperse to reward contracts\nfunction _earmarkRewards(uint256 _pid) internal {\n    PoolInfo storage pool = poolInfo[_pid];\n    require(pool.shutdown == false, \"pool is closed\");\n\n    address gauge = pool.gauge;\n\n    //claim veAsset\n    IStaker(staker).claimVeAsset(gauge);\n\n    //check if there are extra rewards\n    address stash = pool.stash;\n    if (stash != address(0)) {\n        //claim extra rewards\n        IStash(stash).claimRewards();\n        //process extra rewards\n        IStash(stash).processStash();\n    }\n\t..SNIP..\n}\n```\n\n#### First Operation -  Claim the veAsset\n\nSince this is a Angle Deployment, when the `VoterProxy.claimVeAsset` is triggered,  it will go through the if-else logic (`escrowModle == IVoteEscrow.EscrowModle.ANGLE`) and execute `  IGauge(_gauge).claim_rewards() `, and all rewards tokens will be sent to `VoterProxy` contract. Assume that `100 ANGLE` and `100 DAI` were received.\n\nNote that in this example, we have two reward tokens (ANGLE and DAI). Additionally, gauge redirection was not configured on the gauge at this point, thus the gauge rewards will be sent to the caller, which is the `VoterProxy` contract.\n\nSubsequently, the code `IERC20(veAsset).safeTransfer(operator, _balance);` will be executed, and veAsset (`100 ANGLE`) reward tokens will be transferred to the `Booster` contract for distribution. However, the `100 DAI` reward tokens will remain stuck in the `VoterProxy` contract. As such, users will not be able to get any reward tokens (e.g. DAI, WETH) except veAsset (ANGLE) tokens from the gauges.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L224>\n\n```\nfunction claimVeAsset(address _gauge) external returns (uint256) {\n    require(msg.sender == operator, \"!auth\");\n\n    uint256 _balance = 0;\n\n    if (escrowModle == IVoteEscrow.EscrowModle.PICKLE) {\n        try IGauge(_gauge).getReward() {} catch {\n            return _balance;\n        }\n    } else if (\n        escrowModle == IVoteEscrow.EscrowModle.CURVE ||\n        escrowModle == IVoteEscrow.EscrowModle.RIBBON\n    ) {\n        try ITokenMinter(minter).mint(_gauge) {} catch {\n            return _balance;\n        }\n    } else if (escrowModle == IVoteEscrow.EscrowModle.IDLE) {\n        try ITokenMinter(minter).distribute(_gauge) {} catch {\n            return _balance;\n        }\n    } else if (escrowModle == IVoteEscrow.EscrowModle.ANGLE) {\n        try IGauge(_gauge).claim_rewards() {} catch {\n            return _balance;\n        }\n    }\n\n    _balance = IERC20(veAsset).balanceOf(address(this));\n    IERC20(veAsset).safeTransfer(operator, _balance);\n\n    return _balance;\n}\n```\n\nFollowing is Angle's Gauge Contract for reference:\n\n<https://github.com/AngleProtocol/angle-core/blob/4d854e0d74be703a3707898f26ea2dd4166bc9b6/contracts/staking/LiquidityGaugeV4.vy#L344>\n\n(Mainnet Deployed Address: <https://etherscan.io/address/0x8E2c0CbDa6bA7B65dbcA333798A3949B07638026>)\n\n> Note: Angle Protocol is observed to use LiquidityGaugeV4 contract for all of their gauges. Thus, ExtraRewardStashV3 is utilised during pool creation.\n\n```\n@external\n@nonreentrant('lock')\ndef claim_rewards(_addr: address = msg.sender, _receiver: address = ZERO_ADDRESS):\n    \"\"\"\n    @notice Claim available reward tokens for `_addr`\n    @param _addr Address to claim for\n    @param _receiver Address to transfer rewards to - if set to\n                     ZERO_ADDRESS, uses the default reward receiver\n                     for the caller\n    \"\"\"\n    if _receiver != ZERO_ADDRESS:\n        assert _addr == msg.sender  \\# dev: cannot redirect when claiming for another user\n    self._checkpoint_rewards(_addr, self.totalSupply, True, _receiver)\n```\n\n#### Second Operation - Claim extra rewards\n\nAfter the `IStaker(staker).claimVeAsset(gauge);` code within the `Booster._earmarkRewards` function is executed, `IStash(stash).claimRewards();`  and `IStash(stash).processStash();` functions will be executed next. `stash` == `ExtraRewardStashV3`.\n\nThe `ExtraRewardStashV3.claimRewards` will call the `Booster.setGaugeRedirect` first so that all the gauge rewards will be redirected to `ExtraRewardStashV3` stash contract. Subsequently, `ExtraRewardStashV3.claimRewards` will trigger `Booster.claimRewards` to claim the gauge rewards from the Angle's gauge.\n\nNote that this is the second time the contract attempts to claim gauge rewards from the gauge. Thus, no gauge rewards will be received since we already claimed them earlier. Next, `ExtraRewardStashV3` will attempt to process all the tokens stored in its contract and send them to the respective reward contracts for distribution to the users. However, the contract does not have any tokens stored in it because the earlier attempt to claim gauge rewards return nothing.\n\nAs we can see, the DAI reward tokens are still stuck in the `VoterProxy` contract at this point.\n\n<https://github.com/AngleProtocol/angle-core/blob/4d854e0d74be703a3707898f26ea2dd4166bc9b6/contracts/staking/LiquidityGaugeV4.vy#L332>\n\n```\ndef set_rewards_receiver(_receiver: address):\n    \"\"\"\n    @notice Set the default reward receiver for the caller.\n    @dev When set to ZERO_ADDRESS, rewards are sent to the caller\n    @param _receiver Receiver address for any rewards claimed via `claim_rewards`\n    \"\"\"\n    self.rewards_receiver[msg.sender] = _receiver\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV3.sol#L61>\n\n```\n//try claiming if there are reward tokens registered\nfunction claimRewards() external returns (bool) {\n    require(msg.sender == operator, \"!authorized\");\n\n    //this is updateable from v2 gauges now so must check each time.\n    checkForNewRewardTokens();\n\n    //make sure we're redirected\n    if (!hasRedirected) {\n        IDeposit(operator).setGaugeRedirect(pid);\n        hasRedirected = true;\n    }\n\n    uint256 length = tokenCount;\n    if (length > 0) {\n        //claim rewards on gauge for staker\n        //using reward_receiver so all rewards will be moved to this stash\n        IDeposit(operator).claimRewards(pid, gauge);\n    }\n    return true;\n}\n```\n\n### Impact\n\nUser's gauge rewards are frozen/stuck in `VoterProxy` contract. Additionally, there is no method to sweep/collect the reward tokens stuck in the `VoterProxy` contract.\n\n### Recommended Mitigation Steps\n\n> Note: I do not see `Booster.setGaugeRedirect` being called in the deployment and testing scripts. Thus, it is fair to assume that the team is not aware of the need to trigger `Booster.setGaugeRedirect` during deployment. If the gauge redirection has been set to the stash contract `ExtraRewardStashV3` right from the start before anyone triggered the `earmarkRewards` function, this issue should not occur.\n\nConsider triggering `Booster.setGaugeRedirect` during the deployment to set gauge redirection to stash contract (`ExtraRewardStashV3`) so that the Angle's gauge rewards will not be redirected to `VoterProxy` contract and get stuck there.\n\nAlternatively, update the `Booster._earmarkRewards` to as follows:\n\n```\n//claim veAsset and extra rewards and disperse to reward contracts\nfunction _earmarkRewards(uint256 _pid) internal {\n\tPoolInfo storage pool = poolInfo[_pid];\n\trequire(pool.shutdown == false, \"pool is closed\");\n\n\taddress stash = pool.stash;\n\tif (escrowModle == IVoteEscrow.EscrowModle.ANGLE) {\n\t\t//claims gauges rewards\n\t\tIStash(stash).claimRewards();\n\t\t//process gauges rewards\n\t\tIStash(stash).processStash();\n\t} else {\n\t\t//claim veAsset\n        IStaker(staker).claimVeAsset(gauge);\n\n        //check if there are extra rewards\n        address stash = pool.stash;\n        if (stash != address(0)) {\n            //claim extra rewards\n            IStash(stash).claimRewards();\n            //process extra rewards\n            IStash(stash).processStash();\n        }\n\t}\n\n\t//veAsset balance\n    uint256 veAssetBal = IERC20(veAsset).balanceOf(address(this));\n\t..SNIP..\n}\n```\n\nThere is no need to specifically call `VoterProxy.claimVeAsset` to fetch ANGLE for Angle Protocol because calling `IStash(stash).claimRewards()` will fetch both ANGLE and other reward tokens from the gauge anyway. When the stash contract receives the ANGLE tokens, it will automatically transfer all of them back to `Booster` contract when `IStash(stash).processStash()` is executed. The `IStash(stash).claimRewards()` function also performs a sanity check to ensure that the gauge redirection is pointing to itself before claiming the gauge rewards, and automatically configure them if it is not, so it will not cause the reward tokens to get stuck in `VoterProxy` contract.\n\n*   Curve uses an older version of LiquidityGauge contract. Thus, two calls are needed (`Minter.mint` to claim CRV and `LiquidityGauge.claim_rewards` to claim other rewards).\n\n*   Angle uses newer version of LiquidityGauge (V4) contract that just need one function call (`LiquidityGauge.claim_rewards` ) to fetch both veAsset and other rewards.\n\n*   IDLE uses LiquidityGauge (V3) contract. veAsset (IDLE) is minted by calling `DistributorProxy.distribute` and gauge rewards are claimed by calling `LiquidityGauge.claim_rewards`.\n\nDue to the discrepancies between different protocols in the reward claiming process, additional care must be taken to ensure that the flow of veAsset and gauge rewards are transferred to the appropriate contracts during integration. Otherwise, rewards will be stuck.\n\nLastly, I only see test cases written for claiming veAsset from the gauge. For completeness, it is recommended to also write test cases for claiming extra rewards from the gauge apart from veAsset.\n\n**[solvetony (veToken Finance) confirmed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/209#issuecomment-1156668018):**\n > Good catch, this issue is because Angle uses the same function for claim veAsset and extra rewards. \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/209#issuecomment-1193419949):**\n > The warden has shown how Angle protocol will break certain invariants as the code assumes that claiming of `veAsset` to always be separate from claiming of `additionalRewards`.\n> \n> Due to this any additional reward emitted by the Angle Gauge will be stuck in the claiming contract.\n> \n> While impact is limited to loss of yield (loss of additional tokens), because the finding has broken the assumptions of the contract, meaning that Angle Protocol should not be integrated without a fix, I believe High Severity to be appropriate.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/209#issuecomment-1199815504):**\n > Upon further review, we may raise the concern of the contract being out of scope.\n> \n> However, given that:\n> - The sponsor Confirmed\n> - The vulnerability would be present in a normal configuration\n> \n> I believe the finding is of High Severity.\n\n\n\n***\n\n \n# Medium Risk Findings (30)\n## [[M-01] compromised `owner` can drain funds from`VeTokenMinter.sol`](https://github.com/code-423n4/2022-05-vetoken-findings/issues/69)\n_Submitted by SmartSek, also found by ch13fd357r0y3r_\n\nCompromised `owner` can `withdraw()` entire balance of `VeTokenMinter.sol` to any other account.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L77-L81>\n\n```\nfunction withdraw(address _destination, uint256 _amount) external onlyOwner {\n    veToken.safeTransfer(_destination, _amount);\n\n    emit Withdraw(_destination, _amount);\n}\n```\n\nThe `owner` can choose any `_destination` and `_amount` to send funds to with no delay or limit.\nThese funds could be used to call `Booster.deposit()` and then `Booster.withdraw()`(withdraw) the equivalent in `lptoken`.\n\n### Recommended Mitigation Steps\n\nConsider implementing a timelock on `VeTokenMinter.withdraw()` and changing the `destination` to an address that `owner` has no control over.\n\nExample of similar issues illustrating the severity of the finding can be found [here (H-09)](https://code4rena.com/reports/2022-01-insure).\n\n**[solvetony (veToken Finance) acknowledged and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/69#issuecomment-1156609426):**\n > Requires compromised owner.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/69#issuecomment-1175569241):**\n > Finding is valid, but contingent on a Malicious or Compromised Admin, Medium Severity is more appropriate.\n\n\n\n***\n\n## [[M-02] VE3DRewardPool.sol is incompatible with Bal/veBal](https://github.com/code-423n4/2022-05-vetoken-findings/issues/53)\n_Submitted by 0x52_\n\n`getReward` will become completely unusable if bal is added as an support asset.\n\n### Proof of Concept\n\nveBal is not staked bal, it is staked 80-20 bal/eth LP. Rewards from gauges are paid in bal NOT 80-20 bal/eth LP. All rewards to this address will be received as bal. If the contract tries to deposit bal directly it will fail, causing getReward to always revert if bal is a supported asset (as all documentation conveys that it will be).\n\n### Recommended Mitigation Steps\n\nExclude veBal/Bal as a supported asset or create a special wrapper for Bal that adds the Bal as one sided liquidity then stakes the LP.\n\n**[solvetony (veToken Finance) disputed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/53#issuecomment-1156605217):**\n > Out of the scope, Balancer. But we need to consider this, once we start working on these.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/53#issuecomment-1189659591):**\n > The finding shows how the code cannot support veBAL.\n> \n> In the specific case of veBAL, the deposit token is 80/20 BAL but the reward is BAL, meaning the function will eventually revert.\n> \n> This is conditional on the token being the BAL token, which means the finding cannot be of High Severity (conditional on configuration).\n> \n> The sponsor claims that Balancer will not be used, and that may be the case, however the [README for the contest](https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/README.md#L20) does include BAL and for that reason I think the finding is Valid and of Medium Severity.\n\n\n\n***\n\n## [[M-03] No check for existing extraRewards during push](https://github.com/code-423n4/2022-05-vetoken-findings/issues/89)\n_Submitted by cryptphi, also found by csanuragjain_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L138>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DLocker.sol#L156>\n\n### Impact\n\nSimilar to a report I submitted for BaseRewardPool.sol (<https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L126>)\n\nWhen adding `extraRewards` to the extra reward pool in <https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L138> , there's no check for already existing address.\n\nAssume a particular address takes up 2 slots out of 3, and a user withdraws staked extra rewards, the user will receive double the amount requested in <https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L257-L258>\n\n### Proof of Concept\n\n1.  Assume `rewardManager` had mistakenly added the same address twice in `addExtraReward()`\n2.  A user calls `stake()` , linked rewards is staked twice to the same address (unexpected behaviour I guess but not severe issue)\n3.  Now, user calls `withdraw()` to withdraw linked rewards (this is already 2x in step 2)\n4.  User will receive double the linked rewards due to the iteration in `https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L257-L258`\n\n### Recommended Mitigation Steps\n\nGuess a check for an already existing extraRewards can be added before Line 138\n\n#### Similar issue\n<https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DLocker.sol#L156> - not so sure of the severity for this.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L126>  - reported in a seperate report\n\n**[jetbrain10 (veToken Finannce) confirmed](https://github.com/code-423n4/2022-05-vetoken-findings/issues/89)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/89#issuecomment-1189682693):**\n > The warden has shown how, due to a misconfiguration error, a leak of value can happen, and other depositors (late withdrawers) would lose the rewards that they are entitled to.\n> \n> Mitigation seems to be straightforward (add a duplicate check, or use a enumerableMap), that said, because of the risk of loss contingent on configuration, I agree with Medium Severity.\n\n\n\n***\n\n## [[M-04] User can lose extra rewards](https://github.com/code-423n4/2022-05-vetoken-findings/issues/15)\n_Submitted by csanuragjain_\n\nrewardManager can at anytime delete the extra Rewards. This impacts the extra rewards earned by existing staker. The existing staker will have no way to claim these extra rewards. Since these extra rewards have been staked for all users making a deposit BaseRewardPool.sol#L215 so basically the extra reward gets locked with no one having access to this fund. Need to be fixed for BaseRewardPool.sol as well\n\n### Proof of Concept\n\n1.  rewardManager adds 2 extra reward token A,B using addExtraReward\n2.  User X makes a deposit of amount 1000 using stake function\n3.  This stakes extra rewards A,B for this user\n4.  rewardManager now calls clearExtraRewards which removes extraRewards object\n5.  User X has now no way to retrieve the staked extra rewards A,B of amount 1000\n\n### Recommended Mitigation Steps\n\nIf rewardManager wants to clear extra rewards then all existing stakes on extra rewards must be withdrawn and claimed so that user extra rewards are not lost.\n\n**[solvetony (veToken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/15#issuecomment-1156597107):**\n > Not an issue of the user staked fund, but we need to add call at pool factory for `clearExtraRewards()`. \n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/15#issuecomment-1190943684):**\n > The warden has shown how, due to admin privilege, extra rewards could stay stuck in the contract.\n> \n> Because this is contingent on a malicious admin, I believe Medium Severity to be more appropriate.\n> \n> Notice that the rewards would be lost forever as there doesn't seem to be any `sweep` function which instead would allow the admin to take the reward tokens.\n> \n> My recommendation is to remove the function to `clearExtraRewards` as it doesn't seem to help but it can indeed cause issues.\n\n\n\n***\n\n## [[M-05] Duplicate LP token could lead to incorrect deposits](https://github.com/code-423n4/2022-05-vetoken-findings/issues/11)\n_Submitted by csanuragjain, also found by kirk-baird and unforgiven_\n\nIt was observed that addPool function is not checking for duplicate lpToken which allows 2 or more pools to have exact same lpToken. This can cause issue with deposits.\n\nIn case of duplicate lpToken, the first pool calling depositAll will take away all lpToken and deposit them under there own pid. This leaves no balance for 2nd pool.\n\n### Proof of Concept\n\n1.  PoolManager call addPool function and uses lpToken as A\n2.  PoolManager again call addPool function and mistakenly provides lpToken as A\n3.  Now 2 pools will be created with lpToken as A\n4.  depositAll function is called passing first pool.\n5.  This takes all balance of lpToken A and depsoit it under first pool pid\n6.  This mean no balance is left for second pool now\n\n### Recommended Mitigation Steps\n\nAdd a global variable keeping track of all lpToken added for pool. In case of duplicate lpToken addPool function should fail.\n\n**[jetbrain10 (veToken Finance) confirmed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/11#issuecomment-1156614001):**\n > There is already a validation not allow to add duplicated gauges, pool manager contract, add pool function , but we have to add also a validation for lp token like gauges.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/11#issuecomment-1190948418):**\n > The warden has shown how, due to a lack of validation, the assumption that each lpToken is used only on one pool can be broken.\n> This will cause accounting issues.\n> \n> For those reasons, I agree with Medium Severity.\n\n\n\n***\n\n## [[M-06] Incorrectly set ```_maxTime``` to be in line with the locking ```maxTime``` of each veToken could render the ```deposit``` of this contract to be unfunctional or even freeze assets inside the contract ](https://github.com/code-423n4/2022-05-vetoken-findings/issues/141)\n_Submitted by Kumpa, also found by SecureZeroX and unforgiven_\n\nSince \\_maxTime needs to be manually input in the constructor with no other ways of changing it, if the owner inputs the \\_maxTime that is higher than the capacity of each vaults of veTokens, it will cause `IVoteEscrow(escrow).increase_unlock_time(_value);` to get rejected.\n\nIn the mild case when a user initially locks the asset during depositing, the contract will simply revert the transaction.\n\nIn the severe case when a user does not lock the asset during depositing, the asset will end up locked in the contract since noone will be able to succesfully call `lockVeAsset`. This will cause the asset to be locked up with no way of withdrawing it. Even though a user will still get benefits from the minted reward, a contract will not be able to receive any benefits since it can't utilize the locked asset in `VeAssetDepositor`.\n\n### Proof of Concept\n\n![Pic 1 ](https://user-images.githubusercontent.com/63941340/171625668-85834a21-f3c2-4837-b49b-4ed5a975132a.jpg)\n\n1.The owner initially sets \\_maxTime in constructor to be 126489600 (86400*366*4) instead of 126144000 (86400*365*4) which is the maximum time that a user can deposit in curve\n\n![Pic 2](https://user-images.githubusercontent.com/63941340/171625682-49582795-ed3f-4ae5-8302-57f270376461.jpg)\n\n2.A user `deposit` veAsset but deferring the locking to save gas\n\n3.The veAsset is transferred from a user to the contract and the contract mint a reward token to the user\n\n![Pic 3](https://user-images.githubusercontent.com/63941340/171625696-9d57f982-233e-4f26-8536-a6e8804c6f5e.jpg)\n\n![Pic 4](https://user-images.githubusercontent.com/63941340/171625706-b8ddf803-1bd4-4aba-89c9-354445168eda.jpg)\n\n![Pic 5](https://user-images.githubusercontent.com/63941340/171625711-d8c63db6-c962-4150-867d-d51bb15ea055.jpg)<br>\n&ast;Above shows that the deposit will get reverted if lockAmount is more than 4 years in curve's VotingEscrow\n\n4.The veAsset will not be able to move to the staking contract because when VoterProxy calls `increase_unlock_time` in the targeted vault, the call will get reverted due to exceeded \\_value of `unlockAt`\n\n### Recommended Mitigation Steps\n\nThe owner should set the value of \\_maxTime in advance for each veAsset and not relying on manual inputting during the constructoring as the risk of misconfiging ot is high. Otherwise the contract should add an emergency measure that can help change \\_maxTime but this function needs to be protected with the highest security (eg. with timelock and multisig).\n\n**[solvetony (veToken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/141#issuecomment-1156645854):**\n > We can set it by a function instead of a constructor. Middle risk.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/141#issuecomment-1190967097):**\n > The warden has shown how, due to misconfiguration a lock may not be created, causing tokens to be stuck in the contract. \n> \n> We can confirm that a revert would happen by checking [`VotingEscrow`](https://etherscan.io/address/0x5f3b5dfeb7b28cdbd7faba78963ee202a494e2a2#code#L426)\n> \n> Because this is contingent on a wrong configuration I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-07] `VE3DRewardPool` and `VE3DLocker` adds to an unbounded array which may potentially lock all rewards in the contract](https://github.com/code-423n4/2022-05-vetoken-findings/issues/136)\n_Submitted by kirk-baird, also found by csanuragjain, Dravee, gzeon, IllIllI, Koustre, Ruhum, unforgiven, VAD37, and xiaoming90_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L102-L112>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L145-L172>\n\n### Impact\n\nThe function `addReward()` allows the owner to add a new reward token to the list `rewardTokens`.\n\nHowever, this is an unbounded list that when appended to cannot be shortened. The impact is it is possible to reach a state where the list is so long it cannot be iterated through due to the gas cost being larger than the block gas limit. This would cause a state where all transactions which iterate over this list will revert.\n\nSince the modifier `updateReward()` iterates over this list it is possible that there will reach a state where the we are unable to call any functions with this modifier. The list includes\n\n*   `stake()`\n*   `stakeAll()`\n*   `stakeFor()`\n*   `withdraw()`\n*   `withdrawAll()`\n*   `getReward()`\n*   `notifyRewardAmount()`\n\nAs a result it would therefore be impossible to withdraw any rewards from this contract.\n\nThe same issue exists in `VE3DLocker`.  Where rewards can be added by either `Booster` or the owner.\n\n### Proof of Concept\n\n```\n    function addReward(\n        address _rewardToken,\n        address _veAssetDeposits,\n        address _ve3TokenRewards,\n        address _ve3Token\n    ) external onlyOwner {\n        rewardTokenInfo[_rewardToken].veAssetDeposits = _veAssetDeposits;\n        rewardTokenInfo[_rewardToken].ve3TokenRewards = _ve3TokenRewards;\n        rewardTokenInfo[_rewardToken].ve3Token = _ve3Token;\n        rewardTokens.add(_rewardToken);\n    }\n```\n\n```\n    function addReward(\n        address _rewardsToken,\n        address _veAssetDeposits,\n        address _ve3Token,\n        address _ve3TokenStaking,\n        address _distributor,\n        bool _isVeAsset\n    ) external {\n        require(_msgSender() == owner() || operators.contains(_msgSender()), \"!Auth\");\n        require(rewardData[_rewardsToken].lastUpdateTime == 0);\n        require(_rewardsToken != address(stakingToken));\n        rewardTokens.push(_rewardsToken);\n\n\n        rewardData[_rewardsToken].lastUpdateTime = uint40(block.timestamp);\n        rewardData[_rewardsToken].periodFinish = uint40(block.timestamp);\n        rewardDistributors[_rewardsToken][_distributor] = true;\n\n\n        rewardData[_rewardsToken].isVeAsset = _isVeAsset;\n        // if reward is veAsset\n        if (_isVeAsset) {\n            require(_ve3Token != address(0));\n            require(_ve3TokenStaking != address(0));\n            require(_veAssetDeposits != address(0));\n            rewardData[_rewardsToken].ve3Token = _ve3Token;\n            rewardData[_rewardsToken].ve3TokenStaking = _ve3TokenStaking;\n            rewardData[_rewardsToken].veAssetDeposits = _veAssetDeposits;\n        }\n    }\n```\n\n### Recommended Mitigation Steps\n\nConsider having some method for removing old reward tokens which are no longer in use.\n\nAlternatively set a hard limit on the number of reward tokens that can be added.\n\nA different option is to allow rewards to be iterated and distributed on a per token bases rather than all tokens at once.\n\n**[jetbrain10 (veToken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/136#issuecomment-1156705919):**\n > we're going to add a bound,  same as [#222](https://github.com/code-423n4/2022-05-vetoken-findings/issues/222), [#125](https://github.com/code-423n4/2022-05-vetoken-findings/issues/125).\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/136#issuecomment-1190946773):**\n > <img width=\"210\" alt=\"Screenshot 2022-07-21 at 03 49 56\" src=\"https://user-images.githubusercontent.com/13383782/180112223-805eab5a-75c8-4f3d-be41-f27fc64e610a.png\">\n> \n> My guesstimate of the math is that each reward would add 100k gas to the `updateReward` modifier, meaning we'd need 120 reward tokens before any consideration about running out of gas would happen.\n> \n> You also don't seem to be able to add a second one (provided someone has used the contract at least once after an addition).\n> \n> I'll think about it but am thinking Medium is stretching it.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/136#issuecomment-1193393769):**\n > Likelyhood is very low, however per the rules if enough rewards are added then claiming and withdrawing can be bricked permanently.\n> \n> I'd recommend end users to ensure the unlikely number of 120 rewards is never reached.\n> \n> Marking the finding as Valid and of Medium Severity.\n\n\n\n***\n\n## [[M-08] Not updating `totalWeight` when operator is removed in `VeTokenMinter`](https://github.com/code-423n4/2022-05-vetoken-findings/issues/120)\n_Submitted by sseefried, also found by shenwilly_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L36-L38>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L41-L4>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598-L614>\n\n### Impact\n\nThe `totalWeight` state variable of the `VeTokenMinter` contract is used to work out the amount of `veAsset` earned when the `Booster.rewardClaimed` function is called.\n\nHowever, while `totalWeight` is modified inside the `VeTokenMinter` contract when function `updateveAssetWeight` is called, the `totalWeight` is not similarly reduced when function `removeOperator` is called.\n\nThe impact is that remaining operators do not receive a fair share of the total rewards and a portion of the rewards are not given out at all.\n\n### Proof of Concept\n\n*   Operator 1 is added with weight 9\n*   Operator 2 is added with weight 1\n\nThe `totalWeight` is now 10.\n\nThis means that Operator 1 receives 90% of the amount while Operator 2 receives 10%.\n\nIf we then call `removeOperator` on Operator 1 then 90% of the reward is no longer minted and distributed. This is unfair to the remaining operators.\n\nThe can be seen on lines [607 - 608](https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L607-L608) of the `Booster` contract. Function `rewardClaimed` will never be called for (removed) Operator 1. But for Operator 2 they will still receive 10% of the rewards even though Operator 1 is no longer registered in the system.\n\n### Recommended Mitigation Steps\n\nThe `totalWeight` should be reduced so that the remaining operators receive a fair share of the total rewards.\n\nUsing just method calls from `VeTokenMinter` one could rectify this situation by\n\n*   adding the removed operator with `addOperator`\n*   setting the weight to `0` using `updateveAssetWeight`. This will have the effect of reducing the `totalWeight` by the right amount.\n*   removing the operator again using `removeOperator`\n\nHowever, the `removeOperator` function should just be rewritten to be as follows:\n\n```\nfunction removeOperator(address _operator) public onlyOwner {\n    totalWeight -= veAssetWeights[_operator];\n    veAssetWeights[_operator] = 0;\n    operators.remove(_operator);\n}\n```\n\nYou might also want to modify `addOperator` so that a weight can be provided as an extra argument. This saves having to call `addOperator` and then `updateveAssetWeight` which could save on gas.\n\n**[solvetony (veToken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/120#issuecomment-1156643912):**\n > Confirmed. But this should be a middle risk. \n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/120#issuecomment-1193397795):**\n > The warden has shown how, due to a privileged call, removing an operator, the weight used to distribute rewards will not be updated fairly. \n> This will cause an improper distribution of rewards.\n> \n> Because the finding is limited to Loss of Yield, due to Admin Configuration, I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-09] in notifyRewardAmount() of VE3DRewardPool and BaseRewardPool some tokes will be locked and not distributed becasue of rounding error](https://github.com/code-423n4/2022-05-vetoken-findings/issues/165)\n_Submitted by unforgiven_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L327-L345>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L367-L384>\n\n### Impact\n\nFunction `notifyRewardAmount()` calculates `rewardRate` for reward token/s in `VE3DRewardPool` and `BaseRewardPool`. to calculate `rewardRate` it divides `reward` amount to `duration` but because of the rounding error in division, some of `reward` amount wouldn't get distributed and stuck in contract (`rewardRate * duration < reward`). and contract don't redistributes them or don't have any mechanism to recover them. This bug can be more damaging if the precision of `rewardToken` is low or token price is high.\n\n### Proof of Concept\n\nThis is `notifyRewardAmount()` code in `BaseRewardPool`: (contract `VE3DRewardPool` is similar)\n\n        function notifyRewardAmount(uint256 reward) internal updateReward(address(0)) {\n            historicalRewards = historicalRewards.add(reward);\n            if (block.timestamp >= periodFinish) {\n                rewardRate = reward.div(duration);\n            } else {\n                uint256 remaining = periodFinish.sub(block.timestamp);\n                uint256 leftover = remaining.mul(rewardRate);\n                reward = reward.add(leftover);\n                rewardRate = reward.div(duration);\n            }\n            currentRewards = reward;\n            lastUpdateTime = block.timestamp;\n            periodFinish = block.timestamp.add(duration);\n            emit RewardAdded(reward);\n        }\n\nAs you can see it sets `rewardRate = reward.div(duration);` and this is where the rounding error happens. and even if contract distributes all in all the duration it will distribute `rewardRate * duration` which can be lower than `reward` and the extra reward amount will stuck in contract. This is `queueNewRewards()` code which calls `notifyRewardAmount()`:\n\n        function queueNewRewards(uint256 _rewards) external returns (bool) {\n            require(msg.sender == operator, \"!authorized\");\n\n            _rewards = _rewards.add(queuedRewards);\n\n            if (block.timestamp >= periodFinish) {\n                notifyRewardAmount(_rewards);\n                queuedRewards = 0;\n                return true;\n            }\n\n            //et = now - (finish-duration)\n            uint256 elapsedTime = block.timestamp.sub(periodFinish.sub(duration));\n            //current at now: rewardRate * elapsedTime\n            uint256 currentAtNow = rewardRate * elapsedTime;\n            uint256 queuedRatio = currentAtNow.mul(1000).div(_rewards);\n\n            //uint256 queuedRatio = currentRewards.mul(1000).div(_rewards);\n            if (queuedRatio < newRewardRatio) {\n                notifyRewardAmount(_rewards);\n                queuedRewards = 0;\n            } else {\n                queuedRewards = _rewards;\n            }\n            return true;\n        }\n\nAs you can see it queues `rewardToken`  and when the reward amount reach some point it calls `notifyRewardAmount()` and set `queuedRewards`  to `0x0`. `notifyRewardAmount()` will set `rewardRate` based on `reward amount` but because of the rounding error some of the reward token `0 =< unused < duration` will stuck in contract and pool will not distribute it. if the token has low precision or has higher price then this amount value can be very big because `notifyRewardAmount()` can be called multiple times.\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nadd extra amount to `queuedRewards` so it would be distributed on next `notifyRewardAmount()` or add other mechanism to recover it.\n\n**[solvetony (veToken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/165#issuecomment-1156647102):**\n > Will be fixed by two solutions, adding precision and by adding another function. Middle risk.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/165#issuecomment-1193398878):**\n > The warden has shown how, due to rounding errors, `rewardRate` may round down and cause a certain amount of tokens not to be distributed.\n> \n> In lack of a way for the `operator` to re-queue the undistributed rewards, those tokens will be lost.\n> \n> Because we know `duration` is `604800` we can see that the `rewardRate` max loss is `604799`.\n> \n> Meaning the potential max dust due to rounding down can be upwards of a number with 12 decimals<br>\n> <img width=\"239\" alt=\"Screenshot 2022-07-24 at 23 38 33\" src=\"https://user-images.githubusercontent.com/13383782/180666870-ce02ff32-84d5-4d8c-9dc1-cc0bf9d5ef9b.png\">\n> \n> \n> Because the finding is limited to loss of Yield, I believe Medium Severity to be more appropriate.\n> \n\n\n\n***\n\n## [[M-10] Unable To Get Rewards If Admin Withdraws \\$VE3D tokens From `VeTokenMinter` Contract](https://github.com/code-423n4/2022-05-vetoken-findings/issues/202)\n_Submitted by xiaoming90, also found by 0x1f8b, and VAD37_\n\nIt was observed that users will not be able to get their rewards from the reward contract at certain point of time if admin withdraws \\$VE3D token from the `VeTokenMinter` contract.\n\n### Proof of Concept\n\nBased on the deployment script, it was understood that at the start of the project deployment, 30 million \\$VE3D tokens will be pre-minted for the `VeTokenMinter` contract. Thus, the `veToken.balanceOf(VeTokenMinter.address)` will be 30 million \\$VE3D tokens after the deployment.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/2_deploy_basic_contracts.js#L18>\n\n```javascript\n// vetoken minter\nawait deployer.deploy(VeTokenMinter, veTokenAddress);\nlet vetokenMinter = await VeTokenMinter.deployed();\naddContract(\"system\", \"vetokenMinter\", vetokenMinter.address);\nglobal.created = true;\n//mint vetoke to minter contract\nconst vetoken = await VeToken.at(veTokenAddress);\nawait vetoken.mint(vetokenMinter.address, web3.utils.toWei(\"30000000\"), { from: vetokenOperator });\naddContract(\"system\", \"vetoken\", veTokenAddress);\n```\n\nIn the ` VeTokenMinter  ` contract, there is a function called `VeTokenMinter.withdraw` that allows the admin to withdraw \\$VE3D tokens from the contract. Noted that this withdraw function only perform the transfer, but did not update any of the state variables (e.g. totalSupply, maxSupply) in the contract.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L77>\n\n```\nfunction withdraw(address _destination, uint256 _amount) external onlyOwner {\n    veToken.safeTransfer(_destination, _amount);\n\n    emit Withdraw(_destination, _amount);\n}\n```\n\nAssuming that an admin withdrawed 29 million \\$VE3D tokens from the `VoteProxy` with the appropriate approval from the DAO or community for some valid purposes. The `veToken.balanceOf(VeTokenMinter.address)` will be 1 million \\$VE3D tokens after the withdrawal.\n\nAt this point, notice that `veToken.balanceOf(VeTokenMinter.address)` is 1 million, while the `VeTokenMinter.maxSupply` constant is 30 million. Therefore, there exists a discrepency between the actual amount of \\$VE3D tokens (1 million) stored in the contact versus the max supply (30 million).\n\nThis discrepency will cause an issue in the `VeTokenMinter.mint` function because the calculation of the amount of \\$VE3D tokens to be transferred is based on the fact that 30 million \\$VE3D tokens is always sitting in the `VeTokenMinter` contract, and thus there is always sufficient \\$VE3D tokens available in the `VeTokenMinter` contract to send to its users.\n\nThe `uint256 amtTillMax = maxSupply.sub(supply);` code shows that the calculation is based on `maxSupply` constant, which is 30 million.\n\nAssume that `mint(0x001, 10 million)` is called, and the value of the state variables when stepping through this function are as follows:\n\n*   `maxSupply` constant = 30 million\n*   `veToken.balanceOf(VeTokenMinter.address)` = 1 million\n*   `supply` & `totalSupply` = 20 million\n*   `totalCliffs` = 1000\n*   ` reductionPerCliff  ` = 30,000 (maxSupply / totalCliffs)\n*   `cliff` = 666 (supply/reductionPerCliff)\n*   `reduction` = 1000 - 666 = 334\n*   `_amount` = 10 million &ast; (334/1000) = 3.340 million\n*   `amtTillMax` = 10 million (maxSupply - supply) (Over here the contract assume that it still has 10 million VE3D tokens more to reach the max supply)\n*   `(_amount > amtTillMax)` = `False` (since \"3.340 million > 10 million\" = false )\n*   `veToken.safeTransfer(0x001, 3.340 million)` (This will revert. Insufficent balance)\n\nThe `veToken.safeTransfer(0x001, 3.340 million` will fail and revert because `VeTokenMinter` contract does not hold sufficent amount of \\$VE3D tokens to transfer out.`veToken.balanceOf(VeTokenMinter.address)` = 1 million, while the contract was attempting to send out 3.340 million.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L48>\n\n```\nfunction mint(address _to, uint256 _amount) external {\n    require(operators.contains(_msgSender()), \"not an operator\");\n\n    uint256 supply = totalSupply;\n\n    //use current supply to gauge cliff\n    //this will cause a bit of overflow into the next cliff range\n    //but should be within reasonable levels.\n    //requires a max supply check though\n    uint256 cliff = supply.div(reductionPerCliff);\n    //mint if below total cliffs\n    if (cliff < totalCliffs) {\n        //for reduction% take inverse of current cliff\n        uint256 reduction = totalCliffs.sub(cliff);\n        //reduce\n        _amount = _amount.mul(reduction).div(totalCliffs);\n\n        //supply cap check\n        uint256 amtTillMax = maxSupply.sub(supply);\n        if (_amount > amtTillMax) {\n            _amount = amtTillMax;\n        }\n\n        //mint\n        veToken.safeTransfer(_to, _amount);\n        totalSupply += _amount;\n    }\n}\n```\n\nThe failure/revert of `VeTokenMinter.mint` function will cascade up to `Booster.rewardClaimed`, and futher cascade up to `BaseRewardPool.getReward`. Thus, `BaseRewardPool.getReward` will stop working. As a result, the users will not be able to get any rewards from the reward contracts.\n\nThis issue will affect all projects (Curve, Pickle, Ribbon, Idle, Angle, Balancer) because ` VeTokenMinter  ` contract is deployed once, and referenced by all the projects. Thus, the impact could be quite widespread if this occurs, and many users would be affected.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598>\n\n```\nfunction rewardClaimed(\n    uint256 _pid,\n    address _address,\n    uint256 _amount\n) external returns (bool) {\n    address rewardContract = poolInfo[_pid].veAssetRewards;\n    require(msg.sender == rewardContract || msg.sender == lockRewards, \"!auth\");\n    ITokenMinter veTokenMinter = ITokenMinter(minter);\n    //calc the amount of veAssetEarned\n    uint256 _veAssetEarned = _amount.mul(veTokenMinter.veAssetWeights(address(this))).div(\n        veTokenMinter.totalWeight()\n    );\n    //mint reward tokens\n    ITokenMinter(minter).mint(_address, _veAssetEarned);\n\n    return true;\n}\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L267>\n\n```\nfunction getReward(address _account, bool _claimExtras)\n    public\n    updateReward(_account)\n    returns (bool)\n{\n    uint256 reward = earned(_account);\n    if (reward > 0) {\n        rewards[_account] = 0;\n        rewardToken.safeTransfer(_account, reward);\n        IDeposit(operator).rewardClaimed(pid, _account, reward);\n        emit RewardPaid(_account, reward);\n    }\n\n    //also get rewards from linked rewards\n    if (_claimExtras) {\n        for (uint256 i = 0; i < extraRewards.length; i++) {\n            IRewards(extraRewards[i]).getReward(_account);\n        }\n    }\n    return true;\n}\n```\n\n### Recommended Mitigation Steps\n\nRemove the `VeTokenMinter.withdraw` function if possible. Otherwise, update the internal accounting of `VeTokenMinter` contract during withdrawal so that the actual balance of the \\$VE3D tokens is taken into consideration within the `VeTokenMinter.mint`, and the contract will not attempt to transfer more tokens than what it has.\n\nOn a side note, [Convex's Minter contract](https://github.com/convex-eth/platform/blob/main/contracts/contracts/Cvx.sol), will mint the `CRX` gov tokens to the users on the fly. See <https://github.com/convex-eth/platform/blob/1f11027d429e454dacc4c959502687eaeffdb74a/contracts/contracts/Cvx.sol#L76>. Thus, there will not be a case where there is not sufficient `CRV` tokens in the contract to send to it users.\n\nHowever, in VeToken Protocol, it attempts to transfer the portion of pre-minted \\$VE3D tokens (30 millions) to the users. See <https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L72>. Thus, it is possible that there is not enough \\$VE3D tokens to send to its users if the admin withdraw the pre-minted \\$VE3D tokens.\n\n**[solvetony (veToken Finance) confirmed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/202#issuecomment-1156661445):**\n > We might need to withdraw, so we need to fix it.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/202#issuecomment-1193401315):**\n > I have to acknowledge that `mint` can fail if not enough token is present, however I must disagree with the finding.\n> \n> The warden is saying that [`totalSupply`](https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L73) is going to be a big number, while the number is updated exclusively after minting happens.\n> \n> For this reason I think the report is mostly invalid. No math issues will happen due to minting to the contract and then withdrawing as the variables will not be set in unrealistic values.\n> \n> However, it is true that `mint`ing an amount greater than what the contract hold will brick the system.\n> For that reason I'll consider the report as valid and Medium, however I believe the POC for the high severity finding to be incorrect.\n\n\n\n***\n\n## [[M-11] Misconfiguration of Fees Incentive Might Cause Tokens To Be Stuck In `Booster` Contract](https://github.com/code-423n4/2022-05-vetoken-findings/issues/215)\n_Submitted by xiaoming90, also found by 0xNazgul, berndartmueller, cccz, FSchmoede, Funen, kirk-baird, Kumpa, and VAD37_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L193>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L576>\n\n### Proof of Concept\n\nThe `Booster.setFeeInfo` function is responsible for setting the allocation of gauge fees between lockers and \\$VE3D stakers.  `lockFeesIncentive` and `stakerLockFeesIncentive` should add up to `10000` , which is equivalent to `100%`.\n\nHowever, there is no validation check to ensure that that `_lockFeesIncentive` and `_stakerLockFeesIncentive` add up to `10000`. Thus, it entirely depends on the developer to get these two values right.\n\nAs such, it is possible to set `lockFeesIncentive + takerLockFeesIncentive` to be less than `100%`. This might happen due to human error. For instance, a typo (forget a few zero) or newly joined developer might not be aware of the fee denomination and called `setFeeInfo(40, 60)` instead of `setFeeInfo(4000, 6000)`.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L193>\n\n```\nuint256 public constant FEE_DENOMINATOR = 10000;\n\n// Set reward token and claim contract, get from Curve's registry\nfunction setFeeInfo(uint256 _lockFeesIncentive, uint256 _stakerLockFeesIncentive) external {\n    require(msg.sender == feeManager, \"!auth\");\n\n    lockFeesIncentive = _lockFeesIncentive;\n    stakerLockFeesIncentive = _stakerLockFeesIncentive;\n    ..SNIP..\n}\n```\n\nAssume that `setFeeInfo(40, 60)` is called instead of of `setFeeInfo(4000, 6000)`, only `1%` of the fee collected will be transferred to the users and the remaining `99%` of the fee collected will be stuck in the `Booster` contract.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L576>\n\n```\nfunction earmarkFees() external returns (bool) {\n    //claim fee rewards\n    IStaker(staker).claimFees(feeDistro, feeToken);\n    //send fee rewards to reward contract\n    uint256 _balance = IERC20(feeToken).balanceOf(address(this));\n\n    uint256 _lockFeesIncentive = _balance.mul(lockFeesIncentive).div(FEE_DENOMINATOR);\n    uint256 _stakerLockFeesIncentive = _balance.mul(stakerLockFeesIncentive).div(\n        FEE_DENOMINATOR\n    );\n    if (_lockFeesIncentive > 0) {\n        IERC20(feeToken).safeTransfer(lockFees, _lockFeesIncentive);\n        IRewards(lockFees).queueNewRewards(_lockFeesIncentive);\n    }\n    if (_stakerLockFeesIncentive > 0) {\n        IERC20(feeToken).safeTransfer(stakerLockRewards, _stakerLockFeesIncentive);\n        IRewards(stakerLockRewards).queueNewRewards(feeToken, _stakerLockFeesIncentive);\n    }\n    return true;\n}\n```\n\n#### Can we retrieve or \"save\" the tokens stuck in `Booster` contract?\n\nAny veAsset (e.g. CRV, ANGLE) sitting on the `Booster` contract is claimable. However, in this case, the `feeToken` is likely not a veAsset, thus the remaining gauge fee will be stuck in the `Booster` contract perpetually. For instance, in Curve, the gauge fee is paid out in 3CRV, the LP token for the TriPool. ([Source](https://resources.curve.fi/crv-token/understanding-crv#staking-trading-fees))\n\n### Impact\n\nUsers will lost their gauge fee if this happens.\n\n### Recommended Mitigation Steps\n\nImplement validation check to ensure that `lockFeesIncentive` and `takerLockFeesIncentive` add up to 100% to eliminate any risk of misconfiguration.\n\n```\nuint256 public constant FEE_DENOMINATOR = 10000;\n\n// Set reward token and claim contract, get from Curve's registry\nfunction setFeeInfo(uint256 _lockFeesIncentive, uint256 _stakerLockFeesIncentive) external {\n    require(msg.sender == feeManager, \"!auth\");\n    require(_lockFeesIncentive + _stakerLockFeesIncentive == FEE_DENOMINATOR, \"Invalid fees\");\n\n    lockFeesIncentive = _lockFeesIncentive;\n    stakerLockFeesIncentive = _stakerLockFeesIncentive;\n    ..SNIP..\n}\n```\n\n**[solvetony (veToken Finance) confirmed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/215#issuecomment-1156735713):**\n > Will try to provide a fix based on recommendation.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/215#issuecomment-1193402631):**\n > The warden has shown that, due to a lack of checks, a misconfiguration can happen that will cause tokens to be stuck (although temporarily) in the `Booster`.\n> \n> I believe a simple check to ensure:\n> - Caller incentive is not unfairly high (e.g. 100%)\n> - Total sums up to 100%\n> \n> Would be a great way to give additional guarantees to the contract.\n> \n> Agree with Medium Severity.\n\n\n\n***\n\n## [[M-12] Malicious operator can rug pull](https://github.com/code-423n4/2022-05-vetoken-findings/issues/4)\n_Submitted by oyc_109_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L138-L143>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L274-L285>\n\n### Vulnerability Details\n\nA compromised or malicious operator can withdraw all tokens by calling the function withdrawAll\n\n    /2022-05-vetoken/contracts/VoterProxy.sol\n    138:     function withdrawAll(address _token, address _gauge) external returns (bool) {\n    139:         require(msg.sender == operator, \"!auth\");\n    140:         uint256 amount = balanceOfPool(_gauge).add(IERC20(_token).balanceOf(address(this)));\n    141:         withdraw(_token, _gauge, amount);\n    142:         return true;\n    143:     }\n\nThe operator can also call an arbitary address with any value\n\n    /2022-05-vetoken/contracts/VoterProxy.sol\n    274:     function execute(\n    275:         address _to,\n    276:         uint256 _value,\n    277:         bytes calldata _data\n    278:     ) external returns (bool, bytes memory) {\n    279:         require(msg.sender == operator, \"!auth\");\n    280: \n    281:         (bool success, bytes memory result) = _to.call{value: _value}(_data);\n    282:         require(success, \"!success\");\n    283: \n    284:         return (success, result);\n    285:     }\n\n**[jetbrain10 (veToken Finance) disputed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/4#issuecomment-1156603061):**\n > The operator will be the multi-sig wallet. \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/4#issuecomment-1193404020):**\n > The warden has shown a risk for depositors in that the `operator` can sweep all tokens out of the contract.\n> \n> While this comment is longer than the report, the finding is valid and of medium severity.\n\n\n\n***\n\n## [[M-13] Unused rewards(because of totalSupply()==0 for some period) will be locked forever in VE3DRewardPool and BaseRewardPool](https://github.com/code-423n4/2022-05-vetoken-findings/issues/168)\n_Submitted by unforgiven, also found by csanuragjain_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L152-L162>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L170-L183>\n\n### Impact\n\nThe `VE3DRewardPool` and `BaseRewardPool` contract is supposed to distribute rewards to stackers, but if in some period, `totalSupply()` was equal to `0`, then for that time period, rewards will not added to `rewardPerTokenStored` and those period rewards would not distribute to any address and those rewards will stuck in contract forever.\n\n### Proof of Concept\n\nThis is `notifyRewardAmount()` code in `BaseRewardPool` contract: (`VE3DRewardPool` code is similar)\n\n          function notifyRewardAmount(uint256 reward) internal updateReward(address(0)) {\n            historicalRewards = historicalRewards.add(reward);\n            if (block.timestamp >= periodFinish) {\n                rewardRate = reward.div(duration);\n            } else {\n                uint256 remaining = periodFinish.sub(block.timestamp);\n                uint256 leftover = remaining.mul(rewardRate);\n                reward = reward.add(leftover);\n                rewardRate = reward.div(duration);\n            }\n            currentRewards = reward;\n            lastUpdateTime = block.timestamp;\n            periodFinish = block.timestamp.add(duration);\n            emit RewardAdded(reward);\n        }\n\nAs you can see, in the line `rewardRate = reward.div(duration);` the value of `rewardRate` has been set to the division of available `reward` to `duration`. so if we distribute `rewardRate` amount in every second between stackers, then all rewards will be used by contract. contract uses ` updateReward()  ` modifier to update `rewardPerTokenStored` (this variable keeps track of distributed tokens) and this modifier uses  `rewardPerToken()` to update `BaseRewardPool`:\n\n          modifier updateReward(address account) {\n            rewardPerTokenStored = rewardPerToken();\n            lastUpdateTime = lastTimeRewardApplicable();\n            if (account != address(0)) {\n                rewards[account] = earned(account);\n                userRewardPerTokenPaid[account] = rewardPerTokenStored;\n            }\n            emit RewardUpdated(account, rewards[account], rewardPerTokenStored, lastUpdateTime);\n            _;\n        }\n\nThis is `rewardPerToken()` code in `BaseRewardPool`:\n\n        function rewardPerToken() public view returns (uint256) {\n            if (totalSupply() == 0) {\n                return rewardPerTokenStored;\n            }\n            return\n                rewardPerTokenStored.add(\n                    lastTimeRewardApplicable().sub(lastUpdateTime).mul(rewardRate).mul(1e18).div(\n                        totalSupply()\n                    )\n                );\n        }\n\nIf for some period `totalSupply()` was `0` then contract won't increase `rewardPerTokenStored` and those periods reward stuck in contract forever, because there is no mechanism to calculate them and withdraw them in contract.\nFor example if `operator` deploy and initialize the pool immediately before others having a chance of stacking their tokens, and use `queueNewRewards()` to queue the rewards then The rewards for early period of pool will be locked forever.\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nAdd some mechanism to recalculate `rewardRate` or calculated undistributed rewards(calculated undistributed reward based on `rewardRate` and when `totalSupply()` is `0`).\n\n**[solvetony (veToken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/168#issuecomment-1156648983):**\n > Recover function would solve this issue. Middle risk.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/168#issuecomment-1193413011):**\n > The warden has found a valid problem, however a coded POC would have gone a long way.\n> \n> In order to judge the issue I had to code it for myself to be able to demonstrate the problem.\n> \n> Anyhow this is a Brownie dump of me setting up the contract (removing transferFrom to get it done rapidly)\n> Showing how skipping 1/3 of reward duration will cause a loss of 1/3 of the yield.\n> \n> Meaning that the accumulator used for rewards is not redistributing the old rewards\n> \n> ```\n> >>> x.lastTimeRewardApplicable()\n> 0\n> >>> x.queueNewRewards(1e18, {\"from\": a[0]})\n> Transaction sent: 0x0b959c886d959038396aa0a9a82cef39c6bc817e4e48026068b242b0a46df81f\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 5\n>   BaseRewardPool.queueNewRewards confirmed   Block: 15208165   Gas used: 46822 (0.39%)\n> \n> <Transaction '0x0b959c886d959038396aa0a9a82cef39c6bc817e4e48026068b242b0a46df81f'>\n> >>> x.lastTimeRewardApplicable()\n> 1658703966\n> >>> chain.time()\n> 1658703975\n> >>> 1658703966 - 1658703975\n> -9\n> >>> x.lastTimeRewardApplicable()\n> 1658703966\n> >>> x.lastUpdateTime()\n> 1658703966\n> >>> x.periodFinish()\n> 1659308766\n> >>> 1658703966 - 1659308766\n> -604800\n> >>> chain.sleep(604800 // 3) \\#\\# Sleep for third of time\n> >>> chain.time()\n> 1658905644\n> >>> 1658905644- 1659308766\n> -403122\n> >>> x.stake(1e18, {\"from\": a[0]})\n> Transaction sent: 0x4899faa962b45d2f746db4f045b9858fdd506185cecab019516f4b9cae4bfd37\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 6\n>   BaseRewardPool.stake confirmed   Block: 15208166   Gas used: 73201 (0.61%)\n> \n> <Transaction '0x4899faa962b45d2f746db4f045b9858fdd506185cecab019516f4b9cae4bfd37'>\n> >>> x.balanceOf(a[0])\n> 1000000000000000000\n> >>> x.earned(a[0])\n> 0\n> >>> chain.sleep(x.duration())\n> >>> x.earned(a[0])\n> 0\n> >>> x.getReward(a[0], False)\n> Transaction sent: 0xba12fac5aa76e59d51fa277245cd96db53d7ca2685bdf97abdee734550f102e8\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 7\n>   BaseRewardPool.getReward confirmed   Block: 15208167   Gas used: 57623 (0.48%)\n> \n> <Transaction '0xba12fac5aa76e59d51fa277245cd96db53d7ca2685bdf97abdee734550f102e8'>\n> >>> history[-1].return_value\n> 666502976190414339\n> >>>\n> ``` \n> \n> Which means, that the warden has found a valid vulnerability and any time spent with a totalSupply of 0 will cause those rewards to be lost.\n> \n> Because this is contingent on:\n> - No deposits before adding rewards\n> - Lasts only until a deposit has happened\n> - Is related to loss of yield\n> \n> I believe Medium Severity to be more appropriate.\n\n\n\n***\n\n## [[M-14] Deposited staking tokens can be lost if rewards token info added by mistake in addReward() in VE3DRewardPool and there is no checking to ensure this would not happen (ve3Token for one reward was equal to stacking token)](https://github.com/code-423n4/2022-05-vetoken-findings/issues/172)\n_Submitted by unforgiven_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L102-L112>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L297-L318>\n\n### Impact\n\nIf `owner` by mistake or bad intention add a reward token that `ve3Token` of `new reward` token was equal to `old reward` token address then `old reward` token balance of `VE3DRewardPool` can be lost by calling `getReward(account, _claimExtras=False,_stake=False)` because of the line `314` which is `IERC20(rewardTokenInfo[_rewardToken].ve3Token).safeTransfer(_account,ve3TokenBalance);`\n\n### Proof of Concept\n\nThis is `addReward()` code in `VE3DRewardPool`:\n\n        function addReward(\n            address _rewardToken,\n            address _veAssetDeposits,\n            address _ve3TokenRewards,\n            address _ve3Token\n        ) external onlyOwner {\n            rewardTokenInfo[_rewardToken].veAssetDeposits = _veAssetDeposits;\n            rewardTokenInfo[_rewardToken].ve3TokenRewards = _ve3TokenRewards;\n            rewardTokenInfo[_rewardToken].ve3Token = _ve3Token;\n            rewardTokens.add(_rewardToken);\n        }\n\nAs you can see there is no check for values and it sets new `rewardToken` parameters. This is `getReward()` code:\n\n        function getReward(\n            address _account,\n            bool _claimExtras,\n            bool _stake\n        ) public updateReward(_account) {\n            address _rewardToken;\n            for (uint256 i = 0; i < rewardTokens.length(); i++) {\n                _rewardToken = rewardTokens.at(i);\n\n                uint256 reward = earnedReward(_rewardToken, _account);\n                if (reward > 0) {\n                    rewardTokenInfo[_rewardToken].rewards[_account] = 0;\n                    IERC20(_rewardToken).safeApprove(rewardTokenInfo[_rewardToken].veAssetDeposits, 0);\n                    IERC20(_rewardToken).safeApprove(\n                        rewardTokenInfo[_rewardToken].veAssetDeposits,\n                        reward\n                    );\n                    IVeAssetDeposit(rewardTokenInfo[_rewardToken].veAssetDeposits).deposit(\n                        reward,\n                        false\n                    );\n\n                    uint256 ve3TokenBalance = IERC20(rewardTokenInfo[_rewardToken].ve3Token).balanceOf(\n                        address(this)\n                    );\n                    if (_stake) {\n                        IERC20(rewardTokenInfo[_rewardToken].ve3Token).safeApprove(\n                            rewardTokenInfo[_rewardToken].ve3TokenRewards,\n                            0\n                        );\n                        IERC20(rewardTokenInfo[_rewardToken].ve3Token).safeApprove(\n                            rewardTokenInfo[_rewardToken].ve3TokenRewards,\n                            ve3TokenBalance\n                        );\n                        IRewards(rewardTokenInfo[_rewardToken].ve3TokenRewards).stakeFor(\n                            _account,\n                            ve3TokenBalance\n                        );\n                    } else {\n                        IERC20(rewardTokenInfo[_rewardToken].ve3Token).safeTransfer(\n                            _account,\n                            ve3TokenBalance\n                        );\n                    }\n                    emit RewardPaid(_account, ve3TokenBalance);\n                }\n            }\n\n            //also get rewards from linked rewards\n            if (_claimExtras) {\n                uint256 length = extraRewards.length;\n                for (uint256 i = 0; i < length; i++) {\n                    IRewards(extraRewards[i]).getReward(_account);\n                }\n            }\n        }\n\nAs you can see it loops through all `rewardTokens` and in line `314` it transfers all balance of `rewardTokenInfo[_rewardToken].ve3Token` of contract to `account` address. So if `owner` by mistake or bad intention add a new `rewardToken` that `rewardTokenInfo[newRewardToken].ve3Token == oldRewardToken` then by calling `getReward(account, False, False)` contract will loop through all reward tokens and when it reaches the `newRewardToken` it will transfer all the balance of contract in `rewardTokenInfo[newRewardToken].ve3Token` address to account address and `rewardTokenInfo[newRewardToken].ve3Token` is `oldRewardToken`, so it will transfer all the `oldRewardToken` balance of contract(which was supposed to be distributed among all stackers) to account address. This is like a backdoor that gives `owner` the ability to withdraw rewards tokens and if owner makes a simple mistake then one can easily withdraw that contract balance of reward token.\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nIn `addReward()` check that there is no mistake or any malicious values added to rewards.\n\n**[solvetony (veToken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/172#issuecomment-1156653388):**\n > We would try to decrease chance of that, most likely by implementing validation, to reduce manual check for owner.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/172#issuecomment-1193415095):**\n > The warden has shown how due to misconfiguration all rewards could be sent to the first claimer, because this is contingent on a misconfiguration, I believe Medium Severity to be more appropriate.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/172#issuecomment-1193416081):**\n > While this report and [#179](https://github.com/code-423n4/2022-05-vetoken-findings/issues/179) can be grouped as similar, I believe the warden has shown two different potential risks and at this time am choosing to leave the two findings as separate.\n\n\n\n***\n\n## [[M-15] Owner should be allowed to change feeManager](https://github.com/code-423n4/2022-05-vetoken-findings/issues/99)\n_Submitted by csanuragjain_\n\nOnce Fee Manager has been set initially by owner, then owner has no power to change it. Owner should be allowed to change fees manager in case if he feels current fee manager is behaving maliciously\n\n### Proof of Concept\n\n1.  Observe the setFeeManager function and see that only feeManager is allowed to change it once set initially\n\n<!---->\n\n    function setFeeManager(address _feeM) external {\n            require(msg.sender == feeManager, \"!auth\");\n            feeManager = _feeM;\n            emit FeeManagerUpdated(_feeM);\n        }\n\n### Recommended Mitigation Steps\n\nChange the setFeeManager function like below. Same can be done with other important functionality involving setArbitrator and setVoteDelegate\n\n    require(msg.sender == owner, \"!auth\");\n\n**[jetbrain10 (veToken Finance) confirmed, but disagreed with severity](https://github.com/code-423n4/2022-05-vetoken-findings/issues/99)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/99#issuecomment-1193425185):**\n > I agree with the finding, the feeManager can also potentially funnel funds away so it's best to allow governance to replace them if need be.\n> \n> Due to the finding being tied to admin privilege, I agree with Medium Severity.\n\n\n\n***\n\n## [[M-16] Admin Privilege in minting to arbitrary address allows operator to dilute tokens](https://github.com/code-423n4/2022-05-vetoken-findings/issues/108)\n_Submitted by Alex the Entreprenerd, also found by IllIllI_\n\n`veTokenMinter` allows any operator to mint new tokens, that's fine in the context of it being used for:\n\n*   having `VeAssetDepositor` deposit for the user and mint\n*   Having the `Booster` mint reward tokens\n\nHowever because of the open ended system that allows any address to be set as `operator`, the system allows the admin to set themselves as the operator and to mint an excess amount of tokens, diluting other users.\n\nBecause this seems to be used exclusively by the `VeAssetDepositor` and the `Booster` hardcoding these two addresses would provide stronger security guarantees.\n\n### Proof of Concept\n\naddOperator(malicious, {\"from\": gov})\n\nmint(malicious, AMOUNT, {\"from\": malicious})\n\n### Recommended Mitigation Steps\n\nSet the minters as immutable to provide stronger security guarantees.\n\n**[jetbrain10 (veToken Finance) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/108#issuecomment-1156697130):**\n > Admin will be controlled by DAO to prevent this happen.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/108#issuecomment-1193431886):**\n> Because am judging the contest am forfeiting any winnings.\n> \n> I do believe that the system would be best if the minters where hardcoded (it would also save gas).\n\n\n\n***\n\n## [[M-17] Missing sane bounds on asset weights](https://github.com/code-423n4/2022-05-vetoken-findings/issues/192)\n_Submitted by IllIllI_\n\nThe admin may fat-finger a change, or be malicious, and have the weights be extreme - ranging from zero to `type(uint256).max`, which would cause the booster to pay out unexpected amounts\n\n### Proof of Concept\n\nNo bounds checks in the update function:\n\n```\nFile: contracts/VeTokenMinter.sol   \\#1\n\n41       function updateveAssetWeight(address veAssetOperator, uint256 newWeight) external onlyOwner {\n42           require(operators.contains(veAssetOperator), \"not an veAsset operator\");\n43           totalWeight -= veAssetWeights[veAssetOperator];\n44           veAssetWeights[veAssetOperator] = newWeight;\n45           totalWeight += newWeight;\n46       }\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L41-L46>\n\nThe value is used by the reward contract to determine how much to mint:\n\n```\nFile: contracts/Booster.sol   \\#2\n\n598       function rewardClaimed(\n599           uint256 _pid,\n600           address _address,\n601           uint256 _amount\n602       ) external returns (bool) {\n603           address rewardContract = poolInfo[_pid].veAssetRewards;\n604           require(msg.sender == rewardContract || msg.sender == lockRewards, \"!auth\");\n605           ITokenMinter veTokenMinter = ITokenMinter(minter);\n606           //calc the amount of veAssetEarned\n607           uint256 _veAssetEarned = _amount.mul(veTokenMinter.veAssetWeights(address(this))).div(\n608               veTokenMinter.totalWeight()\n609           );\n610           //mint reward tokens\n611           ITokenMinter(minter).mint(_address, _veAssetEarned);\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L598-L611>\n\nWrong values will lead to excessive inflation/deflation.\n\n### Recommended Mitigation Steps\n\nHave sane upper/lower limits on the values.\n\n**[solvetony  (veToken Finance) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/192#issuecomment-1156727045):**\n > We may consider adding this.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/192#issuecomment-1193438892):**\n > The warden has shown how due to a lack of checks certain assets may provide a disproportionate amount of rewards.\n> \n> Because this is contingent on an admin mistake, and the impact would be loss or gain of Yield; I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-18] Governance can arbitrarily burn VeToken from any address](https://github.com/code-423n4/2022-05-vetoken-findings/issues/233)\n_Submitted by shenwilly_\n\nGovernance can burn any amount of `VeToken` from any address.\n\nUnlike `VE3Token` which is minted when users deposit veAsset and burned when users withdraw, the `burn` function in the governance token `VeToken.sol` is unnecessary and open up the risk of malicious/compromised governance burning user's token.\n\n### Recommended Mitigation Steps\n\nConsider removing the function, or modify the burn function so it only allows `msg.sender` to burn the token:\n\n    function burn(uint256 _amount) external {\n        _burn(msg.sender, _amount);\n    }\n\n**[solvetony (veToken Finance) acknowledged and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/233#issuecomment-1156744206):**\n > We might update readme on that case.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/233#issuecomment-1193449708):**\n > The warden has shown how the operator, which may be the DAO or a privileged Multisig, can burn any tokens.\n> \n> While the functionality is part of the system for VE3Token as the system uses it to track underlying ownership, burning of balances from arbitrary addresses is a dangerous form of admin privilege.\n> \n> I'd recommend deleting the burn function.\n\n\n\n***\n\n## [[M-19] `VE3DRewardPool` claim in loop depend on pausable token](https://github.com/code-423n4/2022-05-vetoken-findings/issues/166)\n_Submitted by VAD37_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L296-L299>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/1be2f03670e407908f175c08cf8cc0ce96c55baf/contracts/VeAssetDepositor.sol#L134-L152>\n\n### Vulnerability Details\n\nProject veToken is supposed to be a generalized version of Convex for non-Curve token.\nThere is only one contract for all rewards token in the platform.\n\nAll ve3Token rewards are bundled together inside `ve3DLocker` and `ve3DRewardPool` in a loop. Instead of having its own unique contract like `VeAssetDepositer` or `VoterProxy` for each token.\n\n### Impact\n\nIf one token has pausable transfer, user cannot claim rewards or withdraw if they have multiple rewards include that pause token.\n\nRight now the project intends to support only 6 tokens, including Ribbon token which has [pausable transfer](https://etherscan.io/address/0x6123b0049f904d730db3c36a31167d9d4121fa6b#code#L810) controlled by Ribbon DAO.\n\nNormally, this would not be an issue in Convex where only a few pools would be affected by single coin. Since, veAsset are bundled together into single reward pool, it becomes a major problem.\n\n### Proof of Concept\n\n*   Token like Ribbon pause token transfer by DAO due to an unfortunate event.\n*   `VE3DRewardPool` try call `getReward()`, `VeAssetDepositor` [try deposit token from earned rewards](https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L296-L299) does not work anymore because `IERC20.transfer` [is blocked](https://github.com/code-423n4/2022-05-vetoken/blob/1be2f03670e407908f175c08cf8cc0ce96c55baf/contracts/VeAssetDepositor.sol#L134-L152). This effectively reverts current function if user have this token reward > 0.\n\n### Recommended Mitigation Steps\n\nIt would be a better practice if we had a second `getReward()` function that accepts an array of token that we would like to interact with.\n\nIt saves gas and only requires some extra work on frontend website.\nInstead of current implementation, withdraw all token bundles together.\n\n**[solvetony (veToken Finance) confirmed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/166#issuecomment-1156706193):**\n > It might happen rarely, but we might fix that.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/166#issuecomment-1194847379):**\n > The warden has shown how, in certain cases, because a reward token could be pausable, this can cause the entire claim process to break as `getReward` doesn't allow the caller to specify which tokens to receive.\n> \n> I have to agree that the odds are low, however the finding is valid and because it's reliant on external conditions I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-20] Contracts should be robust to upgrades of underlying gauges and eventually changes of the underlying tokens](https://github.com/code-423n4/2022-05-vetoken-findings/issues/50)\n_Submitted by Picodes_\n\nFor some veAsset project (for example Angle’s [gauges](https://github.com/AngleProtocol/angle-core/blob/main/contracts/staking/LiquidityGaugeV4UpgradedToken.vy), gauge contracts are upgradable, so interfaces and underlying LP tokens are subject to change, blocking and freezing the system. Note that this is not hypothetic as it happened a few weeks ago: see this [snapshot vote](https://snapshot.org/#/anglegovernance.eth/proposal/0x1adb0a958220b3dcb54d2cb426ca19110486a598a41a75b3b37c51bfbd299513). Therefore, the system should be robust to a change in the pair gauge / token.\n\nNote that is doable in the current setup for the veToken team to rescue the funds in such case, hence it is only a medium issue.\nYou’d have to do as follow: a painful shutdown of the `Booster` (which would lead to an horrible situation where you’d have to preserve backwards compatibility for LPs to save their funds in the new Booster), an operator change in `VoterProxy` to be able to call `execute`.\n\n### Recommended Mitigation Steps\n\nTo deal with upgradeable contracts, either the `VoterProxy` needs to be upgradable to deal with any situation that may arise, either you need to add upgradeable “intermediate” contracts between the `staker` and the gauge that could be changed to preserve the logic.\n\n**[jetbrain10 (veToken Finance) confirmed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/50#issuecomment-1156647119):**\n > Same as answer [#49](https://github.com/code-423n4/2022-05-vetoken-findings/issues/49)  for angle Voter Proxy, will make it upgrade able and make all future VoterProxy can be upgrade able as well if veAsset project agrees.  \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/50#issuecomment-1194878444):**\n > The warden has shown how, due to integrating with underlying upgradeable contracts, the Sponsors Contracts could get bricked or forced into a shutdown.\n> \n> I believe the finding to be equivalent to showing how the system could end up being attached to a bad gauge, and the warden has shown historical proof that this has happened and could happen again.\n> \n> For those reasons, as well as the Sponsor Confirming, I believe the finding to be valid and of Medium Severity.\n\n\n\n***\n\n## [[M-21] `VoterProxy` incorrectly assumes a 1-1 mapping between the gauge and the LP tokens.](https://github.com/code-423n4/2022-05-vetoken-findings/issues/51)\n_Submitted by Picodes_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L270>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L140>\n\n### Impact\n\nWhen calling `withdrawAll`, to compute the amount to withdraw, the contract checks the balance of gauge tokens and assume that `1 gauge token = 1 LP token` by doing `uint256 amount = balanceOfPool(_gauge).add(IERC20(_token).balanceOf(address(this)));`. Overall this assumption may not hold and this would lead to a loss of funds when calling `withdrawAll`.\n\n### Proof of Concept\n\nIndeed this is false in some cases, check for example <https://etherscan.io/address/0x3785Ce82be62a342052b9E5431e9D3a839cfB581> where the total supply is not the same as the balance of LP tokens held by the contract. You can also check the contract code where you can see there is a `staking_factor` between the balance and the underlying LP token balance.\n\n### Recommended Mitigation Steps\n\nUse the total supply of `pool.token` which is a better proxy to know how much to withdraw when withdrawing all.\n\n**[jetbrain10 (veToken Finance) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/51#issuecomment-1156648009):**\n > Are you referring we need to calc the staking _factor by ourself?\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/51#issuecomment-1193441785):**\n > @jetbrain10 the warden says that some Deposits will not return the same amount of Lp Tokens.\n> \n> See this example from the contract linked by the Warden:\n> https://etherscan.io/tx/0xd3eab573697d4fb92ebe4d91d35b03795d384ac45f7a723b321c98f6da2420cb\n>\n> I think this means the contracts may break when integrating with Angle Protocol.\n> \n> As far as I'm aware CRV, Balancer will return a 1-1 between the Deposit Token and the Gauge Token.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/51#issuecomment-1194879916):**\n > The warden has shown evidence of the GaugeLP-Token being \"rebased\" from the \"usual\" 1-1 to a ratio (assuming due to cost / increasing in value in underlying).\n> \n> Because:\n> - The Sponsor system is meant to integrate with multiple protocols\n> - The warden has shown a specific example (ANGLE) of the math bring broken\n> \n> Considering that this is contingent on the sponsor launching an integration with the Angle Protocol, using Gauges that \"rebase\", I believe the finding to be Valid and of Medium Severity.\n> \n> Most likely remediation will require poking the gauge for exchange rates and also checking available tokens after withdrawing.\n\n**[jetbrain10 (veToken Finance) acknowledged](https://github.com/code-423n4/2022-05-vetoken-findings/issues/51)**\n\n\n\n***\n\n## [[M-22] VE3DRewardPool allows the same reward address to be added multiple times to the `extraRewards` array](https://github.com/code-423n4/2022-05-vetoken-findings/issues/55)\n_Submitted by Ruhum_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L134-L139>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L214-L216>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/BaseRewardPool.sol#L121>\n\n### Impact\n\nWhen the same address is included twice it might cause issues depending on the contract. I checked the current convex contract to see which addresses were added to the `extraRewards` array. For [cvxCRV Rewards](https://etherscan.io/address/0x3Fe65692bfCD0e6CF84cB1E7d24108E434A7587e#readContract) there's only [0x7091dbb7fcbA54569eF1387Ac89Eb2a5C9F6d2EA](https://etherscan.io/address/0x7091dbb7fcbA54569eF1387Ac89Eb2a5C9F6d2EA#code) which is the VirtualBalanceRewardPool contract.\n\n### Proof of Concept\n\n1.  `rewardManager` adds the same address twice through [`addExtraReward()`](https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L134-L139)\n2.  VE3DRewardPool calls [`stake()`](https://github.com/code-423n4/2022-05-vetoken/blob/main/contracts/VE3DRewardPool.sol#L209-L226) twice with the same amount:\n\n```sol\n    function stake(uint256 _amount) public updateReward(msg.sender) {\n        require(_amount > 0, \"RewardPool : Cannot stake 0\");\n\n        //also stake to linked rewards\n        uint256 length = extraRewards.length;\n        for (uint256 i = 0; i < length; i++) {\n            IRewards(extraRewards[i]).stake(msg.sender, _amount);\n        }\n\n        //add supply\n        _totalSupply = _totalSupply.add(_amount);\n        //add to sender balance sheet\n        _balances[msg.sender] = _balances[msg.sender].add(_amount);\n        //take tokens from sender\n        stakingToken.safeTransferFrom(msg.sender, address(this), _amount);\n\n        emit Staked(msg.sender, _amount);\n    }\n```\n\n### Recommended Mitigation Steps\n\nPrevent the same addresses from being added multiple times to the `extraRewards` array.\n\n**[jetbrain10 (vetoken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/55#issuecomment-1156650189):**\n > Will add code to check if this is same reward address.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/55#issuecomment-1194880451):**\n > The warden has shown how, due to a misconfiguration, rewards could be disbursed twice, breaking protocol invariants.\n> \n> Because this is contingent on admin privilege, I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-23] BaseRewardPool's `rewardPerTokenStored` can be inflated and rewards can be stolen](https://github.com/code-423n4/2022-05-vetoken-findings/issues/201)\n_Submitted by sorrynotsorry_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L180>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L137-L142>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L157-L159>\n\n### Impact\n\nThe first user who calls BaseRewardPool's `stake()` function with 1 wei can inflate the `rewardPerTokenStored`. And the same user can call `withdraw` and drain the rewards.\n\n### Proof of Concept\n\nWhen a user call `stake()` with 1 wei,  it updates the `_totalSupply` as 1 wei  and the `rewards` through `updateReward` modifier.\nThis modifier calls `rewardPerToken()` to assign the return to `rewardPerTokenStored` and assigns it to the account via `userRewardPerTokenPaid[account] = rewardPerTokenStored;`\n`rewardPerToken()` formula is as below;\n\n```\nfunction rewardPerToken() public view returns (uint256) {\n        if (totalSupply() == 0) {\n            return rewardPerTokenStored;\n        }\n        return\n            rewardPerTokenStored.add(\n                lastTimeRewardApplicable().sub(lastUpdateTime).mul(rewardRate).mul(1e18).div(\n                    totalSupply()\n                )\n            );\n    }\n```\n\nSince it depends on the denominator  as totalSupply(), the whole multiplying will be divided by 1 wei which will inflate the `rewardPerTokenStored` astronomically.\nAnd there is no obstacle for the user to withdraw it in the withdraw function.\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L180>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L137-L142>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L157-L159>\n\n### Recommended Mitigation Steps\n\nThe team might consider to add boundries to reward the stakers to be consistent inside the limits.\n\n**[solvetony (veToken Finance) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/201#issuecomment-1156660229):**\n > This is the rare case when only one staker in the pool.\n\n**[Alex the Entreprenerd (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/201#issuecomment-1196128779):**\n > This report would have heavily benefited by a coded POC.\n> \n> I'm pasting my raw data from terminal (typos and stuff included)\n> \n> \n> ## Compare for unfairness\n> \n> Seems to be unfair toward the early depositor, but not too crazily\n> \n> ```\n> >>> x = BaseRewardPool.deploy(1, ETH_ADDRESS, ETH_ADDRESS, a[0], a[0], {\"from\": a[0]})\n> Transaction sent: 0x981137ae6eead737b5a56a58f03046f184b9482c7b85307c3eba140a401a92f5\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 4\n>   BaseRewardPool.constructor confirmed   Block: 15221212   Gas used: 863738 (7.20%)\n>   BaseRewardPool deployed at: 0xe0aA552A10d7EC8760Fc6c246D391E698a82dDf9\n> \n> >>> x.stake(1, {\"from\": a[0]})\n> Transaction sent: 0x03971a1e78ab54979f834746436488f1cb49c5a483957f0ce01f409124bd38d5\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 5\n>   BaseRewardPool.stake confirmed   Block: 15221213   Gas used: 79754 (0.66%)\n> \n> <Transaction '0x03971a1e78ab54979f834746436488f1cb49c5a483957f0ce01f409124bd38d5'>\n> >>> x.queueNewRewards(1e18, {\"from\": a[0]})\n> Transaction sent: 0xb88fe369ed4b49f8043d67354f3429f41a403fa98b4e74a82a2a773ae00186d9\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 6\n>   BaseRewardPool.queueNewRewards confirmed   Block: 15221214   Gas used: 39180 (0.33%)\n> \n> <Transaction '0xb88fe369ed4b49f8043d67354f3429f41a403fa98b4e74a82a2a773ae00186d9'>\n> >>> chain.sleep(x.duration() // 10)\n> >>> chain.time\n> <bound method Chain.time of <Chain object (chainid=1, height=15221214)>>\n> >>> chain.time()\n> 1658940912\n> >>> chain.sleep(x.duration() // 10)\n> >>> chain.time()\n> 1659001396\n> >>> x.stake(1, {\"from\": a[0]})\n> Transaction sent: 0xea095333668d2f89979e55bfd7252e6c117d875bfbb628ee853383a3da3064e5\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 7\n>   BaseRewardPool.stake confirmed   Block: 15221215   Gas used: 74391 (0.62%)\n> \n> <Transaction '0xea095333668d2f89979e55bfd7252e6c117d875bfbb628ee853383a3da3064e5'>\n> >>> x.stake(10, {\"from\": a[1]})\n> Transaction sent: 0x85f2de5caee675c9c9889533804c65cb6b337f3dcb714af718fec70bc33a34d6\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 5\n>   BaseRewardPool.stake confirmed   Block: 15221216   Gas used: 100191 (0.83%)\n> \n> <Transaction '0x85f2de5caee675c9c9889533804c65cb6b337f3dcb714af718fec70bc33a34d6'>\n> >>> chain.sleep(x.duration())\n> >>> first = x.getReward({\"from\": a[0]).return_value\n>   File \"<console>\", line 1,\n>     first = x.getReward({\"from\": a[0]).return_value\n>                                      ^\n> SyntaxError: closing parenthesis ')' does not match opening parenthesis '{'\n> >>> first = x.getReward({\"from\": a[0]).return_value\n>   File \"<console>\", line 1,\n>     first = x.getReward({\"from\": a[0]).return_value\n>                                      ^\n> SyntaxError: closing parenthesis ')' does not match opening parenthesis '{'\n> >>> first = x.getReward({\"from\": a[0]}).return_value\n> Transaction sent: 0x6cd0057d7a1c9586b6bb75324d1871fbce02b661c2bd957ee4d58adee58799d2\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 8\n>   BaseRewardPool.getReward confirmed   Block: 15221217   Gas used: 56876 (0.47%)\n> \n> >>> second = x.getReward({\"from\": a[1]}).return_value\n> Transaction sent: 0x2fc7122fe33c2b332d32c1bc634ef9ec5d94133fc41168408cbdec954e5bc8ad\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 6\n>   BaseRewardPool.getReward confirmed   Block: 15221218   Gas used: 48476 (0.40%)\n> \n> >>> first\n> True\n> >>> second\n> True\n> >>> x.userRewardPerTokenPaid(a[0])\n> 266715305335072250583333333333333333\n> >>> x.userRewardPerTokenPaid(a[1])\n> 266715305335072250583333333333333333\n> \n> \\#\\# Second User (10 deposited)\n> >>> history[-1].events\n> {'RewardUpdated': [OrderedDict([('user', '0x33A4622B82D4c04a53e170c638B944ce27cffce3'), ('reward', 666615685626040430), ('rewardPerTokenStored', 266715305335072250583333333333333333), ('lastUpdateTime', 1659485217)])]}\n> \\#\\# First user 2 deposited (early 1 /10th of time)\n> >>> history[-2].events\n> {'RewardUpdated': [OrderedDict([('user', '0x66aB6D9362d4F35596279692F0251Db635165871'), ('reward', 333384314373866769), ('rewardPerTokenStored', 266715305335072250583333333333333333), ('lastUpdateTime', 1659485217)])]}\n> >>>\n> ```\n> \n> \n> \\#\\# Deposit, front-run rewards and withdraw\n> ```\n> >>> x.stake(1, {\"from\": a[0]})\n> Transaction sent: 0x03971a1e78ab54979f834746436488f1cb49c5a483957f0ce01f409124bd38d5\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 5\n>   BaseRewardPool.stake confirmed   Block: 15221254   Gas used: 79754 (0.66%)\n> \n> <Transaction '0x03971a1e78ab54979f834746436488f1cb49c5a483957f0ce01f409124bd38d5'>\n> >>> x.queueNewRewards(1e18, {\"from\": a[0]})\n> Transaction sent: 0xb88fe369ed4b49f8043d67354f3429f41a403fa98b4e74a82a2a773ae00186d9\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 6\n>   BaseRewardPool.queueNewRewards confirmed   Block: 15221255   Gas used: 39180 (0.33%)\n> \n> <Transaction '0xb88fe369ed4b49f8043d67354f3429f41a403fa98b4e74a82a2a773ae00186d9'>\n> >>> x.withdraw(1, False, {\"from\": a[0]})\n> Transaction sent: 0x28e3687fb982c9473cd4c79e5a04e66f90cc1ab7182d6d55c6a790716d3aeddf\n>   Gas price: 0.0 gwei   Gas limit: 12000000   Nonce: 7\n>   BaseRewardPool.withdraw confirmed   Block: 15221256   Gas used: 44611 (0.37%)\n> \n> <Transaction '0x28e3687fb982c9473cd4c79e5a04e66f90cc1ab7182d6d55c6a790716d3aeddf'>\n> >>> history[-1].events\n> {'RewardUpdated': [OrderedDict([('user', '0x66aB6D9362d4F35596279692F0251Db635165871'), ('reward', 46296296296292), ('rewardPerTokenStored', 46296296296292000000000000000000), ('lastUpdateTime', 1658880907)])]}\n> >>> 46296296296292 / 1e18\n> 4.6296296296292e-05\n> >>>\n> \n> ```\n> \n> Let's compare against a more non-malicious realistic deposit of 1e18\n> (Same as above but stake and withdraw for 1e18)\n> ```\n> {'RewardUpdated': [OrderedDict([('user', '0x66aB6D9362d4F35596279692F0251Db635165871'), ('reward', 14880952380951), ('rewardPerTokenStored', 14880952380951), ('lastUpdateTime', 1658880998)])]}\n> ```\n> \n> Seems to receive 3 times less rewards\n> \n> \n> I think there may be a lot more to uncover, and this finding would have benefitted by more time invested in coding a POC.\n> \n> With the information that I have, it does seem like, due to the supply math, that early depositors can inflate the amount of rewards they receive by depositing a small amount.\n> \n> It may be advisable to discuss this with the Synthetix team to see historically how this can be griefed, and it may be ideal to require an initial deposit of at least 1e18 tokens on the first deposit.\n> \n> Because the finding is:\n> - Limited to loss of yield\n> - Lacks Coded POC showing how to steal all rewards (my due diligence denies that statement)\n> \n> I think Medium Severity is more appropriate\n\n\n\n***\n\n## [[M-24] User can lose funds](https://github.com/code-423n4/2022-05-vetoken-findings/issues/13)\n_Submitted by csanuragjain_\n\nIf `\\_rewardToken` is set as `\\_stakingToken` by mistake then user funds would get lost (staking token will get sent as reward token). Need to be fixed for BaseRewardPool.sol as well.\n\n### Proof of Concept\n\n1.  User A and B makes deposit of amount 100 each\n2.  Owner calls addReward and queueNewRewards to add 1 reward amount with \\_rewardToken as stakingToken (by mistake)\n3.  After some time reward is calculated as 5 for User A (total reward amount is same as staking amount which is 100+100+1).\n4.  User A makes the withdraw and obtains 105 amount and now User B is stuck since contract does not have enough funds\n\n### Recommended Mitigation Steps\n\nAdd below check in constructor\n\n    require(_stakingToken!=_rewardToken, \"Incorrect reward token\");\n\n**[jetbrain10 (veToken Finance) disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/13#issuecomment-1156617737):**\n > It's set by owner, so there is no issue, but it is nice to have and it is a quick fix.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/13#issuecomment-1196137029):**\n > The warden has shown how, due to a misconfiguration, the deposit token `stakingToken` could be transferred away to early withdrawers.\n> \n> For end users the basic due diligence would be to ensure that the `stakingToken` is not added as reward.\n> \n> Because the finding is contingent on a malicious admin / misconfiguration, I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-25] Consistently check account balance before and after transfers for Fee-On-Transfer discrepancies](https://github.com/code-423n4/2022-05-vetoken-findings/issues/190)\n_Submitted by Dravee, also found by pauliax_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L356>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L337>\n\n### Vulnerability Details\n\nAs arbitrary ERC20 tokens can be passed, the amount here should be calculated every time to take into consideration a possible fee-on-transfer or deflation.\n\nAlso, it's a good practice for the future of the solution.\n\nAffected code:\n\n*   File: Booster.sol\n\n```\n345:     function deposit(\n346:         uint256 _pid,\n347:         uint256 _amount,\n348:         bool _stake\n349:     ) public returns (bool) {\n...\n356:         IERC20(lptoken).safeTransferFrom(msg.sender, staker, _amount); //@audit medium: not compatible with Fee On Transfer Tokens\n...\n372:             ITokenMinter(token).mint(address(this), _amount);\n...\n374:             IERC20(token).safeApprove(rewardContract, _amount);\n375:             IRewards(rewardContract).stakeFor(msg.sender, _amount);\n...\n378:             ITokenMinter(token).mint(msg.sender, _amount);\n...\n381:         emit Deposited(msg.sender, _pid, _amount);\n...\n```\n\n*   File: VE3DRewardPool.sol\n\n```\n336:     function donate(address _rewardToken, uint256 _amount) external {\n337:         IERC20(_rewardToken).safeTransferFrom(msg.sender, address(this), _amount); //@audit medium: not compatible with Fee On Transfer Tokens\n338:         rewardTokenInfo[_rewardToken].queuedRewards += _amount;\n339:     }\n```\n\n### Recommended Mitigation Steps\n\nUse the balance before and after the transfer to calculate the received amount instead of assuming that it would be equal to the amount passed as a parameter.\n\n**[solvetony (veToken Finance) confirmed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/190#issuecomment-1156725976):**\n > Confirmed in donate function, we are have to add a check for the reward token list \n> However, I don't think we do anything with lp token as we already use the exact lp token address\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/190#issuecomment-1196138241):**\n > While I think the scenario is highly unlikely, the warden has shown how, in the case of a `feeOnTransfer` token being added as reward, the claiming of reward could be potentially broken.\n> \n> Remediation can be as simple as checking for the actual transferred amount in the `donate` function, or simply not allowing the tokens.\n> \n> However, because the warden has shown how the system could be bricked due to a configuration issue, I believe Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-26] `VE3DLocker.sol` Wrong implementation of inversely traverse for loops always reverts](https://github.com/code-423n4/2022-05-vetoken-findings/issues/150)\n_Submitted by WatchPug, also found by Dravee, gzeon, and TerrierLover_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L305-L329>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L349-L373>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L376-L396>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DLocker.sol#L399-L415>\n\n### Vulnerability Details\n\n```\nfunction totalSupplyAtEpoch(uint256 _epoch) external view returns (uint256 supply) {\n    uint256 epochStart = uint256(epochs[_epoch].date).div(rewardsDuration).mul(\n        rewardsDuration\n    );\n    uint256 cutoffEpoch = epochStart.sub(lockDuration);\n\n    //traverse inversely to make more current queries more gas efficient\n    for (uint256 i = _epoch; i + 1 != 0; i--) {\n        Epoch storage e = epochs[i];\n        if (uint256(e.date) <= cutoffEpoch) {\n            break;\n        }\n        supply = supply.add(epochs[i].supply);\n    }\n\n    return supply;\n}\n```\n\nIn `VE3DLocker.sol`, there are multiple instances in which an inversely traverse for loop is used \"to make more current queries more gas efficient\".\n\nFor example:\n\n*   `totalSupplyAtEpoch()`\n*   `balanceAtEpochOf()`\n*   `pendingLockAtEpochOf()`\n*   `totalSupply()`\n\nThe implementation of the inversely traverse for loop is inherited from Convex's original version: <https://github.com/convex-eth/platform/blob/main/contracts/contracts/CvxLockerV2.sol#L333-L334>\n\nHowever, Convex's locker contract is using Solidity 0.6.12, in which the arithmetic operations will overflow/underflow without revert.\n\nAs the solidity version used in the current implementation of `VE3DLocker.sol` is `0.8.7`, and there are some breaking changes in Solidity v0.8.0, including:\n\n> Arithmetic operations revert on underflow and overflow.\n\nRef: <https://docs.soliditylang.org/en/v0.8.7/080-breaking-changes.html#silent-changes-of-the-semantics>\n\nWhich makes the current implementation of inversely traverse for loops always reverts.\n\nMore specifically:\n\n1.  `for (uint i = locks.length - 1; i + 1 != 0; i--) {` will revert when `locks.length == 0` at `locks.length - 1` due to underflow;\n2.  `for (uint256 i = _epoch; i + 1 != 0; i--) {` will loop until `i == 0` and reverts at `i--` due to underflow.\n\nAs a result, all these functions will be malfunctioning and all the internal and external usage of these function will always revert.\n\n### Recommended Mitigation Steps\n\nChange `VE3DLocker.sol#L315` to:\n\n```\nfor (uint256 i = locks.length; i > 0; i--) {\n    uint256 lockEpoch = uint256(locks[i - 1].unlockTime).sub(lockDuration);\n    //lock epoch must be less or equal to the epoch we're basing from.\n    if (lockEpoch <= epochTime) {\n        if (lockEpoch > cutoffEpoch) {\n            amount = amount.add(locks[i - 1].amount);\n```\n\nChange `VE3DLocker.sol#L360` to:\n\n```\nfor (uint256 i = locks.length; i > 0; i--) {\n    uint256 lockEpoch = uint256(locks[i - 1].unlockTime).sub(lockDuration);\n\n    //return the next epoch balance\n    if (lockEpoch == nextEpoch) {\n        return locks[i - 1].amount;\n    } else if (lockEpoch < nextEpoch) {\n        //no need to check anymore\n        break;\n    }\n```\n\nChange `VE3DLocker.sol#L387` to:\n\n```\nfor (uint256 i = epochindex; i > 0; i--) {\n    Epoch storage e = epochs[i - 1];\n```\n\nChange `VE3DLocker.sol#L406` to:\n\n```\nfor (uint256 i = _epoch + 1; i > 0; i--) {\n    Epoch storage e = epochs[i - 1];\n    if (uint256(e.date) <= cutoffEpoch) {\n        break;\n    }\n    supply = supply.add(e.supply);\n}\n```\n\n**[solvetony (veToken Finance) confirmed and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/150#issuecomment-1156684581):**\n > Looks valid.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/150#issuecomment-1196144415):**\n > The warden has shed light into a underflow that will cause a few functions which logic was ported over from 0.6.12, to revert due to new checks introduced in a more recent version of solidity.\n> \n> While the bug is easily fixable, the functions are broken.\n> \n> Normally I would be conflicted between a Low and Medium severity as these functions are mostly `view` and seem to have no particular impact.\n> \n> However, due to my familiarity with other Lockers, and the CVX Voting Strategy used I believe the finding implications are that:\n> - Integrating strategies (tokenizedLocks of the VE3DLocker) would be bricked\n> - Snapshot wouldn't be usable as it would need to know the balance of a user at a specific epoch\n> \n> So am confident in a Medium Severity and have contemplated raising to High, as impact is pretty dramatic.\n> \n> Personally am very confident governance couldn't work without some of the `view` functions impacted, however, considering that the Warden (and other dups) did not bring in any mention of governance, I think Medium Severity is appropriate.\n> \n> I highly recommend the sponsor ensures their governance-related function don't revert as that would be very problematic.\n\n\n\n***\n\n## [[M-27] Booster's shutdownPool can freeze user funds](https://github.com/code-423n4/2022-05-vetoken-findings/issues/35)\n_Submitted by hyh, also found by jonatascm_\n\n`shutdownPool()` marks shutdown successful even if it's not (i.e. when withdrawAll() call wasn't successful). As withdrawing logic expect that the pool in shutdown has already provided the funds, and makes no additional attempts to retrieve them, user funds will be frozen permanently as there are no mechanics in place to turn shutdown off for a pool.\n\nSetting severity to medium as that's user principal funds freeze scenario conditional on any issues in withdrawAll().\n\n### Proof of Concept\n\nIn the case of unsuccessful withdrawAll() call the pool nevertheless will be marked as shutdown:\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L312-L320>\n\n```\n        //withdraw from gauge\n        try IStaker(staker).withdrawAll(pool.lptoken, pool.gauge) {} catch {}\n\n        pool.shutdown = true;\n        gaugeMap[pool.gauge] = false;\n\n        emit PoolShuttedDown(_pid);\n        return true;\n    }\n```\n\nIt will block the withdrawals as there will be not enough funds to fulfil the claim:\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L408-L422>\n\n```\n        //pull from gauge if not shutdown\n        // if shutdown tokens will be in this contract\n        if (!pool.shutdown) {\n            IStaker(staker).withdraw(lptoken, gauge, _amount);\n        }\n\n        //some gauges claim rewards when withdrawing, stash them in a seperate contract until next claim\n        //do not call if shutdown since stashes wont have access\n        address stash = pool.stash;\n        if (stash != address(0) && !isShutdown && !pool.shutdown) {\n            IStash(stash).stashRewards();\n        }\n\n        //return lp tokens\n        IERC20(lptoken).safeTransfer(_to, _amount);\n```\n\nThis way user funds will be frozen as the system will not attempt to withdraw from the pool, while there will be no funds to transfer to the user and \\_withdraw() will be reverting on L422 safeTransfer call.\n\n### Recommended Mitigation Steps\n\nThe shutdownPool logic can to be updated:\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L307-L320>\n\nConsider unifying the logic with shutdownSystem() and marking the pool shutdown only if withdraw was successful, for example:\n\n```\n//shutdown pool\nfunction shutdownPool(uint256 _pid, bool forced) external returns (bool){\n    require(msg.sende == poolManager, \"!auth\");\n    PoolInfo storage pool = poolInfo[_pid];\n\n    bool withdrawSuccess = false;\n\n    //withdraw from gauge\n    try IStaker(staker).withdrawAll(pool.lptoken,pool.gauge){\n    \twithdrawSuccess = true;\n    } catch {}\n\n    if (withdrawSuccess || forced) {\n\t    pool.shutdown = true;\n\t    gaugeMap[pool.gauge] = false;\n        emit PoolShuttedDown(_pid);\n    \treturn true;\n    }\n\n    return false;\n}\n```\n\n**[jetbrain10 (veToken Finance) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/35#issuecomment-1156634327):**\n > Convex has the same, and we may need force shutdown. \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/35#issuecomment-1193437919):**\n > My issue with the submission is that it makes the following statement:\n> `Setting severity to medium as that's user principal funds freeze scenario conditional on any issues in withdrawAll().`\n> \n> Without mentioning any possible scenario in which `withdrawAll` could fail\n> \n> \n> Given the information that I have we could have reverts if:\n> - Token is paused (e.g. Tether Blacklist)\n> - Gauge breaks (not much you can do there, pausing probably won't help recover funds)\n> - Misterious bugs in the code, none were mentioned above.\n> \n> Will think about severity.\n> \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/35#issuecomment-1196149442):**\n > After reviewing the rest of the contest, I remember marking a finding about Paused tokens with Medium Severity, so while I think the submission could have been made stronger by providing real-world examples of how the tokens could be stuck, to maintain consistency I'll mark this finding as valid as well.\n> \n> As while it's unspecified how a revert could happen, the try catch irreversible system does mean that a failed rescue bricks the tokens, perhaps a governance only secondary rescue system may be helpful for emergency scenarios.\n\n\n\n***\n\n## [[M-28] ExtraRewardStashV2's stashRewards can become unavailable](https://github.com/code-423n4/2022-05-vetoken-findings/issues/36)\n_Submitted by hyh_\n\nThere is no check for the reward token amount to be transferred out in stashRewards(). As reward token list is external (controlled with `IGauge(gauge).reward_tokens`), and an arbitrary token can end up there, in the case when such token doesn't allow for zero amount transfers, the stashRewards() managed extra rewards retrieval can become unavailable.\n\nI.e. stashRewards() can be blocked for even an extended period of time, so all other extra rewards gathering will not be possible. This cannot be controlled by the system as pool reward token list is external.\n\nSetting the severity to medium as reward gathering is a base functionality of the system and its availability is affected.\n\n### Proof of Concept\n\n`stashRewards()` attempts to send the `amount` to rewardArbitrator() without checking:\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV2.sol#L193-L203>\n\n```\n    if (activeCount > 1) {\n        //take difference of before/after(only send new tokens)\n        uint256 amount = IERC20(token).balanceOf(address(this));\n        amount = amount.sub(before);\n\n        //send to arbitrator\n        address arb = IDeposit(operator).rewardArbitrator();\n        if (arb != address(0)) {\n            IERC20(token).safeTransfer(arb, amount);\n        }\n    }\n```\n\nIf `IStaker(staker).withdraw()` produced no new tokens for any reason, the `amount = amount.sub(before)` above can be zero:\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/ExtraRewardStashV2.sol#L188-L189>\n\n```\n    uint256 before = IERC20(token).balanceOf(address(this));\n    IStaker(staker).withdraw(token);\n```\n\nAs reward `token` can be arbitrary, it can also be reverting on an attempt to transfer zero amounts:\n\n<https://github.com/d-xo/weird-erc20#revert-on-zero-value-transfers>\n\nIf this be the case then the whole stashRewards() call will be failing until `IStaker(staker).withdraw()` manage to withdraw some `tokens` or such `token` be removed from gauge's reward token list. Both events aren’t directly controllable by the system.\n\n### Recommended Mitigation Steps\n\nConsider running the transfer only when amount is positive:\n\n```\n-   if (activeCount > 1) {\n+   if (amount > 0 && activeCount > 1) {\n        //take difference of before/after(only send new tokens)\n        uint256 amount = IERC20(token).balanceOf(address(this));\n        amount = amount.sub(before);\n\n        //send to arbitrator\n        address arb = IDeposit(operator).rewardArbitrator();\n        if (arb != address(0)) {\n            IERC20(token).safeTransfer(arb, amount);\n        }\n    }\n```\n\n**[jetbrain10 (veToken Finance) confirmed](https://github.com/code-423n4/2022-05-vetoken-findings/issues/36)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/36#issuecomment-1196153811):**\n > The warden has shown how, due to a lack of check for zero-transfer, for specific tokens, the `stashRewads` function can be made to revert, causing it not to process any reward token\n> \n> Because this is contingent on the token having zero-balance and reverting, I think Medium Severity to be appropriate.\n\n\n\n***\n\n## [[M-29] Centralisation RIsk: `VoterProxy` owner may set the `operate` to an address they own and drain all token balances](https://github.com/code-423n4/2022-05-vetoken-findings/issues/82)\n_Submitted by kirk-baird_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L274-L285>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L123-L143>\n\n### Impact\n\nThe `owner` of `VoterProxy` is able to call `setOperator()` (if the previous operator is shutdown). This allows them to then call `execute()`, `withdraw()` or `withdrawAll()`.\n\nExecute makes a call to any arbitrary contract with arbitrary data. This may therefore call any ERC20 token, and gauge or the `VoterEscrow` account and withdraw protocol funds.\n\nThe functions `withdraw()` and `withdrawAll()` can also be abused to take all funds deposited in the gauges and transfer them to the owner's malicious address.\n\nThis poses a significant centralisation risk if the owner private key is compromised or the owner decides to rug pull.\n\n### Proof of Concept\n\nAfter the owner has updated the `operator` via `setOperator()` they are able to call `VoterProxy.execute()` to execute any call to any smart contract.\n\n```\n    function execute(\n        address _to,\n        uint256 _value,\n        bytes calldata _data\n    ) external returns (bool, bytes memory) {\n        require(msg.sender == operator, \"!auth\");\n\n\n        (bool success, bytes memory result) = _to.call{value: _value}(_data);\n        require(success, \"!success\");\n\n\n        return (success, result);\n    }\n```\n\nSimilarly, for `withdraw()` and `withdrawAll()`\n\n```\n    function withdraw(\n        address _token,\n        address _gauge,\n        uint256 _amount\n    ) public returns (bool) {\n        require(msg.sender == operator, \"!auth\");\n        uint256 _balance = IERC20(_token).balanceOf(address(this));\n        if (_balance < _amount) {\n            _amount = _withdrawSome(_gauge, _amount.sub(_balance));\n            _amount = _amount.add(_balance);\n        }\n        IERC20(_token).safeTransfer(msg.sender, _amount);\n        return true;\n    }\n\n\n    function withdrawAll(address _token, address _gauge) external returns (bool) {\n        require(msg.sender == operator, \"!auth\");\n        uint256 amount = balanceOfPool(_gauge).add(IERC20(_token).balanceOf(address(this)));\n        withdraw(_token, _gauge, amount);\n        return true;\n    }\n```\n\n### Recommended Mitigation Steps\n\nThis issue may be mitigated removing the ability for the `owner` to change the operator in `VoterProxy`.\n\nIf the functionality is require ensure it is behind a time lock and multisig / dao.\n\n**[jetbrain10 (veToken Finance) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/82#issuecomment-1156665133):**\n > Admin will be controlled by DAO and muti-sig wallet.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/82#issuecomment-1196155412):**\n > The warden has shown how, due to a couple of permissioned functions, funds may be swept out of the `VoterProxy`.\n> \n> Because this is contingent on a malicious admin, I believe Medium severity to be appropriate.\n> \n> For end users I highly recommend making sure that not only the multi-sig is strong (high threshold), but also that is behind a time-lock to ensure you have time to react in case of emergency.\n\n***\n\n## [[M-30] Incorrect deployment parameters](https://github.com/code-423n4/2022-05-vetoken-findings/issues/52)\n_Submitted by Picodes_\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/25_deploy_angle_pools.js#L68>\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/migrations/25_deploy_angle_pools.js#L80>\n\n### Impact\n\nThe address of G-Uni tokens in the deployment scripts are not up to date.\n\n### Proof of Concept\n\nFor example for agEUR/USDC it is 0xedecb43233549c51cc3268b5de840239787ad56c and not 0x2bD9F7974Bc0E4Cb19B8813F8Be6034F3E772add.\n\n### Recommended Mitigation Steps\n\nFor safety why not fetching directly the LP token from the staking contract?\n\n**[jetbrain10 (veToken Finance) confirmed](https://github.com/code-423n4/2022-05-vetoken-findings/issues/52)** \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/52#issuecomment-1200279065):**\n> The warden has shown how a configuration file shows that the settings for the project are using an old address.\n> \n> While the finding pertains to a setup script (generally out of scope), given that:\n> - The sponsor has confirmed\n> - The finding is valid in that using older deployments will cause at the very least a loss of yield\n> - We already had an instance of bringing an out-of-scope file into scope via Sponsor-Confirming (See: [#209](https://github.com/code-423n4/2022-05-vetoken-findings/issues/209))\n> \n> With the information I have, I believe the finding to be of Medium Severity and believe the sponsor will mitigate by updating to the Warden suggested addresses.\n\n\n***\n\n\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 51 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-05-vetoken-findings/issues/183) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [kirk-baird](https://github.com/code-423n4/2022-05-vetoken-findings/issues/132), [reassor](https://github.com/code-423n4/2022-05-vetoken-findings/issues/259), [WatchPug](https://github.com/code-423n4/2022-05-vetoken-findings/issues/159), [cryptphi](https://github.com/code-423n4/2022-05-vetoken-findings/issues/122), [minhquanym](https://github.com/code-423n4/2022-05-vetoken-findings/issues/186), [SmartSek](https://github.com/code-423n4/2022-05-vetoken-findings/issues/75), [pauliax](https://github.com/code-423n4/2022-05-vetoken-findings/issues/268), [Dravee](https://github.com/code-423n4/2022-05-vetoken-findings/issues/264), [SecureZeroX](https://github.com/code-423n4/2022-05-vetoken-findings/issues/103), [TerrierLover](https://github.com/code-423n4/2022-05-vetoken-findings/issues/130), [sseefried](https://github.com/code-423n4/2022-05-vetoken-findings/issues/118), [xiaoming90](https://github.com/code-423n4/2022-05-vetoken-findings/issues/223), [0xNazgul](https://github.com/code-423n4/2022-05-vetoken-findings/issues/58), [csanuragjain](https://github.com/code-423n4/2022-05-vetoken-findings/issues/17), [horsefacts](https://github.com/code-423n4/2022-05-vetoken-findings/issues/218), [berndartmueller](https://github.com/code-423n4/2022-05-vetoken-findings/issues/125), [dipp](https://github.com/code-423n4/2022-05-vetoken-findings/issues/221), [Hawkeye](https://github.com/code-423n4/2022-05-vetoken-findings/issues/177), [MiloTruck](https://github.com/code-423n4/2022-05-vetoken-findings/issues/139), [sashik_eth](https://github.com/code-423n4/2022-05-vetoken-findings/issues/184), [unforgiven](https://github.com/code-423n4/2022-05-vetoken-findings/issues/231), [hansfriese](https://github.com/code-423n4/2022-05-vetoken-findings/issues/63), [hyh](https://github.com/code-423n4/2022-05-vetoken-findings/issues/39), [robee](https://github.com/code-423n4/2022-05-vetoken-findings/issues/38), [0x29A](https://github.com/code-423n4/2022-05-vetoken-findings/issues/228), [catchup](https://github.com/code-423n4/2022-05-vetoken-findings/issues/134), [ellahi](https://github.com/code-423n4/2022-05-vetoken-findings/issues/241), [FSchmoede](https://github.com/code-423n4/2022-05-vetoken-findings/issues/90), [gzeon](https://github.com/code-423n4/2022-05-vetoken-findings/issues/254), [simon135](https://github.com/code-423n4/2022-05-vetoken-findings/issues/229), [0x1f8b](https://github.com/code-423n4/2022-05-vetoken-findings/issues/9), [0xf15ers](https://github.com/code-423n4/2022-05-vetoken-findings/issues/162), [Deivitto](https://github.com/code-423n4/2022-05-vetoken-findings/issues/269), [Funen](https://github.com/code-423n4/2022-05-vetoken-findings/issues/232), [asutorufos](https://github.com/code-423n4/2022-05-vetoken-findings/issues/42), [BouSalman](https://github.com/code-423n4/2022-05-vetoken-findings/issues/27), [cccz](https://github.com/code-423n4/2022-05-vetoken-findings/issues/115), [cogitoergosumsw](https://github.com/code-423n4/2022-05-vetoken-findings/issues/29), [ElKu](https://github.com/code-423n4/2022-05-vetoken-findings/issues/148), [GimelSec](https://github.com/code-423n4/2022-05-vetoken-findings/issues/193), [shenwilly](https://github.com/code-423n4/2022-05-vetoken-findings/issues/234), [sorrynotsorry](https://github.com/code-423n4/2022-05-vetoken-findings/issues/199), [c3phas](https://github.com/code-423n4/2022-05-vetoken-findings/issues/213), [Picodes](https://github.com/code-423n4/2022-05-vetoken-findings/issues/48), [_Adam](https://github.com/code-423n4/2022-05-vetoken-findings/issues/126), [delfin454000](https://github.com/code-423n4/2022-05-vetoken-findings/issues/175), [oyc_109](https://github.com/code-423n4/2022-05-vetoken-findings/issues/2), [0xDjango](https://github.com/code-423n4/2022-05-vetoken-findings/issues/261), [Chom](https://github.com/code-423n4/2022-05-vetoken-findings/issues/207), and [z3s](https://github.com/code-423n4/2022-05-vetoken-findings/issues/121).*\n\n## Low Risk Issues\n\n|   | Issue                                                                                | Instances |\n| - | :----------------------------------------------------------------------------------- | :-------: |\n| L&#8209;01 | `getAPY()` returns the wrong answer during leap years                                |     1     |\n| L&#8209;02 | Missing checks for `address(0x0)` when assigning values to `address` state variables |     26    |\n\nTotal: 27 instances over 2 issues\n\n## [L-01] `getAPY()` returns the wrong answer during leap years\n\nThere are more blocks in a year during a leap year. Using a static value for the number of blocks in a year will eventually lead to the wrong answer\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/BaseRewardPool.sol   \\#1\n\n343      function getAPY() external view returns (uint256) {\n344          return rewardRate.mul(BLOCKS_PER_YEAR).mul(1e18).div(totalSupply());\n345:     }\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L343-L345>\n\n## [L-02] Missing checks for `address(0x0)` when assigning values to `address` state variables\n\n*There are 26 instances of this issue. (For in-depth details on this and all further low & non-critical issues with multiple instances, see the warden's [full report](https://github.com/code-423n4/2022-05-vetoken-findings/issues/183).*\n\n\n## Non-critical Issues\n\n|    | Issue                                                                                                                             | Instances |\n| -- | :-------------------------------------------------------------------------------------------------------------------------------- | :-------: |\n| N&#8209;01  | Adding a `return` statement when the function defines a named return variable, is redundant                                       |     1     |\n| N&#8209;02  | `public` functions not called by the contract should be declared `external` instead                                               |     8     |\n| N&#8209;03  | `constant`s should be defined rather than using magic numbers                                                                     |     10    |\n| N&#8209;04  | Numeric values having to do with time should use time units for readability                                                       |     1     |\n| N&#8209;05  | Large multiples of ten should use scientific notation (e.g. `1e6`) rather than decimal literals (e.g. `1000000`), for readability |     1     |\n| N&#8209;06  | Missing event for critical parameter change                                                                                       |     5     |\n| N&#8209;07  | Use a more recent version of solidity                                                                                             |     6     |\n| N&#8209;08  | Constant redefined elsewhere                                                                                                      |     10    |\n| N&#8209;09  | Inconsistent spacing in comments                                                                                                  |     17    |\n| N&#8209;10 | Typos                                                                                                                             |     8     |\n| N&#8209;11 | File is missing NatSpec                                                                                                           |     3     |\n| N&#8209;12 | NatSpec is incomplete                                                                                                             |     1     |\n| N&#8209;13 | Avoid the use of sensitive terms                                                                                      |     1   |\n| N&#8209;14 | `safeApprove()` is deprecated                                                                               |     12   |\n\nTotal: 84 instances over 14 issues\n\n## [N-01] Adding a `return` statement when the function defines a named return variable, is redundant\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/VoterProxy.sol   \\#1\n\n119:          return balance;\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L119>\n\n## [N-02] `public` functions not called by the contract should be declared `external` instead\n\nContracts [are allowed](https://docs.soliditylang.org/en/latest/contracts.html#function-overriding) to override their parents' functions and change the visibility from `external` to `public`.\n\n*There are 8 instances of this issue.*\n\n## [N-03] `constant`s should be defined rather than using magic numbers\n\n*There are 10 instances of this issue.*\n\n## [N-04] Numeric values having to do with time should use time units for readability\n\nThere are [units](https://docs.soliditylang.org/en/latest/units-and-global-variables.html#time-units) for seconds, minutes, hours, days, and weeks\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/VeAssetDepositor.sol   \\#1\n\n/// @audit 86400\n18:       uint256 private constant WEEK = 7 * 86400;\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeAssetDepositor.sol#L18>\n\n## [N-05] Large multiples of ten should use scientific notation (e.g. `1e6`) rather than decimal literals (e.g. `1000000`), for readability\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/VeTokenMinter.sol   \\#1\n\n15:       uint256 public constant maxSupply = 30 * 1000000 * 1e18; //30mil\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L15>\n\n## [N-06] Missing event for critical parameter change\n\n*There are 5 instances of this issue.*\n\n## [N-07] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.13 to get the ability to use `using for` with a list of free functions\n\n*There are 6 instances of this issue.*\n\n## [N-08] Constant redefined elsewhere\n\nConsider defining in only one contract so that values cannot become out of sync when only one location is updated. A [cheap way](https://medium.com/coinmonks/gas-cost-of-solidity-library-functions-dbe0cedd4678) to store constants in a single location is to create an `internal constant` in a `library`. If the variable is a local cache of another contract's value, consider making the cache variable internal or private, which will require external users to query the contract with the source of truth, so that callers don't get out of sync.\n\n*There are 10 instances of this issue.*\n\n## [N-09] Inconsistent spacing in comments\n\nSome lines use `// x` and some use `//x`. The instances below point out the usages that don't follow the majority, within each file\n\n*There are 17 instances of this issue.*\n\n## [N-10] Typos\n\n*There are 8 instances of this issue.*\n\n## [N-11] File is missing NatSpec\n\n*There are 3 instances of this issue.*\n\n## [N-12] NatSpec is incomplete\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/VoterProxy.sol   \\#1\n\n/// @audit Missing: '@param bytes'\n191       /**\n192        * @notice  Verifies that the hash is valid\n193        * @dev     Snapshot Hub will call this function when a vote is submitted using\n194        *          snapshot.js on behalf of this contract. Snapshot Hub will call this\n195        *          function with the hash and the signature of the vote that was cast.\n196        * @param _hash Hash of the message that was sent to Snapshot Hub to cast a vote\n197        * @return EIP1271 magic value if the signature is value\n198        */\n199:      function isValidSignature(bytes32 _hash, bytes memory) public view returns (bytes4) {\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VoterProxy.sol#L191-L199>\n\n## [N-13] Avoid the use of sensitive terms\n\nUse [alternative variants](https://www.zdnet.com/article/mysql-drops-master-slave-and-blacklist-whitelist-terminology/), e.g. allowlist/denylist instead of whitelist/blacklist\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/VE3DRewardPool.sol   \\#1\n204:         //fees dont apply until whitelist+veVeAsset lock begins so will report\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VE3DRewardPool.sol#L204>\n\n\t\n## [N-14] `safeApprove()` is deprecated\n\n[Deprecated](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/bfff03c0d2a59bcd8e2ead1da9aed9edf0080d05/contracts/token/ERC20/utils/SafeERC20.sol#L38-L45) in favor of `safeIncreaseAllowance()` and `safeDecreaseAllowance()`. If only setting the initial allowance to the value that means infinite, `safeIncreaseAllowance()` can be used instead\n\n*There are 12 instances of this issue.*\n\n**[jetbrain10 (veToken Finance) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/183#issuecomment-1156948705):**\n > High quality.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/183#issuecomment-1179581972):**\n > 2L, 5R, 7NC\n\n >*(Note: See [original submission](https://github.com/code-423n4/2022-05-vetoken-findings/issues/183) for judge's full commentary.)*\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 48 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-05-vetoken-findings/issues/181) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [0x1f8b](https://github.com/code-423n4/2022-05-vetoken-findings/issues/8), [MiloTruck](https://github.com/code-423n4/2022-05-vetoken-findings/issues/138), [sashik_eth](https://github.com/code-423n4/2022-05-vetoken-findings/issues/182), [_Adam](https://github.com/code-423n4/2022-05-vetoken-findings/issues/129), [Funen](https://github.com/code-423n4/2022-05-vetoken-findings/issues/230), [Tomio](https://github.com/code-423n4/2022-05-vetoken-findings/issues/153), [jonatascm](https://github.com/code-423n4/2022-05-vetoken-findings/issues/65), [robee](https://github.com/code-423n4/2022-05-vetoken-findings/issues/37), [cogitoergosumsw](https://github.com/code-423n4/2022-05-vetoken-findings/issues/30), [SecureZeroX](https://github.com/code-423n4/2022-05-vetoken-findings/issues/104), [WatchPug](https://github.com/code-423n4/2022-05-vetoken-findings/issues/158), [SmartSek](https://github.com/code-423n4/2022-05-vetoken-findings/issues/76), [catchup](https://github.com/code-423n4/2022-05-vetoken-findings/issues/135), [fatherOfBlocks](https://github.com/code-423n4/2022-05-vetoken-findings/issues/33), [FSchmoede](https://github.com/code-423n4/2022-05-vetoken-findings/issues/91), [0x29A](https://github.com/code-423n4/2022-05-vetoken-findings/issues/114), [0xKitsune](https://github.com/code-423n4/2022-05-vetoken-findings/issues/59), [Dravee](https://github.com/code-423n4/2022-05-vetoken-findings/issues/167), [gzeon](https://github.com/code-423n4/2022-05-vetoken-findings/issues/248), [GalloDaSballo](https://github.com/code-423n4/2022-05-vetoken-findings/issues/109), [horsefacts](https://github.com/code-423n4/2022-05-vetoken-findings/issues/219), [0xf15ers](https://github.com/code-423n4/2022-05-vetoken-findings/issues/163), [0xNazgul](https://github.com/code-423n4/2022-05-vetoken-findings/issues/57), [c3phas](https://github.com/code-423n4/2022-05-vetoken-findings/issues/208), [delfin454000](https://github.com/code-423n4/2022-05-vetoken-findings/issues/173), [Kaiziron](https://github.com/code-423n4/2022-05-vetoken-findings/issues/113), [simon135](https://github.com/code-423n4/2022-05-vetoken-findings/issues/171), [TomJ](https://github.com/code-423n4/2022-05-vetoken-findings/issues/86), [0xkatana](https://github.com/code-423n4/2022-05-vetoken-findings/issues/41), [asutorufos](https://github.com/code-423n4/2022-05-vetoken-findings/issues/43), [Cityscape](https://github.com/code-423n4/2022-05-vetoken-findings/issues/178), [ElKu](https://github.com/code-423n4/2022-05-vetoken-findings/issues/147), [ellahi](https://github.com/code-423n4/2022-05-vetoken-findings/issues/240), [hansfriese](https://github.com/code-423n4/2022-05-vetoken-findings/issues/64), [minhquanym](https://github.com/code-423n4/2022-05-vetoken-findings/issues/180), [oyc_109](https://github.com/code-423n4/2022-05-vetoken-findings/issues/1), [pauliax](https://github.com/code-423n4/2022-05-vetoken-findings/issues/271), [Randyyy](https://github.com/code-423n4/2022-05-vetoken-findings/issues/272), [reassor](https://github.com/code-423n4/2022-05-vetoken-findings/issues/251), [RoiEvenHaim](https://github.com/code-423n4/2022-05-vetoken-findings/issues/169), [sach1r0](https://github.com/code-423n4/2022-05-vetoken-findings/issues/40), [saian](https://github.com/code-423n4/2022-05-vetoken-findings/issues/174), [TerrierLover](https://github.com/code-423n4/2022-05-vetoken-findings/issues/131), [Waze](https://github.com/code-423n4/2022-05-vetoken-findings/issues/146), [z3s](https://github.com/code-423n4/2022-05-vetoken-findings/issues/119), [Hawkeye](https://github.com/code-423n4/2022-05-vetoken-findings/issues/111), and [Ruhum](https://github.com/code-423n4/2022-05-vetoken-findings/issues/61).*\n\n## Summary\n\n|    | Issue                                                                                                                                                      | Instances |\n| -- | :--------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------: |\n| G&#8209;01  | Update to state var should only happen once in a function                                                                                                  |     1     |\n| G&#8209;02  | Multiple `address` mappings can be combined into a single `mapping` of an `address` to a `struct`, where appropriate                                       |     1     |\n| G&#8209;03  | State variables only set in the constructor should be declared `immutable`                                                                                 |     11    |\n| G&#8209;04  | Avoid contract existence checks by using solidity version 0.8.10 or later                                                                                  |    124    |\n| G&#8209;05  | State variables should be cached in stack variables rather than re-reading them from storage                                                               |     39    |\n| G&#8209;06  | Multiple accesses of a mapping/array should use a local variable cache                                                                                     |     30    |\n| G&#8209;07  | `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables                                                                                     |     3     |\n| G&#8209;08  | `internal` functions only called once can be inlined to save gas                                                                                           |     2     |\n| G&#8209;09  | `<array>.length` should not be looked up in every loop of a `for`-loop                                                                                     |     7     |\n| G&#8209;10 | `++i`/`i++` should be `unchecked{++i}`/`unchecked{i++}` when it is not possible for them to overflow, as is the case when used in `for`- and `while`-loops |     13    |\n| G&#8209;11 | `keccak256()` should only need to be called on a specific string literal once                                                                              |     1     |\n| G&#8209;12 | Using `bool`s for storage incurs overhead                                                                                                                  |     5     |\n| G&#8209;13 | Using `> 0` costs more gas than `!= 0` when used on a `uint` in a `require()` statement                                                                    |     7     |\n| G&#8209;14 | It costs more gas to initialize variables to zero than to let the default of zero be applied                                                               |     14    |\n| G&#8209;15 | `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)                                                                |     13    |\n| G&#8209;16 | Splitting `require()` statements that use `&&` saves gas                                                                                                   |     2     |\n| G&#8209;17 | Using `private` rather than `public` for constants, saves gas                                                                                              |     9     |\n| G&#8209;18 | Don't compare boolean expressions to boolean literals                                                                                                      |     7     |\n| G&#8209;19 | Don't use `SafeMath` once the solidity version is 0.8.0 or greater                                                                                         |     6     |\n| G&#8209;20 | Duplicated `require()`/`revert()` checks should be refactored to a modifier or function                                                                    |     15    |\n| G&#8209;21 | `require()` or `revert()` statements that check input arguments should be at the top of the function                                                       |     2     |\n| G&#8209;22 | Empty blocks should be removed or emit something                                                                                                           |     3     |\n| G&#8209;23 | Use custom errors rather than `revert()`/`require()` strings to save deployment gas                                                                        |     67    |\n| G&#8209;24 | Functions guaranteed to revert when called by normal users can be marked `payable`                                                                         |     7     |\n| G&#8209;25 | Don't use `_msgSender()` if not supporting EIP-2771                                                                                                        |     2     |\n\nTotal: 391 instances over 25 issues\n\n## [G-01] Update to state var should only happen once in a function\n\nThe assignment of `totalWeight` can be optimized by summing the old and new weights\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/VeTokenMinter.sol   \\#1\n\n43           totalWeight -= veAssetWeights[veAssetOperator];\n44           veAssetWeights[veAssetOperator] = newWeight;\n45:          totalWeight += newWeight;\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/VeTokenMinter.sol#L43-L45>\n\n## [G-02] Multiple `address` mappings can be combined into a single `mapping` of an `address` to a `struct`, where appropriate\n\nSaves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (**20000 gas**) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save **\\~42 gas per access** due to not having to recalculate the key's keccak256 hash (Gkeccak256 - **30 gas**) and that calculation's associated stack operations.\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/BaseRewardPool.sol   \\#1\n\n75        mapping(address => uint256) public userRewardPerTokenPaid;\n76        mapping(address => uint256) public rewards;\n77:       mapping(address => uint256) private _balances;\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/BaseRewardPool.sol#L75-L77>\n\n## [G-03] State variables only set in the constructor should be declared `immutable`\n\nAvoids a Gsset (**20000 gas**) in the constructor, and replaces each Gwarmacces (**100 gas**) with a `PUSH32` (**3 gas**).\n\n*There are 11 instances of this issue. (For in-depth details on this and all further gas optimizations with multiple instances, see the warden's [full report](https://github.com/code-423n4/2022-05-vetoken-findings/issues/181).)*\n\n\n## [G-04] Avoid contract existence checks by using solidity version 0.8.10 or later\n\nPrior to 0.8.10 the compiler inserted extra code, including `EXTCODESIZE` (**700 gas**), to check for contract existence for external calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value\n\n*There are 124 instances of this issue.*\n\n## [G-05] State variables should be cached in stack variables rather than re-reading them from storage\n\nThe instances below point to the second+ access of a state variable within a function. Caching of a state variable replace each Gwarmaccess (**100 gas**) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.\n\n*There are 39 instances of this issue.*\n\n## [G-06] Multiple accesses of a mapping/array should use a local variable cache\n\nThe instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping's value in a local `storage` variable when the value is accessed [multiple times](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0), saves **\\~42 gas per access** due to not having to recalculate the key's keccak256 hash (Gkeccak256 - **30 gas**) and that calculation's associated stack operations. Caching an array's struct avoids recalculating the array offsets into memory\n\n*There are 30 instances of this issue.*\n\n## [G-07] `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables\n\n*There are 3 instances of this issue.*\n\n## [G-08] `internal` functions only called once can be inlined to save gas\n\nNot inlining costs **20 to 40 gas** because of two extra `JUMP` instructions and additional stack operations needed for function calls.\n\n*There are 2 instances of this issue.*\n\n## [G-09] `<array>.length` should not be looked up in every loop of a `for`-loop\n\nThe overheads outlined below are *PER LOOP*, excluding the first loop\n\n*   storage arrays incur a Gwarmaccess (**100 gas**)\n*   memory arrays use `MLOAD` (**3 gas**)\n*   calldata arrays use `CALLDATALOAD` (**3 gas**)\n\nCaching the length changes each of these to a `DUP<N>` (**3 gas**), and gets rid of the extra `DUP<N>` needed to store the stack offset\n\n*There are 7 instances of this issue.*\n\n## [G-10] `++i`/`i++` should be `unchecked{++i}`/`unchecked{i++}` when it is not possible for them to overflow, as is the case when used in `for`- and `while`-loops\n\nThe `unchecked` keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves **30-40 gas [per loop](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked)**\n\n*There are 13 instances of this issue.*\n\n## [G-11] `keccak256()` should only need to be called on a specific string literal once\n\nIt should be saved to an immutable variable, and the variable used instead. If the hash is being used as a part of a function selector, the cast to `bytes4` should also only be done once\n\n*There is 1 instance of this issue:*\n\n```\nFile: contracts/Booster.sol   \\#1\n\n488:              bytes4(keccak256(\"set_rewards_receiver(address)\")),\n```\n\n<https://github.com/code-423n4/2022-05-vetoken/blob/2d7cd1f6780a9bcc8387dea8fecfbd758462c152/contracts/Booster.sol#L488>\n\n## [G-12] Using `bool`s for storage incurs overhead\n\n```\n    // Booleans are more expensive than uint256 or any type that takes up a full\n    // word because each write operation emits an extra SLOAD to first read the\n    // slot's contents, replace the bits taken up by the boolean, and then write\n    // back. This is the compiler's defense against contract upgrades and\n    // pointer aliasing, and it cannot be disabled.\n```\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27><br>\nUse `uint256(1)` and `uint256(2)` for true/false to avoid a Gwarmaccess (**[100 gas](https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058)**), and to avoid Gsset (**20000 gas**) when changing from 'false' to 'true', after having been 'true' in the past\n\n*There are 5 instances of this issue.*\n\n## [G-13] Using `> 0` costs more gas than `!= 0` when used on a `uint` in a `require()` statement\n\nThis change saves **[6 gas](https://aws1.discourse-cdn.com/business6/uploads/zeppelin/original/2X/3/363a367d6d68851f27d2679d10706cd16d788b96.png)** per instance\n\n*There are 7 instances of this issue.*\n\n## [G-14] It costs more gas to initialize variables to zero than to let the default of zero be applied\n\n*There are 14 instances of this issue.*\n\n## [G-15] `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)\n\nSaves **6 gas per loop**\n\n*There are 13 instances of this issue.*\n\n## [G-16] Splitting `require()` statements that use `&&` saves gas\n\nSee [this issue](https://github.com/code-423n4/2022-01-xdefi-findings/issues/128) which describes the fact that there is a larger deployment gas cost, but with enough runtime calls, the change ends up being cheaper\n\n*There are 2 instances of this issue.*\n\n## [G-17] Using `private` rather than `public` for constants, saves gas\n\nIf needed, the value can be read from the verified contract source code. Savings are due to the compiler not having to create non-payable getter functions for deployment calldata, and not adding another entry to the method ID table\n\n*There are 9 instances of this issue.*\n\n## [G-18] Don't compare boolean expressions to boolean literals\n\n`if (<x> == true)` => `if (<x>)`, `if (<x> == false)` => `if (!<x>)`\n\n*There are 7 instances of this issue.*\n\n## [G-19] Don't use `SafeMath` once the solidity version is 0.8.0 or greater\n\nVersion 0.8.0 introduces internal overflow checks, so using `SafeMath` is redundant and adds overhead\n\n*There are 6 instances of this issue.*\n\n## [G-20] Duplicated `require()`/`revert()` checks should be refactored to a modifier or function\n\nSaves deployment costs\n\n*There are 15 instances of this issue.*\n\n## [G-21] `require()` or `revert()` statements that check input arguments should be at the top of the function\n\nChecks that involve constants should come before checks that involve state variables\n\n*There are 2 instances of this issue.*\n\n## [G-22] Empty blocks should be removed or emit something\n\nThe code should be refactored such that they no longer exist, or the block should do something useful, such as emitting an event or reverting. If the contract is meant to be extended, the contract should be `abstract` and the function signatures be added without any default implementation. If the block is an empty if-statement block to avoid doing subsequent checks in the else-if/else conditions, the else-if/else conditions should be nested under the negation of the if-statement, because they involve different classes of checks, which may lead to the introduction of errors when the code is later modified (`if(x){}else if(y){...}else{...}` => `if(!x){if(y){...}else{...}}`)\n\n*There are 3 instances of this issue.*\n\n## [G-23] Use custom errors rather than `revert()`/`require()` strings to save deployment gas\n\nCustom errors are available from solidity version 0.8.4. The instances below match or exceed that version\n\n*There are 67 instances of this issue.*\n\n## [G-24] Functions guaranteed to revert when called by normal users can be marked `payable`\n\nIf a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided. The extra opcodes avoided are\n`CALLVALUE`(2),`DUP1`(3),`ISZERO`(3),`PUSH2`(3),`JUMPI`(10),`PUSH1`(3),`DUP1`(3),`REVERT`(0),`JUMPDEST`(1),`POP`(2), which costs an average of about **21 gas per call** to the function, in addition to the extra deployment cost\n\n*There are 7 instances of this issue.*\n\n## [G-25] Don't use `_msgSender()` if not supporting EIP-2771\n\nUse `msg.sender` if the code does not implement [EIP-2771 trusted forwarder](https://eips.ethereum.org/EIPS/eip-2771) support\n\n*There are 2 instances of this issue.*\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2022-05-vetoken-findings/issues/181#issuecomment-1183897399):**\n> Most thorough submission, would like for the warden to add:\n> - Total Gas Saved per finding next to headline\n> - POC for some of the contentious stuff (refactor storage, pack, use bool), because some of the advice while generally sound, requires a refactoring that leverages the concept.\n> \n> Overall best report for the contest\n>\n\n > Total Gas Saved\n> 46633\n\n>*(Note: See [original submission](https://github.com/code-423n4/2022-05-vetoken-findings/issues/181) for judge's full commentary.)*\n\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}