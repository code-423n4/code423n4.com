{
  "circa": {
    "title": "Tracer",
    "sponsor": "Tracer",
    "slug": "2021-06-tracer",
    "date": "2021-09-16",
    "findings": "https://github.com/code-423n4/2021-06-tracer-findings/issues",
    "contest": 16
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code 432n4 (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of the Tracer smart contract system written in Solidity. The code contest took place between June 23—June 30, 2021.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>12 Wardens contributed reports to the Tracer code contest:</p>\n<ul>\n<li><a href=\"https://github.com/0xsanson\">0xsanson</a></li>\n<li><a href=\"https://github.com/x9453\">shw</a></li>\n<li><a href=\"https://twitter.com/0xRajeev\">0xRajeev</a></li>\n<li><a href=\"https://twitter.com/SolidityDev\">pauliax</a></li>\n<li><a href=\"https://twitter.com/gpersoon\">gpersoon</a></li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/a_delamo\">a_delamo</a></li>\n<li><a href=\"https://twitter.com/MukeshJ_eth\">Jmukesh</a></li>\n<li><a href=\"https://github.com/0xsanson\">Lucius</a></li>\n<li><a href=\"https://twitter.com/_smonica_\">s1m0</a></li>\n<li><a href=\"https://twitter.com/Tensors8\">tensors</a></li>\n<li><a href=\"https://twitter.com/_hrkrshnn\">hrkrshnn</a></li>\n</ul>\n<p>This contest was judged by <a href=\"http://twitter.com/cemozer_\">cemozerr</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/_ninek_\">ninek</a> and <a href=\"https://twitter.com/money_lego\">moneylegobatman</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 43 unique vulnerabilities. All of the issues presented here are linked back to their original finding</p>\n<p>Of these vulnerabilities, 6 received a risk rating in the category of HIGH severity, 13 received a risk rating in the category of MEDIUM severity, and 24 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 32 non-critical recommendations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-06-tracer\">C4 Tracer code contest repository</a> is comprised of 44 smart contracts written in the Solidity programming language and includes 2,453 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings\" style=\"position:relative;\"><a href=\"#high-risk-findings\" aria-label=\"high risk findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings</h1>\n<h2 id=\"h-01-wrong-trading-pricing-calculations\" style=\"position:relative;\"><a href=\"#h-01-wrong-trading-pricing-calculations\" aria-label=\"h 01 wrong trading pricing calculations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/119\">[H-01] Wrong trading pricing calculations</a></h2>\n<p><em>Submitted by 0xsanson, also found by shw</em></p>\n<p>In the <code>Pricing</code> contract, an agent can manipulate the trading prices by spamming a high amount of trades.</p>\n<p>Indeed an agent can create a high amount of orders at an arbitrary price and with a near-zero amount (so the agent doesn’t even need large funds); next he/she pairs the orders with another account and calls <code>Trader.executeTrade</code>; now every order calls a <code>Pricing.recordTrade</code> using the arbitrary price set by the agent.</p>\n<p>Since the trades are all made in the same hour, by the way <code>hourlyTracerPrices[currentHour]</code> is calculated, it skews the average price towards the price set by the agent. This arbitrary value is used to calculate the <code>fundingRates</code> and the <code>fairPrice</code>, allowing a malicious agent the ability to manipulate the market.</p>\n<p>Recommend passing the <code>fillAmount</code> parameter to <code>recordTrade(...)</code>, and calculate <code>hourlyTracerPrices[currentHour].trades</code> summing <code>fillAmount</code> instead of 1 every trade.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/119#issuecomment-873747695\">raymogg (Tracer) confirmed</a>:</strong></p>\n<blockquote>\n<p>Issue is valid, and there appear to be a few other issues that reference similar problems.</p>\n<p>The Trader contract will have a whitelist allowing only select relayers to push orders on chain. As long as off chain order books have sufficient liquidity, this issue is then mitigated as users can’t just arbitrarily match orders and send them in, they must be matched on a book with liquidity. To alter the price you would then need to eat through significant liquidity (increasing the cost of this attack).</p>\n</blockquote>\n<h2 id=\"h-02-use-of-incorrect-index-leads-to-incorrect-updation-of-funding-rates\" style=\"position:relative;\"><a href=\"#h-02-use-of-incorrect-index-leads-to-incorrect-updation-of-funding-rates\" aria-label=\"h 02 use of incorrect index leads to incorrect updation of funding rates permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/74\">[H-02] Use of incorrect index leads to incorrect updation of funding rates</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>The <code>updateFundingRate()</code> function updates the funding rate and insurance funding rate. While the instant/new funding rates are calculated correctly, the cumulative funding rate calculation is incorrect because it is always adding the instant to 0, not the previous value. This is due to the use of <code>[currentFundingIndex]</code> which has been updated since the previous call to this function while it should really be using <code>[currentFundingIndex-1]</code> to reference the previous funding rate.</p>\n<p>The impact of this, is that the cumulative funding rate and insurance funding rates are calculated incorrectly without considering the correct previous values. This affects the settling of accounts across the entire protocol. The protocol logic is significantly impacted, accounts will not be settled as expected, protocol shutdown and contracts will need to be redeployed. Users may lose funds and the protocol takes a reputation hit.</p>\n<p>Recommend using <code>[currentFundingIndex-1]</code> for non-zero values of <code>currentFundingIndex</code> to get the value updated in the previous call on lines L155 and L159 of <code>Pricing.sol</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/74#issuecomment-873752562\">raymogg (Tracer) confirmed</a>:</strong></p>\n<blockquote>\n<p>Confirmed as an index issue with funding rate 👍</p>\n</blockquote>\n<h2 id=\"h-03-malicious-owner-can-drain-the-market-at-any-time-using-safetywithdraw\" style=\"position:relative;\"><a href=\"#h-03-malicious-owner-can-drain-the-market-at-any-time-using-safetywithdraw\" aria-label=\"h 03 malicious owner can drain the market at any time using safetywithdraw permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/81\">[H-03] Malicious owner can drain the market at any time using <code>SafetyWithdraw</code></a></h2>\n<p><em>Submitted by 0xRajeev, also found by pauliax and gpersoon</em></p>\n<p>The <code>withdrawERC20Token()</code> in <code>SafetyWithdraw</code> inherited in <code>TracerPerpetualSwaps</code> is presumably a guarded launch emergency withdrawal mechanism. However, given the trust model where the market creator/owner is potentially untrusted/malicious, this is a dangerous approach to emergency withdrawal in the context of guarded launch.</p>\n<p>Alternatively, if this is meant for the owner to withdraw “external” ERC20 tokens mistakenly deposited to the Tracer market, then the function should exclude <code>tracerQuoteToken</code> from being the <code>tokenAddress</code> that can be used as a parameter to <code>withdrawERC20Token()</code>.</p>\n<p>The impact of this is that, if a malicious owner of a market withdraws/rugs all <code>tracerQuoteToken</code>s deposited at any time after market launch, all users lose deposits and the protocol takes a reputational hit and has to refund the users from treasury.</p>\n<p>Therefor, it is recommended that, for a guarded launch circuit breaker, design a pause/unpause feature where deposits are paused (in emergency situations) but withdrawals are allowed by the depositors themselves instead of the owner. Alternatively, if this is meant to be for removing external ERC20 tokens accidentally deposited to market, exclude the <code>tracerQuoteToken</code> from being given as the <code>tokenAddress</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/81#issuecomment-873752133\">raymogg (Tracer) confirmed but suggested a severity of 2 </a>:</strong></p>\n<blockquote>\n<p>The only reason for the dispute on severity is that as part of the security model, the owner can manipulate the market in other ways (such as changing the oracle being used), so this trust assumption over the owner already exists. For this reason the team thinks this issue is closer to a medium</p>\n<p>This however is a good issue as it is not the greatest circuit breaking mechanism, and as noted in #7 can reflect badly on the project without the exploit being used. The mechanism is being removed and replaced with more structured circuit breaker.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/81#issuecomment-882110087\">cemozerr (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Marking this as high risk, as regardless of the owner manipulating in other ways, the threat persists.</p>\n</blockquote>\n<h2 id=\"h-04-logic-error-in-fee-subtraction\" style=\"position:relative;\"><a href=\"#h-04-logic-error-in-fee-subtraction\" aria-label=\"h 04 logic error in fee subtraction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/127\">[H-04] Logic error in fee subtraction</a></h2>\n<p><em>Submitted by 0xsanson</em></p>\n<p>In <code>LibBalances.applyTrade()</code>, we need to collect a fee from the trade. However, the current code subtracts a fee from the short position and adds it to the long. The correct implementation is to subtract a fee to both (see <code>TracerPerpetualSwaps.sol</code> L272).\nThis issue causes withdrawals problems, since Tracer thinks it can withdraw the collect fees, leaving the users with an incorrect amount of quote tokens.</p>\n<p>Recommend changing <code>+fee</code> to <code>-fee</code> in the <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibBalances.sol#L187\">highlighted line</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/127#issuecomment-873778933\">raymogg (Tracer) confirmed</a>:</strong></p>\n<blockquote>\n<p>Valid issue 👍</p>\n</blockquote>\n<h2 id=\"h-05-insurance-slippage-reimbursement-can-be-used-to-steal-insurance-fund\" style=\"position:relative;\"><a href=\"#h-05-insurance-slippage-reimbursement-can-be-used-to-steal-insurance-fund\" aria-label=\"h 05 insurance slippage reimbursement can be used to steal insurance fund permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/105\">[H-05] Insurance slippage reimbursement can be used to steal insurance fund</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>Liquidation</code> contract allows the liquidator to submit “bad” trade orders and the insurance reimburses them from the insurance fund, see <code>Liquidation.claimReceipt</code>.\nThe function can be called with an <code>orders</code> array, which does not check for duplicate orders.\nAn attacker can abuse this to make a profit by liquidating themselves, making a small bad trade and repeatedly submitting this bad trade for slippage reimbursement.</p>\n<p><strong>Example</strong>:</p>\n<ul>\n<li>Attacker uses two accounts, one as the liquidator and one as the liquidatee.</li>\n<li>They run some high-leverage trades such that the liquidatee gets liquidated with the next price update. (If not cash out and make a profit this way through trading, and try again.)</li>\n<li>Liquidator liquidates liquidatee</li>\n<li>\n<p>They now do two trades:</p>\n<ul>\n<li>One “good” trade at the market price that fills 99% of the liquidation amount. The slippage protection should not kick in for this trade</li>\n<li>One “bad” trade at a horrible market price that fills only 1% of the liquidation amount. This way the slippage protection kicks in for this trade</li>\n</ul>\n</li>\n<li>The liquidator now calls <code>claimReceipt(orders)</code> where <code>orders</code> is an array that contains many duplicates of the “bad” trade, for example 100 times. The <code>calcUnitsSold</code> function will return <code>unitsSold = receipt.amountLiquidated</code> and a bad <code>avgPrice</code>. They are now reimbursed the price difference on the full liquidation amount (instead of only on 1% of it) making an overall profit</li>\n</ul>\n<p>This can be repeated until the insurance fund is drained.</p>\n<p>The attacker has an incentive to do this attack as it’s profitable and the insurance fund will be completely drained.</p>\n<p>Recommend disallowing duplicate orders in the <code>orders</code> argument of <code>claimReceipt</code>. This should make the attack at least unprofitable, but it could still be a griefing attack.\nA quick way to ensure that <code>orders</code> does not contain duplicates is by having liquidators submit the orders in a sorted way (by order ID) and then checking in the <code>calcUnitsSold</code> <code>for</code> loop that the current order ID is strictly greater than the previous one.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/105#issuecomment-873780483\">BenjaminPatch (Tracer) confirmed</a>:</strong></p>\n<blockquote>\n<p>Valid issue. The recommended mitigation step would also work. <img class=\"emoji-icon\" alt=\"emoji-+1\" data-icon=\"emoji-+1\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAATiElEQVR4Ae2bBYwdx/bmfwVNFwdthwzhZJmZmZmZmZmZmVe4zLx/ZmYOZzf04rzYw5f6dnd1wU6qW6OR5dGztc+W3sv75KPLPXW+OvDVaZnP4XP4HD7WEDxk/J6f8fRkOxv/8+Fk8yclw8FWXhRaCEFT1YemWn9tXa7/AfC1D42Av/xLfyQPE9Vq8Xs3Ll36BzuXrzDZ2qQoClASUzWUyyVHB/t2eXTyJ4G/xUNAZP9hohgMf9bmzjbbl3fZ3NoiHRZoqWgbQ1mOyYpCH2j9N49v3/LA33ngBBAsDwsns/eGu1ee/96TyZTpxoTJxpRsawxCEKwjm+UkWiG8w9T1Xzu8fesrge96oATUdc3DQqKvPFbkxcZgWDAoBuTTASpP+g8VSm9ACJjaUK3KZLVY/nHglz1QAvLBiIeF2Xz9SJ4mRZImJFpHU1oREITgUVoymAyp12vGGxOGw8HPurX/4VXg/QdGwKKc8bAgSDaV1kJJidSnpiQIEABIIKDzhDzPKIYFo/FomB6oH/lACUiF4mFhrRgKKVFSIYUEBAGBFAII+BBQiSbNUtIkI80zhM5+MPAfH1wX0BkPC21Zp0oKEBJCQIgAAiSA6N+XASklWouYIsG56zxA6OAcDwN/6X99p/h9P+XFtG+7XNR9RR8RUiqUlOD95C993ndLwD8QAk4XxkOCQPT5RuBTIgQCAY9XgHpQBEgeIkIIng59CAgI4a7iPASPawxt07qzdX6GEyBCEE5IiZC944SzXAiRE4HwAe8stm1pqjWNaReA+GwgAJ3lRqkut4VSRDICvfOgpSA0FmtamnJFuVywrtu9B0mA5iFCal3qNEWprg0KRIyGSAjgK4tdlzSrJeXJCeViybJu3gXCZwMBQSepzrMcpZOu67UOrTQyOHzbYsuKar5gdXzE/OiQ5aoM89q++VlBwM94+unk+uXp780GBTrVKBkIVUMwDTYEnDFRApezExanzq8WC5ZVs/fyh8vXAf8ZT8CP+iGXf8fp8fdH5EVBqjVCKoIE7xzOWUxdUS3nrOezOBeoqob5uv2GDxbN8jOegL/0S37ojUu7O39uvDGlGAyi1NVKoZSMoieIAEi885jY+gxV3ZRvH5b/FmgB9xlNwGA4+hub29sb48mEvMhJ04R4IEIglECJBJ0miEQDYNqWsjG3vvW92Ws9AXzGtsG/8st/5M/aubz7S6ZbmwzHI7JBRpIkSK0QH5nqTCYJOsnicx8C1nk1mWQeMJ+xBPyBX/Ijio3tzb+2tbvLR+E/GBbkOu36v9KIXvL6AEFIgtIIlUBskSwPFs38jIDPxBR4dDj83afDz+8z3txgOByQJSkqS7vdd5ZeHiN6VRghJUKA9+H93vnwGUnAX/1VP+bF3cu7f2prZ5vxaEwxHKKnI4SK6q8jIIRo4SNzHuE9eAvBs27tNwMW4DOOgD//83/8xval7X+7++iV6XgSR1vo8bCbAkkZ9f6Z/g8QvMPZNhrW4r31X//W8ecB/uyav/XnDLayfKgSlRNcBiCDsjWmaU0dxNIugfK+Cfhbv+an8unE+4fvZJceG/+bRx5//AdMNzYZjYYkgwytBVKAEADibPdd8HhvoxL01Zp2XWLL6uSHXp889Wt+wovf54kXvs8PVFn2I53zN4QQUylFghAKH+I/75wLzgQzMWVdVfvNunrTNM2XtPPV5wE3P/WNkZ/3Q/h0YvropX/zxFNP/ertnS0mkyHD8YR0MkAlAoWMBZDWI9Y1zlucc9hqTb2cM9/f54P/+warsubR7/X9GV1+DIeIXSGyJxVCilgzBALvPd46grW0tsU0NVW5Zjmbcbx/4E4f/+XRK/PfBTRcAL336glwMbZfmA7yafGMUMmOkLIIjS2rqjw4qmfvAwvO4bnrz/zDq88+86unGxuMxyOK0YhkUiCVQAYJEvAC2haPBwLBttimxqxKlkeHyAA/8Kf8DLKtbawPuETjBCAEge5RABLiYwyDdYO3La0xmKpmOChIUq0E4Te1z9aP/Z8vfPVnXySm9O233uJuuPZTv+9wc2v0R4rR5FcNJ9Nr+SBLlFQxX01Tm+3lcn+2f/CdH3xw+3+Xy/oLf8yP/yG/++oLL/6eycY05nwxGca7PkrI/rQnEF6AMYi2xQdw1uJbi61r6tWc1f4eO089w2RnGy8EejKi1SJGydmxOXIg+scuMChyKCus0TRaxzrjXEtTlizms59+7Sdc/8HAt9yVgNMP4U4k1XBra/w/Nq9c+Sk7l3YZjsdkWRYvHEIMu9S25vH2Rvn4jSf3f265Wh8+8/2+785oOiXLs7jz6ShHJ4oz520AU4NznfS1ntCfA2zbYMo1pqni7wkepVKkUKRagk7wIhCEAPpsAAJ9RAULqcaJgAye4FOaPKWI9x8UIcgfcCEBIUjuxGT4xO/f2N35KZcfvcLpASYquDTPkZKznHOn1lYFG9Mxo+nGjkwzsjQhGQ7Qo6yTukL0Ow/Ytnde4J0lnJqzbcz/drWMEVCWK1xdg2kQAVStEFYhleq97q4XpKBTTyE++tac1QklQAcX/55wH5mjcSHhAujGBc7Dq8Ho0mj4W7d2dtna3mJjc5N8a0ySJmfKLTQWXze4IsVbi0wzEqVQRYEa5QjZT3YR0RHaNloAfGxzPj626zXV7Jj5/m3mh0ccL2vefPU1ti/tIgcjvGmiRI5yGRlDv18E9AhBxLT03sUZojU1zXxOu5hRn5qpK/bn6/cuJOD0Q87jxesbP/C0iF2dbIwZDocUm2OSYYoU3Y4qIOQ5aI2vJc57tNYInSAGGUL3Qie2PAnGcea89x2B1mGbino+Z3H7Fif7e9w6PDq1Oa+/t0e7XvHs88+STTbIhkPSNEOmXfdDhI6IIGJHCfF6tpsjGkNTlSwXS2Z7h5HUvZPVl3zBS3vfVsJdR+v6P7+0x3n8+aef+NHD0ZCiKE4tI81TpFRoKQn01VcEGOcICc46RJJAmiB0398FiBimgHeIqPcDoat8eNtgypJqfszi+Ii9vUPKdc2P+6k/kWe+9/fFtw2H777FzddfYb1axRQIyHhprVVck1YpoY8GAhHWWuqqZtU0HM7X3J7V7K/dJ4oBslzfqxKU8sU0y0jSFJ0kCN3P7/rKS09CLEjDAtUGSPrQ7POwey7A+k7ZAcF7grdd4Tur/AvK1SqS+HN+za/h6gvfm9ZagpDsPv0MN2YzyuNDVscn1OUSs17T1BWNaXCm23HbGlwIHcku0OJQOuXy5SHblwTXavNbH9uZbAO/+K4E/N4f+yQ9+Idf+45I0+x6kiQoLXvnuQABJJCd2wVBB88ZIcJ7fL/A4MH5bv7nWhOJKFdLrj3/PI888xxlWSIGBeQpQqYU0ynD69e4HEJXA/CEvnsI56KQCm13Pe9aXF+cTWNYrUoOD464efMmi/rdX8gF0ONRzjmoROsrWmuUUF0Vj0ZEnwI9+mi/6JDt+y/08CIAHhEjIcSPXHCxLmzt7mCdB6UhS2iFJ7gAwhPo9TMOKUEmEqE1AoUSOSCQjUXUdWyBwrR4XaGcQGVrdJqRaC0uJCDR+g4C5IbsZ/d92J+3M0R3zvkr7hIgONflPh7hIDiPc30qBB+LmlYy1pgQIyR+L/5tJ0IfWf7scsGBwyPoNkWEjiDhLbhu930fBW2Miu61D/AXP++l5G7TJf3n//dLnIMUUqdS9n+gu4sTiTgPf5cND3c6H0K3YiHA0aUBoV80SKnjZCjLCxbzE4IxHQmrNTJPIimoc7SL89ftzXnEqXlrYlRFXWFMbH22LqlWS+pyRV3XDrg7AXf6opRIzjscPCh119t36L7WhTOnObfYKH2j4wQA1yu/uPjYLtPBiMn2NsefvMnJhzfZuPIozlQIa/rUk2eeI2UvpPpu0kVMz7ONOsCaBrOuqdYlq6NjVseHLE9mrNbmJUDdSxcQcUwpOJf7F+S56EQIbQAl+hwJAH0HsF0EIAihX6j3CGxPSkBpzWg8YT1f8O1f+sU8/twLXLp6lWI0RiVpF3lSxqghhF5H+L6jBPAWHzzeGJxpT62hrkpWixUnpwR88OG+v7m/+M7vuHnyJwHuiYBAkCHQe0i0u0OAcVBVoDsdgJIgAB/ARkf7qPVdjgYfhVOI5ASg0/dpUbB/cJPv+Yav4/H3HkFKGcNOCBGdtq4TW611WOtibjsP4GnqlrVpEB6scywqw7oNLBrLQdnYNw/rv/naQfUO4O91IiQAQr9LZ7IuANwR4k0TT10yFi9LSNKOBNc5jABcP/KiD1l3Fg2dfHWOpq5J8pQf97N+STxIrWYzmuWSajWPJzrTtLRNg+h1BAgkAR8ESZYwTnTsWCHAaOKoG8e6dWxXJs3S5Y87JeAbgfaeCAg+hLhQESDmK3eJBIEwXbW1xsXWJIVHtYbgJPQ7H9sdHrzHO87PAKNFEtqWqqyYbm6ze/1JUAnTq08isxQInZL0cNYlvAcRoD8DCHwUUjiHiVK4iuF/64MP+MQ777O0H16C/RIw90SAc9Z571RwPoZaJEHHngMekAJi7tuuEJuaECwyyXFJN63B+y584xd6EXTOCL6Xxg7fR4LWCbaqILEAOCURiYZUw5kK7ciF/jTY2kgQwuLlqXmB1R6nEjya1nucdy1Q32sNwFvXeufSmLe+cyYQEE4Q4QKYlmBbCI7W1EijkGOFkoKAR8aRnTvb7UhEbz1iyEbHREBqHSVxs5xBNohhrowBrekagQJxTm67bk30ZLuuFcbdXy9XrI4+OggdsJgvqBpzE3D3TIB1tvXWdsUG37GcpuA9tA68RTh3pu+9aTDWotIURHebK4iuSgvRh/x5x6XsHJcCKXXU7cUg4/atA959+WWuPvc8VV0i0zx2CSFktLPO0zvfBVIXAba1sQVWq5LlfMbJ7X2O9/eYzZb+EwfrLwLEPRNQGzMzxmzgbHQQ58AYCKFvbeCF6I+g8WATz91pmp8JJql0fB6DQAQihO8i+Exeq+igzjKKYhBniN/17d/O8fERT1x9gnRQIHV3Eo3wveMupk3f+/vhTNtiTM16tWa2WLJ/tOTm0WL92l75F7/qvdlb93VfoCrrT5q6vm4ag+2dpDGgFQLwcXdjgTs76tazE3TStcFUACmIPg2Ed32oCvD09UGBBKl6AkZjNtsWCLz95tu89NIbXJqOmEyHhPjb0HcjhfchtlLf5TdVZbDeUbeOyjjKxjE3jjow+6I3j74QaO8nBcKqqt9Zr1Y/ql6XmKqhzVOUUqizsA8QF2Cx8UQWWJdrWn8LIVVsazorUEnShW6sJRCCOxM2cUpsVcx9rROSPKcYTwAR7WS15unnn4nO27aldY62MbHKx8fWYq3HEQhSopViY5CyrTReylj8FmXz6E9v5PNf/ObB+/dFwGyx/vbFyezXLGYzhqMhaaYRPp6SOKvm3dEzdgB7asaYOIsPSAZVTTqcoLMUnaYIegQfLYQQSYqjLLp0UErHmaO1hmSl2dmc8NT3/4Gk0ylpMUDqDEIgFvT4+5YQu6HvruU8bWup6orZ8YwPP/gk1dvvsT1KdoH6flLAv7y/+KbHd+blaG9/mPXFz0zGpFr3Ki8uJOZdW1eUJzPWTcPhwTFVaxktS7LhiGwwigov7rKSiL6DQuiLZ3cN2xrato1h7YLABk9TO5bzOYXStEGhM4lQkhASwIHSkIRIQhyri5bGOJZNy3xVcnIyZ7FaY52dA+39EOC+++biwx9wZfGlRZb8AkGITo4nE9IsRUkZCw/O9jchSqrFgvmiZLZu2F/ssbVcMxgOSfMBWZGTZhmpTlBRLKnYGURfzLpu03Zyt6lo4t0imJVr3nr1Fa7eeAqKISpGge7bYeg7QMAH35FoDFW5YjlfcLS3z96tfeZluXx7v/r2H/zo2HMx0KdfoAff/uHSAuYb3539ozyRP7xtzSOrxZLxaBjn9YmKC4jqrY0RUFNVVbyVNa9ajlcNbx2UFHny0uWNwY1hno3zNCVNE5JEkSZ9WxN9Ve8PNgSPtS46UxtHGyTf89rb7M+WXNndjZGE0ngh6WeL8bfe+dgCTVtTLdcsVyuOFyXHq2r11sH6D536c0ivHu7nf41Ngd0XLg2+9/d7ZPprp4PkhVGaXM5zvZFqLSB0eWxdLIKVsbH6nqzN0XFlXrl50nzhm0fVtzy7Uzzy3KXRj9wdpj9sXOhnh2m6kSUKqSQSgRShF0OAD/38xMdrNsZSntq6btGpYlzk5HkWi50UlICGkDkXaK0NpnVNZdrlsra3jlbNN3/P3vLz3j9p3gL2gWOA+yEgA7aBLWAEJI+O0+3tYbI5TJKNLGWUIkZBiMQH70tj5/PK3t5btrdOGjcD3DnGJaA++v3VjfzGzjB9YZjIa3mqrqZaXpKIXAlyEcOiC2sXiPWgcc62bajXtj1Z1f7dRe1eO6nb7/ZCHuVS6SwTuQwIE7ytG98clWZ10rglYIEKOAEOgfI+CYgYA5v9Yw4oQH6K6ZgD2t5c/x0NJPGxv8Yd1yE+XoxwzvwdrwUdwh1rML3TM2AO+PsSQj1WdDBAfs4JeRcCfG8t0PRm++8kfUSldxChLiBTAOFOcnuzgLvAofMbUAPr3vz/7/8cTe6y8EjCBX/8zghQ/e/TO66lL4iG845zh/Ntb/48SRd8zz6g/zp7cQrc42/VHREgL1hHuCACfLRPI/4ffcj4tNFkmVoAAAAASUVORK5CYII=\" title=\"emoji-+1\" /></p>\n</blockquote>\n<h2 id=\"h-06-wrong-price-scale-for-gasoracle\" style=\"position:relative;\"><a href=\"#h-06-wrong-price-scale-for-gasoracle\" aria-label=\"h 06 wrong price scale for gasoracle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/93\">[H-06] Wrong price scale for <code>GasOracle</code></a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>GasOracle</code> uses two chainlink oracles (GAS in ETH with some decimals, USD per ETH with some decimals) and multiplies their raw return values to get the gas price in USD.</p>\n<p>However, the scaling depends on the underlying decimals of the two oracles and could be anything.\nBut the code assumes it’s in 18 decimals.</p>\n<blockquote>\n<p>“Returned value is USD/Gas * 10^18 for compatibility with rest of calculations”</p>\n</blockquote>\n<p>There is a <code>toWad</code> function that seems to involve scaling but it is never used.</p>\n<p>The impact is that, If the scale is wrong, the gas price can be heavily inflated or under-reported.</p>\n<p>Recommend checking <code>chainlink.decimals()</code> to know the decimals of the oracle answers and scale the answers to 18 decimals such that no matter the decimals of the underlying oracles, the <code>latestAnswer</code> function always returns the answer in 18 decimals.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/93#issuecomment-873750451\">raymogg (Tracer) confirmed and disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>Disagree with severity as while the statement that the underlying decimals of the oracles could be anything, we will be using production Chainlink feeds for which the decimals are known at the time of deploy.</p>\n<p>This is still however an issue as you don’t want someone using different oracles (eg non Chainlink) that have different underlying decimals and not realising that this contract will not support that.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/93#issuecomment-882123137\">cemozerr (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Marking this a high-risk issue as it poses a big threat to users deploying their own markets</p>\n</blockquote>\n<h1 id=\"medium-risk-findings\" style=\"position:relative;\"><a href=\"#medium-risk-findings\" aria-label=\"medium risk findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings</h1>\n<h2 id=\"m-01-use-of-deprecated-chainlink-api\" style=\"position:relative;\"><a href=\"#m-01-use-of-deprecated-chainlink-api\" aria-label=\"m 01 use of deprecated chainlink api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/73\">[M-01] Use of deprecated Chainlink API</a></h2>\n<p><em>Submitted by 0xRajeev, also found by a</em>delamo, cmichel and shw_</p>\n<p>The contracts use Chainlink’s deprecated API <code>latestAnswer()</code>. Such functions might suddenly stop working if Chainlink stopped supporting deprecated APIs.</p>\n<p>The impact is that, if the deprecated API stops working, prices cannot be obtained, the protocol stops and contracts have to be redeployed.</p>\n<p>Recommend using V3 <a href=\"https://docs.chain.link/docs/price-feeds-api-reference/\">interface functions</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/145\">raymogg (Tracer) confirmed in a separate issue</a></strong></p>\n<h2 id=\"m-02-no-check-transferfrom-return-value\" style=\"position:relative;\"><a href=\"#m-02-no-check-transferfrom-return-value\" aria-label=\"m 02 no check transferfrom return value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/115\">[M-02] No check <code>transferFrom()</code> return value</a></h2>\n<p><em>Submitted by s1m0, also found by pauliax, shw, 0xRajeev, JMukesh, Lucius and cmichel</em></p>\n<p>The smart contract doesn’t check the return value of <code>token.transfer()</code> and <code>token.transferFrom()</code>, some erc20 token might not revert in case of error but return false.\nIn the <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/TracerPerpetualSwaps.sol#L151\">TracerPerpetualSwaps:deposit</a> and <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Insurance.sol#L51\">Insurance:deposit</a> this would allow a user to deposit for free. See issue page for other places.</p>\n<p>Recommend wrapping the call into a <code>require()</code> or using openzeppelin’s <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol\">SafeERC20 library</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/115\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"m-03-deflationary-tokens-are-not-supported\" style=\"position:relative;\"><a href=\"#m-03-deflationary-tokens-are-not-supported\" aria-label=\"m 03 deflationary tokens are not supported permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/104\">[M-03] Deflationary tokens are not supported</a></h2>\n<p><em>Submitted by cmichel, also found by s1m0 and 0xRajeev</em></p>\n<p>There are ERC20 tokens that may make certain customizations to their ERC20 contracts.\nOne type of these tokens is deflationary tokens that charge a certain fee for every <code>transfer()</code> or <code>transferFrom()</code>.</p>\n<p>The <code>deposit()</code> functions of <code>Insurance</code> and <code>TracerPerpetualSwaps</code> assume that the external ERC20 balance of the contract increases by the same amount as the <code>amount</code> parameter of the <code>transferFrom</code>.</p>\n<p>The user is credited the full amount without the taxes (<code>userBalance.position.quote</code>).</p>\n<p>Recommend as one possible mitigation, measuring the asset change right before and after the asset-transferring functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/104#issuecomment-873757118\">raymogg (Tracer) confirmed but disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>Most likely not a medium risk as you can do a lot more nasty things than just use rebasing tokens. Since the owner of a market can set their own quote token, this token could be a token they control the supply of allowing them to arbitrarily transfer tokens between accounts, etc.</p>\n<p>As such, this sort of falls outside of our trust model. Market creators should use tokens that behave as “standard” ERC20s. We will make a not that rebasing and deflationary tokens should not be used as quote tokens without weird behaviour.</p>\n<p>Would be better as a low or informational issue due to this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/104#issuecomment-882104304\">cemozerr (Judge) downgraded severity from 2 to 1</a>:</strong></p>\n<blockquote>\n<p>Marking this as low risk as it seems to fall outside of the trust model, yet important enough to communicate to users explicitly.</p>\n</blockquote>\n<h2 id=\"m-04-underflow-problems-occurring-when-a-token-has-18-decimals\" style=\"position:relative;\"><a href=\"#m-04-underflow-problems-occurring-when-a-token-has-18-decimals\" aria-label=\"m 04 underflow problems occurring when a token has 18 decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/116\">[M-04] Underflow problems occurring when a token has >18 decimals</a></h2>\n<p><em>Submitted by tensors, also found by s1m0</em></p>\n<p>The contracts assume that all tokens will have &#x3C;=18 decimals. This isn’t necessarily a problem if the Tracer team is the only people deploying the contracts and they keep it in mind. But, If the contracts are to be deployed by other people, this assumption should be made explicit and hard-coded.</p>\n<p>We can see that the scaler computations will underflow and be defined when it should not be In <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibBalances.sol#L220-L232\">L220-L232</a>.</p>\n<p>Recommend writing a require check that ensures <code>tokenDecimals &#x3C;= 18</code> before running the above functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/116#issuecomment-873755853\">raymogg (Tracer) confirmed</a>:</strong></p>\n<blockquote>\n<p>Valid issue and makes sense as a medium.</p>\n<p>Suggested mitigation will be implemented.</p>\n</blockquote>\n<h2 id=\"m-05-add-reentrancy-protections-on-function-executetrade\" style=\"position:relative;\"><a href=\"#m-05-add-reentrancy-protections-on-function-executetrade\" aria-label=\"m 05 add reentrancy protections on function executetrade permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/143\">[M-05] Add reentrancy protections on function <code>executeTrade</code></a></h2>\n<p><em>Submitted by shw, also found by 0xRajeev</em></p>\n<p>As written in the to-do comments, reentrancy could happen in the <code>executeTrade</code> function of <code>Trader</code> since the <code>makeOrder.market</code> can be a user-controlled external contract. See <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Trader.sol#L121-L126\">L121-L126</a> in <code>Trader.sol</code>.</p>\n<p>Recommend adding a reentrancy guard (e.g., the <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol\">implementation from OpenZeppelin</a>) to prevent the users from reentering critical functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/143#issuecomment-874405296\">raymogg (Tracer) disputed</a>:</strong></p>\n<blockquote>\n<p>Disputing just as while this is important, its quite explicitly stated in the todo comment and as such is already known by the team as a potential issue.</p>\n<p>Realistically shouldn’t be too much of a problem with whitelisting of the trader.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/143#issuecomment-882105114\">cemozerr (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Marking this as medium risk as, regardless of being noted by the team, still poses a security threat.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/143#issuecomment-874405296\">OsmanBran (Tracer) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/72\">#72</a></p>\n</blockquote>\n<h2 id=\"m-06-single-step-process-for-critical-ownership-transfer\" style=\"position:relative;\"><a href=\"#m-06-single-step-process-for-critical-ownership-transfer\" aria-label=\"m 06 single step process for critical ownership transfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/43\">[M-06] Single-step process for critical ownership transfer</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>The <code>Tracer Perpetuals Factory</code> contract is arguably the most critical contract in the project given that it deploys all the markets. The ownership of this contract is transferred to <code>_governance address</code>, i.e. TracerDAO, in the constructor. This critical address transfer in one-step is very risky because it is irrecoverable from any mistakes.</p>\n<p>The impact is that, if an incorrect address (e.g. one for which the private key is not known) is used accidentally, then it prevents the use of all the <code>onlyOwner()</code> functions forever, which includes the changing of various deployer contract addresses and market approvals. This use of an incorrect address may not even be immediately apparent given that these functions are probably not used immediately. When noticed, due to a failing <code>onlyOwner()</code> function call, it will force the redeployment of the <code>factory</code> contract and require appropriate changes and notifications for switching from the old to new address. This will diminish trust in markets and incur a significant reputational damage. See <a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/43\">issue page</a> for proof of concept.</p>\n<p>Recommend retaining the deployer ownership in the constructor and then using a two-step address change to <code>_governance</code> address separately using setter functions:</p>\n<ol>\n<li>Approve a new address as a <code>pendingOwner</code></li>\n<li>A transaction from the <code>pendingOwner</code> (TracerDAO) address claims the pending ownership change.</li>\n</ol>\n<p>This mitigates risk because if an incorrect address is used in step (1), then it can be fixed by re-approving the correct address. Only after a correct address is used in step (1) can step (2) happen and complete the address/ownership change.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/43#issuecomment-873762658\">raymogg (Tracer) acknowledged</a>:</strong></p>\n<blockquote>\n<p>Correct that having the owner be set to a wrong address could be detrimental, however for the first deploy of the factory, this will be owned by the DAO and will be easy to validate on deployment.</p>\n<p>Subsequent ownership transfers will be done via DAO proposal, and will have many eyes across them (due to them being a public Tracer DAO proposal) before function execution happens.</p>\n<p>For this reason it seems like a lot of overhead to have a two step process for this. Not withstanding that the issue you mention could still be possible</p>\n</blockquote>\n<h2 id=\"m-07-malicious-owner-can-arbitrarily-change-fee-to-any--value\" style=\"position:relative;\"><a href=\"#m-07-malicious-owner-can-arbitrarily-change-fee-to-any--value\" aria-label=\"m 07 malicious owner can arbitrarily change fee to any  value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/66\">[M-07] Malicious owner can arbitrarily change fee to any % value</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>The Tracer protocol like any other allows market creators to charge fees for trades. However, a malicious/greedy owner can arbitrarily change fee to any % value and without an event to observe this change or a timelock to react, there is no easy way for users to monitor this via front-end or off-chain monitoring tools.</p>\n<p>The impact is that, if the users are trading on a market with 0.1% fees and the owner suddenly changes this to 100%, the users realise this only after their trades are executed. Market loses confidence. Protocol takes a reputational hit.</p>\n<p>See similar Medium-severity finding in <a href=\"https://consensys.net/diligence/audits/2020/12/1inch-liquidity-protocol/#unpredictable-behavior-for-users-due-to-admin-front-running-or-general-bad-timing\">ConsenSys’s Audit of 1inch Liquidity Protocol</a></p>\n<p>Recommend implementing an <code>Emit</code> event, and providing a timelock for users to react and establish an upper threshold for fees that is decided across markets by governance.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/66#issuecomment-873760964\">raymogg (Tracer) confirmed</a>:</strong></p>\n<blockquote>\n<p>Like the idea of having a timelock for any update parameter update that immediately affects traders</p>\n</blockquote>\n<h2 id=\"m-08-missing-events-for-critical-parameter-changing-operations-by-owner\" style=\"position:relative;\"><a href=\"#m-08-missing-events-for-critical-parameter-changing-operations-by-owner\" aria-label=\"m 08 missing events for critical parameter changing operations by owner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/64\">[M-08] Missing events for critical parameter changing operations by owner</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>The owner of <code>TracerPerpetualSwaps</code> contract, who is potentially untrusted as per specification, can change the market critical parameters such as the addresses of the <code>Liquidation</code>/<code>Pricing</code>/<code>Insurance</code>/<code>GasOracle</code>/<code>FeeReceiver</code> and also critical values such as  <code>feeRate</code>, <code>maxLeverage</code>, <code>fundingRateSensitivity</code>, <code>deleveragingCliff</code>, <code>lowestMaxLeverage</code>, <code>insurancePoolSwitchStage</code> and whitelisting.</p>\n<p>None of these setter functions emit events to record these changes on-chain for off-chain monitors/tools/interfaces to register the updates and react if necessary.</p>\n<p>The impact of this is that, if a malicious owner changes the critical addresses or values that significantly change the security posture/perception of the protocol. No events are emitted and users lose funds/confidence. The protocol takes a reputation hit.</p>\n<p>See similar high-severity finding in <a href=\"https://blog.openzeppelin.com/audius-contracts-audit/#high\">OpenZeppelin’s Audit of Audius</a> and medium-severity finding <a href=\"https://blog.openzeppelin.com/uma-audit-phase-4/\">OpenZeppelin’s Audit of UMA Phase 4</a>.</p>\n<p>Recommend to consider emitting events when these addresses/values are updated. This will be more transparent and it will make it easier to keep track of the status of the system.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/64#issuecomment-873760825\">raymogg (Tracer) marked as duplicate of another (confirmed issue)</a>:</strong></p>\n<blockquote>\n<p>Duplicate of #66</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/64#issuecomment-882106845\">cemozerr (Judge) reopened and removed duplicate label</a>:</strong></p>\n<blockquote>\n<p>Opening this issue as the event emission seems to be separate from the arbitrarily changing of the values.</p>\n</blockquote>\n<h2 id=\"m-09-wrong-funding-index-in-settle-when-no-base\" style=\"position:relative;\"><a href=\"#m-09-wrong-funding-index-in-settle-when-no-base\" aria-label=\"m 09 wrong funding index in settle when no base permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/106\">[M-09] Wrong funding index in settle when no base?</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>TracerPerpetualSwaps.settle</code> function updates the user’s last index to <code>currentGlobalFundingIndex</code>, however a comment states:</p>\n<blockquote>\n<p>”// Note: global rates reference the last fully established rate (hence the -1), and not the current global rate. User rates reference the last saved user rate”</p>\n</blockquote>\n<p>The code for the <code>else</code> branch also updates the last index to <code>currentGlobalFundingIndex - 1</code> instead of <code>currentGlobalFundingIndex</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">accountBalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk12\">base</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// set to the last fully established index</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit shouldn&#39;t this be global - 1 like below?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">accountBalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastUpdatedIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentGlobalFundingIndex</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">accountBalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastUpdatedGasPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gasPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">latestAnswer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The impact is that it might be possible for first-time depositors to skip having to pay the first funding rate period as the <code>accountLastUpdatedIndex + 1 &#x3C; currentGlobalFundingIndex</code> check will still return <code>false</code> when the funding rates are updated the next time.</p>\n<p>Recommend to check if setting it to <code>currentGlobalFundingIndex</code> or to <code>currentGlobalFundingIndex - 1</code> is correct.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/106\">raymogg (Tracer) confirmed but disagreed with severity</a></strong></p>\n<h2 id=\"m-10-prb-math-not-audited\" style=\"position:relative;\"><a href=\"#m-10-prb-math-not-audited\" aria-label=\"m 10 prb math not audited permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/11\">[M-10] <code>prb-math</code> not audited</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>The library <a href=\"//%20https://github.com/hifi-finance/prb-math#security\"><code>prb-math</code> documents</a> have not been audited by a security researcher.  This means its more risky to rely on this library.</p>\n<p>Recommend considering (crowdsourcing) an audit for <code>prb-math</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/11\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"m-11-claim-liquidation-escrow\" style=\"position:relative;\"><a href=\"#m-11-claim-liquidation-escrow\" aria-label=\"m 11 claim liquidation escrow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/2\">[M-11] Claim liquidation escrow</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>A liquidator can always claim the liquidation escrow in the following way:</p>\n<ul>\n<li>create a second account</li>\n<li>setup a complimentary trade in that second account, which will result in a large slippage when executed</li>\n<li>call <code>executeTrade</code> (which everyone can call), to execute a trade between his own two accounts with a large slippage</li>\n<li>the slippage doesn’t hurt because the liquidator owns both accounts</li>\n<li>call <code>claimReceipt</code> with the receiptId of the executed order, within the required period (e.g. 15 minutes)</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Trader.sol#L67\">L67</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeTrade</span><span class=\"mtk1\">(Types.SignedLimitOrder[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">makers</span><span class=\"mtk1\">, Types.SignedLimitOrder[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">takers</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Liquidation.sol#L394\">L394</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimReceipt</span><span class=\"mtk1\">( </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiptId</span><span class=\"mtk1\">, Perpetuals.Order[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orders</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">traderContract</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>Recommend to perhaps limit who can call <code>executeTrade</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/2#issuecomment-873774429\">raymogg (Tracer) acknowledged and confirmed</a>:</strong></p>\n<blockquote>\n<p>Valid issue which would allow someone to get reimbursed for slippage against themselves.</p>\n<p>The Trader contract will have whitelisted relayers added to prevent issues like this (similar to #119)</p>\n</blockquote>\n<h2 id=\"m-12-avoid-paying-insurance\" style=\"position:relative;\"><a href=\"#m-12-avoid-paying-insurance\" aria-label=\"m 12 avoid paying insurance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/30\">[M-12] avoid paying insurance</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>It’s possible to avoid paying insurance in the following way:</p>\n<ul>\n<li>once per hour (at the right moment), do the following:</li>\n<li>using a flash loan, or with a large amount of tokens, call <code>deposit</code> of <code>Insurance.sol</code> to make sure that the pool is sufficiently filled (<code>poolHoldings</code> > <code>poolTarget</code>)</li>\n<li>call the function <code>executeTrade</code> of Trader<code>.sol</code> with a minimal trade (possibly of value 0, see finding ”<code>executeTrade</code> with same trades”)</li>\n<li><code>executeTrade</code> calls <code>matchOrders</code>, which calls <code>recordTrade</code></li>\n<li><code>recordTrade</code> calls <code>updateFundingRate()</code>;   (once per hour, so you have to be sure you do it in time before other trades trigger this)</li>\n<li><code>updateFundingRate</code> calls <code>getPoolFundingRate</code></li>\n<li><code>getPoolFundingRate</code> determines the insurance rate, but because the insurance pool is sufficiently full (due to the flash loan), the rate is 0</li>\n<li><code>updateFundingRate</code> stores the 0 rate via <code>setInsuranceFundingRate</code>  (which is used later on to calculate the amounts for the insurances)</li>\n<li>withdraw from the Insurance and pay back the flash loan</li>\n</ul>\n<p>The insurance rates are 0 now and no-one pays insurance. The gas costs relative to the insurance costs + the flash loan fees determine if this is an economically viable attack. Otherwise it is still a grief attack.\nThis will probably be detected pretty soon because the insurance pool will stay empty. However its difficult to prevent.</p>\n<p>See issue page for code referenced in proof of concept.</p>\n<p>Recommend setting a timelock on withdrawing insurance.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/30#issuecomment-873763520\">raymogg (Tracer) confirmed but disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>Really like this exploit idea. Currently this is possible since the Trader is not whitelisted (eg there is no whitelisted relayer address). With this added, this exploit is no longer possible as only off chain relayers can place orders with the trader.</p>\n<p>Disagree with the severity mainly due to the fact that executing this exploit once would only cause insurance funding to not be paid for a single hour. For insurance funding to never be paid, you would have to time this transaction as the first transaction on each and every hour. This would quickly be noticed. The only affect on this would be insurance depositors miss interest payments for a few periods.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/30#issuecomment-882109332\">cemozerr (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Marking this as medium risk as a front-runner could keep doing this for not paying any funding using a bot.</p>\n</blockquote>\n<h2 id=\"m-13-trader-orders-can-be-front-run-and-users-can-be-denied-from-trading\" style=\"position:relative;\"><a href=\"#m-13-trader-orders-can-be-front-run-and-users-can-be-denied-from-trading\" aria-label=\"m 13 trader orders can be front run and users can be denied from trading permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/100\">[M-13] Trader orders can be front-run and users can be denied from trading</a></h2>\n<p><em>Submitted by cmichel, also found by gpersoon and tensors</em></p>\n<p>The <code>Trader</code> contract accepts two signed orders and tries to match them. Once they are matched and become filled, they can therefore not be matched against other orders anymore.</p>\n<p>This allows for a griefing attack where an attacker can deny any other user from trading by observing the mempool and front-running their trades by creating their own order and match it against the counter order instead.</p>\n<p>In this way, a trader can be denied from trading. The cost of the griefing attack is that the trader has to match the order themselves, however depending on the liquidity of the order book and the spread, they might be able to do the counter-trade again afterwards, basically just paying the fees.</p>\n<p>It could be useful if the attacker is a liquidator and is stopping a user who is close to liquidation from becoming liquid again.</p>\n<p>This seems hard to circumvent in the current design. If the order book is also off-chain, the <code>executeTrade</code> could also be a bot-only function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/123#issuecomment-873755673\">raymogg (Tracer) disputed (in duplicate)</a></strong></p>\n<blockquote>\n<p>Marked as a dispute as this is not really an issue. Tracer will initially maintain an off chain order book that is the entry point for users to make orders (and for market makers to interact with).</p>\n<p>Orders only get propagated on chain once they have been matched, and they will only be propagated on chain by whitelisted relayers. As such nobody can arbitrarily frontrun the orders with their own.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/123#issuecomment-882119567\">cemozerr (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Currently not seeing a whitelisted relayer functionality, so marking this a valid medium risk issue.</p>\n</blockquote>\n<h1 id=\"low-risk-findings\" style=\"position:relative;\"><a href=\"#low-risk-findings\" aria-label=\"low risk findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings</h1>\n<h2 id=\"l-01-zero-address-checks-are-missing\" style=\"position:relative;\"><a href=\"#l-01-zero-address-checks-are-missing\" aria-label=\"l 01 zero address checks are missing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/49\">[L-01] Zero-address checks are missing</a></h2>\n<p><em>Submitted by 0xRajeev, also found by JMukesh, cmichel, gpersoon, pauliax and shw</em></p>\n<p>Zero-address checks are a best-practice for input validation of critical address parameters. While the codebase applies this to most addresses in setters, there are many places where this is missing in constructors and setters. Accidental use of zero-addresses may result in exceptions, burn fees/tokens or force redeployment of contracts.</p>\n<p>Recommend adding zero-address checks.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/49#issuecomment-874361310\">raymogg (Tracer) confirmed</a></strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/136\">#136</a></p>\n<p>More issues brought up in this one, but falls under the general category of missing zero address checks</p>\n</blockquote>\n<h2 id=\"l-02-can-set-values-to-more-than-100\" style=\"position:relative;\"><a href=\"#l-02-can-set-values-to-more-than-100\" aria-label=\"l 02 can set values to more than 100 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/102\">[L-02] Can set values to more than 100%</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>There are several setter functions that do not check if the amount is less than 100% including:</p>\n<ul>\n<li><code>TracerPerpetualSwaps</code>: <code>setFeeRate</code>, <code>setDeleveragingCliff</code>, <code>setInsurancePoolSwitchStage</code></li>\n<li><code>Insurance</code>: <code>setFeeRate</code>, <code>setDeleveragingCliff</code>, <code>setInsurancePoolSwitchStage</code></li>\n</ul>\n<p>The impact is that setting values to more than 100% might lead to unintended functionality.</p>\n<p>Recommend ensuring that the parameters are less than 100%.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/102\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-03-liquidationgascost-may-not-be-a-constant\" style=\"position:relative;\"><a href=\"#l-03-liquidationgascost-may-not-be-a-constant\" aria-label=\"l 03 liquidationgascost may not be a constant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/48\">[L-03] LIQUIDATION<em>GAS</em>COST may not be a constant</a></h2>\n<p><em>Submitted by 0xRajeev, also found by cmichel and gpersoon</em></p>\n<p>The gas cost for liquidation may change if code is updated/optimized, the compiler is changed or profiling is improved. The developers may forget to update this constant in code. The impact is that the margin validity calculation, which uses this value, may be affected if this changes and hence is not as declared in the constant. This may adversely impact validation.</p>\n<p>Because It is safer to make this a constructor-set immutable value that will force usage of an updated accurate value at deployment time.</p>\n<p>Recommend evaluating if the sensitivity to this value is great enough to justify a setter to change it if incorrectly initialized at deployment.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/101\">raymogg (Tracer) confirmed in (duplicate issue)</a></strong></p>\n<h2 id=\"l-04-deposit-event-should-use-the-converted-wad-amount\" style=\"position:relative;\"><a href=\"#l-04-deposit-event-should-use-the-converted-wad-amount\" aria-label=\"l 04 deposit event should use the converted wad amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/56\">[L-04] <code>Deposit</code> event should use the converted WAD amount</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>The <code>Deposit</code> event uses the function parameter amount instead of the <code>convertedWadAmount</code> which is what is used to update the user’s position and TVL because it prevents any dust deposited in amount. This will also make it consistent with the emit event in the <code>withdraw</code> function.</p>\n<p>The impact is that the<code>Deposit</code> event amount reflects the value with dust while the user position does not. This may lead to confusion.</p>\n<p>Recommend using <code>uint256(convertedWadAmount)</code> instead of amount in <code>Deposit</code> event.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/56\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-05-tvl-calculation-in-withdraw-should-use-convertedwadamount-instead-of-amount\" style=\"position:relative;\"><a href=\"#l-05-tvl-calculation-in-withdraw-should-use-convertedwadamount-instead-of-amount\" aria-label=\"l 05 tvl calculation in withdraw should use convertedwadamount instead of amount permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/57\">[L-05] TVL calculation in <code>withdraw()</code> should use <code>convertedWadAmount</code> instead of <code>amount</code></a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>The TVL calculation in <code>deposit()</code> uses <code>convertedWadAmount</code> but the one in <code>withdraw()</code> uses the parameter <code>amount</code>. While <code>amount</code> is still in WAD format, it may contain dust which is what the conversion to <code>rawTokenAmount</code> and then back to <code>convertedWadAmount</code> removes.</p>\n<p>The impact of this is that use of <code>amount</code> in TVL during <code>withdraw()</code> will consider dust while the one in <code>deposit()</code> will not, which is inconsistent.</p>\n<p>Recommend using <code>convertedWadAmount</code> instead of <code>amount</code> to be consistent with the increment during <code>withdraw()</code> TVL calculation.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/57\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-06-lack-of-a-contract-existence-check-may-lead-to-undefined-behavior\" style=\"position:relative;\"><a href=\"#l-06-lack-of-a-contract-existence-check-may-lead-to-undefined-behavior\" aria-label=\"l 06 lack of a contract existence check may lead to undefined behavior permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/71\">[L-06] Lack of a contract existence check may lead to undefined behavior</a></h2>\n<p><em>Submitted by 0xRajeev, also found by a</em>delamo and pauliax_</p>\n<p>Low-level calls <code>call</code>/<code>delegatecall</code>/<code>staticcall</code> return true even if the account called is non-existent (per EVM design).</p>\n<p>Solidity documentation warns:</p>\n<blockquote>\n<p>“The low-level functions <code>call</code>, <code>delegatecall</code> and <code>staticcall</code> return true as their first return value if the account called is non-existent, as part of the design of the EVM. Account existence must be checked prior to calling if needed.”</p>\n</blockquote>\n<p>Market address may not exist as a contract (e.g. incorrect EOA address used in orders), in which case low-level calls still returns true/success. But the trade is assumed to have been successfully executed.</p>\n<p>As a result, <code>executeTrade()</code> executes batch orders against a non-existing market contract due to a mistake in the trading interface. The transaction executes successfully without any side-effects because the market doesn’t exist. Internal accounting is updated incorrectly.</p>\n<p>See related High-severity finding in <a href=\"https://github.com/trailofbits/publications/blob/master/reviews/hermez.pdf\">ToB’s Audit of Hermez</a> and <a href=\"https://github.com/Uniswap/uniswap-v3-core/blob/main/audits/tob/audit.pdf\">ToB’s Audit of Uniswap V3</a>. Also see <a href=\"https://docs.soliditylang.org/en/v0.8.0/control-structures.html#error-handling-assert-require-revert-and-exceptions\">Warning in solidity documentation</a>.</p>\n<p><a href=\"https://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Trader.sol#L121-L129\">https://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Trader.sol#L121-L129</a></p>\n<p>Recommend that <code>makeOrder.market</code> should be checked for contract existence before the low-level call, and then verified to be the actual market contract (but it is not verified as noted in the comment). Evaluate if this is a greater concern than undefined behavior.</p>\n<h2 id=\"l-07-using-txgasprice-to-prevent-front-running-may-lead-to-failed-liquidations\" style=\"position:relative;\"><a href=\"#l-07-using-txgasprice-to-prevent-front-running-may-lead-to-failed-liquidations\" aria-label=\"l 07 using txgasprice to prevent front running may lead to failed liquidations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/76\">[L-07] Using <code>tx.gasprice</code> to prevent front-running may lead to failed liquidations</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>In <code>verifyAndSubmitLiquidation()</code>, the <code>tx.gasprice</code> is checked against the <code>fastGasOracle</code>’s current gas price presumably to prevent liquidators front-running others for the same market/account by using a gas price exceeding the current prevailing price as indicated by the <code>fastGasOracle</code>.</p>\n<p>The impact is that, if the gas prices are increasing rapidly due to volatility or network congestion, or if the liquidation engines and <code>fastGasOracle</code> are out of sync on gas prices because of consulting different sources, then these liquidations will keep failing. Front-running risk on liquidations is not adequately protected by <code>tx.gasprice</code> check.</p>\n<p>This logic may also be impacted by the upcoming inclusion of EIP-1559 in London fork which affect gas semantics significantly.</p>\n<p>Liquidation bots front-running by monitoring mempool or the use of FlashBots for liquidation MEV, is a systemic challenge and not solved by using gasprice logic in contracts. Would recommend evaluating if the benefits match the failure modes.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/76#issuecomment-876022738\">raymogg (Tracer) acknowledged</a>:</strong></p>\n<blockquote>\n<p>Good point on the strict check of fast gas price. As you pointed out this is to prevent gas auctions from occuring and causing liquidations to be extremely expensive, however this could become a bottleneck in times of rapidly changing gas prices.</p>\n<p>Have acknowledged that this could cause problems in certain scenarios. The team will be thinking about a safer implementation of this mechanism.</p>\n</blockquote>\n<h2 id=\"l-08-potential-division-by-zero\" style=\"position:relative;\"><a href=\"#l-08-potential-division-by-zero\" aria-label=\"l 08 potential division by zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/83\">[L-08] Potential division by zero</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>In function <code>minimumMargin()</code>, <code>maximumLeverage</code> being zero is not handled because it will result in div by zero as <code>PRBMathUD60x18.div</code> expects non-zero <code>diTracer</code>.</p>\n<p>The impact is that various critical market functions will revert if <code>maximumLeverage</code> is zero. See issue page for effected code.</p>\n<p>Recommend adding checks to make sure <code>maximumLeverage</code> is never zero or handle appropriately.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/83\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-09-unlocked-pragma-used-in-multiple-contracts\" style=\"position:relative;\"><a href=\"#l-09-unlocked-pragma-used-in-multiple-contracts\" aria-label=\"l 09 unlocked pragma used in multiple contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/133\">[L-09] Unlocked pragma used in multiple contracts</a></h2>\n<p><em>Submitted by shw, also found by JMukesh</em></p>\n<p>Most of the contracts use an unlocked pragma (e.g., <code>pragma solidity ^0.8.0</code>) which is not fixed to a specific Solidity version. Locking the pragma helps ensure that contracts do not accidentally get deployed using a different compiler version with which they have been tested the most. Please use <code>grep -R pragma .</code> to find the unlocked pragma statements in the codebase</p>\n<p>Recommend locking pragmas to a specific Solidity version. Consider the compiler bugs in the following lists and ensure the contracts are not affected by them. It is also recommended to use the latest version of Solidity when deploying contracts (see <a href=\"https://docs.soliditylang.org/en/v0.8.6/\">Solidity docs</a>).</p>\n<p>Solidity compiler bugs:\n<a href=\"https://github.com/ethereum/solidity/blob/develop/docs/bugs.json\">Solidity repo - known bugs</a>\n<a href=\"https://github.com/ethereum/solidity/blob/develop/docs/bugs_by_version.json\">Solidity repo - bugs by version</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/133#issuecomment-876078882\">raymogg (Tracer) confirmed but disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>Disagree with severity as the Solidity version is defined in the project config as well so the risk of the contracts being deployed with the wrong version is low. Should be a 0</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/133#issuecomment-882095913\">cemozerr (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Marking this as low risk as unlocked pragma can lead to compiler bugs.</p>\n</blockquote>\n<h2 id=\"l-10-libmath-fails-implicitly\" style=\"position:relative;\"><a href=\"#l-10-libmath-fails-implicitly\" aria-label=\"l 10 libmath fails implicitly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/88\">[L-10] <code>LibMath</code> fails implicitly</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>When <code>LibMath.abs</code> is called with -2^255 (<code>type(int256).min</code>), it tries to multiply it by <code>-1</code> but it’ll fail as it exceeds the max signed 256-bit integers. The function will fail with an implicit error that might be hard to locate.</p>\n<p>Recommend throwing an error similar to <code>toInt256</code> like <code>int256 overflow</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/88\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-11-libmathsumn-can-iterate-over-array\" style=\"position:relative;\"><a href=\"#l-11-libmathsumn-can-iterate-over-array\" aria-label=\"l 11 libmathsumn can iterate over array permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/89\">[L-11] <code>LibMath.sumN</code> can iterate over array</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>When <code>LibMath.sumN</code> function does not check if <code>n &#x3C;= arr.length</code> and can therefore fail if called with <code>n > arr.length</code>. The caller must always check that it’s called with an argument that is less than <code>n</code> which is inconvenient.</p>\n<p>Recommend changing the condition to iterate up to <code>min(n, arr.length)</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/89\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-12-todos-left-in-the-code\" style=\"position:relative;\"><a href=\"#l-12-todos-left-in-the-code\" aria-label=\"l 12 todos left in the code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/12\">[L-12] todos left in the code</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>There are several todos left in the code. See Issue page for list.\nRecommend checking, fixing and removing the todos before it is deployed in production</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/12\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-13-check-sign-in-calculateslippage\" style=\"position:relative;\"><a href=\"#l-13-check-sign-in-calculateslippage\" aria-label=\"l 13 check sign in calculateslippage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/17\">[L-13] check sign in <code>calculateSlippage</code></a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>In function <code>calculateSlippage</code> of <code>LibLiquidation.sol</code>, the value of <code>amountToReturn</code> is calculated by subtracting to numbers. Later on it is checked to see if this value is negative. However, <code>amountToReturn</code> is an unsigned integer so it can never be negative. If a negative number would be attempted to be assigned, the code will revert, because solidity 0.8 checks for this. See <code>LibLiquidation.sol</code> <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibLiquidation.sol#L106\">L106</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">calculateSlippage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountToReturn</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">percentSlippage</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">avgPrice</span><span class=\"mtk1\"> &lt; receipt.price &amp;&amp; receipt.liquidationSide == Perpetuals.Side.Long) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amountToReturn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amountExpectedFor</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amountSoldFor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">avgPrice</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">receipt</span><span class=\"mtk1\">.</span><span class=\"mtk12\">liquidationSide</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">Perpetuals</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Side</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Short</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amountToReturn</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amountSoldFor</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amountExpectedFor</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amountToReturn</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {    </span><span class=\"mtk3\">// can never be smaller than 0, because `amountToReturn` is uint256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Recommend double checking if <code>amountToReturn</code> could be negative. If this is the case, change the type of <code>amountToReturn</code> to int256 and add the appropriate type casts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/17#issuecomment-876085044\">raymogg (Tracer) confirmed</a>:</strong></p>\n<blockquote>\n<p>Confirmed but think this is a 0 on severity. The check while a bit redundant on the less than case, is actually still needed as we do want to catch the case where <code>amountToReturn = 0</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/17#issuecomment-882100905\">cemozerr (Judge) commented</a>:</strong></p>\n<blockquote>\n<p>Marking this as low risk as a “Double check if amountToReturn could be negative” seems necessary for the scenarios where the amountToReturn could underflow.</p>\n</blockquote>\n<h2 id=\"l-14-the-averagepriceforperiod-function-may-revert-without-proper-error-message-returned\" style=\"position:relative;\"><a href=\"#l-14-the-averagepriceforperiod-function-may-revert-without-proper-error-message-returned\" aria-label=\"l 14 the averagepriceforperiod function may revert without proper error message returned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/140\">[L-14] The <code>averagePriceForPeriod</code> function may revert without proper error message returned</a></h2>\n<p><em>Submitted by shw, also found by gpersoon</em></p>\n<p>The <code>averagePriceForPeriod</code> function of <code>LibPrices</code> does not handle the case where <code>j</code> equals 0 (i.e., no trades happened in the last 24 hours). The transaction reverts due to dividing by 0 without a proper error message returned.</p>\n<p>Recommend adding <code>require(j > 0, \"...\")</code> before line 73 to handle this special case.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/140\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-15-make-sure-withdrawfees-always-can-withdraw\" style=\"position:relative;\"><a href=\"#l-15-make-sure-withdrawfees-always-can-withdraw\" aria-label=\"l 15 make sure withdrawfees always can withdraw permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/23\">[L-15] make sure <code>withdrawFees</code> always can withdraw</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>If you call the function <code>withdrawFees</code> when “TVL” is not enough for the fee, then the code  would revert. In this case the fees cannot be withdrawn. Although it is unlikely that the TVL would be wrong, it is probably better to be able to withdraw the remaining fees.</p>\n<p><code>TracerPerpetualSwaps.sol</code> <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/TracerPerpetualSwaps.sol#L508\">L508</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawFees</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tempFees</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">fees</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">tvl</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tvl</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">tempFees</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Withdraw from the account</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tracerQuoteToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feeReceiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tempFees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FeeWithdrawn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feeReceiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tempFees</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend adding something like <code>tempFees = min (fees, tvl);</code>, and changing <code>fees=0</code> to <code>fees -= tempFees;</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/23\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-16-matchorders-couldshould-check-market\" style=\"position:relative;\"><a href=\"#l-16-matchorders-couldshould-check-market\" aria-label=\"l 16 matchorders couldshould check market permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/6\">[L-16] <code>matchOrders</code> could/should check market</a></h2>\n<p><em>Submitted by gpersoon</em></p>\n<p>The function <code>matchOrders</code> of <code>TracerPerpetualSwaps.sol</code> doesn’t check that the contract itself is indeed equal to <code>order1.market</code> and <code>order2.market</code>.</p>\n<p>The function <code>executeTrade</code> in <code>Trader.sol</code>, which calls the <code>matchOrders</code>, can deal with multiple markets.</p>\n<p>Suppose there would be a mistake in <code>executeTrade</code>,  or in a future version, the <code>matchOrders</code> would be done in the wrong market.</p>\n<p><code>TracerPerpetualSwaps.sol</code> <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/TracerPerpetualSwaps.sol#L216\">L216</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> `</span><span class=\"mtk11\">matchOrders</span><span class=\"mtk1\">`( Perpetuals.Order </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order1</span><span class=\"mtk1\">, Perpetuals.Order </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">order2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fillAmount</span><span class=\"mtk1\"> )</span></span></span></code></pre>\n<p><code>Trader.sol</code> <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Trader.sol#L67\">L67</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> `</span><span class=\"mtk11\">executeTrade</span><span class=\"mtk1\">`(Types.SignedLimitOrder[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">makers</span><span class=\"mtk1\">, Types.SignedLimitOrder[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">takers</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\">  </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">makeOrder</span><span class=\"mtk1\">.</span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">ITracerPerpetualSwaps</span><span class=\"mtk1\">(</span><span class=\"mtk12\">makeOrder</span><span class=\"mtk1\">.</span><span class=\"mtk12\">market</span><span class=\"mtk1\">).</span><span class=\"mtk12\">matchOrders</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">makeOrder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">takeOrder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fillAmount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><code>LibPerpetuals.sol</code> <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibPerpetuals.sol#L128\">L128</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">canMatch</span><span class=\"mtk1\">( </span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aFilled</span><span class=\"mtk1\">,</span><span class=\"mtk12\">Order</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">b</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bFilled</span><span class=\"mtk1\"> ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">marketsMatch</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">market</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">market</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Recommend adding something like:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\"> ( </span><span class=\"mtk12\">order1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">market</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Wrong market&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Note: <code>canMatch</code> already verifies that  <code>order1.market== order2.market</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/6\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-17-inclusive-check-that-account-is-not-above-minimum-margin\" style=\"position:relative;\"><a href=\"#l-17-inclusive-check-that-account-is-not-above-minimum-margin\" aria-label=\"l 17 inclusive check that account is not above minimum margin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/109\">[L-17] inclusive check that account is not above minimum margin</a></h2>\n<p><em>Submitted by pauliax</em></p>\n<p>Here the check <code>currentMargin</code> &#x3C; <code>Balances.minimumMargin</code> should be inclusive &#x3C;= to indicate the account is not above minimum margin:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">currentMargin</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ||</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentMargin</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk12\">Balances</span><span class=\"mtk1\">.</span><span class=\"mtk11\">minimumMargin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pos</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">gasCost</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tracer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">trueMaxLeverage</span><span class=\"mtk1\">()),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;LIQ: Account above margin&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span></code></pre>\n<p>Recommend using <code>uint256(currentMargin) &#x3C;= Balances.minimumMargin</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/109\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-18-hardcoded-chainid\" style=\"position:relative;\"><a href=\"#l-18-hardcoded-chainid\" aria-label=\"l 18 hardcoded chainid permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/85\">[L-18] hardcoded <code>chainID</code></a></h2>\n<p><em>Submitted by pauliax, also found by s1m0, shw and 0xRajeev</em></p>\n<p>Hardcoding <code>chainID</code> is error-prone (in case you decide to deploy on a different chain and forget to change this, or if the chain forks, etc…):\n<code>uint256 public constant override chainId = 1337;</code> // Changes per chain</p>\n<p>Recommend better utilization of global variable <code>block.chainid</code>, or you can also retrieve <code>chainID</code> via <a href=\"https://ethereum.stackexchange.com/a/77550/17387\">assembly</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/67#issuecomment-873753616\">raymogg (Tracer) disputed in a duplicate issue</a></strong></p>\n<blockquote>\n<p>Disputing as an issue as while the suggested approach is a better solution (dynamically setting ChainID), deploying a Trader contract with the wrong ID does not affect the system. A new Trader can be deployed using the appropriate ChainID if one is accidentally deployed with the wrong ChainID.</p>\n<p>Currently this ChainID is just updated before deployment. The team will implement the dynamic approach moving forward.</p>\n</blockquote>\n<p><em><strong>Note:</strong> Additional conversation regarding this vulnerability can be found <a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/67\">here</a></em></p>\n<h2 id=\"l-19-pricesaverageprice-does-not-show-a-difference-between-no-trades-and-a-zero-price\" style=\"position:relative;\"><a href=\"#l-19-pricesaverageprice-does-not-show-a-difference-between-no-trades-and-a-zero-price\" aria-label=\"l 19 pricesaverageprice does not show a difference between no trades and a zero price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/139\">[L-19] <code>Prices.averagePrice</code> does not show a difference between no trades and a zero price</a></h2>\n<p><em>Submitted by shw</em></p>\n<p>The <code>getHourlyAvgTracerPrice</code> and <code>getHourlyAvgOraclePrice</code> functions in <code>Pricing</code> return 0 if there is no trade during the given <code>hour</code> because of the design of <code>averagePrice</code>, which could mislead users that the hourly average price is 0. The same problem happens when emitting the old hourly average in the <code>recordTrade</code> function. See <code>Pricing.sol</code> <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Pricing.sol#L254-L256\">L254-L256</a>, <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Pricing.sol#L262-L264\">L262-L264</a>, and <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Pricing.sol#L74\">L74</a>.</p>\n<p>Recommend returning a special value (e.g., <code>type(uint256).max</code>) from <code>averagePrice</code> if there is no trade during the specified hour to distinguish from an actual zero price. Handle this particular value whenever the <code>averagePrice</code> function is called by others.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/139\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-20-margin-value-is-not-checked-to-be-non-negative-in-leveragednotionalvalue\" style=\"position:relative;\"><a href=\"#l-20-margin-value-is-not-checked-to-be-non-negative-in-leveragednotionalvalue\" aria-label=\"l 20 margin value is not checked to be non negative in leveragednotionalvalue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/141\">[L-20] Margin value is not checked to be non-negative in <code>leveragedNotionalValue</code></a></h2>\n<p><em>Submitted by shw</em></p>\n<p>The <code>leveragedNotionalValue</code> function of <code>LibBalance</code> gets the margin value of a position (i.e., the <code>marginValue</code> variable) to calculate the notional value. However, the position’s margin value is not checked to be non-negative. Margin with a value less than zero is considered invalid and should be specially handled. <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibBalances.sol#L80\">L80</a> in <code>LibBalances.sol</code>.</p>\n<p>Recommend checking whether <code>marginValue</code> is less than zero and handle this case.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/141#issuecomment-882197605\">OsmanBran acknowledged</a>:</strong></p>\n<blockquote>\n<p>Although in a normal state marginValue should not be negative (due to being liquidated prior to this), this function should still handle negative values for marginValue and result in valid calculations. Reverting the function due to negative margin values will cause undesirable side-effects in the system.</p>\n</blockquote>\n<h2 id=\"l-21-the-currenthour-variable-in-pricing-could-be-out-of-sync\" style=\"position:relative;\"><a href=\"#l-21-the-currenthour-variable-in-pricing-could-be-out-of-sync\" aria-label=\"l 21 the currenthour variable in pricing could be out of sync permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/142\">[L-21] The <code>currentHour</code> variable in <code>Pricing</code> could be out of sync</a></h2>\n<p><em>Submitted by shw</em></p>\n<p>The <code>recordTrade</code> function in <code>Pricing</code> updates the <code>currentHour</code> variable by 1 every hour. However, if there is no trade (i.e., the <code>recordTrade</code> is not called) during this hour, the <code>currentHour</code> is out of sync with the actual hour. As a result, the <code>averagePriceForPeriod</code> function uses the prices before 24 hours and causes errors on the average price. See <code>Pricing.sol</code>  <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Pricing.sol#L90-L94\">L90-L94</a>.</p>\n<p>Recommend calculating how much time passed (e.g., <code>(block.timestamp - startLastHour) / 3600</code>) to update the <code>currentHour</code> variable correctly.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/142\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-22-potential-out-of-gas-exception-due-to-unbounded-loop\" style=\"position:relative;\"><a href=\"#l-22-potential-out-of-gas-exception-due-to-unbounded-loop\" aria-label=\"l 22 potential out of gas exception due to unbounded loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/69\">[L-22] Potential Out-of-Gas exception due to unbounded loop</a></h2>\n<p><em>Submitted by 0xRajeev</em></p>\n<p>Trading function <code>executeTrade()</code> batch executes maker/taker orders against a market. The trader/interface provides arrays of makers/takers which is unbounded. As a result, if the number of orders is too many, there is a risk of this transaction exceeding the block gas limit (which is 15 million currently). See <code>Trader.sol</code> <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Trader.sol#L67\">L67</a> and <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Trader.sol#L78\">L78</a></p>\n<p>The impact is that if <code>executeTrade()</code> is called with too many orders in the batch, the transaction might exceed block gas limit and revert, resulting in none of the orders are executed.</p>\n<p>See similar medium-severity finding from <a href=\"https://consensys.net/diligence/audits/2020/12/growth-defi-v1/#potential-resource-exhaustion-by-external-calls-performed-within-an-unbounded-loop\">ConsenSys’s Audit of Growth DeFi</a>.</p>\n<p>Recommend limiting the number or orders executed based on <code>gasleft()</code> after every iteration, or estimating the gas cost and enforcing an upper bound on the number of orders allowed in maker/taker arrays.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/69\">raymogg (Tracer) confirmed</a></strong></p>\n<h2 id=\"l-23-using-array-memory-parameter-without-checking-its-length-\" style=\"position:relative;\"><a href=\"#l-23-using-array-memory-parameter-without-checking-its-length-\" aria-label=\"l 23 using array memory parameter without checking its length  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/35\">[L-23] Using array memory parameter without checking its length </a></h2>\n<p><em>Submitted by JMukesh</em></p>\n<p>These array memory parameters can be  problematic if not used properly. For example, if the array is very large, it may overlap over other part of memory (<code>Liquidation.sol</code> <a href=\"https://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Liquidation.sol#L274\">L274</a>).</p>\n<p>This an example to show the exploit:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// based on https://github.com/paradigm-operations/paradigm-ctf-2021/blob/master/swap/private/Exploit.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.4</span><span class=\"mtk1\">.</span><span class=\"mtk7\">24</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// only works with low solidity version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">test</span><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Overlap</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">field0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// this can be in any solidity version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Overlap</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">v</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">v</span><span class=\"mtk1\">.</span><span class=\"mtk12\">field0</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1234</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]); </span><span class=\"mtk3\">// would expect to be 0 however is 1234</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">go</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> { </span><span class=\"mtk3\">// this part requires the low solidity version</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">x</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0x800000000000000000000000000000000000000000000000000000000000000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 2^251</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payload</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">mint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0x20</span><span class=\"mtk1\">, </span><span class=\"mtk12\">x</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">=</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">).</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk12\">payload</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Recommend checking array length before using it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/35#issuecomment-874362760\">raymogg (Tracer) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of #79</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/35#issuecomment-875179515\">sporejack (Tracer) commented</a>:</strong></p>\n<blockquote>\n<p>So the provided PoC code works (under <code>solc</code> 0.4.24) subject to test case:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">expect</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;chai&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Overlap&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;go&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">overlapFactory</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">overlap</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">before</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">overlapFactory</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractFactory</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Overlap&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">overlap</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">overlapFactory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">overlap</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deployed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">context</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;When called&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Emits `log` event with correct value&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">var</span><span class=\"mtk1\"> </span><span class=\"mtk12\">firstAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">BigNumber</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;1234&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">overlap</span><span class=\"mtk1\">.</span><span class=\"mtk11\">go</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">emit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">overlap</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;log&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk11\">withArgs</span><span class=\"mtk1\">(</span><span class=\"mtk12\">firstAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/35#issuecomment-875180758\">sporejack (Tracer) confirmed</a>:</strong></p>\n<blockquote>\n<p>My assessment is:</p>\n<table>\n<thead>\n<tr>\n<th>Impact</th>\n<th>Difficulty</th>\n<th>Overall</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Low</td>\n<td>Low</td>\n<td>Low</td>\n</tr>\n</tbody>\n</table>\n<p>With rationale:</p>\n<ul>\n<li>Unclear (<em>a priori</em>) exactly <em>how</em> PoC constitutes an exploit</li>\n<li>PoC payload will likely cause unexpected behaviour in production codebase</li>\n<li>Relatively easy for adversary to craft viable payload (simple overflow)</li>\n</ul>\n</blockquote>\n<h2 id=\"l-24-wrong-token-approval\" style=\"position:relative;\"><a href=\"#l-24-wrong-token-approval\" aria-label=\"l 24 wrong token approval permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/99\">[L-24] Wrong token approval</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The pool holdings of <code>Insurance</code> (<code>publicCollateralAmount</code> and <code>bufferCollateralAmount</code>) is in WAD (18 decimals) but it’s used as a raw token value in <code>drainPool</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// amount is a mix of pool holdings, i.e., 18 decimals</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// this requires amount to be in RAW! if tracerMarginToken has &gt; 18 decimals, it&#39;ll break, &lt; 18 decimals will approve too much</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">tracerMarginToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tracer</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// this requires amount to be in WAD which is correct</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">tracer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>If <code>tracerMarginToken</code> has less than 18 decimals, the approval approves orders of magnitude more tokens than required for the <code>deposit</code> call that follows.\nIf <code>tracerMarginToken</code> has more than 18 decimals, the <code>deposit</code> that follows would fail as fewer tokens were approved, but the protocol seems to disallow tokens in general with more than 18 decimals.</p>\n<p>Recommend converting the <code>amount</code> to a “raw token value” and approve this one instead.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/99#issuecomment-873757790\">raymogg (Tracer) confirmed but disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>The issue is correct in pointing out that the wrong approve amount is used, however disagree with the severity.</p>\n<p>It is common practice to approve the maximum amount of tokens for a contract to spend already. This bug simply allows more tokens to be approved (to a trusted contract in the system), than was intended. This is only exploitable if paired with another bug in the Tracer contracts. As is, no users would be affected.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/99#issuecomment-882120601\">cemozerr (Judge) lowered severity from 2 to 1</a>:</strong></p>\n<blockquote>\n<p>Marking this as low-risk as it would only pose a security threat coupled with another bug.</p>\n</blockquote>\n<h1 id=\"non-critical-findings-20\" style=\"position:relative;\"><a href=\"#non-critical-findings-20\" aria-label=\"non critical findings 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (20)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/117\">[N-01] Missing checks for <code>lowestMaxLeverage</code> &#x3C; <code>maxLeverage</code> and <code>insurancePoolSwitchStage</code> &#x3C; <code>deleveragingCliff</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/121\">[N-02] Superfluous <code>verifySignature</code> function</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/122\">[N-03] State variable not used</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/128\">[N-04] Change <code>claimEscrow()</code> to external</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/10\">[N-05] Only one constructor with an emit</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/14\">[N-06] Use constants for numbers</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/15\">[N-07] alternative solidity coding</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/16\">[N-08] Comment for formula <code>calcEscrowLiquidationAmount</code> different than code</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/18\">[N-09] Comment in <code>partialLiquidationIsValid</code> misleading</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/25\">[N-10] use try catch</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/26\">[N-11] Comment in <code>claimEscrow</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/29\">[N-12] Use immutable keyword29</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/75\">[N-13] Close-ended time ranges may confuse users/interfaces</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/118\">[N-14] Unnecessary type conversions</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/78\">[N-15] <code>setDecimals</code> can be set by anyone and not used</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/63\">[N-16] Event log poisoning/griefing in <code>withdrawFees()</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/107\">[N-17] <code>claimEscrow</code> with not yet existing id</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/47\">[N-18] orders and <code>orderToSig</code> mappings</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/61\">[N-19] Dangerous use of storage data location specifier</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/79\">[N-20] Missing length check on array could lead to undefined behavior</a></li>\n</ul>\n<h1 id=\"gas-optimizations-12\" style=\"position:relative;\"><a href=\"#gas-optimizations-12\" aria-label=\"gas optimizations 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (12)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/125\">[G-01] Gas savings in <code>getPoolFundingRate()</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/131\">[G-02] Gas savings in <code>verifyAndSubmitLiquidation()</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/38\">[G-03] Unused State variable</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/40\">[G-04] state variable which can be declared as immutable</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/62\">[G-05] function which can declared as external </a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/120\">[G-06] Use EIP-1167 in order to deploy new perpetual swap contracts</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/24\">[G-07] Variables that can be converted into immutables</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/36\">[G-08] [Gas] Change some function parameters from <code>memory</code> to <code>calldata</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/37\">[G-09] [Gas] Use at least 0.8.0 instead of 0.8.4</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/108\">[G-10] <code>amountToReturn</code> > <code>receipt.escrowedAmount</code> could be inclusive</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/50\">[G-11] recalculation of 10**18</a></li>\n<li><a href=\"https://github.com/code-423n4/2021-06-tracer-findings/issues/52\">[G-12] <code>executionPrice</code>, <code>newMakeAverage</code> and <code>newTakeAverage</code> before calling the market</a></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings\">High Risk Findings</a></p>\n<ul>\n<li><a href=\"#h-01-wrong-trading-pricing-calculations\">[H-01] Wrong trading pricing calculations</a></li>\n<li><a href=\"#h-02-use-of-incorrect-index-leads-to-incorrect-updation-of-funding-rates\">[H-02] Use of incorrect index leads to incorrect updation of funding rates</a></li>\n<li><a href=\"#h-03-malicious-owner-can-drain-the-market-at-any-time-using-safetywithdraw\">[H-03] Malicious owner can drain the market at any time using <code>SafetyWithdraw</code></a></li>\n<li><a href=\"#h-04-logic-error-in-fee-subtraction\">[H-04] Logic error in fee subtraction</a></li>\n<li><a href=\"#h-05-insurance-slippage-reimbursement-can-be-used-to-steal-insurance-fund\">[H-05] Insurance slippage reimbursement can be used to steal insurance fund</a></li>\n<li><a href=\"#h-06-wrong-price-scale-for-gasoracle\">[H-06] Wrong price scale for <code>GasOracle</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings\">Medium Risk Findings</a></p>\n<ul>\n<li><a href=\"#m-01-use-of-deprecated-chainlink-api\">[M-01] Use of deprecated Chainlink API</a></li>\n<li><a href=\"#m-02-no-check-transferfrom-return-value\">[M-02] No check <code>transferFrom()</code> return value</a></li>\n<li><a href=\"#m-03-deflationary-tokens-are-not-supported\">[M-03] Deflationary tokens are not supported</a></li>\n<li><a href=\"#m-04-underflow-problems-occurring-when-a-token-has-18-decimals\">[M-04] Underflow problems occurring when a token has >18 decimals</a></li>\n<li><a href=\"#m-05-add-reentrancy-protections-on-function-executetrade\">[M-05] Add reentrancy protections on function <code>executeTrade</code></a></li>\n<li><a href=\"#m-06-single-step-process-for-critical-ownership-transfer\">[M-06] Single-step process for critical ownership transfer</a></li>\n<li><a href=\"#m-07-malicious-owner-can-arbitrarily-change-fee-to-any--value\">[M-07] Malicious owner can arbitrarily change fee to any % value</a></li>\n<li><a href=\"#m-08-missing-events-for-critical-parameter-changing-operations-by-owner\">[M-08] Missing events for critical parameter changing operations by owner</a></li>\n<li><a href=\"#m-09-wrong-funding-index-in-settle-when-no-base\">[M-09] Wrong funding index in settle when no base?</a></li>\n<li><a href=\"#m-10-prb-math-not-audited\">[M-10] <code>prb-math</code> not audited</a></li>\n<li><a href=\"#m-11-claim-liquidation-escrow\">[M-11] Claim liquidation escrow</a></li>\n<li><a href=\"#m-12-avoid-paying-insurance\">[M-12] avoid paying insurance</a></li>\n<li><a href=\"#m-13-trader-orders-can-be-front-run-and-users-can-be-denied-from-trading\">[M-13] Trader orders can be front-run and users can be denied from trading</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-findings\">Low Risk Findings</a></p>\n<ul>\n<li><a href=\"#l-01-zero-address-checks-are-missing\">[L-01] Zero-address checks are missing</a></li>\n<li><a href=\"#l-02-can-set-values-to-more-than-100\">[L-02] Can set values to more than 100%</a></li>\n<li><a href=\"#l-03-liquidationgascost-may-not-be-a-constant\">[L-03] LIQUIDATION<em>GAS</em>COST may not be a constant</a></li>\n<li><a href=\"#l-04-deposit-event-should-use-the-converted-wad-amount\">[L-04] <code>Deposit</code> event should use the converted WAD amount</a></li>\n<li><a href=\"#l-05-tvl-calculation-in-withdraw-should-use-convertedwadamount-instead-of-amount\">[L-05] TVL calculation in <code>withdraw()</code> should use <code>convertedWadAmount</code> instead of <code>amount</code></a></li>\n<li><a href=\"#l-06-lack-of-a-contract-existence-check-may-lead-to-undefined-behavior\">[L-06] Lack of a contract existence check may lead to undefined behavior</a></li>\n<li><a href=\"#l-07-using-txgasprice-to-prevent-front-running-may-lead-to-failed-liquidations\">[L-07] Using <code>tx.gasprice</code> to prevent front-running may lead to failed liquidations</a></li>\n<li><a href=\"#l-08-potential-division-by-zero\">[L-08] Potential division by zero</a></li>\n<li><a href=\"#l-09-unlocked-pragma-used-in-multiple-contracts\">[L-09] Unlocked pragma used in multiple contracts</a></li>\n<li><a href=\"#l-10-libmath-fails-implicitly\">[L-10] <code>LibMath</code> fails implicitly</a></li>\n<li><a href=\"#l-11-libmathsumn-can-iterate-over-array\">[L-11] <code>LibMath.sumN</code> can iterate over array</a></li>\n<li><a href=\"#l-12-todos-left-in-the-code\">[L-12] todos left in the code</a></li>\n<li><a href=\"#l-13-check-sign-in-calculateslippage\">[L-13] check sign in <code>calculateSlippage</code></a></li>\n<li><a href=\"#l-14-the-averagepriceforperiod-function-may-revert-without-proper-error-message-returned\">[L-14] The <code>averagePriceForPeriod</code> function may revert without proper error message returned</a></li>\n<li><a href=\"#l-15-make-sure-withdrawfees-always-can-withdraw\">[L-15] make sure <code>withdrawFees</code> always can withdraw</a></li>\n<li><a href=\"#l-16-matchorders-couldshould-check-market\">[L-16] <code>matchOrders</code> could/should check market</a></li>\n<li><a href=\"#l-17-inclusive-check-that-account-is-not-above-minimum-margin\">[L-17] inclusive check that account is not above minimum margin</a></li>\n<li><a href=\"#l-18-hardcoded-chainid\">[L-18] hardcoded <code>chainID</code></a></li>\n<li><a href=\"#l-19-pricesaverageprice-does-not-show-a-difference-between-no-trades-and-a-zero-price\">[L-19] <code>Prices.averagePrice</code> does not show a difference between no trades and a zero price</a></li>\n<li><a href=\"#l-20-margin-value-is-not-checked-to-be-non-negative-in-leveragednotionalvalue\">[L-20] Margin value is not checked to be non-negative in <code>leveragedNotionalValue</code></a></li>\n<li><a href=\"#l-21-the-currenthour-variable-in-pricing-could-be-out-of-sync\">[L-21] The <code>currentHour</code> variable in <code>Pricing</code> could be out of sync</a></li>\n<li><a href=\"#l-22-potential-out-of-gas-exception-due-to-unbounded-loop\">[L-22] Potential Out-of-Gas exception due to unbounded loop</a></li>\n<li><a href=\"#l-23-using-array-memory-parameter-without-checking-its-length-\">[L-23] Using array memory parameter without checking its length </a></li>\n<li><a href=\"#l-24-wrong-token-approval\">[L-24] Wrong token approval</a></li>\n</ul>\n</li>\n<li><a href=\"#non-critical-findings-20\">Non-Critical Findings (20)</a></li>\n<li><a href=\"#gas-optimizations-12\">Gas Optimizations (12)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode 432n4 (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of the Tracer smart contract system written in Solidity. The code contest took place between June 23—June 30, 2021.\n\n## Wardens\n\n12 Wardens contributed reports to the Tracer code contest:\n\n- [0xsanson](https://github.com/0xsanson)\n- [shw](https://github.com/x9453)\n- [0xRajeev](https://twitter.com/0xRajeev)\n- [pauliax](https://twitter.com/SolidityDev)\n- [gpersoon](https://twitter.com/gpersoon)\n- [cmichel](https://twitter.com/cmichelio)\n- [a_delamo](https://twitter.com/a_delamo)\n- [Jmukesh](https://twitter.com/MukeshJ_eth)\n- [Lucius](https://github.com/0xsanson)\n- [s1m0](https://twitter.com/_smonica_)\n- [tensors](https://twitter.com/Tensors8)\n- [hrkrshnn](https://twitter.com/_hrkrshnn)\n\nThis contest was judged by [cemozerr](http://twitter.com/cemozer_).\n\nFinal report assembled by [ninek](https://twitter.com/_ninek_) and [moneylegobatman](https://twitter.com/money_lego).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 43 unique vulnerabilities. All of the issues presented here are linked back to their original finding\n\nOf these vulnerabilities, 6 received a risk rating in the category of HIGH severity, 13 received a risk rating in the category of MEDIUM severity, and 24 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 32 non-critical recommendations.\n\n# Scope\n\nThe code under review can be found within the [C4 Tracer code contest repository](https://github.com/code-423n4/2021-06-tracer) is comprised of 44 smart contracts written in the Solidity programming language and includes 2,453 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings\n\n## [[H-01] Wrong trading pricing calculations](https://github.com/code-423n4/2021-06-tracer-findings/issues/119)\n_Submitted by 0xsanson, also found by shw_\n\nIn the `Pricing` contract, an agent can manipulate the trading prices by spamming a high amount of trades.\n\nIndeed an agent can create a high amount of orders at an arbitrary price and with a near-zero amount (so the agent doesn't even need large funds); next he/she pairs the orders with another account and calls `Trader.executeTrade`; now every order calls a `Pricing.recordTrade` using the arbitrary price set by the agent.\n\nSince the trades are all made in the same hour, by the way `hourlyTracerPrices[currentHour]` is calculated, it skews the average price towards the price set by the agent. This arbitrary value is used to calculate the `fundingRates` and the `fairPrice`, allowing a malicious agent the ability to manipulate the market.\n\nRecommend passing the `fillAmount` parameter to `recordTrade(...)`, and calculate `hourlyTracerPrices[currentHour].trades` summing `fillAmount` instead of 1 every trade.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/119#issuecomment-873747695):**\n > Issue is valid, and there appear to be a few other issues that reference similar problems.\n>\n> The Trader contract will have a whitelist allowing only select relayers to push orders on chain. As long as off chain order books have sufficient liquidity, this issue is then mitigated as users can't just arbitrarily match orders and send them in, they must be matched on a book with liquidity. To alter the price you would then need to eat through significant liquidity (increasing the cost of this attack).\n\n\n## [[H-02] Use of incorrect index leads to incorrect updation of funding rates](https://github.com/code-423n4/2021-06-tracer-findings/issues/74)\n_Submitted by 0xRajeev_\n\nThe `updateFundingRate()` function updates the funding rate and insurance funding rate. While the instant/new funding rates are calculated correctly, the cumulative funding rate calculation is incorrect because it is always adding the instant to 0, not the previous value. This is due to the use of `[currentFundingIndex]` which has been updated since the previous call to this function while it should really be using `[currentFundingIndex-1]` to reference the previous funding rate.\n\nThe impact of this, is that the cumulative funding rate and insurance funding rates are calculated incorrectly without considering the correct previous values. This affects the settling of accounts across the entire protocol. The protocol logic is significantly impacted, accounts will not be settled as expected, protocol shutdown and contracts will need to be redeployed. Users may lose funds and the protocol takes a reputation hit.\n\nRecommend using `[currentFundingIndex-1]` for non-zero values of `currentFundingIndex` to get the value updated in the previous call on lines L155 and L159 of `Pricing.sol`.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/74#issuecomment-873752562):**\n > Confirmed as an index issue with funding rate 👍\n\n\n## [[H-03] Malicious owner can drain the market at any time using `SafetyWithdraw`](https://github.com/code-423n4/2021-06-tracer-findings/issues/81)\n_Submitted by 0xRajeev, also found by pauliax and gpersoon_\n\nThe `withdrawERC20Token()` in `SafetyWithdraw` inherited in `TracerPerpetualSwaps` is presumably a guarded launch emergency withdrawal mechanism. However, given the trust model where the market creator/owner is potentially untrusted/malicious, this is a dangerous approach to emergency withdrawal in the context of guarded launch.\n\nAlternatively, if this is meant for the owner to withdraw “external” ERC20 tokens mistakenly deposited to the Tracer market, then the function should exclude `tracerQuoteToken` from being the `tokenAddress` that can be used as a parameter to `withdrawERC20Token()`.\n\nThe impact of this is that, if a malicious owner of a market withdraws/rugs all `tracerQuoteToken`s deposited at any time after market launch, all users lose deposits and the protocol takes a reputational hit and has to refund the users from treasury.\n\nTherefor, it is recommended that, for a guarded launch circuit breaker, design a pause/unpause feature where deposits are paused (in emergency situations) but withdrawals are allowed by the depositors themselves instead of the owner. Alternatively, if this is meant to be for removing external ERC20 tokens accidentally deposited to market, exclude the `tracerQuoteToken` from being given as the `tokenAddress`.\n\n**[raymogg (Tracer) confirmed but suggested a severity of 2 ](https://github.com/code-423n4/2021-06-tracer-findings/issues/81#issuecomment-873752133):**\n > The only reason for the dispute on severity is that as part of the security model, the owner can manipulate the market in other ways (such as changing the oracle being used), so this trust assumption over the owner already exists. For this reason the team thinks this issue is closer to a medium\n>\n> This however is a good issue as it is not the greatest circuit breaking mechanism, and as noted in #7 can reflect badly on the project without the exploit being used. The mechanism is being removed and replaced with more structured circuit breaker.\n\n**[cemozerr (Judge) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/81#issuecomment-882110087):**\n > Marking this as high risk, as regardless of the owner manipulating in other ways, the threat persists.\n\n## [[H-04] Logic error in fee subtraction](https://github.com/code-423n4/2021-06-tracer-findings/issues/127)\n_Submitted by 0xsanson_\n\nIn `LibBalances.applyTrade()`, we need to collect a fee from the trade. However, the current code subtracts a fee from the short position and adds it to the long. The correct implementation is to subtract a fee to both (see `TracerPerpetualSwaps.sol` L272).\nThis issue causes withdrawals problems, since Tracer thinks it can withdraw the collect fees, leaving the users with an incorrect amount of quote tokens.\n\nRecommend changing `+fee` to `-fee` in the [highlighted line](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibBalances.sol#L187).\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/127#issuecomment-873778933):**\n > Valid issue 👍\n\n## [[H-05] Insurance slippage reimbursement can be used to steal insurance fund](https://github.com/code-423n4/2021-06-tracer-findings/issues/105)\n_Submitted by cmichel_\n\nThe `Liquidation` contract allows the liquidator to submit \"bad\" trade orders and the insurance reimburses them from the insurance fund, see `Liquidation.claimReceipt`.\nThe function can be called with an `orders` array, which does not check for duplicate orders.\nAn attacker can abuse this to make a profit by liquidating themselves, making a small bad trade and repeatedly submitting this bad trade for slippage reimbursement.\n\n**Example**:\n- Attacker uses two accounts, one as the liquidator and one as the liquidatee.\n- They run some high-leverage trades such that the liquidatee gets liquidated with the next price update. (If not cash out and make a profit this way through trading, and try again.)\n- Liquidator liquidates liquidatee\n- They now do two trades:\n  - One \"good\" trade at the market price that fills 99% of the liquidation amount. The slippage protection should not kick in for this trade\n  - One \"bad\" trade at a horrible market price that fills only 1% of the liquidation amount. This way the slippage protection kicks in for this trade\n- The liquidator now calls `claimReceipt(orders)` where `orders` is an array that contains many duplicates of the \"bad\" trade, for example 100 times. The `calcUnitsSold` function will return `unitsSold = receipt.amountLiquidated` and a bad `avgPrice`. They are now reimbursed the price difference on the full liquidation amount (instead of only on 1% of it) making an overall profit\n\nThis can be repeated until the insurance fund is drained.\n\nThe attacker has an incentive to do this attack as it's profitable and the insurance fund will be completely drained.\n\nRecommend disallowing duplicate orders in the `orders` argument of `claimReceipt`. This should make the attack at least unprofitable, but it could still be a griefing attack.\nA quick way to ensure that `orders` does not contain duplicates is by having liquidators submit the orders in a sorted way (by order ID) and then checking in the `calcUnitsSold` `for` loop that the current order ID is strictly greater than the previous one.\n\n**[BenjaminPatch (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/105#issuecomment-873780483):**\n > Valid issue. The recommended mitigation step would also work. :+1:\n\n\n## [[H-06] Wrong price scale for `GasOracle`](https://github.com/code-423n4/2021-06-tracer-findings/issues/93)\n_Submitted by cmichel_\n\nThe `GasOracle` uses two chainlink oracles (GAS in ETH with some decimals, USD per ETH with some decimals) and multiplies their raw return values to get the gas price in USD.\n\nHowever, the scaling depends on the underlying decimals of the two oracles and could be anything.\nBut the code assumes it's in 18 decimals.\n\n> \"Returned value is USD/Gas * 10^18 for compatibility with rest of calculations\"\n\nThere is a `toWad` function that seems to involve scaling but it is never used.\n\nThe impact is that, If the scale is wrong, the gas price can be heavily inflated or under-reported.\n\nRecommend checking `chainlink.decimals()` to know the decimals of the oracle answers and scale the answers to 18 decimals such that no matter the decimals of the underlying oracles, the `latestAnswer` function always returns the answer in 18 decimals.\n\n**[raymogg (Tracer) confirmed and disagreed with severity](https://github.com/code-423n4/2021-06-tracer-findings/issues/93#issuecomment-873750451):**\n > Disagree with severity as while the statement that the underlying decimals of the oracles could be anything, we will be using production Chainlink feeds for which the decimals are known at the time of deploy.\n>\n> This is still however an issue as you don't want someone using different oracles (eg non Chainlink) that have different underlying decimals and not realising that this contract will not support that.\n\n**[cemozerr (Judge) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/93#issuecomment-882123137):**\n > Marking this a high-risk issue as it poses a big threat to users deploying their own markets\n\n# Medium Risk Findings\n\n## [[M-01] Use of deprecated Chainlink API](https://github.com/code-423n4/2021-06-tracer-findings/issues/73)\n_Submitted by 0xRajeev, also found by a_delamo, cmichel and shw_\n\nThe contracts use Chainlink’s deprecated API `latestAnswer()`. Such functions might suddenly stop working if Chainlink stopped supporting deprecated APIs.\n\nThe impact is that, if the deprecated API stops working, prices cannot be obtained, the protocol stops and contracts have to be redeployed.\n\nRecommend using V3 [interface functions](https://docs.chain.link/docs/price-feeds-api-reference/).\n\n**[raymogg (Tracer) confirmed in a separate issue](https://github.com/code-423n4/2021-06-tracer-findings/issues/145)**\n\n## [[M-02] No check `transferFrom()` return value](https://github.com/code-423n4/2021-06-tracer-findings/issues/115)\n_Submitted by s1m0, also found by pauliax, shw, 0xRajeev, JMukesh, Lucius and cmichel_\n\nThe smart contract doesn't check the return value of `token.transfer()` and `token.transferFrom()`, some erc20 token might not revert in case of error but return false.\nIn the [TracerPerpetualSwaps:deposit](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/TracerPerpetualSwaps.sol#L151) and [Insurance:deposit](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Insurance.sol#L51) this would allow a user to deposit for free. See issue page for other places.\n\nRecommend wrapping the call into a `require()` or using openzeppelin's [SafeERC20 library](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol).\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/115)**\n\n## [[M-03] Deflationary tokens are not supported](https://github.com/code-423n4/2021-06-tracer-findings/issues/104)\n_Submitted by cmichel, also found by s1m0 and 0xRajeev_\n\nThere are ERC20 tokens that may make certain customizations to their ERC20 contracts.\nOne type of these tokens is deflationary tokens that charge a certain fee for every `transfer()` or `transferFrom()`.\n\nThe `deposit()` functions of `Insurance` and `TracerPerpetualSwaps` assume that the external ERC20 balance of the contract increases by the same amount as the `amount` parameter of the `transferFrom`.\n\nThe user is credited the full amount without the taxes (`userBalance.position.quote`).\n\nRecommend as one possible mitigation, measuring the asset change right before and after the asset-transferring functions.\n\n**[raymogg (Tracer) confirmed but disagreed with severity](https://github.com/code-423n4/2021-06-tracer-findings/issues/104#issuecomment-873757118):**\n > Most likely not a medium risk as you can do a lot more nasty things than just use rebasing tokens. Since the owner of a market can set their own quote token, this token could be a token they control the supply of allowing them to arbitrarily transfer tokens between accounts, etc.\n>\n> As such, this sort of falls outside of our trust model. Market creators should use tokens that behave as \"standard\" ERC20s. We will make a not that rebasing and deflationary tokens should not be used as quote tokens without weird behaviour.\n>\n> Would be better as a low or informational issue due to this.\n\n**[cemozerr (Judge) downgraded severity from 2 to 1](https://github.com/code-423n4/2021-06-tracer-findings/issues/104#issuecomment-882104304):**\n > Marking this as low risk as it seems to fall outside of the trust model, yet important enough to communicate to users explicitly.\n\n## [[M-04] Underflow problems occurring when a token has >18 decimals](https://github.com/code-423n4/2021-06-tracer-findings/issues/116)\n_Submitted by tensors, also found by s1m0_\n\nThe contracts assume that all tokens will have <=18 decimals. This isn't necessarily a problem if the Tracer team is the only people deploying the contracts and they keep it in mind. But, If the contracts are to be deployed by other people, this assumption should be made explicit and hard-coded.\n\nWe can see that the scaler computations will underflow and be defined when it should not be In [L220-L232](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibBalances.sol#L220-L232).\n\nRecommend writing a require check that ensures `tokenDecimals <= 18` before running the above functions.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/116#issuecomment-873755853):**\n > Valid issue and makes sense as a medium.\n>\n> Suggested mitigation will be implemented.\n\n## [[M-05] Add reentrancy protections on function `executeTrade`](https://github.com/code-423n4/2021-06-tracer-findings/issues/143)\n_Submitted by shw, also found by 0xRajeev_\n\nAs written in the to-do comments, reentrancy could happen in the `executeTrade` function of `Trader` since the `makeOrder.market` can be a user-controlled external contract. See [L121-L126](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Trader.sol#L121-L126) in `Trader.sol`.\n\nRecommend adding a reentrancy guard (e.g., the [implementation from OpenZeppelin](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol)) to prevent the users from reentering critical functions.\n\n**[raymogg (Tracer) disputed](https://github.com/code-423n4/2021-06-tracer-findings/issues/143#issuecomment-874405296):**\n > Disputing just as while this is important, its quite explicitly stated in the todo comment and as such is already known by the team as a potential issue.\n>\n> Realistically shouldn't be too much of a problem with whitelisting of the trader.\n\n**[cemozerr (Judge) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/143#issuecomment-882105114):**\n > Marking this as medium risk as, regardless of being noted by the team, still poses a security threat.\n\n**[OsmanBran (Tracer) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/143#issuecomment-874405296):**\n > Duplicate of [#72](https://github.com/code-423n4/2021-06-tracer-findings/issues/72)\n\n## [[M-06] Single-step process for critical ownership transfer](https://github.com/code-423n4/2021-06-tracer-findings/issues/43)\n_Submitted by 0xRajeev_\n\nThe `Tracer Perpetuals Factory` contract is arguably the most critical contract in the project given that it deploys all the markets. The ownership of this contract is transferred to `_governance address`, i.e. TracerDAO, in the constructor. This critical address transfer in one-step is very risky because it is irrecoverable from any mistakes.\n\nThe impact is that, if an incorrect address (e.g. one for which the private key is not known) is used accidentally, then it prevents the use of all the `onlyOwner()` functions forever, which includes the changing of various deployer contract addresses and market approvals. This use of an incorrect address may not even be immediately apparent given that these functions are probably not used immediately. When noticed, due to a failing `onlyOwner()` function call, it will force the redeployment of the `factory` contract and require appropriate changes and notifications for switching from the old to new address. This will diminish trust in markets and incur a significant reputational damage. See [issue page](https://github.com/code-423n4/2021-06-tracer-findings/issues/43) for proof of concept.\n\nRecommend retaining the deployer ownership in the constructor and then using a two-step address change to `_governance` address separately using setter functions:\n1) Approve a new address as a `pendingOwner`\n2) A transaction from the `pendingOwner` (TracerDAO) address claims the pending ownership change.\n\nThis mitigates risk because if an incorrect address is used in step (1), then it can be fixed by re-approving the correct address. Only after a correct address is used in step (1) can step (2) happen and complete the address/ownership change.\n\n**[raymogg (Tracer) acknowledged](https://github.com/code-423n4/2021-06-tracer-findings/issues/43#issuecomment-873762658):**\n > Correct that having the owner be set to a wrong address could be detrimental, however for the first deploy of the factory, this will be owned by the DAO and will be easy to validate on deployment.\n>\n> Subsequent ownership transfers will be done via DAO proposal, and will have many eyes across them (due to them being a public Tracer DAO proposal) before function execution happens.\n>\n> For this reason it seems like a lot of overhead to have a two step process for this. Not withstanding that the issue you mention could still be possible\n\n## [[M-07] Malicious owner can arbitrarily change fee to any % value](https://github.com/code-423n4/2021-06-tracer-findings/issues/66)\n_Submitted by 0xRajeev_\n\nThe Tracer protocol like any other allows market creators to charge fees for trades. However, a malicious/greedy owner can arbitrarily change fee to any % value and without an event to observe this change or a timelock to react, there is no easy way for users to monitor this via front-end or off-chain monitoring tools.\n\nThe impact is that, if the users are trading on a market with 0.1% fees and the owner suddenly changes this to 100%, the users realise this only after their trades are executed. Market loses confidence. Protocol takes a reputational hit.\n\nSee similar Medium-severity finding in [ConsenSys's Audit of 1inch Liquidity Protocol](https://consensys.net/diligence/audits/2020/12/1inch-liquidity-protocol/#unpredictable-behavior-for-users-due-to-admin-front-running-or-general-bad-timing)\n\nRecommend implementing an `Emit` event, and providing a timelock for users to react and establish an upper threshold for fees that is decided across markets by governance.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/66#issuecomment-873760964):**\n > Like the idea of having a timelock for any update parameter update that immediately affects traders\n\n## [[M-08] Missing events for critical parameter changing operations by owner](https://github.com/code-423n4/2021-06-tracer-findings/issues/64)\n_Submitted by 0xRajeev_\n\nThe owner of `TracerPerpetualSwaps` contract, who is potentially untrusted as per specification, can change the market critical parameters such as the addresses of the `Liquidation`/`Pricing`/`Insurance`/`GasOracle`/`FeeReceiver` and also critical values such as  `feeRate`, `maxLeverage`, `fundingRateSensitivity`, `deleveragingCliff`, `lowestMaxLeverage`, `insurancePoolSwitchStage` and whitelisting.\n\nNone of these setter functions emit events to record these changes on-chain for off-chain monitors/tools/interfaces to register the updates and react if necessary.\n\nThe impact of this is that, if a malicious owner changes the critical addresses or values that significantly change the security posture/perception of the protocol. No events are emitted and users lose funds/confidence. The protocol takes a reputation hit.\n\nSee similar high-severity finding in [OpenZeppelin’s Audit of Audius](https://blog.openzeppelin.com/audius-contracts-audit/#high) and medium-severity finding [OpenZeppelin’s Audit of UMA Phase 4](https://blog.openzeppelin.com/uma-audit-phase-4/).\n\nRecommend to consider emitting events when these addresses/values are updated. This will be more transparent and it will make it easier to keep track of the status of the system.\n\n**[raymogg (Tracer) marked as duplicate of another (confirmed issue)](https://github.com/code-423n4/2021-06-tracer-findings/issues/64#issuecomment-873760825):**\n > Duplicate of #66\n\n**[cemozerr (Judge) reopened and removed duplicate label](https://github.com/code-423n4/2021-06-tracer-findings/issues/64#issuecomment-882106845):**\n > Opening this issue as the event emission seems to be separate from the arbitrarily changing of the values.\n\n## [[M-09] Wrong funding index in settle when no base?](https://github.com/code-423n4/2021-06-tracer-findings/issues/106)\n_Submitted by cmichel_\n\nThe `TracerPerpetualSwaps.settle` function updates the user's last index to `currentGlobalFundingIndex`, however a comment states:\n\n> \"// Note: global rates reference the last fully established rate (hence the -1), and not the current global rate. User rates reference the last saved user rate\"\n\nThe code for the `else` branch also updates the last index to `currentGlobalFundingIndex - 1` instead of `currentGlobalFundingIndex`.\n\n```solidity\nif (accountBalance.position.base == 0) {\n    // set to the last fully established index\n    // @audit shouldn't this be global - 1 like below?\n    accountBalance.lastUpdatedIndex = currentGlobalFundingIndex;\n    accountBalance.lastUpdatedGasPrice = IOracle(gasPriceOracle).latestAnswer();\n}\n```\n\nThe impact is that it might be possible for first-time depositors to skip having to pay the first funding rate period as the `accountLastUpdatedIndex + 1 < currentGlobalFundingIndex` check will still return `false` when the funding rates are updated the next time.\n\nRecommend to check if setting it to `currentGlobalFundingIndex` or to `currentGlobalFundingIndex - 1` is correct.\n\n**[raymogg (Tracer) confirmed but disagreed with severity](https://github.com/code-423n4/2021-06-tracer-findings/issues/106)**\n\n## [[M-10] `prb-math` not audited](https://github.com/code-423n4/2021-06-tracer-findings/issues/11)\n_Submitted by gpersoon_\n\nThe library [`prb-math` documents](// https://github.com/hifi-finance/prb-math#security) have not been audited by a security researcher.  This means its more risky to rely on this library.\n\nRecommend considering (crowdsourcing) an audit for `prb-math`.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/11)**\n\n## [[M-11] Claim liquidation escrow](https://github.com/code-423n4/2021-06-tracer-findings/issues/2)\n_Submitted by gpersoon_\n\nA liquidator can always claim the liquidation escrow in the following way:\n- create a second account\n- setup a complimentary trade in that second account, which will result in a large slippage when executed\n- call `executeTrade` (which everyone can call), to execute a trade between his own two accounts with a large slippage\n- the slippage doesn't hurt because the liquidator owns both accounts\n- call `claimReceipt` with the receiptId of the executed order, within the required period (e.g. 15 minutes)\n\n[L67](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Trader.sol#L67)\n```solidity\nfunction executeTrade(Types.SignedLimitOrder[] memory makers, Types.SignedLimitOrder[] memory takers) external override {\n```\n[L394](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Liquidation.sol#L394)\n```solidity\nfunction claimReceipt( uint256 receiptId, Perpetuals.Order[] memory orders, address traderContract) external override {\n```\n\nRecommend to perhaps limit who can call `executeTrade`.\n\n**[raymogg (Tracer) acknowledged and confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/2#issuecomment-873774429):**\n > Valid issue which would allow someone to get reimbursed for slippage against themselves.\n>\n> The Trader contract will have whitelisted relayers added to prevent issues like this (similar to #119)\n\n## [[M-12] avoid paying insurance](https://github.com/code-423n4/2021-06-tracer-findings/issues/30)\n_Submitted by gpersoon_\n\nIt's possible to avoid paying insurance in the following way:\n\n- once per hour (at the right moment), do the following:\n1. using a flash loan, or with a large amount of tokens, call `deposit` of `Insurance.sol` to make sure that the pool is sufficiently filled (`poolHoldings` > `poolTarget`)\n2. call the function `executeTrade` of Trader`.sol` with a minimal trade (possibly of value 0, see finding \"`executeTrade` with same trades\")\n3. `executeTrade` calls `matchOrders`, which calls `recordTrade`\n4. `recordTrade` calls `updateFundingRate()`;   (once per hour, so you have to be sure you do it in time before other trades trigger this)\n5. `updateFundingRate` calls `getPoolFundingRate`\n6. `getPoolFundingRate` determines the insurance rate, but because the insurance pool is sufficiently full (due to the flash loan), the rate is 0\n7. `updateFundingRate` stores the 0 rate via `setInsuranceFundingRate`  (which is used later on to calculate the amounts for the insurances)\n8. withdraw from the Insurance and pay back the flash loan\n\nThe insurance rates are 0 now and no-one pays insurance. The gas costs relative to the insurance costs + the flash loan fees determine if this is an economically viable attack. Otherwise it is still a grief attack.\nThis will probably be detected pretty soon because the insurance pool will stay empty. However its difficult to prevent.\n\nSee issue page for code referenced in proof of concept.\n\nRecommend setting a timelock on withdrawing insurance.\n\n**[raymogg (Tracer) confirmed but disagreed with severity](https://github.com/code-423n4/2021-06-tracer-findings/issues/30#issuecomment-873763520):**\n > Really like this exploit idea. Currently this is possible since the Trader is not whitelisted (eg there is no whitelisted relayer address). With this added, this exploit is no longer possible as only off chain relayers can place orders with the trader.\n>\n> Disagree with the severity mainly due to the fact that executing this exploit once would only cause insurance funding to not be paid for a single hour. For insurance funding to never be paid, you would have to time this transaction as the first transaction on each and every hour. This would quickly be noticed. The only affect on this would be insurance depositors miss interest payments for a few periods.\n\n**[cemozerr (Judge) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/30#issuecomment-882109332):**\n > Marking this as medium risk as a front-runner could keep doing this for not paying any funding using a bot.\n\n## [[M-13] Trader orders can be front-run and users can be denied from trading](https://github.com/code-423n4/2021-06-tracer-findings/issues/100)\n_Submitted by cmichel, also found by gpersoon and tensors_\n\nThe `Trader` contract accepts two signed orders and tries to match them. Once they are matched and become filled, they can therefore not be matched against other orders anymore.\n\nThis allows for a griefing attack where an attacker can deny any other user from trading by observing the mempool and front-running their trades by creating their own order and match it against the counter order instead.\n\nIn this way, a trader can be denied from trading. The cost of the griefing attack is that the trader has to match the order themselves, however depending on the liquidity of the order book and the spread, they might be able to do the counter-trade again afterwards, basically just paying the fees.\n\nIt could be useful if the attacker is a liquidator and is stopping a user who is close to liquidation from becoming liquid again.\n\nThis seems hard to circumvent in the current design. If the order book is also off-chain, the `executeTrade` could also be a bot-only function.\n\n**[raymogg (Tracer) disputed (in duplicate)](https://github.com/code-423n4/2021-06-tracer-findings/issues/123#issuecomment-873755673)**\n> Marked as a dispute as this is not really an issue. Tracer will initially maintain an off chain order book that is the entry point for users to make orders (and for market makers to interact with).\n>\n> Orders only get propagated on chain once they have been matched, and they will only be propagated on chain by whitelisted relayers. As such nobody can arbitrarily frontrun the orders with their own.\n\n**[cemozerr (Judge) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/123#issuecomment-882119567):**\n > Currently not seeing a whitelisted relayer functionality, so marking this a valid medium risk issue.\n\n# Low Risk Findings\n\n## [[L-01] Zero-address checks are missing](https://github.com/code-423n4/2021-06-tracer-findings/issues/49)\n_Submitted by 0xRajeev, also found by JMukesh, cmichel, gpersoon, pauliax and shw_\n\nZero-address checks are a best-practice for input validation of critical address parameters. While the codebase applies this to most addresses in setters, there are many places where this is missing in constructors and setters. Accidental use of zero-addresses may result in exceptions, burn fees/tokens or force redeployment of contracts.\n\nRecommend adding zero-address checks.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/49#issuecomment-874361310)**\n> Duplicate of [#136](https://github.com/code-423n4/2021-06-tracer-findings/issues/136)\n>\n> More issues brought up in this one, but falls under the general category of missing zero address checks\n\n## [[L-02] Can set values to more than 100%](https://github.com/code-423n4/2021-06-tracer-findings/issues/102)\n_Submitted by cmichel_\n\nThere are several setter functions that do not check if the amount is less than 100% including:\n\n- `TracerPerpetualSwaps`: `setFeeRate`, `setDeleveragingCliff`, `setInsurancePoolSwitchStage`\n- `Insurance`: `setFeeRate`, `setDeleveragingCliff`, `setInsurancePoolSwitchStage`\n\nThe impact is that setting values to more than 100% might lead to unintended functionality.\n\nRecommend ensuring that the parameters are less than 100%.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/102)**\n\n## [[L-03] LIQUIDATION_GAS_COST may not be a constant](https://github.com/code-423n4/2021-06-tracer-findings/issues/48)\n_Submitted by 0xRajeev, also found by cmichel and gpersoon_\n\nThe gas cost for liquidation may change if code is updated/optimized, the compiler is changed or profiling is improved. The developers may forget to update this constant in code. The impact is that the margin validity calculation, which uses this value, may be affected if this changes and hence is not as declared in the constant. This may adversely impact validation.\n\nBecause It is safer to make this a constructor-set immutable value that will force usage of an updated accurate value at deployment time.\n\nRecommend evaluating if the sensitivity to this value is great enough to justify a setter to change it if incorrectly initialized at deployment.\n\n**[raymogg (Tracer) confirmed in (duplicate issue)](https://github.com/code-423n4/2021-06-tracer-findings/issues/101)**\n\n\n## [[L-04] `Deposit` event should use the converted WAD amount](https://github.com/code-423n4/2021-06-tracer-findings/issues/56)\n_Submitted by 0xRajeev_\n\nThe `Deposit` event uses the function parameter amount instead of the `convertedWadAmount` which is what is used to update the user’s position and TVL because it prevents any dust deposited in amount. This will also make it consistent with the emit event in the `withdraw` function.\n\nThe impact is that the`Deposit` event amount reflects the value with dust while the user position does not. This may lead to confusion.\n\nRecommend using `uint256(convertedWadAmount)` instead of amount in `Deposit` event.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/56)**\n\n## [[L-05] TVL calculation in `withdraw()` should use `convertedWadAmount` instead of `amount`](https://github.com/code-423n4/2021-06-tracer-findings/issues/57)\n_Submitted by 0xRajeev_\n\nThe TVL calculation in `deposit()` uses `convertedWadAmount` but the one in `withdraw()` uses the parameter `amount`. While `amount` is still in WAD format, it may contain dust which is what the conversion to `rawTokenAmount` and then back to `convertedWadAmount` removes.\n\nThe impact of this is that use of `amount` in TVL during `withdraw()` will consider dust while the one in `deposit()` will not, which is inconsistent.\n\nRecommend using `convertedWadAmount` instead of `amount` to be consistent with the increment during `withdraw()` TVL calculation.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/57)**\n\n## [[L-06] Lack of a contract existence check may lead to undefined behavior](https://github.com/code-423n4/2021-06-tracer-findings/issues/71)\n_Submitted by 0xRajeev, also found by a_delamo and pauliax_\n\nLow-level calls `call`/`delegatecall`/`staticcall` return true even if the account called is non-existent (per EVM design).\n\nSolidity documentation warns:\n> \"The low-level functions `call`, `delegatecall` and `staticcall` return true as their first return value if the account called is non-existent, as part of the design of the EVM. Account existence must be checked prior to calling if needed.”\n\nMarket address may not exist as a contract (e.g. incorrect EOA address used in orders), in which case low-level calls still returns true/success. But the trade is assumed to have been successfully executed.\n\nAs a result, `executeTrade()` executes batch orders against a non-existing market contract due to a mistake in the trading interface. The transaction executes successfully without any side-effects because the market doesn’t exist. Internal accounting is updated incorrectly.\n\nSee related High-severity finding in [ToB’s Audit of Hermez](https://github.com/trailofbits/publications/blob/master/reviews/hermez.pdf) and [ToB’s Audit of Uniswap V3](https://github.com/Uniswap/uniswap-v3-core/blob/main/audits/tob/audit.pdf). Also see [Warning in solidity documentation](https://docs.soliditylang.org/en/v0.8.0/control-structures.html#error-handling-assert-require-revert-and-exceptions).\n\nhttps://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Trader.sol#L121-L129\n\nRecommend that `makeOrder.market` should be checked for contract existence before the low-level call, and then verified to be the actual market contract (but it is not verified as noted in the comment). Evaluate if this is a greater concern than undefined behavior.\n\n## [[L-07] Using `tx.gasprice` to prevent front-running may lead to failed liquidations](https://github.com/code-423n4/2021-06-tracer-findings/issues/76)\n_Submitted by 0xRajeev_\n\nIn `verifyAndSubmitLiquidation()`, the `tx.gasprice` is checked against the `fastGasOracle`’s current gas price presumably to prevent liquidators front-running others for the same market/account by using a gas price exceeding the current prevailing price as indicated by the `fastGasOracle`.\n\nThe impact is that, if the gas prices are increasing rapidly due to volatility or network congestion, or if the liquidation engines and `fastGasOracle` are out of sync on gas prices because of consulting different sources, then these liquidations will keep failing. Front-running risk on liquidations is not adequately protected by `tx.gasprice` check.\n\nThis logic may also be impacted by the upcoming inclusion of EIP-1559 in London fork which affect gas semantics significantly.\n\nLiquidation bots front-running by monitoring mempool or the use of FlashBots for liquidation MEV, is a systemic challenge and not solved by using gasprice logic in contracts. Would recommend evaluating if the benefits match the failure modes.\n\n**[raymogg (Tracer) acknowledged](https://github.com/code-423n4/2021-06-tracer-findings/issues/76#issuecomment-876022738):**\n > Good point on the strict check of fast gas price. As you pointed out this is to prevent gas auctions from occuring and causing liquidations to be extremely expensive, however this could become a bottleneck in times of rapidly changing gas prices.\n>\n> Have acknowledged that this could cause problems in certain scenarios. The team will be thinking about a safer implementation of this mechanism.\n\n## [[L-08] Potential division by zero](https://github.com/code-423n4/2021-06-tracer-findings/issues/83)\n_Submitted by 0xRajeev_\n\nIn function `minimumMargin()`, `maximumLeverage` being zero is not handled because it will result in div by zero as `PRBMathUD60x18.div` expects non-zero `diTracer`.\n\nThe impact is that various critical market functions will revert if `maximumLeverage` is zero. See issue page for effected code.\n\nRecommend adding checks to make sure `maximumLeverage` is never zero or handle appropriately.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/83)**\n\n## [[L-09] Unlocked pragma used in multiple contracts](https://github.com/code-423n4/2021-06-tracer-findings/issues/133)\n_Submitted by shw, also found by JMukesh_\n\nMost of the contracts use an unlocked pragma (e.g., `pragma solidity ^0.8.0`) which is not fixed to a specific Solidity version. Locking the pragma helps ensure that contracts do not accidentally get deployed using a different compiler version with which they have been tested the most. Please use `grep -R pragma .` to find the unlocked pragma statements in the codebase\n\nRecommend locking pragmas to a specific Solidity version. Consider the compiler bugs in the following lists and ensure the contracts are not affected by them. It is also recommended to use the latest version of Solidity when deploying contracts (see [Solidity docs](https://docs.soliditylang.org/en/v0.8.6/)).\n\nSolidity compiler bugs:\n[Solidity repo - known bugs](https://github.com/ethereum/solidity/blob/develop/docs/bugs.json)\n[Solidity repo - bugs by version](https://github.com/ethereum/solidity/blob/develop/docs/bugs_by_version.json)\n\n**[raymogg (Tracer) confirmed but disagreed with severity](https://github.com/code-423n4/2021-06-tracer-findings/issues/133#issuecomment-876078882):**\n > Disagree with severity as the Solidity version is defined in the project config as well so the risk of the contracts being deployed with the wrong version is low. Should be a 0\n\n**[cemozerr (Judge) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/133#issuecomment-882095913):**\n > Marking this as low risk as unlocked pragma can lead to compiler bugs.\n\n## [[L-10] `LibMath` fails implicitly](https://github.com/code-423n4/2021-06-tracer-findings/issues/88)\n_Submitted by cmichel_\n\nWhen `LibMath.abs` is called with -2^255 (`type(int256).min`), it tries to multiply it by `-1` but it'll fail as it exceeds the max signed 256-bit integers. The function will fail with an implicit error that might be hard to locate.\n\nRecommend throwing an error similar to `toInt256` like `int256 overflow`.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/88)**\n\n## [[L-11] `LibMath.sumN` can iterate over array](https://github.com/code-423n4/2021-06-tracer-findings/issues/89)\n_Submitted by cmichel_\n\nWhen `LibMath.sumN` function does not check if `n <= arr.length` and can therefore fail if called with `n > arr.length`. The caller must always check that it's called with an argument that is less than `n` which is inconvenient.\n\nRecommend changing the condition to iterate up to `min(n, arr.length)`.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/89)**\n\n## [[L-12] todos left in the code](https://github.com/code-423n4/2021-06-tracer-findings/issues/12)\n_Submitted by gpersoon_\n\nThere are several todos left in the code. See Issue page for list.\nRecommend checking, fixing and removing the todos before it is deployed in production\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/12)**\n\n## [[L-13] check sign in `calculateSlippage`](https://github.com/code-423n4/2021-06-tracer-findings/issues/17)\n_Submitted by gpersoon_\n\nIn function `calculateSlippage` of `LibLiquidation.sol`, the value of `amountToReturn` is calculated by subtracting to numbers. Later on it is checked to see if this value is negative. However, `amountToReturn` is an unsigned integer so it can never be negative. If a negative number would be attempted to be assigned, the code will revert, because solidity 0.8 checks for this. See `LibLiquidation.sol` [L106](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibLiquidation.sol#L106).\n```solidity\nfunction calculateSlippage(\n...\n    uint256 amountToReturn = 0;\n    uint256 percentSlippage = 0;\n    if (avgPrice < receipt.price && receipt.liquidationSide == Perpetuals.Side.Long) {\n        amountToReturn = amountExpectedFor - amountSoldFor;\n    } else if (avgPrice > receipt.price && receipt.liquidationSide == Perpetuals.Side.Short) {\n        amountToReturn = amountSoldFor - amountExpectedFor;\n    }\n    if (amountToReturn <= 0) {    // can never be smaller than 0, because `amountToReturn` is uint256\n        return 0;\n    }\n```\n\nRecommend double checking if `amountToReturn` could be negative. If this is the case, change the type of `amountToReturn` to int256 and add the appropriate type casts.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/17#issuecomment-876085044):**\n > Confirmed but think this is a 0 on severity. The check while a bit redundant on the less than case, is actually still needed as we do want to catch the case where `amountToReturn = 0`.\n\n**[cemozerr (Judge) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/17#issuecomment-882100905):**\n > Marking this as low risk as a \"Double check if amountToReturn could be negative\" seems necessary for the scenarios where the amountToReturn could underflow.\n\n## [[L-14] The `averagePriceForPeriod` function may revert without proper error message returned](https://github.com/code-423n4/2021-06-tracer-findings/issues/140)\n_Submitted by shw, also found by gpersoon_\n\nThe `averagePriceForPeriod` function of `LibPrices` does not handle the case where `j` equals 0 (i.e., no trades happened in the last 24 hours). The transaction reverts due to dividing by 0 without a proper error message returned.\n\nRecommend adding `require(j > 0, \"...\")` before line 73 to handle this special case.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/140)**\n\n## [[L-15] make sure `withdrawFees` always can withdraw](https://github.com/code-423n4/2021-06-tracer-findings/issues/23)\n_Submitted by gpersoon_\n\nIf you call the function `withdrawFees` when \"TVL\" is not enough for the fee, then the code  would revert. In this case the fees cannot be withdrawn. Although it is unlikely that the TVL would be wrong, it is probably better to be able to withdraw the remaining fees.\n\n`TracerPerpetualSwaps.sol` [L508](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/TracerPerpetualSwaps.sol#L508)\n```solidity\nfunction withdrawFees() external override {\n    uint256 tempFees = fees;\n    fees = 0;\n    tvl = tvl - tempFees;\n\n    // Withdraw from the account\n    IERC20(tracerQuoteToken).transfer(feeReceiver, tempFees);\n    emit FeeWithdrawn(feeReceiver, tempFees);\n}\n```\n\nRecommend adding something like `tempFees = min (fees, tvl);`, and changing `fees=0` to `fees -= tempFees;`\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/23)**\n\n## [[L-16] `matchOrders` could/should check market](https://github.com/code-423n4/2021-06-tracer-findings/issues/6)\n_Submitted by gpersoon_\n\nThe function `matchOrders` of `TracerPerpetualSwaps.sol` doesn't check that the contract itself is indeed equal to `order1.market` and `order2.market`.\n\nThe function `executeTrade` in `Trader.sol`, which calls the `matchOrders`, can deal with multiple markets.\n\nSuppose there would be a mistake in `executeTrade`,  or in a future version, the `matchOrders` would be done in the wrong market.\n\n`TracerPerpetualSwaps.sol` [L216](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/TracerPerpetualSwaps.sol#L216)\n```solidity\nfunction `matchOrders`( Perpetuals.Order memory order1, Perpetuals.Order memory order2, uint256 fillAmount )\n```\n\n`Trader.sol` [L67](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Trader.sol#L67)\n```solidity\n function `executeTrade`(Types.SignedLimitOrder[] memory makers, Types.SignedLimitOrder[] memory takers) external  override {\n...\n    (bool success, ) = makeOrder.market.call(\n    abi.encodePacked(\n        ITracerPerpetualSwaps(makeOrder.market).matchOrders.selector,\n        abi.encode(makeOrder, takeOrder, fillAmount)\n    )\n);\n```\n\n`LibPerpetuals.sol` [L128](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibPerpetuals.sol#L128)\n```solidity\nfunction canMatch( Order memory a, uint256 aFilled,Order memory b, uint256 bFilled ) internal view returns (bool) {\n    ...\n        bool marketsMatch = a.market == b.market;\n```\n\nRecommend adding something like:\n```solidity\nrequire ( order1.market == address(this), \"Wrong market\");\n```\nNote: `canMatch` already verifies that  `order1.market== order2.market`\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/6)**\n\n## [[L-17] inclusive check that account is not above minimum margin](https://github.com/code-423n4/2021-06-tracer-findings/issues/109)\n_Submitted by pauliax_\n\nHere the check `currentMargin` < `Balances.minimumMargin` should be inclusive <= to indicate the account is not above minimum margin:\n```solidity\n    require(\n        currentMargin <= 0 ||\n            uint256(currentMargin) < Balances.minimumMargin(pos, price, gasCost, tracer.trueMaxLeverage()),\n        \"LIQ: Account above margin\"\n    );\n```\n\nRecommend using `uint256(currentMargin) <= Balances.minimumMargin`\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/109)**\n\n## [[L-18] hardcoded `chainID`](https://github.com/code-423n4/2021-06-tracer-findings/issues/85)\n_Submitted by pauliax, also found by s1m0, shw and 0xRajeev_\n\nHardcoding `chainID` is error-prone (in case you decide to deploy on a different chain and forget to change this, or if the chain forks, etc...):\n`uint256 public constant override chainId = 1337;` // Changes per chain\n\nRecommend better utilization of global variable `block.chainid`, or you can also retrieve `chainID` via [assembly]( https://ethereum.stackexchange.com/a/77550/17387).\n\n**[raymogg (Tracer) disputed in a duplicate issue](https://github.com/code-423n4/2021-06-tracer-findings/issues/67#issuecomment-873753616)**\n> Disputing as an issue as while the suggested approach is a better solution (dynamically setting ChainID), deploying a Trader contract with the wrong ID does not affect the system. A new Trader can be deployed using the appropriate ChainID if one is accidentally deployed with the wrong ChainID.\n>\n> Currently this ChainID is just updated before deployment. The team will implement the dynamic approach moving forward.\n\n_**Note:** Additional conversation regarding this vulnerability can be found [here](https://github.com/code-423n4/2021-06-tracer-findings/issues/67)_\n\n## [[L-19] `Prices.averagePrice` does not show a difference between no trades and a zero price](https://github.com/code-423n4/2021-06-tracer-findings/issues/139)\n_Submitted by shw_\n\nThe `getHourlyAvgTracerPrice` and `getHourlyAvgOraclePrice` functions in `Pricing` return 0 if there is no trade during the given `hour` because of the design of `averagePrice`, which could mislead users that the hourly average price is 0. The same problem happens when emitting the old hourly average in the `recordTrade` function. See `Pricing.sol` [L254-L256](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Pricing.sol#L254-L256), [L262-L264](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Pricing.sol#L262-L264), and [L74](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Pricing.sol#L74).\n\nRecommend returning a special value (e.g., `type(uint256).max`) from `averagePrice` if there is no trade during the specified hour to distinguish from an actual zero price. Handle this particular value whenever the `averagePrice` function is called by others.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/139)**\n\n## [[L-20] Margin value is not checked to be non-negative in `leveragedNotionalValue`](https://github.com/code-423n4/2021-06-tracer-findings/issues/141)\n_Submitted by shw_\n\nThe `leveragedNotionalValue` function of `LibBalance` gets the margin value of a position (i.e., the `marginValue` variable) to calculate the notional value. However, the position's margin value is not checked to be non-negative. Margin with a value less than zero is considered invalid and should be specially handled. [L80](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/lib/LibBalances.sol#L80) in `LibBalances.sol`.\n\nRecommend checking whether `marginValue` is less than zero and handle this case.\n\n**[OsmanBran acknowledged](https://github.com/code-423n4/2021-06-tracer-findings/issues/141#issuecomment-882197605):**\n > Although in a normal state marginValue should not be negative (due to being liquidated prior to this), this function should still handle negative values for marginValue and result in valid calculations. Reverting the function due to negative margin values will cause undesirable side-effects in the system.\n\n## [[L-21] The `currentHour` variable in `Pricing` could be out of sync](https://github.com/code-423n4/2021-06-tracer-findings/issues/142)\n_Submitted by shw_\n\nThe `recordTrade` function in `Pricing` updates the `currentHour` variable by 1 every hour. However, if there is no trade (i.e., the `recordTrade` is not called) during this hour, the `currentHour` is out of sync with the actual hour. As a result, the `averagePriceForPeriod` function uses the prices before 24 hours and causes errors on the average price. See `Pricing.sol`  [L90-L94](https://github.com/code-423n4/2021-06-tracer/blob/main/src/contracts/Pricing.sol#L90-L94).\n\nRecommend calculating how much time passed (e.g., `(block.timestamp - startLastHour) / 3600`) to update the `currentHour` variable correctly.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/142)**\n\n## [[L-22] Potential Out-of-Gas exception due to unbounded loop](https://github.com/code-423n4/2021-06-tracer-findings/issues/69)\n_Submitted by 0xRajeev_\n\nTrading function `executeTrade()` batch executes maker/taker orders against a market. The trader/interface provides arrays of makers/takers which is unbounded. As a result, if the number of orders is too many, there is a risk of this transaction exceeding the block gas limit (which is 15 million currently). See `Trader.sol` [L67](https://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Trader.sol#L67) and [L78](https://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Trader.sol#L78)\n\nThe impact is that if `executeTrade()` is called with too many orders in the batch, the transaction might exceed block gas limit and revert, resulting in none of the orders are executed.\n\nSee similar medium-severity finding from [ConsenSys's Audit of Growth DeFi](https://consensys.net/diligence/audits/2020/12/growth-defi-v1/#potential-resource-exhaustion-by-external-calls-performed-within-an-unbounded-loop).\n\nRecommend limiting the number or orders executed based on `gasleft()` after every iteration, or estimating the gas cost and enforcing an upper bound on the number of orders allowed in maker/taker arrays.\n\n**[raymogg (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/69)**\n\n## [[L-23] Using array memory parameter without checking its length ](https://github.com/code-423n4/2021-06-tracer-findings/issues/35)\n_Submitted by JMukesh_\n\nThese array memory parameters can be  problematic if not used properly. For example, if the array is very large, it may overlap over other part of memory (`Liquidation.sol` [L274](https://github.com/code-423n4/2021-06-tracer/blob/74e720ee100fd027c592ea44f272231ad4dfa2ab/src/contracts/Liquidation.sol#L274)).\n\nThis an example to show the exploit:\n```solidity\n// based on https://github.com/paradigm-operations/paradigm-ctf-2021/blob/master/swap/private/Exploit.sol\npragma solidity ^0.4.24; // only works with low solidity version\n\ncontract test{\nstruct Overlap {\nuint field0;\n}\nevent log(uint);\n\nfunction mint(uint[] memory amounts) public returns (uint) {\n// this can be in any solidity version\nOverlap memory v;\nv.field0 = 1234;\nemit log(amounts[0]); // would expect to be 0 however is 1234\nreturn 1;\n}\n\nfunction go() public { // this part requires the low solidity version\nuint x=0x800000000000000000000000000000000000000000000000000000000000000; // 2^251\nbytes memory payload = abi.encodeWithSelector(this.mint.selector, 0x20, x);\nbool success=address(this).call(payload);\n}\n}\n```\n\nRecommend checking array length before using it.\n\n**[raymogg (Tracer) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/35#issuecomment-874362760):**\n > Duplicate of #79\n\n**[sporejack (Tracer) commented](https://github.com/code-423n4/2021-06-tracer-findings/issues/35#issuecomment-875179515):**\n > So the provided PoC code works (under `solc` 0.4.24) subject to test case:\n>\n> ```javascript\n> const { expect } = require(\"chai\");\n>\n> describe(\"Overlap\", async () => {\n>     describe(\"go\", async () => {\n>         let overlapFactory;\n>         let overlap;\n>\n>         before(async () => {\n>             overlapFactory = await ethers.getContractFactory(\"Overlap\");\n>             overlap = await overlapFactory.deploy();\n>\n>             await overlap.deployed();\n>         });\n>\n>         context(\"When called\", async () => {\n>           it(\"Emits `log` event with correct value\", async () => {\n>             var firstAmount = ethers.BigNumber.from(\"1234\");\n>\n>             await expect(overlap.go()).to.emit(overlap, \"log\").withArgs(firstAmount);\n>           });\n>         });\n>     });\n> });\n> ```\n\n**[sporejack (Tracer) confirmed](https://github.com/code-423n4/2021-06-tracer-findings/issues/35#issuecomment-875180758):**\n > My assessment is:\n>\n> | Impact | Difficulty | Overall |\n> | --- | --- | --- |\n> | Low | Low | Low |\n>\n> With rationale:\n>\n>  - Unclear (_a priori_) exactly _how_ PoC constitutes an exploit\n>  - PoC payload will likely cause unexpected behaviour in production codebase\n>  - Relatively easy for adversary to craft viable payload (simple overflow)\n\n## [[L-24] Wrong token approval](https://github.com/code-423n4/2021-06-tracer-findings/issues/99)\n_Submitted by cmichel_\n\nThe pool holdings of `Insurance` (`publicCollateralAmount` and `bufferCollateralAmount`) is in WAD (18 decimals) but it's used as a raw token value in `drainPool`\n\n```solidity\n// amount is a mix of pool holdings, i.e., 18 decimals\n// this requires amount to be in RAW! if tracerMarginToken has > 18 decimals, it'll break, < 18 decimals will approve too much\ntracerMarginToken.approve(address(tracer), amount);\n// this requires amount to be in WAD which is correct\ntracer.deposit(amount);\n```\n\nIf `tracerMarginToken` has less than 18 decimals, the approval approves orders of magnitude more tokens than required for the `deposit` call that follows.\nIf `tracerMarginToken` has more than 18 decimals, the `deposit` that follows would fail as fewer tokens were approved, but the protocol seems to disallow tokens in general with more than 18 decimals.\n\nRecommend converting the `amount` to a \"raw token value\" and approve this one instead.\n\n**[raymogg (Tracer) confirmed but disagreed with severity](https://github.com/code-423n4/2021-06-tracer-findings/issues/99#issuecomment-873757790):**\n > The issue is correct in pointing out that the wrong approve amount is used, however disagree with the severity.\n>\n> It is common practice to approve the maximum amount of tokens for a contract to spend already. This bug simply allows more tokens to be approved (to a trusted contract in the system), than was intended. This is only exploitable if paired with another bug in the Tracer contracts. As is, no users would be affected.\n\n**[cemozerr (Judge) lowered severity from 2 to 1](https://github.com/code-423n4/2021-06-tracer-findings/issues/99#issuecomment-882120601):**\n > Marking this as low-risk as it would only pose a security threat coupled with another bug.\n\n# Non-Critical Findings (20)\n\n* [[N-01] Missing checks for `lowestMaxLeverage` < `maxLeverage` and `insurancePoolSwitchStage` < `deleveragingCliff`](https://github.com/code-423n4/2021-06-tracer-findings/issues/117)\n* [[N-02] Superfluous `verifySignature` function](https://github.com/code-423n4/2021-06-tracer-findings/issues/121)\n* [[N-03] State variable not used](https://github.com/code-423n4/2021-06-tracer-findings/issues/122)\n* [[N-04] Change `claimEscrow()` to external](https://github.com/code-423n4/2021-06-tracer-findings/issues/128)\n* [[N-05] Only one constructor with an emit](https://github.com/code-423n4/2021-06-tracer-findings/issues/10)\n* [[N-06] Use constants for numbers](https://github.com/code-423n4/2021-06-tracer-findings/issues/14)\n* [[N-07] alternative solidity coding](https://github.com/code-423n4/2021-06-tracer-findings/issues/15)\n* [[N-08] Comment for formula `calcEscrowLiquidationAmount` different than code](https://github.com/code-423n4/2021-06-tracer-findings/issues/16)\n* [[N-09] Comment in `partialLiquidationIsValid` misleading](https://github.com/code-423n4/2021-06-tracer-findings/issues/18)\n* [[N-10] use try catch](https://github.com/code-423n4/2021-06-tracer-findings/issues/25)\n* [[N-11] Comment in `claimEscrow`](https://github.com/code-423n4/2021-06-tracer-findings/issues/26)\n* [[N-12] Use immutable keyword29](https://github.com/code-423n4/2021-06-tracer-findings/issues/29)\n* [[N-13] Close-ended time ranges may confuse users/interfaces](https://github.com/code-423n4/2021-06-tracer-findings/issues/75)\n* [[N-14] Unnecessary type conversions](https://github.com/code-423n4/2021-06-tracer-findings/issues/118)\n* [[N-15] `setDecimals` can be set by anyone and not used](https://github.com/code-423n4/2021-06-tracer-findings/issues/78)\n* [[N-16] Event log poisoning/griefing in `withdrawFees()`](https://github.com/code-423n4/2021-06-tracer-findings/issues/63)\n* [[N-17] `claimEscrow` with not yet existing id](https://github.com/code-423n4/2021-06-tracer-findings/issues/107)\n* [[N-18] orders and `orderToSig` mappings](https://github.com/code-423n4/2021-06-tracer-findings/issues/47)\n* [[N-19] Dangerous use of storage data location specifier](https://github.com/code-423n4/2021-06-tracer-findings/issues/61)\n* [[N-20] Missing length check on array could lead to undefined behavior](https://github.com/code-423n4/2021-06-tracer-findings/issues/79)\n\n# Gas Optimizations (12)\n\n* [[G-01] Gas savings in `getPoolFundingRate()`](https://github.com/code-423n4/2021-06-tracer-findings/issues/125)\n* [[G-02] Gas savings in `verifyAndSubmitLiquidation()`](https://github.com/code-423n4/2021-06-tracer-findings/issues/131)\n* [[G-03] Unused State variable](https://github.com/code-423n4/2021-06-tracer-findings/issues/38)\n* [[G-04] state variable which can be declared as immutable](https://github.com/code-423n4/2021-06-tracer-findings/issues/40)\n* [[G-05] function which can declared as external ](https://github.com/code-423n4/2021-06-tracer-findings/issues/62)\n* [[G-06] Use EIP-1167 in order to deploy new perpetual swap contracts](https://github.com/code-423n4/2021-06-tracer-findings/issues/120)\n* [[G-07] Variables that can be converted into immutables](https://github.com/code-423n4/2021-06-tracer-findings/issues/24)\n* [[G-08] [Gas] Change some function parameters from `memory` to `calldata`](https://github.com/code-423n4/2021-06-tracer-findings/issues/36)\n* [[G-09] [Gas] Use at least 0.8.0 instead of 0.8.4](https://github.com/code-423n4/2021-06-tracer-findings/issues/37)\n* [[G-10] `amountToReturn` > `receipt.escrowedAmount` could be inclusive](https://github.com/code-423n4/2021-06-tracer-findings/issues/108)\n* [[G-11] recalculation of 10**18](https://github.com/code-423n4/2021-06-tracer-findings/issues/50)\n* [[G-12] `executionPrice`, `newMakeAverage` and `newTakeAverage` before calling the market](https://github.com/code-423n4/2021-06-tracer-findings/issues/52)\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}