{
  "circa": {
    "title": "Perennial contest",
    "sponsor": "Perennial",
    "slug": "2021-12-perennial",
    "date": "2022-01-24",
    "findings": "https://github.com/code-423n4/2021-12-perennial-findings/issues",
    "contest": 60
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the code contest outlined in this document, C4 conducted an analysis of Perennial contest smart contract system written in Solidity. The code contest took place between December 9—December 15 2021.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>13 Wardens contributed reports to the Perennial contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a> </li>\n<li><a href=\"https://twitter.com/KenzoAgada\">kenzo</a></li>\n<li>WatchPug (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li>0x0x0x</li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li>robee</li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/merkleplant_eth\">pmerkleplant</a></li>\n<li><a href=\"https://twitter.com/0xbroccolirob\">broccolirob</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a> and <a href=\"https://twitter.com/CloudEllie1\">CloudEllie</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 11 unique vulnerabilities and 38 total findings. All of the issues presented here are linked back to their original finding.</p>\n<p>Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity, 3 received a risk rating in the category of MEDIUM severity, and 6 received a risk rating in the category of LOW severity.</p>\n<p>C4 analysis also identified 5 non-critical recommendations and 22 gas optimizations.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2021-12-perennial\">C4 Perennial contest repository</a>, and is composed of 38 smart contracts written in the Solidity programming language and includes 3531 lines of Solidity code and 7 lines of JavaScript.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code423n4.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-wrong-shortfall-calculation\" style=\"position:relative;\"><a href=\"#h-01-wrong-shortfall-calculation\" aria-label=\"h 01 wrong shortfall calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/18\">[H-01] Wrong shortfall calculation</a></h2>\n<p><em>Submitted by kenzo</em></p>\n<p>Every time an account is settled, if shortfall is created, due to a wrong calculation shortfall will double in size and add the new shortfall.</p>\n<h4 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>Loss of funds: users won’t be able to withdraw the correct amount of funds. Somebody would have to donate funds to resolve the wrong shortfall.</p>\n<h4 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>We can see in the <code>settleAccount</code> of <code>OptimisticLedger</code> that <code>self.shortfall</code> ends up being <code>self.shortfall+self.shortfall+newShortfall</code>: <a href=\"https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/collateral/types/OptimisticLedger.sol#L63:#L74\">(Code ref)</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">settleAccount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">OptimisticLedger</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">self</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Fixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">UFixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Fixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Fixed18Lib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">newBalance</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sign</span><span class=\"mtk1\">() == -</span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBalance</span><span class=\"mtk1\">.</span><span class=\"mtk11\">abs</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">newBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Fixed18Lib</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZERO</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">account</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">newBalance</span><span class=\"mtk1\">.</span><span class=\"mtk11\">abs</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">self</span><span class=\"mtk1\">.</span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\">.</span><span class=\"mtk11\">add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shortfall</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Additionally, you can add the following line to the “shortfall reverts if depleted” test in <code>Collateral.test.js</code>, line 190:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">productSigner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">settleAccount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">userB</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, -</span><span class=\"mtk7\">50</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>Previously the test product had 50 shortfall. Now we added 50 more, but the test will print that the actual shortfall is 150, and not 100 as it should be.</p>\n<h4 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Move the setting of <code>self.shortfall</code> to inside the if function and change the line to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    self.shortfall = shortfall</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/18#issuecomment-995416504\">kbrizzle (Perennial) confirmed</a>:</strong></p>\n<blockquote>\n<p>Excellent find 🙏 </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/18#issuecomment-1001280292\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding <code>shortfall = self.shortfall.add(newBalance.abs());</code> is already shortfal + newBalance.abs()\nSo performing line <code>73</code> <code>self.shortfall = self.shortfall.add(shortfall);</code> is adding <code>shortfall</code> again</p>\n</blockquote>\n<h2 id=\"h-02-withdrawto-does-not-sync-before-checking-a-positions-margin-requirements\" style=\"position:relative;\"><a href=\"#h-02-withdrawto-does-not-sync-before-checking-a-positions-margin-requirements\" aria-label=\"h 02 withdrawto does not sync before checking a positions margin requirements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/74\">[H-02] <code>withdrawTo</code> Does Not Sync Before Checking A Position’s Margin Requirements</a></h2>\n<p><em>Submitted by leastwood</em></p>\n<h4 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The <code>maintenanceInvariant</code> modifier in <code>Collateral</code> aims to check if a user meets the margin requirements to withdraw collateral by checking its current and next maintenance. <code>maintenanceInvariant</code> inevitably calls <code>AccountPosition.maintenance</code> which uses the oracle’s price to calculate the margin requirements for a given position. Hence, if the oracle has not synced in a long time, <code>maintenanceInvariant</code> may end up utilising an outdated price for a withdrawal. This may allow a user to withdraw collateral on an undercollaterized position.</p>\n<h4 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p><a href=\"https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/collateral/Collateral.sol#L67-L76\">https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/collateral/Collateral.sol#L67-L76</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IProduct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">product</span><span class=\"mtk1\">, </span><span class=\"mtk12\">UFixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">notPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">collateralInvariant</span><span class=\"mtk1\">(msg.sender, </span><span class=\"mtk12\">product</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">maintenanceInvariant</span><span class=\"mtk1\">(msg.sender, </span><span class=\"mtk12\">product</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_products</span><span class=\"mtk1\">[</span><span class=\"mtk12\">product</span><span class=\"mtk1\">].</span><span class=\"mtk11\">debitAccount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdrawal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">product</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/collateral/Collateral.sol#L233-L241\">https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/collateral/Collateral.sol#L233-L241</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maintenanceInvariant</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IProduct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">product</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">UFixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maintenance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">product</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maintenance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">UFixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maintenanceNext</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">product</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maintenanceNext</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">UFixed18Lib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">max</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maintenance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">maintenanceNext</span><span class=\"mtk1\">).</span><span class=\"mtk11\">gt</span><span class=\"mtk1\">(</span><span class=\"mtk11\">collateral</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">product</span><span class=\"mtk1\">)))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CollateralInsufficientCollateralError</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/product/types/position/AccountPosition.sol#L71-L75\">https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/product/types/position/AccountPosition.sol#L71-L75</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maintenanceInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Position</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">position</span><span class=\"mtk1\">, </span><span class=\"mtk12\">IProductProvider</span><span class=\"mtk1\"> </span><span class=\"mtk12\">provider</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">UFixed18</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Fixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">priceAtVersion</span><span class=\"mtk1\">(</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">currentVersion</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">UFixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">notionalMax</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Fixed18Lib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">from</span><span class=\"mtk1\">(</span><span class=\"mtk12\">position</span><span class=\"mtk1\">.</span><span class=\"mtk11\">max</span><span class=\"mtk1\">()).</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oraclePrice</span><span class=\"mtk1\">).</span><span class=\"mtk11\">abs</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">notionalMax</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">maintenance</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h4 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual code review.</p>\n<h4 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Consider adding <code>settleForAccount(msg.sender)</code> to the <code>Collateral.withdrawTo</code> function to ensure the most up to date oracle price is used when assessing an account’s margin requirements.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/74#issuecomment-996589429\">kbrizzle (Perennial) confirmed</a>:</strong></p>\n<blockquote>\n<p>Great catch 🙏 </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/74#issuecomment-1001590562\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>With most onChain protocols where there is potential for undercollateralized positions and liquidations, it is very important to accrue a user position before making any changes to their balance.</p>\n<p>The warden identified a potential way for a user to withdraw funds while their account is below margin requirements.</p>\n<p>Because this impacts the core functionality functionality of the protocol (accounting), I’m raising the severity to high</p>\n<p>Mitigation seems to be straightforward</p>\n</blockquote>\n<h1 id=\"medium-risk-findings-3\" style=\"position:relative;\"><a href=\"#medium-risk-findings-3\" aria-label=\"medium risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (3)</h1>\n<h2 id=\"m-01-no-checks-if-given-product-is-created-by-the-factory\" style=\"position:relative;\"><a href=\"#m-01-no-checks-if-given-product-is-created-by-the-factory\" aria-label=\"m 01 no checks if given product is created by the factory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/63\">[M-01] No checks if given product is created by the factory</a></h2>\n<p><em>Submitted by 0x0x0x</em></p>\n<p>An attacker can create a fake product. <code>Collateral</code> contract does not check whether the given product is created by the factory. A malicious product can return arbitrary maintenance amounts, therefore they can make any deposit to fake product stuck (simply return collateral - 1 as maintenance) and fake product owner can change the maintenance and liquidate whenever wanted and claim full collateral.</p>\n<p>This is a serious attack vector, since by only interacting with <code>Collateral</code> contract the user can lose funds. Furthermore, this vulnerability poses big risks in combination web vulnerabilities. Users always have to check the product address to avoid getting scammed, but likely most users will only check the contract address.</p>\n<p>Furthermore, if another protocol would want to add perennial protocol for its use case, the other protocol has to be careful with this behaviour and keep track of whitelisted products. This complicates adoption of perennial protocol, since whitelist has to be managed manually or else this vulnerability will likely be exploitable.</p>\n<h4 id=\"mitigation-step\" style=\"position:relative;\"><a href=\"#mitigation-step\" aria-label=\"mitigation step permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation step</h4>\n<p>Add a mapping inside <code>Collateral</code>, which verifies whether a product is created by factory or not. This mapping should get updated by the factory. This will add a little bit gas cost, but will eliminate a serious attack vector.</p>\n<p>Or less gas efficient option is directly call a function from factory to verify.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/63#issuecomment-997158601\">kbrizzle (Perennial) disagreed with severity</a>:</strong></p>\n<blockquote>\n<p>Good find 🙏 </p>\n<p>On severity: In general there’s a whole plethora of ways a Product owner could create a product that harmful a user which choses to take part in it. The design model of Perennial is to give the Product owners the <em>freedom</em> to create risky products, but to segregate that risk to only those products, and this issue does not break this segregation of risk. This is especially important during our gated-beta phase while we learn which levers are worth it to lock down. </p>\n<p>That being said this is low hanging fruit to correct, so we think it should still be <code>2 (Medium)</code> severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/63#issuecomment-1001284165\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Given the extensible nature of the <code>Collateral</code> contract, users can call the contract with any user input for <code>product</code> this could be used maliciously against the users as the warden highlighted.</p>\n<p>This can definitely happen, but is contingent on a set of external factors, so I think medium severity is more appropriate</p>\n</blockquote>\n<h2 id=\"m-02-multiple-initialization-of-collateral-contract\" style=\"position:relative;\"><a href=\"#m-02-multiple-initialization-of-collateral-contract\" aria-label=\"m 02 multiple initialization of collateral contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13\">[M-02] Multiple initialization of Collateral contract</a></h2>\n<p><em>Submitted by 0x1f8b</em></p>\n<h4 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h4>\n<p>The attacker can initialize the contract, take malicious actions, and allow it to be re-initialized by the project without any error being noticed.</p>\n<h4 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>The <code>initialize</code> method of the<code>Collateral</code> contract does not contain the <code>initializer</code> modifier, it delegates this process to check if the factory is different from address(0) in the<code>UFactoryProvider__initialize</code> call, however the <code>factory_</code>is other than address(0), so an attacker could use front-running by listening to the memory pool, initialize the contract with a <code>factory=address(0)</code>, perform malicious actions, and still allow it to be started later by the I draft the contract without noticing any error.</p>\n<p>Source reference:</p>\n<ul>\n<li>Collateral.initialize</li>\n</ul>\n<h4 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h4>\n<p>Manual review</p>\n<h4 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Use <code>initializer</code> modifier</p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-995339471\">kbrizzle (Perennial) marked as duplicate</a>:</strong></p>\n<blockquote>\n<p>Duplicate of: <a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/71\">https://github.com/code-423n4/2021-12-perennial-findings/issues/71</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001284802\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Disagree with sponsor that this is duplicate of #73 </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001285612\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The finding mentions that <code>initialize</code> can be called multiple times, specifically by first having <code>factory</code> set to address(0) and then setting it to it’s final value.</p>\n<p>This is true.</p>\n<p>Calling initialize multiple times could allow to set certain values up with a different token, then change to another token and set the factory. This could be used to trick the protocol accounting to later take advantage of other depositors.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001285964\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The specific vulnerability is the lack of the  <code>initializer</code> modifier on initialize, the consequences  can be problematic only if a malicious actor were to set the contracts up.</p>\n<p>Because this can be done, and it’s reliant on a specific setup, I’ll mark the finding as medium severity, mitigation is straightforward</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001294139\">kbrizzle (Perennial) commented</a>:</strong></p>\n<blockquote>\n<p>My understanding of these is that:</p>\n<ul>\n<li>\n<h1 id=\"73-would-allow-an-attacker-to-front-run-the-initialization-of-a-contract-to-gain-admin-but-the-subsequent-legitimate-attempt-to-initialize-would-revert\" style=\"position:relative;\"><a href=\"#73-would-allow-an-attacker-to-front-run-the-initialization-of-a-contract-to-gain-admin-but-the-subsequent-legitimate-attempt-to-initialize-would-revert\" aria-label=\"73 would allow an attacker to front run the initialization of a contract to gain admin but the subsequent legitimate attempt to initialize would revert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>73 would allow an attacker to front-run the initialization of a contract to gain admin, but the subsequent legitimate attempt to initialize would revert.</h1>\n</li>\n<li>\n<h1 id=\"13-would-allow-an-attacker-to-front-run-the-initialization-of-a-contract-to-gain-admin-and-the-subsequent-legitimate-attempt-to-initialize-would-still-work-thereby-possibly-going-unnoticed\" style=\"position:relative;\"><a href=\"#13-would-allow-an-attacker-to-front-run-the-initialization-of-a-contract-to-gain-admin-and-the-subsequent-legitimate-attempt-to-initialize-would-still-work-thereby-possibly-going-unnoticed\" aria-label=\"13 would allow an attacker to front run the initialization of a contract to gain admin and the subsequent legitimate attempt to initialize would still work thereby possibly going unnoticed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>13 would allow an attacker to front-run the initialization of a contract to gain admin, and the subsequent legitimate attempt to initialize would still work (thereby possibly going unnoticed).</h1>\n</li>\n</ul>\n<p>If we want to tag these as separate issues, I think that makes sense as the effects are slightly different. Both are ultimately a documentation issue though solved by this <a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/71#issuecomment-995343823\">remediation</a>, so I’m wondering why one is tagged as <code>0 (Non-critical)</code> and the other <code>2 (Medium)</code>.</p>\n<p>Is that correct, or is there an issue here even <em>with</em> proper atomic deploy-and-initialize usage with OZ’s upgrades plugin? Just want to make sure we’re not missing something else here. Also - we do not have an <code>initializer</code> modifier available in the code base, so the remediation suggestion was a little confusing.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001296121\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@kbrizzle Yes, this is something that can still be done, arguably only by your deployer</p>\n<p>You could deploy and <code>initialize</code> the contract with factory set to 0, use that to perform operations with a token you created (so it has no cost to you), then <code>initialize</code> again with factory set to the proper value</p>\n<p>Because certain functions do not check for the product being created by the factory, this can be done as a way to lay the ground for a rug against future depositors</p>\n<p>So to my eyes this finding highlights the consequences of a lack of the <code>initializer</code> modifier, while the other is the usual <code>initializer can be frontrun</code> non critical finding</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001299037\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@kbrizzle to clarify: you won’t be frontrun with your deployment as the deploy + initialize is done in one tx.\nBut the <code>Collateral</code>  not having <code>initializer</code> can be used by the deployer for malicious purposes because what was perceived as an <code>unchangeable</code> token can actually be changed if you set up <code>initialize</code> with the factory address set to 0</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001301453\">kbrizzle (Perennial) commented</a>:</strong></p>\n<blockquote>\n<p>@Alex the Entreprenerd I see, that makes sense from the perspective of the token seeming like it should be immutable 👍 </p>\n<p>FWIW in this scenario the deployer would have to run the risk of someone else initializing and taking admin for the duration that the malicious initial token was active - so I’m not sure how feasible that would be.</p>\n<p>That being said, I think a <code>UInitializable</code> would be a great addition to our lib anyways, so let’s go this route since this does seem like a solution with better guarantees. Thanks for the explanation!</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001304373\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The attack is dependent upon external conditions (malicious deployer, nobody else calling initialize, setting up malicious accounting), for that reason (as per the docs) I believe medium severity to be proper.</p>\n</blockquote>\n<h2 id=\"m-03-chainlinks-latestrounddata-might-return-stale-or-incorrect-results\" style=\"position:relative;\"><a href=\"#m-03-chainlinks-latestrounddata-might-return-stale-or-incorrect-results\" aria-label=\"m 03 chainlinks latestrounddata might return stale or incorrect results permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/24\">[M-03] Chainlink’s <code>latestRoundData</code> might return stale or incorrect results</a></h2>\n<p><em>Submitted by WatchPug, also found by cmichel, defsec, and ye0lde</em></p>\n<p><a href=\"https://github.com/code-423n4/2021-12-perennial/blob/fd7c38823833a51ae0c6ae3856a3d93a7309c0e4/protocol/contracts/oracle/ChainlinkOracle.sol#L50-L60\">https://github.com/code-423n4/2021-12-perennial/blob/fd7c38823833a51ae0c6ae3856a3d93a7309c0e4/protocol/contracts/oracle/ChainlinkOracle.sol#L50-L60</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sync</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (, </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feedPrice</span><span class=\"mtk1\">, , </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, ) = </span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestRoundData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Fixed18</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Fixed18Lib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ratio</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feedPrice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">SafeCast</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toInt256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_decimalOffset</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">priceAtVersion</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">timestampAtVersion</span><span class=\"mtk1\">[</span><span class=\"mtk11\">currentVersion</span><span class=\"mtk1\">()] + </span><span class=\"mtk12\">minDelay</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">priceAtVersion</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">timestampAtVersion</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Version</span><span class=\"mtk1\">(</span><span class=\"mtk11\">currentVersion</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>On <code>ChainlinkOracle.sol</code>, we are using <code>latestRoundData</code>, but there is no check if the return value indicates stale data. This could lead to stale prices according to the Chainlink documentation:</p>\n<ul>\n<li><a href=\"https://docs.chain.link/docs/historical-price-data/#historical-rounds\">https://docs.chain.link/docs/historical-price-data/#historical-rounds</a></li>\n<li><a href=\"https://docs.chain.link/docs/faq/#how-can-i-check-if-the-answer-to-a-round-is-being-carried-over-from-a-previous-round\">https://docs.chain.link/docs/faq/#how-can-i-check-if-the-answer-to-a-round-is-being-carried-over-from-a-previous-round</a></li>\n</ul>\n<h4 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h4>\n<p>Consider adding missing checks for stale data.</p>\n<p>For example:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">uint80</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feedPrice</span><span class=\"mtk1\">, , </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint80</span><span class=\"mtk1\"> </span><span class=\"mtk12\">answeredInRound</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestRoundData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feedPrice</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Chainlink price &lt;= 0&quot;</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">answeredInRound</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">roundID</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Stale price&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Round not complete&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/24\">kbrizzle (Perennial) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/24#issuecomment-1001295232\">Alex the Entreprenerd (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree with the finding, while you can get started with Chainlink’s feed can be used with one line of code, in a production environment it is best to ensure that the data is fresh and within rational bounds</p>\n</blockquote>\n<h1 id=\"low-risk-findings-6\" style=\"position:relative;\"><a href=\"#low-risk-findings-6\" aria-label=\"low risk findings 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Findings (6)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/11\">[L-02] Not verified function inputs of public / external functions</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/72\">[L-03] On updating the Incentive fee greater than UFixedLib18.ONE, new Programs can not be created</a> <em>Submitted by hubble</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/50\">[L-04] Missing fee parameter validation</a> <em>Submitted by cmichel, also found by 0x1f8b and defsec</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/54\">[L-05] Fixed18 conversions don’t work for all values</a> <em>Submitted by cmichel, also found by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/35\">[L-06] <code>Factory.sol#updateController()</code> Lack of input validation</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/36\">[L-01] <code>Incentivizer.sol</code> Tokens with fee on transfer are not supported</a> <em>Submitted by WatchPug</em></li>\n</ul>\n<h1 id=\"non-critical-findings-5\" style=\"position:relative;\"><a href=\"#non-critical-findings-5\" aria-label=\"non critical findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Findings (5)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/12\">[N-05] Unsecure Ownership Transfer</a> <em>Submitted by 0x1f8b, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/1\">[N-01] Unused imports</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/10\">[N-02] Solidity compiler versions mismatch</a> <em>Submitted by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/71\">[N-03] Initialization functions can be front-run</a> <em>Submitted by broccolirob, also found by leastwood, cmichel, and WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/41\">[N-04]  Removing redundant code can save gas (Collateral, Factory, Incentivizer, ChainlinkOracle)</a> <em>Submitted by ye0lde</em></li>\n</ul>\n<h1 id=\"gas-optimizations-22\" style=\"position:relative;\"><a href=\"#gas-optimizations-22\" aria-label=\"gas optimizations 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations (22)</h1>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/43\">[G-01] claimFee loop does not check for zero transfer amount (Incentivizer.sol) </a> <em>Submitted by ye0lde</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/33\">[G-02] Cache storage read and call results in the stack can save gas</a> <em>Submitted by WatchPug, also found by gzeon</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/31\">[G-03] Cache array length in for loops can save gas</a> <em>Submitted by WatchPug, also found by 0x0x0x, pmerkleplant, and robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/34\">[G-04] Unnecessary checked arithmetic in for loops</a> <em>Submitted by WatchPug, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/32\">[G-05] Reuse operation results can save gas</a> <em>Submitted by WatchPug, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/29\">[G-06] Use immutable variables can save gas</a> <em>Submitted by WatchPug, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/37\">[G-07] Best Practice: public functions not used by current contract should be external</a> <em>Submitted by WatchPug, also found by robee</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/20\">[G-09] Avoid unnecessary arithmetic operations can save gas</a> <em>Submitted by WatchPug, also found by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/57\">[G-10] Adding unchecked directive can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/40\">[G-11] Cache storage variables in the stack can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/39\">[G-12] Remove unnecessary variables can make the code simpler and save some gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/38\">[G-13] Inline unnecessary function can make the code simpler and save some gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/30\">[G-14] Avoid unnecessary <code>SafeCast.toInt256()</code> can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/27\">[G-15] Adding a new method <code>provider.currentPrice()</code> can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/26\">[G-16] Avoid unnecessary external calls can save gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/23\">[G-17] <code>Token18.sol#balanceOf()</code> When <code>isEther()</code>, <code>fromTokenAmount()</code> is unnecessary</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/22\">[G-18] <code>Token18.sol#push()</code> When <code>isEther()</code>, <code>toTokenAmount()</code> is unnecessary</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/21\">[G-19] <code>10 ** 18</code> can be changed to <code>1e18</code> and save some gas</a> <em>Submitted by WatchPug</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/70\">[G-20] <code>Collateral.sol#maintananceInvariant</code> can be combined with <code>collateralnvarant</code> to save gas</a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/65\">[G-21] At <code>Product.sol#closeAll</code>, cache <code>_position[account]</code></a> <em>Submitted by 0x0x0x</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/52\">[G-22] <code>NotControllerOwnerError</code> error not used</a> <em>Submitted by cmichel</em></li>\n<li><a href=\"https://github.com/code-423n4/2021-12-perennial-findings/issues/66\">[G-08] At settleAccountInternal, check whether the position can be changeable to pre more efficiently</a> <em>Submitted by 0x0x0x</em></li>\n</ul>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-wrong-shortfall-calculation\">[H-01] Wrong shortfall calculation</a></li>\n<li><a href=\"#h-02-withdrawto-does-not-sync-before-checking-a-positions-margin-requirements\">[H-02] <code>withdrawTo</code> Does Not Sync Before Checking A Position’s Margin Requirements</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-3\">Medium Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#m-01-no-checks-if-given-product-is-created-by-the-factory\">[M-01] No checks if given product is created by the factory</a></li>\n<li><a href=\"#m-02-multiple-initialization-of-collateral-contract\">[M-02] Multiple initialization of Collateral contract</a></li>\n<li><a href=\"#m-03-chainlinks-latestrounddata-might-return-stale-or-incorrect-results\">[M-03] Chainlink’s <code>latestRoundData</code> might return stale or incorrect results</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-findings-6\">Low Risk Findings (6)</a></li>\n<li><a href=\"#non-critical-findings-5\">Non-Critical Findings (5)</a></li>\n<li><a href=\"#gas-optimizations-22\">Gas Optimizations (22)</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 code contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the code contest outlined in this document, C4 conducted an analysis of Perennial contest smart contract system written in Solidity. The code contest took place between December 9—December 15 2021.\n\n## Wardens\n\n13 Wardens contributed reports to the Perennial contest:\n\n1. [leastwood](https://twitter.com/liam_eastwood13) \n1. [kenzo](https://twitter.com/KenzoAgada)\n1. WatchPug ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n1. 0x0x0x\n1. 0x1f8b\n1. [cmichel](https://twitter.com/cmichelio)\n1. robee\n1. hubble (ksk2345 and shri4net)\n1. [defsec](https://twitter.com/defsec_)\n1. [ye0lde](https://twitter.com/_ye0lde)\n1. [gzeon](https://twitter.com/gzeon)\n1. [pmerkleplant](https://twitter.com/merkleplant_eth)\n1. [broccolirob](https://twitter.com/0xbroccolirob)\n\nThis contest was judged by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay) and [CloudEllie](https://twitter.com/CloudEllie1).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 11 unique vulnerabilities and 38 total findings. All of the issues presented here are linked back to their original finding.\n\nOf these vulnerabilities, 2 received a risk rating in the category of HIGH severity, 3 received a risk rating in the category of MEDIUM severity, and 6 received a risk rating in the category of LOW severity.\n\nC4 analysis also identified 5 non-critical recommendations and 22 gas optimizations.\n\n# Scope\n\nThe code under review can be found within the [C4 Perennial contest repository](https://github.com/code-423n4/2021-12-perennial), and is composed of 38 smart contracts written in the Solidity programming language and includes 3531 lines of Solidity code and 7 lines of JavaScript.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code423n4.com).\n\n# High Risk Findings (2)\n## [[H-01] Wrong shortfall calculation](https://github.com/code-423n4/2021-12-perennial-findings/issues/18)\n_Submitted by kenzo_\n\nEvery time an account is settled, if shortfall is created, due to a wrong calculation shortfall will double in size and add the new shortfall.\n\n#### Impact\n\nLoss of funds: users won't be able to withdraw the correct amount of funds. Somebody would have to donate funds to resolve the wrong shortfall.\n\n#### Proof of Concept\n\nWe can see in the `settleAccount` of `OptimisticLedger` that `self.shortfall` ends up being `self.shortfall+self.shortfall+newShortfall`: [(Code ref)](https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/collateral/types/OptimisticLedger.sol#L63:#L74)\n\n```solidity\nfunction settleAccount(OptimisticLedger storage self, address account, Fixed18 amount)\ninternal returns (UFixed18 shortfall) {\n    Fixed18 newBalance = Fixed18Lib.from(self.balances[account]).add(amount);\n\n    if (newBalance.sign() == -1) {\n        shortfall = self.shortfall.add(newBalance.abs());\n        newBalance = Fixed18Lib.ZERO;\n    }\n\n    self.balances[account] = newBalance.abs();\n    self.shortfall = self.shortfall.add(shortfall);\n}\n```\n\nAdditionally, you can add the following line to the \"shortfall reverts if depleted\" test in `Collateral.test.js`, line 190:\n\n```js\nawait collateral.connect(productSigner).settleAccount(userB.address, -50)\n```\n\nPreviously the test product had 50 shortfall. Now we added 50 more, but the test will print that the actual shortfall is 150, and not 100 as it should be.\n\n#### Recommended Mitigation Steps\n\nMove the setting of `self.shortfall` to inside the if function and change the line to:\n```\n    self.shortfall = shortfall\n``` \n\n**[kbrizzle (Perennial) confirmed](https://github.com/code-423n4/2021-12-perennial-findings/issues/18#issuecomment-995416504):**\n > Excellent find 🙏 \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/18#issuecomment-1001280292):**\n > Agree with the finding `shortfall = self.shortfall.add(newBalance.abs());` is already shortfal + newBalance.abs()\n> So performing line `73` `self.shortfall = self.shortfall.add(shortfall);` is adding `shortfall` again\n\n\n\n## [[H-02] `withdrawTo` Does Not Sync Before Checking A Position's Margin Requirements](https://github.com/code-423n4/2021-12-perennial-findings/issues/74)\n_Submitted by leastwood_\n\n#### Impact\n\nThe `maintenanceInvariant` modifier in `Collateral` aims to check if a user meets the margin requirements to withdraw collateral by checking its current and next maintenance. `maintenanceInvariant` inevitably calls `AccountPosition.maintenance` which uses the oracle's price to calculate the margin requirements for a given position. Hence, if the oracle has not synced in a long time, `maintenanceInvariant` may end up utilising an outdated price for a withdrawal. This may allow a user to withdraw collateral on an undercollaterized position.\n\n#### Proof of Concept\n\n<https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/collateral/Collateral.sol#L67-L76>\n\n```solidity\nfunction withdrawTo(address account, IProduct product, UFixed18 amount)\nnotPaused\ncollateralInvariant(msg.sender, product)\nmaintenanceInvariant(msg.sender, product)\nexternal {\n    _products[product].debitAccount(msg.sender, amount);\n    token.push(account, amount);\n\n    emit Withdrawal(msg.sender, product, amount);\n}\n```\n<https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/collateral/Collateral.sol#L233-L241>\n```solidity\nmodifier maintenanceInvariant(address account, IProduct product) {\n    _;\n\n    UFixed18 maintenance = product.maintenance(account);\n    UFixed18 maintenanceNext = product.maintenanceNext(account);\n\n    if (UFixed18Lib.max(maintenance, maintenanceNext).gt(collateral(account, product)))\n        revert CollateralInsufficientCollateralError();\n}\n```\n<https://github.com/code-423n4/2021-12-perennial/blob/main/protocol/contracts/product/types/position/AccountPosition.sol#L71-L75>\n```solidity\nfunction maintenanceInternal(Position memory position, IProductProvider provider) private view returns (UFixed18) {\n    Fixed18 oraclePrice = provider.priceAtVersion(provider.currentVersion());\n    UFixed18 notionalMax = Fixed18Lib.from(position.max()).mul(oraclePrice).abs();\n    return notionalMax.mul(provider.maintenance());\n}\n```\n#### Tools Used\n\nManual code review.\n\n#### Recommended Mitigation Steps\n\nConsider adding `settleForAccount(msg.sender)` to the `Collateral.withdrawTo` function to ensure the most up to date oracle price is used when assessing an account's margin requirements.\n\n**[kbrizzle (Perennial) confirmed](https://github.com/code-423n4/2021-12-perennial-findings/issues/74#issuecomment-996589429):**\n > Great catch 🙏 \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/74#issuecomment-1001590562):**\n > With most onChain protocols where there is potential for undercollateralized positions and liquidations, it is very important to accrue a user position before making any changes to their balance.\n> \n> The warden identified a potential way for a user to withdraw funds while their account is below margin requirements.\n> \n> Because this impacts the core functionality functionality of the protocol (accounting), I'm raising the severity to high\n> \n> Mitigation seems to be straightforward\n\n\n\n \n# Medium Risk Findings (3)\n## [[M-01] No checks if given product is created by the factory](https://github.com/code-423n4/2021-12-perennial-findings/issues/63)\n_Submitted by 0x0x0x_\n\nAn attacker can create a fake product. `Collateral` contract does not check whether the given product is created by the factory. A malicious product can return arbitrary maintenance amounts, therefore they can make any deposit to fake product stuck (simply return collateral - 1 as maintenance) and fake product owner can change the maintenance and liquidate whenever wanted and claim full collateral.\n\nThis is a serious attack vector, since by only interacting with `Collateral` contract the user can lose funds. Furthermore, this vulnerability poses big risks in combination web vulnerabilities. Users always have to check the product address to avoid getting scammed, but likely most users will only check the contract address.\n\nFurthermore, if another protocol would want to add perennial protocol for its use case, the other protocol has to be careful with this behaviour and keep track of whitelisted products. This complicates adoption of perennial protocol, since whitelist has to be managed manually or else this vulnerability will likely be exploitable.\n\n#### Mitigation step\n\nAdd a mapping inside `Collateral`, which verifies whether a product is created by factory or not. This mapping should get updated by the factory. This will add a little bit gas cost, but will eliminate a serious attack vector.\n\nOr less gas efficient option is directly call a function from factory to verify.\n\n**[kbrizzle (Perennial) disagreed with severity](https://github.com/code-423n4/2021-12-perennial-findings/issues/63#issuecomment-997158601):**\n > Good find 🙏 \n> \n> On severity: In general there's a whole plethora of ways a Product owner could create a product that harmful a user which choses to take part in it. The design model of Perennial is to give the Product owners the *freedom* to create risky products, but to segregate that risk to only those products, and this issue does not break this segregation of risk. This is especially important during our gated-beta phase while we learn which levers are worth it to lock down. \n> \n> That being said this is low hanging fruit to correct, so we think it should still be `2 (Medium)` severity.\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/63#issuecomment-1001284165):**\n > Given the extensible nature of the `Collateral` contract, users can call the contract with any user input for `product` this could be used maliciously against the users as the warden highlighted.\n> \n> This can definitely happen, but is contingent on a set of external factors, so I think medium severity is more appropriate\n\n\n\n## [[M-02] Multiple initialization of Collateral contract](https://github.com/code-423n4/2021-12-perennial-findings/issues/13)\n_Submitted by 0x1f8b_\n\n#### Impact\n\nThe attacker can initialize the contract, take malicious actions, and allow it to be re-initialized by the project without any error being noticed.\n\n#### Proof of Concept\n\nThe `initialize` method of the`  Collateral ` contract does not contain the `initializer` modifier, it delegates this process to check if the factory is different from address(0) in the`  UFactoryProvider__initialize ` call, however the ` factory_  `is other than address(0), so an attacker could use front-running by listening to the memory pool, initialize the contract with a `factory=address(0)`, perform malicious actions, and still allow it to be started later by the I draft the contract without noticing any error.\n\nSource reference:\n\n*   Collateral.initialize\n\n#### Tools Used\n\nManual review\n\n#### Recommended Mitigation Steps\n\nUse `initializer` modifier\n\n**[kbrizzle (Perennial) marked as duplicate](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-995339471):**\n > Duplicate of: https://github.com/code-423n4/2021-12-perennial-findings/issues/71\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001284802):**\n > Disagree with sponsor that this is duplicate of #73 \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001285612):**\n > The finding mentions that `initialize` can be called multiple times, specifically by first having `factory` set to address(0) and then setting it to it's final value.\n> \n> This is true.\n> \n> Calling initialize multiple times could allow to set certain values up with a different token, then change to another token and set the factory. This could be used to trick the protocol accounting to later take advantage of other depositors.\n> \n> \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001285964):**\n > The specific vulnerability is the lack of the  `initializer` modifier on initialize, the consequences  can be problematic only if a malicious actor were to set the contracts up.\n> \n> Because this can be done, and it's reliant on a specific setup, I'll mark the finding as medium severity, mitigation is straightforward\n\n**[kbrizzle (Perennial) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001294139):**\n > My understanding of these is that:\n> \n> - #73 would allow an attacker to front-run the initialization of a contract to gain admin, but the subsequent legitimate attempt to initialize would revert.\n> - #13 would allow an attacker to front-run the initialization of a contract to gain admin, and the subsequent legitimate attempt to initialize would still work (thereby possibly going unnoticed).\n> \n> If we want to tag these as separate issues, I think that makes sense as the effects are slightly different. Both are ultimately a documentation issue though solved by this [remediation](https://github.com/code-423n4/2021-12-perennial-findings/issues/71#issuecomment-995343823), so I'm wondering why one is tagged as `0 (Non-critical)` and the other `2 (Medium)`.\n> \n> Is that correct, or is there an issue here even *with* proper atomic deploy-and-initialize usage with OZ's upgrades plugin? Just want to make sure we're not missing something else here. Also - we do not have an `initializer` modifier available in the code base, so the remediation suggestion was a little confusing.\n> \n> \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001296121):**\n > @kbrizzle Yes, this is something that can still be done, arguably only by your deployer\n> \n> You could deploy and `initialize` the contract with factory set to 0, use that to perform operations with a token you created (so it has no cost to you), then `initialize` again with factory set to the proper value\n> \n> Because certain functions do not check for the product being created by the factory, this can be done as a way to lay the ground for a rug against future depositors\n> \n> So to my eyes this finding highlights the consequences of a lack of the `initializer` modifier, while the other is the usual `initializer can be frontrun` non critical finding\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001299037):**\n > @kbrizzle to clarify: you won't be frontrun with your deployment as the deploy + initialize is done in one tx.\n> But the `Collateral`  not having `initializer` can be used by the deployer for malicious purposes because what was perceived as an `unchangeable` token can actually be changed if you set up `initialize` with the factory address set to 0\n\n**[kbrizzle (Perennial) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001301453):**\n > @Alex the Entreprenerd I see, that makes sense from the perspective of the token seeming like it should be immutable 👍 \n> \n> FWIW in this scenario the deployer would have to run the risk of someone else initializing and taking admin for the duration that the malicious initial token was active - so I'm not sure how feasible that would be.\n> \n> That being said, I think a `UInitializable` would be a great addition to our lib anyways, so let's go this route since this does seem like a solution with better guarantees. Thanks for the explanation!\n> \n> \n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/13#issuecomment-1001304373):**\n > The attack is dependent upon external conditions (malicious deployer, nobody else calling initialize, setting up malicious accounting), for that reason (as per the docs) I believe medium severity to be proper.\n\n\n\n## [[M-03] Chainlink's `latestRoundData` might return stale or incorrect results](https://github.com/code-423n4/2021-12-perennial-findings/issues/24)\n_Submitted by WatchPug, also found by cmichel, defsec, and ye0lde_\n\n<https://github.com/code-423n4/2021-12-perennial/blob/fd7c38823833a51ae0c6ae3856a3d93a7309c0e4/protocol/contracts/oracle/ChainlinkOracle.sol#L50-L60>\n\n```solidity\nfunction sync() public {\n    (, int256 feedPrice, , uint256 timestamp, ) = feed.latestRoundData();\n    Fixed18 price = Fixed18Lib.ratio(feedPrice, SafeCast.toInt256(_decimalOffset));\n\n    if (priceAtVersion.length == 0 || timestamp > timestampAtVersion[currentVersion()] + minDelay) {\n        priceAtVersion.push(price);\n        timestampAtVersion.push(timestamp);\n\n        emit Version(currentVersion(), timestamp, price);\n    }\n}\n```\n\nOn `ChainlinkOracle.sol`, we are using `latestRoundData`, but there is no check if the return value indicates stale data. This could lead to stale prices according to the Chainlink documentation:\n\n*   <https://docs.chain.link/docs/historical-price-data/#historical-rounds>\n*   <https://docs.chain.link/docs/faq/#how-can-i-check-if-the-answer-to-a-round-is-being-carried-over-from-a-previous-round>\n\n#### Recommendation\n\nConsider adding missing checks for stale data.\n\nFor example:\n\n```solidity\n(uint80 roundID, int256 feedPrice, , uint256 timestamp, uint80 answeredInRound) = feed.latestRoundData();\nrequire(feedPrice > 0, \"Chainlink price <= 0\"); \nrequire(answeredInRound >= roundID, \"Stale price\");\nrequire(timestamp != 0, \"Round not complete\");\n```\n\n**[kbrizzle (Perennial) confirmed](https://github.com/code-423n4/2021-12-perennial-findings/issues/24)**\n\n**[Alex the Entreprenerd (judge) commented](https://github.com/code-423n4/2021-12-perennial-findings/issues/24#issuecomment-1001295232):**\n > Agree with the finding, while you can get started with Chainlink's feed can be used with one line of code, in a production environment it is best to ensure that the data is fresh and within rational bounds\n\n# Low Risk Findings (6)\n- [[L-02] Not verified function inputs of public / external functions](https://github.com/code-423n4/2021-12-perennial-findings/issues/11) _Submitted by robee_\n- [[L-03] On updating the Incentive fee greater than UFixedLib18.ONE, new Programs can not be created](https://github.com/code-423n4/2021-12-perennial-findings/issues/72) _Submitted by hubble_\n- [[L-04] Missing fee parameter validation](https://github.com/code-423n4/2021-12-perennial-findings/issues/50) _Submitted by cmichel, also found by 0x1f8b and defsec_\n- [[L-05] Fixed18 conversions don't work for all values](https://github.com/code-423n4/2021-12-perennial-findings/issues/54) _Submitted by cmichel, also found by WatchPug_\n- [[L-06] `Factory.sol#updateController()` Lack of input validation](https://github.com/code-423n4/2021-12-perennial-findings/issues/35) _Submitted by WatchPug_\n- [[L-01] `Incentivizer.sol` Tokens with fee on transfer are not supported](https://github.com/code-423n4/2021-12-perennial-findings/issues/36) _Submitted by WatchPug_\n\n# Non-Critical Findings (5)\n- [[N-05] Unsecure Ownership Transfer](https://github.com/code-423n4/2021-12-perennial-findings/issues/12) _Submitted by 0x1f8b, also found by robee_\n- [[N-01] Unused imports](https://github.com/code-423n4/2021-12-perennial-findings/issues/1) _Submitted by robee_\n- [[N-02] Solidity compiler versions mismatch](https://github.com/code-423n4/2021-12-perennial-findings/issues/10) _Submitted by robee_\n- [[N-03] Initialization functions can be front-run](https://github.com/code-423n4/2021-12-perennial-findings/issues/71) _Submitted by broccolirob, also found by leastwood, cmichel, and WatchPug_\n- [[N-04]  Removing redundant code can save gas (Collateral, Factory, Incentivizer, ChainlinkOracle)](https://github.com/code-423n4/2021-12-perennial-findings/issues/41) _Submitted by ye0lde_\n\n# Gas Optimizations (22)\n- [[G-01] claimFee loop does not check for zero transfer amount (Incentivizer.sol) ](https://github.com/code-423n4/2021-12-perennial-findings/issues/43) _Submitted by ye0lde_\n- [[G-02] Cache storage read and call results in the stack can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/33) _Submitted by WatchPug, also found by gzeon_\n- [[G-03] Cache array length in for loops can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/31) _Submitted by WatchPug, also found by 0x0x0x, pmerkleplant, and robee_\n- [[G-04] Unnecessary checked arithmetic in for loops](https://github.com/code-423n4/2021-12-perennial-findings/issues/34) _Submitted by WatchPug, also found by robee_\n- [[G-05] Reuse operation results can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/32) _Submitted by WatchPug, also found by robee_\n- [[G-06] Use immutable variables can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/29) _Submitted by WatchPug, also found by robee_\n- [[G-07] Best Practice: public functions not used by current contract should be external](https://github.com/code-423n4/2021-12-perennial-findings/issues/37) _Submitted by WatchPug, also found by robee_\n- [[G-09] Avoid unnecessary arithmetic operations can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/20) _Submitted by WatchPug, also found by cmichel_\n- [[G-10] Adding unchecked directive can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/57) _Submitted by WatchPug_\n- [[G-11] Cache storage variables in the stack can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/40) _Submitted by WatchPug_\n- [[G-12] Remove unnecessary variables can make the code simpler and save some gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/39) _Submitted by WatchPug_\n- [[G-13] Inline unnecessary function can make the code simpler and save some gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/38) _Submitted by WatchPug_\n- [[G-14] Avoid unnecessary `SafeCast.toInt256()` can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/30) _Submitted by WatchPug_\n- [[G-15] Adding a new method `provider.currentPrice()` can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/27) _Submitted by WatchPug_\n- [[G-16] Avoid unnecessary external calls can save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/26) _Submitted by WatchPug_\n- [[G-17] `Token18.sol#balanceOf()` When `isEther()`, `fromTokenAmount()` is unnecessary](https://github.com/code-423n4/2021-12-perennial-findings/issues/23) _Submitted by WatchPug_\n- [[G-18] `Token18.sol#push()` When `isEther()`, `toTokenAmount()` is unnecessary](https://github.com/code-423n4/2021-12-perennial-findings/issues/22) _Submitted by WatchPug_\n- [[G-19] `10 ** 18` can be changed to `1e18` and save some gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/21) _Submitted by WatchPug_\n- [[G-20] `Collateral.sol#maintananceInvariant` can be combined with `collateralnvarant` to save gas](https://github.com/code-423n4/2021-12-perennial-findings/issues/70) _Submitted by 0x0x0x_\n- [[G-21] At `Product.sol#closeAll`, cache `_position[account]`](https://github.com/code-423n4/2021-12-perennial-findings/issues/65) _Submitted by 0x0x0x_\n- [[G-22] `NotControllerOwnerError` error not used](https://github.com/code-423n4/2021-12-perennial-findings/issues/52) _Submitted by cmichel_\n- [[G-08] At settleAccountInternal, check whether the position can be changeable to pre more efficiently](https://github.com/code-423n4/2021-12-perennial-findings/issues/66) _Submitted by 0x0x0x_\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}