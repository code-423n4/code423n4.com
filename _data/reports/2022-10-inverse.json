{
  "circa": {
    "title": "Inverse Finance contest",
    "sponsor": "Inverse Finance",
    "slug": "2022-10-inverse",
    "date": "2022-12-20",
    "findings": "https://github.com/code-423n4/2022-10-inverse-findings/issues",
    "contest": 175
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Inverse Finance smart contract system written in Solidity. The audit contest took place between October 25—October 30 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>140 Wardens contributed reports to the Inverse Finance contest:</p>\n<ol>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>0xRobocop</li>\n<li><a href=\"https://twitter.com/0xRoxas\">0xRoxas</a></li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>0xbepresent</li>\n<li>0xc0ffEE</li>\n<li>2997ms</li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li>Amithuddar</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>B2</li>\n<li>BClabs (nalus and Reptilia)</li>\n<li>Bnke0x0</li>\n<li>CertoraInc (egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, shakedwinder, and RoiEvenHaim)</li>\n<li><a href=\"https://twitter.com/0xch301\">Ch_301</a></li>\n<li><a href=\"https://www.linkedin.com/in/evgeniy-shaldin-21898712a/\">Chandr</a></li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li>CloudX (<a href=\"https://twitter.com/angel_tripi\">Migue</a>, pabliyo, and marce1993)</li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li>Diana</li>\n<li>Dinesh11G</li>\n<li><a href=\"https://twitter.com/ElKu_crypto\">ElKu</a></li>\n<li><a href=\"https://franfran.dev/\">Franfran</a></li>\n<li>HardlyCodeMan</li>\n<li>Holmgren</li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li><a href=\"https://jeiwan.net\">Jeiwan</a></li>\n<li>Josiah</li>\n<li><a href=\"https://twitter.com/JagadeshRonanki\">JrNet</a></li>\n<li>Jujic</li>\n<li>KoKo</li>\n<li>Lambda</li>\n<li>M4TZ1P (<a href=\"https://twitter.com/huna38699\">DekaiHako</a>, holyhansss_kr, <a href=\"https://twitter.com/younsle1\">Zer0Luck</a>, AAIIWITF, and <a href=\"https://github.com/exd0tpy\">exd0tpy</a>)</li>\n<li>Mathieu</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>Olivierdem</li>\n<li>Ozy42</li>\n<li><a href=\"https://twitter.com/thePicodes\">Picodes</a></li>\n<li><a href=\"https://www.linkedin.com/in/nhan-vo-a9473019a/\">Rahoz</a></li>\n<li>RaoulSchaffranek</li>\n<li>RaymondFam</li>\n<li>ReyAdmirado</li>\n<li>Rolezn</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>Shinchan (<a href=\"https://twitter.com/Sm4rty_\">Sm4rty</a>, <a href=\"https://twitter.com/prasantgupta52\">prasantgupta52</a>, and <a href=\"https://twitter.com/rohan16___\">Rohan16</a>)</li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li>Wawrdog</li>\n<li>Waze</li>\n<li>__141345__</li>\n<li><a href=\"https://github.com/romeroadrian\">adriro</a></li>\n<li>ajtra</li>\n<li>aphak5010</li>\n<li>ballx</li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>brgltd</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>c7e7eff</li>\n<li><a href=\"https://twitter.com/CAA1994\">carlitox477</a></li>\n<li><a href=\"https://twitter.com/catchup22\">catchup</a></li>\n<li>cccz</li>\n<li>cducrest</li>\n<li>ch0bu</li>\n<li>chaduke</li>\n<li>chrisdior4</li>\n<li>codexploder</li>\n<li>corerouter</li>\n<li>cryptonue</li>\n<li>cryptostellar5</li>\n<li>cryptphi</li>\n<li>cuteboiz</li>\n<li><a href=\"https://twitter.com/cylzxje\">cylzxje</a></li>\n<li>d3e4</li>\n<li>delfin454000</li>\n<li>dipp</li>\n<li>djxploit</li>\n<li><a href=\"https://github.com/lyciumlee\">durianSausage</a></li>\n<li>eierina</li>\n<li><a href=\"https://twitter.com/kamensec\">elprofesor</a></li>\n<li>enckrish</li>\n<li>evmwanderer</li>\n<li>exolorkistis</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219\">gogo</a></li>\n<li>gs8nrv</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>horsefacts</li>\n<li>idkwhatimdoing</li>\n<li>imare</li>\n<li>immeas</li>\n<li>jayphbee</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>jwood</li>\n<li><a href=\"https://twitter.com/0xKaden\">kaden</a></li>\n<li>karanctf</li>\n<li>ladboy233</li>\n<li>leosathya</li>\n<li>lukris02</li>\n<li><a href=\"https://github.com/martin-petrov03\">martin</a></li>\n<li>mcwildy</li>\n<li>minhtrng</li>\n<li>neumo</li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li>pashov</li>\n<li>peanuts</li>\n<li>pedr02b2</li>\n<li><a href=\"https://twitter.com/Pedroais2/\">pedroais</a></li>\n<li><a href=\"https://t.me/pfahard\">pfapostol</a></li>\n<li>rbserver</li>\n<li><a href=\"https://twitter.com/ret2basic\">ret2basic</a></li>\n<li>robee</li>\n<li><a href=\"twitter.com/rokinot\">rokinot</a></li>\n<li>rotcivegaf</li>\n<li>rvierdiiev</li>\n<li>sakman</li>\n<li>sakshamguruji</li>\n<li>sam_cunningham</li>\n<li><a href=\"https://medium.com/@saneryee-studio\">saneryee</a></li>\n<li>shark</li>\n<li>simon135</li>\n<li>skyle</li>\n<li>sorrynotsorry</li>\n<li>tnevler</li>\n<li>tonisives</li>\n<li>trustindistrust</li>\n<li>wagmi</li>\n<li><a href=\"https://twitter.com/yamapyblack\">yamapyblack</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/0xean\">0xean</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 18 unique vulnerabilities. Of these vulnerabilities, 0 received a risk rating in the category of HIGH severity and 18 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 54 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 55 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-10-inverse\">C4 Inverse Finance contest repository</a>, and is composed of 8 smart contracts written in the Solidity programming language and includes 901 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"medium-risk-findings-18\" style=\"position:relative;\"><a href=\"#medium-risk-findings-18\" aria-label=\"medium risk findings 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (18)</h1>\n<h2 id=\"m-01-unhandled-return-values-of-transfer-and-transferfrom\" style=\"position:relative;\"><a href=\"#m-01-unhandled-return-values-of-transfer-and-transferfrom\" aria-label=\"m 01 unhandled return values of transfer and transferfrom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/10\">[M-01] Unhandled return values of <code>transfer</code> and <code>transferFrom</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/10\">2997ms</a></em></p>\n<p>ERC20 implementations are not always consistent. Some implementations of transfer and transferFrom could return ‘false’ on failure instead of reverting. It is safer to wrap such calls into <code>require()</code> statements to these failures.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L205\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L205</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L280\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L280</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L399\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L399</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L537\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L537</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L570\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L570</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L602\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L602</a><br></p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check the return value and revert on <code>0/false</code> or use OpenZeppelin’s SafeERC20 wrapper functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/10#issuecomment-1351551238\">08xmt (Inverse) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Every deployment of a market will use a trusted token, and be audited by the DAO and governance. Even when using safe transfer, there’s no guarantee that an ERC20 token will behave as expected.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-users-can-avoid-paying-fees-if-they-manage-to-update-their-accrued-fees-periodically\" style=\"position:relative;\"><a href=\"#m-02-users-can-avoid-paying-fees-if-they-manage-to-update-their-accrued-fees-periodically\" aria-label=\"m 02 users can avoid paying fees if they manage to update their accrued fees periodically permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/83\">[M-02] Users can avoid paying fees if they manage to update their accrued fees periodically</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/83\">RaoulSchaffranek</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/215\">carlitox477</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L287\">DBR.sol#L287</a><br></p>\n<p>While a user borrows DOLA, his debt position in the DBR contract accrues more debt over time. However, Solidity contracts cannot update their storage automatically over time; state updates must always be triggered by externally owned accounts. For this reason, the DBR contract cannot accurately represent a user’s debt position in its storage at all times. Instead, the contract offers a method <code>accrueDueTokens</code> that, when called, updates the internal storage with the debts that accrued since the last update. This method is called before all critical financial operations that depend on an accurate value of the accumulated deficit in the contract’s storage. On top, this method can also be invoked permissionless at any time. Suppose a borrower manages to call this function periodically and keep the time difference between updates short. In that case, a rounding error in the computation of the accrued debt can cause the expression to round down to zero. In this case, the user successfully avoided paying interest on his debt.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>For reference, here is the affected code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">accrueDueTokens</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lastUpdated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] == </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">accrued</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastUpdated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">]) * </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">dueTokensAccrued</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">accrued</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">totalDueTokensAccrued</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">accrued</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">lastUpdated</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">accrued</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The problem is that the function updates the <code>lastUpdated[user]</code> storage variable even when <code>accrued</code> is <code>0</code>.</p>\n<h4 id=\"example\" style=\"position:relative;\"><a href=\"#example\" aria-label=\"example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example</h4>\n<p>Let’s assume that the last update occurred at <code>t_0</code>.<br>\nFurther assume that the next update occurs at <code>t_1</code> with <code>t_1 - t_0 = 12s</code>. (<code>12s</code> is the current Ethereum block time)<br>\nSuppose that the user’s recorded <code>debt</code> position at <code>t_0</code> is <code>1,000,000 wei</code>.<br>\nThen the accrued debt formula gives us the following:<br></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">accrued = (t_1 - t_0) * debt / 365 days</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        = 12          * 1,000,000 / 31,536,000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        = 1,000,000 / 31,536,000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        = 0 (because unsigned integer division rounds down)</span></span></code></pre>\n<h4 id=\"maximizing-profit\" style=\"position:relative;\"><a href=\"#maximizing-profit\" aria-label=\"maximizing profit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Maximizing profit</h4>\n<p>The accrued debt formula rounds towards zero if we have <code>(t_1 - t_0) * debt &#x3C; 365 days</code>.<br>\nThis gives us a method to compute the maximal debt that we can deposit to make the attack more efficient:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">debt_max = 365 days / 12s -1 = 2,627,999</span></span></code></pre>\n<p>Notice that an attacker is not limited to these small loans. He can split a massive loan into multiple small loans, capped at 2,627,999.<br>\nTo borrow X tokens (where X is given in WEI), we can compute the number of needed loans as:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">#loans = X / 2,627,999</span></span></code></pre>\n<p>For example, to borrow 1 DOLA:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">#loans = 10^18 / 2,627,999 = 380517648599</span></span></code></pre>\n<p>To borrow 1,000,000 DOLA we would thus need 380,517,648,599,000,000 small loans.</p>\n<h4 id=\"economical-feasibility\" style=\"position:relative;\"><a href=\"#economical-feasibility\" aria-label=\"economical feasibility permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Economical feasibility</h4>\n<p>The attack would be economically feasible if the costs of the attack were lower than the interest that accrued throughout the successful attack.<br>\nThe dominating factor of the attack costs is the gas costs which the attacker needs to pay to update the accrued interest of the small loans every second. A clever attacker would batch as many updates into a single transaction as possible to minimize the gas overhead of the transaction. Still, at the current block time (12s), gas price (7 gwei), block gas limit (30,000,000), and current ETH price (<code>$1,550.80</code>), it’s hardly imaginable that this attack is economically feasible at the moment.</p>\n<h4 id=\"risk-parameters\" style=\"position:relative;\"><a href=\"#risk-parameters\" aria-label=\"risk parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Risk parameters</h4>\n<p>However, all these values could change in the future. And if we look at other networks, Layer2 or EVM compatible Layer1, the parameters might be different today.</p>\n<p>Also, notice that if the contract were used to borrow a different asset than DOLA, the numbers would look drastically different. The risk increases with the asset’s price and becomes bigger the fewer decimals the token uses. For example, to borrow 1 WBTC (8 decimals), we would only need 39 small loans:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">#loans = 10^8 / 2,627,999 ~39</span></span></code></pre>\n<p>And to borrow WBTC worth $1,000,000 at a price of 20,746$/BTC, we would need 1864 small loans.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">#loans ~= 49*10^8 / 2,627,999 ~= 1864</span></span></code></pre>\n<h4 id=\"foundry\" style=\"position:relative;\"><a href=\"#foundry\" aria-label=\"foundry permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Foundry</h4>\n<p>The following test demonstrates how to avoid paying interest on a loan for 1h. A failing test means that the attack was successful.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ git diff src/test/DBR.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/test/DBR.t.sol b/src/test/DBR.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 3988cf7..8779da7 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/test/DBR.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/test/DBR.t.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -25,6 +25,20 @@ contract DBRTest is FiRMTest {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    function testFail_free_borrow() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        uint borrowAmount =  2_627_999;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        vm.prank(address(market));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        dbr.onBorrow(user, borrowAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        for (uint i = 12; i &lt;= 3600; i += 12) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            vm.warp(block.timestamp + 12);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+            dbr.accrueDueTokens(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        assertEq(dbr.deficitOf(user), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     function testOnBorrow_Reverts_When_AccrueDueTokensBringsUserDbrBelow0() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         gibWeth(user, wethTestAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         gibDBR(user, wethTestAmount);</span></span></code></pre>\n<p>Output:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$ forge test --match-test testFail_free_borrow -vv</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[⠆] Compiling...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[⠊] Compiling 1 files with 0.8.17</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[⠢] Solc 0.8.17 finished in 2.62s</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Compiler run successful</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Running 1 test for src/test/DBR.t.sol:DBRTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[FAIL. Reason: Assertion failed.] testFail_free_borrow() (gas: 1621543)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: FAILED. 0 passed; 1 failed; finished in 8.03ms</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Failing tests:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Encountered 1 failing test in src/test/DBR.t.sol:DBRTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">[FAIL. Reason: Assertion failed.] testFail_free_borrow() (gas: 1621543)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Encountered a total of 1 failing tests, 0 tests succeeded</span></span></code></pre>\n<p>Classified as a high medium because the yields can get stolen/denied. It’s not high risk because I don’t see an economically feasible exploit.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode, Wolramapha, Foundry</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Document the risks transparently and prominently.</li>\n<li>Re-evaluate the risks according to the specific network parameters of every network you want to deploy to.</li>\n<li>Do not update the <code>lastUpdated</code> timestamp of the user if the computed accrued amount was zero.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/83#issuecomment-1304324558\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Debatable if this even qualifies as Medium. Leaning towards QA / LOW but will leave open for sponsor review.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/83#issuecomment-1315741882\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/InverseFinance/FrontierV2/pull/20\">https://github.com/InverseFinance/FrontierV2/pull/20</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-user-can-borrow-dola-indefinitely-without-settling-dbr-deficit-by-keeping-their-debt-close-to-the-allowed-maximum\" style=\"position:relative;\"><a href=\"#m-03-user-can-borrow-dola-indefinitely-without-settling-dbr-deficit-by-keeping-their-debt-close-to-the-allowed-maximum\" aria-label=\"m 03 user can borrow dola indefinitely without settling dbr deficit by keeping their debt close to the allowed maximum permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/155\">[M-03] User can borrow DOLA indefinitely without settling DBR deficit by keeping their debt close to the allowed maximum</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/155\">Holmgren</a></em></p>\n<p>A user can borrow DOLA interest-free. This requires the user to precisely manage their collateral. This issue might become especially troublesome if a Market is opened with some stablecoin as the collateral (because price fluctuations would become negligible and carefully managing collateral level would be easy).</p>\n<p>This issue is harder to exploit (but not impossible) if <code>gov</code> takes responsibility for forcing replenishment, since <code>gov</code> has a stronger economic incentive than third parties.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If my calculations are correct, with the current gas prices it costs about <code>$5</code> to call <code>Market.forceReplenish(...)</code>. Thus  there is no economic incentive to do so as long as a debtor’s DBR deficit is worth less than <code>$5</code>/<code>replenishmentIncentive</code> so probably around <code>$100</code>.</p>\n<p>This is because replenishing cannot push a user’s debt under the water (<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L567\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L567</a>) and a user can repay their debt without having settled the DBR deficit (<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L531\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L531</a>).</p>\n<p>So, assuming the current prices, a user can:</p>\n<ol>\n<li>Deposit some collateral</li>\n<li>Borrow close to the maximum allowed amount of DOLA</li>\n<li>Keep withdrawing or depositing collateral so that the collateral surplus does not exceed $100 (assuming current gas prices)</li>\n<li><code>repay()</code> their debt at any time in the future.</li>\n<li>Withdraw all the collateral.</li>\n</ol>\n<p>All this is possible with arbitrarily large DBR deficit because due to small collateral surplus at no point was it economical for a third party to <code>forceReplenish()</code> the user. If <code>gov</code> takes responsibility for <code>forceReplenish()</code>ing, the above procedure is still viable although the user has to maintain the collateral surplus at no more than around <code>$5</code>.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Allow replenishing to push the debt under the water and disallow repaying the debt with an outstanding DBR deficit. E.g.:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">diff --git a/src/Market.sol b/src/Market.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">index 9585b85..d69b599 100644</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">--- a/src/Market.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+++ b/src/Market.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -531,6 +531,7 @@ contract Market {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     function repay(address user, uint amount) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         uint debt = debts[user];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         require(debt &gt;= amount, &quot;Insufficient debt&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+        require(dbr.deficitOf(user) == 0, &quot;DBR Deficit&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         debts[user] -= amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         totalDebt -= amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         dbr.onRepay(user, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">@@ -563,8 +564,6 @@ contract Market {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         uint replenishmentCost = amount * dbr.replenishmentPriceBps() / 10000;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         uint replenisherReward = replenishmentCost * replenishmentIncentiveBps / 10000;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         debts[user] += replenishmentCost;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-        uint collateralValue = getCollateralValueInternal(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-        require(collateralValue &gt;= debts[user], &quot;Exceeded collateral value&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         totalDebt += replenishmentCost;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         dbr.onForceReplenish(user, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">         dola.transfer(msg.sender, replenisherReward);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/155#issuecomment-1304634317\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This seems like a dust attack. Will leave open for sponsor review. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/155#issuecomment-1327347446\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/InverseFinance/FrontierV2/pull/24\">https://github.com/InverseFinance/FrontierV2/pull/24</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-erc777-reentrancy-when-withdrawing-can-be-used-to-withdraw-all-collateral\" style=\"position:relative;\"><a href=\"#m-04-erc777-reentrancy-when-withdrawing-can-be-used-to-withdraw-all-collateral\" aria-label=\"m 04 erc777 reentrancy when withdrawing can be used to withdraw all collateral permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/206\">[M-04] ERC777 reentrancy when withdrawing can be used to withdraw all collateral</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/206\">Lambda</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/cc281e5800d5860c816138980f08b84225e430fe/src/Market.sol#L464\">Market.sol#L464</a><br></p>\n<p>Markets can be deployed with arbitrary tokens for the collateral, including ERC777 tokens (that are downwards-compatible with ERC20). However, when the system is used with those tokens, an attacker can drain his escrow contract completely while still having a loan. This happens because with ERC777 tokens, there is a <code>tokensToSend</code> hook that is executed before the actual transfer (and the balance updates) happen. Therefore, <code>escrow.balance()</code> (which retrieves the token balance) will still report the old balance when an attacker reenters from this hook.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof Of Concept</h3>\n<p>We assume that <code>collateral</code> is an ERC777 token and that the <code>collateralFactorBps</code> is 5,000 (<code>50%</code>). The user has deposited 10,000 USD (worth of collateral) and taken out a loan worth 2,500 USD. He is therefore allowed to withdraw 5,000 USD (worth of collateral). However, he can usse the ERC777 reentrancy to take out all 10,000 USD (worth of collateral) and still keep the loaned 2,500 USD:</p>\n<ol>\n<li>The user calls <code>withdraw(amount)</code> to withdraw his 5,000 USD (worth of collateral).</li>\n<li>In <code>withdrawInternal</code>, the limit check succeeds (the user is allowed to withdraw 5,000 USD) and <code>escrow.pay(to, amount)</code> is called. This will initiate a transfer to the provided address (no matter which escrow is used, but we assume <code>SimpleERC20Escrow</code> for this example).</li>\n<li>Because the collateral is an ERC777 token, the <code>tokensToSend</code> hook is executed before the actual transfer (and before any balance updates are made). The user can exploit this by calling <code>withdraw(amount)</code> again within the hook.</li>\n<li><code>withdrawInternal</code> will call <code>getWithdrawalLimitInternal</code>, which calls <code>escrow.balance()</code>. This receives the collateral balance of the escrow, which is not yet updated. Because of that, the balance is still 10,000 USD (worth of collateral) and the calculated withdraw limit is therefore still 5,000 USD.</li>\n<li>Both transfers (the reentered one and the original one) succeed and the user has received all of his collateral (10,000 USD), while still having the 2,500 USD loan.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Mark these functions as <code>nonReentrant</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/206#issuecomment-1304567191\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sponsor should review as the attack does seem valid with some pre-conditions (ERC777 tokens being used for collateral). Probably more of a Medium severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/206#issuecomment-1313354099\">08xmt (Inverse) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>We make the security assumption that future collateral added by Inverse Finance DAO is compliant with standard ERC-20 behavior. Inverse Finance is full control of collateral that will be added to the platform and only intend to add collateral that properly reverts on failed transfers. Each ERC20 token added as collateral will be audited for non-standard behaviour. I would consider this a Low Risk finding, depending on how you value errors made in launch parameters.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/206#issuecomment-1329464062\">0xean (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>@08xmt - The revert on a failed transfer here isn’t the issue, it is the re-entrancy that isn’t guarded against properly. While I understand your comment, if it were my codebase, I would simply add the modifier and incur the small gas costs as an additional layer of security to avoid mistakes in the future. I don’t think this qualifies as High, but does show an attack path that <em>could</em> be achieved with an ERC777 token being used as collateral. Going to downgrade to Medium and will be happy to hear more discussion on the topic before final review. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/206#issuecomment-1332543501\">08xmt (Inverse) commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - The risk is still only present with unvetted contracts, and if the desire should exist in the future to implement a market with a token with re-entrancy, the code can be modified as necessary.</p>\n<p>Will respect the judge’s decision on severity in the end, but ultimately seem like a deployment parameter risk more than anything.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/206#issuecomment-1333969128\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Thanks @08xmt for the response.</p>\n<p>While I agree that proper vetting <em>could</em> avoid this issue, the wardens are analyzing the code and documentation that is presented before them and I think in light of this, the issue is valid. Had the warden simply stated that there was a reentrancy modifier missing without showing a valid path to it being exploited, I would downgrade to QA. But given they showed a valid attack path due to the lack of reentrancy controls I think this should be awarded.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-repay-function-can-be-dosed\" style=\"position:relative;\"><a href=\"#m-05-repay-function-can-be-dosed\" aria-label=\"m 05 repay function can be dosed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/252\">[M-05] <code>repay</code> function can be DOSed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/252\">djxploit</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/439\">immeas</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L531\">Market.sol#L531</a><br></p>\n<p>In <code>repay()</code> users can repay their debt.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function repay(address user, uint amount) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint debt = debts[user];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(debt &gt;= amount, &quot;Insufficient debt&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        debts[user] -= amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        totalDebt -= amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        dbr.onRepay(user, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        dola.transferFrom(msg.sender, address(this), amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Repay(user, msg.sender, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>There is a <code>require</code> condition, that checks if the amount provided, is greater than the debt of the user. If it is, then the function reverts. This is where the vulnerability arises.</p>\n<p><code>repay</code> function can be frontrun by an attacker. Say an attacker pay a small amount of debt for the victim user, by frontrunning his repay transaction. Now when the victim’s transaction gets executed, the <code>require</code> condition will fail, as the amount of debt is less than the amount of DOLA provided. Hence the attacker can repeat the process to DOS the victim from calling the repay function.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Victim calls repay() function to pay his debt of 500 DOLA , by providing the amount as 500</li>\n<li>Now attacker saw this transaction on mempool</li>\n<li>Attacker frontruns the transaction, by calling repay() with amount provided as 1 DOLA</li>\n<li>Attacker’s transaction get’s executed first due to frontrunning, which reduces the debt of the victim user to 499 DOLA</li>\n<li>Now when the victim’s transaction get’s executed, the debt of victim has reduced to 499 DOLA, and the amount to repay provided was 500 DOLA. Now as debt is less than the amount provided, so the require function will fail, and the victim’s transaction will revert.</li>\n</ol>\n<p>This will prevent the victim from calling repay function.</p>\n<p>Hence an attacker can DOS the repay function for the victim user.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement DOS protection.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/252#issuecomment-1304641340\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This seems like a stretch to me. Will leave open for sponsor review but most likely close as invalid. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/252#issuecomment-1308151711\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Mitigating PR: <a href=\"https://github.com/InverseFinance/FrontierV2/pull/13\">https://github.com/InverseFinance/FrontierV2/pull/13</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-user-can-free-from-liquidation-fee-if-its-escrow-balance-is-less-than-the-calculated-liquidation-fee\" style=\"position:relative;\"><a href=\"#m-06-user-can-free-from-liquidation-fee-if-its-escrow-balance-is-less-than-the-calculated-liquidation-fee\" aria-label=\"m 06 user can free from liquidation fee if its escrow balance is less than the calculated liquidation fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/275\">[M-06] User can free from liquidation fee if its escrow balance is less than the calculated liquidation fee</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/275\">jayphbee</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/391\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/330\">corerouter</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/302\">trustindistrust</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/115\">cccz</a></em></p>\n<p>User can free from liquidation fee if its escrow balance less than the calculated liquidation fee.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If the <code>liquidationFeeBps</code> is enabled, the <code>gov</code> should receive the liquidation fee. But if user’s escrow balance is less than the calculated liquidation fee, <code>gov</code> got nothing.<br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L605-L610\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L605-L610</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidationFeeBps</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">liquidationFeeBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">() &gt;= </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>User should pay all the remaining escrow balance if the calculated liquidation fee is greater than its escrow balance.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidationFeeBps</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">liquidationFeeBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">() &gt;= </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">, </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/275#issuecomment-1304642370\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This should amount to dust. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/275#issuecomment-1308193523\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/InverseFinance/FrontierV2/pull/15\">https://github.com/InverseFinance/FrontierV2/pull/15</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-oracles-two-day-feature-can-be-gamed\" style=\"position:relative;\"><a href=\"#m-07-oracles-two-day-feature-can-be-gamed\" aria-label=\"m 07 oracles two day feature can be gamed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/278\">[M-07] Oracle’s two-day feature can be gamed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/278\">Ruhum</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L124\">Oracle.sol#L124</a><br></p>\n<p>The two-day feature of the oracle can be gamed where you only have to manipulate the oracle for ~2 blocks.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The oracle computes the day using:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">day</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Since we’re working with <code>uint</code> values here, the following is true:<br>\n<code>1728799 / 86400 = 1</code><br>\n<code>172800 / 86400 = 2</code><br></p>\n<p>Meaning, if you manipulate the oracle at the last block of day <code>X</code>, e.g. <code>23:59:50</code>, and at the first block of day <code>X + 1</code>, e.g. <code>00:00:02</code>, you bypass the two-day feature of the oracle. You only have to manipulate the oracle for two blocks.</p>\n<p>This is quite hard to pull off. I’m also not sure whether there were any instances of Chainlink oracle manipulation before. But, since you designed this feature to prevent small timeframe oracle manipulation I think it’s valid to point this out.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>If you increase it to a three-day interval you can fix this issue. Then, the oracle has to be manipulated for at least 24 hours.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/278#issuecomment-1315421650\">08xmt (Inverse) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is an issue if a 24 hour period elapses without any calls to the oracle <em>and</em> the underlying oracle is manipulable. The two day low is meant to be an added layer of security, but not bullet proof.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-protocol-withdrawals-of-collateral-can-be-unexpectedly-locked-if-governance-sets-the-collateralfactorbps-to-0\" style=\"position:relative;\"><a href=\"#m-08-protocol-withdrawals-of-collateral-can-be-unexpectedly-locked-if-governance-sets-the-collateralfactorbps-to-0\" aria-label=\"m 08 protocol withdrawals of collateral can be unexpectedly locked if governance sets the collateralfactorbps to 0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/301\">[M-08] Protocol withdrawals of collateral can be unexpectedly locked if governance sets the <code>collateralFactorBps</code> to 0</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/301\">trustindistrust</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/576\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/570\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/563\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/541\">eierina</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/511\">pedroais</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/502\">RaoulSchaffranek</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/470\">c7e7eff</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/442\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/422\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/338\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/292\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/261\">jwood</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/209\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/200\">peanuts</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/120\">codexploder</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L359\">https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L359</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L376\">https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L376</a><br></p>\n<p>The FiRM <code>Marketplace</code> contract contains multiple governance functions for setting important values for a given debt market. Many of these are numeric values that affect ratios/levels for debt positions, fees, incentives, etc.</p>\n<p>In particular, <code>Market.setCollateralFactorBps()</code> sets the ratio for how much collateral is required for loans vs the debt taken on by the user. The lower the value, the less debt a user can take on. See <code>Market.getCreditLimitInternal()</code> for that implementation.</p>\n<p>The function <code>Market.getWithdrawalLimitInternal()</code> calculates how much collateral a user can withdraw from the protocol, factoring in their current level of debt. It contains the following check:</p>\n<p><code>if(collateralFactorBps == 0) return 0;</code></p>\n<p>This would cause the user to not be able to withdraw any tokens, so long as they had any non-0 amount of debt and the <code>collateralFactorBps</code> was 0.</p>\n<h3 id=\"severity-rationalization\" style=\"position:relative;\"><a href=\"#severity-rationalization\" aria-label=\"severity rationalization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Rationalization</h3>\n<p>It is the warden’s estimation that all semantics for locking functionality of the protocol should be explicit rather than implicit. While it is very unlikely that governance would intentionally set this value to 0, if it were to do so it would disproportionately affect users whose debt values were low compared to their deposited collateral.</p>\n<p>It is also obvious that the same function that set the value to 0 could be used to revert the change. However, this would take time. Inverse Finance has mandatory minimums for the time required to process governance items in its workflow (<a href=\"https://docs.inverse.finance/inverse-finance/governance/creating-a-proposal\">https://docs.inverse.finance/inverse-finance/governance/creating-a-proposal</a>)</p>\n<blockquote>\n<p>The community has a social agreement to post all proposals on the forum and as a draft in GovMills at least 24 hours before the proposal is put up for an on-chain vote, and also to host a community call focusing on the proposal before the voting period.</p>\n</blockquote>\n<blockquote>\n<p>Once a proposal has passed, it must be queued on-chain. This action can be triggered by anyone who is willing to pay the gas fee (usually done by a DAO member). The proposal then enters a holding period of 40 hours to allow users time to prepare for the consequences of the execution of the proposal.</p>\n</blockquote>\n<p>As such, were the situation to occur it would cause at least 64 hours of lock.</p>\n<p>Since the contract itself only overtly contains locking for new borrowing, this implicit lock on withdraws seems like an unnecessary risk.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider a minimum for this value, to go along with the maximum value check already present in the setter function. While this will still reduce the quantity of collateral that can be withdrawn by users, it would allow for some withdraws to occur.</p>\n<p>An explicit withdrawal lock could be implemented, making the semantic clear. This function could have modified access controls to enable faster reactions vs governance alone.</p>\n<p>Alternatively, if there was an intention for this value to accept <code>0</code>, consider an ‘escape hatch’ function that could be enacted by users when a ‘defaulted’ state is set on the Market.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/301#issuecomment-1351644972\">08xmt (Inverse) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>This is functioning as intended. Setting a low collateralFactor like this is essentially a way to force borrowers to repay their debt. It may be a necessary operation in an emergency.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-avoidable-misconfiguration-could-lead-to-invescrow-contract-not-minting-xinv-tokens\" style=\"position:relative;\"><a href=\"#m-09-avoidable-misconfiguration-could-lead-to-invescrow-contract-not-minting-xinv-tokens\" aria-label=\"m 09 avoidable misconfiguration could lead to invescrow contract not minting xinv tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/379\">[M-09] Avoidable misconfiguration could lead to <code>INVEscrow</code> contract not minting <code>xINV</code> tokens</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/379\">neumo</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/506\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/187\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/106\">BClabs</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/88\">rvierdiiev</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L281-L283\">Market.sol#L281-L283</a><br></p>\n<p>If a user creates a market with the <strong>INVEscrow</strong> implementation as <strong>escrowImplementation</strong> and false as <strong>callOnDepositCallback</strong>, the deposits made by users in the escrow (through the market) would not mint <strong>xINV</strong> tokens for them. As <strong>callOnDepositCallback</strong> is an immutable variable set in the constructor, this mistake would make the market a failure and the user should deploy a new one (even worse, if the error is detected after any user has deposited funds, some sort of migration of funds should be needed).</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Both <strong>escrowImplementation</strong> and <strong>callOnDepositCallback</strong> are immutable:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrowImplementation</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">callOnDepositCallback</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span></code></pre>\n<p>and its value is set at creation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">constructor</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_gov</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_lender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_pauseGuardian</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_escrowImplementation</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IDolaBorrowingRights</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_dbr</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IOracle</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracle</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collateralFactorBps</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_replenishmentIncentiveBps</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_liquidationIncentiveBps</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_callOnDepositCallback</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">escrowImplementation</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_escrowImplementation</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">callOnDepositCallback</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_callOnDepositCallback</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> }</span></span></span></code></pre>\n<p>When the user deposits collateral, if <strong>callOnDepositCallback</strong> is true, there is a call to the escrow’s <strong>onDeposit</strong> callback:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">callOnDepositCallback</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">onDeposit</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This is <strong>INVEscrow</strong>’s onDeposit function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onDeposit</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">invBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">invBalance</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">xINV</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">invBalance</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// we do not check return value because we don&#39;t want errors to block this call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The thing is if <strong>callOnDepositCallback</strong> is false, this function is never called and the user does not turn his/her collateral (<strong>INV</strong>) into <strong>xINV</strong>.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Either make <strong>callOnDepositCallback</strong> a configurable parameter in Market.sol or always call the <strong>onDeposit</strong> callback (just get rid of the <strong>callOnDepositCallback</strong> variable) and leave it empty in case there’s no extra functionality that needs to be executed for that escrow. In the case that the same escrow has to execute the callback for some markets and not for others, this solution would imply that there should be two escrows, one with the callback to be executed and another with the callback empty.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/379#issuecomment-1352201329\">08xmt (Inverse) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/InverseFinance/FrontierV2/pull/21/commits/0d4b01c594fb56a9f0ba944f6946874a5b335152\">https://github.com/InverseFinance/FrontierV2/pull/21/commits/0d4b01c594fb56a9f0ba944f6946874a5b335152</a></p>\n<p>We acknowledge that markets can be configured incorrectly, but it should generally be assumed that markets will be configured correctly, as this will go through both internal and governance review.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-liquidation-should-make-a-borrower-healthier\" style=\"position:relative;\"><a href=\"#m-10-liquidation-should-make-a-borrower-healthier\" aria-label=\"m 10 liquidation should make a borrower healthier permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/395\">[M-10] Liquidation should make a borrower <em>healthier</em></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/395\">hansfriese</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L559\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L559</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L591\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L591</a><br></p>\n<p>For a lending pool, borrower’s debt healthness can be decided by the health factor, i.e. the collateral value divided by debt. ($C/D$)</p>\n<p>The less the health factor is, the borrower’s collateral is more risky of being liquidated.</p>\n<p>Liquidation is supposed to make the borrower healthier (by paying debts and claiming some collateral), or else continuous liquidations can follow up and this can lead to a so-called <a href=\"https://medium.com/coinmonks/what-is-liquidation-in-defi-lending-and-borrowing-platforms-3326e0ba8d0\">liquidation crisis</a>.</p>\n<p>In a normal lending protocol, borrower’s debt is limited by collateral factor in any case.</p>\n<p>For this protocol, users can force replenishment for the addresses in deficit and the replenishment increases the borrower’s debt.</p>\n<p>And in the current implementation the replenishment is limited so that the new debt is not over than the collateral value.</p>\n<p>As we will see below, this limitation is not enough and if the borrower’s debt is over some threshold (still less than collateral value), liquidation makes the borrower debt “unhealthier”.</p>\n<p>And repeating liquidation can lead to various problems and we will even show an example that the attacker can take the DOLA out of the market.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Please see warden’s <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/395\">original submission</a> for full proof of concept.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Make sure the liquidation does not decrease the health index in the function <code>liquidate</code>.<br>\nWith this mitigation, we also suggest limiting the debt increase in the function <code>forceReplenish</code> so that the new debt after replenish will not be over the threshold.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">liquidate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must repay positive debt&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getCreditLimitInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">) &lt; </span><span class=\"mtk12\">debt</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;User debt is healthy&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">liquidationFactorBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Exceeded liquidation factor&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ****************************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">beforeHealthFactor</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCollateralValue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">debt</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// @audit remember the health factor before liquidation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ****************************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// collateral price in dola</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidatorReward</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">price</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// collateral amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">liquidatorReward</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">liquidatorReward</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">liquidationIncentiveBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">totalDebt</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">onRepay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">dola</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">predictEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidatorReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">liquidationFeeBps</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">liquidationFeeBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">() &gt;= </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gov</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidationFee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ****************************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">afterHealthFactor</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCollateralValue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">]; </span><span class=\"mtk3\">// @audit health factor after liquidation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">afterHealthFactor</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">beforeHealthFactor</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Liquidation should not decrease the health factor of the address&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit new check</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ****************************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Liquidate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">repaidDebt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">liquidatorReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">forceReplenish</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deficit</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deficitOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deficit</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;No DBR deficit&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deficit</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Amount &gt; deficit&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">replenishmentPriceBps</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">replenisherReward</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">replenishmentIncentiveBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralValue</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCollateralValueInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ****************************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// require(collateralValue &gt;= debts[user], &quot;Exceeded collateral value&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralValue</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] * (</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">liquidationIncentiveBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">liquidationFeeBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Debt exceeds safe collateral limit&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit more strict limit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// ****************************************</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">totalDebt</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">onForceReplenish</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">dola</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">replenisherReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ForceReplenish</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\">, </span><span class=\"mtk12\">replenisherReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/395#issuecomment-1319032040\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed by <a href=\"https://github.com/InverseFinance/FrontierV2/pull/22\">https://github.com/InverseFinance/FrontierV2/pull/22</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/395#issuecomment-1329659986\">0xean (judge) decreased severity and commented</a>:</strong></p>\n<blockquote>\n<p>I think this comes down to design tradeoffs and is not unique to this specific lending protocol. It certainly shouldn’t be consider High risk, but could see it being considered Medium as users should be aware that in market sell offs, cascading liquidations are a potential reality either due to liquidation rewards OR simply declining prices and the feedback loop at liquidations occur. </p>\n<p>That being said, these items are not unique to this protocol, so perhaps QA is a better grade for this issue. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/395#issuecomment-1330959334\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@08xmt - care to weigh in on this one? I am unable to see your fix, but may help in how I judge it. The warden asked me to re-review and is suggesting a Medium severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/395#issuecomment-1331975521\">08xmt (Inverse) commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - I think a Medium rating is fair. Our fix has been to revert when the combination of Collateral Factor, Liquidation Incentive and Liquidation Fee would result in profitable self liquidations or unhealthier debt after liquidations.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(collateralFactorBps &gt; 0){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint unsafeLiquidationIncentive = 10000 * 10000 / collateralFactorBps - 10000 - liquidationFeeBps;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(liquidationIncentiveBps &lt; unsafeLiquidationIncentive,  &quot;New liquidation param allow profitable self liquidation&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/395#issuecomment-1332119153\">0xean (judge) increased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Thanks, will upgrade back to Medium. :)</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-viewprice-doesnt-always-report-dampened-price\" style=\"position:relative;\"><a href=\"#m-11-viewprice-doesnt-always-report-dampened-price\" aria-label=\"m 11 viewprice doesnt always report dampened price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/404\">[M-11] <code>viewPrice</code> doesn’t always report dampened price</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/404\">Jeiwan</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Oracle.sol#L91\">Oracle.sol#L91</a><br></p>\n<p>Oracle’s <code>viewPrice</code> function doesn’t report a dampened price until <code>getPrice</code> is called and today’s price is updated. This will impact the public read-only functions that call it:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L312\">getCollateralValue</a>;</li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L334\">getCreditLimit</a> (calls <code>getCollateralValue</code>);</li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L578\">getLiquidatableDebt</a> (calls <code>getCreditLimit</code>);</li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L370\">getWithdrawalLimit</a>.</li>\n</ul>\n<p>These functions are used to get on-chain state and prepare values for write calls (e.g. calculate withdrawal amount before withdrawing or calculate a user’s debt that can be liquidated before liquidating it). Thus, wrong values returned by these functions can cause withdrawal of a wrong amount or liquidation of a wrong debt or cause reverts.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// src/test/Oracle.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_viewPriceNoDampenedPrice_AUDIT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralFactor</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">collateralFactorBps</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">day</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ethFeed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestAnswer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//1600e18 price saved as daily low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">dailyLows</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">), </span><span class=\"mtk12\">day</span><span class=\"mtk1\">), </span><span class=\"mtk12\">feedPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1200e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ethFeed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">changeAnswer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//1200e18 price saved as daily low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">dailyLows</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">), ++</span><span class=\"mtk12\">day</span><span class=\"mtk1\">), </span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">3000e18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ethFeed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">changeAnswer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">//1200e18 should be twoDayLow, 3000e18 is current price. We should receive dampened price here.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Notice that viewPrice is called before getPrice.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">viewPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">dailyLows</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">), ++</span><span class=\"mtk12\">day</span><span class=\"mtk1\">), </span><span class=\"mtk12\">newPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1200e18</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10_000</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">collateralFactor</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// View price wasn&#39;t dampened.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">viewPrice</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3000e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider this change:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Oracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Oracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -89,6 +89,9 @@ contract Oracle {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint day = block.timestamp / 1 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // get today&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint todaysLow = dailyLows[token][day];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            if(todaysLow == 0 || normalizedPrice &lt; todaysLow) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                todaysLow = normalizedPrice;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // get yesterday&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             uint yesterdaysLow = dailyLows[token][day - 1];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             // calculate new borrowing power based on collateral factor</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/404#issuecomment-1304647858\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Well written report that explains the impact of this unlike the others. Will leave open for review. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/404#issuecomment-1315325006\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/InverseFinance/FrontierV2/pull/18\">https://github.com/InverseFinance/FrontierV2/pull/18</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12--users-could-get-some-dola-even-if-they-are-on-liquidation-position\" style=\"position:relative;\"><a href=\"#m-12--users-could-get-some-dola-even-if-they-are-on-liquidation-position\" aria-label=\"m 12  users could get some dola even if they are on liquidation position permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/419\">[M-12]  Users could get some <code>DOLA</code> even if they are on liquidation position</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/419\">Ch_301</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L566\">Market.sol#L566</a><br></p>\n<p>Users able to invoke <code>forceReplenish()</code> when they are on liquidation position.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>On <code>Market.sol</code> ==> <code>forceReplenish()</code><br>\nOn this line</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint collateralValue = getCollateralValueInternal(user);</span></span></code></pre>\n<p><code>getCollateralValueInternal(user)</code> only return the value of the collateral</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getCollateralValueInternal(address user) internal returns (uint) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IEscrow escrow = predictEscrow(user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint collateralBalance = escrow.balance();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return collateralBalance * oracle.getPrice(address(collateral), collateralFactorBps) / 1 ether; </span></span></code></pre>\n<p>So if the user have 1.5 wETH at the price of  <code>1 ETH = 1600 USD</code> <br>\nIt will return <code>1.5 * 1600</code> and this value is the real value we can’t just check it directly with the debt like this</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"> require(collateralValue &gt;= debts[user], &quot;Exceeded collateral value&quot;);</span></span></code></pre>\n<p>This is no longer <code>over collateralized</code> protocol.<br>\nThe value needs to be multiplied by <code>collateralFactorBps / 10000</code></p>\n<ul>\n<li>So depending on the value of <code>collateralFactorBps</code> and <code>liquidationFactorBps</code> the user could be in the liquidation position but he is able to invoke <code>forceReplenish()</code> to cover all their <code>dueTokensAccrued[user]</code> on <code>DBR.sol</code> and get more <code>DOLA</code></li>\n<li>or it will lead a healthy debt to be in the liquidation position after invoking <code>forceReplenish()</code></li>\n<li>*</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use <code>getCreditLimitInternal()</code> rather than <code>getCollateralValueInternal()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/419#issuecomment-1304650692\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I believe this warden may be correct in the fact that we should actually be adding the <code>collateralFactor</code> into the check.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/419#issuecomment-1313694712\">08xmt (Inverse) commented</a>:</strong></p>\n<blockquote>\n<p>While increasing debt beyond the Credit limit do risk creating bad debt, this bad debt is owed entirely to the protocol. If one wanted to minimise the amount of bad debt created this way, it would be possible to change the line to <code>getCollateralValueInternal() * (10000 - liquidationIncentiveBps) / 10000;</code>, as this would also slightly reduce the amount of bad debt paid out to force replenishers as incentives.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/419#issuecomment-1315243835\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/InverseFinance/FrontierV2/pull/17\">https://github.com/InverseFinance/FrontierV2/pull/17</a>.</p>\n<p>Added a variant of this solution: <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/419#issuecomment-1313694712\">https://github.com/code-423n4/2022-10-inverse-findings/issues/419#issuecomment-1313694712</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-marketforcereplenish-can-be-dosed\" style=\"position:relative;\"><a href=\"#m-13-marketforcereplenish-can-be-dosed\" aria-label=\"m 13 marketforcereplenish can be dosed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/443\">[M-13] <code>Market::forceReplenish</code> can be DoSed</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/443\">immeas</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L562\">Market.sol#L562</a><br></p>\n<p>If a user wants to completely <code>forceReplenish</code> a borrower with deficit, the borrower or any other malicious party can front run this with a dust amount to prevent the replenish.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testForceReplenishFrontRun</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">gibWeth</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">gibDBR</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">14</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialReplenisherDola</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">DOLA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">replenisher</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">borrowAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getMaxBorrowAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">borrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">borrowAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialUserDebt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">debts</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialMarketDola</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">DOLA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">market</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">5</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deficitBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deficitOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">replenisher</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">forceReplenish</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">,</span><span class=\"mtk7\">1</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// front run DoS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Amount &gt; deficit&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">forceReplenish</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">deficitBefore</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// fails due to amount being larger than deficit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DOLA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">replenisher</span><span class=\"mtk1\">), </span><span class=\"mtk12\">initialReplenisherDola</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;DOLA balance of replenisher changed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DOLA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">market</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">initialMarketDola</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;DOLA balance of market changed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DOLA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">replenisher</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">initialReplenisherDola</span><span class=\"mtk1\">, </span><span class=\"mtk12\">initialMarketDola</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">DOLA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">market</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;DOLA balance of market did not decrease by amount paid to replenisher&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deficitOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">), </span><span class=\"mtk12\">deficitBefore</span><span class=\"mtk1\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Deficit of borrower was not fully replenished&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// debt only increased by dust</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">debts</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">initialUserDebt</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">replenishmentPriceBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Debt of borrower did not increase by replenishment price&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>This requires that the two txs end up in the same block. If they end up in different blocks the front run transaction will need to account for the increase in deficit between blocks.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>vscode, forge</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use <code>min(deficit,amount)</code> as amount to replenish.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/443#issuecomment-1304652467\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Very similar to <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/439\"><code>#439</code></a> and unclear as the benefit the attacker is gaining here. They would be better off just front running the entire transaction and getting additional reward. Will leave open for sponsor review, but most likely QA or invalid. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/443#issuecomment-1309781833\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/InverseFinance/FrontierV2/pull/16.\">https://github.com/InverseFinance/FrontierV2/pull/16.</a><br>\nPossible to imagine a situation where an attacker has an underwater loan and keeps front running his own forced replenishments with single digit DBR forced replenishments.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-two-day-low-oracle-used-in-marketliquidate-makes-the-system-highly-at-risk-in-an-oracle-attack-\" style=\"position:relative;\"><a href=\"#m-14-two-day-low-oracle-used-in-marketliquidate-makes-the-system-highly-at-risk-in-an-oracle-attack-\" aria-label=\"m 14 two day low oracle used in marketliquidate makes the system highly at risk in an oracle attack  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/469\">[M-14] Two day low oracle used in <code>Market.liquidate()</code> makes the system highly at risk in an oracle attack </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/469\">gs8nrv</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/424\">immeas</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/408\">yamapyblack</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/232\">idkwhatimdoing</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/220\">kaden</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/164\">Holmgren</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/89\">rvierdiiev</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L596\">https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L596</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L594\">https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L594</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L597\">https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L597</a><br></p>\n<p>Usage of the 2 day low exchange rate when trying to liquidate is highly risky as it incentives even more malicious agents to control the price feed for a short period of time. By controlling shortly the feed, it puts at risk any debt opened for a 2 day period + the collateral released will be overshoot during the liquidation.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The attack can be done by either an attack directly on the feed to push bad data, or in the case of Chainlink manipulating for a short period of time the markets to force an update from Chainlink. Then when either of the attacks has been made the attacker call <code>Oracle.getPrice()</code>. It then gives a 2 day period to the attacker (and any other agent who wants to liquidate) to liquidate any escrow.</p>\n<p>This has a second drawback, we see that we use the same value at line 596, which is used to compute the liquidator reward (l.597), leading to more collateral released than expected. For instance manipulating once the feed and bring the ETH/USD rate to 20 instead of 2000, liquidator will earn 100 more than he should have had.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Instead of using the 2 day lowest price during the liquidation, the team could either take the current oracle price, while still using the 2 day period for any direct agent interaction to minimise attacks both from users side and liquidators side.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/469#issuecomment-1338401236\">0xean (judge) decreased severity to Medium</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/469#issuecomment-1351441640\">08xmt (Inverse) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>The debt is not more at risk than through normal oracle manipulation. The oracle will return the normalized price if it’s lower than the dampened two-day low, meaning oracle manipulations can always be used for bad liquidations.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-oracle-assumes-token-and-feed-decimals-will-be-limited-to-18-decimals\" style=\"position:relative;\"><a href=\"#m-15-oracle-assumes-token-and-feed-decimals-will-be-limited-to-18-decimals\" aria-label=\"m 15 oracle assumes token and feed decimals will be limited to 18 decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/533\">[M-15] Oracle assumes token and feed decimals will be limited to 18 decimals</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/533\">adriro</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/562\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/550\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/540\">neumo</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/448\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/361\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/306\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/285\">eierina</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/207\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/148\">RaoulSchaffranek</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/135\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/118\">codexploder</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/109\">BClabs</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/94\">8olidity</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/90\">joestakey</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L87\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L87</a><br>\n<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L121\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L121</a><br></p>\n<p>The <code>Oracle</code> contract normalizes prices in both <code>viewPrices</code> and <code>getPrices</code> functions to adjust for potential decimal differences between feed and token decimals and the expected return value.</p>\n<p>However these functions assume that <code>feedDecimals</code> and <code>tokenDecimals</code> won’t exceed 18 since the normalization calculation is <code>36 - feedDecimals - tokenDecimals</code>, or that at worst case the sum of both won’t exceed 36.</p>\n<p>This assumption should be safe for certain cases, for example WETH is 18 decimals and the ETH/USD chainlink is 8 decimals, but may cause an overflow (and a revert) for the general case, rendering the Oracle useless in these cases.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>If <code>feedDecimals + tokenDecimals > 36</code> then the expression <code>36 - feedDecimals - tokenDecimals</code> will be negative and (due to Solidity 0.8 default checked math) will cause a revert.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In case <code>feedDecimals + tokenDecimals</code> exceeds 36, then the proper normalization procedure would be to <strong>divide</strong> the price by <code>10 ** decimals</code>. Something like this:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint normalizedPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (feedDecimals + tokenDecimals &gt; 36) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint decimals = feedDecimals + tokenDecimals - 36;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    normalizedPrice = price / (10 ** decimals)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">} else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint8 decimals = 36 - feedDecimals - tokenDecimals;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    normalizedPrice = price * (10 ** decimals);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/533#issuecomment-1351469171\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/InverseFinance/FrontierV2/pull/25\">https://github.com/InverseFinance/FrontierV2/pull/25</a><br>\nAlso pretty sure this is a dupe</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-calling-repay-function-sends-less-dola-to-market-contract-when-forcereplenish-function-is-not-called-while-it-could-be-called\" style=\"position:relative;\"><a href=\"#m-16-calling-repay-function-sends-less-dola-to-market-contract-when-forcereplenish-function-is-not-called-while-it-could-be-called\" aria-label=\"m 16 calling repay function sends less dola to market contract when forcereplenish function is not called while it could be called permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/583\">[M-16] Calling <code>repay</code> function sends less DOLA to <code>Market</code> contract when <code>forceReplenish</code> function is not called while it could be called</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/583\">rbserver</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/519\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/417\">Ch_301</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/401\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/385\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/311\">0xRobocop</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/182\">MiloTruck</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/158\">sam_cunningham</a></em></p>\n<p>When a user incurs a DBR deficit, a replenisher can call the <code>forceReplenish</code> function to force the user to replenish DBR. However, there is no guarantee that the <code>forceReplenish</code> function will always be called. When the <code>forceReplenish</code> function is not called, such as because that the replenisher does not notice the user’s DBR deficit promptly, the user can just call the <code>repay</code> function to repay the origianl debt and the <code>withdraw</code> function to receive all of the deposited collateral even when the user has a DBR deficit already. Yet, in the same situation, if the <code>forceReplenish</code> function has been called, more debt should be added for the user, and the user needs to repay more in order to get back all of the deposited collateral. Hence, when the <code>forceReplenish</code> function is not called while it could be called, the <code>Market</code> contract would receive less DOLA if the user decides to repay the debt and withdraw the collateral both in full.</p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L559-L572\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L559-L572</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">forceReplenish</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">deficit</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deficitOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deficit</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;No DBR deficit&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">deficit</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Amount &gt; deficit&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">replenishmentPriceBps</span><span class=\"mtk1\">() / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">replenisherReward</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">replenishmentIncentiveBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] += </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralValue</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCollateralValueInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralValue</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Exceeded collateral value&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">totalDebt</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">onForceReplenish</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">dola</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">replenisherReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ForceReplenish</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">replenishmentCost</span><span class=\"mtk1\">, </span><span class=\"mtk12\">replenisherReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L531-L539\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L531-L539</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">repay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Insufficient debt&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">totalDebt</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">onRepay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">dola</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Repay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L472-L474\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L472-L474</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">withdrawInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L460-L466\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L460-L466</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdrawInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">limit</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getWithdrawalLimitInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">limit</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Insufficient withdrawal limit&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Please add the following test in <code>src\\test\\Market.t.sol</code>. This test will pass to demonstrate the described scenario.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testRepayAndWithdrawInFullWhenIncurringDBRDeficitIfNotBeingForcedToReplenish</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">gibWeth</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">gibDBR</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// user deposits wethTestAmount WETH and borrows wethTestAmount DOLA</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">borrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DOLA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">), </span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">60</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// after some time, user incurs DBR deficit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">dbr</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deficitOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// yet, since no one notices that user has a DBR deficit and forces user to replenish DBR,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//   user is able to repay wethTestAmount DOLA that was borrowed previously and withdraw wethTestAmount WETH that was deposited previously</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">repay</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">market</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// as a result, user is able to get back all of the deposited WETH, which should not be possible if user has been forced to replenish DBR</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DOLA</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">), </span><span class=\"mtk12\">wethTestAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>When calling the <code>repay</code> function, the user’s DBR deficit can also be checked. If the user has a DBR deficit, an amount, which is similar to <code>replenishmentCost</code> that is calculated in the <code>forceReplenish</code> function, can be calculated; it can then be used to adjust the <code>repay</code> function’s <code>amount</code> input for updating the states regarding the user’s and total debts in the relevant contracts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/583#issuecomment-1351478264\">08xmt (Inverse) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Working as intended.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-17-chainlink-oracle-data-feed-is-not-sufficiently-validated-and-can-return-stale-price\" style=\"position:relative;\"><a href=\"#m-17-chainlink-oracle-data-feed-is-not-sufficiently-validated-and-can-return-stale-price\" aria-label=\"m 17 chainlink oracle data feed is not sufficiently validated and can return stale price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/584\">[M-17] Chainlink oracle data feed is not sufficiently validated and can return stale <code>price</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/584\">rbserver</a>, also found by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/601\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/573\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/565\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/547\">sorrynotsorry</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/545\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/537\">c7e7eff</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/530\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/529\">pedroais</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/512\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/481\">dipp</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/458\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/455\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/435\">immeas</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/431\">imare</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/426\">Olivierdem</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/403\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/400\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/397\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/384\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/383\">elprofesor</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/350\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/339\">tonisives</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/337\">catchup</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/299\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/284\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/276\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/260\">Franfran</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/258\">Wawrdog</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/231\">idkwhatimdoing</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/217\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/205\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/197\">peanuts</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/196\">saneryee</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/193\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/189\">eierina</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/181\">cuteboiz</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/162\">martin</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/153\">M4TZ1P</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/151\">Jujic</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/140\">rokinot</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/131\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/116\">codexploder</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/97\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/92\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/68\">leosathya</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/45\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/39\">8olidity</a></em></p>\n<p>Calling the <code>Oracle</code> contract’s <code>viewPrice</code> or <code>getPrice</code> function executes <code>uint price = feeds[token].feed.latestAnswer()</code> and <code>require(price > 0, \"Invalid feed price\")</code>. Besides that Chainlink’s <code>latestAnswer</code> function is deprecated, only verifying that <code>price > 0</code> is true is also not enough to guarantee that the returned <code>price</code> is not stale. Using a stale <code>price</code> can cause the calculations for the credit and withdrawal limits to be inaccurate, which, for example, can mistakenly consider a user’s debt to be under water and unexpectedly allow the user’s debt to be liquidated.</p>\n<p>To avoid using a stale answer returned by the Chainlink oracle data feed, according to <a href=\"https://docs.chain.link/docs/historical-price-data\">Chainlink’s documentation</a>:</p>\n<ol>\n<li>The <code>latestRoundData</code> function can be used instead of the deprecated <code>latestAnswer</code> function.</li>\n<li><code>roundId</code> and <code>answeredInRound</code> are also returned. “You can check <code>answeredInRound</code> against the current <code>roundId</code>. If <code>answeredInRound</code> is less than <code>roundId</code>, the answer is being carried over. If <code>answeredInRound</code> is equal to <code>roundId</code>, then the answer is fresh.”</li>\n<li>“A read can revert if the caller is requesting the details of a round that was invalid or has not yet been answered. If you are deriving a round ID without having observed it before, the round might not be complete. To check the round, validate that the timestamp on that round is not 0.”</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L78-L105\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L78-L105</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">viewPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fixedPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fixedPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">IChainlinkFeed</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get price from feed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestAnswer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid feed price&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// normalize price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">36</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">day</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get today&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get yesterday&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// calculate new borrowing power based on collateral factor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBorrowingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">newBorrowingPower</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\">: </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Price not found&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L112-L144\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L112-L144</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fixedPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fixedPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">IChainlinkFeed</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get price from feed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestAnswer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid feed price&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// normalize price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">36</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// potentially store price as today&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">day</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RecordDailyLow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get yesterday&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// calculate new borrowing power based on collateral factor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBorrowingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">newBorrowingPower</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\">: </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Price not found&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L344-L347\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L344-L347</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getCreditLimitInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralValue</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCollateralValueInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralValue</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L323-L327\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L323-L327</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getCollateralValueInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">predictEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L353-L363\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L353-L363</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getWithdrawalLimitInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">predictEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following steps can occur for the described scenario.</p>\n<ol>\n<li>Alice calls the <code>depositAndBorrow</code> function to deposit some WETH as the collateral and borrows some DOLA against the collateral.</li>\n<li>Bob calls the <code>liquidate</code> function for trying to liquidate Alice’s debt. Because the Chainlink oracle data feed returns an up-to-date price at this moment, the <code>getCreditLimitInternal</code> function calculates Alice’s credit limit accurately, which does not cause Alice’s debt to be under water. Hence, Bob’s <code>liquidate</code> transaction reverts.</li>\n<li>After some time, Bob calls the <code>liquidate</code> function again for trying to liquidate Alice’s debt. This time, because the Chainlink oracle data feed returns a positive but stale price, the <code>getCreditLimitInternal</code> function calculates Alice’s credit limit inaccurately, which mistakenly causes Alice’s debt to be under water.</li>\n<li>Bob’s <code>liquidate</code> transaction is executed successfully so he gains some of Alice’s WETH collateral. Alice loses such WETH collateral amount unexpectedly because her debt should not be considered as under water if the stale price was not used.</li>\n</ol>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L82-L83\">Oracle.sol#L82-L83</a> and <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L116-L117\">Oracle.sol#L116-L117</a> can be updated to the following code.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">uint80</span><span class=\"mtk1\"> </span><span class=\"mtk12\">roundId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">int256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">answer</span><span class=\"mtk1\">, , </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">updatedAt</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint80</span><span class=\"mtk1\"> </span><span class=\"mtk12\">answeredInRound</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestRoundData</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">answeredInRound</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">roundId</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;answer is stale&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">updatedAt</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;round is incomplete&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">answer</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid feed answer&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">answer</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/584#issuecomment-1351486543\">08xmt (Inverse) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Fixed in <a href=\"https://github.com/InverseFinance/FrontierV2/pull/19\">https://github.com/InverseFinance/FrontierV2/pull/19</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-protocols-usability-becomes-very-limited-when-access-to-chainlink-oracle-data-feed-is-blocked\" style=\"position:relative;\"><a href=\"#m-18-protocols-usability-becomes-very-limited-when-access-to-chainlink-oracle-data-feed-is-blocked\" aria-label=\"m 18 protocols usability becomes very limited when access to chainlink oracle data feed is blocked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/586\">[M-18] Protocol’s usability becomes very limited when access to Chainlink oracle data feed is blocked</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/586\">rbserver</a></em></p>\n<p>Based on the current implementation, when the protocol wants to use Chainlink oracle data feed for getting a collateral token’s price, the fixed price for the token should not be set. When the fixed price is not set for the token, calling the <code>Oracle</code> contract’s <code>viewPrice</code> or <code>getPrice</code> function will execute <code>uint price = feeds[token].feed.latestAnswer()</code>. As <a href=\"https://blog.openzeppelin.com/secure-smart-contract-guidelines-the-dangers-of-price-oracles/\">https://blog.openzeppelin.com/secure-smart-contract-guidelines-the-dangers-of-price-oracles/</a> mentions, it is possible that Chainlink’s “multisigs can immediately block access to price feeds at will”. When this occurs, executing <code>feeds[token].feed.latestAnswer()</code> will revert so calling the <code>viewPrice</code> and <code>getPrice</code> functions also revert, which cause denial of service when calling functions like <code>getCollateralValueInternal</code> and<code>getWithdrawalLimitInternal</code>. The <code>getCollateralValueInternal</code> and<code>getWithdrawalLimitInternal</code> functions are the key elements to the core functionalities, such as borrowing, withdrawing, force-replenishing, and liquidating; with these functionalities facing DOS, the protocol’s usability becomes very limited.</p>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L78-L105\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L78-L105</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">viewPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fixedPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fixedPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">IChainlinkFeed</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get price from feed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestAnswer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid feed price&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// normalize price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">36</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">day</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get today&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get yesterday&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// calculate new borrowing power based on collateral factor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBorrowingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">newBorrowingPower</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\">: </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Price not found&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L112-L144\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L112-L144</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fixedPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fixedPrices</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">IChainlinkFeed</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get price from feed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">latestAnswer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid feed price&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// normalize price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">36</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// potentially store price as today&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">day</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RecordDailyLow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// get yesterday&#39;s low</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// calculate new borrowing power based on collateral factor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBorrowingPower</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">yesterdaysLow</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">newBorrowingPower</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">twoDayLow</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">dampenedPrice</span><span class=\"mtk1\">: </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Price not found&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L344-L347\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L344-L347</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getCreditLimitInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralValue</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getCollateralValueInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralValue</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L323-L327\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L323-L327</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getCollateralValueInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">predictEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L353-L363\">https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L353-L363</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getWithdrawalLimitInternal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">predictEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balance</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">debt</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">10000</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">collateralFactorBps</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\">) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collateralBalance</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">minimumCollateral</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The following steps can occur for the described scenario.</p>\n<ol>\n<li>Chainlink oracle data feed is used for getting the collateral token’s price so the fixed price for the token is not set.</li>\n<li>Alice calls the <code>depositAndBorrow</code> function to deposit some of the collateral token and borrows some DOLA against the collateral.</li>\n<li>Chainlink’s multisigs suddenly blocks access to price feeds so executing <code>feeds[token].feed.latestAnswer()</code> will revert.</li>\n<li>Alice tries to borrow more DOLA but calling the <code>borrow</code> function, which eventually executes <code>feeds[token].feed.latestAnswer()</code>, reverts.</li>\n<li>Alice tries to withdraw the deposited collateral but calling the <code>withdraw</code> function, which eventually executes <code>feeds[token].feed.latestAnswer()</code>, reverts.</li>\n<li>Similarly, calling the <code>forceReplenish</code> and <code>liquidate</code> functions would all revert as well.</li>\n</ol>\n<h3 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VSCode</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The <code>Oracle</code> contract’s <code>viewPrice</code> and <code>getPrice</code> functions can be updated to refactor <code>feeds[token].feed.latestAnswer()</code> into <code>try feeds[token].feed.latestAnswer() returns (int256 price) { ... } catch Error(string memory) { ... }</code>. The logic for getting the collateral token’s price from the Chainlink oracle data feed should be placed in the <code>try</code> block while some fallback logic when the access to the Chainlink oracle data feed is denied should be placed in the <code>catch</code> block. If getting the fixed price for the collateral token is considered as a fallback logic, then setting the fixed price for the token should become mandatory, which is different from the current implementation. Otherwise, fallback logic for getting the token’s price from a fallback oracle is needed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/586#issuecomment-1313321130\">08xmt (Inverse) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>In the unlikely event of a chainlink msig block, the protocol can still recover through the use of governance actions to insert a new feed. I’d consider this a Low Severity, as protocol is only DOS’ed for a short period, and can’t be repeatedly DOS’ed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/586#issuecomment-1329521891\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</p>\n</blockquote>\n<p>I don’t think a Medium requires some amount of time for the DOS to be valid, so I think without a mitigation or fallback in place, this is a valid issue and should qualify as Medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/586#issuecomment-1332010534\">08xmt (Inverse) commented</a>:</strong></p>\n<blockquote>\n<p>@0xean - That’s fair.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 54 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/126\">report highlighted below</a> by <strong>0x1f8b</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/594\">JC</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/593\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/590\">rbserver</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/588\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/569\">cylzxje</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/567\">tnevler</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/548\">c7e7eff</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/536\">adriro</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/535\">brgltd</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/531\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/527\">c3phas</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/523\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/517\">delfin454000</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/516\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/513\">Josiah</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/498\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/496\">rotcivegaf</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/493\">cducrest</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/491\">robee</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/489\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/486\">lukris02</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/484\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/460\">simon135</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/456\">enckrish</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/452\">wagmi</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/444\">immeas</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/413\">pedr02b2</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/406\">sakshamguruji</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/398\">hansfriese</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/392\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/377\">neumo</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/365\">shark</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/345\">__141345__</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/321\">cryptostellar5</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/305\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/298\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/295\">trustindistrust</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/281\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/257\">oyc_109</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/214\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/212\">ch0bu</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/186\">Diana</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/184\">B2</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/161\">evmwanderer</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/108\">aphak5010</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/99\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/72\">chrisdior4</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/46\">Rahoz</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/37\">Bnke0x0</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/33\">Dinesh11G</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/27\">fatherOfBlocks</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/7\">RaymondFam</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/2\">leosathya</a>.</em></p>\n<h2 id=\"01-allows-malleable-secp256k1-signatures\" style=\"position:relative;\"><a href=\"#01-allows-malleable-secp256k1-signatures\" aria-label=\"01 allows malleable secp256k1 signatures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] Allows malleable <code>SECP256K1</code> signatures</h2>\n<p>Here, the <code>ecrecover()</code> method doesn’t check the <code>s</code> range.</p>\n<p>Homestead (<a href=\"https://eips.ethereum.org/EIPS/eip-2\">EIP-2</a>) added this limitation, however the precompile remained unaltered. The majority of libraries, including OpenZeppelin, do this check.</p>\n<p>Since an order can only be confirmed once and its hash is saved, there doesn’t seem to be a serious danger in existing use cases.</p>\n<h3 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<ul>\n<li><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/7201e6707f6631d9499a569f492870ebdd4133cf/contracts/utils/cryptography/ECDSA.sol#L138-L149\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/7201e6707f6631d9499a569f492870ebdd4133cf/contracts/utils/cryptography/ECDSA.sol#L138-L149</a></li>\n</ul>\n<h3 id=\"affected-source-code\" style=\"position:relative;\"><a href=\"#affected-source-code\" aria-label=\"affected source code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/DBR.sol#L226-L248\">DBR.sol:226-248</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L425-L447\">Market.sol:425-447</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L489-L511\">Market.sol:489-511</a></li>\n</ul>\n<h2 id=\"02-lack-of-checks-address0\" style=\"position:relative;\"><a href=\"#02-lack-of-checks-address0\" aria-label=\"02 lack of checks address0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] Lack of checks <code>address(0)</code></h2>\n<p>The following methods have a lack of checks if the received argument is an address, it’s good practice in order to reduce human error to check that the address specified in the constructor or initialize is different than <code>address(0)</code>.</p>\n<h3 id=\"affected-source-code-1\" style=\"position:relative;\"><a href=\"#affected-source-code-1\" aria-label=\"affected source code 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/BorrowController.sol#L14\">BorrowController.sol:14</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/BorrowController.sol#L26\">BorrowController.sol:26</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/escrows/SimpleERC20Escrow.sol#L28\">SimpleERC20Escrow.sol:28</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/escrows/GovTokenEscrow.sol#L33-L34\">GovTokenEscrow.sol:33-34</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/escrows/INVEscrow.sol#L35\">INVEscrow.sol:35</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/escrows/INVEscrow.sol#L47-L48\">INVEscrow.sol:47-48</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Fed.sol#L37-L40\">Fed.sol:37-40</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Fed.sol#L50\">Fed.sol:50</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Fed.sol#L68\">Fed.sol:68</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Oracle.sol#L32\">Oracle.sol:32</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Oracle.sol#L44\">Oracle.sol:44</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/DBR.sol#L39\">DBR.sol:39</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/DBR.sol#L54\">DBR.sol:54</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L77-L83\">Market.sol:77-83</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L130\">Market.sol:130</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L136\">Market.sol:136</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L142\">Market.sol:142</a></li>\n</ul>\n<h2 id=\"03-avoid-using-txorigin\" style=\"position:relative;\"><a href=\"#03-avoid-using-txorigin\" aria-label=\"03 avoid using txorigin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] Avoid using <code>tx.origin</code></h2>\n<p><code>tx.origin</code> is a global variable in Solidity that returns the address of the account that sent the transaction.</p>\n<p>Using the variable could make a contract vulnerable if an authorized account calls a malicious contract. You can impersonate a user using a third party contract.</p>\n<p>This can make it easier to create a vault on behalf of another user with an external administrator (by receiving it as an argument).</p>\n<h3 id=\"affected-source-code-2\" style=\"position:relative;\"><a href=\"#affected-source-code-2\" aria-label=\"affected source code 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/BorrowController.sol#L47\">BorrowController.sol:47</a></li>\n</ul>\n<h2 id=\"04-mixing-and-outdated-compiler\" style=\"position:relative;\"><a href=\"#04-mixing-and-outdated-compiler\" aria-label=\"04 mixing and outdated compiler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] Mixing and Outdated compiler</h2>\n<p>The pragma version used are:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity ^0.8.13;</span></span></code></pre>\n<p><em>Note that mixing pragma is not recommended. Because different compiler versions have different meanings and behaviors, it also significantly raises maintenance costs. As a result, depending on the compiler version selected for any given file, deployed contracts may have security issues.</em></p>\n<p>The minimum required version must be <a href=\"https://github.com/ethereum/solidity/releases/tag/v0.8.17\">0.8.17</a>; otherwise, contracts will be affected by the following <strong>important bug fixes</strong>:</p>\n<p><a href=\"https://blog.soliditylang.org/2022/05/18/solidity-0.8.14-release-announcement/\">0.8.14</a>:</p>\n<ul>\n<li>ABI Encoder: When ABI-encoding values from calldata that contain nested arrays, correctly validate the nested array length against <code>calldatasize()</code> in all cases.</li>\n<li>Override Checker: Allow changing data location for parameters only when overriding external functions.</li>\n</ul>\n<p><a href=\"https://blog.soliditylang.org/2022/06/15/solidity-0.8.15-release-announcement/\">0.8.15</a></p>\n<ul>\n<li>Code Generation: Avoid writing dirty bytes to storage when copying <code>bytes</code> arrays.</li>\n<li>Yul Optimizer: Keep all memory side-effects of inline assembly blocks.</li>\n</ul>\n<p><a href=\"https://blog.soliditylang.org/2022/08/08/solidity-0.8.16-release-announcement/\">0.8.16</a></p>\n<ul>\n<li>Code Generation: Fix data corruption that affected ABI-encoding of calldata values represented by tuples: structs at any nesting level; argument lists of external functions, events and errors; return value lists of external functions. The 32 leading bytes of the first dynamically-encoded value in the tuple would get zeroed when the last component contained a statically-encoded array.</li>\n</ul>\n<p><a href=\"https://blog.soliditylang.org/2022/09/08/solidity-0.8.17-release-announcement/\">0.8.17</a></p>\n<ul>\n<li>Yul Optimizer: Prevent the incorrect removal of storage writes before calls to Yul functions that conditionally terminate the external EVM call.</li>\n</ul>\n<p>Apart from these, there are several minor bug fixes and improvements.</p>\n<h2 id=\"05-lack-of-ack-during-owner-change\" style=\"position:relative;\"><a href=\"#05-lack-of-ack-during-owner-change\" aria-label=\"05 lack of ack during owner change permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] Lack of ACK during owner change</h2>\n<p>It’s possible to lose the ownership under specific circumstances.</p>\n<p>Because of human error it’s possible to set a new invalid owner. When you want to change the owner’s address it’s better to propose a new owner, and then accept this ownership with the new wallet.</p>\n<h3 id=\"affected-source-code-3\" style=\"position:relative;\"><a href=\"#affected-source-code-3\" aria-label=\"affected source code 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Fed.sol#L50\">Fed.sol:50</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L130\">Market.sol:130</a></li>\n</ul>\n<h2 id=\"06-market-pause-is-not-checked-during-contraction\" style=\"position:relative;\"><a href=\"#06-market-pause-is-not-checked-during-contraction\" aria-label=\"06 market pause is not checked during contraction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] Market pause is not checked during <code>contraction</code></h2>\n<p>In the <code>Fed</code> contract, during the <code>expansion</code> method is checked that the market is not paused, this requirement is not done during the <code>contraction</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function contraction(IMarket market, uint amount) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(msg.sender == chair, &quot;ONLY CHAIR&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(dbr.markets(address(market)), &quot;UNSUPPORTED MARKET&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       require(!market.borrowPaused(), &quot;CANNOT EXPAND PAUSED MARKETS&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint supply = supplies[market];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(amount &lt;= supply, &quot;AMOUNT TOO BIG&quot;); // can&#39;t burn profits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        market.recall(amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        dola.burn(amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        supplies[market] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        globalSupply -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        emit Contraction(market, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"affected-source-code-4\" style=\"position:relative;\"><a href=\"#affected-source-code-4\" aria-label=\"affected source code 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Fed.sol#L105\">Fed.sol:105</a></li>\n</ul>\n<h2 id=\"07-lack-of-no-reentrant-modifier\" style=\"position:relative;\"><a href=\"#07-lack-of-no-reentrant-modifier\" aria-label=\"07 lack of no reentrant modifier permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] Lack of no reentrant modifier</h2>\n<p>The <code>Market.getEscrow</code>, <code>Fed.expansion</code> and <code>Fed.contraction</code> methods do not have the <code>noReentrant</code> modifier and make calls to an external contract that can take advantage of and call these methods again, but it seems to fail due to the lack of tokens.</p>\n<p>However, if any of the other addresses used their receive event to provide liquidity to the contract, the attacking account could benefit from it.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   function expansion(IMarket market, uint amount) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   function expansion(IMarket market, uint amount) public noReentrant {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   function contraction(IMarket market, uint amount) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   function contraction(IMarket market, uint amount) public noReentrant {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>For example, in <code>getEscrow</code> if the <code>escrow</code> allows a callback, it could create two scrows, loosing funds if in this callback it will call again <code>getEscrow</code>, using for example <code>deposit</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">IEscrow</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">escrows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">IEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">escrows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">escrow</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li>Bob call <code>deposit</code>.</li>\n<li>During the <code>escrow</code> initialization it happend a reentrancy and call again <code>deposit</code>.</li>\n<li>The first deposit will be loss in the first escrow.</li>\n</ul>\n<p><em>Please note that current escrows do not allow re-entry, so I decided to use Low</em>.\n<strong>It’s always good to change the storage flags before the externals calls.</strong></p>\n<h3 id=\"affected-source-code-5\" style=\"position:relative;\"><a href=\"#affected-source-code-5\" aria-label=\"affected source code 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Fed.sol#L86\">Fed.sol:86</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Fed.sol#L103\">Fed.sol:103</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L245\">Market.sol:245</a></li>\n</ul>\n<h2 id=\"08-lack-of-checks-the-integer-ranges\" style=\"position:relative;\"><a href=\"#08-lack-of-checks-the-integer-ranges\" aria-label=\"08 lack of checks the integer ranges permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] Lack of checks the integer ranges</h2>\n<p>The following methods lack checks on the following integer arguments, you can see the recommendations above.</p>\n<h3 id=\"affected-source-code-6\" style=\"position:relative;\"><a href=\"#affected-source-code-6\" aria-label=\"affected source code 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<p><code>_replenishmentPriceBps</code> is not checked to be != 0 during the <code>constructor</code>, nevertheless it’s checked in <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/DBR.sol#L63\">setReplenishmentPriceBps</a></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/DBR.sol#L36\">DBR.sol:36</a></li>\n</ul>\n<p><code>replenishmentIncentiveBps</code> is not checked to be > 0 during the <code>constructor</code>, nevertheless it’s checked in <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L173\">setReplenismentIncentiveBps</a></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L76\">Market.sol:76</a></li>\n</ul>\n<h2 id=\"09-lack-of-checks-supportsinterface\" style=\"position:relative;\"><a href=\"#09-lack-of-checks-supportsinterface\" aria-label=\"09 lack of checks supportsinterface permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] Lack of checks <code>supportsInterface</code></h2>\n<p>The <code>EIP-165</code> standard helps detect that a smart contract implements the expected logic, prevents human error when configuring smart contract bindings, so it is recommended to check that the received argument is a contract and supports the expected interface.</p>\n<h3 id=\"reference-1\" style=\"position:relative;\"><a href=\"#reference-1\" aria-label=\"reference 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<ul>\n<li><a href=\"https://eips.ethereum.org/EIPS/eip-165\">https://eips.ethereum.org/EIPS/eip-165</a></li>\n</ul>\n<h3 id=\"affected-source-code-7\" style=\"position:relative;\"><a href=\"#affected-source-code-7\" aria-label=\"affected source code 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/DBR.sol#L99\">DBR.sol:99</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L81-L83\">Market.sol:81-83</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L118\">Market.sol:118</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L124\">Market.sol:124</a></li>\n</ul>\n<h2 id=\"10-lack-of-event-emit\" style=\"position:relative;\"><a href=\"#10-lack-of-event-emit\" aria-label=\"10 lack of event emit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[10] Lack of event emit</h2>\n<p>The <code>Market.pauseBorrows</code>, <code>Market.setLiquidationFeeBps</code>, <code>Market.setLiquidationIncentiveBps</code>, <code>Market.setReplenismentIncentiveBps</code>, <code>Market.setLiquidationFactorBps</code>, <code>Market.setCollateralFactorBps</code>, <code>Market.setBorrowController</code>, <code>Market.setOracle</code> methods do not emit an event when the state changes, something that it’s very important for dApps and users.</p>\n<h3 id=\"affected-source-code-8\" style=\"position:relative;\"><a href=\"#affected-source-code-8\" aria-label=\"affected source code 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L118\">Market.sol:118</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L124\">Market.sol:124</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L149\">Market.sol:149</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L161\">Market.sol:161</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L172\">Market.sol:172</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L183\">Market.sol:183</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L194\">Market.sol:194</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L218\">Market.sol:218</a></li>\n</ul>\n<h2 id=\"11-oracle-not-compatible-with-tokens-of-19-or-more-decimals\" style=\"position:relative;\"><a href=\"#11-oracle-not-compatible-with-tokens-of-19-or-more-decimals\" aria-label=\"11 oracle not compatible with tokens of 19 or more decimals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[11] Oracle not compatible with tokens of 19 or more decimals</h2>\n<p>Keep in mind that the version of solidity used, despite being greater than <code>0.8</code>, does not prevent integer overflows during casting, it only does so in mathematical operations.</p>\n<p>In the case that <code>feed.decimals()</code> returns 18, and the token is more than 18 decimals, the following subtraction will cause an underflow, denying the oracle service.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">feed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();  </span><span class=\"mtk3\">// 18 =&gt; [ETH/DAI] https://rinkeby.etherscan.io/address/0x74825dbc8bf76cc4e9494d0ecb210f676efa001d#readContract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">feeds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">].</span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">;   </span><span class=\"mtk3\">// &gt; 18</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">36</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feedDecimals</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">tokenDecimals</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// overflow</span></span></span></code></pre>\n<p>All pairs have 8 decimals except the <a href=\"https://docs.chain.link/docs/ethereum-addresses\">ETH</a> pairs, so a token with 19 decimals in ETH, will fault.</p>\n<h3 id=\"affected-source-code-9\" style=\"position:relative;\"><a href=\"#affected-source-code-9\" aria-label=\"affected source code 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Oracle.sol#L87-L98\">Oracle.sol:87-98</a></li>\n</ul>\n<h2 id=\"12-wrong-visibility\" style=\"position:relative;\"><a href=\"#12-wrong-visibility\" aria-label=\"12 wrong visibility permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[12] Wrong visibility</h2>\n<p>The method <code>accrueDueTokens</code> doesn’t check that the call is made by a market, and it’s public, it should be changed to internal or private to be more resilient.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">markets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Only markets can call onBorrow&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"affected-source-code-10\" style=\"position:relative;\"><a href=\"#affected-source-code-10\" aria-label=\"affected source code 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/DBR.sol#L284\">DBR.sol:284</a></li>\n</ul>\n<h2 id=\"13-bad-nomenclature\" style=\"position:relative;\"><a href=\"#13-bad-nomenclature\" aria-label=\"13 bad nomenclature permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[13] Bad nomenclature</h2>\n<p>The interface <code>IERC20</code> contains two methdos that are not pressent in the official ERC20, <code>delegate</code> and <code>delegates</code>, it’s recommended to change the name of the contract because not any ERC20 it’s valid.</p>\n<h3 id=\"affected-source-code-11\" style=\"position:relative;\"><a href=\"#affected-source-code-11\" aria-label=\"affected source code 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/escrows/GovTokenEscrow.sol#L9-L10\">GovTokenEscrow.sol:9-10</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/escrows/INVEscrow.sol#L10-L11\">INVEscrow.sol:10-11</a></li>\n</ul>\n<h2 id=\"14-open-todo\" style=\"position:relative;\"><a href=\"#14-open-todo\" aria-label=\"14 open todo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[14] Open TODO</h2>\n<p>The code that contains “open todos” reflects that the development is not finished and that the code can change a posteriori, prior release, with or without audit.</p>\n<h3 id=\"affected-source-code-12\" style=\"position:relative;\"><a href=\"#affected-source-code-12\" aria-label=\"affected source code 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<blockquote>\n<p>// TODO: Test whether an immutable variable will persist across proxies</p>\n</blockquote>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/escrows/INVEscrow.sol#L35\">INVEscrow.sol:35</a></li>\n</ul>\n<h2 id=\"15-avoid-duplicate-code\" style=\"position:relative;\"><a href=\"#15-avoid-duplicate-code\" aria-label=\"15 avoid duplicate code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[15] Avoid duplicate code</h2>\n<p>The <code>viewPrice</code> and <code>getPrice</code> methods of the <code>Oracle</code> contract are very similar, the only difference being the following peace of code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">dailyLows</span><span class=\"mtk1\">[</span><span class=\"mtk12\">token</span><span class=\"mtk1\">][</span><span class=\"mtk12\">day</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">todaysLow</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RecordDailyLow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">normalizedPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span></code></pre>\n<p>It’s recommended to reuse the code in order to be more readable and light.</p>\n<h3 id=\"affected-source-code-13\" style=\"position:relative;\"><a href=\"#affected-source-code-13\" aria-label=\"affected source code 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Oracle.sol#L126-L130\">Oracle.sol:126-130</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Oracle.sol#L79-L103\">Oracle.sol:79-103</a></li>\n</ul>\n<h2 id=\"16-avoid-hardcoded-values\" style=\"position:relative;\"><a href=\"#16-avoid-hardcoded-values\" aria-label=\"16 avoid hardcoded values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[16] Avoid hardcoded values</h2>\n<p>It is not good practice to hardcode values, but if you are dealing with addresses much less, these can change between implementations, networks or projects, so it is convenient to remove these values from the source code.</p>\n<h3 id=\"affected-source-code-14\" style=\"position:relative;\"><a href=\"#affected-source-code-14\" aria-label=\"affected source code 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Affected Source Code</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L44\">Market.sol:44</a></li>\n</ul>\n<p>It’s recommended to create a factor variable for <code>10000</code>:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L74-L76\">Market.sol:74-76</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L150\">Market.sol:150</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L162\">Market.sol:162</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L173\">Market.sol:173</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L184\">Market.sol:184</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L195\">Market.sol:195</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L336\">Market.sol:336</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L346\">Market.sol:346</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L360\">Market.sol:360</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L377\">Market.sol:377</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L563-L564\">Market.sol:563-564</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L583\">Market.sol:583</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-10-inverse/blob/3e81f0f5908ea99b36e6ab72f13488bbfe622183/src/Market.sol#L595-L606\">Market.sol:595-606</a></li>\n</ul>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 55 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/368\">report highlighted below</a> by <strong>pfapostol</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/604\">mcwildy</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/595\">sakman</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/592\">JC</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/559\">tnevler</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/554\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/539\">adriro</a>,\n<a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/532\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/528\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/515\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/505\">KoKo</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/497\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/492\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/490\">robee</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/488\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/485\">JrNet</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/475\">0xRoxas</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/471\">enckrish</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/465\">Amithuddar</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/451\">CloudX</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/411\">karanctf</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/380\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/369\">Chandr</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/355\">HardlyCodeMan</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/344\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/326\">shark</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/322\">Shinchan</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/313\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/312\">sakshamguruji</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/282\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/259\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/256\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/226\">kaden</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/213\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/194\">B2</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/169\">ch0bu</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/154\">martin</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/130\">Ozy42</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/124\">cryptostellar5</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/121\">Diana</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/107\">aphak5010</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/96\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/85\">skyle</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/65\">exolorkistis</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/50\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/47\">Rahoz</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/36\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/34\">ret2basic</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/32\">Dinesh11G</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/26\">ballx</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/25\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/19\">chaduke</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/11\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/4\">Mathieu</a>, and <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/3\">leosathya</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p>Gas savings are estimated using the gas report of existing <code>forge test --gas-report</code> tests (the sum of all deployment costs and the sum of the costs of calling methods) and may vary depending on the implementation of the fix.</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n<th align=\"center\">Estimated gas(deployments)</th>\n<th align=\"center\">Estimated gas(min method call)</th>\n<th align=\"center\">Estimated gas(avg method call)</th>\n<th align=\"center\">Estimated gas(max method call)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"><strong>01</strong></td>\n<td align=\"left\">State variables only set in the constructor should be declared immutable</td>\n<td align=\"center\">2</td>\n<td align=\"center\">117 275</td>\n<td align=\"center\">104</td>\n<td align=\"center\">110</td>\n<td align=\"center\">110</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>02</strong></td>\n<td align=\"left\">Use function instead of modifiers</td>\n<td align=\"center\">4</td>\n<td align=\"center\">115 926</td>\n<td align=\"center\">162</td>\n<td align=\"center\">-264</td>\n<td align=\"center\">-481</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>03</strong></td>\n<td align=\"left\">Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function</td>\n<td align=\"center\">11</td>\n<td align=\"center\">114 932</td>\n<td align=\"center\">-59</td>\n<td align=\"center\">-284</td>\n<td align=\"center\">-398</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>04</strong></td>\n<td align=\"left\">Multiple address mappings can be combined into a single mapping of an address to a struct, where appropriate</td>\n<td align=\"center\">5</td>\n<td align=\"center\">24 227</td>\n<td align=\"center\">254</td>\n<td align=\"center\">533</td>\n<td align=\"center\">-6 726</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>05</strong></td>\n<td align=\"left\">Expression can be unchecked when overflow is not possible</td>\n<td align=\"center\">6</td>\n<td align=\"center\">20 220</td>\n<td align=\"center\">410</td>\n<td align=\"center\">4 630</td>\n<td align=\"center\">1354</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>06</strong></td>\n<td align=\"left\">State variables can be packed into fewer storage slots</td>\n<td align=\"center\">1</td>\n<td align=\"center\">-5 008</td>\n<td align=\"center\">1 911</td>\n<td align=\"center\">15 525</td>\n<td align=\"center\">20 972</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>07</strong></td>\n<td align=\"left\">Refactoring similar statements</td>\n<td align=\"center\">1</td>\n<td align=\"center\">18 422</td>\n<td align=\"center\">-18</td>\n<td align=\"center\">-11</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>08</strong></td>\n<td align=\"left\">Better algorithm for underflow check</td>\n<td align=\"center\">3</td>\n<td align=\"center\">12 613</td>\n<td align=\"center\">656</td>\n<td align=\"center\">8 332</td>\n<td align=\"center\">3 741</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>09</strong></td>\n<td align=\"left\"><code>x = x + y</code> is cheaper than <code>x += y</code></td>\n<td align=\"center\">12</td>\n<td align=\"center\">11 214</td>\n<td align=\"center\">180</td>\n<td align=\"center\">468</td>\n<td align=\"center\">616</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>10</strong></td>\n<td align=\"left\"><code>internal</code> functions only called once can be inlined to save gas</td>\n<td align=\"center\">1</td>\n<td align=\"center\">5 207</td>\n<td align=\"center\">67</td>\n<td align=\"center\">47</td>\n<td align=\"center\">24</td>\n</tr>\n<tr>\n<td align=\"center\"><strong>11</strong></td>\n<td align=\"left\">State variables should be cached in stack variables rather than re-reading them from storage</td>\n<td align=\"center\">2</td>\n<td align=\"center\">5 007</td>\n<td align=\"center\">478</td>\n<td align=\"center\">1 117</td>\n<td align=\"center\">1 423</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"left\"><strong>Overall gas savings</strong></td>\n<td align=\"center\"><strong>48</strong></td>\n<td align=\"center\"><strong>416 802 (6,58%)</strong></td>\n<td align=\"center\"><strong>3 423 (0,34%)</strong></td>\n<td align=\"center\"><strong>15 773 (0,82%)</strong></td>\n<td align=\"center\"><strong>18 283 (0,72%)</strong></td>\n</tr>\n</tbody>\n</table>\n<p><strong>Total: 48 instances over 11 issues</strong></p>\n<hr>\n<h2 id=\"01-state-variables-only-set-in-the-constructor-should-be-declared-immutable-2-instances\" style=\"position:relative;\"><a href=\"#01-state-variables-only-set-in-the-constructor-should-be-declared-immutable-2-instances\" aria-label=\"01 state variables only set in the constructor should be declared immutable 2 instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] State variables only set in the constructor should be declared immutable (2 instances)</h2>\n<p>Deployment. Gas Saved: <strong>117 275</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>104</strong></p>\n<p>Average Method Call. Gas Saved: <strong>110</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>110</strong></p>\n<p>Overall gas change: <strong>-678 (-0.723%)</strong></p>\n<p>Avoids a Gsset (20000 gas) in the constructor, and replaces each Gwarmacces (100 gas) with a PUSH32 (3 gas).</p>\n<h3 id=\"srcdbrsol11-12\" style=\"position:relative;\"><a href=\"#srcdbrsol11-12\" aria-label=\"srcdbrsol11 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L11\">11</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L12\">12</a></h3>\n<p><strong>NOTE:</strong> name and symbol must be within 32 bytes</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..013960f 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -8,8 +8,8 @@ pragma solidity ^0.8.13;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    8,   8: */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    9,   9: contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   10,  10: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  11     :-    string public name;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  12     :-    string public symbol;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       11:+    bytes32 public immutable name;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       12:+    bytes32 public immutable symbol;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   13,  13:     uint8 public constant decimals = 18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   14,  14:     uint256 public _totalSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   15,  15:     address public operator;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -34,8 +34,8 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   34,  34:         address _operator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   35,  35:     ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   36,  36:         replenishmentPriceBps = _replenishmentPriceBps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  37     :-        name = _name;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  38     :-        symbol = _symbol;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       37:+        name = bytes32(bytes(_name));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       38:+        symbol = bytes32(bytes(_symbol));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   39,  39:         operator = _operator;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   40,  40:         INITIAL_CHAIN_ID = block.chainid;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   41,  41:         INITIAL_DOMAIN_SEPARATOR = computeDomainSeparator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -268,7 +268,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  268, 268:             keccak256(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  269, 269:                 abi.encode(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  270, 270:                     keccak256(&quot;EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)&quot;),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 271     :-                    keccak256(bytes(name)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      271:+                    keccak256(bytes.concat(name)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  272, 272:                     keccak256(&quot;1&quot;),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  273, 273:                     block.chainid,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  274, 274:                     address(this)</span></span></span></code></pre>\n<h2 id=\"02-use-function-instead-of-modifiers-4-instances\" style=\"position:relative;\"><a href=\"#02-use-function-instead-of-modifiers-4-instances\" aria-label=\"02 use function instead of modifiers 4 instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] Use function instead of modifiers (4 instances)</h2>\n<p>Deployment. Gas Saved: <strong>115 926</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>162</strong></p>\n<p>Average Method Call. Gas Saved: <strong>-264</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>-481</strong></p>\n<p>Overall gas change: <strong>734 (2.459%)</strong></p>\n<h3 id=\"srcborrowcontrollersol17\" style=\"position:relative;\"><a href=\"#srcborrowcontrollersol17\" aria-label=\"srcborrowcontrollersol17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/BorrowController.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/BorrowController.sol#L17\">17</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/BorrowController.sol b/src/BorrowController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 6decad1..080a4e3 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/BorrowController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/BorrowController.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -14,28 +14,36 @@ contract BorrowController {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   14,  14:         operator = _operator;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   15,  15:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   16,  16: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  17     :-    modifier onlyOperator {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       17:+    function onlyOperator() private view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   18,  18:         require(msg.sender == operator, &quot;Only operator&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  19     :-        _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   20,  19:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   21,  20:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   22,  21:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   23,  22:     @notice Sets the operator of the borrow controller. Only callable by the operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   24,  23:     @param _operator The address of the new operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   25,  24:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  26     :-    function setOperator(address _operator) public onlyOperator { operator = _operator; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       25:+    function setOperator(address _operator) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       26:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       27:+        operator = _operator; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       28:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   27,  29: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   28,  30:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   29,  31:     @notice Allows a contract to use the associated market.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   30,  32:     @param allowedContract The address of the allowed contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   31,  33:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  32     :-    function allow(address allowedContract) public onlyOperator { contractAllowlist[allowedContract] = true; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       34:+    function allow(address allowedContract) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       35:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       36:+        contractAllowlist[allowedContract] = true; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       37:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   33,  38: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   34,  39:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   35,  40:     @notice Denies a contract to use the associated market</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   36,  41:     @param deniedContract The addres of the denied contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   37,  42:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  38     :-    function deny(address deniedContract) public onlyOperator { contractAllowlist[deniedContract] = false; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       43:+    function deny(address deniedContract) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       44:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       45:+        contractAllowlist[deniedContract] = false; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       46:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   39,  47: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   40,  48:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   41,  49:     @notice Checks if a borrow is allowed</span></span></span></code></pre>\n<h3 id=\"srcdbrsol44\" style=\"position:relative;\"><a href=\"#srcdbrsol44\" aria-label=\"srcdbrsol44 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L44\">44</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..50428cd 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -41,16 +41,16 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   41,  41:         INITIAL_DOMAIN_SEPARATOR = computeDomainSeparator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   42,  42:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   43,  43: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  44     :-    modifier onlyOperator {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       44:+    function onlyOperator() private view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   45,  45:         require(msg.sender == operator, &quot;ONLY OPERATOR&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  46     :-        _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   47,  46:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   48,  47:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   49,  48:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   50,  49:     @notice Sets pending operator of the contract. Operator role must be claimed by the new oprator. Only callable by Operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   51,  50:     @param newOperator_ The address of the newOperator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   52,  51:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  53     :-    function setPendingOperator(address newOperator_) public onlyOperator {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       52:+    function setPendingOperator(address newOperator_) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       53:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   54,  54:         pendingOperator = newOperator_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   55,  55:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   56,  56: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -59,7 +59,8 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   59,  59:      At 10000, the cost of replenishing 1 DBR is 1 DOLA in debt. Only callable by Operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   60,  60:     @param newReplenishmentPriceBps_ The new replen</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   61,  61:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  62     :-    function setReplenishmentPriceBps(uint newReplenishmentPriceBps_) public onlyOperator {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       62:+    function setReplenishmentPriceBps(uint newReplenishmentPriceBps_) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       63:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   63,  64:         require(newReplenishmentPriceBps_ &gt; 0, &quot;replenishment price must be over 0&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   64,  65:         replenishmentPriceBps = newReplenishmentPriceBps_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   65,  66:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -78,7 +79,8 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   78,  79:     @notice Add a minter to the set of addresses allowed to mint DBR tokens. Only callable by Operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   79,  80:     @param minter_ The address of the new minter.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   80,  81:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  81     :-    function addMinter(address minter_) public onlyOperator {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       82:+    function addMinter(address minter_) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       83:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   82,  84:         minters[minter_] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   83,  85:         emit AddMinter(minter_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   84,  86:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -87,7 +89,8 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   87,  89:     @notice Removes a minter from the set of addresses allowe to mint DBR tokens. Only callable by Operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   88,  90:     @param minter_ The address to be removed from the minter set.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   89,  91:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  90     :-    function removeMinter(address minter_) public onlyOperator {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       92:+    function removeMinter(address minter_) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       93:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   91,  94:         minters[minter_] = false;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   92,  95:         emit RemoveMinter(minter_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   93,  96:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -96,7 +99,8 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   96,  99:     @dev markets can be added but cannot be removed. A removed market would result in unrepayable debt for some users.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   97, 100:     @param market_ The address of the new market contract to be added.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   98, 101:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  99     :-    function addMarket(address market_) public onlyOperator {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      102:+    function addMarket(address market_) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      103:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  100, 104:         markets[market_] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  101, 105:         emit AddMarket(market_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  102, 106:     }</span></span></span></code></pre>\n<h3 id=\"srcmarketsol92\" style=\"position:relative;\"><a href=\"#srcmarketsol92\" aria-label=\"srcmarketsol92 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Market.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L92\">92</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Market.sol b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 9585b85..796d0d0 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -89,9 +89,8 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   89,  89:         INITIAL_DOMAIN_SEPARATOR = computeDomainSeparator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   90,  90:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   91,  91:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  92     :-    modifier onlyGov {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       92:+    function onlyGov() private view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   93,  93:         require(msg.sender == gov, &quot;Only gov can call this function&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  94     :-        _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   95,  94:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   96,  95: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   97,  96:     function DOMAIN_SEPARATOR() public view virtual returns (bytes32) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -115,38 +114,54 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  115, 114:     @notice sets the oracle to a new oracle. Only callable by governance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  116, 115:     @param _oracle The new oracle conforming to the IOracle interface.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  117, 116:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 118     :-    function setOracle(IOracle _oracle) public onlyGov { oracle = _oracle; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      117:+    function setOracle(IOracle _oracle) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      118:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      119:+        oracle = _oracle; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      120:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  119, 121: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  120, 122:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  121, 123:     @notice sets the borrow controller to a new borrow controller. Only callable by governance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  122, 124:     @param _borrowController The new borrow controller conforming to the IBorrowController interface.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  123, 125:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 124     :-    function setBorrowController(IBorrowController _borrowController) public onlyGov { borrowController = _borrowController; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      126:+    function setBorrowController(IBorrowController _borrowController) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      127:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      128:+        borrowController = _borrowController; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      129:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  125, 130: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  126, 131:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  127, 132:     @notice sets the address of governance. Only callable by governance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  128, 133:     @param _gov Address of the new governance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  129, 134:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 130     :-    function setGov(address _gov) public onlyGov { gov = _gov; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      135:+    function setGov(address _gov) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      136:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      137:+        gov = _gov; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      138:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  131, 139: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  132, 140:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  133, 141:     @notice sets the lender to a new lender. The lender is allowed to recall dola from the contract. Only callable by governance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  134, 142:     @param _lender Address of the new lender.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  135, 143:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 136     :-    function setLender(address _lender) public onlyGov { lender = _lender; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      144:+    function setLender(address _lender) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      145:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      146:+        lender = _lender; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      147:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  137, 148: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  138, 149:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  139, 150:     @notice sets the pause guardian. The pause guardian can pause borrowing. Only callable by governance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  140, 151:     @param _pauseGuardian Address of the new pauseGuardian.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  141, 152:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 142     :-    function setPauseGuardian(address _pauseGuardian) public onlyGov { pauseGuardian = _pauseGuardian; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      153:+    function setPauseGuardian(address _pauseGuardian) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      154:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      155:+        pauseGuardian = _pauseGuardian; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      156:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  143, 157:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  144, 158:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  145, 159:     @notice sets the Collateral Factor requirement of the market as measured in basis points. 1 = 0.01%. Only callable by governance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  146, 160:     @dev Collateral factor mus be set below 100%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  147, 161:     @param _collateralFactorBps The new collateral factor as measured in basis points. </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  148, 162:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 149     :-    function setCollateralFactorBps(uint _collateralFactorBps) public onlyGov {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      163:+    function setCollateralFactorBps(uint _collateralFactorBps) public  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      164:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  150, 165:         require(_collateralFactorBps &lt; 10000, &quot;Invalid collateral factor&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  151, 166:         collateralFactorBps = _collateralFactorBps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  152, 167:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -158,7 +173,8 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  158, 173:     @dev Must be set between 1 and 10000.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  159, 174:     @param _liquidationFactorBps The new liquidation factor in basis points. 1 = 0.01%/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  160, 175:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 161     :-    function setLiquidationFactorBps(uint _liquidationFactorBps) public onlyGov {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      176:+    function setLiquidationFactorBps(uint _liquidationFactorBps) public  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      177:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  162, 178:         require(_liquidationFactorBps &gt; 0 &amp;&amp; _liquidationFactorBps &lt;= 10000, &quot;Invalid liquidation factor&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  163, 179:         liquidationFactorBps = _liquidationFactorBps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  164, 180:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -169,7 +185,8 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  169, 185:     @dev Must be set between 1 and 10000.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  170, 186:     @param _replenishmentIncentiveBps The new replenishment incentive set in basis points. 1 = 0.01%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  171, 187:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 172     :-    function setReplenismentIncentiveBps(uint _replenishmentIncentiveBps) public onlyGov {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      188:+    function setReplenismentIncentiveBps(uint _replenishmentIncentiveBps) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      189:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  173, 190:         require(_replenishmentIncentiveBps &gt; 0 &amp;&amp; _replenishmentIncentiveBps &lt; 10000, &quot;Invalid replenishment incentive&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  174, 191:         replenishmentIncentiveBps = _replenishmentIncentiveBps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  175, 192:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -180,7 +197,8 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  180, 197:     @dev Must be set between 0 and 10000 - liquidation fee.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  181, 198:     @param _liquidationIncentiveBps The new liqudation incentive set in basis points. 1 = 0.01% </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  182, 199:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 183     :-    function setLiquidationIncentiveBps(uint _liquidationIncentiveBps) public onlyGov {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      200:+    function setLiquidationIncentiveBps(uint _liquidationIncentiveBps) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      201:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  184, 202:         require(_liquidationIncentiveBps &gt; 0 &amp;&amp; _liquidationIncentiveBps + liquidationFeeBps &lt; 10000, &quot;Invalid liquidation incentive&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  185, 203:         liquidationIncentiveBps = _liquidationIncentiveBps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  186, 204:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -191,7 +209,8 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  191, 209:     @dev Must be set between 0 and 10000 - liquidation factor.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  192, 210:     @param _liquidationFeeBps The new liquidation fee set in basis points. 1 = 0.01%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  193, 211:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 194     :-    function setLiquidationFeeBps(uint _liquidationFeeBps) public onlyGov {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      212:+    function setLiquidationFeeBps(uint _liquidationFeeBps) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      213:+        onlyGov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  195, 214:         require(_liquidationFeeBps &gt; 0 &amp;&amp; _liquidationFeeBps + liquidationIncentiveBps &lt; 10000, &quot;Invalid liquidation fee&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  196, 215:         liquidationFeeBps = _liquidationFeeBps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  197, 216:     }</span></span></span></code></pre>\n<h3 id=\"srcoraclesol35\" style=\"position:relative;\"><a href=\"#srcoraclesol35\" aria-label=\"srcoraclesol35 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Oracle.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Oracle.sol#L35\">35</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Oracle.sol b/src/Oracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 14338ed..3e7c608 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Oracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Oracle.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -32,16 +32,18 @@ contract Oracle {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   32,  32:         operator = _operator;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   33,  33:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   34,  34: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  35     :-    modifier onlyOperator {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       35:+    function onlyOperator() private view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   36,  36:         require(msg.sender == operator, &quot;ONLY OPERATOR&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  37     :-        _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   38,  37:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   39,  38:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   40,  39:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   41,  40:     @notice Sets the pending operator of the oracle. Only callable by operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   42,  41:     @param newOperator_ The address of the pending operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   43,  42:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  44     :-    function setPendingOperator(address newOperator_) public onlyOperator { pendingOperator = newOperator_; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       43:+    function setPendingOperator(address newOperator_) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       44:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       45:+        pendingOperator = newOperator_; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       46:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   45,  47: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   46,  48:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   47,  49:     @notice Sets the price feed of a specific token address.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -50,7 +52,10 @@ contract Oracle {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   50,  52:     @param feed The chainlink feed of the ERC20 token.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   51,  53:     @param tokenDecimals uint8 representing the decimal precision of the token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   52,  54:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  53     :-    function setFeed(address token, IChainlinkFeed feed, uint8 tokenDecimals) public onlyOperator { feeds[token] = FeedData(feed, tokenDecimals); }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       55:+    function setFeed(address token, IChainlinkFeed feed, uint8 tokenDecimals) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       56:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       57:+        feeds[token] = FeedData(feed, tokenDecimals); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       58:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   54,  59: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   55,  60:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   56,  61:     @notice Sets a fixed price for a token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -58,7 +63,10 @@ contract Oracle {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   58,  63:     @param token The address of the fixed price token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   59,  64:     @param price The fixed price of the token. Remember to account for decimal precision when setting this.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   60,  65:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  61     :-    function setFixedPrice(address token, uint price) public onlyOperator { fixedPrices[token] = price; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       66:+    function setFixedPrice(address token, uint price) public { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       67:+        onlyOperator();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       68:+        fixedPrices[token] = price; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       69:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   62,  70: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   63,  71:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   64,  72:     @notice Claims the operator role. Only successfully callable by the pending operator.</span></span></span></code></pre>\n<h2 id=\"03-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function-instances\" style=\"position:relative;\"><a href=\"#03-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function-instances\" aria-label=\"03 duplicated requirerevert checks should be refactored to a modifier or function instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function (instances)</h2>\n<p>Deployment. Gas Saved: <strong>114 932</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>-59</strong></p>\n<p>Average Method Call. Gas Saved: <strong>-284</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>-398</strong></p>\n<p>Overall gas change: <strong>-2 665 (-12.599%)</strong></p>\n<h3 id=\"srcfedsol49-58-67-76-87-88-104-105\" style=\"position:relative;\"><a href=\"#srcfedsol49-58-67-76-87-88-104-105\" aria-label=\"srcfedsol49 58 67 76 87 88 104 105 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Fed.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L49\">49</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L58\">58</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L67\">67</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L76\">76</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L87\">87</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L88\">88</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L104\">104</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L105\">105</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Fed.sol b/src/Fed.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 1e819bb..8b54676 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Fed.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Fed.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -41,12 +41,24 @@ contract Fed {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   41,  41:         supplyCeiling = _supplyCeiling;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   42,  42:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   43,  43: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       44:+    function is_gov() private view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       45:+        require(msg.sender == gov, &quot;ONLY GOV&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       46:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       47:+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       48:+    function is_chair() private view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       49:+        require(msg.sender == chair, &quot;ONLY CHAIR&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       50:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       51:+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       52:+    function is_supported_market(IMarket _market) private view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       53:+        require(dbr.markets(address(_market)), &quot;UNSUPPORTED MARKET&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       54:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       55:+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   44,  56:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   45,  57:     @notice Change the governance of the Fed contact. Only callable by governance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   46,  58:     @param _gov The address of the new governance contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   47,  59:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   48,  60:     function changeGov(address _gov) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  49     :-        require(msg.sender == gov, &quot;ONLY GOV&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       61:+        is_gov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   50,  62:         gov = _gov;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   51,  63:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   52,  64: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -55,7 +67,7 @@ contract Fed {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   55,  67:     @param _supplyCeiling Amount to set the supply ceiling to</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   56,  68:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   57,  69:     function changeSupplyCeiling(uint _supplyCeiling) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  58     :-        require(msg.sender == gov, &quot;ONLY GOV&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       70:+        is_gov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   59,  71:         supplyCeiling = _supplyCeiling;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   60,  72:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   61,  73: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -64,7 +76,7 @@ contract Fed {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   64,  76:     @param _chair Address of the new chair.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   65,  77:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   66,  78:     function changeChair(address _chair) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  67     :-        require(msg.sender == gov, &quot;ONLY GOV&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       79:+        is_gov();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   68,  80:         chair = _chair;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   69,  81:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   70,  82: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -73,7 +85,7 @@ contract Fed {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   73,  85:     @dev Useful for immediately removing chair powers in case of a wallet compromise.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   74,  86:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   75,  87:     function resign() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  76     :-        require(msg.sender == chair, &quot;ONLY CHAIR&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       88:+        is_chair();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   77,  89:         chair = address(0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   78,  90:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   79,  91: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -84,8 +96,8 @@ contract Fed {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   84,  96:     @param amount The amount of DOLA to mint and supply to the market.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   85,  97:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   86,  98:     function expansion(IMarket market, uint amount) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  87     :-        require(msg.sender == chair, &quot;ONLY CHAIR&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  88     :-        require(dbr.markets(address(market)), &quot;UNSUPPORTED MARKET&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       99:+        is_chair();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      100:+        is_supported_market(market);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   89, 101:         require(market.borrowPaused() != true, &quot;CANNOT EXPAND PAUSED MARKETS&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   90, 102:         dola.mint(address(market), amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   91, 103:         supplies[market] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -101,8 +113,8 @@ contract Fed {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  101, 113:     @param amount The amount of DOLA to withdraw and burn.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  102, 114:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  103, 115:     function contraction(IMarket market, uint amount) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 104     :-        require(msg.sender == chair, &quot;ONLY CHAIR&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 105     :-        require(dbr.markets(address(market)), &quot;UNSUPPORTED MARKET&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      116:+        is_chair();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      117:+        is_supported_market(market);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  106, 118:         uint supply = supplies[market];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  107, 119:         require(amount &lt;= supply, &quot;AMOUNT TOO BIG&quot;); // can&#39;t burn profits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  108, 120:         market.recall(amount);</span></span></span></code></pre>\n<h3 id=\"srcdbrsol171-195-373\" style=\"position:relative;\"><a href=\"#srcdbrsol171-195-373\" aria-label=\"srcdbrsol171 195 373 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L171\">171</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L195\">195</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L373\">373</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..625c422 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -46,6 +46,10 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   46,  46:         _;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   47,  47:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   48,  48:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       49:+    function is_balance_sufficient(address _user, uint256 amount) private view {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       50:+        require(balanceOf(_user) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       51:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       52:+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   49,  53:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   50,  54:     @notice Sets pending operator of the contract. Operator role must be claimed by the new oprator. Only callable by Operator.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   51,  55:     @param newOperator_ The address of the newOperator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -168,7 +172,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  168, 172:     @return Always returns true, will revert if not successful.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  169, 173:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  170, 174:     function transfer(address to, uint256 amount) public virtual returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 171     :-        require(balanceOf(msg.sender) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      175:+        is_balance_sufficient(msg.sender, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  172, 176:         balances[msg.sender] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  173, 177:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  174, 178:             balances[to] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -192,7 +196,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  192, 196:     ) public virtual returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  193, 197:         uint256 allowed = allowance[from][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  194, 198:         if (allowed != type(uint256).max) allowance[from][msg.sender] = allowed - amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 195     :-        require(balanceOf(from) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      199:+        is_balance_sufficient(from, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  196, 200:         balances[from] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  197, 201:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  198, 202:             balances[to] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -370,7 +374,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  370, 374:     @param amount Amount of DBR to be burned.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  371, 375:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  372, 376:     function _burn(address from, uint256 amount) internal virtual {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 373     :-        require(balanceOf(from) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      377:+        is_balance_sufficient(from, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  374, 378:         balances[from] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  375, 379:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  376, 380:             _totalSupply -= amount;</span></span></span></code></pre>\n<h2 id=\"04-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate-5-instances\" style=\"position:relative;\"><a href=\"#04-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate-5-instances\" aria-label=\"04 multiple address mappings can be combined into a single mapping of an address to a struct where appropriate 5 instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] Multiple address mappings can be combined into a single mapping of an address to a struct, where appropriate (5 instances)</h2>\n<p>Deployment. Gas Saved: <strong>24 227</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>254</strong></p>\n<p>Average Method Call. Gas Saved: <strong>533</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>-6 726</strong></p>\n<p>Overall gas change: <strong>-1 371 (20.741%)</strong></p>\n<p>Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (20000 gas) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save ~42 gas per access due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - 30 gas) and that calculation’s associated stack operations.</p>\n<h3 id=\"srcdbrsol19-23-26-27-28\" style=\"position:relative;\"><a href=\"#srcdbrsol19-23-26-27-28\" aria-label=\"srcdbrsol19 23 26 27 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L19\">19</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L23\">23</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L26\">26</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L27\">27</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L28\">28</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..43db0aa 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -8,6 +8,17 @@ pragma solidity ^0.8.13;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    8,   8: */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    9,   9: contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   10,  10: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       11:+    struct UserInfo {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       12:+        uint256 balances;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       13:+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       14:+        uint256 nonce;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       15:+        uint256 debts;  // user =&gt; debt across all tracked markets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       16:+        uint256 dueTokensAccrued; // user =&gt; amount of due tokens accrued</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       17:+        uint256 lastUpdated; // user =&gt; last update timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       18:+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       19:+    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       20:+    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       21:+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   11,  22:     string public name;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   12,  23:     string public symbol;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   13,  24:     uint8 public constant decimals = 18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -16,16 +27,11 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   16,  27:     address public pendingOperator;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   17,  28:     uint public totalDueTokensAccrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   18,  29:     uint public replenishmentPriceBps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  19     :-    mapping(address =&gt; uint256) public balances;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  20     :-    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       30:+    mapping(address =&gt; UserInfo) public userInfo;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   21,  31:     uint256 internal immutable INITIAL_CHAIN_ID;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   22,  32:     bytes32 internal immutable INITIAL_DOMAIN_SEPARATOR;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  23     :-    mapping(address =&gt; uint256) public nonces;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   24,  33:     mapping (address =&gt; bool) public minters;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   25,  34:     mapping (address =&gt; bool) public markets;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  26     :-    mapping (address =&gt; uint) public debts; // user =&gt; debt across all tracked markets</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  27     :-    mapping (address =&gt; uint) public dueTokensAccrued; // user =&gt; amount of due tokens accrued</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  28     :-    mapping (address =&gt; uint) public lastUpdated; // user =&gt; last update timestamp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   29,  35: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   30,  36:     constructor(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   31,  37:         uint _replenishmentPriceBps,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -118,10 +124,10 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  118, 124:     @return uint representing the balance of the user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  119, 125:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  120, 126:     function balanceOf(address user) public view returns (uint) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 121     :-        uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 122     :-        uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 123     :-        if(dueTokensAccrued[user] + accrued &gt; balances[user]) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 124     :-        return balances[user] - dueTokensAccrued[user] - accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      127:+        uint debt = userInfo[user].debts;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      128:+        uint accrued = (block.timestamp - userInfo[user].lastUpdated) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      129:+        if(userInfo[user].dueTokensAccrued + accrued &gt; userInfo[user].balances) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      130:+        return userInfo[user].balances - userInfo[user].dueTokensAccrued - accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  125, 131:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  126, 132: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  127, 133:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -131,10 +137,10 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  131, 137:     @return uint representing the deficit of the user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  132, 138:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  133, 139:     function deficitOf(address user) public view returns (uint) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 134     :-        uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 135     :-        uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 136     :-        if(dueTokensAccrued[user] + accrued &lt; balances[user]) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 137     :-        return dueTokensAccrued[user] + accrued - balances[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      140:+        uint debt = userInfo[user].debts;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      141:+        uint accrued = (block.timestamp - userInfo[user].lastUpdated) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      142:+        if(userInfo[user].dueTokensAccrued + accrued &lt; userInfo[user].balances) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      143:+        return userInfo[user].dueTokensAccrued + accrued - userInfo[user].balances;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  138, 144:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  139, 145:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  140, 146:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -144,9 +150,9 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  144, 150:     @return Returns a signed int of the user&#39;s balance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  145, 151:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  146, 152:     function signedBalanceOf(address user) public view returns (int) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 147     :-        uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 148     :-        uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 149     :-        return int(balances[user]) - int(dueTokensAccrued[user]) - int(accrued);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      153:+        uint debt = userInfo[user].debts;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      154:+        uint accrued = (block.timestamp - userInfo[user].lastUpdated) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      155:+        return int(userInfo[user].balances) - int(userInfo[user].dueTokensAccrued) - int(accrued);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  150, 156:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  151, 157: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  152, 158:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -169,9 +175,9 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  169, 175:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  170, 176:     function transfer(address to, uint256 amount) public virtual returns (bool) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  171, 177:         require(balanceOf(msg.sender) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 172     :-        balances[msg.sender] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      178:+        userInfo[msg.sender].balances -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  173, 179:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 174     :-            balances[to] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      180:+            userInfo[to].balances += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  175, 181:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  176, 182:         emit Transfer(msg.sender, to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  177, 183:         return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -193,9 +199,9 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  193, 199:         uint256 allowed = allowance[from][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  194, 200:         if (allowed != type(uint256).max) allowance[from][msg.sender] = allowed - amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  195, 201:         require(balanceOf(from) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 196     :-        balances[from] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      202:+        userInfo[from].balances -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  197, 203:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 198     :-            balances[to] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      204:+            userInfo[to].balances += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  199, 205:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  200, 206:         emit Transfer(from, to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  201, 207:         return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -236,7 +242,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  236, 242:                                 owner,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  237, 243:                                 spender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  238, 244:                                 value,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 239     :-                                nonces[owner]++,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      245:+                                userInfo[owner].nonce++,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  240, 246:                                 deadline</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  241, 247:                             )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  242, 248:                         )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -256,7 +262,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  256, 262:     @notice Function for invalidating the nonce of a signed message.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  257, 263:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  258, 264:     function invalidateNonce() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 259     :-        nonces[msg.sender]++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      265:+        userInfo[msg.sender].nonce++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  260, 266:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  261, 267: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  262, 268:     function DOMAIN_SEPARATOR() public view virtual returns (bytes32) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -282,12 +288,12 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  282, 288:     @param user The address of the user to accrue DBR debt to.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  283, 289:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  284, 290:     function accrueDueTokens(address user) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 285     :-        uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 286     :-        if(lastUpdated[user] == block.timestamp) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 287     :-        uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 288     :-        dueTokensAccrued[user] += accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      291:+        uint debt = userInfo[user].debts;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      292:+        if(userInfo[user].lastUpdated == block.timestamp) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      293:+        uint accrued = (block.timestamp - userInfo[user].lastUpdated) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      294:+        userInfo[user].dueTokensAccrued += accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  289, 295:         totalDueTokensAccrued += accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 290     :-        lastUpdated[user] = block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      296:+        userInfo[user].lastUpdated = block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  291, 297:         emit Transfer(user, address(0), accrued);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  292, 298:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  293, 299: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -301,7 +307,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  301, 307:         require(markets[msg.sender], &quot;Only markets can call onBorrow&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  302, 308:         accrueDueTokens(user);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  303, 309:         require(deficitOf(user) == 0, &quot;DBR Deficit&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 304     :-        debts[user] += additionalDebt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      310:+        userInfo[user].debts += additionalDebt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  305, 311:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  306, 312: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  307, 313:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -313,7 +319,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  313, 319:     function onRepay(address user, uint repaidDebt) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  314, 320:         require(markets[msg.sender], &quot;Only markets can call onRepay&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  315, 321:         accrueDueTokens(user);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 316     :-        debts[user] -= repaidDebt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      322:+        userInfo[user].debts -= repaidDebt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  317, 323:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  318, 324: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  319, 325:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -329,7 +335,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  329, 335:         require(deficit &gt;= amount, &quot;Amount &gt; deficit&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  330, 336:         uint replenishmentCost = amount * replenishmentPriceBps / 10000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  331, 337:         accrueDueTokens(user);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 332     :-        debts[user] += replenishmentCost;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      338:+        userInfo[user].debts += replenishmentCost;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  333, 339:         _mint(user, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  334, 340:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  335, 341: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -359,7 +365,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  359, 365:     function _mint(address to, uint256 amount) internal virtual {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  360, 366:         _totalSupply += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  361, 367:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 362     :-            balances[to] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      368:+            userInfo[to].balances += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  363, 369:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  364, 370:         emit Transfer(address(0), to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  365, 371:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -371,7 +377,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  371, 377:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  372, 378:     function _burn(address from, uint256 amount) internal virtual {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  373, 379:         require(balanceOf(from) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 374     :-        balances[from] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      380:+        userInfo[from].balances -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  375, 381:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  376, 382:             _totalSupply -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  377, 383:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/test/DBR.t.sol b/src/test/DBR.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3988cf7..754bf7f 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/test/DBR.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/test/DBR.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -145,17 +145,19 @@ contract DBRTest is FiRMTest {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  145, 145:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  146, 146: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  147, 147:     function test_invalidateNonce() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 148     :-        assertEq(dbr.nonces(user), 0, &quot;User nonce should be uninitialized&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      148:+        (, uint256 nonce,,,) = dbr.userInfo(user);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      149:+        assertEq(nonce, 0, &quot;User nonce should be uninitialized&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  149, 150: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  150, 151:         vm.startPrank(user);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  151, 152:         dbr.invalidateNonce();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  152, 153: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 153     :-        assertEq(dbr.nonces(user), 1, &quot;User nonce was not invalidated&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      154:+        (,nonce,,,) = dbr.userInfo(user);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      155:+        assertEq(nonce, 1, &quot;User nonce was not invalidated&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  154, 156:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  155, 157: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  156, 158:     function test_approve_increasesAllowanceByAmount() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  157, 159:         uint amount = 100e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 158     :-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      160:+        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  159, 161:         assertEq(dbr.allowance(user, gov), 0, &quot;Allowance should not be set yet&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  160, 162: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  161, 163:         vm.startPrank(user);</span></span></span></code></pre>\n<h2 id=\"05-expression-can-be-unchecked-when-overflow-is-not-possible-6-instances\" style=\"position:relative;\"><a href=\"#05-expression-can-be-unchecked-when-overflow-is-not-possible-6-instances\" aria-label=\"05 expression can be unchecked when overflow is not possible 6 instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] Expression can be unchecked when overflow is not possible (6 instances)</h2>\n<p>Deployment. Gas Saved: <strong>20 220</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>410</strong></p>\n<p>Average Method Call. Gas Saved: <strong>4 630</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>1 354</strong></p>\n<p>Overall gas change: <strong>-6 233 (-5.326%)</strong></p>\n<h3 id=\"srcdbrsol110-124-137-259\" style=\"position:relative;\"><a href=\"#srcdbrsol110-124-137-259\" aria-label=\"srcdbrsol110 124 137 259 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L110\">110</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L124\">124</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L137\">137</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L259\">259</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..0781c97 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -107,8 +107,10 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  107, 107:     @return uint representing the total supply of DBR.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  108, 108:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  109, 109:     function totalSupply() public view returns (uint) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 110     :-        if(totalDueTokensAccrued &gt; _totalSupply) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 111     :-        return _totalSupply - totalDueTokensAccrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      110:+        unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      111:+            if(totalDueTokensAccrued &gt; _totalSupply) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      112:+            return _totalSupply - totalDueTokensAccrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      113:+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  112, 114:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  113, 115: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  114, 116:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -121,7 +123,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  121, 123:         uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  122, 124:         uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  123, 125:         if(dueTokensAccrued[user] + accrued &gt; balances[user]) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 124     :-        return balances[user] - dueTokensAccrued[user] - accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      126:+        unchecked { return balances[user] - dueTokensAccrued[user] - accrued; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  125, 127:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  126, 128: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  127, 129:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -134,7 +136,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  134, 136:         uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  135, 137:         uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  136, 138:         if(dueTokensAccrued[user] + accrued &lt; balances[user]) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 137     :-        return dueTokensAccrued[user] + accrued - balances[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      139:+        unchecked { return dueTokensAccrued[user] + accrued - balances[user]; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  138, 140:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  139, 141:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  140, 142:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -256,7 +258,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  256, 258:     @notice Function for invalidating the nonce of a signed message.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  257, 259:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  258, 260:     function invalidateNonce() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 259     :-        nonces[msg.sender]++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      261:+        unchecked { nonces[msg.sender]++; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  260, 262:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  261, 263: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  262, 264:     function DOMAIN_SEPARATOR() public view virtual returns (bytes32) {</span></span></span></code></pre>\n<h3 id=\"srcfedsol124\" style=\"position:relative;\"><a href=\"#srcfedsol124\" aria-label=\"srcfedsol124 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Fed.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Fed.sol#L124\">124</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Fed.sol b/src/Fed.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 1e819bb..b57b444 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Fed.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Fed.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -121,7 +121,7 @@ contract Fed {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  121, 121:         uint marketValue = dola.balanceOf(address(market)) + market.totalDebt();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  122, 122:         uint supply = supplies[market];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  123, 123:         if(supply &gt;= marketValue) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 124     :-        return marketValue - supply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      124:+        unchecked { return marketValue - supply; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  125, 125:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  126, 126: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  127, 127:     /**</span></span></span></code></pre>\n<h3 id=\"srcmarketsol521\" style=\"position:relative;\"><a href=\"#srcmarketsol521\" aria-label=\"srcmarketsol521 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Market.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L521\">521</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Market.sol b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 9585b85..293bbb6 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -518,7 +518,7 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  518, 518:     @notice Function for incrementing the nonce of the msg.sender, making their latest signed message unusable.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  519, 519:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  520, 520:     function invalidateNonce() public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 521     :-        nonces[msg.sender]++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      521:+        unchecked { nonces[msg.sender]++; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  522, 522:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  523, 523:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  524, 524:     /**</span></span></span></code></pre>\n<h2 id=\"06-state-variables-can-be-packed-into-fewer-storage-slots-1-instance\" style=\"position:relative;\"><a href=\"#06-state-variables-can-be-packed-into-fewer-storage-slots-1-instance\" aria-label=\"06 state variables can be packed into fewer storage slots 1 instance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] State variables can be packed into fewer storage slots (1 instance)</h2>\n<p>Deployment. Gas Saved: <strong>-5 008</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>1 911</strong></p>\n<p>Average Method Call. Gas Saved: <strong>15 525</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>20 972</strong></p>\n<p>Overall gas change: <strong>-62 419 (-69.524%)</strong></p>\n<p>If variables occupying the same slot are both written the same function or by the constructor, avoids a separate Gsset (20000 gas). Reads of the variables can also be cheaper</p>\n<p>uint256(32), mapping(32), address(20), bool(1)</p>\n<h3 id=\"srcmarketsol53\" style=\"position:relative;\"><a href=\"#srcmarketsol53\" aria-label=\"srcmarketsol53 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Market.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L53\">53</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Market.sol b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 9585b85..6141e5c 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -36,6 +36,7 @@ interface IBorrowController {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   36,  36: contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   37,  37: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   38,  38:     address public gov;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       39:+    bool public borrowPaused;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   39,  40:     address public lender;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   40,  41:     address public pauseGuardian;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   41,  42:     address public immutable escrowImplementation;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -50,7 +51,6 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   50,  51:     uint public liquidationFeeBps;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   51,  52:     uint public liquidationFactorBps = 5000; // 50% by default</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   52,  53:     bool immutable callOnDepositCallback;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  53     :-    bool public borrowPaused;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   54,  54:     uint public totalDebt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   55,  55:     uint256 internal immutable INITIAL_CHAIN_ID;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   56,  56:     bytes32 internal immutable INITIAL_DOMAIN_SEPARATOR;</span></span></span></code></pre>\n<h2 id=\"07-refactoring-similar-statements-1-instance\" style=\"position:relative;\"><a href=\"#07-refactoring-similar-statements-1-instance\" aria-label=\"07 refactoring similar statements 1 instance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] Refactoring similar statements (1 instance)</h2>\n<p>Deployment. Gas Saved: <strong>18 422</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>-18</strong></p>\n<p>Average Method Call. Gas Saved: <strong>-11</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>6</strong></p>\n<p>Overall gas change: <strong>4 876 (7.739%)</strong></p>\n<h3 id=\"srcmarketsol213\" style=\"position:relative;\"><a href=\"#srcmarketsol213\" aria-label=\"srcmarketsol213 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Market.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L213\">213</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Market.sol b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 9585b85..da295e5 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -210,11 +210,9 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  210, 210:     @param _value Boolean representing the state pause state of borrows. true = paused, false = unpaused.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  211, 211:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  212, 212:     function pauseBorrows(bool _value) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 213     :-        if(_value) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 214     :-            require(msg.sender == pauseGuardian || msg.sender == gov, &quot;Only pause guardian or governance can pause&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 215     :-        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 216     :-            require(msg.sender == gov, &quot;Only governance can unpause&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 217     :-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      213:+        require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      214:+            ( _value &amp;&amp; msg.sender == pauseGuardian) || msg.sender == gov,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      215:+            &quot;Only pause guardian or governance can pause&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  218, 216:         borrowPaused = _value;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  219, 217:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  220, 218: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/test/Market.t.sol b/src/test/Market.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 8992ab9..86af449 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/test/Market.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/test/Market.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -16,7 +16,7 @@ import &quot;./mocks/BorrowContract.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   16,  16: import {EthFeed} from &quot;./mocks/EthFeed.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   17,  17: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   18,  18: contract MarketTest is FiRMTest {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  19     :-    bytes onlyGovUnpause = &quot;Only governance can unpause&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       19:+    bytes onlyGovUnpause = &quot;Only pause guardian or governance can pause&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   20,  20:     bytes onlyPauseGuardianOrGov = &quot;Only pause guardian or governance can pause&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   21,  21: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   22,  22:     BorrowContract borrowContract;</span></span></span></code></pre>\n<h2 id=\"08-better-algorithm-for-underflow-check-3-instances\" style=\"position:relative;\"><a href=\"#08-better-algorithm-for-underflow-check-3-instances\" aria-label=\"08 better algorithm for underflow check 3 instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] Better algorithm for underflow check (3 instances)</h2>\n<p>Deployment. Gas Saved: <strong>12 613</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>656</strong></p>\n<p>Average Method Call. Gas Saved: <strong>8 332</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>3 741</strong></p>\n<p>Overall gas change: <strong>-18 048 (-15.981%)</strong></p>\n<h3 id=\"srcdbrsol110-123-136\" style=\"position:relative;\"><a href=\"#srcdbrsol110-123-136\" aria-label=\"srcdbrsol110 123 136 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L110\">110</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L123\">123</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L136\">136</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..bff9fef 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -104,37 +104,39 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  104, 104:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  105, 105:     @notice Get the total supply of DBR tokens.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  106, 106:     @dev The total supply is calculated as the difference between total DBR minted and total DBR accrued.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 107     :-    @return uint representing the total supply of DBR.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      107:+    @return ret uint representing the total supply of DBR.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  108, 108:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 109     :-    function totalSupply() public view returns (uint) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 110     :-        if(totalDueTokensAccrued &gt; _totalSupply) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 111     :-        return _totalSupply - totalDueTokensAccrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      109:+    function totalSupply() public view returns (uint ret) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      110:+        unchecked { ret = _totalSupply - totalDueTokensAccrued; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      111:+        if(ret &gt; _totalSupply) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  112, 112:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  113, 113: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  114, 114:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  115, 115:     @notice Get the DBR balance of an address. Will return 0 if the user has zero DBR or a deficit.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  116, 116:     @dev The balance of a user is calculated as the difference between the user&#39;s balance and the user&#39;s accrued DBR debt + due DBR debt.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  117, 117:     @param user Address of the user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 118     :-    @return uint representing the balance of the user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      118:+    @return ret uint representing the balance of the user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  119, 119:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 120     :-    function balanceOf(address user) public view returns (uint) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      120:+    function balanceOf(address user) public view returns (uint ret) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  121, 121:         uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  122, 122:         uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 123     :-        if(dueTokensAccrued[user] + accrued &gt; balances[user]) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 124     :-        return balances[user] - dueTokensAccrued[user] - accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      123:+        uint mid = dueTokensAccrued[user] + accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      124:+        unchecked { ret = balances[user] - mid; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      125:+        if(ret &gt; balances[user]) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  125, 126:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  126, 127: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  127, 128:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  128, 129:     @notice Get the DBR deficit of an address. Will return 0 if th user has zero DBR or more.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  129, 130:     @dev The deficit of a user is calculated as the difference between the user&#39;s accrued DBR deb + due DBR debt and their balance.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  130, 131:     @param user Address of the user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 131     :-    @return uint representing the deficit of the user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      132:+    @return ret uint representing the deficit of the user.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  132, 133:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 133     :-    function deficitOf(address user) public view returns (uint) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      134:+    function deficitOf(address user) public view returns (uint ret) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  134, 135:         uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  135, 136:         uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 136     :-        if(dueTokensAccrued[user] + accrued &lt; balances[user]) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 137     :-        return dueTokensAccrued[user] + accrued - balances[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      137:+        uint mid = dueTokensAccrued[user] + accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      138:+        unchecked { ret = mid - balances[user]; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      139:+        if(mid &lt; ret) return 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  138, 140:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  139, 141:     </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  140, 142:     /**</span></span></span></code></pre>\n<h2 id=\"09-x--x--y-is-cheaper-than-x--y-12-instances\" style=\"position:relative;\"><a href=\"#09-x--x--y-is-cheaper-than-x--y-12-instances\" aria-label=\"09 x  x  y is cheaper than x  y 12 instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] <code>x = x + y</code> is cheaper than <code>x += y</code> (12 instances)</h2>\n<p>Deployment. Gas Saved: <strong>11 214</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>180</strong></p>\n<p>Average Method Call. Gas Saved: <strong>468</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>616</strong></p>\n<p>Overall gas change: <strong>-5 325 (-1.318%)</strong></p>\n<h3 id=\"srcdbrsol174-196-289-360-362-376\" style=\"position:relative;\"><a href=\"#srcdbrsol174-196-289-360-362-376\" aria-label=\"srcdbrsol174 196 289 360 362 376 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L174\">174</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L196\">196</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L289\">289</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L360\">360</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L362\">362</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L376\">376</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..c02b782 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -171,7 +171,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  171, 171:         require(balanceOf(msg.sender) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  172, 172:         balances[msg.sender] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  173, 173:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 174     :-            balances[to] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      174:+            balances[to] = balances[to] + amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  175, 175:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  176, 176:         emit Transfer(msg.sender, to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  177, 177:         return true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -193,7 +193,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  193, 193:         uint256 allowed = allowance[from][msg.sender];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  194, 194:         if (allowed != type(uint256).max) allowance[from][msg.sender] = allowed - amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  195, 195:         require(balanceOf(from) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 196     :-        balances[from] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      196:+        balances[from] = balances[from] - amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  197, 197:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  198, 198:             balances[to] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  199, 199:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -286,7 +286,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  286, 286:         if(lastUpdated[user] == block.timestamp) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  287, 287:         uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  288, 288:         dueTokensAccrued[user] += accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 289     :-        totalDueTokensAccrued += accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      289:+        totalDueTokensAccrued = totalDueTokensAccrued + accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  290, 290:         lastUpdated[user] = block.timestamp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  291, 291:         emit Transfer(user, address(0), accrued);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  292, 292:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -357,9 +357,9 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  357, 357:     @param amount Amount of DBR to mint.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  358, 358:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  359, 359:     function _mint(address to, uint256 amount) internal virtual {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 360     :-        _totalSupply += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      360:+        _totalSupply = _totalSupply + amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  361, 361:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 362     :-            balances[to] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      362:+            balances[to] = balances[to] + amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  363, 363:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  364, 364:         emit Transfer(address(0), to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  365, 365:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -373,7 +373,7 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  373, 373:         require(balanceOf(from) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  374, 374:         balances[from] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  375, 375:         unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 376     :-            _totalSupply -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      376:+            _totalSupply = _totalSupply - amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  377, 377:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  378, 378:         emit Transfer(from, address(0), amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  379, 379:     }</span></span></span></code></pre>\n<h3 id=\"srcmarketsol395-397-535-568-598-600\" style=\"position:relative;\"><a href=\"#srcmarketsol395-397-535-568-598-600\" aria-label=\"srcmarketsol395 397 535 568 598 600 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Market.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L395\">395</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L397\">397</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L535\">535</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L568\">568</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L598\">598</a>, <a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L600\">600</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Market.sol b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 9585b85..bc0ff93 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -392,9 +392,9 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  392, 392:             require(borrowController.borrowAllowed(msg.sender, borrower, amount), &quot;Denied by borrow controller&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  393, 393:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  394, 394:         uint credit = getCreditLimitInternal(borrower);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 395     :-        debts[borrower] += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      395:+        debts[borrower] = debts[borrower] + amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  396, 396:         require(credit &gt;= debts[borrower], &quot;Exceeded credit limit&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 397     :-        totalDebt += amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      397:+        totalDebt = totalDebt + amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  398, 398:         dbr.onBorrow(borrower, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  399, 399:         dola.transfer(to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  400, 400:         emit Borrow(borrower, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -532,7 +532,7 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  532, 532:         uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  533, 533:         require(debt &gt;= amount, &quot;Insufficient debt&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  534, 534:         debts[user] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 535     :-        totalDebt -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      535:+        totalDebt = totalDebt - amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  536, 536:         dbr.onRepay(user, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  537, 537:         dola.transferFrom(msg.sender, address(this), amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  538, 538:         emit Repay(user, msg.sender, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -565,7 +565,7 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  565, 565:         debts[user] += replenishmentCost;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  566, 566:         uint collateralValue = getCollateralValueInternal(user);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  567, 567:         require(collateralValue &gt;= debts[user], &quot;Exceeded collateral value&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 568     :-        totalDebt += replenishmentCost;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      568:+        totalDebt = totalDebt + replenishmentCost;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  569, 569:         dbr.onForceReplenish(user, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  570, 570:         dola.transfer(msg.sender, replenisherReward);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  571, 571:         emit ForceReplenish(user, msg.sender, amount, replenishmentCost, replenisherReward);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -595,9 +595,9 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  595, 595:         require(repaidDebt &lt;= debt * liquidationFactorBps / 10000, &quot;Exceeded liquidation factor&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  596, 596:         uint price = oracle.getPrice(address(collateral), collateralFactorBps);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  597, 597:         uint liquidatorReward = repaidDebt * 1 ether / price;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 598     :-        liquidatorReward += liquidatorReward * liquidationIncentiveBps / 10000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      598:+        liquidatorReward = liquidatorReward + liquidatorReward * liquidationIncentiveBps / 10000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  599, 599:         debts[user] -= repaidDebt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 600     :-        totalDebt -= repaidDebt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      600:+        totalDebt = totalDebt - repaidDebt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  601, 601:         dbr.onRepay(user, repaidDebt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  602, 602:         dola.transferFrom(msg.sender, address(this), repaidDebt);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  603, 603:         IEscrow escrow = predictEscrow(user);</span></span></span></code></pre>\n<h2 id=\"10-internal-functions-only-called-once-can-be-inlined-to-save-gas-1-instance\" style=\"position:relative;\"><a href=\"#10-internal-functions-only-called-once-can-be-inlined-to-save-gas-1-instance\" aria-label=\"10 internal functions only called once can be inlined to save gas 1 instance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[10] <code>internal</code> functions only called once can be inlined to save gas (1 instance)</h2>\n<p>Deployment. Gas Saved: <strong>5 207</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>67</strong></p>\n<p>Average Method Call. Gas Saved: <strong>47</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>24</strong></p>\n<p>Overall gas change: -137 (-0.154%)</p>\n<h3 id=\"srcdbrsol341\" style=\"position:relative;\"><a href=\"#srcdbrsol341\" aria-label=\"srcdbrsol341 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L341\">341</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..a357f92 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -338,7 +338,12 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  338, 338:     @param amount Amount to be burned</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  339, 339:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  340, 340:     function burn(uint amount) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 341     :-        _burn(msg.sender, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      341:+        require(balanceOf(msg.sender) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      342:+        balances[msg.sender] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      343:+        unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      344:+            _totalSupply -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      345:+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      346:+        emit Transfer(msg.sender, address(0), amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  342, 347:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  343, 348: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  344, 349:     /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -364,20 +369,6 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  364, 369:         emit Transfer(address(0), to, amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  365, 370:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  366, 371: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 367     :-    /**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 368     :-    @notice Internal function for burning DBR.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 369     :-    @param from Address to burn DBR from.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 370     :-    @param amount Amount of DBR to be burned.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 371     :-    */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 372     :-    function _burn(address from, uint256 amount) internal virtual {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 373     :-        require(balanceOf(from) &gt;= amount, &quot;Insufficient balance&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 374     :-        balances[from] -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 375     :-        unchecked {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 376     :-            _totalSupply -= amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 377     :-        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 378     :-        emit Transfer(from, address(0), amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 379     :-    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 380     :-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  381, 372:     event Transfer(address indexed from, address indexed to, uint256 amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  382, 373:     event Approval(address indexed owner, address indexed spender, uint256 amount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  383, 374:     event AddMinter(address indexed minter);</span></span></span></code></pre>\n<h2 id=\"11-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage-2-instances\" style=\"position:relative;\"><a href=\"#11-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage-2-instances\" aria-label=\"11 state variables should be cached in stack variables rather than re reading them from storage 2 instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[11] State variables should be cached in stack variables rather than re-reading them from storage (2 instances)</h2>\n<p>Deployment. Gas Saved: <strong>5 007</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>478</strong></p>\n<p>Average Method Call. Gas Saved: <strong>1 117</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>1 423</strong></p>\n<p>Overall gas change: <strong>-6 231 (-1.618%)</strong></p>\n<h3 id=\"srcdbrsol286\" style=\"position:relative;\"><a href=\"#srcdbrsol286\" aria-label=\"srcdbrsol286 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/DBR.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/DBR.sol#L286\">286</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/DBR.sol b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index aab6daf..c70fcd7 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/DBR.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -283,8 +283,9 @@ contract DolaBorrowingRights {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  283, 283:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  284, 284:     function accrueDueTokens(address user) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  285, 285:         uint debt = debts[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 286     :-        if(lastUpdated[user] == block.timestamp) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 287     :-        uint accrued = (block.timestamp - lastUpdated[user]) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      286:+        uint _lastUpdated = lastUpdated[user];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      287:+        if(_lastUpdated == block.timestamp) return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      288:+        uint accrued = (block.timestamp - _lastUpdated) * debt / 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  288, 289:         dueTokensAccrued[user] += accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  289, 290:         totalDueTokensAccrued += accrued;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  290, 291:         lastUpdated[user] = block.timestamp;</span></span></span></code></pre>\n<h3 id=\"srcmarketsol391\" style=\"position:relative;\"><a href=\"#srcmarketsol391\" aria-label=\"srcmarketsol391 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>src/Market.sol:<a href=\"https://github.com/code-423n4/2022-10-inverse/blob/main/src/Market.sol#L391\">391</a></h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/Market.sol b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 9585b85..5f3264d 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/Market.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -388,8 +388,9 @@ contract Market {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  388, 388:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  389, 389:     function borrowInternal(address borrower, address to, uint amount) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  390, 390:         require(!borrowPaused, &quot;Borrowing is paused&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 391     :-        if(borrowController != IBorrowController(address(0))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 392     :-            require(borrowController.borrowAllowed(msg.sender, borrower, amount), &quot;Denied by borrow controller&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      391:+        IBorrowController _borrowController = borrowController;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      392:+        if(_borrowController != IBorrowController(address(0))) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+      393:+            require(_borrowController.borrowAllowed(msg.sender, borrower, amount), &quot;Denied by borrow controller&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  393, 394:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  394, 395:         uint credit = getCreditLimitInternal(borrower);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  395, 396:         debts[borrower] += amount;</span></span></span></code></pre>\n<h2 id=\"overall-gas-savings\" style=\"position:relative;\"><a href=\"#overall-gas-savings\" aria-label=\"overall gas savings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overall gas savings</h2>\n<p>Deployment. Gas Saved: <strong>416 802</strong></p>\n<p>Minimum Method Call. Gas Saved: <strong>3 423</strong></p>\n<p>Average Method Call. Gas Saved: <strong>15 773</strong></p>\n<p>Maximum Method Call. Gas Saved: <strong>18 283</strong></p>\n<p>Overall gas change: <strong>-84 866 (-67.204%)</strong></p>\n<p>Please see warden’s <a href=\"https://github.com/code-423n4/2022-10-inverse-findings/issues/368\">original submission</a> for full details and diff.</p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#medium-risk-findings-18\">Medium Risk Findings (18)</a></p>\n<ul>\n<li><a href=\"#m-01-unhandled-return-values-of-transfer-and-transferfrom\">[M-01] Unhandled return values of <code>transfer</code> and <code>transferFrom</code></a></li>\n<li><a href=\"#m-02-users-can-avoid-paying-fees-if-they-manage-to-update-their-accrued-fees-periodically\">[M-02] Users can avoid paying fees if they manage to update their accrued fees periodically</a></li>\n<li><a href=\"#m-03-user-can-borrow-dola-indefinitely-without-settling-dbr-deficit-by-keeping-their-debt-close-to-the-allowed-maximum\">[M-03] User can borrow DOLA indefinitely without settling DBR deficit by keeping their debt close to the allowed maximum</a></li>\n<li><a href=\"#m-04-erc777-reentrancy-when-withdrawing-can-be-used-to-withdraw-all-collateral\">[M-04] ERC777 reentrancy when withdrawing can be used to withdraw all collateral</a></li>\n<li><a href=\"#m-05-repay-function-can-be-dosed\">[M-05] <code>repay</code> function can be DOSed</a></li>\n<li><a href=\"#m-06-user-can-free-from-liquidation-fee-if-its-escrow-balance-is-less-than-the-calculated-liquidation-fee\">[M-06] User can free from liquidation fee if its escrow balance is less than the calculated liquidation fee</a></li>\n<li><a href=\"#m-07-oracles-two-day-feature-can-be-gamed\">[M-07] Oracle’s two-day feature can be gamed</a></li>\n<li><a href=\"#m-08-protocol-withdrawals-of-collateral-can-be-unexpectedly-locked-if-governance-sets-the-collateralfactorbps-to-0\">[M-08] Protocol withdrawals of collateral can be unexpectedly locked if governance sets the <code>collateralFactorBps</code> to 0</a></li>\n<li><a href=\"#m-09-avoidable-misconfiguration-could-lead-to-invescrow-contract-not-minting-xinv-tokens\">[M-09] Avoidable misconfiguration could lead to <code>INVEscrow</code> contract not minting <code>xINV</code> tokens</a></li>\n<li><a href=\"#m-10-liquidation-should-make-a-borrower-healthier\">[M-10] Liquidation should make a borrower <em>healthier</em></a></li>\n<li><a href=\"#m-11-viewprice-doesnt-always-report-dampened-price\">[M-11] <code>viewPrice</code> doesn’t always report dampened price</a></li>\n<li><a href=\"#m-12--users-could-get-some-dola-even-if-they-are-on-liquidation-position\">[M-12]  Users could get some <code>DOLA</code> even if they are on liquidation position</a></li>\n<li><a href=\"#m-13-marketforcereplenish-can-be-dosed\">[M-13] <code>Market::forceReplenish</code> can be DoSed</a></li>\n<li><a href=\"#m-14-two-day-low-oracle-used-in-marketliquidate-makes-the-system-highly-at-risk-in-an-oracle-attack-\">[M-14] Two day low oracle used in <code>Market.liquidate()</code> makes the system highly at risk in an oracle attack </a></li>\n<li><a href=\"#m-15-oracle-assumes-token-and-feed-decimals-will-be-limited-to-18-decimals\">[M-15] Oracle assumes token and feed decimals will be limited to 18 decimals</a></li>\n<li><a href=\"#m-16-calling-repay-function-sends-less-dola-to-market-contract-when-forcereplenish-function-is-not-called-while-it-could-be-called\">[M-16] Calling <code>repay</code> function sends less DOLA to <code>Market</code> contract when <code>forceReplenish</code> function is not called while it could be called</a></li>\n<li><a href=\"#m-17-chainlink-oracle-data-feed-is-not-sufficiently-validated-and-can-return-stale-price\">[M-17] Chainlink oracle data feed is not sufficiently validated and can return stale <code>price</code></a></li>\n<li><a href=\"#m-18-protocols-usability-becomes-very-limited-when-access-to-chainlink-oracle-data-feed-is-blocked\">[M-18] Protocol’s usability becomes very limited when access to Chainlink oracle data feed is blocked</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#01-allows-malleable-secp256k1-signatures\">01 Allows malleable <code>SECP256K1</code> signatures</a></li>\n<li><a href=\"#02-lack-of-checks-address0\">02 Lack of checks <code>address(0)</code></a></li>\n<li><a href=\"#03-avoid-using-txorigin\">03 Avoid using <code>tx.origin</code></a></li>\n<li><a href=\"#04-mixing-and-outdated-compiler\">04 Mixing and Outdated compiler</a></li>\n<li><a href=\"#05-lack-of-ack-during-owner-change\">05 Lack of ACK during owner change</a></li>\n<li><a href=\"#06-market-pause-is-not-checked-during-contraction\">06 Market pause is not checked during <code>contraction</code></a></li>\n<li><a href=\"#07-lack-of-no-reentrant-modifier\">07 Lack of no reentrant modifier</a></li>\n<li><a href=\"#08-lack-of-checks-the-integer-ranges\">08 Lack of checks the integer ranges</a></li>\n<li><a href=\"#09-lack-of-checks-supportsinterface\">09 Lack of checks <code>supportsInterface</code></a></li>\n<li><a href=\"#10-lack-of-event-emit\">10 Lack of event emit</a></li>\n<li><a href=\"#11-oracle-not-compatible-with-tokens-of-19-or-more-decimals\">11 Oracle not compatible with tokens of 19 or more decimals</a></li>\n<li><a href=\"#12-wrong-visibility\">12 Wrong visibility</a></li>\n<li><a href=\"#13-bad-nomenclature\">13 Bad nomenclature</a></li>\n<li><a href=\"#14-open-todo\">14 Open TODO</a></li>\n<li><a href=\"#15-avoid-duplicate-code\">15 Avoid duplicate code</a></li>\n<li><a href=\"#16-avoid-hardcoded-values\">16 Avoid hardcoded values</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#01-state-variables-only-set-in-the-constructor-should-be-declared-immutable-2-instances\">01 State variables only set in the constructor should be declared immutable (2 instances)</a></li>\n<li><a href=\"#02-use-function-instead-of-modifiers-4-instances\">02 Use function instead of modifiers (4 instances)</a></li>\n<li><a href=\"#03-duplicated-requirerevert-checks-should-be-refactored-to-a-modifier-or-function-instances\">03 Duplicated <code>require()</code>/<code>revert()</code> checks should be refactored to a modifier or function (instances)</a></li>\n<li><a href=\"#04-multiple-address-mappings-can-be-combined-into-a-single-mapping-of-an-address-to-a-struct-where-appropriate-5-instances\">04 Multiple address mappings can be combined into a single mapping of an address to a struct, where appropriate (5 instances)</a></li>\n<li><a href=\"#05-expression-can-be-unchecked-when-overflow-is-not-possible-6-instances\">05 Expression can be unchecked when overflow is not possible (6 instances)</a></li>\n<li><a href=\"#06-state-variables-can-be-packed-into-fewer-storage-slots-1-instance\">06 State variables can be packed into fewer storage slots (1 instance)</a></li>\n<li><a href=\"#07-refactoring-similar-statements-1-instance\">07 Refactoring similar statements (1 instance)</a></li>\n<li><a href=\"#08-better-algorithm-for-underflow-check-3-instances\">08 Better algorithm for underflow check (3 instances)</a></li>\n<li><a href=\"#09-x--x--y-is-cheaper-than-x--y-12-instances\">09 <code>x = x + y</code> is cheaper than <code>x += y</code> (12 instances)</a></li>\n<li><a href=\"#10-internal-functions-only-called-once-can-be-inlined-to-save-gas-1-instance\">10 <code>internal</code> functions only called once can be inlined to save gas (1 instance)</a></li>\n<li><a href=\"#11-state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage-2-instances\">11 State variables should be cached in stack variables rather than re-reading them from storage (2 instances)</a></li>\n<li><a href=\"#overall-gas-savings\">Overall gas savings</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}