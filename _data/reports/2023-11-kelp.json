{
  "circa": {
    "title": "Kelp DAO | rsETH",
    "sponsor": "Kelp DAO",
    "slug": "2023-11-kelp",
    "date": "2023-12-11",
    "findings": "https://github.com/code-423n4/2023-11-kelp-findings/issues",
    "contest": 305
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the Kelp DAO | rsETH smart contract system written in Solidity. The audit took place between November 10—November 15 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>194 Wardens contributed reports to the Kelp DAO | rsETH audit:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@m_Rassska\">m_Rassska</a></li>\n<li><a href=\"https://code4rena.com/@CatsSecurity\">CatsSecurity</a> (<a href=\"https://code4rena.com/@nirlin\">nirlin</a> and <a href=\"https://code4rena.com/@cats\">cats</a>)</li>\n<li><a href=\"https://code4rena.com/@adriro\">adriro</a></li>\n<li><a href=\"https://code4rena.com/@Bauchibred\">Bauchibred</a></li>\n<li><a href=\"https://code4rena.com/@PENGUN\">PENGUN</a></li>\n<li><a href=\"https://code4rena.com/@SBSecurity\">SBSecurity</a> (<a href=\"https://code4rena.com/@Slavcheww\">Slavcheww</a> and <a href=\"https://code4rena.com/@Blckhv\">Blckhv</a>)</li>\n<li><a href=\"https://code4rena.com/@deth\">deth</a></li>\n<li><a href=\"https://code4rena.com/@0xDING99YA\">0xDING99YA</a></li>\n<li><a href=\"https://code4rena.com/@jayfromthe13th\">jayfromthe13th</a></li>\n<li><a href=\"https://code4rena.com/@Aamir\">Aamir</a></li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@almurhasan\">almurhasan</a></li>\n<li><a href=\"https://code4rena.com/@d3e4\">d3e4</a></li>\n<li><a href=\"https://code4rena.com/@anarcheuz\">anarcheuz</a></li>\n<li><a href=\"https://code4rena.com/@circlelooper\">circlelooper</a></li>\n<li><a href=\"https://code4rena.com/@hals\">hals</a></li>\n<li><a href=\"https://code4rena.com/@Bauer\">Bauer</a></li>\n<li><a href=\"https://code4rena.com/@ck\">ck</a></li>\n<li><a href=\"https://code4rena.com/@Pechenite\">Pechenite</a> (<a href=\"https://code4rena.com/@Bozho\">Bozho</a> and <a href=\"https://code4rena.com/@radev_sw\">radev_sw</a>)</li>\n<li><a href=\"https://code4rena.com/@Aymen0909\">Aymen0909</a></li>\n<li><a href=\"https://code4rena.com/@0xbrett8571\">0xbrett8571</a></li>\n<li><a href=\"https://code4rena.com/@crack-the-kelp\">crack-the-kelp</a> (<a href=\"https://code4rena.com/@Parth\">Parth</a> and <a href=\"https://code4rena.com/@wildanvin\">wildanvin</a>)</li>\n<li><a href=\"https://code4rena.com/@max10afternoon\">max10afternoon</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@0xmystery\">0xmystery</a></li>\n<li><a href=\"https://code4rena.com/@glcanvas\">glcanvas</a></li>\n<li><a href=\"https://code4rena.com/@btk\">btk</a></li>\n<li><a href=\"https://code4rena.com/@ge6a\">ge6a</a></li>\n<li><a href=\"https://code4rena.com/@turvy_fuzz\">turvy_fuzz</a></li>\n<li><a href=\"https://code4rena.com/@Daniel526\">Daniel526</a></li>\n<li><a href=\"https://code4rena.com/@Shaheen\">Shaheen</a></li>\n<li><a href=\"https://code4rena.com/@0xhacksmithh\">0xhacksmithh</a></li>\n<li><a href=\"https://code4rena.com/@0xMilenov\">0xMilenov</a></li>\n<li><a href=\"https://code4rena.com/@0xVolcano\">0xVolcano</a></li>\n<li><a href=\"https://code4rena.com/@0xepley\">0xepley</a></li>\n<li><a href=\"https://code4rena.com/@T1MOH\">T1MOH</a></li>\n<li><a href=\"https://code4rena.com/@osmanozdemir1\">osmanozdemir1</a></li>\n<li><a href=\"https://code4rena.com/@zhaojie\">zhaojie</a></li>\n<li><a href=\"https://code4rena.com/@unique\">unique</a></li>\n<li><a href=\"https://code4rena.com/@ast3ros\">ast3ros</a></li>\n<li><a href=\"https://code4rena.com/@DanielArmstrong\">DanielArmstrong</a></li>\n<li><a href=\"https://code4rena.com/@sakshamguruji\">sakshamguruji</a></li>\n<li><a href=\"https://code4rena.com/@ZanyBonzy\">ZanyBonzy</a></li>\n<li><a href=\"https://code4rena.com/@albahaca\">albahaca</a></li>\n<li><a href=\"https://code4rena.com/@foxb868\">foxb868</a></li>\n<li><a href=\"https://code4rena.com/@invitedtea\">invitedtea</a></li>\n<li><a href=\"https://code4rena.com/@chaduke\">chaduke</a></li>\n<li><a href=\"https://code4rena.com/@jasonxiale\">jasonxiale</a></li>\n<li><a href=\"https://code4rena.com/@tallo\">tallo</a></li>\n<li><a href=\"https://code4rena.com/@0xffchain\">0xffchain</a></li>\n<li><a href=\"https://code4rena.com/@deepkin\">deepkin</a></li>\n<li><a href=\"https://code4rena.com/@Stormy\">Stormy</a></li>\n<li><a href=\"https://code4rena.com/@bLnk\">bLnk</a></li>\n<li><a href=\"https://code4rena.com/@roleengineer\">roleengineer</a></li>\n<li><a href=\"https://code4rena.com/@nmirchev8\">nmirchev8</a></li>\n<li><a href=\"https://code4rena.com/@rouhsamad\">rouhsamad</a></li>\n<li><a href=\"https://code4rena.com/@GREY-HAWK-REACH\">GREY-HAWK-REACH</a> (<a href=\"https://code4rena.com/@Kose\">Kose</a>, <a href=\"https://code4rena.com/@dimulski\">dimulski</a>, and <a href=\"https://code4rena.com/@aslanbek\">aslanbek</a>,<a href=\"https://code4rena.com/@Habib0x\">Habib0x</a>)</li>\n<li><a href=\"https://code4rena.com/@ayden\">ayden</a></li>\n<li><a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a></li>\n<li><a href=\"https://code4rena.com/@AlexCzm\">AlexCzm</a></li>\n<li><a href=\"https://code4rena.com/@adam-idarrha\">adam-idarrha</a></li>\n<li><a href=\"https://code4rena.com/@QiuhaoLi\">QiuhaoLi</a></li>\n<li><a href=\"https://code4rena.com/@Ruhum\">Ruhum</a></li>\n<li><a href=\"https://code4rena.com/@mahdirostami\">mahdirostami</a></li>\n<li><a href=\"https://code4rena.com/@xAriextz\">xAriextz</a></li>\n<li><a href=\"https://code4rena.com/@0x1337\">0x1337</a></li>\n<li><a href=\"https://code4rena.com/@Juntao\">Juntao</a></li>\n<li><a href=\"https://code4rena.com/@0xluckhu\">0xluckhu</a></li>\n<li><a href=\"https://code4rena.com/@cryptothemex\">cryptothemex</a></li>\n<li><a href=\"https://code4rena.com/@trachev\">trachev</a></li>\n<li><a href=\"https://code4rena.com/@deepplus\">deepplus</a></li>\n<li><a href=\"https://code4rena.com/@Weed0607\">Weed0607</a></li>\n<li><a href=\"https://code4rena.com/@Jiamin\">Jiamin</a></li>\n<li><a href=\"https://code4rena.com/@crunch\">crunch</a></li>\n<li><a href=\"https://code4rena.com/@Varun_05\">Varun_05</a></li>\n<li><a href=\"https://code4rena.com/@7siech\">7siech</a></li>\n<li><a href=\"https://code4rena.com/@0xNaN\">0xNaN</a></li>\n<li><a href=\"https://code4rena.com/@Sathish9098\">Sathish9098</a></li>\n<li><a href=\"https://code4rena.com/@ABAIKUNANBAEV\">ABAIKUNANBAEV</a></li>\n<li><a href=\"https://code4rena.com/@0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://code4rena.com/@fouzantanveer\">fouzantanveer</a></li>\n<li><a href=\"https://code4rena.com/@SAAJ\">SAAJ</a></li>\n<li><a href=\"https://code4rena.com/@clara\">clara</a></li>\n<li><a href=\"https://code4rena.com/@KeyKiril\">KeyKiril</a></li>\n<li><a href=\"https://code4rena.com/@Myd\">Myd</a></li>\n<li><a href=\"https://code4rena.com/@digitizeworx\">digitizeworx</a></li>\n<li><a href=\"https://code4rena.com/@tala7985\">tala7985</a></li>\n<li><a href=\"https://code4rena.com/@Raihan\">Raihan</a></li>\n<li><a href=\"https://code4rena.com/@0xAnah\">0xAnah</a></li>\n<li><a href=\"https://code4rena.com/@JCK\">JCK</a></li>\n<li><a href=\"https://code4rena.com/@0xhex\">0xhex</a></li>\n<li><a href=\"https://code4rena.com/@0xta\">0xta</a></li>\n<li><a href=\"https://code4rena.com/@shamsulhaq123\">shamsulhaq123</a></li>\n<li><a href=\"https://code4rena.com/@Rickard\">Rickard</a></li>\n<li><a href=\"https://code4rena.com/@rumen\">rumen</a></li>\n<li><a href=\"https://code4rena.com/@spark\">spark</a></li>\n<li><a href=\"https://code4rena.com/@Madalad\">Madalad</a></li>\n<li><a href=\"https://code4rena.com/@Phantasmagoria\">Phantasmagoria</a></li>\n<li><a href=\"https://code4rena.com/@SandNallani\">SandNallani</a></li>\n<li><a href=\"https://code4rena.com/@bronze_pickaxe\">bronze_pickaxe</a></li>\n<li><a href=\"https://code4rena.com/@zach\">zach</a></li>\n<li><a href=\"https://code4rena.com/@pep7siup\">pep7siup</a></li>\n<li><a href=\"https://code4rena.com/@twcctop\">twcctop</a></li>\n<li><a href=\"https://code4rena.com/@joaovwfreire\">joaovwfreire</a></li>\n<li><a href=\"https://code4rena.com/@TheSchnilch\">TheSchnilch</a></li>\n<li><a href=\"https://code4rena.com/@gumgumzum\">gumgumzum</a></li>\n<li><a href=\"https://code4rena.com/@0xrugpull_detector\">0xrugpull_detector</a></li>\n<li><a href=\"https://code4rena.com/@wisdomn_\">wisdomn_</a></li>\n<li><a href=\"https://code4rena.com/@ke1caM\">ke1caM</a></li>\n<li><a href=\"https://code4rena.com/@critical-or-high\">critical-or-high</a></li>\n<li><a href=\"https://code4rena.com/@ubl4nk\">ubl4nk</a></li>\n<li><a href=\"https://code4rena.com/@Krace\">Krace</a></li>\n<li><a href=\"https://code4rena.com/@peanuts\">peanuts</a></li>\n<li><a href=\"https://code4rena.com/@mahyar\">mahyar</a></li>\n<li><a href=\"https://code4rena.com/@qpzm\">qpzm</a></li>\n<li><a href=\"https://code4rena.com/@peter\">peter</a></li>\n<li><a href=\"https://code4rena.com/@SpicyMeatball\">SpicyMeatball</a></li>\n<li><a href=\"https://code4rena.com/@ptsanev\">ptsanev</a></li>\n<li><a href=\"https://code4rena.com/@Banditx0x\">Banditx0x</a></li>\n<li><a href=\"https://code4rena.com/@shealtielanz\">shealtielanz</a></li>\n<li><a href=\"https://code4rena.com/@_thanos1\">_thanos1</a></li>\n<li><a href=\"https://code4rena.com/@0xAadi\">0xAadi</a></li>\n<li><a href=\"https://code4rena.com/@phoenixV110\">phoenixV110</a></li>\n<li><a href=\"https://code4rena.com/@poneta\">poneta</a></li>\n<li><a href=\"https://code4rena.com/@0xvj\">0xvj</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@gesha17\">gesha17</a></li>\n<li><a href=\"https://code4rena.com/@Topmark\">Topmark</a></li>\n<li><a href=\"https://code4rena.com/@dipp\">dipp</a></li>\n<li><a href=\"https://code4rena.com/@adeolu\">adeolu</a></li>\n<li><a href=\"https://code4rena.com/@leegh\">leegh</a></li>\n<li><a href=\"https://code4rena.com/@cartlex_\">cartlex_</a></li>\n<li><a href=\"https://code4rena.com/@RaoulSchaffranek\">RaoulSchaffranek</a></li>\n<li><a href=\"https://code4rena.com/@Matin\">Matin</a></li>\n<li><a href=\"https://code4rena.com/@cheatc0d3\">cheatc0d3</a></li>\n<li><a href=\"https://code4rena.com/@Tumelo_Crypto\">Tumelo_Crypto</a></li>\n<li><a href=\"https://code4rena.com/@Yanchuan\">Yanchuan</a></li>\n<li><a href=\"https://code4rena.com/@0xHelium\">0xHelium</a></li>\n<li><a href=\"https://code4rena.com/@Amithuddar\">Amithuddar</a></li>\n<li><a href=\"https://code4rena.com/@Inspecktor\">Inspecktor</a></li>\n<li><a href=\"https://code4rena.com/@0xblackskull\">0xblackskull</a></li>\n<li><a href=\"https://code4rena.com/@0xLeveler\">0xLeveler</a></li>\n<li><a href=\"https://code4rena.com/@baice\">baice</a></li>\n<li><a href=\"https://code4rena.com/@niser93\">niser93</a></li>\n<li><a href=\"https://code4rena.com/@ro1sharkm\">ro1sharkm</a></li>\n<li><a href=\"https://code4rena.com/@hihen\">hihen</a></li>\n<li><a href=\"https://code4rena.com/@McToady\">McToady</a></li>\n<li><a href=\"https://code4rena.com/@bareli\">bareli</a></li>\n<li><a href=\"https://code4rena.com/@eeshenggoh\">eeshenggoh</a></li>\n<li><a href=\"https://code4rena.com/@seerether\">seerether</a></li>\n<li><a href=\"https://code4rena.com/@Soul22\">Soul22</a></li>\n<li><a href=\"https://code4rena.com/@AerialRaider\">AerialRaider</a></li>\n<li><a href=\"https://code4rena.com/@Cryptor\">Cryptor</a></li>\n<li><a href=\"https://code4rena.com/@boredpukar\">boredpukar</a></li>\n<li><a href=\"https://code4rena.com/@TeamSS\">TeamSS</a> (<a href=\"https://code4rena.com/@0xSimeon\">0xSimeon</a> and <a href=\"https://code4rena.com/@0xsagetony\">0xsagetony</a>)</li>\n<li><a href=\"https://code4rena.com/@alexfilippov314\">alexfilippov314</a></li>\n<li><a href=\"https://code4rena.com/@Draiakoo\">Draiakoo</a></li>\n<li><a href=\"https://code4rena.com/@amaechieth\">amaechieth</a></li>\n<li><a href=\"https://code4rena.com/@squeaky_cactus\">squeaky_cactus</a></li>\n<li><a href=\"https://code4rena.com/@King_\">King_</a></li>\n<li><a href=\"https://code4rena.com/@MatricksDeCoder\">MatricksDeCoder</a></li>\n<li><a href=\"https://code4rena.com/@Noro\">Noro</a></li>\n<li><a href=\"https://code4rena.com/@paritomarrr\">paritomarrr</a></li>\n<li><a href=\"https://code4rena.com/@soliditytaker\">soliditytaker</a></li>\n<li><a href=\"https://code4rena.com/@ziyou-\">ziyou-</a></li>\n<li><a href=\"https://code4rena.com/@codynhat\">codynhat</a></li>\n<li><a href=\"https://code4rena.com/@passion\">passion</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@supersizer0x\">supersizer0x</a></li>\n<li><a href=\"https://code4rena.com/@stackachu\">stackachu</a></li>\n<li><a href=\"https://code4rena.com/@evmboi32\">evmboi32</a></li>\n<li><a href=\"https://code4rena.com/@taner2344\">taner2344</a></li>\n<li><a href=\"https://code4rena.com/@marchev\">marchev</a></li>\n<li><a href=\"https://code4rena.com/@Stormreckson\">Stormreckson</a></li>\n<li><a href=\"https://code4rena.com/@Eigenvectors\">Eigenvectors</a> (<a href=\"https://code4rena.com/@Cosine\">Cosine</a> and <a href=\"https://code4rena.com/@timo\">timo</a>)</li>\n<li><a href=\"https://code4rena.com/@ElCid\">ElCid</a></li>\n<li><a href=\"https://code4rena.com/@desaperh\">desaperh</a></li>\n<li><a href=\"https://code4rena.com/@debo\">debo</a></li>\n<li><a href=\"https://code4rena.com/@merlinboii\">merlinboii</a></li>\n<li><a href=\"https://code4rena.com/@pipidu83\">pipidu83</a></li>\n<li><a href=\"https://code4rena.com/@LinKenji\">LinKenji</a></li>\n<li><a href=\"https://code4rena.com/@zhaojohnson\">zhaojohnson</a></li>\n<li><a href=\"https://code4rena.com/@MaslarovK\">MaslarovK</a></li>\n<li><a href=\"https://code4rena.com/@Tadev\">Tadev</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@0xDjango\">0xDjango</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 5 unique vulnerabilities. Of these vulnerabilities, 3 received a risk rating in the category of HIGH severity and 2 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 125 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 16 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-11-kelp\">C4 Kelp DAO | rsETH repository</a>, and is composed of 10 smart contracts written in the Solidity programming language and includes 498 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>Hound</strong> from warden DadeKuma, generated the <a href=\"https://gist.github.com/code423n4/12695ad1ff625d86046b7f5b78e6dda5\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-3\" style=\"position:relative;\"><a href=\"#high-risk-findings-3\" aria-label=\"high risk findings 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (3)</h1>\n<h2 id=\"h-01-possible-arbitrage-from-chainlink-price-discrepancy-\" style=\"position:relative;\"><a href=\"#h-01-possible-arbitrage-from-chainlink-price-discrepancy-\" aria-label=\"h 01 possible arbitrage from chainlink price discrepancy  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/584\">[H-01] Possible arbitrage from Chainlink price discrepancy </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/584\">m_Rassska</a>, also found by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/894\">SBSecurity</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/865\">Aamir</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/858\">d3e4</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/828\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/687\">CatsSecurity</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/678\">jayfromthe13th</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/609\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/516\">deth</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/443\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/300\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/284\">almurhasan</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/191\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/869\">anarcheuz</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/311\">circlelooper</a></em></p>\n<h3 id=\"some-theory-needed\" style=\"position:relative;\"><a href=\"#some-theory-needed\" aria-label=\"some theory needed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Some theory needed</h3>\n<ul>\n<li>Currently KelpDAO relies on the following chainlink price feeds in order to calculate rsETH/ETH exchange rate:</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"center\"><strong>Price Feed</strong></th>\n<th align=\"center\"><strong>Deviation</strong></th>\n<th align=\"center\"><strong>Heartbeat</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>1</strong></td>\n<td align=\"center\">rETH/ETH</td>\n<td align=\"center\">2%</td>\n<td align=\"center\">86400s</td>\n</tr>\n<tr>\n<td><strong>2</strong></td>\n<td align=\"center\">cbETH/ETH</td>\n<td align=\"center\">1%</td>\n<td align=\"center\">86400s</td>\n</tr>\n<tr>\n<td><strong>3</strong></td>\n<td align=\"center\">stETH/ETH</td>\n<td align=\"center\">0.5%</td>\n<td align=\"center\">86400s</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>As we can see, an acceptable deviation for rETH/ETH price feed is about <code>[-2% 2%]</code>, meaning that the nodes will not update an on-chain price, in case the boundaries are not reached within the 24h period. These deviations are significant enough to open an arbitrage opportunities which will impact an overall rsETH/ETH exchange rate badly.</li>\n<li>For a further analysis we have to look at the current LSD market distribution, which is represented here:</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"center\"><strong>LSD</strong></th>\n<th align=\"center\"><strong>Staked ETH</strong></th>\n<th align=\"center\"><strong>Market Share</strong></th>\n<th><strong>LRTDepositPool ratio</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>1</strong></td>\n<td align=\"center\">Lido</td>\n<td align=\"center\">8.95m</td>\n<td align=\"center\">~77.35%</td>\n<td>~88.17%</td>\n</tr>\n<tr>\n<td><strong>2</strong></td>\n<td align=\"center\">Rocket Pool</td>\n<td align=\"center\">1.01m</td>\n<td align=\"center\">~8.76%</td>\n<td>~9.95%</td>\n</tr>\n<tr>\n<td><strong>3</strong></td>\n<td align=\"center\">Coinbase</td>\n<td align=\"center\">190.549</td>\n<td align=\"center\">~1.65%</td>\n<td>~1.88%</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>Where <code>LRTDepositPool ratio</code> is an approximate ratio of deposited lsts based on the overall LSD market.</li>\n</ul>\n<h3 id=\"an-example-of-profitable-arbitrage\" style=\"position:relative;\"><a href=\"#an-example-of-profitable-arbitrage\" aria-label=\"an example of profitable arbitrage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An example of profitable arbitrage</h3>\n<p>See <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/584\">original submission</a> for full details.</p>\n<h3 id=\"final-words\" style=\"position:relative;\"><a href=\"#final-words\" aria-label=\"final words permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final words</h3>\n<p>Basically, price feeds don’t have to reach those extreme boundaries in order to profit from it. In theory presented above we were able to get +2.3% profit, which is significant in case there is a huge liquidity supplied. The combination of deviations might be absolutely random, since it operates in set of rational numbers. But it will constantly open a small [+1%; +1.5%] arbitrage opportunities to be exploited.</p>\n<h3 id=\"proof-on-concept\" style=\"position:relative;\"><a href=\"#proof-on-concept\" aria-label=\"proof on concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof on Concept</h3>\n<details>\n<ul>\n<li>\n<p>To reproduce the case described above, slightly change:</p>\n<ul>\n<li>\n<p><code>LRTOracleMock</code>:</p>\n<ul>\n<li>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">LRTOracleMock</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">submitNewAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newPrice</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_newPrice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n</ul>\n</li>\n<li>\n<p><code>setUp()</code>:</p>\n<ul>\n<li>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">LRTDepositPoolTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BaseTest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">RSETHTest</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LRTDepositPool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\">(</span><span class=\"mtk12\">RSETHTest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">BaseTest</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// deploy LRTDepositPool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ProxyAdmin</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxyAdmin</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ProxyAdmin</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">LRTDepositPool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractImpl</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">LRTDepositPool</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">TransparentUpgradeableProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractProxy</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TransparentUpgradeableProxy</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractImpl</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxyAdmin</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk8\">&quot;&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">LRTDepositPool</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractProxy</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// initialize RSETH. LRTCOnfig is already initialized in RSETHTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rseth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// add rsETH to LRT config</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setRSETH</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rseth</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// add oracle to LRT config</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_ORACLE</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">LRTOracle</span><span class=\"mtk1\">()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_DEPOSIT_POOL</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">LRTOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_ORACLE</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// add minter role for rseth to lrtDepositPool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rseth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">grantRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rseth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">MINTER_ROLE</span><span class=\"mtk1\">(), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n</ul>\n</li>\n<li>\n<p><code>test_DepositAsset()</code>:</p>\n<ul>\n<li>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">test_DepositAsset</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rETHPriceOracle</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1.09149e18</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stETHPriceOracle</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0.99891e18</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cbETHPriceOracle</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1.05407e18</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">LRTOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_ORACLE</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">updatePriceOracleFor</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETH</span><span class=\"mtk1\">), </span><span class=\"mtk12\">rETHPriceOracle</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">LRTOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_ORACLE</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">updatePriceOracleFor</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stETH</span><span class=\"mtk1\">), </span><span class=\"mtk12\">stETHPriceOracle</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">LRTOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_ORACLE</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">updatePriceOracleFor</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cbETH</span><span class=\"mtk1\">), </span><span class=\"mtk12\">cbETHPriceOracle</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;rETH/ETH exchange rate after&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;stETH/ETH exchange rate after&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;cbETH/ETH exchange rate after&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cbETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// alice provides huge amount of liquidity to the pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">), </span><span class=\"mtk7\">9950</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETHAddress</span><span class=\"mtk1\">, </span><span class=\"mtk7\">9950</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">stETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">), </span><span class=\"mtk7\">88170</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositAsset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stETH</span><span class=\"mtk1\">), </span><span class=\"mtk7\">88170</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">cbETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1880</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositAsset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cbETH</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1880</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">carol</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// carol deposits, when the price feeds return answer pretty close to a spot price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">carolBalanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rseth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">carol</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">), </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositAsset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETH</span><span class=\"mtk1\">), </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">carolBalanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rseth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">carol</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rETHNewPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) * </span><span class=\"mtk7\">102</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// +2%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stETHNewPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) * </span><span class=\"mtk7\">995</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// -0.5%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cbETHNewPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cbETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))) * </span><span class=\"mtk7\">99</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// -1%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">submitNewAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETHNewPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">submitNewAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stETHNewPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cbETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">submitNewAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cbETHNewPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;rETH/ETH exchange rate after&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;stETH/ETH exchange rate after&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;cbETH/ETH exchange rate after&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">LRTOracleMock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cbETHPriceOracle</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// bob balance of rsETH before deposit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bobBalanceBefore</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rseth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">rETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">), </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositAsset</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rETH</span><span class=\"mtk1\">), </span><span class=\"mtk7\">100</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bobBalanceAfter</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rseth</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bobBalanceBefore</span><span class=\"mtk1\">, </span><span class=\"mtk12\">carolBalanceBefore</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;the balances are not the same&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">assertGt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bobBalanceAfter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">carolBalanceAfter</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">102</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;some random shit happened&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">assertLt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bobBalanceAfter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">carolBalanceAfter</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">103</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;some random shittttt happened&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</details>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><strong>Short term:</strong></p>\n<ul>\n<li>N/A</li>\n</ul>\n<p><strong>Long term:</strong></p>\n<ul>\n<li>I was thinking about utilizing multiple price oracles, which could potentially close any profitable opportunities, but the gas overhead and overall complexity grows rapidly. Unfortunately, I don’t have anything robust to offer by now, but open to discuss about it.</li>\n</ul>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Math</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/584#issuecomment-1825309294\">gus (Kelp) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>We appreciate the explanation at length you have here. We see the arbitrage as a feature rather than a bug in the system. The past 2 year data on the price discrepancy assures us that this is a minor vector that will not impact deposits or withdraws significantly. Moreover, the fact that minters earn nominally more and withdrawals earn nominally less balances the system. We also want to call out that price arbitrage is not a unique problem to our design. It is virtually present across every staking protocol and we encourage healthy arbitrage opportunity here.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/584#issuecomment-1847574552\">0xDjango (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is valid. Depositors will be able to deposit the minimally-priced asset and steal value from the deposit pool. The deviation % and heartbeat are too large and this will open up arbitrage opportunities to the detriment of Kelp’s users. When Kelp implements the withdrawal mechanism, we will have a better understanding of the profitability of such an attack. For example, if Kelp implements withdrawals without a staking delay, given the large amount of on-chain liquidity of the underlying assets, the pool may be able to be exploited for large amounts given even a 1% price discrepancy between the different LSTs.</p>\n</blockquote>\n<p><em>Note: see <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/584\">original submission</a> for full discussion.</em></p>\n<hr>\n<h2 id=\"h-02-protocol-mints-less-rseth-on-deposit-than-intended\" style=\"position:relative;\"><a href=\"#h-02-protocol-mints-less-rseth-on-deposit-than-intended\" aria-label=\"h 02 protocol mints less rseth on deposit than intended permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/62\">[H-02] Protocol mints less rsETH on deposit than intended</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/62\">T1MOH</a>, also found by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/863\">0xepley</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/860\">SBSecurity</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/853\">cryptothemex</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/817\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/777\">AlexCzm</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/765\">trachev</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/761\">adam-idarrha</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/694\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/672\">deepplus</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/636\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/594\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/549\">Weed0607</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/542\">DanielArmstrong</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/540\">rouhsamad</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/524\">osmanozdemir1</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/503\">GREY-HAWK-REACH</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/490\">0x1337</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/455\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/449\">Jiamin</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/427\">crunch</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/402\">Varun_05</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/379\">7siech</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/344\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/312\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/291\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/275\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/274\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/256\">Aamir</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/200\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/181\">max10afternoon</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/175\">crack-the-kelp</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/173\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/164\">0xluckhu</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/105\">0xNaN</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/98\">mahdirostami</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/95\">0xmystery</a></em></p>\n<p>Price of rsETH is calculated as <code>totalLockedETH / rsETHSupply</code>. rsETH price is used to calculate rsETH amount to mint when user deposits. Formulas are following:</p>\n<ul>\n<li><code>rsethAmountToMint = amount * assetPrice / rsEthPrice</code></li>\n<li><code>rsEthPrice = totalEthLocked / rsETHSupply</code></li>\n</ul>\n<p>Problem is that it transfers deposit amount before calculation of <code>rsethAmountToMint</code>. It increases <code>totalEthLocked</code>. As a result rsethAmountToMint is less than intended because rsEthPrice is higher.</p>\n<p>For example:</p>\n<ol>\n<li>Suppose <code>totalEthLocked</code> = 10e18, assetPrice = 1e18, rsETHSupply = 10e18</li>\n<li>User deposits 30e18. He expects to receive 30e18 rsETH</li>\n<li>However actual received amount will be <code>30e18 * 1e18 / ((30e18 * 1e18 + 10e18 * 1e18) / 10e18) = 7.5e18</code></li>\n</ol>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Here you can see that it firstly transfers asset to <code>address(this)</code>, then calculates amount to mint:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">depositAsset</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">depositAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">whenNotPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlySupportedAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TokenTransferFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// interactions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsethAmountMinted</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_mintRsETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AssetDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rsethAmountMinted</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>There is long chain of calls:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">_mintRsETH</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">getRsETHAmountToMint</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">LRTOracle</span><span class=\"mtk1\">().</span><span class=\"mtk11\">getRSETHPrice</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">getTotalAssetDeposits</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">getTotalAssetDeposits</span><span class=\"mtk1\">()</span></span></span></code></pre>\n<p>Finally <code>getTotalAssetDeposits()</code> uses current <code>balanceOf()</code>, which was increased before by transferring deposit amount:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getAssetDistributionData</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlySupportedAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetLyingInDepositPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetLyingInNDCs</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetStakedInEigenLayer</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Question: is here the right place to have this? Could it be in LRTConfig?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@&gt;      </span><span class=\"mtk12\">assetLyingInDepositPool</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ndcsCount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">ndcsCount</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">assetLyingInNDCs</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">assetStakedInEigenLayer</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">INodeDelegator</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">getAssetBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Transfer tokens in the end:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function depositAsset(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address asset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 depositAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        whenNotPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        onlySupportedAsset(asset)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       uint256 rsethAmountMinted = _mintRsETH(asset, depositAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (!IERC20(asset).transferFrom(msg.sender, address(this), depositAmount)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            revert TokenTransferFailed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       // interactions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       uint256 rsethAmountMinted = _mintRsETH(asset, depositAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        emit AssetDeposit(asset, depositAmount, rsethAmountMinted);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Oracle</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/62#issuecomment-1813278876\">RaymondFam (lookout) commented</a>:</strong></p>\n<blockquote>\n<p>This vulnerability is worse than a donation attack.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/62#issuecomment-1850480282\">gus (Kelp) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>This is a legitimate issue and has been fixed in commit 3b4e36c740013b32b78e93b00438b25f848e5f76 to separately have rsETH price calculators and read value from state variables, which also helped reduce gas cost to a great extent as well. We thank the warden for alerting us to this issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/62#issuecomment-1838891636\">0xDjango (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is a High severity issue. The miscalculation causes direct fund loss to users.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-the-price-of-rseth-could-be-manipulated-by-the-first-staker\" style=\"position:relative;\"><a href=\"#h-03-the-price-of-rseth-could-be-manipulated-by-the-first-staker\" aria-label=\"h 03 the price of rseth could be manipulated by the first staker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/42\">[H-03] The price of rsETH could be manipulated by the first staker</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/42\">Krace</a>, also found by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/855\">SBSecurity</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/842\">spark</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/819\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/811\">Madalad</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/751\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/733\">adam-idarrha</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/727\">Phantasmagoria</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/698\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/676\">CatsSecurity</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/666\">SandNallani</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/658\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/631\">AlexCzm</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/621\">deth</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/601\">bronze_pickaxe</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/598\">osmanozdemir1</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/595\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/588\">zach</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/582\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/570\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/559\">mahyar</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/557\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/547\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/532\">ck</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/528\">joaovwfreire</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/511\">GREY-HAWK-REACH</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/451\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/441\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/430\">qpzm</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/377\">TheSchnilch</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/353\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/330\">QiuhaoLi</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/305\">0xrugpull_detector</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/297\">Aamir</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/286\">almurhasan</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/281\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/264\">wisdomn_</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/257\">peter</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/241\">max10afternoon</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/219\">rouhsamad</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/218\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/204\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/203\">crack-the-kelp</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/174\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/172\">ke1caM</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/118\">ptsanev</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/99\">mahdirostami</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/85\">Banditx0x</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/78\">critical-or-high</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/60\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/53\">ubl4nk</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/45\">Bauer</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/788\">btk</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L95-L110\">https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L95-L110</a><br>\n<a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTOracle.sol#L52-L79\">https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTOracle.sol#L52-L79</a></p>\n<p>The first staker can potentially manipulate the price of rsETH through a donation attack, causing subsequent stakers to receive no rsETH after depositing. The first staker can exploit this method to siphon funds from other users.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The mining amount of rsETH is calculated in function <code>getRsETHAmountToMint</code> which directly utilizes the total value of the asset divided by the price of a single rsETH.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getRsETHAmountToMint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsethAmountToMint</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// setup oracle contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lrtOracleAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_ORACLE</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ILRTOracle</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lrtOracle</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ILRTOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtOracleAddress</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// calculate rseth amount to mint based on asset amount and asset exchange rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rsethAmountToMint</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">lrtOracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)) / </span><span class=\"mtk12\">lrtOracle</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getRSETHPrice</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Subsequently, the price of rsETH is related to its totalSupply and the total value of deposited assets.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getRSETHPrice</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsETHPrice</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsETHTokenAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">rsETH</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rsEthSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IRSETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rsETHTokenAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">rsEthSupply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalETHInPool</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lrtDepositPoolAddr</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_DEPOSIT_POOL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supportedAssets</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getSupportedAssetList</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supportedAssetCount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">supportedAssets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint16</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset_idx</span><span class=\"mtk1\">; </span><span class=\"mtk12\">asset_idx</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">supportedAssetCount</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">supportedAssets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset_idx</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetER</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getAssetPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalAssetAmt</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ILRTDepositPool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPoolAddr</span><span class=\"mtk1\">).</span><span class=\"mtk11\">getTotalAssetDeposits</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">totalETHInPool</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">totalAssetAmt</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">assetER</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ++</span><span class=\"mtk12\">asset_idx</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//@audit the price of rsETH is calculated based on the asset and totalSupply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalETHInPool</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">rsEthSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The total value of deposited assets comprises three parts: the assets in <code>LRTDepositPool</code>, the assets in <code>NodeDelagator</code>, and the assets in the eigenlayer. Anyone can directly contribute asset tokens to <code>LRTDepositPool</code> or <code>NodeDelegator</code> to augment the total value of deposited assets.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getAssetDistributionData</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlySupportedAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetLyingInDepositPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetLyingInNDCs</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assetStakedInEigenLayer</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Question: is here the right place to have this? Could it be in LRTConfig?</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assetLyingInDepositPool</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ndcsCount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">ndcsCount</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">assetLyingInNDCs</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">assetStakedInEigenLayer</span><span class=\"mtk1\"> += </span><span class=\"mtk11\">INodeDelegator</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">getAssetBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"case\" style=\"position:relative;\"><a href=\"#case\" aria-label=\"case permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Case</h3>\n<p>Therefore, the price of rsETH is susceptible to manipulation by the first staker, considering the following scenario:</p>\n<ul>\n<li>Alice is the first staker and she deposits 1 USDC (the price of USDC is set to $1), she will get 1 wei rsETH, and the totalSupply of rsETH is 1 wei. </li>\n</ul>\n<p>Here is the test, add it to <code>test/LRTDepositPoolTest.t.sol</code> and run with <code>forge test --match-test test_ControlPrice -vv</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/LRTDepositPoolTest.t.sol b/test/LRTDepositPoolTest.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 40abc93..63349c2 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/LRTDepositPoolTest.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/LRTDepositPoolTest.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -9,10 +9,11 @@ import { ILRTDepositPool } from &quot;src/interfaces/ILRTDepositPool.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { TransparentUpgradeableProxy } from &quot;@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> import { ProxyAdmin } from &quot;@openzeppelin/contracts/proxy/transparent/ProxyAdmin.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+import &quot;forge-std/console.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract LRTOracleMock {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function getAssetPrice(address) external pure returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return 1e18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function getRSETHPrice() external pure returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -109,6 +110,23 @@ contract LRTDepositPoolDepositAsset is LRTDepositPoolTest {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         lrtDepositPool.depositAsset(rETHAddress, 2 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function test_ControlPrice() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.startPrank(alice);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // alice balance of rsETH before deposit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 aliceBalanceBefore = rseth.balanceOf(address(alice));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        rETH.approve(address(lrtDepositPool), 1 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        lrtDepositPool.depositAsset(rETHAddress, 1 ether);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        // alice balance of rsETH after deposit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 aliceBalanceAfter = rseth.balanceOf(address(alice));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        vm.stopPrank();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        console.log(&quot; rsETH of Alice: &quot;, aliceBalanceAfter - aliceBalanceBefore);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function test_DepositAsset() external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         vm.startPrank(alice);</span></span></span></code></pre>\n<ul>\n<li>Alice donates 10000 USDC to the <code>LRTDepositPool</code> to inflate the price of rsETH. Now the price of rsETH is: (10000 + 1)ether / 1 wei = 10001 ether</li>\n<li>Any subsequent staker who deposits assets worth less than 10001 USDC will not receive any rsETH, and they won’t be able to withdraw the deposited assets either. Alice can directly siphon off these funds.</li>\n</ul>\n<p>For example, if Bob deposit 10000 USDC, then the <code>rsethAmountToMint</code> is <code>(10000 ether * 1) / (10001)ether = 0</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">rsethAmountToMint = (amount * lrtOracle.getAssetPrice(asset)) / lrtOracle.getRSETHPrice();</span></span></code></pre>\n<p>Moreover, there is no check on the actual amount of rsETH received by the user, and the execution continues even if this amount is zero.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _mintRsETH(address _asset, uint256 _amount) private returns (uint256 rsethAmountToMint) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (rsethAmountToMint) = getRsETHAmountToMint(_asset, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address rsethToken = lrtConfig.rsETH();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // mint rseth for user</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //@audit sender could receive 0 token</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IRSETH(rsethToken).mint(msg.sender, rsethAmountToMint);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It is recommended to pre-mint some rsETH tokens to prevent price manipulation or ensure that the <code>rsethAmountToMint</code> is greater than zero.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/42#issuecomment-1825350085\">gus (Kelp) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>We agree this is an issue. We also agree that it should be of a MEDIUM severity as it is an edge case that happens on the first protocol interaction.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/42#issuecomment-1825451322\">manoj9april (Kelp) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/42#issuecomment-1836453373\">0xDjango (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Judging as HIGH. While it is an edge case, the potential loss of funds is present. Vault donation attacks have been judged as high in the majority of C4 audits where no safeguards are implemented.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/42#issuecomment-1837395661\">manoj9april (Kelp) commented</a>:</strong></p>\n<blockquote>\n<p>Initial minting is a way of mitigating this issue. And this mitigation could be done after deployment. Hence no safeguard were added in contract. Hence request to decrease to medium.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/42#issuecomment-1838882957\">0xDjango (judge) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p><em>Initial minting is a way of mitigating this issue. And this mitigation could be done after deployment. Hence no safeguard were added in contract. Hence request to decrease to medium.</em></p>\n</blockquote>\n<p>Based on the implementation, this issue will remain HIGH. Funds are at risk until Kelp takes subsequent action to mitigate.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/62#issuecomment-1850480282\">gus (Kelp) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We disagree with the severity of this issue. Every protocol has to setup the contracts first before publicizing that contracts are ready for public usage. We take measures to ensure the exchange rate is closer to 1 before users interact with contracts.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-2\" style=\"position:relative;\"><a href=\"#medium-risk-findings-2\" aria-label=\"medium risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (2)</h1>\n<h2 id=\"m-01-update-in-strategy-will-cause-wrong-issuance-of-shares\" style=\"position:relative;\"><a href=\"#m-01-update-in-strategy-will-cause-wrong-issuance-of-shares\" aria-label=\"m 01 update in strategy will cause wrong issuance of shares permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/197\">[M-01] Update in strategy will cause wrong issuance of shares</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/197\">crack-the-kelp</a>, also found by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/198\">crack-the-kelp</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/893\">osmanozdemir1</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/833\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/821\">tallo</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/818\">0xffchain</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/797\">Stormy</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/775\">jayfromthe13th</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/688\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/649\">bLnk</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/644\">Pechenite</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/638\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/620\">roleengineer</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/596\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/564\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/518\">deth</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/513\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/487\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/454\">0xDING99YA</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/426\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/419\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/398\">deepkin</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/339\">DanielArmstrong</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/334\">nmirchev8</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTOracle.sol#L70\">https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTOracle.sol#L70</a><br>\n<a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L49\">https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L49</a><br>\n<a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L84\">https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L84</a><br>\n<a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/NodeDelegator.sol#L122-L123\">https://github.com/code-423n4/2023-11-kelp/blob/main/src/NodeDelegator.sol#L122-L123</a></p>\n<p>If there is update in strategy, <code>getTotalAssetDeposits(asset)</code> will reduce for asset. Because it checks for the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L84\">assets deposited in NodeDelegator</a>. NodeDelegator.getAssetBalance() will check for asset balance for the strategy of the user. If strategy is updated, then the balance of old strategy won’t be taken into account which will reduce the totalDeposits. This will reduce the rsETH share price and cause more rsETH shares to be minted for the depositors. Thus, depositors can immediately deposit and their shares are worth more than their deposit.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contract LRTDepositPoolTest is BaseTest, RSETHTest {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    LRTDepositPool public lrtDepositPool;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    LRTOracle public lrtOracle;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    NodeDelegator public nodeDelegator;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ILRTConfig public ilrtConfig;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    MockEigenStrategyManager public mockEigenStraregyManager;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    MockStrategy public mockStrategy1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    MockStrategy public mockStrategy2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setUp() public virtual override(RSETHTest, BaseTest) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        super.setUp();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // deploy LRTDepositPool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ProxyAdmin proxyAdmin = new ProxyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LRTDepositPool contractImpl = new LRTDepositPool();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TransparentUpgradeableProxy contractProxy = new TransparentUpgradeableProxy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(contractImpl),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(proxyAdmin),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool = LRTDepositPool(address(contractProxy));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //deploy rsETH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        proxyAdmin = new ProxyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        RSETH tokenImpl = new RSETH();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TransparentUpgradeableProxy tokenProxy = new TransparentUpgradeableProxy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(tokenImpl),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(proxyAdmin),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rseth = RSETH(address(tokenProxy));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //deploy lrtConfig</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        proxyAdmin = new ProxyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LRTConfig lrtConfigImpl = new LRTConfig();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TransparentUpgradeableProxy lrtConfigProxy = new TransparentUpgradeableProxy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(lrtConfigImpl),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(proxyAdmin),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig = LRTConfig(address(lrtConfigProxy));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // initialize RSETH. LRTCOnfig is already initialized in RSETHTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // rseth.initialize(address(admin), address(lrtConfig));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // add rsETH to LRT config</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // lrtConfig.setRSETH(address(rseth));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // add oracle to LRT config</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // deploy LRTOracle</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ProxyAdmin proxyAdmin1 = new ProxyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtOracle = new LRTOracle();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TransparentUpgradeableProxy contractProxy1 = new TransparentUpgradeableProxy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(lrtOracle),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(proxyAdmin1),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtOracle = LRTOracle(address(contractProxy1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // deploy NodeDelegator</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        proxyAdmin1 = new ProxyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        nodeDelegator = new NodeDelegator();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        contractProxy1 = new TransparentUpgradeableProxy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(nodeDelegator),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(proxyAdmin1),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        nodeDelegator = NodeDelegator(address(contractProxy1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.initialize(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            admin,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(stETH),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(rETH),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(cbETH),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(rseth)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rseth.initialize(admin, address(lrtConfig));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtOracle.initialize(address(lrtConfig));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        nodeDelegator.initialize(address(lrtConfig));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool.initialize(address(lrtConfig));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mockEigenStraregyManager = new MockEigenStrategyManager();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mockStrategy1 = new MockStrategy(address(stETH), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mockStrategy2 = new MockStrategy(address(stETH), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(admin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.setContract(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            keccak256(&quot;LRT_DEPOSIT_POOL&quot;),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(lrtDepositPool)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.setContract(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            keccak256(&quot;EIGEN_STRATEGY_MANAGER&quot;),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(mockEigenStraregyManager)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.grantRole(keccak256(&quot;MANAGER&quot;), manager);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.setRSETH(address(rseth));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(manager);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtOracle.updatePriceOracleFor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(stETH),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(new LRTOracleMock())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtOracle.updatePriceOracleFor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(rETH),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(new LRTOracleMock())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtOracle.updatePriceOracleFor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(cbETH),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(new LRTOracleMock())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // lrtConfig.addNewSupportedAsset(address(randomToken), 100_000 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // lrtOracle.updatePriceOracleFor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //     address(randomToken),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //     address(new LRTOracleMock())</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(admin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.updateAssetStrategy(address(stETH), address(mockStrategy1));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.setContract(LRTConstants.LRT_ORACLE, address(lrtOracle));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // add minter role for rseth to lrtDepositPool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rseth.grantRole(rseth.MINTER_ROLE(), address(lrtDepositPool));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address[] memory nodeDelegatorContracts = new address[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        nodeDelegatorContracts[0] = address(nodeDelegator);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool.addNodeDelegatorContractToQueue(nodeDelegatorContracts);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function test_update_strategy_cause_wrong_minting_of_shares() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //NOTE: comment line 207-211 in setup for this</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(admin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.grantRole(LRTConstants.MANAGER, manager);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stETH.approve(address(lrtDepositPool), 10 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool.depositAsset(address(stETH), 10 ether); //NOTE: 10000000000000000000 rsETH amount minted</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(manager);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool.transferAssetToNodeDelegator(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(stETH),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            10 ether</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(admin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.updateAssetStrategy(address(stETH), address(mockStrategy2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.updateAssetStrategy(address(rETH), address(mockStrategy2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.updateAssetStrategy(address(cbETH), address(mockStrategy2));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stETH.approve(address(lrtDepositPool), 10 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool.depositAsset(address(stETH), 10 ether); //NOTE:   2500000000000000000 rsETH amount minted even after fixing deposit bug</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>While updating the strategy, ensure that balance deposited in previous strategy for same asset is accounted while minting the shares.</p>\n<h3 id=\"assessed-type-2\" style=\"position:relative;\"><a href=\"#assessed-type-2\" aria-label=\"assessed type 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>ERC4626</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/197#issuecomment-1825335776\">gus (Kelp) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>The Eigenlayer has a 1-1 mapping for asset and its strategy.  We don’t believe this an issue with KelpDAO or its code but with Eigenlayer if it upgrades its protocol to have multiple strategies for an asset.  Then if this occurs, KelpDAO will also have to upgrade its contracts to ensure the compatibility to Eigenlayer.<br>\nAlso, if Eigenlayer changes strategies, they are responsible to migrate the internal accounting to the new address. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/197#issuecomment-1833168052\">manoj9april (Kelp) commented</a>:</strong></p>\n<blockquote>\n<p>Currently Eigenlayer’s implementation allows them to have multiple startegies for any asset.<br>\n-> But we can continue to deposit into one strategy for a asset and it won’t be a problem for us. That is assuming 1:1 mapping won’t harm us.</p>\n<p>Above assumptions will only create problem in case, Eigenlayer wants to spread the current funds into multiple strategies for any asset in future upgrades. And in this case, they will provide proper heads up ahead of time and we can upgrade along with them accordingly.</p>\n<p>In case they change their strategy for any asset, we can point to new strategy address and it should work fine. And in this case Eigenlayer should should take care of all migration of funds from old to new strategy.</p>\n<p>But as currently nothing has been decided at Eigenlayer end. I believe we are good with our current assumption of 1:1. It would be overkill to assume anything else as of now.</p>\n<p>Please check the attached conversation with Eigenlayer team.<br>\nDiscord: <a href=\"https://discord.com/channels/1089434273720832071/1096331191243788379\">https://discord.com/channels/1089434273720832071/1096331191243788379</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/197#issuecomment-1836498666\">0xDjango (judge) invalidated and commented</a>:</strong></p>\n<blockquote>\n<p>Kelp has provided adequate reasoning behind the current design. I agree that it is unlikely that a breaking change from the Eigenlayer protocol would not be properly communicated ahead of time. Designing around this potentiality would impose added risk in the current design.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/197#issuecomment-1837271970\">radev_sw (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hey, @0xDjango.</p>\n<p>I disagree with the reasons provided above.</p>\n<blockquote>\n<p><em>We don’t believe this an issue with KelpDAO or its code but with Eigenlayer if it upgrades its protocol to have multiple strategies for an asset.</em></p>\n</blockquote>\n<p>The problem lies specifically in how Kelp DAO upgrades the strategy for assets. Nothing related to the functionality of EigenLayer Strategies.</p>\n<p>Let’s view at the code of startegy upgrading</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateAssetStrategy</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strategy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlySupportedAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">UtilLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkNonZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strategy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">assetStrategy</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">] == </span><span class=\"mtk12\">strategy</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ValueAlreadyInUse</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assetStrategy</span><span class=\"mtk1\">[</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">strategy</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As we can see, when an EigenLayer Strategy for an asset is changed, there is currently no mechanism in place to migrate user deposits from the old strategy to the new one. It is precisely in this scenario that the vulnerability arises.</p>\n<p>If a strategy update occurs, the function <code>getTotalAssetDeposits(asset)</code> will show a reduced value for that asset. This reduction happens because the function references assets deposited in NodeDelegator. Specifically, <code>NodeDelegator.sol#getAssetBalance()</code> assesses the asset balance based on the user’s current strategy. When a strategy update takes place, the balance associated with the previous strategy is no longer considered, leading to a decrease in <code>totalDeposits</code>. As a result, the share price of <code>rsETH</code> decreases, prompting the system to mint more <code>rsETH</code> shares for depositors. Consequently, depositors can make immediate deposits, gaining shares that are more valuable than the actual amount they deposited.</p>\n<p>This vulnerability describes <strong>significant flaws</strong> in the KelpDAO protocol flow. Nothing related to the functionality of EigenLayer Strategies.</p>\n<blockquote>\n<p><em>But as currently nothing has been decided at Eigenlayer end. I believe we are good with our current assumption of 1:1. It would be a overkill to assume anything else as of now.</em></p>\n</blockquote>\n<p>The recommendations in this report do not make any assumptions about the implementation of 1:1 mapping. Instead, they specifically suggest updating the <code>updateAssetStrategy()</code> function. In a way that update would enable the transfer of user deposits from the old strategy to the new strategy once the new strategy is set. (as in my issue <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/644\">#644</a> writes)</p>\n<p>I believe the issue has been misjudged and should be mitigated to High Severity Issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/197#issuecomment-1837404596\">manoj9april (Kelp) commented</a>:</strong></p>\n<blockquote>\n<p>@radev_sw - KelpDao will only update the strategy address when EigenLayer updates strategy for any asset (which EigenLayer currently has no plans as such).</p>\n<p>Even if above scenario takes place. EigenLayer should provide proper communications ahead of time. And we can go through follow below steps:</p>\n<ul>\n<li>Eigenlayer communicates strategy update</li>\n<li>KelpDao pauses its protocol for a mutually decided duration</li>\n<li>EigenLayer migrates its state from old contracts to new contracts</li>\n<li>KelpDao points to new strategy contract</li>\n<li>KelpDao resumes</li>\n</ul>\n<p>If migration of contract state is not possible at EigenLayer and they (Eigenlayer) decomission their old strategy, only in this scenario<br>\nKelpDao will have to withdraw its funds from old strategy and redelgate it to new strategy. And these steps will be done in complete visibility and transparency with proper timelocks.\nBut sees no harm or loss to funds or miscalculation.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/197#issuecomment-1839037847\">0xDjango (judge) increased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>This will be upgraded to MEDIUM. </p>\n<p>The warden accurately explains how <strong>Kelp’s</strong> internal accounting will be broken if they decide to use the <code>updateAssetStrategy()</code> function. If Kelp changes the strategy address, rsETH share prices will decrease in a way that should not occur.</p>\n<p>While Kelp describes the list of actions that they would take in the case they would need to change the strategy address, the implementation does not protect against the possibility of the broken accounting.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-lack-of-slippage-control-on-lrtdepositpooldepositasset\" style=\"position:relative;\"><a href=\"#m-02-lack-of-slippage-control-on-lrtdepositpooldepositasset\" aria-label=\"m 02 lack of slippage control on lrtdepositpooldepositasset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/148\">[M-02] Lack of slippage control on <code>LRTDepositPool.depositAsset</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/148\">max10afternoon</a>, also found by <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/884\">0xhacksmithh</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/862\">ge6a</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/847\">btk</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/846\">anarcheuz</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/825\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/681\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/647\">Pechenite</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/611\">0xMilenov</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/550\">turvy_fuzz</a>, ck (<a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/522\">1</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/510\">2</a>), hals (<a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/412\">1</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/409\">2</a>), <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/356\">Daniel526</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/230\">Shaheen</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/209\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/195\">glcanvas</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/158\">0xbrett8571</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/101\">0xmystery</a>, and Bauer (<a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/48\">1</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/39\">2</a>)</em></p>\n<p>The <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L119C14-L119C26\">depositAsset</a> function of the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L19C10-L19C24\">LRTDepositPool</a> contract, enables users to deposit assets into the protocol, getting <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/RSETH.sol#L14C10-L14C15\">RSETH</a> tokens in return. The function doesn’t have any type of slippage control; this is relevant in the context of the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L119C14-L119C26\">depositAsset</a> function, since the amount of tokens received by the user is determined by an interaction with an oracle, meaning that the amount received in return may vary indefinitely while the request is waiting to be executed.</p>\n<p><em>Also the users will have no defense against price manipulations attacks, if they where to be found after the protocol’s deployment.</em></p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>As can be observed by looking at its parameters and implementation, the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L119C14-L119C26\">depositAsset</a> function of the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L19C10-L19C24\">LRTDepositPool</a> contract, doesn’t have any type of slippage protection:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function depositAsset(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address asset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 depositAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        whenNotPaused</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        nonReentrant</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        onlySupportedAsset(asset)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // checks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (depositAmount == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert InvalidAmount();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (depositAmount &gt; getAssetCurrentLimit(asset)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert MaximumDepositLimitReached();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (!IERC20(asset).transferFrom(msg.sender, address(this), depositAmount)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert TokenTransferFailed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // interactions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 rsethAmountMinted = _mintRsETH(asset, depositAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit AssetDeposit(asset, depositAmount, rsethAmountMinted);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Meaning that users have no control over how many <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/RSETH.sol#L14C10-L14C15\">RSETH</a> tokens they will get in return for depositing in the contract.</p>\n<p>The amount of tokens to be minted, with respect to the deposited amount, is determined by the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L95\">getRsETHAmountToMint</a> function of the same contract (inside of <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L151\">_mintRsETH</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getRsETHAmountToMint(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address asset,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        public</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        view</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (uint256 rsethAmountToMint)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // setup oracle contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address lrtOracleAddress = lrtConfig.getContract(LRTConstants.LRT_ORACLE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ILRTOracle lrtOracle = ILRTOracle(lrtOracleAddress);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // calculate rseth amount to mint based on asset amount and asset exchange rate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rsethAmountToMint = (amount * lrtOracle.getAssetPrice(asset)) / lrtOracle.getRSETHPrice();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As can be observed, this function uses two oracle interactions to determine how many tokens to mint, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTOracle.sol#L45\">getAssetPrice</a> and <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTOracle.sol#L52\">getRSETHPrice</a> (with <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTOracle.sol#L52\">getRSETHPrice</a> internally calling <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTOracle.sol#L45\">getAssetPrice</a> as well).</p>\n<p>The <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTOracle.sol#L45\">getAssetPrice</a> function queries the external oracle for the asset price:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getAssetPrice(address asset) public view onlySupportedAsset(asset) returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return IPriceFetcher(assetPriceOracle[asset]).getAssetPrice(asset);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Meaning that the user has no way to predict how many <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/RSETH.sol#L14C10-L14C15\">RSETH</a> they will get back at the moment of minting, as the price could be updated while the request is in the mempool.</p>\n<p>Here is a very simple foundry script that shows that an oracle price modification, can largely impact the amount of tokens received in return by the user (implying that the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L119C14-L119C26\">depositAsset</a> function has no protection against it).</p>\n<details>\n<p>Place it in the <code>test</code> folder to preserve dependencies:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: UNLICENSED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.21;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { BaseTest } from &quot;./BaseTest.t.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { LRTDepositPool } from &quot;src/LRTDepositPool.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { RSETHTest, ILRTConfig, UtilLib, LRTConstants } from &quot;./RSETHTest.t.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { ILRTDepositPool } from &quot;src/interfaces/ILRTDepositPool.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { TransparentUpgradeableProxy } from &quot;@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { ProxyAdmin } from &quot;@openzeppelin/contracts/proxy/transparent/ProxyAdmin.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;forge-std/console.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract LRTOracleMock {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 assetPrice = 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setAssetPrice(uint256 newPrice) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assetPrice = newPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getAssetPrice(address) external view returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return assetPrice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getRSETHPrice() external pure returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract MockNodeDelegator {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getAssetBalance(address) external pure returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract LRTDepositPoolTest is BaseTest, RSETHTest {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    LRTDepositPool public lrtDepositPool;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    LRTOracleMock public mockOracle;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setUp() public virtual override(RSETHTest, BaseTest) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        super.setUp();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // deploy LRTDepositPool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ProxyAdmin proxyAdmin = new ProxyAdmin();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        LRTDepositPool contractImpl = new LRTDepositPool();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TransparentUpgradeableProxy contractProxy = new TransparentUpgradeableProxy(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(contractImpl),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(proxyAdmin),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &quot;&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool = LRTDepositPool(address(contractProxy));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mockOracle = new LRTOracleMock();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // initialize RSETH. LRTCOnfig is already initialized in RSETHTest</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rseth.initialize(address(admin), address(lrtConfig));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(admin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // add rsETH to LRT config</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.setRSETH(address(rseth));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // add oracle to LRT config</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.setContract(LRTConstants.LRT_ORACLE, address(mockOracle));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // add minter role for rseth to lrtDepositPool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rseth.grantRole(rseth.MINTER_ROLE(), address(lrtDepositPool));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract LRTDepositPoolDepositAsset is LRTDepositPoolTest {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address public rETHAddress;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setUp() public override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        super.setUp();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // initialize LRTDepositPool</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool.initialize(address(lrtConfig));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rETHAddress = address(rETH);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // add manager role within LRTConfig</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(admin);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtConfig.grantRole(LRTConstants.MANAGER, manager);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function test_OracleCanModifyAssetMinted() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rETH.approve(address(lrtDepositPool), 2 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(bob);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rETH.approve(address(lrtDepositPool), 2 ether); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 aliceDepositTime = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(alice);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool.depositAsset(rETHAddress, 2 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        mockOracle.setAssetPrice(1e17);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 bobDepositTime = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(bob);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        lrtDepositPool.depositAsset(rETHAddress, 2 ether);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 aliceBalanceAfter = rseth.balanceOf(address(alice));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 bobBalanceAfter = rseth.balanceOf(address(bob));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(aliceBalanceAfter);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(bobBalanceAfter);    </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(aliceDepositTime);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        console.log(bobDepositTime); </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(aliceDepositTime, bobDepositTime);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertGt(aliceBalanceAfter, bobBalanceAfter);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</details>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>An additional parameter could be added to the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/c5fdc2e62c5e1d78769f44d6e34a6fb9e40c00f0/src/LRTDepositPool.sol#L119C14-L119C26\">depositAsset</a> function, to let users decide the minimum amount of tokens to be received, with a relative check after minting.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/148#issuecomment-1825369647\">gus (Kelp) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/148#issuecomment-1837411885\">manoj9april (Kelp) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Slippage control makes more sense in DEXes. But in staking protocols, where prices are mostly stable and users can reject if it txn takes longer time.<br>\nBut it is a useful recommendation.<br>\nI think we can move it to QA.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/148#issuecomment-1839011720\">0xDjango (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Sticking with medium. There is no protection for the user in the current implementation. <code>minShares</code> checks are commonly implemented in staking contracts.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 125 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/581\">report highlighted below</a> by <strong>m_Rassska</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/697\">CatsSecurity</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/650\">Pechenite</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/415\">hals</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/881\">0xepley</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/878\">0xffchain</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/875\">btk</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/873\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/859\">turvy_fuzz</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/840\">adriro</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/831\">anarcheuz</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/815\">Madalad</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/803\">spark</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/798\">ge6a</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/783\">shealtielanz</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/774\">_thanos1</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/769\">0xAadi</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/757\">phoenixV110</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/755\">rouhsamad</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/745\">poneta</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/724\">0xvj</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/723\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/716\">SandNallani</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/714\">gesha17</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/710\">Topmark</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/708\">dipp</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/705\">adeolu</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/686\">leegh</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/685\">tallo</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/677\">osmanozdemir1</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/673\">cartlex_</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/667\">RaoulSchaffranek</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/648\">Matin</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/640\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/637\">cheatc0d3</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/635\">Tumelo_Crypto</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/626\">GREY-HAWK-REACH</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/617\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/616\">bronze_pickaxe</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/579\">Yanchuan</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/578\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/577\">0xHelium</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/575\">Amithuddar</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/569\">Inspecktor</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/568\">sakshamguruji</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/566\">jasonxiale</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/545\">joaovwfreire</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/541\">0xblackskull</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/539\">0xLeveler</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/535\">baice</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/534\">SBSecurity</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/526\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/525\">niser93</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/502\">ro1sharkm</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/500\">hihen</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/499\">Phantasmagoria</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/485\">McToady</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/483\">bareli</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/482\">0x1337</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/479\">Aamir</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/473\">almurhasan</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/458\">eeshenggoh</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/453\">seerether</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/447\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/439\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/432\">Soul22</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/431\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/423\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/399\">deepkin</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/394\">chaduke</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/392\">AerialRaider</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/383\">Shaheen</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/382\">Cryptor</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/381\">boredpukar</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/380\">TeamSS</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/376\">alexfilippov314</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/369\">Draiakoo</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/361\">Daniel526</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/357\">amaechieth</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/351\">zach</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/348\">squeaky_cactus</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/341\">crack-the-kelp</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/336\">King_</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/326\">MatricksDeCoder</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/320\">Noro</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/313\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/310\">wisdomn_</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/306\">0xrugpull_detector</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/298\">pep7siup</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/294\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/292\">paritomarrr</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/285\">soliditytaker</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/272\">ziyou-</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/270\">codynhat</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/262\">passion</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/261\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/251\">supersizer0x</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/248\">stackachu</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/245\">evmboi32</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/243\">TheSchnilch</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/239\">taner2344</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/216\">glcanvas</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/215\">marchev</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/212\">Stormreckson</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/208\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/207\">Eigenvectors</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/196\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/178\">ElCid</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/171\">ke1caM</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/168\">0xluckhu</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/156\">desaperh</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/153\">debo</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/149\">merlinboii</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/140\">ABAIKUNANBAEV</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/116\">pipidu83</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/112\">LinKenji</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/109\">0xbrett8571</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/102\">0xmystery</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/96\">zhaojohnson</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/88\">critical-or-high</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/73\">MaslarovK</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/72\">T1MOH</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/51\">ubl4nk</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/46\">Bauer</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/36\">Tadev</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<h3 id=\"low-severity\" style=\"position:relative;\"><a href=\"#low-severity\" aria-label=\"low severity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Severity</h3>\n<ul>\n<li><strong>[L-01] Prevent deposits to the nodes with max amount of assets being staked already</strong></li>\n<li><strong>[L-02] Set the price feeds during an initialization</strong></li>\n<li><strong>[L-03] Dropping a dust to grief the staking process</strong></li>\n<li><strong>[L-04] Approve to <code>StrategyManager</code> during an initialization</strong></li>\n<li><strong>[L-05] Enforce <code>maxnodeDelegatorCount > nodeDelegatorQueue.length</code></strong></li>\n<li><strong>[L-06] Place an assertion to ensure the system in paused/unpaused state</strong></li>\n</ul>\n<h3 id=\"non-critical-severity\" style=\"position:relative;\"><a href=\"#non-critical-severity\" aria-label=\"non critical severity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Severity</h3>\n<ul>\n<li><strong>[N-01] Introduce <code>removeNodeDelegatorToQueue</code></strong></li>\n</ul>\n<h2 id=\"l-01-prevent-deposits-to-the-nodes-with-max-amount-of-assets-being-staked-already\" style=\"position:relative;\"><a href=\"#l-01-prevent-deposits-to-the-nodes-with-max-amount-of-assets-being-staked-already\" aria-label=\"l 01 prevent deposits to the nodes with max amount of assets being staked already permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Prevent deposits to the nodes with max amount of assets being staked already</h2>\n<p>If the node has staked already 1e23 of assets, it should not receive any transfers, since there is no more space to stake at EigenLayer.</p>\n<h3 id=\"example-of-an-occurrence\" style=\"position:relative;\"><a href=\"#example-of-an-occurrence\" aria-label=\"example of an occurrence permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example of an occurrence</h3>\n<p>Could be implied <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L183-L197\">here</a>.</p>\n<h2 id=\"l-02-set-the-price-feeds-during-an-initialization\" style=\"position:relative;\"><a href=\"#l-02-set-the-price-feeds-during-an-initialization\" aria-label=\"l 02 set the price feeds during an initialization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Set the price feeds during an initialization</h2>\n<p>Currently, the price feeds are set by using <code>updatePriceOracleFor()</code> after an <code>LRTOPracle</code> being deployed. However, it’s better to set up everything during an initialization process.</p>\n<h3 id=\"example-of-an-occurrence-1\" style=\"position:relative;\"><a href=\"#example-of-an-occurrence-1\" aria-label=\"example of an occurrence 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example of an occurrence</h3>\n<p>Could be added, for instance, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTOracle.sol#L29-L35\">here</a>.</p>\n<h2 id=\"l-03-dropping-a-dust-to-grief-the-staking-process\" style=\"position:relative;\"><a href=\"#l-03-dropping-a-dust-to-grief-the-staking-process\" aria-label=\"l 03 dropping a dust to grief the staking process permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Dropping a dust to grief the staking process</h2>\n<p>After an amount of lst being transferred to a specified <code>NodeDelegator</code>, the stake on EigenLayer is expected to happen. However, if there is a possibility to grief <code>depositAssetIntoStrategy</code>, adversary might drop some dust and front-run the tx submitted by <code>LRTManager</code>. This forces to transfer some assets back to the pool in order to successfully stake at EigenLayer.</p>\n<h3 id=\"example-of-an-occurrence-2\" style=\"position:relative;\"><a href=\"#example-of-an-occurrence-2\" aria-label=\"example of an occurrence 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example of an occurrence</h3>\n<p>It’s better to provide an opportunity for <code>LRTManager</code> to decide, how much lst amount is about to be transferred and not blindly rely on the total balance <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/NodeDelegator.sol#L63\">here</a>.</p>\n<h2 id=\"l-04-approve-to-strategymanager-during-an-initialization\" style=\"position:relative;\"><a href=\"#l-04-approve-to-strategymanager-during-an-initialization\" aria-label=\"l 04 approve to strategymanager during an initialization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Approve to <code>StrategyManager</code> during an initialization</h2>\n<p>There is no need to inflate the bytecode for <code>NodeDelegator</code> by introducing a special function for an approval grants. Instead, approve to the <code>eigenlayerStrategyManagerAddress</code> during an initialization.</p>\n<h3 id=\"example-of-an-occurrence-3\" style=\"position:relative;\"><a href=\"#example-of-an-occurrence-3\" aria-label=\"example of an occurrence 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example of an occurrence</h3>\n<p>Could be added, for instance, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTOracle.sol#L29-L35\">here</a>.</p>\n<h2 id=\"l-05-enforce-maxnodedelegatorcount--nodedelegatorqueuelength\" style=\"position:relative;\"><a href=\"#l-05-enforce-maxnodedelegatorcount--nodedelegatorqueuelength\" aria-label=\"l 05 enforce maxnodedelegatorcount  nodedelegatorqueuelength permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Enforce <code>maxnodeDelegatorCount > nodeDelegatorQueue.length</code></h2>\n<p>Put an assertion to ensure that the <code>maxnodeDelegatorCount > nodeDelegatorQueue.length</code> to prevent unexpected behavior from happening. </p>\n<h3 id=\"example-of-an-occurrence-4\" style=\"position:relative;\"><a href=\"#example-of-an-occurrence-4\" aria-label=\"example of an occurrence 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example of an occurrence</h3>\n<p>Could be added, for instance, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L202-L205\">here</a>.</p>\n<h2 id=\"l-06-place-an-assertion-to-ensure-the-system-in-pausedunpaused-state\" style=\"position:relative;\"><a href=\"#l-06-place-an-assertion-to-ensure-the-system-in-pausedunpaused-state\" aria-label=\"l 06 place an assertion to ensure the system in pausedunpaused state permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Place an assertion to ensure the system in paused/unpaused state</h2>\n<p>The functions <code>pause()/unpause()</code> are super important in case something suspicous starts to happen. An <code>LRTManager</code> might accidentally invoke <code>unpause()</code> instead of hitting <code>pause()</code> and convince himself of stopping suspicous activity. However, this might give an attacker the chance to continue his dirty activity.</p>\n<h3 id=\"example-of-an-occurrence-5\" style=\"position:relative;\"><a href=\"#example-of-an-occurrence-5\" aria-label=\"example of an occurrence 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example of an occurrence</h3>\n<p>Could be added, for instance, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L208-L215\">here</a>.</p>\n<h2 id=\"n-01-introduce-removenodedelegatorfromqueue\" style=\"position:relative;\"><a href=\"#n-01-introduce-removenodedelegatorfromqueue\" aria-label=\"n 01 introduce removenodedelegatorfromqueue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Introduce <code>removeNodeDelegatorFromQueue</code></h2>\n<p>It is recommended to introduce <code>removeNodeDelegatorFromQueue</code> in case the <code>NodeDelegator</code> is no longer needed.</p>\n<h3 id=\"example-of-an-occurrence-6\" style=\"position:relative;\"><a href=\"#example-of-an-occurrence-6\" aria-label=\"example of an occurrence 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example of an occurrence</h3>\n<p>Could be introduced, for instance, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol#L158\">here</a>.</p>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 16 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/591\">report highlighted below</a> by <strong>0xVolcano</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/715\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/583\">unique</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/424\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/849\">tala7985</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/813\">Raihan</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/804\">0xAnah</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/802\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/731\">0xhex</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/725\">0xta</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/706\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/629\">shamsulhaq123</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/491\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/144\">ABAIKUNANBAEV</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/137\">Rickard</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/75\">rumen</a>.</em></p>\n<h2 id=\"g-01-avoid-zero-to-non-zero-storage-writes\" style=\"position:relative;\"><a href=\"#g-01-avoid-zero-to-non-zero-storage-writes\" aria-label=\"g 01 avoid zero to non zero storage writes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Avoid zero to non-zero storage writes</h2>\n<p>When a storage variable goes from zero to non-zero, the user must pay 22,100 gas total (20,000 gas for a zero to non-zero write and 2,100 for a cold storage access).</p>\n<p>This is why the Openzeppelin reentrancy guard registers functions as active or not with 1 and 2 rather than 0 and 1. It only costs 5,000 gas to alter a storage variable from non-zero to non-zero.</p>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L19-L38\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L19-L38</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LRTDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">19</span><span class=\"mtk1\">:</span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">LRTDepositPool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ILRTDepositPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">LRTConfigRoleChecker</span><span class=\"mtk1\">, </span><span class=\"mtk12\">PausableUpgradeable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ReentrancyGuardUpgradeable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">20</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxNodeDelegatorCount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">29</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @dev Initializes the contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:    </span><span class=\"mtk3\">/// @param lrtConfigAddr LRT config address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">31</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lrtConfigAddr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">32</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">UtilLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkNonZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfigAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">33</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">__Pausable_init</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">34</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">__ReentrancyGuard_init</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">35</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">maxNodeDelegatorCount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">36</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ILRTConfig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfigAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">UpdatedLRTConfig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfigAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">38</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>When declaring the variable <code>maxNodDelegatorCount</code> the default value is applied since we do not assign anything, the default value of <code>uint256</code> is <code>0</code>.</p>\n<p>We then call the function <code>initialize()</code> and here we assign the value <code>10</code> <code>maxNodeDelegatorCount = 10;</code>. This means our value is updated from <code>0</code>  to <code>10</code>.</p>\n<p>Since the <code>initialize()</code> function will always be called first, we can initialize our variable <code>maxNodDelegatorCount</code>  with <code>1</code> during declaration which should avoid the zero to non zero writes.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> /// @title LRTDepositPool - Deposit Pool Contract for LSTs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> /// @notice Handles LST asset deposits</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract LRTDepositPool is ILRTDepositPool, LRTConfigRoleChecker, PausableUpgradeable, ReentrancyGuardUpgradeable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 public maxNodeDelegatorCount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 public maxNodeDelegatorCount = 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     address[] public nodeDelegatorQueue;</span></span></span></code></pre>\n<h2 id=\"g-02-we-can-optimize-the-function-updatelrtconfig\" style=\"position:relative;\"><a href=\"#g-02-we-can-optimize-the-function-updatelrtconfig\" aria-label=\"g 02 we can optimize the function updatelrtconfig permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] We can optimize the function <code>updateLRTConfig()</code></h2>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/utils/LRTConfigRoleChecker.sol#L47-L51\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/utils/LRTConfigRoleChecker.sol#L47-L51</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">utils</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LRTConfigRoleChecker</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateLRTConfig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lrtConfigAddr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyLRTAdmin</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">UtilLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkNonZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfigAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ILRTConfig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfigAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">UpdatedLRTConfig</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfigAddr</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>The above function uses the modifier <code>onlyLRTAdmin</code> which has the following implementation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyLRTAdmin</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0x00</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">IAccessControl</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">hasRole</span><span class=\"mtk1\">(</span><span class=\"mtk12\">DEFAULT_ADMIN_ROLE</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ILRTConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">CallerNotLRTConfigAdmin</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The modifier reads a state variable <code>lrtConfig</code> and also makes an external call to <code>hasRole()</code>.</p>\n<p>If the check does not pass we have a revert. Using this modifier in our function means we run the check first and revert if the check does not pass.</p>\n<p>If the check passes, our function has one more check <code>UtilLib.checkNonZeroAddress</code> which basically checks that our address is not zero. This is way cheaper compared to the check inside the modifier</p>\n<p>If this check does not pass, it means we would also revert, now suppose the first check(modifier) passes but the non zero fails, the gas consumed inside the modifier doing the state read and external call would all be wasted.</p>\n<p>We can do this check more efficiently by prioritizing cheaper checks first but for this to work, we would need to inline our modifier as shown below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/utils/LRTConfigRoleChecker.sol b/src/utils/LRTConfigRoleChecker.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 991d0e9..1b9917f 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/utils/LRTConfigRoleChecker.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/utils/LRTConfigRoleChecker.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -44,8 +44,12 @@ abstract contract LRTConfigRoleChecker {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @notice Updates the LRT config contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @dev only callable by LRT admin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @param lrtConfigAddr the new LRT config contract Address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    function updateLRTConfig(address lrtConfigAddr) external virtual onlyLRTAdmin {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    function updateLRTConfig(address lrtConfigAddr) external virtual  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         UtilLib.checkNonZeroAddress(lrtConfigAddr);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bytes32 DEFAULT_ADMIN_ROLE = 0x00;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (!IAccessControl(address(lrtConfig)).hasRole(DEFAULT_ADMIN_ROLE, msg.sender)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+            revert ILRTConfig.CallerNotLRTConfigAdmin();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         lrtConfig = ILRTConfig(lrtConfigAddr);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit UpdatedLRTConfig(lrtConfigAddr);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span></span></span></code></pre>\n<h2 id=\"g-03-emit-local-variables-instead-of-state-variablesnot-found-by-bot\" style=\"position:relative;\"><a href=\"#g-03-emit-local-variables-instead-of-state-variablesnot-found-by-bot\" aria-label=\"g 03 emit local variables instead of state variablesnot found by bot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Emit local variables instead of state variables(not found by bot)</h2>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L202-L205\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L202-L205</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LRTDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">202</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">updateMaxNodeDelegatorCount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxNodeDelegatorCount_</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyLRTAdmin</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">203</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">maxNodeDelegatorCount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">maxNodeDelegatorCount_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">204</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaxNodeDelegatorCountUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maxNodeDelegatorCount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -201,7 +201,7 @@ contract LRTDepositPool is ILRTDepositPool, LRTConfigRoleChecker, PausableUpgrad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @param maxNodeDelegatorCount_ Maximum count of node delegator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function updateMaxNodeDelegatorCount(uint256 maxNodeDelegatorCount_) external onlyLRTAdmin {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         maxNodeDelegatorCount = maxNodeDelegatorCount_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        emit MaxNodeDelegatorCountUpdated(maxNodeDelegatorCount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        emit MaxNodeDelegatorCountUpdated(maxNodeDelegatorCount_);//@audit emit the local var</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h2 id=\"g-04-dont-cache-callsvariables-if-using-them-once\" style=\"position:relative;\"><a href=\"#g-04-dont-cache-callsvariables-if-using-them-once\" aria-label=\"g 04 dont cache callsvariables if using them once permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Don’t cache calls/variables if using them once</h2>\n<h3 id=\"no-need-to-cache-lrtconfiggetcontractlrtconstantseigen_strategy_manager\" style=\"position:relative;\"><a href=\"#no-need-to-cache-lrtconfiggetcontractlrtconstantseigen_strategy_manager\" aria-label=\"no need to cache lrtconfiggetcontractlrtconstantseigen_strategy_manager permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>No need to cache <code>lrtConfig.getContract(LRTConstants.EIGEN_STRATEGY_MANAGER)</code></h3>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L38-L46\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L38-L46</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NodeDelegator</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">38</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxApproveToEigenStrategyManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">39:        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">40:        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">41:        </span><span class=\"mtk11\">onlySupportedAsset</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">42:        </span><span class=\"mtk11\">onlyLRTManager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">43:    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">44</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">eigenlayerStrategyManagerAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">EIGEN_STRATEGY_MANAGER</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">45</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">eigenlayerStrategyManagerAddress</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">46</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>The variable <code>eigenlayerStrategyManagerAddress</code> is only used once, therefore no need to cache the call.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/src/NodeDelegator.sol b/src/NodeDelegator.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index bba20ca..989218c 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/src/NodeDelegator.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/src/NodeDelegator.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -41,8 +41,7 @@ contract NodeDelegator is INodeDelegator, LRTConfigRoleChecker, PausableUpgradea</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         onlySupportedAsset(asset)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         onlyLRTManager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address eigenlayerStrategyManagerAddress = lrtConfig.getContract(LRTConstants.EIGEN_STRATEGY_MANAGER);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        IERC20(asset).approve(eigenlayerStrategyManagerAddress, type(uint256).max);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        IERC20(asset).approve(lrtConfig.getContract(LRTConstants.EIGEN_STRATEGY</span></span></span></code></pre>\n<h3 id=\"no-need-to-cache-lrtconfiggetcontractlrtconstantseigen_strategy_manager-1\" style=\"position:relative;\"><a href=\"#no-need-to-cache-lrtconfiggetcontractlrtconstantseigen_strategy_manager-1\" aria-label=\"no need to cache lrtconfiggetcontractlrtconstantseigen_strategy_manager 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>No need to cache <code>lrtConfig.getContract(LRTConstants.EIGEN_STRATEGY_MANAGER)</code></h3>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L51-L68\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L51-L68</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NodeDelegator</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">51</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">depositAssetIntoStrategy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">58:    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strategy</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assetStrategy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">eigenlayerStrategyManagerAddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">EIGEN_STRATEGY_MANAGER</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">AssetDepositIntoStrategy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">, </span><span class=\"mtk12\">strategy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">:</span><span class=\"mtk11\">IEigenStrategyManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">eigenlayerStrategyManagerAddress</span><span class=\"mtk1\">).</span><span class=\"mtk11\">depositIntoStrategy</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IStrategy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strategy</span><span class=\"mtk1\">), </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @notice Deposits an asset lying in this NDC into its strategy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -58,13 +58,12 @@ contract NodeDelegator is INodeDelegator, LRTConfigRoleChecker, PausableUpgradea</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address strategy = lrtConfig.assetStrategy(asset);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         IERC20 token = IERC20(asset);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address eigenlayerStrategyManagerAddress = lrtConfig.getContract(LRTConstants.EIGEN_STRATEGY_MANAGER);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 balance = token.balanceOf(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         emit AssetDepositIntoStrategy(asset, strategy, balance);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        IEigenStrategyManager(eigenlayerStrategyManagerAddress).depositIntoStrategy(IStrategy(strategy), token, balance);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        IEigenStrategyManager(lrtConfig.getContract(LRTConstants.EIGEN_STRATEGY_MANAGER)).depositIntoStrategy(IStrategy(strategy), token, balance);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h3 id=\"no-need-to-cache-lrtconfiggetcontractlrtconstantslrt_deposit_pool\" style=\"position:relative;\"><a href=\"#no-need-to-cache-lrtconfiggetcontractlrtconstantslrt_deposit_pool\" aria-label=\"no need to cache lrtconfiggetcontractlrtconstantslrt_deposit_pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>No need to cache <code>lrtConfig.getContract(LRTConstants.LRT_DEPOSIT_POOL)</code></h3>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L74-L89\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L74-L89</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NodeDelegator</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">74</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferBackToLRTDepositPool</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">84:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">lrtDepositPool</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LRTConstants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">LRT_DEPOSIT_POOL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">86:        </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk10\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk10\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lrtDepositPool</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">87</span><span class=\"mtk1\">:            </span><span class=\"mtk10\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TokenTransferFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     /// @notice Deposits an asset lying in this NDC into its strategy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -81,9 +81,8 @@ contract NodeDelegator is INodeDelegator, LRTConfigRoleChecker, PausableUpgradea</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         onlySupportedAsset(asset)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         onlyLRTManager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address lrtDepositPool = lrtConfig.getContract(LRTConstants.LRT_DEPOSIT_POOL);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (!IERC20(asset).transfer(lrtDepositPool, amount)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (!IERC20(asset).transfer(lrtConfig.getContract(LRTConstants.LRT_DEPOSIT_POOL), amount)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             revert TokenTransferFailed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h3 id=\"no-need-to-cache-lrtconfigassetstrategyasset\" style=\"position:relative;\"><a href=\"#no-need-to-cache-lrtconfigassetstrategyasset\" aria-label=\"no need to cache lrtconfigassetstrategyasset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>No need to cache <code>lrtConfig.assetStrategy(asset)</code></h3>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L121-L124\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L121-L124</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NodeDelegator</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getAssetBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">strategy</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">lrtConfig</span><span class=\"mtk1\">.</span><span class=\"mtk11\">assetStrategy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">asset</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">IStrategy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">strategy</span><span class=\"mtk1\">).</span><span class=\"mtk11\">userUnderlyingView</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">124</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function getAssetBalance(address asset) external view override returns (uin</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">t256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address strategy = lrtConfig.assetStrategy(asset);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        return IStrategy(strategy).userUnderlyingView(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        return IStrategy(lrtConfig.assetStrategy(asset)).userUnderlyingView(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h3 id=\"no-need-to-cache-nodedelegatorqueuendcindex\" style=\"position:relative;\"><a href=\"#no-need-to-cache-nodedelegatorqueuendcindex\" aria-label=\"no need to cache nodedelegatorqueuendcindex permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>No need to cache <code>nodeDelegatorQueue[ndcIndex]</code></h3>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L183-L197\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L183-L197</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LRTDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">183</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferAssetToNodeDelegator</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">192:    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">193</span><span class=\"mtk1\">:        </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">nodeDelegator</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">[</span><span class=\"mtk12\">ndcIndex</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">194</span><span class=\"mtk1\">:        </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk10\">asset</span><span class=\"mtk1\">).</span><span class=\"mtk10\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeDelegator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">195</span><span class=\"mtk1\">:            </span><span class=\"mtk10\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TokenTransferFailed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">197</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -190,8 +190,7 @@ contract LRTDepositPool is ILRTDepositPool, LRTConfigRoleChecker, PausableUpgrad</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         onlyLRTManager</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         onlySupportedAsset(asset)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        address nodeDelegator = nodeDelegatorQueue[ndcIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (!IERC20(asset).transfer(nodeDelegator, amount)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (!IERC20(asset).transfer(nodeDelegatorQueue[ndcIndex], amount)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             revert TokenTransferFailed();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span></code></pre>\n<h2 id=\"g-05-caching-the-length-of-calldata-increases-gas-cost-instead-of-reducing-it\" style=\"position:relative;\"><a href=\"#g-05-caching-the-length-of-calldata-increases-gas-cost-instead-of-reducing-it\" aria-label=\"g 05 caching the length of calldata increases gas cost instead of reducing it permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Caching the length of calldata increases gas cost instead of reducing it</h2>\n<p><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L162-L177\">https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L162-L177</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LRTDepositPool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addNodeDelegatorContractToQueue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nodeDelegatorContracts</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyLRTAdmin</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">nodeDelegatorContracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">maxNodeDelegatorCount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">165</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MaximumNodeDelegatorCountReached</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">166</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">168</span><span class=\"mtk1\">:        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">length</span><span class=\"mtk1\">;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">169</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">UtilLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkNonZeroAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeDelegatorContracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">170</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">nodeDelegatorQueue</span><span class=\"mtk1\">.</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeDelegatorContracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">171</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NodeDelegatorAddedinQueue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nodeDelegatorContracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">172</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">173</span><span class=\"mtk1\">:                ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">174</span><span class=\"mtk1\">:            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">175</span><span class=\"mtk1\">:        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">176</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     function addNodeDelegatorContractToQueue(address[] calldata nodeDelegatorContracts) external onlyLRTAdmin {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 length = nodeDelegatorContracts.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        if (nodeDelegatorQueue.length + length &gt; maxNodeDelegatorCount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (nodeDelegatorQueue.length + nodeDelegatorContracts.length &gt; maxNodeDelegatorCount) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             revert MaximumNodeDelegatorCountReached();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        for (uint256 i; i &lt; length;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        for (uint256 i; i &lt; nodeDelegatorContracts.length;) {</span></span></span></code></pre>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 21 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/618\">report highlighted below</a> by <strong>CatsSecurity</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/876\">SBSecurity</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/867\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/806\">albahaca</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/657\">sakshamguruji</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/546\">foxb868</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/508\">0xbrett8571</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/440\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/437\">invitedtea</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/378\">0xepley</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/872\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/841\">fouzantanveer</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/832\">SAAJ</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/826\">clara</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/720\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/671\">unique</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/586\">KeyKiril</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/574\">Myd</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/512\">digitizeworx</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/404\">ZanyBonzy</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp-findings/issues/250\">glcanvas</a>.</em></p>\n<h3 id=\"description-of-kelp\" style=\"position:relative;\"><a href=\"#description-of-kelp\" aria-label=\"description of kelp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description of Kelp</h3>\n<p>Kelp represents a collaborative DAO with the purpose of enhancing liquidity, DeFi, and maximizing rewards for assets that are restaked. The core of this initiative lies in the integration of a single liquid restaked token made for recognized LSTs, ensuring seamless accessibility. The protocol will allow users to employ their rsETH within EigenLayer strategies, enabling them to generate returns. The ongoing development of rsETH will be carried out within the framework of the Kelp brand.</p>\n<h3 id=\"1-system-overview\" style=\"position:relative;\"><a href=\"#1-system-overview\" aria-label=\"1 system overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. System Overview</h3>\n<p><strong>1.1 Scoping</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTConfig.sol\">LRTConfig</a>: This contract includes the functionality to configure the system such as adding new supported assets, updating assets’ deposit limit, updating an asset’s strategy, setting the <code>rsETH</code> contract address, setting the token address and numerous getter functions.</li>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol\">LRTDepositPool</a>: This contract is the main user-facing contract and includes the functionality to deposit assets, mint <code>rsETH</code>, add node delegator’s to the queue, transfer assets to node delegators, update the max node delegators count and numerous getter functions.</li>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/NodeDelegator.sol\">NodeDelegator</a>: This contract is the recipient of funds from the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol\">LRTDepositPool</a> contract and in turn sends them to the EigenLayer strategies, includes functionality to approve assets to EigenLayer, deposit assets into the strategy, transfer funds back to <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTDepositPool.sol\">LRTDepositPool</a>, and numerous getter functions.</li>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTOracle.sol\">LRTOracle</a>: This contract is utilized as the <code>Oracle</code> to get prices of liquid staking tokens, includes functionality to update the price oracle for supported assets, as well as fetch supported asset and <code>rsETH</code> prices.</li>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/RSETH.sol\">RSETH</a>: This contract is the <code>rsETH</code> ERC20 Token the protocol uses and contains all the standard functionality as per OpenZeppelin’s requirements.</li>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/oracles/ChainlinkPriceOracle.sol\">ChainlinkPriceOracle</a>: This contract is the <code>Chainlink Price Oracle</code> wrapper to integrate their oracles in the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTOracle.sol\">LRTOracle</a> and contains all standard Chainlink Oracle functionality. </li>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/utils/LRTConfigRoleChecker.sol\">LRTConfigRoleChecker</a>: This contract is abstract and is responsible for handling role checks such as <code>onlyLRTManager</code>, <code>onlyLRTAdmin</code>, <code>onlySupportedAsset</code>, and can also be used to update the <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/LRTConfig.sol\">LRTConfig</a> contract.</li>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/utils/UtilLib.sol\">UtilLib</a>: This contract is a simple helper library that contains a check for non zero address function.</li>\n<li><a href=\"https://github.com/code-423n4/2023-11-kelp/blob/main/src/utils/LRTConstants.sol\">LRTConstants</a>: This contract is contains all the shared constant variables used within the system such as <code>R_ETH_TOKEN</code>, <code>ST_ETH_TOKEN</code>, <code>CB_ETH_TOKEN</code>, <code>LRT_ORACLE</code>, <code>LRT_DEPOSIT_POOL</code>, <code>EIGEN_STRATEGY_MANAGER</code>, <code>MANAGER</code>.</li>\n</ul>\n<p><strong>1.2 Access Control Roles</strong></p>\n<p>The contracts uses the following 4 access control modifiers for different mechanisms within the system: </p>\n<ul>\n<li><code>DEFAULT_ADMIN_ROLE</code>: Used for core administrative functions within the system that have to do with initial setting of addresses as well as updating asset strategies. </li>\n<li><code>onlyLRTADMIN</code>: Used for functionality within the system that has to do with node delegaotrs and unpausing the contracts.</li>\n<li><code>onlyLRTMANAGER</code>: Used for functionality within the system that has to do with node delegators, transfer of funds between contracts and EigenLayer strategies and price oracle configurations.</li>\n<li><code>LRTConstants.MANAGER</code>: Used for functionality within the system that has to do with supported assets and their deposit limits.</li>\n</ul>\n<p><strong>1.3 Access Restricted Functions</strong></p>\n<ul>\n<li><code>DEFAULT_ADMIN_ROLE</code>: This role has access to administrative functions such as <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTConfig.sol#L109\">updating asset strategies</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTConfig.sol#L144\">setting the rsETH address</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTConfig.sol#L149\">setting the token address</a> &#x26; <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTConfig.sol#L165\">setting the contract address</a>.</li>\n<li><code>onlyLRTADMIN</code>: This role has access to functions related to the Node Delegators such as <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L162\">adding new node delegator contracts to the queue</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L202\">updating the maximum node delegator count</a> and <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L213\">unpausing</a> the various contracts that allow for that.</li>\n<li><code>onlyLRTMANAGER</code>: This role has access to other functions related to the Node Delegators such as <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L183\">transferring assets from the deposit pool to the node delegator contracts</a>, as well as <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L38\">approving assets to the EigenLayer strategy manager</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L51\">depositing assets from node delegators to the strategy</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/NodeDelegator.sol#L74\">transferring funds from node delegators back to the deposit pool</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTOracle.sol#L88\">updating the price oracle of suported assets</a>, <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/oracles/ChainlinkPriceOracle.sol#L45\">adding or updating the oracle price feed for assets</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTDepositPool.sol#L208\">pausing</a> the various contracts that allow for that.</li>\n<li><code>LRTConstants.MANAGER</code>: This role has access to functions related to <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTConfig.sol#L73\">adding new supported assets</a>, and <a href=\"https://github.com/code-423n4/2023-11-kelp/blob/f751d7594051c0766c7ecd1e68daeb0661e43ee3/src/LRTConfig.sol#L94\">updating the asset deposit limits</a>.</li>\n</ul>\n<h3 id=\"2-architecture-overview--diagrams\" style=\"position:relative;\"><a href=\"#2-architecture-overview--diagrams\" aria-label=\"2 architecture overview  diagrams permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Architecture Overview &#x26; Diagrams</h3>\n<p><strong>2.1 Architecture Overview</strong></p>\n<ul>\n<li>LRTConfig: The LRTConfig contract is a critical part of the Kelp protocol. It contains the logic for the system’s configuration such as supported assets and their deposit limits and asset strategies.</li>\n<li>LRTDepositPool: The LRTDepositPool contract is the main user-facing contract in the protocol responsible for taking in deposits and minting <code>rsETH</code> for users. Users can also get information related to current asset limits, total asset deposits and the node delegator queue. Restricted roles have access to node delegator and transferring of funds functions inside this contract.</li>\n<li>LRTOracle: The LRTOracle contract is the one responsible for fetching prices of LSTs (liquid staking tokens). It works together with the LRTDepositPool to maintain accurate price validity and helps in calculating how much <code>rsETH</code> to mint for users.</li>\n<li>RSETH: The RSETH Contract is the system’s ERC20 token implementation. Not much to say here.</li>\n<li>ChainlinkPriceOracle: The ChainLinkPriceOracle contract is the wrapper contract used to integrate Chainlink’s Oracles. It works together with the LRTOracle contract to supply it’s fetched data.</li>\n<li>LRTConfigRoleChecker: The LRTConfigRoleChecker contract is the system’s implementation for access control modifiers enabling certain functions to only be accessible by privileged roles.</li>\n<li>UtilLib: The UtilLib contract is a helper function lib that contains a check for non zero address function.</li>\n<li>LRTConstants: The LRTConstants contract contains the constant variables shared between the contracts such as <code>R_ETH_TOKEN</code> &#x26; other supported LSTs, <code>LRT_ORACLE</code> &#x26; other contracts, as well as the <code>MANAGER</code> role.</li>\n</ul>\n<p><strong>2.2 Architecture Diagram</strong></p>\n<p>The architecture diagram visualizes how the contracts in the system interact with eachother and provides short descriptions of the contracts’ intended mechanism.</p>\n<p><img src=\"https://user-images.githubusercontent.com/58657666/282805871-37965b8f-cece-4a75-845a-0437ae75d183.jpg\" alt=\"Architechture - Frame 1\"></p>\n<p><strong>2.3 Flow of Funds Diagram</strong></p>\n<p>The flow of funds diagram visualizes the process through which a user goes in order to deposit their assets into the protocol and how they travel to their final destination of the EigenLayer strategies.</p>\n<p><img src=\"https://user-images.githubusercontent.com/58657666/282804967-c299fa9e-ff8b-43ed-9c91-efaee8b950b2.jpg\" alt=\"Architechture - Frame 2\"></p>\n<p><strong>2.4 Core Contracts Parameters Diagram</strong></p>\n<p>The core contracts parameters diagram visualizes the main parameters and/or storage variables in the system and what they represent.</p>\n<p><img src=\"https://user-images.githubusercontent.com/58657666/282804985-134b842b-1bce-4991-981f-83f15c9c7f21.jpg\" alt=\"Architechture - Frame 3\"></p>\n<h3 id=\"3-codebase-assessment\" style=\"position:relative;\"><a href=\"#3-codebase-assessment\" aria-label=\"3 codebase assessment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Codebase Assessment</h3>\n<p>The total nSLOC of the contracts in scope are quite low but it can be seen that the developers have done an excellent job of integrating all the functionality properly. Config, Deposit Pool, Oracles &#x26; Node Delegaotrs communicate seamlessly with access control roles functioning as intended wherever needed. The system includes <code>pause</code> functionality which, in my opinion, is always a good idea.</p>\n<ul>\n<li>General Redability: The codebase exhibits sound coding practices, upholding readability and organization through well-defined variables and function names. </li>\n<li>Code Style: The code adheres to a uniform style and indentation pattern, complemented by in-line comments that provide comprehensive guidance throughout it’s mechanisms.</li>\n<li>Gas: Gas efficiency is effectively upheld.</li>\n<li>Test Suite: With a test suite coverage of 98%, the protocol did an almost perfect job. The setting up of environments for tests was easy and straight-forward.</li>\n<li>Errors &#x26; Events: This is something that codebase lacked in. I didn’t come across any handling neither of errors, nor events.</li>\n<li>Upgradability: All core contracts of the protocol maintained upgradabillity, with plans of future expansion &#x26; integration this should be a must.</li>\n</ul>\n<h3 id=\"4-level-of-documentation\" style=\"position:relative;\"><a href=\"#4-level-of-documentation\" aria-label=\"4 level of documentation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Level of Documentation</h3>\n<p>The documentation provided in the github repo was not extensive, although it’s understandable for such a small codebase. There was a link to <a href=\"https://blog.kelpdao.xyz/reimagine-restaking-with-rseth-developed-by-kelp-78b7a5ae1230\">their blog</a> with some additional information on more in-general subjects such as “What is restaking”, “What is EigenLayer” and such. That’s all good but I would have liked more techinical documentation about the project.</p>\n<h3 id=\"5-systemic--centralization-risks\" style=\"position:relative;\"><a href=\"#5-systemic--centralization-risks\" aria-label=\"5 systemic  centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Systemic &#x26; Centralization Risks</h3>\n<p><strong>5.1 Systemic Risks</strong></p>\n<p>Although the codebase is small, since this is the protocol’s first audit I wouldn’t be surprised if a few bugs arise, it is our goal to clear them. I would usually say there is always room for improvement codebase-wise but I belive the developers have done an excellent job here. The owner’s have stated that they intend to expand the codebase and conduct subsequent audits for the expansion which is great. Me and my teammate were able to uncover a few vulnerabilities and I am sure other auditors will come up with more stuff.</p>\n<ul>\n<li>Loss of value upon mint: Our team uncovered a vulnerability which if exploited could set the system up in such a way that the 2nd depositor’s minting value is significantly reduced. This is quite has quite a serious impact although potentially only possible for the 2nd depositor, even if the system currently has no <code>withdraw</code> functionality, it is still a major loss of <code>value</code>. The issue arises from the fact that the codebase\ndoes not use internal accounting during a crucial division to calculate the <code>rsETH</code> amount to mint, but instead takes the contracts’ balances. This opens the door for an attacker to simply donate/directly send value instead of going through the <code>deposit</code> function and sway the results.</li>\n<li>\n<p>Future integration with LSTs with less than 1e18 decimals: Our team uncovered a vulnerability based on the developer’s assumption that all LST tokens used as supported assets for the system will use 1e18 decimals. The developers communicated in a private discord thread that they are planning to add more supported LST assets in the future if EigenLayer expands. </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Gus — Yesterday at 6:38 PM</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">When Eigenlayer adds/accepts more LSTs, we will want to support those as well</span></span></code></pre>\n<p>If in the future additional assets are supported with a decimal of more/less than 1e18, the calculaction used in the for-loop at <code>LRTOracle::getRSETHPrice#L66</code> will return heavily skewed results and thus minting a way bigger/smaller amount than it should.</p>\n</li>\n</ul>\n<p><strong>5.2 Centralization Risks</strong></p>\n<p>Parts of the functionality of the system is locked behind priviliged-role access control modifiers, functions such as adding new supported assets, setting their deposit limits, increasing the node delegator count, pause/unpause of the protocol, transfer of funds between contracts and EigenLayer strategies and oracle integration.</p>\n<p>All of these are expected, except maybe letting users control how many of their funds, and when, are allocated to EigenLayer strategies. The codebase is still in a very early stage (especially seeing a <code>Withdraw</code> function is missing), and it might be in the plans of the developers to allow for such actions to be decided by the users, but as it stands right now, I feel like that part is rather centralized and an improvement to this would be to allow the users to choose.</p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-3\">High Risk Findings (3)</a></p>\n<ul>\n<li><a href=\"#h-01-possible-arbitrage-from-chainlink-price-discrepancy-\">[H-01] Possible arbitrage from Chainlink price discrepancy </a></li>\n<li><a href=\"#h-02-protocol-mints-less-rseth-on-deposit-than-intended\">[H-02] Protocol mints less rsETH on deposit than intended</a></li>\n<li><a href=\"#h-03-the-price-of-rseth-could-be-manipulated-by-the-first-staker\">[H-03] The price of rsETH could be manipulated by the first staker</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-2\">Medium Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#m-01-update-in-strategy-will-cause-wrong-issuance-of-shares\">[M-01] Update in strategy will cause wrong issuance of shares</a></li>\n<li><a href=\"#m-02-lack-of-slippage-control-on-lrtdepositpooldepositasset\">[M-02] Lack of slippage control on <code>LRTDepositPool.depositAsset</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#l-01-prevent-deposits-to-the-nodes-with-max-amount-of-assets-being-staked-already\">L-01 Prevent deposits to the nodes with max amount of assets being staked already</a></li>\n<li><a href=\"#l-02-set-the-price-feeds-during-an-initialization\">L-02 Set the price feeds during an initialization</a></li>\n<li><a href=\"#l-03-dropping-a-dust-to-grief-the-staking-process\">L-03 Dropping a dust to grief the staking process</a></li>\n<li><a href=\"#l-04-approve-to-strategymanager-during-an-initialization\">L-04 Approve to <code>StrategyManager</code> during an initialization</a></li>\n<li><a href=\"#l-05-enforce-maxnodedelegatorcount--nodedelegatorqueuelength\">L-05 Enforce <code>maxnodeDelegatorCount > nodeDelegatorQueue.length</code></a></li>\n<li><a href=\"#l-06-place-an-assertion-to-ensure-the-system-in-pausedunpaused-state\">L-06 Place an assertion to ensure the system in paused/unpaused state</a></li>\n<li><a href=\"#n-01-introduce-removenodedelegatorfromqueue\">N-01 Introduce <code>removeNodeDelegatorFromQueue</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-avoid-zero-to-non-zero-storage-writes\">G-01 Avoid zero to non-zero storage writes</a></li>\n<li><a href=\"#g-02-we-can-optimize-the-function-updatelrtconfig\">G-02 We can optimize the function <code>updateLRTConfig()</code></a></li>\n<li><a href=\"#g-03-emit-local-variables-instead-of-state-variablesnot-found-by-bot\">G-03 Emit local variables instead of state variables(not found by bot)</a></li>\n<li><a href=\"#g-04-dont-cache-callsvariables-if-using-them-once\">G-04 Don’t cache calls/variables if using them once</a></li>\n<li><a href=\"#g-05-caching-the-length-of-calldata-increases-gas-cost-instead-of-reducing-it\">G-05 Caching the length of calldata increases gas cost instead of reducing it</a></li>\n</ul>\n</li>\n<li><a href=\"#audit-analysis\">Audit Analysis</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}