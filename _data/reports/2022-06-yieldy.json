{
  "circa": {
    "title": "Yieldy contest",
    "sponsor": "Yieldy",
    "slug": "2022-06-yieldy",
    "date": "2022-09-27",
    "findings": "https://github.com/code-423n4/2022-06-yieldy-findings/issues",
    "contest": 139
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Yieldy smart contract system written in Solidity. The audit contest took place between June 21—June 26, 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>110 Wardens contributed reports to the Yieldy contest:</p>\n<ol>\n<li>Lambda</li>\n<li><a href=\"https://twitter.com/thePicodes\">Picodes</a></li>\n<li>0x1f8b</li>\n<li>0x52</li>\n<li>cccz</li>\n<li>unforgiven</li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/berndartmueller\">berndartmueller</a></li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li>BowTiedWardens (BowTiedHeron, BowTiedPickle, <a href=\"BowTiedETHernal\">m4rio_eth</a>, <a href=\"https://twitter.com/BowTiedDravee\">Dravee</a>, and BowTiedFirefox)</li>\n<li><a href=\"https://twitter.com/gallodasballo\">GalloDaSballo</a></li>\n<li>asutorufos</li>\n<li>sashik_eth</li>\n<li><a href=\"https://www.linkedin.com/in/minhquanym/\">minhquanym</a></li>\n<li>skoorch</li>\n<li><a href=\"https://twitter.com/WatchPug_\">WatchPug</a> (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>0x29A (0x4non and rotcivegaf)</li>\n<li>elprofesor</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li><a href=\"https://ericci.dev/\">StErMi</a></li>\n<li>pashov</li>\n<li><a href=\"https://twitter.com/shunduquar\">shung</a></li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li>0xNineDec</li>\n<li>zzzitron</li>\n<li>robee</li>\n<li>hake</li>\n<li>TrungOre</li>\n<li><a href=\"https://twitter.com/ankitparashar\">parashar</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li>kenta</li>\n<li>0x1337</li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>PwnedNoMore (<a href=\"https://www.cs.purdue.edu/homes/zhan3299/index.html\">izhuer</a>, ItsNio, and papr1ka2)</li>\n<li><a href=\"https://t.me/Road220\">m_Rassska</a></li>\n<li>0xDjango</li>\n<li>Metatron</li>\n<li>neumo</li>\n<li>reassor</li>\n<li>_Adam</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li><a href=\"https://www.reddit.com/user/FudgyDRS/\">FudgyDRS</a></li>\n<li>scaraven</li>\n<li>Bnke0x0</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://github.com/antoncoding\">antonttc</a></li>\n<li>GimelSec (<a href=\"https://twitter.com/rayn731\">rayn</a> and sces60107)</li>\n<li><a href=\"https://github.com/exd0tpy\">exd0tpy</a></li>\n<li>0xf15ers (remora and twojoy)</li>\n<li>Waze</li>\n<li>ladboy233</li>\n<li><a href=\"https://twitter.com/Sm4rty_\">Sm4rty</a></li>\n<li>Noah3o6</li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>Limbooo</li>\n<li>sikorico</li>\n<li>aga7hokakological</li>\n<li>delfin454000</li>\n<li>ElKu</li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li>Kaiziron</li>\n<li>simon135</li>\n<li>mics</li>\n<li>UnusualTurtle</li>\n<li>0xmint</li>\n<li><a href=\"https://www.linkedin.com/in/yahia-chaabane/\">ych18</a></li>\n<li>pedr02b2</li>\n<li>ajtra</li>\n<li><a href=\"Fabble#9308\">Fabble</a></li>\n<li>0xc0ffEE</li>\n<li>cryptphi</li>\n<li>dipp</li>\n<li>samruna</li>\n<li>ak1</li>\n<li><a href=\"http://seanseefried.org/blog\">sseefried</a></li>\n<li>PumpkingWok</li>\n<li>tchkvsky</li>\n<li>0xkatana</li>\n<li><a href=\"https://github.com/0xKitsune\">0xKitsune</a></li>\n<li>RedOneN</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li>Nyamcil</li>\n<li><a href=\"https://twitter.com/randyyramadhan\">Randyyy</a></li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li>saian</li>\n<li><a href=\"https://twitter.com/_0v3rf10w\">0v3rf10w</a></li>\n<li>ACai</li>\n<li>bardamu</li>\n<li>sach1r0</li>\n<li><a href=\"s3cunda.github.io\">s3cunda</a></li>\n<li>slywaters</li>\n<li><a href=\"https://twitter.com/0xheynacho\">ignacio</a></li>\n</ol>\n<p>This contest was judged by the Float Capital team: <a href=\"https://github.com/moose-code\">moose-code</a>, <a href=\"https://github.com/JasoonS\">JasoonS</a> &#x26; <a href=\"https://github.com/denhampreen\">denhampreen</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 31 unique vulnerabilities. Of these vulnerabilities, 4 received a risk rating in the category of HIGH severity and 27 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 70 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 70 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-06-yieldy\">C4 Yieldy contest repository</a>, and is composed of 5 smart contracts written in the Solidity programming language and includes 892 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-4\" style=\"position:relative;\"><a href=\"#high-risk-findings-4\" aria-label=\"high risk findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (4)</h1>\n<h2 id=\"h-01-no-withdrawal-possible-for-eth-toke-pool\" style=\"position:relative;\"><a href=\"#h-01-no-withdrawal-possible-for-eth-toke-pool\" aria-label=\"h 01 no withdrawal possible for eth toke pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/87\">[H-01] No withdrawal possible for ETH TOKE pool</a></h2>\n<p><em>Submitted by Lambda</em></p>\n<p>The <code>withdraw</code> function of the ETH Tokemak pool has an additional parameter <code>asEth</code>. This can be seen in the Tokemak <a href=\"https://github.com/Tokemak/tokemak-smart-contracts-public/blob/2f54689d5d16ddfd1751493b161a049d6c98c382/contracts/pools/EthPool.sol#L94\">Github repository</a> or also when looking at the deployed code of the <a href=\"https://etherscan.io/address/0xb104A7fA1041168556218DDb40Fe2516F88246d5#code\">ETH pool</a>. Compare that to e.g. the <a href=\"https://etherscan.io/address/0xca5e07804beef19b6e71b9db18327d215cd58d4e#code\">USDC pool</a>, which does not have this parameter.</p>\n<p>This means that the call to <code>withdraw</code> will when the staking token is ETH / WETH and no withdrawals would be possible.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>A new <code>Staking</code> contract with ETH / WETH as the staking token is deployed. Deposits in Tokemak work fine, so users stake their tokens. However, because of the previously described issue, no withdrawal is possible, leaving the funds locked.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Handle the case where the underlying asset is WETH / ETH separately and pass this boolean in that case.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/87\">toshiSat (Yieldy) confirmed and resolved</a></strong> </p>\n<hr>\n<h2 id=\"h-02-stakingsolstake-dos-by-staking-1-wei-for-the-recipient-when-warmupperiod--0\" style=\"position:relative;\"><a href=\"#h-02-stakingsolstake-dos-by-staking-1-wei-for-the-recipient-when-warmupperiod--0\" aria-label=\"h 02 stakingsolstake dos by staking 1 wei for the recipient when warmupperiod  0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/187\">[H-02] <code>Staking.sol#stake()</code> DoS by staking 1 wei for the recipient when <code>warmUpPeriod > 0</code></a></h2>\n<p><em>Submitted by WatchPug, also found by BowTiedWardens, cccz, minhquanym, parashar, pashov, shung, and zzzitron</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">warmUpPeriod</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// create a claim and mint tokens so a user can claim them once warm up has passed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">warmUpInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">Claim</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">credits:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">credits</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">creditsForTokenBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">expiry:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">warmUpPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>Staking.sol#stake()</code> is a public function and you can specify an arbitrary address as the <code>_recipient</code>.</p>\n<p>When <code>warmUpPeriod > 0</code>, with as little as 1 wei of <code>YIELDY_TOKEN</code>, the <code>_recipient</code>’s <code>warmUpInfo</code> will be push back til <code>epoch.number + warmUpPeriod</code>.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider changing to not allow deposit to another address when <code>warmUpPeriod > 0</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/187#issuecomment-1167621029\">Dravee (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Should be high right? Funds are locked.\nSee <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/245#issuecomment-1167616593\">https://github.com/code-423n4/2022-06-yieldy-findings/issues/245#issuecomment-1167616593</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/187#issuecomment-1198122754\">moose-code (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>Agree this should be high. The cost of the attack is negligible and could cause basic perpetual grievance on all users with one simple script. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/187\">toshiSat (Yieldy) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-03-denial-of-service-by-wrong-batchrequestsremoveaddress-logic\" style=\"position:relative;\"><a href=\"#h-03-denial-of-service-by-wrong-batchrequestsremoveaddress-logic\" aria-label=\"h 03 denial of service by wrong batchrequestsremoveaddress logic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/38\">[H-03] Denial of Service by wrong <code>BatchRequests.removeAddress</code> logic</a></h2>\n<p><em>Submitted by 0x1f8b, also found by rfa, berndartmueller, BowTiedWardens, csanuragjain, Lambda, neumo, and StErMi</em></p>\n<p><strong>Note: issues #<a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/283\">283</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/115\">115</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/82\">82</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/89\">89</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/61\">61</a>, and <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/241\">241</a> were originally broken out as a separate medium issue. Approximately 1 week after judging and awarding were finalized, the judging team re-assessed that these should have all been grouped under H-03. Accordingly, the 6 warden names have been added as submitters above.</strong></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L93\">https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L93</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L57\">https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L57</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L37\">https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L37</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The <code>BatchRequests.removeAddress</code> logic is wrong and it will produce a denial of service.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Removing the element from the array is done using the <code>delete</code> statement, but this is not the proper way to remove an entry from an array, it will just set that position to <code>address(0)</code>.</p>\n<p>Append dummy data:</p>\n<ul>\n<li><code>addAddress('0x0000000000000000000000000000000000000001')</code></li>\n<li><code>addAddress('0x0000000000000000000000000000000000000002')</code></li>\n<li><code>addAddress('0x0000000000000000000000000000000000000003')</code></li>\n<li><code>getAddresses()</code> => <code>address[]: 0x0000000000000000000000000000000000000001,0x0000000000000000000000000000000000000002,0x0000000000000000000000000000000000000003</code></li>\n</ul>\n<p>Remove address:</p>\n<ul>\n<li><code>removeAddress(0x0000000000000000000000000000000000000002)</code> (or <code>0x0000000000000000000000000000000000000003</code>)</li>\n<li><code>getAddresses()</code> => <code>address[]: 0x0000000000000000000000000000000000000001,0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000003</code></li>\n</ul>\n<p>Service is denied because it will try to call <code>canBatchContracts</code>  to <code>address(0)</code>.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>To remove an entry in an array you have to use <code>pop</code> and move the last element to the removed entry position.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/38\">0xean (Yieldy) confirmed and resolved</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/38#issuecomment-1199272074\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree this is high, if the team (owner) didn’t know this they could cause some issues for sure.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-yield-of-liquidityreserve-can-be-stolen\" style=\"position:relative;\"><a href=\"#h-04-yield-of-liquidityreserve-can-be-stolen\" aria-label=\"h 04 yield of liquidityreserve can be stolen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/164\">[H-04] Yield of <code>LiquidityReserve</code> can be stolen</a></h2>\n<p><em>Submitted by Picodes</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L126\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L126</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L176\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L176</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L206\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L206</a></p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Using sandwich attacks and JIT (Just-in-time liquidity), the yield of <code>LiquidityReserve</code> could be extracted for liquidity providers.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The yield of <code>LiquidityReserve</code> is distributed when a user calls <code>instantUnstakeReserve()</code> in <code>Staking</code>. Then, in <code>instantUnstake</code>, <code>totalLockedValue</code> increases with the fee paid by the user withdrawing. The fee is shared between all liquidity providers as they all see the value of their shares increase.</p>\n<p>Therefore, an attacker could do the following sandwich attack when spotting a call to <code>instantUnstakeReserve()</code>.</p>\n<ul>\n<li>In a first tx before the user call, borrow a lot of <code>stakingToken</code> and <code>addLiquidity</code></li>\n<li>The user call to <code>instantUnstakeReserve()</code> leading to a fee of say<code>x\\</code></li>\n<li>In a second tx after the user call, <code>removeLiquidity</code> and repay the loan, taking a large proportion of the user fee</li>\n</ul>\n<p>The problem here is that you can instantly add and remove liquidity without penalty, and that the yield is instantly distributed.</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>To mitigate this, you can</p>\n<ul>\n<li>store the earned fees and distribute them across multiple blocks to make sure the attack wouldn’t be worth it</li>\n<li>add a small fee when removing liquidity, which would make the attack unprofitable</li>\n<li>prevent users from withdrawing before X blocks or add a locking mechanism</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1167971720\">0xean (Yieldy) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>This is not unique to the protocol and is a vulnerability in almost all of the LP designs that are prevalent today. There is no loss of user funds here either.</p>\n<p>Would downgrade to Low or QA.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1169363435\">Picodes (warden) commented</a>:</strong></p>\n<blockquote>\n<p>In standard cases of JIT, for example in a DEX, the attacker takes a risk as the liquidity he adds is used during the swap, and this liquidity is useful for the protocol as leads to a better price for the user, which is not the case here</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1169371024\">0xean (Yieldy) commented</a>:</strong></p>\n<blockquote>\n<p>@Picodes - that is fair but the liquidity is still useful and I still don’t see how this qualifies as high severity.  Eventually it would mean that the liquidity reserve would need less liquidity parked in it if JITers always where hitting it. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1169551914\">Picodes (warden) commented</a>:</strong></p>\n<blockquote>\n<p>To me it’s high because: (correct me if I am missing things)</p>\n<ul>\n<li>JIT is not useful here at all for the protocol, the liquidity they bring is not useful as does not get locked. It’s totally risk free, and as you said it’s a commun attack so it’s likely that someone uses it</li>\n<li>It leads to a loss of LP funds:\nAssume there is 100k unlocked in the pool, and someone <code>instantUnstake</code> 100k, it’ll lock all the LP liquidity. But if someone JITs this, the fees will go to the attacker and not the LP which provided the service by accepting to have its liquidity locked. </li>\n<li>From a protocol point of view, LPing becomes unattractive as all the fees are stolen, breaking the product design</li>\n</ul>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1201261638\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree going to leave this as high. Any whale that does a large unstake will be susceptible to having more of the fee’s eroded to a predatory sandwich attack which provides no value to the system. </p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-27\" style=\"position:relative;\"><a href=\"#medium-risk-findings-27\" aria-label=\"medium risk findings 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (27)</h1>\n<h2 id=\"m-01-unsecure-transferfrom\" style=\"position:relative;\"><a href=\"#m-01-unsecure-transferfrom\" aria-label=\"m 01 unsecure transferfrom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/36\">[M-01] Unsecure <code>transferFrom</code></a></h2>\n<p><em>Submitted by 0x1f8b, also found by 0xNineDec and StErMi</em></p>\n<p>The security of the <code>Yieldy</code> contract is delegated to the compiler used.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>allowance</code> of an account does not have to reflect the real balance of an account, however in the <code>transferFrom</code> method, it is the value that is checked in order to verify that the user has enough balance to make the transfer.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_value</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_allowances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] &gt;= </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Allowance too low&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>However, the real balance of the <code>Yieldy</code> contract is based on the calculation made by the <code>creditsForTokenBalance</code> method, so an underflow could be made in the subtraction of the balance of the <code>from</code> account.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">creditAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">creditsForTokenBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">creditBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">creditBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">creditAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">creditBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">creditBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_to</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">creditAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>This means that the security of the contract is delegated to the checks added by the compiler depending on the pragma used, it must be taken into account that these checks may appear and disappear in future versions of the compiler, so they must be checked at the level of smart contracts.</p>\n<p>Affected source code:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/8400e637d9259b7917bde259a5a2fbbeb5946d45/src/contracts/Yieldy.sol#L212\">Yieldy.sol#L212</a></li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ul>\n<li>Check that the from account has a <code>creditAmount</code> balance.</li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/36#issuecomment-1199930909\">toshiSat (Yieldy) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Looking into this, the balance isn’t calculated through the <code>creditsForTokenBalance</code> method, it’s calculated through the <code>balanceOf</code> method, which in this case the functionality is correct.  We aren’t transferring credits, we are transferring the value and adding to the credits.  Allowance is for value amounts, not credits, also balance can only go up against credits, so if the balance is valid then credits are inherently valid too.  I’m unsure of what to label this as, because we do need to check to see if the user has the correct balance.  I feel like this issue is partially correct.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/36#issuecomment-1199933589\">toshiSat (Yieldy) resolved</a>:</strong></p>\n<blockquote>\n<p><a href=\"https://github.com/shapeshift/foxy/pull/130/files\">https://github.com/shapeshift/foxy/pull/130/files</a> for the fix.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-its-possible-to-perform-dos-and-fund-lose-in-stacking-by-transferring-tokens-directly-to-contract-\" style=\"position:relative;\"><a href=\"#m-02-its-possible-to-perform-dos-and-fund-lose-in-stacking-by-transferring-tokens-directly-to-contract-\" aria-label=\"m 02 its possible to perform dos and fund lose in stacking by transferring tokens directly to contract  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/246\">[M-02] It’s possible to perform DOS and fund lose in Stacking by transferring tokens directly to contract </a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L78-L102\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L78-L102</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L698-L719\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L698-L719</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L401-L417\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L401-L417</a></p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Function <code>rebase()</code> in contract <code>Staking</code> calls <code>Yieldy.rebase(profit, )</code> and <code>Yieldy.rebase(profit, )</code> would revert if <code>rebasingCredits / updatedTotalSupply</code> was equal to <code>0</code>. it’s possible to transfer some <code>STAKING_TOKEN</code> directly to <code>Stacking</code> contract before or after deployment of <code>Staking</code> and make <code>rebasingCredits / updatedTotalSupply</code> equal to <code>0</code>, and then most of the functionalities of <code>Staking</code> would not work because they call <code>rebase()</code> which will revert.\nit’s possible to perform this DOS for any token by transferring some tokens <code>STAKING_TOKEN</code> to contract address and then staking <code>1 wei</code> in contract.\nor for tokens with low precisions and low price it’s even possible to perform when <code>totalSupply()</code> of <code>Yieldy</code> is low.</p>\n<p>Also attacker can only make <code>rebasingCredits / updatedTotalSupply</code>  too low and so rounding error would be significant when <code>rebasingCredits / updatedTotalSupply</code>  gets too low and users funds would be lost because of rounding error.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>rebase()</code> code in <code>Yieldy</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function rebase(uint256 _profit, uint256 _epoch)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        onlyRole(REBASE_ROLE)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 currentTotalSupply = _totalSupply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(_totalSupply &gt; 0, &quot;Can&#39;t rebase if not circulating&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_profit == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            emit LogSupply(_epoch, block.timestamp, currentTotalSupply);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            emit LogRebase(_epoch, 0, getIndex());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 updatedTotalSupply = currentTotalSupply + _profit;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (updatedTotalSupply &gt; MAX_SUPPLY) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                updatedTotalSupply = MAX_SUPPLY;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rebasingCreditsPerToken = rebasingCredits / updatedTotalSupply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(rebasingCreditsPerToken &gt; 0, &quot;Invalid change in supply&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _totalSupply = updatedTotalSupply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _storeRebase(updatedTotalSupply, _profit, _epoch);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see if <code>rebasingCredits / updatedTotalSupply == 0</code> then the code will revert. <code>updatedTotalSupply</code> is equal to <code>_totalSupply + _profit</code> and <code>rebasingCredits</code>  is <code>wad</code> in the first.\n<code>Yieldy.rebase(profit,)</code> is called by <code>Staking.rebase()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function rebase() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // we know about the issues surrounding block.timestamp, using it here will not cause any problems</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (epoch.endTime &lt;= block.timestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IYieldy(YIELDY_TOKEN).rebase(epoch.distribute, epoch.number);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.endTime = epoch.endTime + epoch.duration;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.timestamp = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.number++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 balance = contractBalance();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 staked = IYieldy(YIELDY_TOKEN).totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (balance &lt;= staked) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                epoch.distribute = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                epoch.distribute = balance - staked;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see the value of <code>_profit</code> is set to <code>epoch.distribute</code> which is <code>contractBalance() - IYieldy(YIELDY_TOKEN).totalSupply()</code> and <code>contractBalance()</code> is sum of <code>STAKING_TOKEN</code> and <code>TOKE</code> balance of <code>Staking</code> contract. so if attacker transfers <code>X</code> amount of <code>STAKCING_TOKEN</code> directly to <code>Staking</code> contract then the value of <code>_profit</code> which is going to send to <code>Yieldy.rebase(profit,)</code> would be higher than <code>X</code>. to exploit this attacker call <code>stake(1 wei)</code> after <code>Staking</code> deployment and then transfer <code>STAKING_TOKEN</code> directly to contract. then the value of <code>rebasingCredits</code> in <code>Yieldy</code> would be <code>2 wad</code> and the value of <code>_profit</code> sent to <code>Yieldy.rebase(profit,)</code> would be bigger than <code>2 wad</code> and <code>rebasingCredits / updatedTotalSupply</code> would be <code>0</code> and from now on all calls to <code>Staking.rebase()</code> would revert and that means functions <code>Stake()</code> and <code>instantUnstakeReserve()</code> and <code>instantUnstakeCurve()</code> wouldnt work anymore.</p>\n<p>It’s possible to perform this attack for low precision tokens with low price <code>STAKING_TOKEN</code> too. the only thing attacker needs to do is that in early stage of <code>Staking</code> deployment sends more than <code>rebasingCredits</code> of <code>STAKING_TOKEN</code> token directly to <code>Staking</code> contract address. then in <code>rebase()</code> contract send that amount as <code>profit</code> to <code>Yieldy.rebase()</code> and that call would revert which will cause most of the logics of <code>Staking</code> to revert and not work.</p>\n<p>and when <code>rebasingCredits / updatedTotalSupply</code>  is low, the rounding error would be high enough that the compounding yield won’t show itself. attacker can make <code>rebasingCredits / updatedTotalSupply</code>  too low but not <code>0</code> and from then user’s funds would be lost because of rounding error (wrong number of <code>Yieldy</code> token would be mint for user).</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h4 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>The default initial value of <code>rebasingCredits</code> should be very high that attacker couldn’t perform this attack.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/246#issuecomment-1199950701\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p><code>rebasingCredits</code> is in credits and <code>updatedTotalSupply</code> is in token amounts.  So if even a small amount is staked, the attacker will have to send a large amount to go through with this attack vector for no financial gain.</p>\n<p>This seems like a low priority issue mainly because user funds won’t get lost as if this were to occur then most likely no one has staked and the worst case scenario we will redeploy the contract.\nAlso, we will be staking on every yieldy as we deploy.</p>\n<p>I think we would like to eventually solve this, but for now this seems like it won’t fall in our list of fixes for this iteration. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/246#issuecomment-1230559924\">JasoonS (judge) decreased severity to Medium</a>:</strong></p>\n<blockquote>\n<p>Downgrading to medium.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-minterburnerrole-can-burn-any-amount-of-yieldy-from-an-arbitrary-address\" style=\"position:relative;\"><a href=\"#m-03-minterburnerrole-can-burn-any-amount-of-yieldy-from-an-arbitrary-address\" aria-label=\"m 03 minterburnerrole can burn any amount of yieldy from an arbitrary address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/43\">[M-03] MINTER<em>BURNER</em>ROLE can burn any amount of Yieldy from an arbitrary address</a></h2>\n<p><em>Submitted by 0x1f8b</em></p>\n<p>Using the <code>burn()</code> function of <code>Yieldy</code>, an address with <code>MINTER_BURNER_ROLE</code> can burn an arbitrary amount of tokens from any address.</p>\n<p>We believe this is unnecessary and poses a serious centralization risk.</p>\n<p>A malicious or compromised <code>MINTER_BURNER_ROLE</code> address can take advantage of this.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider removing the <code>MINTER_BURNER_ROLE</code> and change <code>burn()</code> function to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_msgSender</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/43#issuecomment-1197442641\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>There’s tons of centralization risks already, this is acknowledged, but for yieldies to work, there needs to be a trusted party.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/43#issuecomment-1230571763\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Leaving as medium - the code can be upgraded but the code is being assessed as is.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-arbitrage-on-stake\" style=\"position:relative;\"><a href=\"#m-04-arbitrage-on-stake\" aria-label=\"m 04 arbitrage on stake permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/243\">[M-04] Arbitrage on <code>stake()</code></a></h2>\n<p><em>Submitted by BowTiedWardens, also found by WatchPug</em></p>\n<p>Issue: there is a huge arb opportunity for people who deposit 1 block before the <code>rebase()</code>.</p>\n<p>Consequences: then they can call <code>instantUnstakeReserve</code> or <code>instantUnstakeCurve</code> to unstake the staked amount, in this way the profit that needs to be distributed on the next rebase increases, he also messes up the rewards for the other holders as the <code>instantUnstakeReserve</code> does not burn the <code>YIELD_TOKEN</code>. Even if there is a fee on the <code>instantUnstakeReserve</code>, there is still a chance for profit.</p>\n<p><strong>Affected Code</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">406</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> { </span><span class=\"mtk3\">// @audit-info [HIGH] </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">407</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// if override staking, then don&#39;t allow stake</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">408</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">isStakingPaused</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Staking is paused&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">409</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// amount must be non zero</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">410</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have valid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">411</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">412</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yieldyTotalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">413</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">414</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// Don&#39;t rebase unless tokens are already staked or could get locked out of staking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">415</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">yieldyTotalSupply</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">416</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">rebase</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">417</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">418</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">419</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">STAKING_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">420</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">421</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">422</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">_amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">423</span><span class=\"mtk1\">:         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">424</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">425</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">Claim</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">info</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">warmUpInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">426</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">427</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// if claim is available then auto claim tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">428</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">_isClaimAvailable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">429</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">430</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">431</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">432</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">_depositToTokemak</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">433</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">434</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// skip adding to warmup contract if period is 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">435</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">warmUpPeriod</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">436</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">437</span><span class=\"mtk1\">:         } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">438</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// create a claim and mint tokens so a user can claim them once warm up has passed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">439</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">warmUpInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">Claim</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">440</span><span class=\"mtk12\">:</span><span class=\"mtk1\">                 </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">: </span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">441</span><span class=\"mtk12\">:</span><span class=\"mtk1\">                 </span><span class=\"mtk12\">credits</span><span class=\"mtk1\">: </span><span class=\"mtk12\">info</span><span class=\"mtk1\">.</span><span class=\"mtk12\">credits</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">442</span><span class=\"mtk1\">:                     </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">creditsForTokenBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">443</span><span class=\"mtk12\">:</span><span class=\"mtk1\">                 </span><span class=\"mtk12\">expiry</span><span class=\"mtk1\">: </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">warmUpPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">444</span><span class=\"mtk1\">:             });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">445</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">446</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">447</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">448</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">449</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">sendWithdrawalRequests</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">450</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Burn the <code>YIELD_TOKEN</code> amount in the <code>instantUnstakeReserve</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/243#issuecomment-1167959404\">0xean (Yieldy) acknowledged, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Yes, the fee on instant Unstake needs to be set high enough to make this not profitable. </p>\n<p>If a curve pool exists, then this does become possible to arb the rebase and something that should be fixed, potentially with not allowing the warm up period to be violated for instant unstaking (through curve at the very least). </p>\n<p>I would qualify this as Medium severity, and leaking value. </p>\n<p><code>2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/243#issuecomment-1230560050\">JasoonS (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I took another look, medium seems reasonable too.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-possible-dos-out-of-gas-on-loops\" style=\"position:relative;\"><a href=\"#m-05-possible-dos-out-of-gas-on-loops\" aria-label=\"m 05 possible dos out of gas on loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/94\">[M-05] Possible DOS (out-of-gas) on loops.</a></h2>\n<p><em>Submitted by 0x29A, also found by minhquanym</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L16\">https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L16</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L36\">https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L36</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L91\">https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L91</a></p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>It is possible to get an out-of-gas issue while iterating the for loop.</p>\n<p>Please take a look at <a href=\"https://github.com/wissalHaji/solidity-coding-advices/blob/master/best-practices/be-careful-with-loops.md\">this link</a>.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let’s say I want to run the function on <a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L14\"><code>BatchRequests.sol#L14</code></a> and I got a lot of <a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L9\"><code>contracts</code></a> pending for withdrawal.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use this pattern;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> sendWithdrawalRequests on all addresses in contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sendWithdrawalRequests</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractsLength</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">contractsLength</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid from&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">contractsLength</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid to&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">from</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">to</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">canBatchTransactions</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">sendWithdrawalRequests</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/94\">0xean (Yieldy) acknowledged</a></strong> </p>\n<hr>\n<h2 id=\"m-06-user-can-initiate-withdraw-for-previous-epoch-if-rebase-hasnt-been-called-since-end-of-epoch\" style=\"position:relative;\"><a href=\"#m-06-user-can-initiate-withdraw-for-previous-epoch-if-rebase-hasnt-been-called-since-end-of-epoch\" aria-label=\"m 06 user can initiate withdraw for previous epoch if rebase hasnt been called since end of epoch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/28\">[M-06] User can initiate withdraw for previous epoch if rebase hasn’t been called since end of epoch</a></h2>\n<p><em>Submitted by 0x52</em></p>\n<p>User is able to withdraw unstaked asset sooner than they should be.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>Unstake()</code> allows the user to bypass the rebase() call by setting _trigger to false. Since rebase() is bypassed, epoch.number could potentially be stale i.e. doesn’t match the Tokemak epoch. A user could potentially call unstake() with _trigger = false immediately after an epoch has ended but expiry would be set using the stale epoch.number because it wouldn’t be updated by rebase(). This would allow the user to withdraw early before their funds were actually available in the contract because their withdrawal would be considered to be in the epoch before they actually initiated the withdrawal.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>Rebase()</code> cannot be optional when calling unstake.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/28#issuecomment-1168978499\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We use a coolDownAmount of 2 to get around this.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-withdrawals-initiated-after-cycle-withdrawal-request-wont-be-withdrawn-in-the-correct-cycle\" style=\"position:relative;\"><a href=\"#m-07-withdrawals-initiated-after-cycle-withdrawal-request-wont-be-withdrawn-in-the-correct-cycle\" aria-label=\"m 07 withdrawals initiated after cycle withdrawal request wont be withdrawn in the correct cycle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/29\">[M-07] Withdrawals initiated after cycle withdrawal request won’t be withdrawn in the correct cycle</a></h2>\n<p><em>Submitted by 0x52, also found by IllIllI</em></p>\n<p>Some user withdrawals won’t be available for withdrawal even though it should be.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>sendWithdrawalRequest</code> can only happen once per cycle. canBatchTransactions (L386) must return true for the actual withdrawal request to happen. It checks in L362 that currentCycleIndex > lastTokeCycleIndex and in L397 of sendWithdrawlRequest, lastTokeCycleIndex = currentCycleIndex. This means that for the rest of the cycle, canBatchTransactions will return false. This means that if a user requests a withdrawal towards the end of epoch after the withdrawal has been submitted but before the end of the epoch, their withdrawal will be set to the current epoch but the actual token amount of their withdrawal won’t be processed. This will lead to a discrepancy between the number of tokens withdrawn and the number of tokens allowed to be withdrawn by users, which means that not all users who are “eligible” for withdrawal will actually be able to withdraw because there won’t be enough tokens for everyone.</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The requirement in L362 should be removed. As noted in the contract, “TOKE’s requestWithdrawal overwriting the amount if you call it more than once per cycle”. Overwriting the withdrawal is perfectly okay though because it already uses requestWithdrawalAmount which is a cumulative measure of the tokens that need to be withdrawn because it is only decreased when the asset it actually received from a withdrawal.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/29#issuecomment-1168976944\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We get around this by having a coolDownPeriod of 2.  It saves on gas and we only have to call <code>sendWithdrawalRequest</code> once per cycle.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-rebases-can-be-frontrun-with-very-little-token-downtime-even-when-warmupperiod--0\" style=\"position:relative;\"><a href=\"#m-08-rebases-can-be-frontrun-with-very-little-token-downtime-even-when-warmupperiod--0\" aria-label=\"m 08 rebases can be frontrun with very little token downtime even when warmupperiod  0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/31\">[M-08] Rebases can be frontrun with very little token downtime even when warmUpPeriod > 0</a></h2>\n<p><em>Submitted by 0x52, also found by elprofesor</em></p>\n<p>Rebases can be frontrun with very little token downtime even when <code>warmUpPeriod > 0</code>.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L415-L417\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L415-L417</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L703\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L703</a></p>\n<p>A user can call stake the block before epoch.endTime &#x3C;= block.timestamp, allowing the user to bypass the forced rebase called in L416 of the the stake function. If warmUpPeriod > 0 then the user will receive a “warmUpInfo” with the value of their deposit. The very next block, the user can then call instantUnstakeCurve.</p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L600-L627\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L600-L627</a></p>\n<p>This will call rebase again in L633 and this time epoch.endTime &#x3C;= block.timestamp will be true and it will trigger an actual rebase, distributing the pending rewards. _retrieveBalanceFromUser (L617) will then allows the user to unstake all the funds locked in warm up. The issue is that when unstaking it uses userWarmInfo.credits meaning that any rebalance rewards are kept. This allows the user to get in, collect the rebase, then immediately get out.</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Being able to unstake tokens even when in the warm up period is a useful feature but tokens unstaked during that period should not be allowed to accumulate any rebases or it can lead to situations like this. L537-L539 should be changed to:\n<code>warmUpBalance = userWarmInfo.amount</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/226\">toshiSat (Yieldy) acknowledged</a></strong> </p>\n<hr>\n<h2 id=\"m-09-users-of-migrationsol-may-forfeit-rebase-rewards\" style=\"position:relative;\"><a href=\"#m-09-users-of-migrationsol-may-forfeit-rebase-rewards\" aria-label=\"m 09 users of migrationsol may forfeit rebase rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/33\">[M-09] Users of Migration.sol may forfeit rebase rewards</a></h2>\n<p><em>Submitted by 0x52, also found by berndartmueller</em></p>\n<p>Users of <code>moveFundsToUpgradedContract()</code> in migration.sol may forfeit rebase rewards.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>L54 calls instantUnstake(false) meaning that it skips the optional rebase. If there is a pending rebase then the user calling the function will not get this rebase and miss out on potential rewards.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add an input bool <code>\\_trigger</code> then add the following code to the start of the function:</p>\n<p>if (_trigger) {\nrebase();\n}</p>\n<p>This allows users to optionally call rebase if they are concerned about losing pending rebase rewards.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/33\">0xean (Yieldy) acknowledged</a></strong> </p>\n<hr>\n<h2 id=\"m-10-no-way-to-set-curve_pool-approval-after-setting-new-curve-pool-address\" style=\"position:relative;\"><a href=\"#m-10-no-way-to-set-curve_pool-approval-after-setting-new-curve-pool-address\" aria-label=\"m 10 no way to set curve_pool approval after setting new curve pool address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/165\">[M-10] No way to set CURVE_POOL approval after setting new curve pool address</a></h2>\n<p><em>Submitted by 0xDjango, also found by BowTiedWardens, cccz, hansfriese, Metatron, shung, ych18, and zzzitron</em></p>\n<p><code>Staking.setCurvePool()</code> allows the owner to set a new <code>CURVE_POOL</code> address, however, there is no way to set token approvals to the new address. The only calls to <code>token.approve()</code> are found in the constructor. Therefore, there’s no true way to set a new curve pool. All calls to <code>ICurvePool(CURVE_POOL).exchange()</code> will fail.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Set approvals for the new curve pool address in the same <code>setCurvePool()</code> function.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/165\">0xean (Yieldy) acknowledged</a></strong> </p>\n<hr>\n<h2 id=\"m-11-burn-access-control-can-be-bypassed\" style=\"position:relative;\"><a href=\"#m-11-burn-access-control-can-be-bypassed\" aria-label=\"m 11 burn access control can be bypassed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/169\">[M-11] Burn access control can be bypassed</a></h2>\n<p><em>Submitted by pashov, also found by csanuragjain, hake, kenta, m_Rassska, and oyc_109</em></p>\n<p><code>transferFrom</code> method does not check if <code>_to</code> argument is the zero address.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>This can lead to token burns without calling the <code>burn</code> function, which has access control <code>onlyRole(MINTER_BURNER_ROLE)</code> but here this can be bypassed by passing the zero address as the value of <code>_to</code>.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a non-zero address check for <code>_to</code> argument in <code>transferFrom</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/206\">toshiSat (Yieldy) confirmed and resolved</a></strong> </p>\n<hr>\n<h2 id=\"m-12-inconsistent-balance-when-fee-on-transfer-tokens\" style=\"position:relative;\"><a href=\"#m-12-inconsistent-balance-when-fee-on-transfer-tokens\" aria-label=\"m 12 inconsistent balance when fee on transfer tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/234\">[M-12] Inconsistent balance when fee-on transfer tokens.</a></h2>\n<p><em>Submitted by asutorufos</em></p>\n<p>There are ERC20 tokens that may make certain customizations to their ERC20 contracts.</p>\n<p>One type of these tokens is deflationary tokens that charge a certain fee for every <code>transfer()</code> or <code>transferFrom()</code>.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/Staking.sol#:~:text=Invalid%20address%22)%3B-,uint256%20totalTokeAmount%20%3D%20IERC20Upgradeable(TOKE_TOKEN).balanceOf(,)%3B,-%7D\">https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/Staking.sol#:~:text=Invalid%20address%22)%3B-,uint256%20totalTokeAmount%20%3D%20IERC20Upgradeable(TOKE_TOKEN).balanceOf(,)%3B,-%7D</a></p>\n<p>When <code>IERC20Upgradeable(TOKE_TOKEN)</code> get set to <code>totalTokeAmount</code> it will be different once <code>safetransfer</code> have fees as some types of tokens may charge a certain fee for transfer and transferfrom.</p>\n<p>It may be better to get the before balance then <code>safetransferfrom</code> then get the after balance to make sure no fees were added.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/234#issuecomment-1198545807\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We will not support deflationary tokens.  We will document this.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-13-sending-batch-withdrawal-requests-can-possibly-dos\" style=\"position:relative;\"><a href=\"#m-13-sending-batch-withdrawal-requests-can-possibly-dos\" aria-label=\"m 13 sending batch withdrawal requests can possibly dos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/280\">[M-13] Sending batch withdrawal requests can possibly DoS</a></h2>\n<p><em>Submitted by berndartmueller</em></p>\n<p>The function <code>BatchRequests.sendWithdrawalRequests</code> allows calling the <code>sendWithdrawalRequests</code> function on all of the Yieldy contracts at once. However, due to the unbounded <code>for</code> loop, if many Yieldy contracts are added to <code>contracts</code>, this function can potentially DoS due to reaching the block gas limit.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/BatchRequests.sol#L14-L27\">BatchRequests.sendWithdrawalRequests</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sendWithdrawalRequests</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractsLength</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">contractsLength</span><span class=\"mtk1\">; ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">canBatchTransactions</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">sendWithdrawalRequests</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">unchecked</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended mitigation steps</h3>\n<p>Add <code>offset</code> and <code>limit</code> function parameters to implement a “paginated” for loop.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/280#issuecomment-1167783591\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Only the owner of the contract can add addresses to the contract.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/280#issuecomment-1198077126\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Hmm, would consider making this Low. But keeping it medium highlights the importance to be aware of this.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-14-incorrect-rebase-percentage-calculation\" style=\"position:relative;\"><a href=\"#m-14-incorrect-rebase-percentage-calculation\" aria-label=\"m 14 incorrect rebase percentage calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/52\">[M-14] Incorrect rebase percentage calculation</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p><strong>Note: this issue had originally been grouped with M-15. Approximately 1 week after judging and awarding were finalized, the judging team re-assessed that this issue should have been classified as a unique issue. It has been broken out here accordingly.</strong></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/Yieldy.sol#L91\">https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/Yieldy.sol#L91</a></p>\n<p>It was observed that if updatedTotalSupply > MAX<em>SUPPLY then updatedTotalSupply becomes MAX</em>SUPPLY. This means _profit amount is not fully used. But _storeRebase function is still called with _profit amount.</p>\n<p>This becomes a problem since _storeRebase function caluclates rebasePercent using this incorrect _profit amount.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>REBASE_ROLE calls rebase function with say profit 10. Assume currentTotalSupply is 90</li>\n<li>updatedTotalSupply is calculated as updatedTotalSupply = currentTotalSupply + _profit. Thus updatedTotalSupply becomes 90+10=100</li>\n<li>Assume MAX<em>SUPPLY is 91. Since updatedTotalSupply>MAX</em>SUPPLY so updatedTotalSupply is updated to be 91</li>\n<li>Now _storeRebase function is called with updatedTotalSupply (91), _profit(10)</li>\n<li>This is incorrect since 10 amount from _profit is not utilized and only 1 amount is utilized. This becomes a problem in rebasePercent calculation where it is calculated on full 10 amount instead of 1</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use below:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (updatedTotalSupply &gt; MAX_SUPPLY) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_profit=_profit - (updatedTotalSupply-MAX_SUPPLY);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                updatedTotalSupply = MAX_SUPPLY;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/52#issuecomment-1168079367\">toshiSat (Yieldy) acknowledged and commented</a>:</strong> </p>\n<blockquote>\n<p>Max Supply is nearly the max amount in uint256. The protection is there, but will most likely never hit.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/52#issuecomment-1200224474\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Potentially, this should be a medium issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/52#issuecomment-1230560266\">JasoonS (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Downgrading to medium</p>\n</blockquote>\n<hr>\n<h2 id=\"m-15-token-transfers-in-liquidityreserve-and-staking-contract-dont-support-deflationary-erc20-tokens-and-user-funds-can-be-lost-if-stacking-token-was-deflationary\" style=\"position:relative;\"><a href=\"#m-15-token-transfers-in-liquidityreserve-and-staking-contract-dont-support-deflationary-erc20-tokens-and-user-funds-can-be-lost-if-stacking-token-was-deflationary\" aria-label=\"m 15 token transfers in liquidityreserve and staking contract dont support deflationary erc20 tokens and user funds can be lost if stacking token was deflationary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/222\">[M-15] token transfers in LiquidityReserve and Staking contract don’t support deflationary ERC20 tokens, and user funds can be lost if stacking token was deflationary</a></h2>\n<p><em>Submitted by unforgiven, also found by hake, robee, and TrungOre</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L419-L445\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L419-L445</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L120-L126\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L120-L126</a></p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If the token is deflationary then contract will receive less token that requested <code>amount</code> but contract don’t check for the real transferred amount. because this is happening in receiving <code>stacking_token</code> in <code>addLiquidity()</code> of <code>LiquidityReserve</code> and <code>stake()</code> of <code>Staking</code> then those logics for minting <code>YIELDY_TOKEN</code> or <code>LP</code> token is wrong. (contract receive less than <code>amount</code> but mint or transfer <code>amount</code> to user). This can cause other users which staked to lose funds.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is the related code where transfer happens (<code>stake()</code> and <code>addLiquidity()</code>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function stake(uint256 _amount, address _recipient) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // if override staking, then don&#39;t allow stake</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(!isStakingPaused, &quot;Staking is paused&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // amount must be non zero</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(_amount &gt; 0, &quot;Must have valid amount&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 yieldyTotalSupply = IYieldy(YIELDY_TOKEN).totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Don&#39;t rebase unless tokens are already staked or could get locked out of staking</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (yieldyTotalSupply &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rebase();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20Upgradeable(STAKING_TOKEN).safeTransferFrom(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Claim storage info = warmUpInfo[_recipient];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // if claim is available then auto claim tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_isClaimAvailable(_recipient)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            claim(_recipient);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _depositToTokemak(_amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // skip adding to warmup contract if period is 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (warmUpPeriod == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IYieldy(YIELDY_TOKEN).mint(_recipient, _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // create a claim and mint tokens so a user can claim them once warm up has passed</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            warmUpInfo[_recipient] = Claim({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                amount: info.amount + _amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                credits: info.credits +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    IYieldy(YIELDY_TOKEN).creditsForTokenBalance(_amount),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                expiry: epoch.number + warmUpPeriod</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IYieldy(YIELDY_TOKEN).mint(address(this), _amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function addLiquidity(uint256 _amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(isReserveEnabled, &quot;Not enabled yet&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 stakingTokenBalance = IERC20Upgradeable(stakingToken).balanceOf(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 rewardTokenBalance = IERC20Upgradeable(rewardToken).balanceOf(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 lrFoxSupply = totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 coolDownAmount = IStaking(stakingContract)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .coolDownInfo(address(this))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 totalLockedValue = stakingTokenBalance +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardTokenBalance +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            coolDownAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountToMint = (_amount * lrFoxSupply) / totalLockedValue;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20Upgradeable(stakingToken).safeTransferFrom(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mint(msg.sender, amountToMint);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see contract transfers <code>amount</code> of <code>STAKE_TOKEN</code> and assumes it is going to receive that amount and then mint the same <code>amount</code> of <code>YIELDY_TOKEN</code> or <code>LP</code> token.\nSo user receive more funds which belongs to other users. protocol logics are not suitable for deflationary tokens and funds would be lost.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check the real amount of tokens that the contract receives.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/222#issuecomment-1198543234\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We will not be supporting deflationary tokens in Yieldy.  We will document this.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-16-_storerebase-is-called-with-the-wrong-parameters\" style=\"position:relative;\"><a href=\"#m-16-_storerebase-is-called-with-the-wrong-parameters\" aria-label=\"m 16 _storerebase is called with the wrong parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/259\">[M-16] <code>_storeRebase()</code> is called with the wrong parameters</a></h2>\n<p><em>Submitted by BowTiedWardens, also found by hansfriese, hubble, minhquanym, PwnedNoMore, shung, TrungOre, and WatchPug</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L110-L114\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L110-L114</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L97-L100\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L97-L100</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p><code>_storeRebase()</code>’s signature is as such:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L110-L114\">Yieldy.sol#_storeRebase()</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">105:         </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> emits event with data about rebase</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">106:         </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_previousCirculating</span><span class=\"mtk3\"> uint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">107:         </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_profit</span><span class=\"mtk3\"> uint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">108:         </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_epoch</span><span class=\"mtk3\"> uint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">109:      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_storeRebase</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">111:         </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_previousCirculating</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">112:         </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_profit</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">113:         </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_epoch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:     ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>However, instead of being called with the expected <code>_previousCirculating</code> value, it’s called with the current circulation value:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L97-L100\">Yieldy.sol#rebase()</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">updatedTotalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">currentTotalSupply</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_profit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">updatedTotalSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">_storeRebase</span><span class=\"mtk1\">(</span><span class=\"mtk12\">updatedTotalSupply</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_profit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_epoch</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit-info this should be currentTotalSupply otherwise previous = current</span></span></span></code></pre>\n<p>As a consequence, the functionality isn’t doing what it was created for.</p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider calling <code>_storeRebase()</code> with <code>currentTotalSupply</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Yieldy.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 105:             _storeRebase(updatedTotalSupply, _profit, _epoch);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 105:             _storeRebase(currentTotalSupply, _profit, _epoch);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/259#issuecomment-1167809101\">toshiSat (Yieldy) confirmed and resolved</a></strong></p>\n<hr>\n<h2 id=\"m-17-staking-rebase-does-not-rebase-according-to-the-status-of-the-current-epoch\" style=\"position:relative;\"><a href=\"#m-17-staking-rebase-does-not-rebase-according-to-the-status-of-the-current-epoch\" aria-label=\"m 17 staking rebase does not rebase according to the status of the current epoch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/49\">[M-17] Staking: rebase() does not rebase according to the status of the current epoch.</a></h2>\n<p><em>Submitted by cccz</em></p>\n<p>In the staking contract, the rebase function can only be called once per epoch.</p>\n<p>In the rebase function, the rewards of the current epoch are used in the next epoch, which can cause the rewards to be updated incorrectly and lead to incorrect distribution of user rewards.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function rebase() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // we know about the issues surrounding block.timestamp, using it here will not cause any problems</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (epoch.endTime &lt;= block.timestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IYieldy(YIELDY_TOKEN).rebase(epoch.distribute, epoch.number); // 懒更新</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.endTime = epoch.endTime + epoch.duration;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.timestamp = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.number++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 balance = contractBalance();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 staked = IYieldy(YIELDY_TOKEN).totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (balance &lt;= staked) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                epoch.distribute = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                epoch.distribute = balance - staked;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L701-L719\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L701-L719</a></p>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Put <code>IYieldy(YIELDY_TOKEN).rebase</code> after epoch.distribute update</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function rebase() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // we know about the issues surrounding block.timestamp, using it here will not cause any problems</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (epoch.endTime &lt;= block.timestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 balance = contractBalance();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 staked = IYieldy(YIELDY_TOKEN).totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (balance &lt;= staked) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                epoch.distribute = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                epoch.distribute = balance - staked;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IYieldy(YIELDY_TOKEN).rebase(epoch.distribute, epoch.number);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.endTime = epoch.endTime + epoch.duration;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.timestamp = block.timestamp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            epoch.number++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/49#issuecomment-1168884765\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is how the system is designed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/49#issuecomment-1200168413\">JasoonS (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Changing to Medium. It makes sense that the rebase happens after rewards so that those who enter later don’t affect the distribution of rewards before they joined.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-18-removal-of-liquidity-from-the-reserve-can-be-griefed\" style=\"position:relative;\"><a href=\"#m-18-removal-of-liquidity-from-the-reserve-can-be-griefed\" aria-label=\"m 18 removal of liquidity from the reserve can be griefed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/282\">[M-18] Removal of liquidity from the reserve can be griefed</a></h2>\n<p><em>Submitted by IllIllI</em></p>\n<p>Users may be unable to withdraw/remove their liquidity from the <code>LiquidityReserve</code> if a user decides to grief the contract.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is the only function in this contract that is able to unstake funds, so that they can be withdrawn/removed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unstakeAllRewardTokens</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">coolDownAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingContract</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">217</span><span class=\"mtk1\">               .</span><span class=\"mtk11\">coolDownInfo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">218</span><span class=\"mtk1\">               .</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">           </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">coolDownAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">220</span><span class=\"mtk1\">               </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">221</span><span class=\"mtk1\">                   </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">222</span><span class=\"mtk1\">               );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">223</span><span class=\"mtk1\">               </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">unstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">224</span><span class=\"mtk1\">           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">225</span><span class=\"mtk1\">       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L214-L225\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L214-L225</a></p>\n<p>The function requires that the <code>coolDownAmount</code> is zero, or else it skips the <code>unstake()</code> call. A malicious user can make <code>coolDownAmount</code> non-zero by calling <code>Staking.instantUnstakeReserve()</code> when the previous reward is claimed, with just a large enough amount to satisfy the transfer of the amount and of the fee, so there is essentially zero left for other users to withdraw. The function calls <code>LiquidityReserve.instantUnstake()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">571</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">instantUnstakeReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">572</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">573</span><span class=\"mtk1\">           </span><span class=\"mtk3\">// prevent unstaking if override due to vulnerabilities</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">574</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">575</span><span class=\"mtk1\">               !</span><span class=\"mtk12\">isUnstakingPaused</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isInstantUnstakingPaused</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">576</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;Unstaking is paused&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">577</span><span class=\"mtk1\">           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">578</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">579</span><span class=\"mtk1\">           </span><span class=\"mtk11\">rebase</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">580</span><span class=\"mtk1\">           </span><span class=\"mtk11\">_retrieveBalanceFromUser</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">581</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">582</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserveBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">STAKING_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">583</span><span class=\"mtk1\">               </span><span class=\"mtk12\">LIQUIDITY_RESERVE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">584</span><span class=\"mtk1\">           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">585</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">586</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserveBalance</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enough funds in reserve&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">587</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">588</span><span class=\"mtk1\">           </span><span class=\"mtk11\">ILiquidityReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LIQUIDITY_RESERVE</span><span class=\"mtk1\">).</span><span class=\"mtk11\">instantUnstake</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">589</span><span class=\"mtk1\">               </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">590</span><span class=\"mtk1\">               </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">591</span><span class=\"mtk1\">           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">592</span><span class=\"mtk1\">       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L571-L592\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L571-L592</a></p>\n<p>Which boosts the cooldown amount above zero in its call to <code>unstakeAllRewardTokens()</code> and then <code>IStaking.unstake()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">3</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">188</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">instantUnstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">189           </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">190           </span><span class=\"mtk11\">onlyStakingContract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">191       {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">192</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">193</span><span class=\"mtk1\">           </span><span class=\"mtk3\">// claim the stakingToken from previous unstakes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">194</span><span class=\"mtk1\">           </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">claimWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">195</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">196</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountMinusFee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> - ((</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">197</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">198</span><span class=\"mtk1\">           </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">199</span><span class=\"mtk1\">               </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">200</span><span class=\"mtk1\">               </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">201</span><span class=\"mtk1\">               </span><span class=\"mtk12\">_amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">202</span><span class=\"mtk1\">           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">203</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">204</span><span class=\"mtk1\">           </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">               </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">               </span><span class=\"mtk12\">amountMinusFee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">           </span><span class=\"mtk11\">unstakeAllRewardTokens</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">       }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">       </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">212           </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> find balance of reward tokens in contract and unstake them from staking contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">213        */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unstakeAllRewardTokens</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">coolDownAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingContract</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">217</span><span class=\"mtk1\">               .</span><span class=\"mtk11\">coolDownInfo</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">218</span><span class=\"mtk1\">               .</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">           </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">coolDownAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">220</span><span class=\"mtk1\">               </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">221</span><span class=\"mtk1\">                   </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">222</span><span class=\"mtk1\">               );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">223</span><span class=\"mtk1\">               </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingContract</span><span class=\"mtk1\">).</span><span class=\"mtk11\">unstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk4\">false</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">224</span><span class=\"mtk1\">           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">225</span><span class=\"mtk1\">       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L188-L225\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L188-L225</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">674</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_trigger</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">675</span><span class=\"mtk1\">           </span><span class=\"mtk3\">// prevent unstaking if override due to vulnerabilities asdf</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">676</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">isUnstakingPaused</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Unstaking is paused&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">677</span><span class=\"mtk1\">           </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_trigger</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">678</span><span class=\"mtk1\">               </span><span class=\"mtk11\">rebase</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">679</span><span class=\"mtk1\">           }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">680</span><span class=\"mtk1\">           </span><span class=\"mtk11\">_retrieveBalanceFromUser</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">681</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">682</span><span class=\"mtk1\">           </span><span class=\"mtk12\">Claim</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userCoolInfo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">coolDownInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">683</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">684</span><span class=\"mtk1\">           </span><span class=\"mtk3\">// try to claim withdraw if user has withdraws to claim function will check if withdraw is valid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">685</span><span class=\"mtk1\">           </span><span class=\"mtk11\">claimWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">686</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">687</span><span class=\"mtk1\">           </span><span class=\"mtk12\">coolDownInfo</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">Claim</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">688</span><span class=\"mtk12\">               amount:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userCoolInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">689</span><span class=\"mtk12\">               credits:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userCoolInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">credits</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">690</span><span class=\"mtk1\">                   </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">creditsForTokenBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">691</span><span class=\"mtk12\">               expiry:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">coolDownPeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">692</span><span class=\"mtk1\">           });</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L674-L692\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L674-L692</a></p>\n<p>If the malicious user is a miner, that miner can make sure that the block where the previous cooldown expires and is claimed, is the same block where the miner griefs by doing an instant unstake of a small amount, preventing larger amounts from going through. Until the miner decides to stop this behavior, funds will be locked in the contract.</p>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Keep track of submitted amounts during the cooldown, and batch-submit them during the next open window, rather than making it first-come-first-served</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/282#issuecomment-1167948970\">0xean (Yieldy) disputed, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>The warden does identify a potential attack, but the assumptions that are being made for it to work are pretty hard to imagine.  For one, It would require a miner to always be able to process a specific block in order to continually DOS the contract.  This is very infeasible.</p>\n<p>Additionally, if this scenario was to occur, we could pause instant unstaking and wait for the cooldown to expire in order to retrieve funds.  The ability to toggle the instant unstake negates the call path the warden has suggested since <code>Staking.instantUnstakeReserve()</code> would revert. </p>\n<p>Given all of this, I would put this entire attack vector as super low risk and suggest its downgraded to QA. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/282#issuecomment-1200225289\">JasoonS (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I’m going to make this a Medium. While I agree the assumptions are out of the imaginable in reality, it is something that should be looked into for the contracts more seriously than the typical QA.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-19-staking-the-rebase-function-needs-to-be-called-before-calling-the-function-in-the-yieldy-contract-that-uses-the-rebasingcreditspertoken-variable\" style=\"position:relative;\"><a href=\"#m-19-staking-the-rebase-function-needs-to-be-called-before-calling-the-function-in-the-yieldy-contract-that-uses-the-rebasingcreditspertoken-variable\" aria-label=\"m 19 staking the rebase function needs to be called before calling the function in the yieldy contract that uses the rebasingcreditspertoken variable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/126\">[M-19] Staking: the rebase function needs to be called before calling the function in the Yieldy contract that uses the rebasingCreditsPerToken variable</a></h2>\n<p><em>Submitted by cccz</em></p>\n<p>In the Yieldy contract, functions such as balanceOf/creditsForTokenBalance/tokenBalanceForCredits/transfer/transferFrom/burn/mint will use the rebasingCreditsPerToken variable, so before calling these functions in the Staking contract, make sure that the rebase of this epoch has occurred. Therefore, the rebase function should also be called in the unstake/claim/claimWithdraw function of the Staking contract.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L674-L696\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L674-L696</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L465-L508\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L465-L508</a></p>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function claim(address _recipient) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Claim memory info = warmUpInfo[_recipient];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      rebase();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function claimWithdraw(address _recipient) public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Claim memory info = coolDownInfo[_recipient];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">+      rebase();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function unstake(uint256 _amount, bool _trigger) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // prevent unstaking if override due to vulnerabilities asdf</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(!isUnstakingPaused, &quot;Unstaking is paused&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-        if (_trigger) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rebase();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">-        }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/126\">toshiSat (Yieldy) confirmed and resolved</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/126#issuecomment-1199023011\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Yes, seems like a logic flaw, makes sense as Medium.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-20-user-fund-lose-in-addliquidity-of-liquidityreserve-by-increasing-totallockedvalue--totalsupply-to-very-large-number-by-attacker\" style=\"position:relative;\"><a href=\"#m-20-user-fund-lose-in-addliquidity-of-liquidityreserve-by-increasing-totallockedvalue--totalsupply-to-very-large-number-by-attacker\" aria-label=\"m 20 user fund lose in addliquidity of liquidityreserve by increasing totallockedvalue  totalsupply to very large number by attacker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/272\">[M-20] User fund lose in addLiquidity() of LiquidityReserve by increasing (totalLockedValue / totalSupply()) to very large number by attacker</a></h2>\n<p><em>Submitted by unforgiven</em></p>\n<p>Function <code>addLiquidity()</code> suppose to do add Liquidity for the <code>staking Token</code> and receive <code>lrToken</code> in exchange. to calculate amount of <code>IrToken</code> codes uses this calculation: <code>amountToMint = (_amount * lrFoxSupply) / totalLockedValue</code> but it’s possible for attacker to manipulate <code>totalLockedValue</code> (by sending tokens directly to <code>LiquidityReserve</code> address) and make <code>totalLockedValue/lrFoxSupply</code> very high in early stage of contract deployment so because of rounding error in calculation of <code>amountToMint</code> the users would receive very lower <code>IrToken</code> and users funds would be lost and attacker can steal them.</p>\n<p>Attacker can perform this attack by sending tokens before even <code>LiquidityReserve</code> deployed because the contract address would be predictable and attacker can perform front-run or sandwich attack too.</p>\n<p>Also it’s possible to perform this attack for <code>STAKING_TOKEN</code> with low precision and low price even if <code>LiquidityReserve</code> had some balances.</p>\n<h3 id=\"proof-of-concept-17\" style=\"position:relative;\"><a href=\"#proof-of-concept-17\" aria-label=\"proof of concept 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>addLiquidity()</code> code in <code>LiquidityReserve</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function addLiquidity(uint256 _amount) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(isReserveEnabled, &quot;Not enabled yet&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 stakingTokenBalance = IERC20Upgradeable(stakingToken).balanceOf(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 rewardTokenBalance = IERC20Upgradeable(rewardToken).balanceOf(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 lrFoxSupply = totalSupply();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 coolDownAmount = IStaking(stakingContract)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .coolDownInfo(address(this))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 totalLockedValue = stakingTokenBalance +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardTokenBalance +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            coolDownAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountToMint = (_amount * lrFoxSupply) / totalLockedValue;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IERC20Upgradeable(stakingToken).safeTransferFrom(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mint(msg.sender, amountToMint);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see code uses this calculation: <code>amountToMint = (_amount * lrFoxSupply) / totalLockedValue;</code> to find the amount of <code>IrToken</code> that is going to mint for user. but attacker can send <code>stakingToken</code> or <code>rewardToken</code> directly to <code>LiquidityReserve</code> address when the there is no liqudity in the contract and make <code>totalLockedValue</code> very high. then attacker call <code>addLiquidity()</code> and mint some <code>IrToken</code> for himself and from then anyone tries to call <code>addLiquidity()</code> because of rounding error is going to lose some funds (receives less <code>IrToken</code> than he is supposed to)</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add more precision when calculating <code>IrToken</code> so this attack wouldn’t be feasible to perform.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/272#issuecomment-1169117495\">0xean (Yieldy) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>The contract locks a minimum liquidity amount which blocks the feasibility attack for the most part. Please see <code>enableLiquidityReserve</code> for the code where the locking occurs. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/272#issuecomment-1201297362\">moose-code (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Some good worthwhile ideas from the warden but after reviewing the <code>enableLiquidityReserve</code> going to downgrade this to medium. After reading the code and the described attack, its not very clear how the attacker would benefit and bring the contract into this state. </p>\n<p>By sending tokens directly to the contract (expensive) and increasing total totalLockedValue, this will decrease the amount the amountToMint for the user but unclear that this cost is worth it or how an attacker could actually benefit (from what I can see). </p>\n<p>Think its still worth exploring this vector in more depth as its a creative attack. Warrants medium and further investigation. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-21-cannot-mint-to-exactly-max-supply-using-_mint-function\" style=\"position:relative;\"><a href=\"#m-21-cannot-mint-to-exactly-max-supply-using-_mint-function\" aria-label=\"m 21 cannot mint to exactly max supply using _mint function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/200\">[M-21] Cannot mint to exactly max supply using <code>_mint</code> function</a></h2>\n<p><em>Submitted by Chom, also found by hansfriese and minhquanym</em></p>\n<p>Cannot mint to exactly max supply using <code>_mint</code> function.</p>\n<h3 id=\"proof-of-concept-18\" style=\"position:relative;\"><a href=\"#proof-of-concept-18\" aria-label=\"proof of concept 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(_totalSupply &lt; MAX_SUPPLY, &quot;Max supply&quot;);</span></span></code></pre>\n<p>if <code>_totalSupply == MAX_SUPPLY</code> this assert will be failed and reverted.</p>\n<p>But it shouldn’t be reverted as <code>_totalSupply == MAX_SUPPLY</code> is valid.</p>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change to</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(_totalSupply &lt;= MAX_SUPPLY, &quot;Max supply&quot;);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/200#issuecomment-1199257061\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Feels potentially too generous giving this a medium since it isn’t clear what the exploit would be, but it is a bug. I’ll be generous…</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/200#issuecomment-1205716867\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>Yea we aren’t going to implement this one due to nearly every example of rebasing tokens are using this calculation.  It will be very unlikely that total supply ever hits max supply,  so the risk isn’t worth the reward for changing it.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-22-minimum_liquidity-checks-missing---bringing-liquidity-below-required-min\" style=\"position:relative;\"><a href=\"#m-22-minimum_liquidity-checks-missing---bringing-liquidity-below-required-min\" aria-label=\"m 22 minimum_liquidity checks missing   bringing liquidity below required min permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/48\">[M-22] MINIMUM_LIQUIDITY checks missing - Bringing Liquidity below required min</a></h2>\n<p><em>Submitted by csanuragjain</em></p>\n<p>Whale who provided most liquidity to the contract can simply use removeLiquidity function and can remove all of his liquidity. This can leave the residual liquidity to be less than MINIMUM_LIQUIDITY which is incorrect.</p>\n<h3 id=\"proof-of-concept-19\" style=\"position:relative;\"><a href=\"#proof-of-concept-19\" aria-label=\"proof of concept 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Whale A provided initial liquidity plus more liquidity using enableLiquidityReserve and addLiquidity function</li>\n<li>There are other small liquidity providers as well</li>\n<li>Now Whale A decides to remove all the liquidity provided</li>\n<li>This means after liquidity removal the balance liquidity will even drop below MINIMUM_LIQUIDITY which is incorrect</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add below check</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            IERC20Upgradeable(stakingToken).balanceOf(address(this)) - MINIMUM_LIQUIDITY &gt;=</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                amountToWithdraw,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            &quot;Not enough funds&quot;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/48\">toshiSat (Yieldy) confirmed and resolved</a></strong> </p>\n<hr>\n<h2 id=\"m-23-incorrect-withdrawal-requested\" style=\"position:relative;\"><a href=\"#m-23-incorrect-withdrawal-requested\" aria-label=\"m 23 incorrect withdrawal requested permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/56\">[M-23] Incorrect withdrawal requested</a></h2>\n<p><em>Submitted by csanuragjain, also found by MiloTruck</em></p>\n<p><code>\\_requestWithdrawalFromTokemak</code> function :: Instead of sending amountToRequest for requestWithdrawal, contract is asking _amount for requestWithdrawal. This becomes a problem when balance &#x3C; _amount and only balance could be withdrawn</p>\n<h3 id=\"proof-of-concept-20\" style=\"position:relative;\"><a href=\"#proof-of-concept-20\" aria-label=\"proof of concept 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>In _requestWithdrawalFromTokemak function, amountToRequest is calculated as</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// the only way balance &lt; _amount is when using unstakeAllFromTokemak</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amountToRequest = balance &lt; _amount ? balance : _amount;</span></span></code></pre>\n<ol start=\"2\">\n<li>Now assuming balance &#x3C; _amount then amountToRequest becomes balance</li>\n<li>But tokePoolContract.requestWithdrawal is called over _amount instead of amountToRequest which means withdrawal is requested over an extra amount</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Modify Staking.sol#L326 to</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (amountToRequest &gt; 0) tokePoolContract.requestWithdrawal(amountToRequest);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/56\">toshiSat (Yieldy) confirmed and resolved</a></strong> </p>\n<hr>\n<h2 id=\"m-24-staking-presign-could-use-some-basic-validations\" style=\"position:relative;\"><a href=\"#m-24-staking-presign-could-use-some-basic-validations\" aria-label=\"m 24 staking presign could use some basic validations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/172\">[M-24] Staking <code>preSign</code> could use some basic validations</a></h2>\n<p><em>Submitted by Alex the Entreprenerd</em></p>\n<p>The function <code>preSign</code> accepts any <code>orderUid</code>.<br>\n<code>function preSign(bytes calldata orderUid) external onlyOwner</code></p>\n<p>Because of how Cowswap works, accepting any <code>orderUid</code> can be used as a rug-vector.</p>\n<p>This is because the orderData contains a <code>receiver</code> which in lack of validation could be any address.</p>\n<p>You’d also be signing other parameters such as minOut and how long the order could be filled for, which you may or may not want to validate to give stronger security guarantees to end users.</p>\n<h3 id=\"recomended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recomended-mitigation-steps\" aria-label=\"recomended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recomended Mitigation Steps</h3>\n<p>I’d recommend adding basic validation for tokenOut, minOut and receiver.</p>\n<p>Feel free to check the work we’ve done at Badger to validate order parameters, giving way stronger guarantees to end users.\n<a href=\"https://github.com/GalloDaSballo/fair-selling/blob/44c0c0629289a0c4ccb3ca971cc5cd665ce5cb82/contracts/CowSwapSeller.sol#L194\">https://github.com/GalloDaSballo/fair-selling/blob/44c0c0629289a0c4ccb3ca971cc5cd665ce5cb82/contracts/CowSwapSeller.sol#L194</a></p>\n<p>Also notice how through the code above we are able to re-construct the <code>orderUid</code>, feel free to re-use that code which has been validated by the original Cowswap / GPv2 Developers.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/172#issuecomment-1201510899\">toshiSat (Yieldy) confirmed, resolved and commented</a>:</strong></p>\n<blockquote>\n<p>Thanks for the functions, I like what you guys did.  Our cowswap function is only called using the <code>onlyOwner</code> modifier, so I think it’s pretty safe, but I agree some validation would be better than none.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-25-cooldown--warmup-period-do-not-work-when-a-low-_firstepochendtime-is-passed-to-initialize\" style=\"position:relative;\"><a href=\"#m-25-cooldown--warmup-period-do-not-work-when-a-low-_firstepochendtime-is-passed-to-initialize\" aria-label=\"m 25 cooldown  warmup period do not work when a low _firstepochendtime is passed to initialize permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/88\">[M-25] coolDown &#x26; warmUp period do not work when a low _firstEpochEndTime is passed to initialize</a></h2>\n<p><em>Submitted by Lambda</em></p>\n<p>In the constructor of <code>Staking.sol</code>, it is not enforced that the <code>_firstEpochEndTime</code> is larger than the current <code>block.timestamp</code>. If a low value is accidentally passed (or even 0), <code>rebase</code> can be called multiple times in sucession, causing the <code>epoch.number</code> to increase. Therefore, the coolDown &#x26; warmUp period can be circumvented in such a scenario, as <code>epoch.number >= info.expiry</code> (in <code>_isClaimAvailable</code> and <code>_isClaimWithdrawAvailable</code>) will return true after <code>rebase</code> caused several increases of <code>epoch.number</code>.</p>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Either require that <code>_firstEpochEndTime</code> is larger than <code>block.timestamp</code> or set the expiry of the first epoch to <code>block.timestamp + _epochDuration</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/88#issuecomment-1168044235\">toshiSat (Yieldy) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is something we thought about and will most likely set the period temporarily 1 higher when launching with low initial epoch durations.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-26-instantunstake-function-can-be-frontrunned-with-fee-increase\" style=\"position:relative;\"><a href=\"#m-26-instantunstake-function-can-be-frontrunned-with-fee-increase\" aria-label=\"m 26 instantunstake function can be frontrunned with fee increase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/279\">[M-26] instantUnstake function can be frontrunned with fee increase</a></h2>\n<p><em>Submitted by sashik_eth</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/LiquidityReserve.sol#L188\"><code>instantUnstake()</code></a> allows user to unstake their stakingToken for a fee paid to the liquidity providers. This fee could be changed up to 100% any moment by admin.</p>\n<p>Malicious admin could frontrun users <a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/LiquidityReserve.sol#L188\"><code>instantUnstake()</code></a> transaction and set <code>fee</code> to any value (using <a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/LiquidityReserve.sol#L92\"><code>setFee()</code></a>) and get all users unstaking asset.</p>\n<p>It’s even could lead to a situation when non-malicious admin accidentally frontrun unstaking user by increasing fee to a new rate, which user wasn’t expected.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> sets Fee (in basis points eg. 100 bps = 1%) for instant unstaking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">        </span><span class=\"mtk4\">@param</span><span class=\"mtk3\"> </span><span class=\"mtk12\">_fee</span><span class=\"mtk3\"> uint - fee in basis points</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check range before setting fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Out of range&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FeeChanged</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider introducing an upper limit for fees so users can know the maximum fess available in protocol and adding timelock to change fee size.\nThis way, frontrunning will be impossible, and users will know which fee they agree to.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/279\">toshiSat (Yieldy) acknowledged</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/279#issuecomment-1230586458\">JasoonS (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Checks should be in place for this. Saying the code is upgradeable isn’t an excuse for not having sanity checks in admin functions in the code.</p>\n<p>For example script could have a bug that sets this value wrong (for example making it 1e18 times bigger than it should be or something).</p>\n</blockquote>\n<hr>\n<h2 id=\"m-27-instantunstake-fee-can-be-avoided\" style=\"position:relative;\"><a href=\"#m-27-instantunstake-fee-can-be-avoided\" aria-label=\"m 27 instantunstake fee can be avoided permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/9\">[M-27] instantUnstake fee can be avoided</a></h2>\n<p><em>Submitted by skoorch</em></p>\n<p>Users can utilize the <code>instantUnstake</code> function without paying the liquidity provider fee using rounding errors in the fee calculation. This attack only allows for a relatively small amount of tokens to be unstaked in each call, so is likely not feasible on mainnet. However, on low-cost L2s and for tokens with a small decimal precision it is likely a feasible workaround.</p>\n<h3 id=\"proof-of-concept-21\" style=\"position:relative;\"><a href=\"#proof-of-concept-21\" aria-label=\"proof of concept 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>instantUnstake</code> fee is handled by sending the user back <code>amount - fee</code>. We can work around the fee by unstaking small amounts (<code>amount &#x3C; BASIS_POINTS / fee</code>) in a loop until reaching the desired amount.</p>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Avoid using subtraction to calculate the fee as this causes the fee to be rounded down rather than the amount. I’d propose calculating amount less fee using a muldiv operation over (1 - fee). In this case, the fee is effectively rounded up instead of down, so it can never be 0 unless fee is 0. Uniswapv2 uses a similar solution for their LP fee: <a href=\"https://github.com/Uniswap/v2-core/blob/8b82b04a0b9e696c0e83f8b2f00e5d7be6888c79/contracts/UniswapV2Pair.sol#L180-L182\">https://github.com/Uniswap/v2-core/blob/8b82b04a0b9e696c0e83f8b2f00e5d7be6888c79/contracts/UniswapV2Pair.sol#L180-L182</a></p>\n<p>It might look like the following:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 amountMinusFee = amount * (BASIS_POINTS - fee) / BASIS_POINTS</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/9\">toshiSat (Yieldy) confirmed and resolved</a></strong></p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 70 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/235\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/270\">BowTiedWardens</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/277\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/66\">robee</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/90\">0x1337</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/92\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/268\">hubble</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/267\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/156\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/292\">berndartmueller</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/174\">GalloDaSballo</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/201\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/85\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/181\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/163\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/8\">pedr02b2</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/230\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/62\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/23\">exd0tpy</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/274\">GimelSec</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/96\">shung</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/186\">scaraven</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/114\">StErMi</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/135\">zzzitron</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/219\">elprofesor</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/207\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/254\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/295\">FudgyDRS</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/224\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/11\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/213\">hake</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/136\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/42\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/127\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/119\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/216\">aga7hokakological</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/237\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/247\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/250\">dipp</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/19\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/202\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/139\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/239\">Limbooo</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/122\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/128\">Noah3o6</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/6\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/71\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/147\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/78\">0xNineDec</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/166\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/149\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/205\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/301\">UnusualTurtle</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/112\">sseefried</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/299\">0xmint</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/54\">antonttc</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/229\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/177\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/304\">JC</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/117\">Kaiziron</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/154\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/302\">Metatron</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/69\">mics</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/150\">PumpkingWok</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/257\">PwnedNoMore</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/183\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/140\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/261\">tchkvsky</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/193\">TrungOre</a>, and <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/32\">0x52</a>.</em></p>\n<h2 id=\"low-risk-issues\" style=\"position:relative;\"><a href=\"#low-risk-issues\" aria-label=\"low risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>L-01</td>\n<td align=\"left\">Batch-related functions will revert if <code>removeAddress()</code> is called</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>L-02</td>\n<td align=\"left\">Staking contract’s token not verified to be the same token as the staking token</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>L-03</td>\n<td align=\"left\">Missing infinite approval functionality</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>L-04</td>\n<td align=\"left\">Missing checks that the end time matches the duration</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>L-05</td>\n<td align=\"left\">Missing input validations and timelocks</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>L-06</td>\n<td align=\"left\">Front-runable initializer</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 12 instances over 6 issues</p>\n<h2 id=\"l-01-batch-related-functions-will-revert-if-removeaddress-is-called\" style=\"position:relative;\"><a href=\"#l-01-batch-related-functions-will-revert-if-removeaddress-is-called\" aria-label=\"l 01 batch related functions will revert if removeaddress is called permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Batch-related functions will revert if <code>removeAddress()</code> is called</h2>\n<p><code>removeAddress()</code> removes entries from the storage array that holds batch contract addresses, but it doesn’t fill in the deleted entries with a replacement value. When other functions hit these null entries and try to call functions on the zero address, they’ll revert, causing the whole function to fail</p>\n<p><em>There are 2 instances of this issue. (For in-depth details on this and all further low and non-critical items with multiple instances, see the warden’s <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/235\">full report</a>.)</em></p>\n<h2 id=\"l-02-staking-contracts-token-not-verified-to-be-the-same-token-as-the-staking-token\" style=\"position:relative;\"><a href=\"#l-02-staking-contracts-token-not-verified-to-be-the-same-token-as-the-staking-token\" aria-label=\"l 02 staking contracts token not verified to be the same token as the staking token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Staking contract’s token not verified to be the same token as the staking token</h2>\n<p>There may be a mismatch between the token that <code>_stakingContract</code> is in charge of, and the actual token used by the <code>LiquidityReserve</code>. This code should check that they are in fact the same</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">enableLiquidityReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_stakingContract</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">58           </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">59           </span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">60       {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">61</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Already enabled&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">62</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_stakingContract</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Invalid address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">   </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakingTokenBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">               </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">           </span><span class=\"mtk3\">// require address has minimum liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">               </span><span class=\"mtk12\">stakingTokenBalance</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">MINIMUM_LIQUIDITY</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">70</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;Not enough staking tokens&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">           );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">stakingContract</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_stakingContract</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L57-L72\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L57-L72</a></p>\n<h2 id=\"l-03-missing-infinite-approval-functionality\" style=\"position:relative;\"><a href=\"#l-03-missing-infinite-approval-functionality\" aria-label=\"l 03 missing infinite approval functionality permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Missing infinite approval functionality</h2>\n<p>Most other contracts in the repository use <code>type(uint256).max</code> to mean infinite approval, rather than a specific approval amount. Not doing the same thing here will mean inconsistent behavior between the components, will mean that approvals will eventually run down to zero, and will mean that there will be hard-to-track-down issues when things eventually start failing</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_allowances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] &gt;= </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Allowance too low&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newValue</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_allowances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">          </span><span class=\"mtk12\">_allowances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">newValue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Approval</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">newValue</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L210-L214\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L210-L214</a></p>\n<h2 id=\"l-04-missing-checks-that-the-end-time-matches-the-duration\" style=\"position:relative;\"><a href=\"#l-04-missing-checks-that-the-end-time-matches-the-duration\" aria-label=\"l 04 missing checks that the end time matches the duration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Missing checks that the end time matches the duration</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">95</span><span class=\"mtk1\">               duration: </span><span class=\"mtk12\">_epochDuration</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">               number: </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">97</span><span class=\"mtk1\">               timestamp: </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// we know about the issues surrounding block.timestamp, using it here will not cause any problems</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">98</span><span class=\"mtk1\">:              endTime: </span><span class=\"mtk12\">_firstEpochEndTime</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L95-L98\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L95-L98</a></p>\n<h2 id=\"l-05-missing-input-validations-and-timelocks\" style=\"position:relative;\"><a href=\"#l-05-missing-input-validations-and-timelocks\" aria-label=\"l 05 missing input validations and timelocks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Missing input validations and timelocks</h2>\n<p>The following instances are missing checks for zero addresses and or valid ranges for values. Even if the DAO is the one setting these values, it’s important to add sanity checks in case someone does a fat-finger operation that is missed by DAO participants who may not be very technical. There are also no timelocks involved, which <a href=\"https://discord.com/channels/810916927919620096/986765994049564682/990255967847460894\">should be rectified</a></p>\n<p><em>There are 5 instances of this issue.</em></p>\n<h2 id=\"l-06-front-runable-initializer\" style=\"position:relative;\"><a href=\"#l-06-front-runable-initializer\" aria-label=\"l 06 front runable initializer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Front-runable initializer</h2>\n<p>There is nothing preventing another account from calling the initializer before the contract owner. In the best case, the owner is forced to waste gas and re-deploy. In the worst case, the owner does not notice that his/her call reverts, and everyone starts using a contract under the control of an attacker</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Issues</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>N-01</td>\n<td align=\"left\">Return values of <code>approve()</code> not checked</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>N-02</td>\n<td align=\"left\">Misleading variable names</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N-03</td>\n<td align=\"left\"><code>public</code> functions not called by the contract should be declared <code>external</code> instead</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N-04</td>\n<td align=\"left\"><code>constant</code>s should be defined rather than using magic numbers</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>N-05</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>N-06</td>\n<td align=\"left\">Typos</td>\n<td align=\"center\">10</td>\n</tr>\n<tr>\n<td>N-07</td>\n<td align=\"left\">NatSpec is incomplete</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>N-08</td>\n<td align=\"left\">Event is missing <code>indexed</code> fields</td>\n<td align=\"center\">12</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 34 instances over 8 issues</p>\n<h2 id=\"n-01-return-values-of-approve-not-checked\" style=\"position:relative;\"><a href=\"#n-01-return-values-of-approve-not-checked\" aria-label=\"n 01 return values of approve not checked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Return values of <code>approve()</code> not checked</h2>\n<p>Not all <code>IERC20</code> implementations <code>revert()</code> when there’s a failure in <code>approve()</code>. The function signature has a <code>boolean</code> return value and they indicate errors that way instead. By not checking the return value, operations that should have marked as failed, may potentially go through without actually approving anything</p>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n-02-misleading-variable-names\" style=\"position:relative;\"><a href=\"#n-02-misleading-variable-names\" aria-label=\"n 02 misleading variable names permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Misleading variable names</h2>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit code is no longer FOX-specific</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">112</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lrFoxSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L112\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L112</a></p>\n<h2 id=\"n-03-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" style=\"position:relative;\"><a href=\"#n-03-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" aria-label=\"n 03 public functions not called by the contract should be declared external instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] <code>public</code> functions not called by the contract should be declared <code>external</code> instead</h2>\n<p>Contracts <a href=\"https://docs.soliditylang.org/en/latest/contracts.html#function-overriding\">are allowed</a> to override their parents’ functions and change the visibility from <code>external</code> to <code>public</code>.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">   #</span><span class=\"mtk7\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">370</span><span class=\"mtk1\">:      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unstakeAllFromTokemak</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L370\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L370</a></p>\n<h2 id=\"n-04-constants-should-be-defined-rather-than-using-magic-numbers\" style=\"position:relative;\"><a href=\"#n-04-constants-should-be-defined-rather-than-using-magic-numbers\" aria-label=\"n 04 constants should be defined rather than using magic numbers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] <code>constant</code>s should be defined rather than using magic numbers</h2>\n<p>Even <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/9d7ce4d08bf3c3010304a0476a785c70c0e90ae7/contracts/lib/TokenTransferrer.sol#L35-L39\">assembly</a> can benefit from using readable constants instead of hex/numeric literals</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"n-05-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#n-05-use-a-more-recent-version-of-solidity\" aria-label=\"n 05 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.13 to get the ability to use <code>using for</code> with a list of free functions</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<h2 id=\"n-06-typos\" style=\"position:relative;\"><a href=\"#n-06-typos\" aria-label=\"n 06 typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Typos</h2>\n<p><em>There are 10 instances of this issue.</em></p>\n<h2 id=\"n-07-natspec-is-incomplete\" style=\"position:relative;\"><a href=\"#n-07-natspec-is-incomplete\" aria-label=\"n 07 natspec is incomplete permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] NatSpec is incomplete</h2>\n<p><em>There are 2 instances of this issue.</em></p>\n<h2 id=\"n-08-event-is-missing-indexed-fields\" style=\"position:relative;\"><a href=\"#n-08-event-is-missing-indexed-fields\" aria-label=\"n 08 event is missing indexed fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-08] Event is missing <code>indexed</code> fields</h2>\n<p>Each <code>event</code> should use three <code>indexed</code> fields if there are three or more fields</p>\n<p><em>There are 12 instances of this issue.</em></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/235#issuecomment-1236821132\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Low risk issues:<br>\n1 - Agree<br>\n2 - Agree<br>\n3 - Agree<br>\n4 - Agree<br>\n5 - Agree<br>\n6 -Agree<br></p>\n<p>Informational:<br>\n1- Agree<br>\n2 -Agree<br>\n3 - Agree<br>\n4 - Strongly agree, this is very helpful.<br>\n5 - Agree<br>\n6 - Agree<br>\n7 - Agree<br>\n8 - Agree<br></p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 70 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/236\">report highlighted below</a> by <strong>BowTiedWardens</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/231\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/121\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/100\">_Adam</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/212\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/189\">Fabble</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/175\">GalloDaSballo</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/16\">0xkatana</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/20\">0xKitsune</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/273\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/197\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/269\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/107\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/159\">0x29A</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/53\">antonttc</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/15\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/18\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/296\">FudgyDRS</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/106\">minhquanym</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/203\">RedOneN</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/17\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/258\">PwnedNoMore</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/35\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/256\">0xf15ers</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/91\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/225\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/155\">kenta</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/145\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/86\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/120\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/98\">Nyamcil</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/191\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/275\">Randyyy</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/194\">scaraven</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/130\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/137\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/131\">Noah3o6</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/263\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/228\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/58\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/248\">GimelSec</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/305\">JC</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/118\">Kaiziron</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/10\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/182\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/70\">mics</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/297\">0xmint</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/21\">8olidity</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/217\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/271\">Fitraldys</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/214\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/160\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/65\">robee</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/227\">saian</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/290\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/192\">TrungOre</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/293\">UnusualTurtle</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/233\">0v3rf10w</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/34\">ACai</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/83\">bardamu</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/240\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/24\">exd0tpy</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/30\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/113\">StErMi</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/244\">Limbooo</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/199\">s3cunda</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/72\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/157\">slywaters</a>, <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/218\">aga7hokakological</a>, and <a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/4\">ignacio</a>.</em></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<ul>\n<li>G-01. Duplicated external function call</li>\n<li>G-02. Wrong use of the <code>memory</code> keyword for a Struct</li>\n<li>G-03. Caching storage values in memory</li>\n<li>G-04. Avoid emitting a storage variable when a memory value is available</li>\n<li>G-05. Unchecking arithmetics operations that can’t underflow/overflow</li>\n<li>G-06. <code>LiquidityReserveStorage</code> : Tightly pack storage variables</li>\n<li>G-07. <code>YieldyStorage</code> : Tightly pack storage variables</li>\n<li>G-08. Duplicated conditions should be refactored to a modifier or function to save deployment costs</li>\n<li>G-09. A modifier used only once and not being inherited should be inlined to save gas</li>\n<li>G-10. Pre-Solidity <code>0.8.13</code>: <code>> 0</code> is less efficient than <code>!= 0</code> for unsigned integers (with proof)</li>\n<li>G-11. <code>>=</code> is cheaper than <code>></code> (and <code>&#x3C;=</code> cheaper than <code>&#x3C;</code>)</li>\n<li>G-12. Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</li>\n<li>G-13. Using private rather than public for constants saves gas</li>\n<li>G-14. Amounts should be checked for 0 before calling a transfer</li>\n<li>G-15. <code>++i</code> costs less gas compared to <code>i++</code> or <code>i += 1</code> (same for <code>--i</code> vs <code>i--</code> or <code>i -= 1</code>)</li>\n<li>G-16. Public functions to external</li>\n<li>G-17. It costs more gas to initialize variables with their default value than letting the default value be applied</li>\n<li>G-18. Upgrade pragma</li>\n<li>G-19. Use Custom Errors instead of Revert Strings to save Gas</li>\n<li>G-20. Functions guaranteed to revert when called by normal users can be marked <code>payable</code></li>\n<li>G-21. Use <code>1000</code> rather than exponentiation <code>10**3</code></li>\n</ul>\n<h2 id=\"g-01-duplicated-external-function-call\" style=\"position:relative;\"><a href=\"#g-01-duplicated-external-function-call\" aria-label=\"g 01 duplicated external function call permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Duplicated external function call</h2>\n<p>External function calls are expensive. This one seems like a copy-paste error:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L84-L91\">Staking.sol#initialize()</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Staking.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">84:         IERC20Upgradeable(YIELDY_TOKEN).approve(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">85:             LIQUIDITY_RESERVE,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">86:             type(uint256).max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">87:         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 88:         IERC20Upgradeable(YIELDY_TOKEN).approve(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 89:             LIQUIDITY_RESERVE,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 90:             type(uint256).max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 91:         );</span></span></span></code></pre>\n<h2 id=\"g-02-wrong-use-of-the-memory-keyword-for-a-struct\" style=\"position:relative;\"><a href=\"#g-02-wrong-use-of-the-memory-keyword-for-a-struct\" aria-label=\"g 02 wrong use of the memory keyword for a struct permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Wrong use of the <code>memory</code> keyword for a Struct</h2>\n<p>When copying a state struct in memory, there are as many SLOADs and MSTOREs as there are slots. When reading the whole struct multiple times is not needed, it’s better to actually only read the relevant field(s). When only some of the fields are read several times, these particular values should be cached instead of the whole state struct.</p>\n<p>Here, the <code>storage</code> keyword should be used instead of <code>memory</code>:</p>\n<ul>\n<li>Saving 1 STORE and 1 MSTORE: <a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L259-L266\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L259-L266</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Staking.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">259:     function _isClaimAvailable(address _recipient)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">260:         internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">261:         view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">262:         returns (bool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">263:     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 264:         Claim memory info = warmUpInfo[_recipient]; //@audit 2 SLOADs + 2 MSTOREs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 264:         Claim storage info = warmUpInfo[_recipient]; //@audit reference-fetching helper (loved by the Optimizer)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 264:         uint256 _expiry = info.expiry; //@audit 1 SLOAD, 1 MSTORE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 265:         return epoch.number &gt;= info.expiry &amp;&amp; info.expiry != 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 265:         return epoch.number &gt;= _expiry &amp;&amp; _expiry != 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">266:     }</span></span></span></code></pre>\n<ul>\n<li>Saving 2 MSTOREs and 2 MLOADs: <a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L281-L289\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L281-L289</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Staking.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 281:         RequestedWithdrawalInfo memory requestedWithdrawals = tokePoolContract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 281:         RequestedWithdrawalInfo storage requestedWithdrawals = tokePoolContract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">282:             .requestedWithdrawals(address(this));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">283:         uint256 currentCycleIndex = tokeManager.getCurrentCycleIndex();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">284:         return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">285:             epoch.number &gt;= info.expiry &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">286:             info.expiry != 0 &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">287:             info.amount != 0 &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">288:             ((requestedWithdrawals.minCycle &lt;= currentCycleIndex &amp;&amp; //@audit requestedWithdrawals.minCycle only accessed once</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">289:                 requestedWithdrawals.amount + withdrawalAmount &gt;=  //@audit requestedWithdrawals.amount only accessed once</span></span></span></code></pre>\n<ul>\n<li>Saving 1 SLOAD and 1 MSTORE: <a href=\"https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L466-L474\">https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L466-L474</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Staking.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">465:     function claim(address _recipient) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 466:         Claim memory info = warmUpInfo[_recipient]; //@audit 2 SLOADs + 2 MSTOREs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 466:         Claim storage info = warmUpInfo[_recipient]; //@audit reference-fetching helper (loved by the Optimizer)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 466:         uint256 _credits = info.expiry; //@audit 1 SLOAD, 1 MSTORE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">467:         if (_isClaimAvailable(_recipient)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">468:             delete warmUpInfo[_recipient];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">469: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 470:             if (info.credits &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 470:             if (_credits &gt; 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">471:                 IYieldy(YIELDY_TOKEN).transfer(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">472:                     _recipient,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 473:                     IYieldy(YIELDY_TOKEN).tokenBalanceForCredits(info.credits)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 473:                     IYieldy(YIELDY_TOKEN).tokenBalanceForCredits(_credits)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">474:                 );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">475:             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">476:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">477:     }</span></span></span></code></pre>\n<h2 id=\"g-03-caching-storage-values-in-memory\" style=\"position:relative;\"><a href=\"#g-03-caching-storage-values-in-memory\" aria-label=\"g 03 caching storage values in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Caching storage values in memory</h2>\n<p>The code can be optimized by minimizing the number of SLOADs.</p>\n<p>SLOADs are expensive (100 gas after the 1st one) compared to MLOADs/MSTOREs (3 gas each). Storage values read multiple times should instead be cached in memory the first time (costing 1 SLOAD) and then read from this cache to avoid multiple SLOADs.</p>\n<ul>\n<li><code>contracts[i]</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">BatchRequests</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">18</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">19</span><span class=\"mtk1\">:                 </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">canBatchTransactions</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">20</span><span class=\"mtk1\">:             ) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">21</span><span class=\"mtk1\">:                 </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">sendWithdrawalRequests</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<ul>\n<li><code>contracts[i]</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">BatchRequests</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">canBatch</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">canBatchTransactions</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">38</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">batch</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">Batch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">canBatch</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<ul>\n<li><code>contracts[_index]</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">BatchRequests</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">56</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_index</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">57</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_index</span><span class=\"mtk1\">]).</span><span class=\"mtk11\">canBatchTransactions</span><span class=\"mtk1\">()</span></span></span></code></pre>\n<ul>\n<li><code>stakingToken</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">64</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakingTokenBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">75</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<ul>\n<li><code>stakingContract</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: LiquidityReserve.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">72:         stakingContract = _stakingContract;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">81:         IERC20Upgradeable(rewardToken).approve(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 82:             stakingContract,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 82:             _stakingContract,</span></span></span></code></pre>\n<ul>\n<li><code>stakingToken</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">106</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stakingTokenBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<ul>\n<li><code>stakingToken</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">171</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) &gt;=</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">177</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<ul>\n<li><code>affiliateFee</code> and <code>FEE_ADDRESS</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_sendAffiliateFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">130</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">affiliateFee</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">FEE_ADDRESS</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">131</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">affiliateFee</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TOKE_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FEE_ADDRESS</span><span class=\"mtk1\">, </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">134</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<ul>\n<li><code>TOKE_TOKEN</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">144</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalTokeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TOKE_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">145</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">146</span><span class=\"mtk1\">:         );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">TOKE_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<ul>\n<li><code>requestWithdrawalAmount</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">392</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">requestWithdrawalAmount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">393</span><span class=\"mtk1\">:                 </span><span class=\"mtk11\">_requestWithdrawalFromTokemak</span><span class=\"mtk1\">(</span><span class=\"mtk12\">requestWithdrawalAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">394</span><span class=\"mtk1\">:             }</span></span></span></code></pre>\n<ul>\n<li><code>YIELDY_TOKEN</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">519</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">walletBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">522</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">warmUpBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">tokenBalanceForCredits</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">545</span><span class=\"mtk1\">:                     </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">creditsForTokenBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">546</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">remainingAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IYieldy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">559</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">YIELDY_TOKEN</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<ul>\n<li><code>LIQUIDITY_RESERVE</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">583</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">LIQUIDITY_RESERVE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">588</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">ILiquidityReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">LIQUIDITY_RESERVE</span><span class=\"mtk1\">).</span><span class=\"mtk11\">instantUnstake</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<ul>\n<li><code>CURVE_POOL</code> / <code>STAKING_TOKEN</code> / <code>TOKE_POOL</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">633</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">CURVE_POOL</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">634</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address0</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurvePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CURVE_POOL</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">635</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address1</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ICurvePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CURVE_POOL</span><span class=\"mtk1\">).</span><span class=\"mtk11\">coins</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">636</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">637</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">638</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">639</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">TOKE_POOL</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">address0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">STAKING_TOKEN</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">address1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">640</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">641</span><span class=\"mtk1\">:             } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">TOKE_POOL</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">address1</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">STAKING_TOKEN</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">address0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">642</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">643</span><span class=\"mtk1\">:             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">644</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid Curve Pool&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">645</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">646</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">curvePoolFrom</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">from</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">647</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">curvePoolTo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">to</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">648</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">649</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogSetCurvePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">CURVE_POOL</span><span class=\"mtk1\">, </span><span class=\"mtk12\">curvePoolTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">curvePoolFrom</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">650</span><span class=\"mtk1\">:         }</span></span></span></code></pre>\n<ul>\n<li><code>_totalSupply</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Yieldy.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">82:         uint256 currentTotalSupply = _totalSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 83:         require(_totalSupply &gt; 0, &quot;Can&#39;t rebase if not circulating&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 83:         require(currentTotalSupply &gt; 0, &quot;Can&#39;t rebase if not circulating&quot;);</span></span></span></code></pre>\n<ul>\n<li><code>_totalSupply</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">:                 totalStakedAfter: </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">129</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">LogSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_epoch</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"g-04-avoid-emitting-a-storage-variable-when-a-memory-value-is-available\" style=\"position:relative;\"><a href=\"#g-04-avoid-emitting-a-storage-variable-when-a-memory-value-is-available\" aria-label=\"g 04 avoid emitting a storage variable when a memory value is available permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Avoid emitting a storage variable when a memory value is available</h2>\n<p>When they are the same, consider emitting the memory value instead of the storage value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Staking.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">646:             curvePoolFrom = from;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">647:             curvePoolTo = to;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">648: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 649:             emit LogSetCurvePool(CURVE_POOL, curvePoolTo, curvePoolFrom);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 649:             emit LogSetCurvePool(CURVE_POOL, to, from);</span></span></span></code></pre>\n<h2 id=\"g-05-unchecking-arithmetics-operations-that-cant-underflowoverflow\" style=\"position:relative;\"><a href=\"#g-05-unchecking-arithmetics-operations-that-cant-underflowoverflow\" aria-label=\"g 05 unchecking arithmetics operations that cant underflowoverflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Unchecking arithmetics operations that can’t underflow/overflow</h2>\n<p>Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn’t possible (as an example, when a comparison is made before the arithmetic operation), some gas can be saved by using an <code>unchecked</code> block: <a href=\"https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic\">https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic</a></p>\n<p>Consider wrapping with an <code>unchecked</code> block here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Yieldy.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">210:         require(_allowances[_from][msg.sender] &gt;= _value, &quot;Allowance too low&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">211: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 212:         uint256 newValue = _allowances[_from][msg.sender] - _value;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 212:         unchecked { uint256 newValue = _allowances[_from][msg.sender] - _value; }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Yieldy.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">190:         require(creditAmount &lt;= creditBalances[msg.sender], &quot;Not enough funds&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">191: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 192:         creditBalances[msg.sender] = creditBalances[msg.sender] - creditAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 192:         unchecked { creditBalances[msg.sender] = creditBalances[msg.sender] - creditAmount; }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: Staking.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">713:             if (balance &lt;= staked) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">714:                 epoch.distribute = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">715:             } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 716:                 epoch.distribute = balance - staked;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 716:                 unchecked { epoch.distribute = balance - staked; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">717:             }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: LiquidityReserve.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 196:         uint256 amountMinusFee = _amount - ((_amount * fee) / BASIS_POINTS);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 196:         unchecked { uint256 amountMinusFee = _amount - ((_amount * fee) / BASIS_POINTS); }</span></span></span></code></pre>\n<h2 id=\"g-06-liquidityreservestorage--tightly-pack-storage-variables\" style=\"position:relative;\"><a href=\"#g-06-liquidityreservestorage--tightly-pack-storage-variables\" aria-label=\"g 06 liquidityreservestorage  tightly pack storage variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] <code>LiquidityReserveStorage</code> : Tightly pack storage variables</h2>\n<p>Here, variables can be tightly packed from to save 1 SLOT:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: LiquidityReserveStorage.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">04: contract LiquidityReserveStorage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">05:     address public stakingToken; // staking token address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">06:     address public rewardToken; // reward token address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">07:     address public stakingContract; // staking contract address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 8:     bool public isReserveEnabled; // ensures we are fully initialized</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">08:     uint256 public fee; // fee for instant unstaking</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">09:     uint256 public constant MINIMUM_LIQUIDITY = 10**3; // lock minimum stakingTokens for initial liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">10:     uint256 public constant BASIS_POINTS = 10000; // 100% in basis points</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 11:     bool public isReserveEnabled; // ensures we are fully initialized //@audit can be tightly packed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">12: }</span></span></span></code></pre>\n<h2 id=\"g-07-yieldystorage--tightly-pack-storage-variables\" style=\"position:relative;\"><a href=\"#g-07-yieldystorage--tightly-pack-storage-variables\" aria-label=\"g 07 yieldystorage  tightly pack storage variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] <code>YieldyStorage</code> : Tightly pack storage variables</h2>\n<p>Here, variables can be tightly packed from to save 1 SLOT:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: YieldyStorage.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">06: contract YieldyStorage {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">07:     address public stakingContract;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 08:     uint8 internal decimal;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">08:     Rebase[] public rebases;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">09:     uint256 public index;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">10:     bytes32 public constant ADMIN_ROLE = keccak256(&quot;ADMIN&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">11:     bytes32 public constant MINTER_BURNER_ROLE =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">12:         keccak256(&quot;MINTER_BURNER_ROLE&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">13:     bytes32 public constant REBASE_ROLE = keccak256(&quot;REBASE_ROLE&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">14: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">15:     uint256 internal WAD;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">16:     uint256 internal constant MAX_UINT256 = ~uint256(0);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">17: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">18:     uint256 internal constant MAX_SUPPLY = ~uint128(0); // (2^128) - 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">19:     uint256 public rebasingCreditsPerToken; // gonsPerFragment (fragment == 1 token)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">20:     uint256 public rebasingCredits; // total credits in system</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">21:     mapping(address =&gt; uint256) public creditBalances; // gonBalances (gon == credit)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">22: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 23:     uint8 internal decimal; //@audit can be tightly packed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">24: }</span></span></span></code></pre>\n<h2 id=\"g-08-duplicated-conditions-should-be-refactored-to-a-modifier-or-function-to-save-deployment-costs\" style=\"position:relative;\"><a href=\"#g-08-duplicated-conditions-should-be-refactored-to-a-modifier-or-function-to-save-deployment-costs\" aria-label=\"g 08 duplicated conditions should be refactored to a modifier or function to save deployment costs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] Duplicated conditions should be refactored to a modifier or function to save deployment costs</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">105</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">192</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">215</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"g-09-a-modifier-used-only-once-and-not-being-inherited-should-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g-09-a-modifier-used-only-once-and-not-being-inherited-should-be-inlined-to-save-gas\" aria-label=\"g 09 a modifier used only once and not being inherited should be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] A modifier used only once and not being inherited should be inlined to save gas</h2>\n<p>Affected code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">24</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyStakingContract</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">188</span><span class=\"mtk1\">      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">instantUnstake</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  189          </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  190:         </span><span class=\"mtk11\">onlyStakingContract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  191      {</span></span></span></code></pre>\n<h2 id=\"g-10-pre-solidity-0813--0-is-less-efficient-than--0-for-unsigned-integers-with-proof\" style=\"position:relative;\"><a href=\"#g-10-pre-solidity-0813--0-is-less-efficient-than--0-for-unsigned-integers-with-proof\" aria-label=\"g 10 pre solidity 0813  0 is less efficient than  0 for unsigned integers with proof permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Pre-Solidity <code>0.8.13</code>: <code>> 0</code> is less efficient than <code>!= 0</code> for unsigned integers (with proof)</h2>\n<p>Up until Solidity <code>0.8.13</code>: <code>!= 0</code> costs less gas compared to <code>> 0</code> for unsigned integers in <code>require</code> statements with the optimizer enabled (6 gas)</p>\n<p>Proof: While it may seem that <code>> 0</code> is cheaper than <code>!=</code>, this is only true without the optimizer enabled and outside a require statement. If you enable the optimizer AND you’re in a <code>require</code> statement, this will save gas. You can see this tweet for more proofs: <a href=\"https://twitter.com/gzeon/status/1485428085885640706\">https://twitter.com/gzeon/status/1485428085885640706</a></p>\n<p>Consider changing <code>> 0</code> with <code>!= 0</code> here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">118</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must enter valid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">410</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have valid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">572</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">604</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">83</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Can&#39;t rebase if not circulating&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">96</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rebasingCreditsPerToken</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid change in supply&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Also, please enable the Optimizer.</p>\n<h2 id=\"g-11--is-cheaper-than--and--cheaper-than-\" style=\"position:relative;\"><a href=\"#g-11--is-cheaper-than--and--cheaper-than-\" aria-label=\"g 11  is cheaper than  and  cheaper than  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] <code>>=</code> is cheaper than <code>></code> (and <code>&#x3C;=</code> cheaper than <code>&#x3C;</code>)</h2>\n<p>Strict inequalities (<code>></code>) are more expensive than non-strict ones (<code>>=</code>). This is due to some supplementary checks (ISZERO, 3 gas). This also holds true between <code>&#x3C;=</code> and <code>&#x3C;</code>.</p>\n<p>Consider replacing strict inequalities with non-strict ones to save some gas here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">324</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountToRequest</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g-12-splitting-require-statements-that-use--saves-gas\" style=\"position:relative;\"><a href=\"#g-12-splitting-require-statements-that-use--saves-gas\" aria-label=\"g 12 splitting require statements that use  saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</h2>\n<p>If you’re using the Optimizer at 200, instead of using the <code>&#x26;&#x26;</code> operator in a single require statement to check multiple conditions, Consider using multiple require statements with 1 condition per require statement:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">45</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">_stakingToken</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">_rewardToken</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Migration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">21</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">_oldContract</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">_newContract</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">55</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">_stakingToken</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">56</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">_yieldyToken</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">57</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">_tokeToken</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">58</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">_tokePool</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">59</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">_tokeManager</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">60</span><span class=\"mtk1\">:                </span><span class=\"mtk12\">_tokeReward</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">575</span><span class=\"mtk1\">:            !</span><span class=\"mtk12\">isUnstakingPaused</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isInstantUnstakingPaused</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">606</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">CURVE_POOL</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">612</span><span class=\"mtk1\">:            !</span><span class=\"mtk12\">isUnstakingPaused</span><span class=\"mtk1\"> &amp;&amp; !</span><span class=\"mtk12\">isInstantUnstakingPaused</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<p>Please, note that this might not hold true at a higher number of runs for the Optimizer (10k). However, it indeed is true at 200.</p>\n<h2 id=\"g-13-using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g-13-using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g 13 using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Using private rather than public for constants saves gas</h2>\n<p>If needed, the value can be read from the verified contract source code. Savings are due to the compiler not having to create non-payable getter functions for deployment calldata, and not adding another entry to the method ID table</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserveStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">9</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MINIMUM_LIQUIDITY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">3</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// lock minimum stakingTokens for initial liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserveStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">10</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100% in basis points</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">StakingStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">39</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// 100% in basis points</span></span></span></code></pre>\n<h2 id=\"g-14-amounts-should-be-checked-for-0-before-calling-a-transfer\" style=\"position:relative;\"><a href=\"#g-14-amounts-should-be-checked-for-0-before-calling-a-transfer\" aria-label=\"g 14 amounts should be checked for 0 before calling a transfer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-14] Amounts should be checked for 0 before calling a transfer</h2>\n<p>Checking non-zero transfer values can avoid an expensive external call and save gas.</p>\n<p>Consider adding a non-zero-value check here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">121</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">177</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">198</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">204</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">IERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<h2 id=\"g-15-i-costs-less-gas-compared-to-i-or-i--1-same-for---i-vs-i---or-i---1\" style=\"position:relative;\"><a href=\"#g-15-i-costs-less-gas-compared-to-i-or-i--1-same-for---i-vs-i---or-i---1\" aria-label=\"g 15 i costs less gas compared to i or i  1 same for   i vs i   or i   1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-15] <code>++i</code> costs less gas compared to <code>i++</code> or <code>i += 1</code> (same for <code>--i</code> vs <code>i--</code> or <code>i -= 1</code>)</h2>\n<p>Pre-increments and pre-decrements are cheaper.</p>\n<p>For a <code>uint256 i</code> variable, the following is true with the Optimizer enabled at 10k:</p>\n<p><strong>Increment:</strong></p>\n<ul>\n<li><code>i += 1</code> is the most expensive form</li>\n<li><code>i++</code> costs 6 gas less than <code>i += 1</code></li>\n<li><code>++i</code> costs 5 gas less than <code>i++</code> (11 gas less than <code>i += 1</code>)</li>\n</ul>\n<p><strong>Decrement:</strong></p>\n<ul>\n<li><code>i -= 1</code> is the most expensive form</li>\n<li><code>i--</code> costs 11 gas less than <code>i -= 1</code></li>\n<li><code>--i</code> costs 5 gas less than <code>i--</code> (16 gas less than <code>i -= 1</code>)</li>\n</ul>\n<p>Note that post-increments (or post-decrements) return the old value before incrementing or decrementing, hence the name <em>post-increment</em>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">j</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++, </span><span class=\"mtk8\">&quot;This will be false as i is incremented after the comparison&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>However, pre-increments (or pre-decrements) return the new value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">j</span><span class=\"mtk1\"> == ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;This will be true as i is incremented before the comparison&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In the pre-increment case, the compiler has to create a temporary variable (when used) for returning <code>1</code> instead of <code>2</code>.</p>\n<p>Affected code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">708</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">epoch</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">++;</span></span></span></code></pre>\n<p>Consider using pre-increments and pre-decrements where they are relevant (meaning: not where post-increments/decrements logic are relevant).</p>\n<h2 id=\"g-16-public-functions-to-external\" style=\"position:relative;\"><a href=\"#g-16-public-functions-to-external\" aria-label=\"g 16 public functions to external permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-16] Public functions to external</h2>\n<p>An external call cost is less expensive than one of a public function.\nThe following functions could be set external to save gas and improve code quality (extracted from Slither).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">370</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unstakeAllFromTokemak</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h2 id=\"g-17-it-costs-more-gas-to-initialize-variables-with-their-default-value-than-letting-the-default-value-be-applied\" style=\"position:relative;\"><a href=\"#g-17-it-costs-more-gas-to-initialize-variables-with-their-default-value-than-letting-the-default-value-be-applied\" aria-label=\"g 17 it costs more gas to initialize variables with their default value than letting the default value be applied permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-17] It costs more gas to initialize variables with their default value than letting the default value be applied</h2>\n<p>If a variable is not set/initialized, it is assumed to have the default value (<code>0</code> for <code>uint</code>, <code>false</code> for <code>bool</code>, <code>address(0)</code> for address…). Explicitly initializing it with its default value is an anti-pattern and wastes gas.</p>\n<p>As an example: <code>for (uint256 i = 0; i &#x3C; numIterations; ++i) {</code> should be replaced with <code>for (uint256 i; i &#x3C; numIterations; ++i) {</code></p>\n<p>Affected code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">636</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">637</span><span class=\"mtk1\">:            </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Consider removing explicit initializations for default values.</p>\n<h2 id=\"g-18-upgrade-pragma\" style=\"position:relative;\"><a href=\"#g-18-upgrade-pragma\" aria-label=\"g 18 upgrade pragma permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-18] Upgrade pragma</h2>\n<p>Using newer compiler versions and the optimizer give gas optimizations. Also, additional safety checks are available for free.</p>\n<p>The advantages here are:</p>\n<ul>\n<li><strong>Contract existence checks</strong> (>= 0.8.10): external calls skip contract existence checks if the external call has a return value</li>\n</ul>\n<p>Consider upgrading here :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">BatchRequests</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">9</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">9</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserveStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">9</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Migration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">9</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">9</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">StakingStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">9</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">9</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">YieldyStorage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">9</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g-19-use-custom-errors-instead-of-revert-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g-19-use-custom-errors-instead-of-revert-strings-to-save-gas\" aria-label=\"g 19 use custom errors instead of revert strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-19] Use Custom Errors instead of Revert Strings to save Gas</h2>\n<p>Solidity 0.8.4 introduced custom errors. They are more gas efficient than revert strings, when it comes to deploy cost as well as runtime cost when the revert condition is met. Use custom errors instead of revert strings for gas savings.</p>\n<p>Custom errors from Solidity 0.8.4 are cheaper than revert strings (cheaper deployment cost and runtime cost when the revert condition is met)</p>\n<p>Source: <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/\">https://blog.soliditylang.org/2021/04/21/custom-errors/</a>:</p>\n<blockquote>\n<p>Starting from <a href=\"https://github.com/ethereum/solidity/releases/tag/v0.8.4\">Solidity v0.8.4</a>, there is a convenient and gas-efficient way to explain to users why an operation failed through the use of custom errors. Until now, you could already use strings to give more information about failures (e.g., <code>revert(\"Insufficient funds.\");</code>), but they are rather expensive, especially when it comes to deploy cost, and it is difficult to use dynamic information in them.</p>\n</blockquote>\n<p>Custom errors are defined using the <code>error</code> statement, which can be used inside and outside of contracts (including interfaces and libraries).</p>\n<p>Consider replacing all revert strings with custom errors in the solution.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">25</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">stakingContract</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not staking contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">44</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">61</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Already enabled&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">62</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_stakingContract</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Invalid address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">68</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">94</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_fee</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">BASIS_POINTS</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Out of range&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">105</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">163</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Not enough lr tokens&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">170</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">192</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">215</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">isReserveEnabled</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enabled yet&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Migration</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">20</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">54</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">118</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must enter valid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">143</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_claimAddress</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Invalid address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">408</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">isStakingPaused</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Staking is paused&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">410</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Must have valid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">527</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">572</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">574</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">586</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">reserveBalance</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">_amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enough funds in reserve&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">604</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">605</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">611</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">644</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">from</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid Curve Pool&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">676</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">isUnstakingPaused</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Unstaking is paused&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">58</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">stakingContract</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Already Initialized&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">59</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_stakingContract</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Invalid address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">83</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Can&#39;t rebase if not circulating&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">96</span><span class=\"mtk1\">:            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rebasingCreditsPerToken</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid change in supply&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">187</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Invalid address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">190</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">creditAmount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">creditBalances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">], </span><span class=\"mtk8\">&quot;Not enough funds&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">210</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_allowances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_from</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] &gt;= </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Allowance too low&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">249</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_address</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Mint to the zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">257</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">MAX_SUPPLY</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Max supply&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">279</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_address</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Burn from the zero address&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Yieldy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">286</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentCredits</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">creditAmount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enough balance&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"g-20-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" style=\"position:relative;\"><a href=\"#g-20-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\" aria-label=\"g 20 functions guaranteed to revert when called by normal users can be marked payable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-20] Functions guaranteed to revert when called by normal users can be marked <code>payable</code></h2>\n<p>If a function modifier such as <code>onlyOwner</code> is used, the function will revert if a normal user tries to pay the function. Marking the function as <code>payable</code> will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">BatchRequests</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">81</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">BatchRequests</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">89</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">LiquidityReserve</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">92</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">141</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">transferToke</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_claimAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">157</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setCurvePool</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_curvePool</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">167</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAffiliateFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_affiliateFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">177</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setAffiliateAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_affiliateAddress</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">187</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">shouldPauseStaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shouldPause</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">197</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">shouldPauseUnstaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shouldPause</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">207</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">shouldPauseInstantUnstaking</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_shouldPause</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">217</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setEpochDuration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">duration</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">226</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setWarmUpPeriod</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vestingPeriod</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">235</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setCoolDownPeriod</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_vestingPeriod</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">370</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">unstakeAllFromTokemak</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Staking</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">769</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">preSign</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">orderUid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h2 id=\"g-21-use-1000-rather-than-exponentiation-103\" style=\"position:relative;\"><a href=\"#g-21-use-1000-rather-than-exponentiation-103\" aria-label=\"g 21 use 1000 rather than exponentiation 103 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-21] Use <code>1000</code> rather than exponentiation <code>10**3</code></h2>\n<p><code>1000</code> is readable enough and the cost of the exponentiation operation would be saved here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ LiquidityReserveStorage.sol:9:    uint256 public constant MINIMUM_LIQUIDITY = 10**3; // lock minimum stakingTokens for initial liquidity</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- LiquidityReserveStorage.sol:9:    uint256 public constant MINIMUM_LIQUIDITY = 1000; // lock minimum stakingTokens for initial liquidity</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-06-yieldy-findings/issues/236#issuecomment-1179547089\">moose-code (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Excellent.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-4\">High Risk Findings (4)</a></p>\n<ul>\n<li><a href=\"#h-01-no-withdrawal-possible-for-eth-toke-pool\">[H-01] No withdrawal possible for ETH TOKE pool</a></li>\n<li><a href=\"#h-02-stakingsolstake-dos-by-staking-1-wei-for-the-recipient-when-warmupperiod--0\">[H-02] <code>Staking.sol#stake()</code> DoS by staking 1 wei for the recipient when <code>warmUpPeriod > 0</code></a></li>\n<li><a href=\"#h-03-denial-of-service-by-wrong-batchrequestsremoveaddress-logic\">[H-03] Denial of Service by wrong <code>BatchRequests.removeAddress</code> logic</a></li>\n<li><a href=\"#h-04-yield-of-liquidityreserve-can-be-stolen\">[H-04] Yield of <code>LiquidityReserve</code> can be stolen</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-27\">Medium Risk Findings (27)</a></p>\n<ul>\n<li><a href=\"#m-01-unsecure-transferfrom\">[M-01] Unsecure <code>transferFrom</code></a></li>\n<li><a href=\"#m-02-its-possible-to-perform-dos-and-fund-lose-in-stacking-by-transferring-tokens-directly-to-contract-\">[M-02] It’s possible to perform DOS and fund lose in Stacking by transferring tokens directly to contract </a></li>\n<li><a href=\"#m-03-minterburnerrole-can-burn-any-amount-of-yieldy-from-an-arbitrary-address\">[M-03] MINTER<em>BURNER</em>ROLE can burn any amount of Yieldy from an arbitrary address</a></li>\n<li><a href=\"#m-04-arbitrage-on-stake\">[M-04] Arbitrage on <code>stake()</code></a></li>\n<li><a href=\"#m-05-possible-dos-out-of-gas-on-loops\">[M-05] Possible DOS (out-of-gas) on loops.</a></li>\n<li><a href=\"#m-06-user-can-initiate-withdraw-for-previous-epoch-if-rebase-hasnt-been-called-since-end-of-epoch\">[M-06] User can initiate withdraw for previous epoch if rebase hasn’t been called since end of epoch</a></li>\n<li><a href=\"#m-07-withdrawals-initiated-after-cycle-withdrawal-request-wont-be-withdrawn-in-the-correct-cycle\">[M-07] Withdrawals initiated after cycle withdrawal request won’t be withdrawn in the correct cycle</a></li>\n<li><a href=\"#m-08-rebases-can-be-frontrun-with-very-little-token-downtime-even-when-warmupperiod--0\">[M-08] Rebases can be frontrun with very little token downtime even when warmUpPeriod > 0</a></li>\n<li><a href=\"#m-09-users-of-migrationsol-may-forfeit-rebase-rewards\">[M-09] Users of Migration.sol may forfeit rebase rewards</a></li>\n<li><a href=\"#m-10-no-way-to-set-curve_pool-approval-after-setting-new-curve-pool-address\">[M-10] No way to set CURVE_POOL approval after setting new curve pool address</a></li>\n<li><a href=\"#m-11-burn-access-control-can-be-bypassed\">[M-11] Burn access control can be bypassed</a></li>\n<li><a href=\"#m-12-inconsistent-balance-when-fee-on-transfer-tokens\">[M-12] Inconsistent balance when fee-on transfer tokens.</a></li>\n<li><a href=\"#m-13-sending-batch-withdrawal-requests-can-possibly-dos\">[M-13] Sending batch withdrawal requests can possibly DoS</a></li>\n<li><a href=\"#m-14-incorrect-rebase-percentage-calculation\">[M-14] Incorrect rebase percentage calculation</a></li>\n<li><a href=\"#m-15-token-transfers-in-liquidityreserve-and-staking-contract-dont-support-deflationary-erc20-tokens-and-user-funds-can-be-lost-if-stacking-token-was-deflationary\">[M-15] token transfers in LiquidityReserve and Staking contract don’t support deflationary ERC20 tokens, and user funds can be lost if stacking token was deflationary</a></li>\n<li><a href=\"#m-16-_storerebase-is-called-with-the-wrong-parameters\">[M-16] <code>_storeRebase()</code> is called with the wrong parameters</a></li>\n<li><a href=\"#m-17-staking-rebase-does-not-rebase-according-to-the-status-of-the-current-epoch\">[M-17] Staking: rebase() does not rebase according to the status of the current epoch.</a></li>\n<li><a href=\"#m-18-removal-of-liquidity-from-the-reserve-can-be-griefed\">[M-18] Removal of liquidity from the reserve can be griefed</a></li>\n<li><a href=\"#m-19-staking-the-rebase-function-needs-to-be-called-before-calling-the-function-in-the-yieldy-contract-that-uses-the-rebasingcreditspertoken-variable\">[M-19] Staking: the rebase function needs to be called before calling the function in the Yieldy contract that uses the rebasingCreditsPerToken variable</a></li>\n<li><a href=\"#m-20-user-fund-lose-in-addliquidity-of-liquidityreserve-by-increasing-totallockedvalue--totalsupply-to-very-large-number-by-attacker\">[M-20] User fund lose in addLiquidity() of LiquidityReserve by increasing (totalLockedValue / totalSupply()) to very large number by attacker</a></li>\n<li><a href=\"#m-21-cannot-mint-to-exactly-max-supply-using-_mint-function\">[M-21] Cannot mint to exactly max supply using <code>_mint</code> function</a></li>\n<li><a href=\"#m-22-minimum_liquidity-checks-missing---bringing-liquidity-below-required-min\">[M-22] MINIMUM_LIQUIDITY checks missing - Bringing Liquidity below required min</a></li>\n<li><a href=\"#m-23-incorrect-withdrawal-requested\">[M-23] Incorrect withdrawal requested</a></li>\n<li><a href=\"#m-24-staking-presign-could-use-some-basic-validations\">[M-24] Staking <code>preSign</code> could use some basic validations</a></li>\n<li><a href=\"#m-25-cooldown--warmup-period-do-not-work-when-a-low-_firstepochendtime-is-passed-to-initialize\">[M-25] coolDown &#x26; warmUp period do not work when a low _firstEpochEndTime is passed to initialize</a></li>\n<li><a href=\"#m-26-instantunstake-function-can-be-frontrunned-with-fee-increase\">[M-26] instantUnstake function can be frontrunned with fee increase</a></li>\n<li><a href=\"#m-27-instantunstake-fee-can-be-avoided\">[M-27] instantUnstake fee can be avoided</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk-issues\">Low Risk Issues</a></li>\n<li><a href=\"#l-01-batch-related-functions-will-revert-if-removeaddress-is-called\">L-01 Batch-related functions will revert if <code>removeAddress()</code> is called</a></li>\n<li><a href=\"#l-02-staking-contracts-token-not-verified-to-be-the-same-token-as-the-staking-token\">L-02 Staking contract’s token not verified to be the same token as the staking token</a></li>\n<li><a href=\"#l-03-missing-infinite-approval-functionality\">L-03 Missing infinite approval functionality</a></li>\n<li><a href=\"#l-04-missing-checks-that-the-end-time-matches-the-duration\">L-04 Missing checks that the end time matches the duration</a></li>\n<li><a href=\"#l-05-missing-input-validations-and-timelocks\">L-05 Missing input validations and timelocks</a></li>\n<li><a href=\"#l-06-front-runable-initializer\">L-06 Front-runable initializer</a></li>\n<li><a href=\"#non-critical-issues\">Non-Critical Issues</a></li>\n<li><a href=\"#n-01-return-values-of-approve-not-checked\">N-01 Return values of <code>approve()</code> not checked</a></li>\n<li><a href=\"#n-02-misleading-variable-names\">N-02 Misleading variable names</a></li>\n<li><a href=\"#n-03-public-functions-not-called-by-the-contract-should-be-declared-external-instead\">N-03 <code>public</code> functions not called by the contract should be declared <code>external</code> instead</a></li>\n<li><a href=\"#n-04-constants-should-be-defined-rather-than-using-magic-numbers\">N-04 <code>constant</code>s should be defined rather than using magic numbers</a></li>\n<li><a href=\"#n-05-use-a-more-recent-version-of-solidity\">N-05 Use a more recent version of solidity</a></li>\n<li><a href=\"#n-06-typos\">N-06 Typos</a></li>\n<li><a href=\"#n-07-natspec-is-incomplete\">N-07 NatSpec is incomplete</a></li>\n<li><a href=\"#n-08-event-is-missing-indexed-fields\">N-08 Event is missing <code>indexed</code> fields</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#g-01-duplicated-external-function-call\">G-01 Duplicated external function call</a></li>\n<li><a href=\"#g-02-wrong-use-of-the-memory-keyword-for-a-struct\">G-02 Wrong use of the <code>memory</code> keyword for a Struct</a></li>\n<li><a href=\"#g-03-caching-storage-values-in-memory\">G-03 Caching storage values in memory</a></li>\n<li><a href=\"#g-04-avoid-emitting-a-storage-variable-when-a-memory-value-is-available\">G-04 Avoid emitting a storage variable when a memory value is available</a></li>\n<li><a href=\"#g-05-unchecking-arithmetics-operations-that-cant-underflowoverflow\">G-05 Unchecking arithmetics operations that can’t underflow/overflow</a></li>\n<li><a href=\"#g-06-liquidityreservestorage--tightly-pack-storage-variables\">G-06 <code>LiquidityReserveStorage</code> : Tightly pack storage variables</a></li>\n<li><a href=\"#g-07-yieldystorage--tightly-pack-storage-variables\">G-07 <code>YieldyStorage</code> : Tightly pack storage variables</a></li>\n<li><a href=\"#g-08-duplicated-conditions-should-be-refactored-to-a-modifier-or-function-to-save-deployment-costs\">G-08 Duplicated conditions should be refactored to a modifier or function to save deployment costs</a></li>\n<li><a href=\"#g-09-a-modifier-used-only-once-and-not-being-inherited-should-be-inlined-to-save-gas\">G-09 A modifier used only once and not being inherited should be inlined to save gas</a></li>\n<li><a href=\"#g-10-pre-solidity-0813--0-is-less-efficient-than--0-for-unsigned-integers-with-proof\">G-10 Pre-Solidity <code>0.8.13</code>: <code>> 0</code> is less efficient than <code>!= 0</code> for unsigned integers (with proof)</a></li>\n<li><a href=\"#g-11--is-cheaper-than--and--cheaper-than-\">G-11 <code>>=</code> is cheaper than <code>></code> (and <code>&#x3C;=</code> cheaper than <code>&#x3C;</code>)</a></li>\n<li><a href=\"#g-12-splitting-require-statements-that-use--saves-gas\">G-12 Splitting <code>require()</code> statements that use <code>&#x26;&#x26;</code> saves gas</a></li>\n<li><a href=\"#g-13-using-private-rather-than-public-for-constants-saves-gas\">G-13 Using private rather than public for constants saves gas</a></li>\n<li><a href=\"#g-14-amounts-should-be-checked-for-0-before-calling-a-transfer\">G-14 Amounts should be checked for 0 before calling a transfer</a></li>\n<li><a href=\"#g-15-i-costs-less-gas-compared-to-i-or-i--1-same-for---i-vs-i---or-i---1\">G-15 <code>++i</code> costs less gas compared to <code>i++</code> or <code>i += 1</code> (same for <code>--i</code> vs <code>i--</code> or <code>i -= 1</code>)</a></li>\n<li><a href=\"#g-16-public-functions-to-external\">G-16 Public functions to external</a></li>\n<li><a href=\"#g-17-it-costs-more-gas-to-initialize-variables-with-their-default-value-than-letting-the-default-value-be-applied\">G-17 It costs more gas to initialize variables with their default value than letting the default value be applied</a></li>\n<li><a href=\"#g-18-upgrade-pragma\">G-18 Upgrade pragma</a></li>\n<li><a href=\"#g-19-use-custom-errors-instead-of-revert-strings-to-save-gas\">G-19 Use Custom Errors instead of Revert Strings to save Gas</a></li>\n<li><a href=\"#g-20-functions-guaranteed-to-revert-when-called-by-normal-users-can-be-marked-payable\">G-20 Functions guaranteed to revert when called by normal users can be marked <code>payable</code></a></li>\n<li><a href=\"#g-21-use-1000-rather-than-exponentiation-103\">G-21 Use <code>1000</code> rather than exponentiation <code>10**3</code></a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Yieldy smart contract system written in Solidity. The audit contest took place between June 21—June 26, 2022.\n\n## Wardens\n\n110 Wardens contributed reports to the Yieldy contest:\n\n  1. Lambda\n  1. [Picodes](https://twitter.com/thePicodes)\n  1. 0x1f8b\n  1. 0x52\n  1. cccz\n  1. unforgiven\n  1. IllIllI\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. [berndartmueller](https://twitter.com/berndartmueller)\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. BowTiedWardens (BowTiedHeron, BowTiedPickle, [m4rio_eth](BowTiedETHernal), [Dravee](https://twitter.com/BowTiedDravee), and BowTiedFirefox)\n  1. [GalloDaSballo](https://twitter.com/gallodasballo)\n  1. asutorufos\n  1. sashik_eth\n  1. [minhquanym](https://www.linkedin.com/in/minhquanym/)\n  1. skoorch\n  1. [WatchPug](https://twitter.com/WatchPug_) ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. [MiloTruck](https://milotruck.github.io/)\n  1. 0x29A (0x4non and rotcivegaf)\n  1. elprofesor\n  1. [hansfriese](https://twitter.com/hansfriese)\n  1. [StErMi](https://ericci.dev/)\n  1. pashov\n  1. [shung](https://twitter.com/shunduquar)\n  1. [Chom](https://chom.dev)\n  1. 0xNineDec\n  1. zzzitron\n  1. robee\n  1. hake\n  1. TrungOre\n  1. [parashar](https://twitter.com/ankitparashar)\n  1. [defsec](https://twitter.com/defsec_)\n  1. [oyc&#95;109](https://twitter.com/andyfeili)\n  1. kenta\n  1. 0x1337\n  1. hubble (ksk2345 and shri4net)\n  1. PwnedNoMore ([izhuer](https://www.cs.purdue.edu/homes/zhan3299/index.html), ItsNio, and papr1ka2)\n  1. [m&#95;Rassska](https://t.me/Road220)\n  1. 0xDjango\n  1. Metatron\n  1. neumo\n  1. reassor\n  1. &#95;Adam\n  1. [0xNazgul](https://twitter.com/0xNazgul)\n  1. [joestakey](https://twitter.com/JoeStakey)\n  1. [TomJ](https://mobile.twitter.com/tomj_bb)\n  1. [FudgyDRS](https://www.reddit.com/user/FudgyDRS/)\n  1. scaraven\n  1. Bnke0x0\n  1. [fatherOfBlocks](https://twitter.com/father0fBl0cks)\n  1. [antonttc](https://github.com/antoncoding)\n  1. GimelSec ([rayn](https://twitter.com/rayn731) and sces60107)\n  1. [exd0tpy](https://github.com/exd0tpy)\n  1. 0xf15ers (remora and twojoy)\n  1. Waze\n  1. ladboy233\n  1. [Sm4rty](https://twitter.com/Sm4rty_)\n  1. Noah3o6\n  1. [Funen](https://instagram.com/vanensurya)\n  1. Limbooo\n  1. sikorico\n  1. aga7hokakological\n  1. delfin454000\n  1. ElKu\n  1. [JC](https://twitter.com/sm4rtcontr4ct)\n  1. Kaiziron\n  1. simon135\n  1. mics\n  1. UnusualTurtle\n  1. 0xmint\n  1. [ych18](https://www.linkedin.com/in/yahia-chaabane/)\n  1. pedr02b2\n  1. ajtra\n  1. [Fabble](Fabble#9308)\n  1. 0xc0ffEE\n  1. cryptphi\n  1. dipp\n  1. samruna\n  1. ak1\n  1. [sseefried](http://seanseefried.org/blog)\n  1. PumpkingWok\n  1. tchkvsky\n  1. 0xkatana\n  1. [0xKitsune](https://github.com/0xKitsune)\n  1. RedOneN\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. Nyamcil\n  1. [Randyyy](https://twitter.com/randyyramadhan)\n  1. [c3phas](https://twitter.com/c3ph_)\n  1. [8olidity](https://twitter.com/8olidity)\n  1. [Fitraldys](https://twitter.com/fitraldys)\n  1. saian\n  1. [0v3rf10w](https://twitter.com/_0v3rf10w)\n  1. ACai\n  1. bardamu\n  1. sach1r0\n  1. [s3cunda](s3cunda.github.io)\n  1. slywaters\n  1. [ignacio](https://twitter.com/0xheynacho)\n\n\nThis contest was judged by the Float Capital team: [moose-code](https://github.com/moose-code), [JasoonS](https://github.com/JasoonS) & [denhampreen](https://github.com/denhampreen).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 31 unique vulnerabilities. Of these vulnerabilities, 4 received a risk rating in the category of HIGH severity and 27 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 70 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 70 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Yieldy contest repository](https://github.com/code-423n4/2022-06-yieldy), and is composed of 5 smart contracts written in the Solidity programming language and includes 892 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (4)\n## [[H-01] No withdrawal possible for ETH TOKE pool](https://github.com/code-423n4/2022-06-yieldy-findings/issues/87)\n_Submitted by Lambda_\n\nThe `withdraw` function of the ETH Tokemak pool has an additional parameter `asEth`. This can be seen in the Tokemak [Github repository](https://github.com/Tokemak/tokemak-smart-contracts-public/blob/2f54689d5d16ddfd1751493b161a049d6c98c382/contracts/pools/EthPool.sol#L94) or also when looking at the deployed code of the [ETH pool](https://etherscan.io/address/0xb104A7fA1041168556218DDb40Fe2516F88246d5#code). Compare that to e.g. the [USDC pool](https://etherscan.io/address/0xca5e07804beef19b6e71b9db18327d215cd58d4e#code), which does not have this parameter.\n\nThis means that the call to `withdraw` will when the staking token is ETH / WETH and no withdrawals would be possible.\n\n### Proof of Concept\n\nA new `Staking` contract with ETH / WETH as the staking token is deployed. Deposits in Tokemak work fine, so users stake their tokens. However, because of the previously described issue, no withdrawal is possible, leaving the funds locked.\n\n### Recommended Mitigation Steps\n\nHandle the case where the underlying asset is WETH / ETH separately and pass this boolean in that case.\n\n**[toshiSat (Yieldy) confirmed and resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/87)** \n\n***\n\n## [[H-02] `Staking.sol#stake()` DoS by staking 1 wei for the recipient when `warmUpPeriod > 0`](https://github.com/code-423n4/2022-06-yieldy-findings/issues/187)\n_Submitted by WatchPug, also found by BowTiedWardens, cccz, minhquanym, parashar, pashov, shung, and zzzitron_\n\n```solidity\nif (warmUpPeriod == 0) {\n    IYieldy(YIELDY_TOKEN).mint(_recipient, _amount);\n} else {\n    // create a claim and mint tokens so a user can claim them once warm up has passed\n    warmUpInfo[_recipient] = Claim({\n        amount: info.amount + _amount,\n        credits: info.credits +\n            IYieldy(YIELDY_TOKEN).creditsForTokenBalance(_amount),\n        expiry: epoch.number + warmUpPeriod\n    });\n\n    IYieldy(YIELDY_TOKEN).mint(address(this), _amount);\n}\n```\n\n`Staking.sol#stake()` is a public function and you can specify an arbitrary address as the `_recipient`.\n\nWhen `warmUpPeriod > 0`, with as little as 1 wei of `YIELDY_TOKEN`, the `_recipient`'s `warmUpInfo` will be push back til `epoch.number + warmUpPeriod`.\n\n### Recommended Mitigation Steps\n\nConsider changing to not allow deposit to another address when `warmUpPeriod > 0`.\n\n**[Dravee (warden) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/187#issuecomment-1167621029):**\n > Should be high right? Funds are locked.\n> See https://github.com/code-423n4/2022-06-yieldy-findings/issues/245#issuecomment-1167616593\n\n**[moose-code (judge) increased severity to High and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/187#issuecomment-1198122754):**\n> Agree this should be high. The cost of the attack is negligible and could cause basic perpetual grievance on all users with one simple script. \n\n**[toshiSat (Yieldy) confirmed](https://github.com/code-423n4/2022-06-yieldy-findings/issues/187)**\n\n***\n\n## [[H-03] Denial of Service by wrong `BatchRequests.removeAddress` logic](https://github.com/code-423n4/2022-06-yieldy-findings/issues/38)\n_Submitted by 0x1f8b, also found by rfa, berndartmueller, BowTiedWardens, csanuragjain, Lambda, neumo, and StErMi_\n\n**Note: issues #[283](https://github.com/code-423n4/2022-06-yieldy-findings/issues/283), [115](https://github.com/code-423n4/2022-06-yieldy-findings/issues/115), [82](https://github.com/code-423n4/2022-06-yieldy-findings/issues/82), [89](https://github.com/code-423n4/2022-06-yieldy-findings/issues/89), [61](https://github.com/code-423n4/2022-06-yieldy-findings/issues/61), and [241](https://github.com/code-423n4/2022-06-yieldy-findings/issues/241) were originally broken out as a separate medium issue. Approximately 1 week after judging and awarding were finalized, the judging team re-assessed that these should have all been grouped under H-03. Accordingly, the 6 warden names have been added as submitters above.**\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L93>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L57>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/34774d3f5e9275978621fd20af4fe466d195a88b/src/contracts/BatchRequests.sol#L37>\n\n### Impact\n\nThe `BatchRequests.removeAddress` logic is wrong and it will produce a denial of service.\n\n### Proof of Concept\n\nRemoving the element from the array is done using the `delete` statement, but this is not the proper way to remove an entry from an array, it will just set that position to `address(0)`.\n\nAppend dummy data:\n\n*   `addAddress('0x0000000000000000000000000000000000000001')`\n*   `addAddress('0x0000000000000000000000000000000000000002')`\n*   `addAddress('0x0000000000000000000000000000000000000003')`\n*   `getAddresses()` => `address[]: 0x0000000000000000000000000000000000000001,0x0000000000000000000000000000000000000002,0x0000000000000000000000000000000000000003`\n\nRemove address:\n\n*   `removeAddress(0x0000000000000000000000000000000000000002)` (or `0x0000000000000000000000000000000000000003`)\n*   `getAddresses()` => `address[]: 0x0000000000000000000000000000000000000001,0x0000000000000000000000000000000000000000,0x0000000000000000000000000000000000000003`\n\nService is denied because it will try to call `canBatchContracts`  to `address(0)`.\n\n### Recommended Mitigation Steps\n\n*   To remove an entry in an array you have to use `pop` and move the last element to the removed entry position.\n\n**[0xean (Yieldy) confirmed and resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/38)** \n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/38#issuecomment-1199272074):**\n > Agree this is high, if the team (owner) didn't know this they could cause some issues for sure.\n\n***\n\n## [[H-04] Yield of `LiquidityReserve` can be stolen](https://github.com/code-423n4/2022-06-yieldy-findings/issues/164)\n_Submitted by Picodes_\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L126>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L176>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L206>\n\n### Impact\n\nUsing sandwich attacks and JIT (Just-in-time liquidity), the yield of `LiquidityReserve` could be extracted for liquidity providers.\n\n### Proof of Concept\n\nThe yield of `LiquidityReserve` is distributed when a user calls `instantUnstakeReserve()` in `Staking`. Then, in `instantUnstake`, `totalLockedValue` increases with the fee paid by the user withdrawing. The fee is shared between all liquidity providers as they all see the value of their shares increase.\n\nTherefore, an attacker could do the following sandwich attack when spotting a call to `instantUnstakeReserve()`.\n\n*   In a first tx before the user call, borrow a lot of `stakingToken` and `addLiquidity`\n*   The user call to `instantUnstakeReserve()` leading to a fee of say`x\\`\n*   In a second tx after the user call, `removeLiquidity` and repay the loan, taking a large proportion of the user fee\n\nThe problem here is that you can instantly add and remove liquidity without penalty, and that the yield is instantly distributed.\n\n### Recommended Mitigation Steps\n\nTo mitigate this, you can\n\n*   store the earned fees and distribute them across multiple blocks to make sure the attack wouldn’t be worth it\n*   add a small fee when removing liquidity, which would make the attack unprofitable\n*   prevent users from withdrawing before X blocks or add a locking mechanism\n\n**[0xean (Yieldy) disagreed with severity and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1167971720):**\n > This is not unique to the protocol and is a vulnerability in almost all of the LP designs that are prevalent today. There is no loss of user funds here either.\n> \n> Would downgrade to Low or QA.\n\n**[Picodes (warden) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1169363435):**\n > In standard cases of JIT, for example in a DEX, the attacker takes a risk as the liquidity he adds is used during the swap, and this liquidity is useful for the protocol as leads to a better price for the user, which is not the case here\n\n**[0xean (Yieldy) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1169371024):**\n > @Picodes - that is fair but the liquidity is still useful and I still don't see how this qualifies as high severity.  Eventually it would mean that the liquidity reserve would need less liquidity parked in it if JITers always where hitting it. \n\n**[Picodes (warden) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1169551914):**\n > To me it's high because: (correct me if I am missing things)\n> \n>  - JIT is not useful here at all for the protocol, the liquidity they bring is not useful as does not get locked. It's totally risk free, and as you said it’s a commun attack so it’s likely that someone uses it\n>  - It leads to a loss of LP funds: \n> \tAssume there is 100k unlocked in the pool, and someone `instantUnstake` 100k, it’ll lock all the LP liquidity. But if someone JITs this, the fees will go to the attacker and not the LP which provided the service by accepting to have its liquidity locked. \n>  - From a protocol point of view, LPing becomes unattractive as all the fees are stolen, breaking the product design\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/164#issuecomment-1201261638):**\n > Agree going to leave this as high. Any whale that does a large unstake will be susceptible to having more of the fee's eroded to a predatory sandwich attack which provides no value to the system. \n\n***\n\n \n# Medium Risk Findings (27)\n## [[M-01] Unsecure `transferFrom`](https://github.com/code-423n4/2022-06-yieldy-findings/issues/36)\n_Submitted by 0x1f8b, also found by 0xNineDec and StErMi_\n\nThe security of the `Yieldy` contract is delegated to the compiler used.\n\n### Proof of Concept\n\nThe `allowance` of an account does not have to reflect the real balance of an account, however in the `transferFrom` method, it is the value that is checked in order to verify that the user has enough balance to make the transfer.\n\n```javascript\n    function transferFrom(\n        address _from,\n        address _to,\n        uint256 _value\n    ) public override returns (bool) {\n        require(_allowances[_from][msg.sender] >= _value, \"Allowance too low\");\n```\n\nHowever, the real balance of the `Yieldy` contract is based on the calculation made by the `creditsForTokenBalance` method, so an underflow could be made in the subtraction of the balance of the `from` account.\n\n```javascript\n        uint256 creditAmount = creditsForTokenBalance(_value);\n        creditBalances[_from] = creditBalances[_from] - creditAmount;\n        creditBalances[_to] = creditBalances[_to] + creditAmount;\n        emit Transfer(_from, _to, _value);\n```\n\nThis means that the security of the contract is delegated to the checks added by the compiler depending on the pragma used, it must be taken into account that these checks may appear and disappear in future versions of the compiler, so they must be checked at the level of smart contracts.\n\nAffected source code:\n\n*   [Yieldy.sol#L212](https://github.com/code-423n4/2022-06-yieldy/blob/8400e637d9259b7917bde259a5a2fbbeb5946d45/src/contracts/Yieldy.sol#L212)\n\n### Recommended Mitigation Steps\n\n*   Check that the from account has a `creditAmount` balance.\n\n**[toshiSat (Yieldy) confirmed and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/36#issuecomment-1199930909):**\n > Looking into this, the balance isn't calculated through the `creditsForTokenBalance` method, it's calculated through the `balanceOf` method, which in this case the functionality is correct.  We aren't transferring credits, we are transferring the value and adding to the credits.  Allowance is for value amounts, not credits, also balance can only go up against credits, so if the balance is valid then credits are inherently valid too.  I'm unsure of what to label this as, because we do need to check to see if the user has the correct balance.  I feel like this issue is partially correct.\n\n**[toshiSat (Yieldy) resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/36#issuecomment-1199933589):**\n > https://github.com/shapeshift/foxy/pull/130/files for the fix.\n\n\n\n***\n\n## [[M-02] It's possible to perform DOS and fund lose in Stacking by transferring tokens directly to contract ](https://github.com/code-423n4/2022-06-yieldy-findings/issues/246)\n_Submitted by unforgiven_\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L78-L102>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L698-L719>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L401-L417>\n\n### Impact\n\nFunction `rebase()` in contract `Staking` calls `Yieldy.rebase(profit, )` and `Yieldy.rebase(profit, )` would revert if `rebasingCredits / updatedTotalSupply` was equal to `0`. it's possible to transfer some `STAKING_TOKEN` directly to `Stacking` contract before or after deployment of `Staking` and make `rebasingCredits / updatedTotalSupply` equal to `0`, and then most of the functionalities of `Staking` would not work because they call `rebase()` which will revert.\nit's possible to perform this DOS for any token by transferring some tokens `STAKING_TOKEN` to contract address and then staking `1 wei` in contract.\nor for tokens with low precisions and low price it's even possible to perform when `totalSupply()` of `Yieldy` is low.\n\nAlso attacker can only make `rebasingCredits / updatedTotalSupply`  too low and so rounding error would be significant when `rebasingCredits / updatedTotalSupply`  gets too low and users funds would be lost because of rounding error.\n\n### Proof of Concept\n\nThis is `rebase()` code in `Yieldy`:\n\n        function rebase(uint256 _profit, uint256 _epoch)\n            external\n            onlyRole(REBASE_ROLE)\n        {\n            uint256 currentTotalSupply = _totalSupply;\n            require(_totalSupply > 0, \"Can't rebase if not circulating\");\n\n            if (_profit == 0) {\n                emit LogSupply(_epoch, block.timestamp, currentTotalSupply);\n                emit LogRebase(_epoch, 0, getIndex());\n            } else {\n                uint256 updatedTotalSupply = currentTotalSupply + _profit;\n\n                if (updatedTotalSupply > MAX_SUPPLY) {\n                    updatedTotalSupply = MAX_SUPPLY;\n                }\n\n                rebasingCreditsPerToken = rebasingCredits / updatedTotalSupply;\n                require(rebasingCreditsPerToken > 0, \"Invalid change in supply\");\n\n                _totalSupply = updatedTotalSupply;\n\n                _storeRebase(updatedTotalSupply, _profit, _epoch);\n            }\n        }\n\nAs you can see if `  rebasingCredits / updatedTotalSupply == 0 ` then the code will revert. `updatedTotalSupply` is equal to `_totalSupply + _profit` and `rebasingCredits`  is `wad` in the first.\n`Yieldy.rebase(profit,)` is called by `Staking.rebase()`:\n\n        function rebase() public {\n            // we know about the issues surrounding block.timestamp, using it here will not cause any problems\n            if (epoch.endTime <= block.timestamp) {\n                IYieldy(YIELDY_TOKEN).rebase(epoch.distribute, epoch.number);\n\n                epoch.endTime = epoch.endTime + epoch.duration;\n                epoch.timestamp = block.timestamp;\n                epoch.number++;\n\n                uint256 balance = contractBalance();\n                uint256 staked = IYieldy(YIELDY_TOKEN).totalSupply();\n\n                if (balance <= staked) {\n                    epoch.distribute = 0;\n                } else {\n                    epoch.distribute = balance - staked;\n                }\n            }\n        }\n\nAs you can see the value of `_profit` is set to `epoch.distribute` which is `contractBalance() - IYieldy(YIELDY_TOKEN).totalSupply()` and `contractBalance()` is sum of `STAKING_TOKEN` and `TOKE` balance of `Staking` contract. so if attacker transfers `X` amount of `STAKCING_TOKEN` directly to `Staking` contract then the value of `_profit` which is going to send to `Yieldy.rebase(profit,)` would be higher than `X`. to exploit this attacker call `stake(1 wei)` after `Staking` deployment and then transfer `STAKING_TOKEN` directly to contract. then the value of `rebasingCredits` in `Yieldy` would be `2 wad` and the value of `_profit` sent to `Yieldy.rebase(profit,)` would be bigger than `2 wad` and `rebasingCredits / updatedTotalSupply` would be `0` and from now on all calls to `Staking.rebase()` would revert and that means functions `Stake()` and `instantUnstakeReserve()` and `instantUnstakeCurve()` wouldnt work anymore.\n\nIt's possible to perform this attack for low precision tokens with low price `STAKING_TOKEN` too. the only thing attacker needs to do is that in early stage of `Staking` deployment sends more than `rebasingCredits` of `STAKING_TOKEN` token directly to `Staking` contract address. then in `rebase()` contract send that amount as `profit` to `Yieldy.rebase()` and that call would revert which will cause most of the logics of `Staking` to revert and not work.\n\nand when `rebasingCredits / updatedTotalSupply`  is low, the rounding error would be high enough that the compounding yield won't show itself. attacker can make `rebasingCredits / updatedTotalSupply`  too low but not `0` and from then user's funds would be lost because of rounding error (wrong number of `Yieldy` token would be mint for user).\n\n### Tools Used\n\nVIM\n\n#### Recommended Mitigation Steps\n\nThe default initial value of `rebasingCredits` should be very high that attacker couldn't perform this attack.\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/246#issuecomment-1199950701):**\n> `rebasingCredits` is in credits and `updatedTotalSupply` is in token amounts.  So if even a small amount is staked, the attacker will have to send a large amount to go through with this attack vector for no financial gain.\n> \n> This seems like a low priority issue mainly because user funds won't get lost as if this were to occur then most likely no one has staked and the worst case scenario we will redeploy the contract.\n> Also, we will be staking on every yieldy as we deploy.\n> \n> I think we would like to eventually solve this, but for now this seems like it won't fall in our list of fixes for this iteration. \n> \n\n**[JasoonS (judge) decreased severity to Medium](https://github.com/code-423n4/2022-06-yieldy-findings/issues/246#issuecomment-1230559924):**\n > Downgrading to medium.\n\n\n\n***\n\n## [[M-03] MINTER_BURNER_ROLE can burn any amount of Yieldy from an arbitrary address](https://github.com/code-423n4/2022-06-yieldy-findings/issues/43)\n_Submitted by 0x1f8b_\n\nUsing the `burn()` function of `Yieldy`, an address with `MINTER_BURNER_ROLE` can burn an arbitrary amount of tokens from any address.\n\nWe believe this is unnecessary and poses a serious centralization risk.\n\nA malicious or compromised `MINTER_BURNER_ROLE` address can take advantage of this.\n\n### Recommended Mitigation Steps\n\nConsider removing the `MINTER_BURNER_ROLE` and change `burn()` function to:\n\n```javascript\n    function burn(uint256 _amount) external override \n    {\n        _burn(_msgSender(), _amount);\n    }\n```\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/43#issuecomment-1197442641):**\n > There's tons of centralization risks already, this is acknowledged, but for yieldies to work, there needs to be a trusted party.\n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/43#issuecomment-1230571763):**\n > Leaving as medium - the code can be upgraded but the code is being assessed as is.\n\n\n\n***\n\n## [[M-04] Arbitrage on `stake()`](https://github.com/code-423n4/2022-06-yieldy-findings/issues/243)\n_Submitted by BowTiedWardens, also found by WatchPug_\n\nIssue: there is a huge arb opportunity for people who deposit 1 block before the `rebase()`.\n\nConsequences: then they can call `instantUnstakeReserve` or `instantUnstakeCurve` to unstake the staked amount, in this way the profit that needs to be distributed on the next rebase increases, he also messes up the rewards for the other holders as the `instantUnstakeReserve` does not burn the `YIELD_TOKEN`. Even if there is a fee on the `instantUnstakeReserve`, there is still a chance for profit.\n\n**Affected Code**\n\n```solidity\nFile: Staking.sol\n406:     function stake(uint256 _amount, address _recipient) public { // @audit-info [HIGH] \n407:         // if override staking, then don't allow stake\n408:         require(!isStakingPaused, \"Staking is paused\");\n409:         // amount must be non zero\n410:         require(_amount > 0, \"Must have valid amount\");\n411: \n412:         uint256 yieldyTotalSupply = IYieldy(YIELDY_TOKEN).totalSupply();\n413: \n414:         // Don't rebase unless tokens are already staked or could get locked out of staking\n415:         if (yieldyTotalSupply > 0) {\n416:             rebase();\n417:         }\n418: \n419:         IERC20Upgradeable(STAKING_TOKEN).safeTransferFrom(\n420:             msg.sender,\n421:             address(this),\n422:             _amount\n423:         );\n424: \n425:         Claim storage info = warmUpInfo[_recipient];\n426: \n427:         // if claim is available then auto claim tokens\n428:         if (_isClaimAvailable(_recipient)) {\n429:             claim(_recipient);\n430:         }\n431: \n432:         _depositToTokemak(_amount);\n433: \n434:         // skip adding to warmup contract if period is 0\n435:         if (warmUpPeriod == 0) {\n436:             IYieldy(YIELDY_TOKEN).mint(_recipient, _amount);\n437:         } else {\n438:             // create a claim and mint tokens so a user can claim them once warm up has passed\n439:             warmUpInfo[_recipient] = Claim({\n440:                 amount: info.amount + _amount,\n441:                 credits: info.credits +\n442:                     IYieldy(YIELDY_TOKEN).creditsForTokenBalance(_amount),\n443:                 expiry: epoch.number + warmUpPeriod\n444:             });\n445: \n446:             IYieldy(YIELDY_TOKEN).mint(address(this), _amount);\n447:         }\n448: \n449:         sendWithdrawalRequests();\n450:     }\n```\n\n### Recommended Mitigation Steps\n\nBurn the `YIELD_TOKEN` amount in the `instantUnstakeReserve`.\n\n**[0xean (Yieldy) acknowledged, but disagreed with severity and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/243#issuecomment-1167959404):**\n > Yes, the fee on instant Unstake needs to be set high enough to make this not profitable. \n> \n> If a curve pool exists, then this does become possible to arb the rebase and something that should be fixed, potentially with not allowing the warm up period to be violated for instant unstaking (through curve at the very least). \n> \n> I would qualify this as Medium severity, and leaking value. \n> \n> `\n> 2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n> `\n\n**[JasoonS (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/243#issuecomment-1230560050):**\n > I took another look, medium seems reasonable too.\n\n***\n\n## [[M-05] Possible DOS (out-of-gas) on loops.](https://github.com/code-423n4/2022-06-yieldy-findings/issues/94)\n_Submitted by 0x29A, also found by minhquanym_\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L16>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L36>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L91>\n\n### Impact\n\nIt is possible to get an out-of-gas issue while iterating the for loop.\n\nPlease take a look at [this link](https://github.com/wissalHaji/solidity-coding-advices/blob/master/best-practices/be-careful-with-loops.md).\n\n### Proof of Concept\n\nLet's say I want to run the function on [`BatchRequests.sol#L14`](https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L14) and I got a lot of [`contracts`](https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/BatchRequests.sol#L9) pending for withdrawal.\n\n### Recommended Mitigation Steps\n\nUse this pattern;\n\n```solidity\n    /**\n        @notice sendWithdrawalRequests on all addresses in contracts\n     */\n    function sendWithdrawalRequests(uint256 from, uint256 to) external {\n        uint256 contractsLength = contracts.length;\n        require(from < contractsLength, \"Invalid from\");\n        require(to <= contractsLength, \"Invalid to\");\n        for (uint256 i = from; i < to; ) {\n            if (\n                contracts[i] != address(0) &&\n                IStaking(contracts[i]).canBatchTransactions()\n            ) {\n                IStaking(contracts[i]).sendWithdrawalRequests();\n            }\n            unchecked {\n                ++i;\n            }\n        }\n    }\n```\n**[0xean (Yieldy) acknowledged](https://github.com/code-423n4/2022-06-yieldy-findings/issues/94)** \n\n***\n\n## [[M-06] User can initiate withdraw for previous epoch if rebase hasn't been called since end of epoch](https://github.com/code-423n4/2022-06-yieldy-findings/issues/28)\n_Submitted by 0x52_\n\nUser is able to withdraw unstaked asset sooner than they should be.\n\n### Proof of Concept\n\n`Unstake()` allows the user to bypass the rebase() call by setting \\_trigger to false. Since rebase() is bypassed, epoch.number could potentially be stale i.e. doesn't match the Tokemak epoch. A user could potentially call unstake() with \\_trigger = false immediately after an epoch has ended but expiry would be set using the stale epoch.number because it wouldn't be updated by rebase(). This would allow the user to withdraw early before their funds were actually available in the contract because their withdrawal would be considered to be in the epoch before they actually initiated the withdrawal.\n\n### Recommended Mitigation Steps\n\n`Rebase()` cannot be optional when calling unstake.\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/28#issuecomment-1168978499):**\n > We use a coolDownAmount of 2 to get around this.\n\n\n\n***\n\n## [[M-07] Withdrawals initiated after cycle withdrawal request won't be withdrawn in the correct cycle](https://github.com/code-423n4/2022-06-yieldy-findings/issues/29)\n_Submitted by 0x52, also found by IllIllI_\n\nSome user withdrawals won't be available for withdrawal even though it should be.\n\n### Proof of Concept\n\n`sendWithdrawalRequest` can only happen once per cycle. canBatchTransactions (L386) must return true for the actual withdrawal request to happen. It checks in L362 that currentCycleIndex > lastTokeCycleIndex and in L397 of sendWithdrawlRequest, lastTokeCycleIndex = currentCycleIndex. This means that for the rest of the cycle, canBatchTransactions will return false. This means that if a user requests a withdrawal towards the end of epoch after the withdrawal has been submitted but before the end of the epoch, their withdrawal will be set to the current epoch but the actual token amount of their withdrawal won't be processed. This will lead to a discrepancy between the number of tokens withdrawn and the number of tokens allowed to be withdrawn by users, which means that not all users who are \"eligible\" for withdrawal will actually be able to withdraw because there won't be enough tokens for everyone.\n\n### Recommended Mitigation Steps\n\nThe requirement in L362 should be removed. As noted in the contract, \"TOKE's requestWithdrawal overwriting the amount if you call it more than once per cycle\". Overwriting the withdrawal is perfectly okay though because it already uses requestWithdrawalAmount which is a cumulative measure of the tokens that need to be withdrawn because it is only decreased when the asset it actually received from a withdrawal.\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/29#issuecomment-1168976944):**\n > We get around this by having a coolDownPeriod of 2.  It saves on gas and we only have to call `sendWithdrawalRequest` once per cycle.\n\n\n\n***\n\n## [[M-08] Rebases can be frontrun with very little token downtime even when warmUpPeriod > 0](https://github.com/code-423n4/2022-06-yieldy-findings/issues/31)\n_Submitted by 0x52, also found by elprofesor_\n\nRebases can be frontrun with very little token downtime even when `warmUpPeriod > 0`.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L415-L417>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L703>\n\nA user can call stake the block before epoch.endTime <= block.timestamp, allowing the user to bypass the forced rebase called in L416 of the the stake function. If warmUpPeriod > 0 then the user will receive a \"warmUpInfo\" with the value of their deposit. The very next block, the user can then call instantUnstakeCurve.\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L600-L627>\n\nThis will call rebase again in L633 and this time epoch.endTime <= block.timestamp will be true and it will trigger an actual rebase, distributing the pending rewards. \\_retrieveBalanceFromUser (L617) will then allows the user to unstake all the funds locked in warm up. The issue is that when unstaking it uses userWarmInfo.credits meaning that any rebalance rewards are kept. This allows the user to get in, collect the rebase, then immediately get out.\n\n### Recommended Mitigation Steps\n\nBeing able to unstake tokens even when in the warm up period is a useful feature but tokens unstaked during that period should not be allowed to accumulate any rebases or it can lead to situations like this. L537-L539 should be changed to:\n`warmUpBalance = userWarmInfo.amount`.\n\n**[toshiSat (Yieldy) acknowledged](https://github.com/code-423n4/2022-06-yieldy-findings/issues/226)** \n\n\n***\n\n## [[M-09] Users of Migration.sol may forfeit rebase rewards](https://github.com/code-423n4/2022-06-yieldy-findings/issues/33)\n_Submitted by 0x52, also found by berndartmueller_\n\nUsers of `moveFundsToUpgradedContract()` in migration.sol may forfeit rebase rewards.\n\n### Proof of Concept\n\nL54 calls instantUnstake(false) meaning that it skips the optional rebase. If there is a pending rebase then the user calling the function will not get this rebase and miss out on potential rewards.\n\n### Recommended Mitigation Steps\n\nAdd an input bool `\\_trigger` then add the following code to the start of the function:\n\nif (\\_trigger) {\nrebase();\n}\n\nThis allows users to optionally call rebase if they are concerned about losing pending rebase rewards.\n\n**[0xean (Yieldy) acknowledged](https://github.com/code-423n4/2022-06-yieldy-findings/issues/33)** \n\n***\n\n## [[M-10] No way to set CURVE_POOL approval after setting new curve pool address](https://github.com/code-423n4/2022-06-yieldy-findings/issues/165)\n_Submitted by 0xDjango, also found by BowTiedWardens, cccz, hansfriese, Metatron, shung, ych18, and zzzitron_\n\n`Staking.setCurvePool()` allows the owner to set a new `CURVE_POOL` address, however, there is no way to set token approvals to the new address. The only calls to `token.approve()` are found in the constructor. Therefore, there's no true way to set a new curve pool. All calls to `ICurvePool(CURVE_POOL).exchange()` will fail.\n\n### Recommended Mitigation Steps\n\nSet approvals for the new curve pool address in the same `setCurvePool()` function.\n\n**[0xean (Yieldy) acknowledged](https://github.com/code-423n4/2022-06-yieldy-findings/issues/165)** \n***\n\n## [[M-11] Burn access control can be bypassed](https://github.com/code-423n4/2022-06-yieldy-findings/issues/169)\n_Submitted by pashov, also found by csanuragjain, hake, kenta, m&#95;Rassska, and oyc&#95;109_\n\n`transferFrom` method does not check if `_to` argument is the zero address.\n\n### Impact\n\nThis can lead to token burns without calling the `burn` function, which has access control `onlyRole(MINTER_BURNER_ROLE)` but here this can be bypassed by passing the zero address as the value of `_to`.\n\n### Recommended Mitigation Steps\n\nAdd a non-zero address check for `_to` argument in `transferFrom`.\n\n**[toshiSat (Yieldy) confirmed and resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/206)** \n\n\n***\n\n## [[M-12] Inconsistent balance when fee-on transfer tokens.](https://github.com/code-423n4/2022-06-yieldy-findings/issues/234)\n_Submitted by asutorufos_\n\nThere are ERC20 tokens that may make certain customizations to their ERC20 contracts.\n\nOne type of these tokens is deflationary tokens that charge a certain fee for every `transfer()` or `transferFrom()`.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/Staking.sol#:~:text=Invalid%20address%22)%3B-,uint256%20totalTokeAmount%20%3D%20IERC20Upgradeable(TOKE_TOKEN).balanceOf(,)%3B,-%7D>\n\nWhen `IERC20Upgradeable(TOKE_TOKEN)` get set to `totalTokeAmount` it will be different once `safetransfer` have fees as some types of tokens may charge a certain fee for transfer and transferfrom.\n\nIt may be better to get the before balance then `safetransferfrom` then get the after balance to make sure no fees were added.\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/234#issuecomment-1198545807):**\n > We will not support deflationary tokens.  We will document this.\n\n***\n\n## [[M-13] Sending batch withdrawal requests can possibly DoS](https://github.com/code-423n4/2022-06-yieldy-findings/issues/280)\n_Submitted by berndartmueller_\n\nThe function `BatchRequests.sendWithdrawalRequests` allows calling the `sendWithdrawalRequests` function on all of the Yieldy contracts at once. However, due to the unbounded `for` loop, if many Yieldy contracts are added to `contracts`, this function can potentially DoS due to reaching the block gas limit.\n\n### Proof of Concept\n\n[BatchRequests.sendWithdrawalRequests](https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/BatchRequests.sol#L14-L27)\n\n```solidity\nfunction sendWithdrawalRequests() external {\n    uint256 contractsLength = contracts.length;\n    for (uint256 i; i < contractsLength; ) {\n        if (\n            contracts[i] != address(0) &&\n            IStaking(contracts[i]).canBatchTransactions()\n        ) {\n            IStaking(contracts[i]).sendWithdrawalRequests();\n        }\n        unchecked {\n            ++i;\n        }\n    }\n}\n```\n\n### Recommended mitigation steps\n\nAdd `offset` and `limit` function parameters to implement a \"paginated\" for loop.\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/280#issuecomment-1167783591):**\n > Only the owner of the contract can add addresses to the contract.\n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/280#issuecomment-1198077126):**\n > Hmm, would consider making this Low. But keeping it medium highlights the importance to be aware of this.\n\n\n\n***\n\n## [[M-14] Incorrect rebase percentage calculation](https://github.com/code-423n4/2022-06-yieldy-findings/issues/52)\n_Submitted by csanuragjain_\n\n**Note: this issue had originally been grouped with M-15. Approximately 1 week after judging and awarding were finalized, the judging team re-assessed that this issue should have been classified as a unique issue. It has been broken out here accordingly.**\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/Yieldy.sol#L91>\n\nIt was observed that if updatedTotalSupply > MAX_SUPPLY then updatedTotalSupply becomes MAX_SUPPLY. This means _profit amount is not fully used. But _storeRebase function is still called with _profit amount.\n\nThis becomes a problem since _storeRebase function caluclates rebasePercent using this incorrect _profit amount.\n\n### Proof of Concept\n\n1. REBASE_ROLE calls rebase function with say profit 10. Assume currentTotalSupply is 90\n2. updatedTotalSupply is calculated as updatedTotalSupply = currentTotalSupply + _profit. Thus updatedTotalSupply becomes 90+10=100\n\n3. Assume MAX_SUPPLY is 91. Since updatedTotalSupply>MAX_SUPPLY so updatedTotalSupply is updated to be 91\n\n4. Now _storeRebase function is called with updatedTotalSupply (91), _profit(10)\n\n5. This is incorrect since 10 amount from _profit is not utilized and only 1 amount is utilized. This becomes a problem in rebasePercent calculation where it is calculated on full 10 amount instead of 1\n\n### Recommended Mitigation Steps\n\nUse below:\n\n```\nif (updatedTotalSupply > MAX_SUPPLY) {\n_profit=_profit - (updatedTotalSupply-MAX_SUPPLY);\n                updatedTotalSupply = MAX_SUPPLY;\n\t\t\t\t\n            }\n```\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/52#issuecomment-1168079367):** \n > Max Supply is nearly the max amount in uint256. The protection is there, but will most likely never hit.\n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/52#issuecomment-1200224474):**\n > Potentially, this should be a medium issue.\n\n**[JasoonS (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/52#issuecomment-1230560266):**\n > Downgrading to medium\n\n\n\n***\n\n## [[M-15] token transfers in LiquidityReserve and Staking contract don't support deflationary ERC20 tokens, and user funds can be lost if stacking token was deflationary](https://github.com/code-423n4/2022-06-yieldy-findings/issues/222)\n_Submitted by unforgiven, also found by hake, robee, and TrungOre_\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L419-L445>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L120-L126>\n\n### Impact\n\nIf the token is deflationary then contract will receive less token that requested `amount` but contract don't check for the real transferred amount. because this is happening in receiving `stacking_token` in `addLiquidity()` of `LiquidityReserve` and `stake()` of `Staking` then those logics for minting `YIELDY_TOKEN` or `LP` token is wrong. (contract receive less than `amount` but mint or transfer `amount` to user). This can cause other users which staked to lose funds.\n\n### Proof of Concept\n\nThis is the related code where transfer happens (`stake()` and `addLiquidity()`):\n\n        function stake(uint256 _amount, address _recipient) public {\n            // if override staking, then don't allow stake\n            require(!isStakingPaused, \"Staking is paused\");\n            // amount must be non zero\n            require(_amount > 0, \"Must have valid amount\");\n\n            uint256 yieldyTotalSupply = IYieldy(YIELDY_TOKEN).totalSupply();\n\n            // Don't rebase unless tokens are already staked or could get locked out of staking\n            if (yieldyTotalSupply > 0) {\n                rebase();\n            }\n\n            IERC20Upgradeable(STAKING_TOKEN).safeTransferFrom(\n                msg.sender,\n                address(this),\n                _amount\n            );\n\n            Claim storage info = warmUpInfo[_recipient];\n\n            // if claim is available then auto claim tokens\n            if (_isClaimAvailable(_recipient)) {\n                claim(_recipient);\n            }\n\n            _depositToTokemak(_amount);\n\n            // skip adding to warmup contract if period is 0\n            if (warmUpPeriod == 0) {\n                IYieldy(YIELDY_TOKEN).mint(_recipient, _amount);\n            } else {\n                // create a claim and mint tokens so a user can claim them once warm up has passed\n                warmUpInfo[_recipient] = Claim({\n                    amount: info.amount + _amount,\n                    credits: info.credits +\n                        IYieldy(YIELDY_TOKEN).creditsForTokenBalance(_amount),\n                    expiry: epoch.number + warmUpPeriod\n                });\n\n                IYieldy(YIELDY_TOKEN).mint(address(this), _amount);\n            }\n\n<!---->\n\n        function addLiquidity(uint256 _amount) external {\n            require(isReserveEnabled, \"Not enabled yet\");\n            uint256 stakingTokenBalance = IERC20Upgradeable(stakingToken).balanceOf(\n                address(this)\n            );\n            uint256 rewardTokenBalance = IERC20Upgradeable(rewardToken).balanceOf(\n                address(this)\n            );\n            uint256 lrFoxSupply = totalSupply();\n            uint256 coolDownAmount = IStaking(stakingContract)\n                .coolDownInfo(address(this))\n                .amount;\n            uint256 totalLockedValue = stakingTokenBalance +\n                rewardTokenBalance +\n                coolDownAmount;\n\n            uint256 amountToMint = (_amount * lrFoxSupply) / totalLockedValue;\n            IERC20Upgradeable(stakingToken).safeTransferFrom(\n                msg.sender,\n                address(this),\n                _amount\n            );\n            _mint(msg.sender, amountToMint);\n        }\n\nAs you can see contract transfers `amount` of `STAKE_TOKEN` and assumes it is going to receive that amount and then mint the same `amount` of `YIELDY_TOKEN` or `LP` token.\nSo user receive more funds which belongs to other users. protocol logics are not suitable for deflationary tokens and funds would be lost.\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nCheck the real amount of tokens that the contract receives.\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/222#issuecomment-1198543234):**\n > We will not be supporting deflationary tokens in Yieldy.  We will document this.\n\n\n\n***\n\n## [[M-16] `_storeRebase()` is called with the wrong parameters](https://github.com/code-423n4/2022-06-yieldy-findings/issues/259)\n_Submitted by BowTiedWardens, also found by hansfriese, hubble, minhquanym, PwnedNoMore, shung, TrungOre, and WatchPug_\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L110-L114>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L97-L100>\n\n### Vulnerability Details\n\n`_storeRebase()`'s signature is as such:\n\n*   [Yieldy.sol#\\_storeRebase()](https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L110-L114)\n\n```solidity\nFile: Yieldy.sol\n104:     /**\n105:         @notice emits event with data about rebase\n106:         @param _previousCirculating uint\n107:         @param _profit uint\n108:         @param _epoch uint\n109:      */\n110:     function _storeRebase(\n111:         uint256 _previousCirculating,\n112:         uint256 _profit,\n113:         uint256 _epoch\n114:     ) internal {\n```\n\nHowever, instead of being called with the expected `_previousCirculating` value, it's called with the current circulation value:\n\n*   [Yieldy.sol#rebase()](https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L97-L100)\n\n```solidity\nFile: Yieldy.sol\n89:             uint256 updatedTotalSupply = currentTotalSupply + _profit;\n...\n103:             _totalSupply = updatedTotalSupply;\n104: \n105:             _storeRebase(updatedTotalSupply, _profit, _epoch); // @audit-info this should be currentTotalSupply otherwise previous = current\n```\n\nAs a consequence, the functionality isn't doing what it was created for.\n\n### Recommended Mitigation Steps\n\nConsider calling `_storeRebase()` with `currentTotalSupply`:\n\n```diff\nFile: Yieldy.sol\n- 105:             _storeRebase(updatedTotalSupply, _profit, _epoch);\n+ 105:             _storeRebase(currentTotalSupply, _profit, _epoch);\n```\n**[toshiSat (Yieldy) confirmed and resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/259#issuecomment-1167809101)**\n\n\n\n***\n\n## [[M-17] Staking: rebase() does not rebase according to the status of the current epoch.](https://github.com/code-423n4/2022-06-yieldy-findings/issues/49)\n_Submitted by cccz_\n\nIn the staking contract, the rebase function can only be called once per epoch.\n\nIn the rebase function, the rewards of the current epoch are used in the next epoch, which can cause the rewards to be updated incorrectly and lead to incorrect distribution of user rewards.\n\n        function rebase() public {\n            // we know about the issues surrounding block.timestamp, using it here will not cause any problems\n            if (epoch.endTime <= block.timestamp) {\n                IYieldy(YIELDY_TOKEN).rebase(epoch.distribute, epoch.number); // 懒更新\n\n                epoch.endTime = epoch.endTime + epoch.duration;\n                epoch.timestamp = block.timestamp;\n                epoch.number++;\n\n                uint256 balance = contractBalance();\n                uint256 staked = IYieldy(YIELDY_TOKEN).totalSupply();\n\n                if (balance <= staked) {\n                    epoch.distribute = 0;\n                } else {\n                    epoch.distribute = balance - staked;\n                }\n            }\n        }\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L701-L719>\n\n### Recommended Mitigation Steps\n\nPut `IYieldy(YIELDY_TOKEN).rebase` after epoch.distribute update\n\n        function rebase() public {\n            // we know about the issues surrounding block.timestamp, using it here will not cause any problems\n            if (epoch.endTime <= block.timestamp) {\n                uint256 balance = contractBalance();\n                uint256 staked = IYieldy(YIELDY_TOKEN).totalSupply();\n\n                if (balance <= staked) {\n                    epoch.distribute = 0;\n                } else {\n                    epoch.distribute = balance - staked;\n                }\n                IYieldy(YIELDY_TOKEN).rebase(epoch.distribute, epoch.number);\n\n                epoch.endTime = epoch.endTime + epoch.duration;\n                epoch.timestamp = block.timestamp;\n                epoch.number++;\n            }\n        }\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/49#issuecomment-1168884765):**\n > This is how the system is designed.\n\n**[JasoonS (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/49#issuecomment-1200168413):**\n > Changing to Medium. It makes sense that the rebase happens after rewards so that those who enter later don't affect the distribution of rewards before they joined.\n\n\n\n***\n\n## [[M-18] Removal of liquidity from the reserve can be griefed](https://github.com/code-423n4/2022-06-yieldy-findings/issues/282)\n_Submitted by IllIllI_\n\nUsers may be unable to withdraw/remove their liquidity from the `LiquidityReserve` if a user decides to grief the contract.\n\n### Proof of Concept\n\nThis is the only function in this contract that is able to unstake funds, so that they can be withdrawn/removed:\n\n```solidity\nFile: src/contracts/LiquidityReserve.sol   #1\n\n214       function unstakeAllRewardTokens() public {\n215           require(isReserveEnabled, \"Not enabled yet\");\n216           uint256 coolDownAmount = IStaking(stakingContract)\n217               .coolDownInfo(address(this))\n218               .amount;\n219           if (coolDownAmount == 0) {\n220               uint256 amount = IERC20Upgradeable(rewardToken).balanceOf(\n221                   address(this)\n222               );\n223               if (amount > 0) IStaking(stakingContract).unstake(amount, false);\n224           }\n225       }\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L214-L225>\n\nThe function requires that the `coolDownAmount` is zero, or else it skips the `unstake()` call. A malicious user can make `coolDownAmount` non-zero by calling `Staking.instantUnstakeReserve()` when the previous reward is claimed, with just a large enough amount to satisfy the transfer of the amount and of the fee, so there is essentially zero left for other users to withdraw. The function calls `LiquidityReserve.instantUnstake()`:\n\n```solidity\nFile: src/contracts/Staking.sol   #2\n\n571       function instantUnstakeReserve(uint256 _amount) external {\n572           require(_amount > 0, \"Invalid amount\");\n573           // prevent unstaking if override due to vulnerabilities\n574           require(\n575               !isUnstakingPaused && !isInstantUnstakingPaused,\n576               \"Unstaking is paused\"\n577           );\n578   \n579           rebase();\n580           _retrieveBalanceFromUser(_amount, msg.sender);\n581   \n582           uint256 reserveBalance = IERC20Upgradeable(STAKING_TOKEN).balanceOf(\n583               LIQUIDITY_RESERVE\n584           );\n585   \n586           require(reserveBalance >= _amount, \"Not enough funds in reserve\");\n587   \n588           ILiquidityReserve(LIQUIDITY_RESERVE).instantUnstake(\n589               _amount,\n590               msg.sender\n591           );\n592       }\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L571-L592>\n\nWhich boosts the cooldown amount above zero in its call to `unstakeAllRewardTokens()` and then `IStaking.unstake()`:\n\n```solidity\nFile: src/contracts/LiquidityReserve.sol   #3\n\n188       function instantUnstake(uint256 _amount, address _recipient)\n189           external\n190           onlyStakingContract\n191       {\n192           require(isReserveEnabled, \"Not enabled yet\");\n193           // claim the stakingToken from previous unstakes\n194           IStaking(stakingContract).claimWithdraw(address(this));\n195   \n196           uint256 amountMinusFee = _amount - ((_amount * fee) / BASIS_POINTS);\n197   \n198           IERC20Upgradeable(rewardToken).safeTransferFrom(\n199               msg.sender,\n200               address(this),\n201               _amount\n202           );\n203   \n204           IERC20Upgradeable(stakingToken).safeTransfer(\n205               _recipient,\n206               amountMinusFee\n207           );\n208           unstakeAllRewardTokens();\n209       }\n210   \n211       /**\n212           @notice find balance of reward tokens in contract and unstake them from staking contract\n213        */\n214       function unstakeAllRewardTokens() public {\n215           require(isReserveEnabled, \"Not enabled yet\");\n216           uint256 coolDownAmount = IStaking(stakingContract)\n217               .coolDownInfo(address(this))\n218               .amount;\n219           if (coolDownAmount == 0) {\n220               uint256 amount = IERC20Upgradeable(rewardToken).balanceOf(\n221                   address(this)\n222               );\n223               if (amount > 0) IStaking(stakingContract).unstake(amount, false);\n224           }\n225       }\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L188-L225>\n\n```solidity\nFile: src/contracts/Staking.sol   #4\n\n674       function unstake(uint256 _amount, bool _trigger) external {\n675           // prevent unstaking if override due to vulnerabilities asdf\n676           require(!isUnstakingPaused, \"Unstaking is paused\");\n677           if (_trigger) {\n678               rebase();\n679           }\n680           _retrieveBalanceFromUser(_amount, msg.sender);\n681   \n682           Claim storage userCoolInfo = coolDownInfo[msg.sender];\n683   \n684           // try to claim withdraw if user has withdraws to claim function will check if withdraw is valid\n685           claimWithdraw(msg.sender);\n686   \n687           coolDownInfo[msg.sender] = Claim({\n688               amount: userCoolInfo.amount + _amount,\n689               credits: userCoolInfo.credits +\n690                   IYieldy(YIELDY_TOKEN).creditsForTokenBalance(_amount),\n691               expiry: epoch.number + coolDownPeriod\n692           });\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L674-L692>\n\nIf the malicious user is a miner, that miner can make sure that the block where the previous cooldown expires and is claimed, is the same block where the miner griefs by doing an instant unstake of a small amount, preventing larger amounts from going through. Until the miner decides to stop this behavior, funds will be locked in the contract.\n\n### Recommended Mitigation Steps\n\nKeep track of submitted amounts during the cooldown, and batch-submit them during the next open window, rather than making it first-come-first-served\n\n**[0xean (Yieldy) disputed, disagreed with severity and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/282#issuecomment-1167948970):**\n > The warden does identify a potential attack, but the assumptions that are being made for it to work are pretty hard to imagine.  For one, It would require a miner to always be able to process a specific block in order to continually DOS the contract.  This is very infeasible.\n> \n> Additionally, if this scenario was to occur, we could pause instant unstaking and wait for the cooldown to expire in order to retrieve funds.  The ability to toggle the instant unstake negates the call path the warden has suggested since `Staking.instantUnstakeReserve()` would revert. \n> \n> Given all of this, I would put this entire attack vector as super low risk and suggest its downgraded to QA. \n> \n> \n\n**[JasoonS (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/282#issuecomment-1200225289):**\n > I'm going to make this a Medium. While I agree the assumptions are out of the imaginable in reality, it is something that should be looked into for the contracts more seriously than the typical QA.\n\n\n\n***\n\n## [[M-19] Staking: the rebase function needs to be called before calling the function in the Yieldy contract that uses the rebasingCreditsPerToken variable](https://github.com/code-423n4/2022-06-yieldy-findings/issues/126)\n_Submitted by cccz_\n\nIn the Yieldy contract, functions such as balanceOf/creditsForTokenBalance/tokenBalanceForCredits/transfer/transferFrom/burn/mint will use the rebasingCreditsPerToken variable, so before calling these functions in the Staking contract, make sure that the rebase of this epoch has occurred. Therefore, the rebase function should also be called in the unstake/claim/claimWithdraw function of the Staking contract.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L674-L696>\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L465-L508>\n\n### Recommended Mitigation Steps\n\n        function claim(address _recipient) public {\n            Claim memory info = warmUpInfo[_recipient];\n    +      rebase();\n    ...\n        function claimWithdraw(address _recipient) public {\n            Claim memory info = coolDownInfo[_recipient];\n    +      rebase();\n    ...\n        function unstake(uint256 _amount, bool _trigger) external {\n            // prevent unstaking if override due to vulnerabilities asdf\n            require(!isUnstakingPaused, \"Unstaking is paused\");\n    -        if (_trigger) {\n                rebase();\n    -        }\n\n**[toshiSat (Yieldy) confirmed and resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/126)** \n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/126#issuecomment-1199023011):**\n > Yes, seems like a logic flaw, makes sense as Medium.\n\n\n\n***\n\n## [[M-20] User fund lose in addLiquidity() of LiquidityReserve by increasing (totalLockedValue / totalSupply()) to very large number by attacker](https://github.com/code-423n4/2022-06-yieldy-findings/issues/272)\n_Submitted by unforgiven_\n\nFunction `addLiquidity()` suppose to do add Liquidity for the `staking Token` and receive `lrToken` in exchange. to calculate amount of `IrToken` codes uses this calculation: `amountToMint = (_amount * lrFoxSupply) / totalLockedValue` but it's possible for attacker to manipulate `totalLockedValue` (by sending tokens directly to `LiquidityReserve` address) and make `totalLockedValue/lrFoxSupply` very high in early stage of contract deployment so because of rounding error in calculation of `amountToMint` the users would receive very lower `IrToken` and users funds would be lost and attacker can steal them.\n\nAttacker can perform this attack by sending tokens before even `LiquidityReserve` deployed because the contract address would be predictable and attacker can perform front-run or sandwich attack too.\n\nAlso it's possible to perform this attack for `STAKING_TOKEN` with low precision and low price even if `LiquidityReserve` had some balances.\n\n### Proof of Concept\n\nThis is `addLiquidity()` code in `LiquidityReserve`:\n\n        function addLiquidity(uint256 _amount) external {\n            require(isReserveEnabled, \"Not enabled yet\");\n            uint256 stakingTokenBalance = IERC20Upgradeable(stakingToken).balanceOf(\n                address(this)\n            );\n            uint256 rewardTokenBalance = IERC20Upgradeable(rewardToken).balanceOf(\n                address(this)\n            );\n            uint256 lrFoxSupply = totalSupply();\n            uint256 coolDownAmount = IStaking(stakingContract)\n                .coolDownInfo(address(this))\n                .amount;\n            uint256 totalLockedValue = stakingTokenBalance +\n                rewardTokenBalance +\n                coolDownAmount;\n\n            uint256 amountToMint = (_amount * lrFoxSupply) / totalLockedValue;\n            IERC20Upgradeable(stakingToken).safeTransferFrom(\n                msg.sender,\n                address(this),\n                _amount\n            );\n            _mint(msg.sender, amountToMint);\n        }\n\nAs you can see code uses this calculation: `amountToMint = (_amount * lrFoxSupply) / totalLockedValue;` to find the amount of `IrToken` that is going to mint for user. but attacker can send `stakingToken` or `rewardToken` directly to `LiquidityReserve` address when the there is no liqudity in the contract and make `totalLockedValue` very high. then attacker call `addLiquidity()` and mint some `IrToken` for himself and from then anyone tries to call `addLiquidity()` because of rounding error is going to lose some funds (receives less `IrToken` than he is supposed to)\n\n### Tools Used\n\nVIM\n\n### Recommended Mitigation Steps\n\nAdd more precision when calculating `IrToken` so this attack wouldn't be feasible to perform.\n\n**[0xean (Yieldy) disagreed with severity and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/272#issuecomment-1169117495):**\n> The contract locks a minimum liquidity amount which blocks the feasibility attack for the most part. Please see `enableLiquidityReserve` for the code where the locking occurs. \n> \n\n**[moose-code (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/272#issuecomment-1201297362):**\n > Some good worthwhile ideas from the warden but after reviewing the `enableLiquidityReserve` going to downgrade this to medium. After reading the code and the described attack, its not very clear how the attacker would benefit and bring the contract into this state. \n> \n> By sending tokens directly to the contract (expensive) and increasing total totalLockedValue, this will decrease the amount the amountToMint for the user but unclear that this cost is worth it or how an attacker could actually benefit (from what I can see). \n> \n> Think its still worth exploring this vector in more depth as its a creative attack. Warrants medium and further investigation. \n\n\n\n***\n\n## [[M-21] Cannot mint to exactly max supply using `_mint` function](https://github.com/code-423n4/2022-06-yieldy-findings/issues/200)\n_Submitted by Chom, also found by hansfriese and minhquanym_\n\nCannot mint to exactly max supply using `_mint` function.\n\n### Proof of Concept\n\n    require(_totalSupply < MAX_SUPPLY, \"Max supply\");\n\nif `_totalSupply == MAX_SUPPLY` this assert will be failed and reverted.\n\nBut it shouldn't be reverted as `_totalSupply == MAX_SUPPLY` is valid.\n\n### Recommended Mitigation Steps\n\nChange to\n\n    require(_totalSupply <= MAX_SUPPLY, \"Max supply\");\n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/200#issuecomment-1199257061):**\n > Feels potentially too generous giving this a medium since it isn't clear what the exploit would be, but it is a bug. I'll be generous...\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/200#issuecomment-1205716867):**\n > Yea we aren't going to implement this one due to nearly every example of rebasing tokens are using this calculation.  It will be very unlikely that total supply ever hits max supply,  so the risk isn't worth the reward for changing it.\n\n\n\n***\n\n## [[M-22] MINIMUM_LIQUIDITY checks missing - Bringing Liquidity below required min](https://github.com/code-423n4/2022-06-yieldy-findings/issues/48)\n_Submitted by csanuragjain_\n\nWhale who provided most liquidity to the contract can simply use removeLiquidity function and can remove all of his liquidity. This can leave the residual liquidity to be less than MINIMUM_LIQUIDITY which is incorrect.\n\n### Proof of Concept\n\n1.  Whale A provided initial liquidity plus more liquidity using enableLiquidityReserve and addLiquidity function\n\n2.  There are other small liquidity providers as well\n\n3.  Now Whale A decides to remove all the liquidity provided\n\n4.  This means after liquidity removal the balance liquidity will even drop below MINIMUM_LIQUIDITY which is incorrect\n\n### Recommended Mitigation Steps\n\nAdd below check\n\n    require(\n                IERC20Upgradeable(stakingToken).balanceOf(address(this)) - MINIMUM_LIQUIDITY >=\n                    amountToWithdraw,\n                \"Not enough funds\"\n            );\n\n**[toshiSat (Yieldy) confirmed and resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/48)** \n\n***\n\n## [[M-23] Incorrect withdrawal requested](https://github.com/code-423n4/2022-06-yieldy-findings/issues/56)\n_Submitted by csanuragjain, also found by MiloTruck_\n\n`\\_requestWithdrawalFromTokemak` function :: Instead of sending amountToRequest for requestWithdrawal, contract is asking \\_amount for requestWithdrawal. This becomes a problem when balance < \\_amount and only balance could be withdrawn\n\n### Proof of Concept\n\n1.  In \\_requestWithdrawalFromTokemak function, amountToRequest is calculated as\n\n<!---->\n\n    // the only way balance < _amount is when using unstakeAllFromTokemak\n            uint256 amountToRequest = balance < _amount ? balance : _amount;\n\n2.  Now assuming balance < \\_amount then amountToRequest becomes balance\n\n3.  But tokePoolContract.requestWithdrawal is called over \\_amount instead of amountToRequest which means withdrawal is requested over an extra amount\n\n### Recommended Mitigation Steps\n\nModify Staking.sol#L326 to\n\n    if (amountToRequest > 0) tokePoolContract.requestWithdrawal(amountToRequest);\n\n**[toshiSat (Yieldy) confirmed and resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/56)** \n\n***\n\n## [[M-24] Staking `preSign` could use some basic validations](https://github.com/code-423n4/2022-06-yieldy-findings/issues/172)\n_Submitted by Alex the Entreprenerd_\n\nThe function `preSign` accepts any `orderUid`.<br>\n`function preSign(bytes calldata orderUid) external onlyOwner`\n\nBecause of how Cowswap works, accepting any `orderUid` can be used as a rug-vector.\n\nThis is because the orderData contains a `receiver` which in lack of validation could be any address.\n\nYou'd also be signing other parameters such as minOut and how long the order could be filled for, which you may or may not want to validate to give stronger security guarantees to end users.\n\n### Recomended Mitigation Steps\n\nI'd recommend adding basic validation for tokenOut, minOut and receiver.\n\nFeel free to check the work we've done at Badger to validate order parameters, giving way stronger guarantees to end users.\n<https://github.com/GalloDaSballo/fair-selling/blob/44c0c0629289a0c4ccb3ca971cc5cd665ce5cb82/contracts/CowSwapSeller.sol#L194>\n\nAlso notice how through the code above we are able to re-construct the `orderUid`, feel free to re-use that code which has been validated by the original Cowswap / GPv2 Developers.\n\n**[toshiSat (Yieldy) confirmed, resolved and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/172#issuecomment-1201510899):**\n > Thanks for the functions, I like what you guys did.  Our cowswap function is only called using the `onlyOwner` modifier, so I think it's pretty safe, but I agree some validation would be better than none.\n\n\n\n***\n\n## [[M-25] coolDown & warmUp period do not work when a low _firstEpochEndTime is passed to initialize](https://github.com/code-423n4/2022-06-yieldy-findings/issues/88)\n_Submitted by Lambda_\n\nIn the constructor of `Staking.sol`, it is not enforced that the `_firstEpochEndTime` is larger than the current `block.timestamp`. If a low value is accidentally passed (or even 0), `rebase` can be called multiple times in sucession, causing the `epoch.number` to increase. Therefore, the coolDown & warmUp period can be circumvented in such a scenario, as `epoch.number >= info.expiry` (in `_isClaimAvailable` and `_isClaimWithdrawAvailable`) will return true after `rebase` caused several increases of `epoch.number`.\n\n### Recommended Mitigation Steps\n\nEither require that `_firstEpochEndTime` is larger than `block.timestamp` or set the expiry of the first epoch to `block.timestamp + _epochDuration`.\n\n**[toshiSat (Yieldy) acknowledged and commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/88#issuecomment-1168044235):**\n > This is something we thought about and will most likely set the period temporarily 1 higher when launching with low initial epoch durations.\n\n\n\n***\n\n## [[M-26] instantUnstake function can be frontrunned with fee increase](https://github.com/code-423n4/2022-06-yieldy-findings/issues/279)\n_Submitted by sashik&#95;eth_\n\n[`instantUnstake()`](https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/LiquidityReserve.sol#L188) allows user to unstake their stakingToken for a fee paid to the liquidity providers. This fee could be changed up to 100% any moment by admin.\n\nMalicious admin could frontrun users [`instantUnstake()`](https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/LiquidityReserve.sol#L188) transaction and set `fee` to any value (using [`setFee()`](https://github.com/code-423n4/2022-06-yieldy/blob/main/src/contracts/LiquidityReserve.sol#L92)) and get all users unstaking asset.\n\nIt's even could lead to a situation when non-malicious admin accidentally frontrun unstaking user by increasing fee to a new rate, which user wasn't expected.\n\n```solidity\n    /**\n        @notice sets Fee (in basis points eg. 100 bps = 1%) for instant unstaking\n        @param _fee uint - fee in basis points\n     */\n    function setFee(uint256 _fee) external onlyOwner {\n        // check range before setting fee\n        require(_fee <= BASIS_POINTS, \"Out of range\");\n        fee = _fee;\n\n        emit FeeChanged(_fee);\n    }\n```\n\n### Recommended Mitigation Steps\n\nConsider introducing an upper limit for fees so users can know the maximum fess available in protocol and adding timelock to change fee size.\nThis way, frontrunning will be impossible, and users will know which fee they agree to.\n\n**[toshiSat (Yieldy) acknowledged](https://github.com/code-423n4/2022-06-yieldy-findings/issues/279)** \n\n**[JasoonS (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/279#issuecomment-1230586458):**\n > Checks should be in place for this. Saying the code is upgradeable isn't an excuse for not having sanity checks in admin functions in the code.\n> \n> For example script could have a bug that sets this value wrong (for example making it 1e18 times bigger than it should be or something).\n\n***\n\n## [[M-27] instantUnstake fee can be avoided](https://github.com/code-423n4/2022-06-yieldy-findings/issues/9)\n_Submitted by skoorch_\n\nUsers can utilize the `instantUnstake` function without paying the liquidity provider fee using rounding errors in the fee calculation. This attack only allows for a relatively small amount of tokens to be unstaked in each call, so is likely not feasible on mainnet. However, on low-cost L2s and for tokens with a small decimal precision it is likely a feasible workaround.\n\n### Proof of Concept\n\nThe `instantUnstake` fee is handled by sending the user back `amount - fee`. We can work around the fee by unstaking small amounts (`amount < BASIS_POINTS / fee`) in a loop until reaching the desired amount.\n\n### Recommended Mitigation Steps\n\nAvoid using subtraction to calculate the fee as this causes the fee to be rounded down rather than the amount. I'd propose calculating amount less fee using a muldiv operation over (1 - fee). In this case, the fee is effectively rounded up instead of down, so it can never be 0 unless fee is 0. Uniswapv2 uses a similar solution for their LP fee: <https://github.com/Uniswap/v2-core/blob/8b82b04a0b9e696c0e83f8b2f00e5d7be6888c79/contracts/UniswapV2Pair.sol#L180-L182>\n\nIt might look like the following:\n\n    uint256 amountMinusFee = amount * (BASIS_POINTS - fee) / BASIS_POINTS\n\n**[toshiSat (Yieldy) confirmed and resolved](https://github.com/code-423n4/2022-06-yieldy-findings/issues/9)**\n\n***\n\n\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 70 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-06-yieldy-findings/issues/235) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [BowTiedWardens](https://github.com/code-423n4/2022-06-yieldy-findings/issues/270), [defsec](https://github.com/code-423n4/2022-06-yieldy-findings/issues/277), [robee](https://github.com/code-423n4/2022-06-yieldy-findings/issues/66), [0x1337](https://github.com/code-423n4/2022-06-yieldy-findings/issues/90), [0xNazgul](https://github.com/code-423n4/2022-06-yieldy-findings/issues/92), [hubble](https://github.com/code-423n4/2022-06-yieldy-findings/issues/268), [reassor](https://github.com/code-423n4/2022-06-yieldy-findings/issues/267), [0x29A](https://github.com/code-423n4/2022-06-yieldy-findings/issues/156), [berndartmueller](https://github.com/code-423n4/2022-06-yieldy-findings/issues/292), [GalloDaSballo](https://github.com/code-423n4/2022-06-yieldy-findings/issues/174), [joestakey](https://github.com/code-423n4/2022-06-yieldy-findings/issues/201), [Lambda](https://github.com/code-423n4/2022-06-yieldy-findings/issues/85), [pashov](https://github.com/code-423n4/2022-06-yieldy-findings/issues/181), [Picodes](https://github.com/code-423n4/2022-06-yieldy-findings/issues/163), [pedr02b2](https://github.com/code-423n4/2022-06-yieldy-findings/issues/8), [0xc0ffEE](https://github.com/code-423n4/2022-06-yieldy-findings/issues/230), [csanuragjain](https://github.com/code-423n4/2022-06-yieldy-findings/issues/62), [exd0tpy](https://github.com/code-423n4/2022-06-yieldy-findings/issues/23), [GimelSec](https://github.com/code-423n4/2022-06-yieldy-findings/issues/274), [shung](https://github.com/code-423n4/2022-06-yieldy-findings/issues/96), [scaraven](https://github.com/code-423n4/2022-06-yieldy-findings/issues/186), [StErMi](https://github.com/code-423n4/2022-06-yieldy-findings/issues/114), [zzzitron](https://github.com/code-423n4/2022-06-yieldy-findings/issues/135), [elprofesor](https://github.com/code-423n4/2022-06-yieldy-findings/issues/219), [unforgiven](https://github.com/code-423n4/2022-06-yieldy-findings/issues/207), [0xf15ers](https://github.com/code-423n4/2022-06-yieldy-findings/issues/254), [FudgyDRS](https://github.com/code-423n4/2022-06-yieldy-findings/issues/295), [hansfriese](https://github.com/code-423n4/2022-06-yieldy-findings/issues/224), [oyc&#95;109](https://github.com/code-423n4/2022-06-yieldy-findings/issues/11), [hake](https://github.com/code-423n4/2022-06-yieldy-findings/issues/213), [Waze](https://github.com/code-423n4/2022-06-yieldy-findings/issues/136), [0x1f8b](https://github.com/code-423n4/2022-06-yieldy-findings/issues/42), [cccz](https://github.com/code-423n4/2022-06-yieldy-findings/issues/127), [&#95;Adam](https://github.com/code-423n4/2022-06-yieldy-findings/issues/119), [aga7hokakological](https://github.com/code-423n4/2022-06-yieldy-findings/issues/216), [Bnke0x0](https://github.com/code-423n4/2022-06-yieldy-findings/issues/237), [cryptphi](https://github.com/code-423n4/2022-06-yieldy-findings/issues/247), [dipp](https://github.com/code-423n4/2022-06-yieldy-findings/issues/250), [fatherOfBlocks](https://github.com/code-423n4/2022-06-yieldy-findings/issues/19), [Funen](https://github.com/code-423n4/2022-06-yieldy-findings/issues/202), [ladboy233](https://github.com/code-423n4/2022-06-yieldy-findings/issues/139), [Limbooo](https://github.com/code-423n4/2022-06-yieldy-findings/issues/239), [MiloTruck](https://github.com/code-423n4/2022-06-yieldy-findings/issues/122), [Noah3o6](https://github.com/code-423n4/2022-06-yieldy-findings/issues/128), [samruna](https://github.com/code-423n4/2022-06-yieldy-findings/issues/6), [sikorico](https://github.com/code-423n4/2022-06-yieldy-findings/issues/71), [TomJ](https://github.com/code-423n4/2022-06-yieldy-findings/issues/147), [0xNineDec](https://github.com/code-423n4/2022-06-yieldy-findings/issues/78), [0xDjango](https://github.com/code-423n4/2022-06-yieldy-findings/issues/166), [ak1](https://github.com/code-423n4/2022-06-yieldy-findings/issues/149), [Chom](https://github.com/code-423n4/2022-06-yieldy-findings/issues/205), [UnusualTurtle](https://github.com/code-423n4/2022-06-yieldy-findings/issues/301), [sseefried](https://github.com/code-423n4/2022-06-yieldy-findings/issues/112), [0xmint](https://github.com/code-423n4/2022-06-yieldy-findings/issues/299), [antonttc](https://github.com/code-423n4/2022-06-yieldy-findings/issues/54), [delfin454000](https://github.com/code-423n4/2022-06-yieldy-findings/issues/229), [ElKu](https://github.com/code-423n4/2022-06-yieldy-findings/issues/177), [JC](https://github.com/code-423n4/2022-06-yieldy-findings/issues/304), [Kaiziron](https://github.com/code-423n4/2022-06-yieldy-findings/issues/117), [kenta](https://github.com/code-423n4/2022-06-yieldy-findings/issues/154), [Metatron](https://github.com/code-423n4/2022-06-yieldy-findings/issues/302), [mics](https://github.com/code-423n4/2022-06-yieldy-findings/issues/69), [PumpkingWok](https://github.com/code-423n4/2022-06-yieldy-findings/issues/150), [PwnedNoMore](https://github.com/code-423n4/2022-06-yieldy-findings/issues/257), [simon135](https://github.com/code-423n4/2022-06-yieldy-findings/issues/183), [Sm4rty](https://github.com/code-423n4/2022-06-yieldy-findings/issues/140), [tchkvsky](https://github.com/code-423n4/2022-06-yieldy-findings/issues/261), [TrungOre](https://github.com/code-423n4/2022-06-yieldy-findings/issues/193), and [0x52](https://github.com/code-423n4/2022-06-yieldy-findings/issues/32).*\n\n## Low Risk Issues\n\n|   | Issue                                                                           | Instances |\n| - | :------------------------------------------------------------------------------ | :-------: |\n| L-01 | Batch-related functions will revert if `removeAddress()` is called              |     2     |\n| L-02 | Staking contract's token not verified to be the same token as the staking token |     1     |\n| L-03 | Missing infinite approval functionality                                         |     1     |\n| L-04 | Missing checks that the end time matches the duration                           |     1     |\n| L-05 | Missing input validations and timelocks                                         |     5     |\n| L-06 | Front-runable initializer                                                       |     2     |\n\nTotal: 12 instances over 6 issues\n\n## [L-01] Batch-related functions will revert if `removeAddress()` is called\n\n`removeAddress()` removes entries from the storage array that holds batch contract addresses, but it doesn't fill in the deleted entries with a replacement value. When other functions hit these null entries and try to call functions on the zero address, they'll revert, causing the whole function to fail\n\n*There are 2 instances of this issue. (For in-depth details on this and all further low and non-critical items with multiple instances, see the warden's [full report](https://github.com/code-423n4/2022-06-yieldy-findings/issues/235).)*\n\n## [L-02] Staking contract's token not verified to be the same token as the staking token\n\nThere may be a mismatch between the token that `_stakingContract` is in charge of, and the actual token used by the `LiquidityReserve`. This code should check that they are in fact the same\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/contracts/LiquidityReserve.sol   #1\n\n57       function enableLiquidityReserve(address _stakingContract)\n58           external\n59           onlyOwner\n60       {\n61           require(!isReserveEnabled, \"Already enabled\");\n62           require(_stakingContract != address(0), \"Invalid address\");\n63   \n64           uint256 stakingTokenBalance = IERC20Upgradeable(stakingToken).balanceOf(\n65               msg.sender\n66           );\n67           // require address has minimum liquidity\n68           require(\n69               stakingTokenBalance >= MINIMUM_LIQUIDITY,\n70               \"Not enough staking tokens\"\n71           );\n72:          stakingContract = _stakingContract;\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L57-L72>\n\n## [L-03] Missing infinite approval functionality\n\nMost other contracts in the repository use `type(uint256).max` to mean infinite approval, rather than a specific approval amount. Not doing the same thing here will mean inconsistent behavior between the components, will mean that approvals will eventually run down to zero, and will mean that there will be hard-to-track-down issues when things eventually start failing\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/contracts/Yieldy.sol   #1\n\n210          require(_allowances[_from][msg.sender] >= _value, \"Allowance too low\");\n211  \n212          uint256 newValue = _allowances[_from][msg.sender] - _value;\n213          _allowances[_from][msg.sender] = newValue;\n214:         emit Approval(_from, msg.sender, newValue);\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Yieldy.sol#L210-L214>\n\n## [L-04] Missing checks that the end time matches the duration\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/contracts/Staking.sol   #1\n\n95               duration: _epochDuration,\n96               number: 1,\n97               timestamp: block.timestamp, // we know about the issues surrounding block.timestamp, using it here will not cause any problems\n98:              endTime: _firstEpochEndTime,\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L95-L98>\n\n## [L-05] Missing input validations and timelocks\n\nThe following instances are missing checks for zero addresses and or valid ranges for values. Even if the DAO is the one setting these values, it's important to add sanity checks in case someone does a fat-finger operation that is missed by DAO participants who may not be very technical. There are also no timelocks involved, which [should be rectified](https://discord.com/channels/810916927919620096/986765994049564682/990255967847460894)\n\n*There are 5 instances of this issue.*\n\n## [L-06] Front-runable initializer\n\nThere is nothing preventing another account from calling the initializer before the contract owner. In the best case, the owner is forced to waste gas and re-deploy. In the worst case, the owner does not notice that his/her call reverts, and everyone starts using a contract under the control of an attacker\n\n*There are 2 instances of this issue.*\n\n## Non-Critical Issues\n\n|   | Issue                                                                               | Instances |\n| - | :---------------------------------------------------------------------------------- | :-------: |\n| N-01 | Return values of `approve()` not checked                                            |     2     |\n| N-02 | Misleading variable names                                                           |     1     |\n| N-03 | `public` functions not called by the contract should be declared `external` instead |     1     |\n| N-04 | `constant`s should be defined rather than using magic numbers                       |     3     |\n| N-05 | Use a more recent version of solidity                                               |     3     |\n| N-06 | Typos                                                                               |     10    |\n| N-07 | NatSpec is incomplete                                                               |     2     |\n| N-08 | Event is missing `indexed` fields                                                   |     12    |\n\nTotal: 34 instances over 8 issues\n\n## [N-01] Return values of `approve()` not checked\n\nNot all `IERC20` implementations `revert()` when there's a failure in `approve()`. The function signature has a `boolean` return value and they indicate errors that way instead. By not checking the return value, operations that should have marked as failed, may potentially go through without actually approving anything\n\n*There are 2 instances of this issue.*\n\n## [N-02] Misleading variable names\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/contracts/LiquidityReserve.sol   #1\n\n/// @audit code is no longer FOX-specific\n112:         uint256 lrFoxSupply = totalSupply();\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/LiquidityReserve.sol#L112>\n\n## [N-03] `public` functions not called by the contract should be declared `external` instead\n\nContracts [are allowed](https://docs.soliditylang.org/en/latest/contracts.html#function-overriding) to override their parents' functions and change the visibility from `external` to `public`.\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: src/contracts/Staking.sol   #1\n\n370:      function unstakeAllFromTokemak() public onlyOwner {\n```\n\n<https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L370>\n\n## [N-04] `constant`s should be defined rather than using magic numbers\n\nEven [assembly](https://github.com/code-423n4/2022-05-opensea-seaport/blob/9d7ce4d08bf3c3010304a0476a785c70c0e90ae7/contracts/lib/TokenTransferrer.sol#L35-L39) can benefit from using readable constants instead of hex/numeric literals\n\n*There are 3 instances of this issue.*\n\n## [N-05] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.13 to get the ability to use `using for` with a list of free functions\n\n*There are 3 instances of this issue.*\n\n## [N-06] Typos\n\n*There are 10 instances of this issue.*\n\n## [N-07] NatSpec is incomplete\n\n*There are 2 instances of this issue.*\n\n## [N-08] Event is missing `indexed` fields\n\nEach `event` should use three `indexed` fields if there are three or more fields\n\n*There are 12 instances of this issue.*\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/235#issuecomment-1236821132):**\n > Low risk issues:<br>\n> 1 - Agree<br>\n> 2 - Agree<br>\n> 3 - Agree<br>\n> 4 - Agree<br>\n> 5 - Agree<br>\n> 6 -Agree<br>\n> \n> Informational:<br>\n> 1- Agree<br>\n> 2 -Agree<br>\n> 3 - Agree<br>\n> 4 - Strongly agree, this is very helpful.<br>\n> 5 - Agree<br>\n> 6 - Agree<br>\n> 7 - Agree<br>\n> 8 - Agree<br>\n\n***\n\n# Gas Optimizations\n\nFor this contest, 70 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-06-yieldy-findings/issues/236) by **BowTiedWardens** received the top score from the judge.\n\n*The following wardens also submitted reports: [IllIllI](https://github.com/code-423n4/2022-06-yieldy-findings/issues/231), [MiloTruck](https://github.com/code-423n4/2022-06-yieldy-findings/issues/121), [&#95;Adam](https://github.com/code-423n4/2022-06-yieldy-findings/issues/100), [ajtra](https://github.com/code-423n4/2022-06-yieldy-findings/issues/212), [Fabble](https://github.com/code-423n4/2022-06-yieldy-findings/issues/189), [GalloDaSballo](https://github.com/code-423n4/2022-06-yieldy-findings/issues/175), [0xkatana](https://github.com/code-423n4/2022-06-yieldy-findings/issues/16), [0xKitsune](https://github.com/code-423n4/2022-06-yieldy-findings/issues/20), [defsec](https://github.com/code-423n4/2022-06-yieldy-findings/issues/273), [joestakey](https://github.com/code-423n4/2022-06-yieldy-findings/issues/197), [reassor](https://github.com/code-423n4/2022-06-yieldy-findings/issues/269), [TomJ](https://github.com/code-423n4/2022-06-yieldy-findings/issues/107), [0x29A](https://github.com/code-423n4/2022-06-yieldy-findings/issues/159), [antonttc](https://github.com/code-423n4/2022-06-yieldy-findings/issues/53), [Bnke0x0](https://github.com/code-423n4/2022-06-yieldy-findings/issues/15), [fatherOfBlocks](https://github.com/code-423n4/2022-06-yieldy-findings/issues/18), [FudgyDRS](https://github.com/code-423n4/2022-06-yieldy-findings/issues/296), [minhquanym](https://github.com/code-423n4/2022-06-yieldy-findings/issues/106), [RedOneN](https://github.com/code-423n4/2022-06-yieldy-findings/issues/203), [Tomio](https://github.com/code-423n4/2022-06-yieldy-findings/issues/17), [PwnedNoMore](https://github.com/code-423n4/2022-06-yieldy-findings/issues/258), [0x1f8b](https://github.com/code-423n4/2022-06-yieldy-findings/issues/35), [0xf15ers](https://github.com/code-423n4/2022-06-yieldy-findings/issues/256), [0xNazgul](https://github.com/code-423n4/2022-06-yieldy-findings/issues/91), [hansfriese](https://github.com/code-423n4/2022-06-yieldy-findings/issues/225), [kenta](https://github.com/code-423n4/2022-06-yieldy-findings/issues/155), [ladboy233](https://github.com/code-423n4/2022-06-yieldy-findings/issues/145), [Lambda](https://github.com/code-423n4/2022-06-yieldy-findings/issues/86), [m&#95;Rassska](https://github.com/code-423n4/2022-06-yieldy-findings/issues/120), [Nyamcil](https://github.com/code-423n4/2022-06-yieldy-findings/issues/98), [pashov](https://github.com/code-423n4/2022-06-yieldy-findings/issues/191), [Randyyy](https://github.com/code-423n4/2022-06-yieldy-findings/issues/275), [scaraven](https://github.com/code-423n4/2022-06-yieldy-findings/issues/194), [Sm4rty](https://github.com/code-423n4/2022-06-yieldy-findings/issues/130), [Waze](https://github.com/code-423n4/2022-06-yieldy-findings/issues/137), [Noah3o6](https://github.com/code-423n4/2022-06-yieldy-findings/issues/131), [c3phas](https://github.com/code-423n4/2022-06-yieldy-findings/issues/263), [delfin454000](https://github.com/code-423n4/2022-06-yieldy-findings/issues/228), [ElKu](https://github.com/code-423n4/2022-06-yieldy-findings/issues/58), [GimelSec](https://github.com/code-423n4/2022-06-yieldy-findings/issues/248), [JC](https://github.com/code-423n4/2022-06-yieldy-findings/issues/305), [Kaiziron](https://github.com/code-423n4/2022-06-yieldy-findings/issues/118), [oyc&#95;109](https://github.com/code-423n4/2022-06-yieldy-findings/issues/10), [simon135](https://github.com/code-423n4/2022-06-yieldy-findings/issues/182), [mics](https://github.com/code-423n4/2022-06-yieldy-findings/issues/70), [0xmint](https://github.com/code-423n4/2022-06-yieldy-findings/issues/297), [8olidity](https://github.com/code-423n4/2022-06-yieldy-findings/issues/21), [asutorufos](https://github.com/code-423n4/2022-06-yieldy-findings/issues/217), [Fitraldys](https://github.com/code-423n4/2022-06-yieldy-findings/issues/271), [Funen](https://github.com/code-423n4/2022-06-yieldy-findings/issues/214), [Picodes](https://github.com/code-423n4/2022-06-yieldy-findings/issues/160), [robee](https://github.com/code-423n4/2022-06-yieldy-findings/issues/65), [saian](https://github.com/code-423n4/2022-06-yieldy-findings/issues/227), [sashik&#95;eth](https://github.com/code-423n4/2022-06-yieldy-findings/issues/290), [TrungOre](https://github.com/code-423n4/2022-06-yieldy-findings/issues/192), [UnusualTurtle](https://github.com/code-423n4/2022-06-yieldy-findings/issues/293), [0v3rf10w](https://github.com/code-423n4/2022-06-yieldy-findings/issues/233), [ACai](https://github.com/code-423n4/2022-06-yieldy-findings/issues/34), [bardamu](https://github.com/code-423n4/2022-06-yieldy-findings/issues/83), [Chom](https://github.com/code-423n4/2022-06-yieldy-findings/issues/240), [exd0tpy](https://github.com/code-423n4/2022-06-yieldy-findings/issues/24), [sach1r0](https://github.com/code-423n4/2022-06-yieldy-findings/issues/30), [StErMi](https://github.com/code-423n4/2022-06-yieldy-findings/issues/113), [Limbooo](https://github.com/code-423n4/2022-06-yieldy-findings/issues/244), [s3cunda](https://github.com/code-423n4/2022-06-yieldy-findings/issues/199), [sikorico](https://github.com/code-423n4/2022-06-yieldy-findings/issues/72), [slywaters](https://github.com/code-423n4/2022-06-yieldy-findings/issues/157), [aga7hokakological](https://github.com/code-423n4/2022-06-yieldy-findings/issues/218), and [ignacio](https://github.com/code-423n4/2022-06-yieldy-findings/issues/4).*\n\n## Table of Contents\n\n*   G-01. Duplicated external function call\n*   G-02. Wrong use of the `memory` keyword for a Struct\n*   G-03. Caching storage values in memory\n*   G-04. Avoid emitting a storage variable when a memory value is available\n*   G-05. Unchecking arithmetics operations that can't underflow/overflow\n*   G-06. `LiquidityReserveStorage` : Tightly pack storage variables\n*   G-07. `YieldyStorage` : Tightly pack storage variables\n*   G-08. Duplicated conditions should be refactored to a modifier or function to save deployment costs\n*   G-09. A modifier used only once and not being inherited should be inlined to save gas\n*   G-10. Pre-Solidity `0.8.13`: `> 0` is less efficient than `!= 0` for unsigned integers (with proof)\n*   G-11. `>=` is cheaper than `>` (and `<=` cheaper than `<`)\n*   G-12. Splitting `require()` statements that use `&&` saves gas\n*   G-13. Using private rather than public for constants saves gas\n*   G-14. Amounts should be checked for 0 before calling a transfer\n*   G-15. `++i` costs less gas compared to `i++` or `i += 1` (same for `--i` vs `i--` or `i -= 1`)\n*   G-16. Public functions to external\n*   G-17. It costs more gas to initialize variables with their default value than letting the default value be applied\n*   G-18. Upgrade pragma\n*   G-19. Use Custom Errors instead of Revert Strings to save Gas\n*   G-20. Functions guaranteed to revert when called by normal users can be marked `payable`\n*   G-21. Use `1000` rather than exponentiation `10**3`\n\n## [G-01] Duplicated external function call\n\nExternal function calls are expensive. This one seems like a copy-paste error:\n\n*   [Staking.sol#initialize()](https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L84-L91)\n\n```diff\nFile: Staking.sol\n84:         IERC20Upgradeable(YIELDY_TOKEN).approve(\n85:             LIQUIDITY_RESERVE,\n86:             type(uint256).max\n87:         );\n- 88:         IERC20Upgradeable(YIELDY_TOKEN).approve(\n- 89:             LIQUIDITY_RESERVE,\n- 90:             type(uint256).max\n- 91:         );\n```\n\n## [G-02] Wrong use of the `memory` keyword for a Struct\n\nWhen copying a state struct in memory, there are as many SLOADs and MSTOREs as there are slots. When reading the whole struct multiple times is not needed, it's better to actually only read the relevant field(s). When only some of the fields are read several times, these particular values should be cached instead of the whole state struct.\n\nHere, the `storage` keyword should be used instead of `memory`:\n\n*   Saving 1 STORE and 1 MSTORE: <https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L259-L266>\n\n```diff\nFile: Staking.sol\n259:     function _isClaimAvailable(address _recipient)\n260:         internal\n261:         view\n262:         returns (bool)\n263:     {\n- 264:         Claim memory info = warmUpInfo[_recipient]; //@audit 2 SLOADs + 2 MSTOREs\n+ 264:         Claim storage info = warmUpInfo[_recipient]; //@audit reference-fetching helper (loved by the Optimizer)\n+ 264:         uint256 _expiry = info.expiry; //@audit 1 SLOAD, 1 MSTORE\n- 265:         return epoch.number >= info.expiry && info.expiry != 0;\n+ 265:         return epoch.number >= _expiry && _expiry != 0;\n266:     }\n```\n\n*   Saving 2 MSTOREs and 2 MLOADs: <https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L281-L289>\n\n```diff\nFile: Staking.sol\n- 281:         RequestedWithdrawalInfo memory requestedWithdrawals = tokePoolContract\n+ 281:         RequestedWithdrawalInfo storage requestedWithdrawals = tokePoolContract\n282:             .requestedWithdrawals(address(this));\n283:         uint256 currentCycleIndex = tokeManager.getCurrentCycleIndex();\n284:         return\n285:             epoch.number >= info.expiry &&\n286:             info.expiry != 0 &&\n287:             info.amount != 0 &&\n288:             ((requestedWithdrawals.minCycle <= currentCycleIndex && //@audit requestedWithdrawals.minCycle only accessed once\n289:                 requestedWithdrawals.amount + withdrawalAmount >=  //@audit requestedWithdrawals.amount only accessed once\n```\n\n*   Saving 1 SLOAD and 1 MSTORE: <https://github.com/code-423n4/2022-06-yieldy/blob/524f3b83522125fb7d4677fa7a7e5ba5a2c0fe67/src/contracts/Staking.sol#L466-L474>\n\n```diff\nFile: Staking.sol\n465:     function claim(address _recipient) public {\n- 466:         Claim memory info = warmUpInfo[_recipient]; //@audit 2 SLOADs + 2 MSTOREs\n+ 466:         Claim storage info = warmUpInfo[_recipient]; //@audit reference-fetching helper (loved by the Optimizer)\n+ 466:         uint256 _credits = info.expiry; //@audit 1 SLOAD, 1 MSTORE\n467:         if (_isClaimAvailable(_recipient)) {\n468:             delete warmUpInfo[_recipient];\n469: \n- 470:             if (info.credits > 0) {\n+ 470:             if (_credits > 0) {\n471:                 IYieldy(YIELDY_TOKEN).transfer(\n472:                     _recipient,\n- 473:                     IYieldy(YIELDY_TOKEN).tokenBalanceForCredits(info.credits)\n+ 473:                     IYieldy(YIELDY_TOKEN).tokenBalanceForCredits(_credits)\n474:                 );\n475:             }\n476:         }\n477:     }\n```\n\n## [G-03] Caching storage values in memory\n\nThe code can be optimized by minimizing the number of SLOADs.\n\nSLOADs are expensive (100 gas after the 1st one) compared to MLOADs/MSTOREs (3 gas each). Storage values read multiple times should instead be cached in memory the first time (costing 1 SLOAD) and then read from this cache to avoid multiple SLOADs.\n\n*   `contracts[i]`\n\n```solidity\nFile: BatchRequests.sol\n18:                 contracts[i] != address(0) &&\n19:                 IStaking(contracts[i]).canBatchTransactions()\n20:             ) {\n21:                 IStaking(contracts[i]).sendWithdrawalRequests();\n```\n\n*   `contracts[i]`\n\n```solidity\nFile: BatchRequests.sol\n37:             bool canBatch = IStaking(contracts[i]).canBatchTransactions();\n38:             batch[i] = Batch(contracts[i], canBatch);\n\n```\n\n*   `contracts[_index]`\n\n```solidity\nFile: BatchRequests.sol\n56:             contracts[_index],\n57:             IStaking(contracts[_index]).canBatchTransactions()\n```\n\n*   `stakingToken`\n\n```solidity\nFile: LiquidityReserve.sol\n64:         uint256 stakingTokenBalance = IERC20Upgradeable(stakingToken).balanceOf(\n...\n75:         IERC20Upgradeable(stakingToken).safeTransferFrom(\n```\n\n*   `stakingContract`\n\n```diff\nFile: LiquidityReserve.sol\n72:         stakingContract = _stakingContract;\n...\n81:         IERC20Upgradeable(rewardToken).approve(\n- 82:             stakingContract,\n+ 82:             _stakingContract,\n```\n\n*   `stakingToken`\n\n```solidity\nFile: LiquidityReserve.sol\n106:         uint256 stakingTokenBalance = IERC20Upgradeable(stakingToken).balanceOf(\n...\n121:         IERC20Upgradeable(stakingToken).safeTransferFrom(\n\n```\n\n*   `stakingToken`\n\n```solidity\nFile: LiquidityReserve.sol\n171:             IERC20Upgradeable(stakingToken).balanceOf(address(this)) >=\n...\n177:         IERC20Upgradeable(stakingToken).safeTransfer(\n\n```\n\n*   `affiliateFee` and `FEE_ADDRESS`\n\n```solidity\nFile: Staking.sol\n129:     function _sendAffiliateFee(uint256 _amount) internal {\n130:         if (affiliateFee != 0 && FEE_ADDRESS != address(0)) {\n131:             uint256 feeAmount = (_amount * affiliateFee) / BASIS_POINTS;\n132:             IERC20Upgradeable(TOKE_TOKEN).safeTransfer(FEE_ADDRESS, feeAmount);\n133:         }\n134:     }\n```\n\n*   `TOKE_TOKEN`\n\n```solidity\nFile: Staking.sol\n144:         uint256 totalTokeAmount = IERC20Upgradeable(TOKE_TOKEN).balanceOf(\n145:             address(this)\n146:         );\n147:         IERC20Upgradeable(TOKE_TOKEN).safeTransfer(\n```\n\n*   `requestWithdrawalAmount`\n\n```solidity\nFile: Staking.sol\n392:             if (requestWithdrawalAmount > 0) {\n393:                 _requestWithdrawalFromTokemak(requestWithdrawalAmount);\n394:             }\n```\n\n*   `YIELDY_TOKEN`\n\n```solidity\nFile: Staking.sol\n519:         uint256 walletBalance = IERC20Upgradeable(YIELDY_TOKEN).balanceOf(\n...\n522:         uint256 warmUpBalance = IYieldy(YIELDY_TOKEN).tokenBalanceForCredits(\n...\n545:                     IYieldy(YIELDY_TOKEN).creditsForTokenBalance(_amount);\n546:                 uint256 remainingAmount = IYieldy(YIELDY_TOKEN)\n...\n559:             IERC20Upgradeable(YIELDY_TOKEN).safeTransferFrom(\n```\n\n*   `LIQUIDITY_RESERVE`\n\n```solidity\nFile: Staking.sol\n583:             LIQUIDITY_RESERVE\n...\n588:         ILiquidityReserve(LIQUIDITY_RESERVE).instantUnstake(\n```\n\n*   `CURVE_POOL` / `STAKING_TOKEN` / `TOKE_POOL`\n\n```solidity\nFile: Staking.sol\n633:         if (CURVE_POOL != address(0)) {\n634:             address address0 = ICurvePool(CURVE_POOL).coins(0);\n635:             address address1 = ICurvePool(CURVE_POOL).coins(1);\n636:             int128 from = 0;\n637:             int128 to = 0;\n638: \n639:             if (TOKE_POOL == address0 && STAKING_TOKEN == address1) {\n640:                 to = 1;\n641:             } else if (TOKE_POOL == address1 && STAKING_TOKEN == address0) {\n642:                 from = 1;\n643:             }\n644:             require(from == 1 || to == 1, \"Invalid Curve Pool\");\n645: \n646:             curvePoolFrom = from;\n647:             curvePoolTo = to;\n648: \n649:             emit LogSetCurvePool(CURVE_POOL, curvePoolTo, curvePoolFrom);\n650:         }\n```\n\n*   `_totalSupply`\n\n```diff\nFile: Yieldy.sol\n82:         uint256 currentTotalSupply = _totalSupply;\n- 83:         require(_totalSupply > 0, \"Can't rebase if not circulating\");\n+ 83:         require(currentTotalSupply > 0, \"Can't rebase if not circulating\");\n```\n\n*   `_totalSupply`\n\n```solidity\nFile: Yieldy.sol\n122:                 totalStakedAfter: _totalSupply,\n...\n129:         emit LogSupply(_epoch, block.timestamp, _totalSupply);\n```\n\n## [G-04] Avoid emitting a storage variable when a memory value is available\n\nWhen they are the same, consider emitting the memory value instead of the storage value:\n\n```diff\nFile: Staking.sol\n646:             curvePoolFrom = from;\n647:             curvePoolTo = to;\n648: \n- 649:             emit LogSetCurvePool(CURVE_POOL, curvePoolTo, curvePoolFrom);\n+ 649:             emit LogSetCurvePool(CURVE_POOL, to, from);\n```\n\n## [G-05] Unchecking arithmetics operations that can't underflow/overflow\n\nSolidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn't possible (as an example, when a comparison is made before the arithmetic operation), some gas can be saved by using an `unchecked` block: <https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic>\n\nConsider wrapping with an `unchecked` block here:\n\n```diff\nFile: Yieldy.sol\n210:         require(_allowances[_from][msg.sender] >= _value, \"Allowance too low\");\n211: \n- 212:         uint256 newValue = _allowances[_from][msg.sender] - _value;\n+ 212:         unchecked { uint256 newValue = _allowances[_from][msg.sender] - _value; }\n```\n\n```diff\nFile: Yieldy.sol\n190:         require(creditAmount <= creditBalances[msg.sender], \"Not enough funds\");\n191: \n- 192:         creditBalances[msg.sender] = creditBalances[msg.sender] - creditAmount;\n+ 192:         unchecked { creditBalances[msg.sender] = creditBalances[msg.sender] - creditAmount; }\n```\n\n```diff\nFile: Staking.sol\n713:             if (balance <= staked) {\n714:                 epoch.distribute = 0;\n715:             } else {\n- 716:                 epoch.distribute = balance - staked;\n+ 716:                 unchecked { epoch.distribute = balance - staked; }\n717:             }\n```\n\n```diff\nFile: LiquidityReserve.sol\n- 196:         uint256 amountMinusFee = _amount - ((_amount * fee) / BASIS_POINTS);\n+ 196:         unchecked { uint256 amountMinusFee = _amount - ((_amount * fee) / BASIS_POINTS); }\n```\n\n## [G-06] `LiquidityReserveStorage` : Tightly pack storage variables\n\nHere, variables can be tightly packed from to save 1 SLOT:\n\n```diff\nFile: LiquidityReserveStorage.sol\n04: contract LiquidityReserveStorage {\n05:     address public stakingToken; // staking token address\n06:     address public rewardToken; // reward token address\n07:     address public stakingContract; // staking contract address\n+ 8:     bool public isReserveEnabled; // ensures we are fully initialized\n08:     uint256 public fee; // fee for instant unstaking\n09:     uint256 public constant MINIMUM_LIQUIDITY = 10**3; // lock minimum stakingTokens for initial liquidity\n10:     uint256 public constant BASIS_POINTS = 10000; // 100% in basis points\n- 11:     bool public isReserveEnabled; // ensures we are fully initialized //@audit can be tightly packed\n12: }\n```\n\n## [G-07] `YieldyStorage` : Tightly pack storage variables\n\nHere, variables can be tightly packed from to save 1 SLOT:\n\n```diff\nFile: YieldyStorage.sol\n06: contract YieldyStorage {\n07:     address public stakingContract;\n+ 08:     uint8 internal decimal;\n08:     Rebase[] public rebases;\n09:     uint256 public index;\n10:     bytes32 public constant ADMIN_ROLE = keccak256(\"ADMIN\");\n11:     bytes32 public constant MINTER_BURNER_ROLE =\n12:         keccak256(\"MINTER_BURNER_ROLE\");\n13:     bytes32 public constant REBASE_ROLE = keccak256(\"REBASE_ROLE\");\n14: \n15:     uint256 internal WAD;\n16:     uint256 internal constant MAX_UINT256 = ~uint256(0);\n17: \n18:     uint256 internal constant MAX_SUPPLY = ~uint128(0); // (2^128) - 1\n19:     uint256 public rebasingCreditsPerToken; // gonsPerFragment (fragment == 1 token)\n20:     uint256 public rebasingCredits; // total credits in system\n21:     mapping(address => uint256) public creditBalances; // gonBalances (gon == credit)\n22: \n- 23:     uint8 internal decimal; //@audit can be tightly packed\n24: }\n```\n\n## [G-08] Duplicated conditions should be refactored to a modifier or function to save deployment costs\n\n```solidity\nLiquidityReserve.sol:105:        require(isReserveEnabled, \"Not enabled yet\");\nLiquidityReserve.sol:192:        require(isReserveEnabled, \"Not enabled yet\");\nLiquidityReserve.sol:215:        require(isReserveEnabled, \"Not enabled yet\");\n```\n\n## [G-09] A modifier used only once and not being inherited should be inlined to save gas\n\nAffected code:\n\n```solidity\nsrc/contracts/LiquidityReserve.sol:\n   24:     modifier onlyStakingContract() {\n\n  188      function instantUnstake(uint256 _amount, address _recipient)\n  189          external\n  190:         onlyStakingContract\n  191      {\n```\n\n## [G-10] Pre-Solidity `0.8.13`: `> 0` is less efficient than `!= 0` for unsigned integers (with proof)\n\nUp until Solidity `0.8.13`: `!= 0` costs less gas compared to `> 0` for unsigned integers in `require` statements with the optimizer enabled (6 gas)\n\nProof: While it may seem that `> 0` is cheaper than `!=`, this is only true without the optimizer enabled and outside a require statement. If you enable the optimizer AND you're in a `require` statement, this will save gas. You can see this tweet for more proofs: <https://twitter.com/gzeon/status/1485428085885640706>\n\nConsider changing `> 0` with `!= 0` here:\n\n```solidity\nStaking.sol:118:        require(_recipient.amount > 0, \"Must enter valid amount\");\nStaking.sol:410:        require(_amount > 0, \"Must have valid amount\");\nStaking.sol:572:        require(_amount > 0, \"Invalid amount\");\nStaking.sol:604:        require(_amount > 0, \"Invalid amount\");\nYieldy.sol:83:        require(_totalSupply > 0, \"Can't rebase if not circulating\");\nYieldy.sol:96:            require(rebasingCreditsPerToken > 0, \"Invalid change in supply\");\n```\n\nAlso, please enable the Optimizer.\n\n## [G-11] `>=` is cheaper than `>` (and `<=` cheaper than `<`)\n\nStrict inequalities (`>`) are more expensive than non-strict ones (`>=`). This is due to some supplementary checks (ISZERO, 3 gas). This also holds true between `<=` and `<`.\n\nConsider replacing strict inequalities with non-strict ones to save some gas here:\n\n```solidity\nStaking.sol:324:        uint256 amountToRequest = balance < _amount ? balance : _amount;\n```\n\n## [G-12] Splitting `require()` statements that use `&&` saves gas\n\nIf you're using the Optimizer at 200, instead of using the `&&` operator in a single require statement to check multiple conditions, Consider using multiple require statements with 1 condition per require statement:\n\n```solidity\nLiquidityReserve.sol:45:            _stakingToken != address(0) && _rewardToken != address(0),\nMigration.sol:21:            _oldContract != address(0) && _newContract != address(0),\nStaking.sol:55:            _stakingToken != address(0) &&\nStaking.sol:56:                _yieldyToken != address(0) &&\nStaking.sol:57:                _tokeToken != address(0) &&\nStaking.sol:58:                _tokePool != address(0) &&\nStaking.sol:59:                _tokeManager != address(0) &&\nStaking.sol:60:                _tokeReward != address(0) &&\nStaking.sol:575:            !isUnstakingPaused && !isInstantUnstakingPaused,\nStaking.sol:606:            CURVE_POOL != address(0) &&\nStaking.sol:612:            !isUnstakingPaused && !isInstantUnstakingPaused,\n```\n\nPlease, note that this might not hold true at a higher number of runs for the Optimizer (10k). However, it indeed is true at 200.\n\n## [G-13] Using private rather than public for constants saves gas\n\nIf needed, the value can be read from the verified contract source code. Savings are due to the compiler not having to create non-payable getter functions for deployment calldata, and not adding another entry to the method ID table\n\n```solidity\nLiquidityReserveStorage.sol:9:    uint256 public constant MINIMUM_LIQUIDITY = 10**3; // lock minimum stakingTokens for initial liquidity\nLiquidityReserveStorage.sol:10:    uint256 public constant BASIS_POINTS = 10000; // 100% in basis points\nStakingStorage.sol:39:    uint256 public constant BASIS_POINTS = 10000; // 100% in basis points\n```\n\n## [G-14] Amounts should be checked for 0 before calling a transfer\n\nChecking non-zero transfer values can avoid an expensive external call and save gas.\n\nConsider adding a non-zero-value check here:\n\n```solidity\nLiquidityReserve.sol:121:        IERC20Upgradeable(stakingToken).safeTransferFrom(\nLiquidityReserve.sol:177:        IERC20Upgradeable(stakingToken).safeTransfer(\nLiquidityReserve.sol:198:        IERC20Upgradeable(rewardToken).safeTransferFrom(\nLiquidityReserve.sol:204:        IERC20Upgradeable(stakingToken).safeTransfer(\n```\n\n## [G-15] `++i` costs less gas compared to `i++` or `i += 1` (same for `--i` vs `i--` or `i -= 1`)\n\nPre-increments and pre-decrements are cheaper.\n\nFor a `uint256 i` variable, the following is true with the Optimizer enabled at 10k:\n\n**Increment:**\n\n*   `i += 1` is the most expensive form\n*   `i++` costs 6 gas less than `i += 1`\n*   `++i` costs 5 gas less than `i++` (11 gas less than `i += 1`)\n\n**Decrement:**\n\n*   `i -= 1` is the most expensive form\n*   `i--` costs 11 gas less than `i -= 1`\n*   `--i` costs 5 gas less than `i--` (16 gas less than `i -= 1`)\n\nNote that post-increments (or post-decrements) return the old value before incrementing or decrementing, hence the name *post-increment*:\n\n```solidity\nuint i = 1;  \nuint j = 2;\nrequire(j == i++, \"This will be false as i is incremented after the comparison\");\n```\n\nHowever, pre-increments (or pre-decrements) return the new value:\n\n```solidity\nuint i = 1;  \nuint j = 2;\nrequire(j == ++i, \"This will be true as i is incremented before the comparison\");\n```\n\nIn the pre-increment case, the compiler has to create a temporary variable (when used) for returning `1` instead of `2`.\n\nAffected code:\n\n```solidity\nStaking.sol:708:            epoch.number++;\n```\n\nConsider using pre-increments and pre-decrements where they are relevant (meaning: not where post-increments/decrements logic are relevant).\n\n## [G-16] Public functions to external\n\nAn external call cost is less expensive than one of a public function.\nThe following functions could be set external to save gas and improve code quality (extracted from Slither).\n\n```solidity\nStaking.sol:370:    function unstakeAllFromTokemak() public onlyOwner {\n```\n\n## [G-17] It costs more gas to initialize variables with their default value than letting the default value be applied\n\nIf a variable is not set/initialized, it is assumed to have the default value (`0` for `uint`, `false` for `bool`, `address(0)` for address...). Explicitly initializing it with its default value is an anti-pattern and wastes gas.\n\nAs an example: `for (uint256 i = 0; i < numIterations; ++i) {` should be replaced with `for (uint256 i; i < numIterations; ++i) {`\n\nAffected code:\n\n```solidity\nStaking.sol:636:            int128 from = 0;\nStaking.sol:637:            int128 to = 0;\n```\n\nConsider removing explicit initializations for default values.\n\n## [G-18] Upgrade pragma\n\nUsing newer compiler versions and the optimizer give gas optimizations. Also, additional safety checks are available for free.\n\nThe advantages here are:\n\n*   **Contract existence checks** (>= 0.8.10): external calls skip contract existence checks if the external call has a return value\n\nConsider upgrading here :\n\n```solidity\nBatchRequests.sol:2:pragma solidity 0.8.9;\nLiquidityReserve.sol:2:pragma solidity 0.8.9;\nLiquidityReserveStorage.sol:2:pragma solidity 0.8.9;\nMigration.sol:2:pragma solidity 0.8.9;\nStaking.sol:2:pragma solidity 0.8.9;\nStakingStorage.sol:2:pragma solidity 0.8.9;\nYieldy.sol:2:pragma solidity 0.8.9;\nYieldyStorage.sol:2:pragma solidity 0.8.9;\n```\n\n## [G-19] Use Custom Errors instead of Revert Strings to save Gas\n\nSolidity 0.8.4 introduced custom errors. They are more gas efficient than revert strings, when it comes to deploy cost as well as runtime cost when the revert condition is met. Use custom errors instead of revert strings for gas savings.\n\nCustom errors from Solidity 0.8.4 are cheaper than revert strings (cheaper deployment cost and runtime cost when the revert condition is met)\n\nSource: <https://blog.soliditylang.org/2021/04/21/custom-errors/>:\n\n> Starting from [Solidity v0.8.4](https://github.com/ethereum/solidity/releases/tag/v0.8.4), there is a convenient and gas-efficient way to explain to users why an operation failed through the use of custom errors. Until now, you could already use strings to give more information about failures (e.g., `revert(\"Insufficient funds.\");`), but they are rather expensive, especially when it comes to deploy cost, and it is difficult to use dynamic information in them.\n\nCustom errors are defined using the `error` statement, which can be used inside and outside of contracts (including interfaces and libraries).\n\nConsider replacing all revert strings with custom errors in the solution.\n\n```solidity\nLiquidityReserve.sol:25:        require(msg.sender == stakingContract, \"Not staking contract\");\nLiquidityReserve.sol:44:        require(\nLiquidityReserve.sol:61:        require(!isReserveEnabled, \"Already enabled\");\nLiquidityReserve.sol:62:        require(_stakingContract != address(0), \"Invalid address\");\nLiquidityReserve.sol:68:        require(\nLiquidityReserve.sol:94:        require(_fee <= BASIS_POINTS, \"Out of range\");\nLiquidityReserve.sol:105:        require(isReserveEnabled, \"Not enabled yet\");\nLiquidityReserve.sol:163:        require(_amount <= balanceOf(msg.sender), \"Not enough lr tokens\");\nLiquidityReserve.sol:170:        require(\nLiquidityReserve.sol:192:        require(isReserveEnabled, \"Not enabled yet\");\nLiquidityReserve.sol:215:        require(isReserveEnabled, \"Not enabled yet\");\nMigration.sol:20:        require(\nStaking.sol:54:        require(\nStaking.sol:118:        require(_recipient.amount > 0, \"Must enter valid amount\");\nStaking.sol:143:        require(_claimAddress != address(0), \"Invalid address\");\nStaking.sol:408:        require(!isStakingPaused, \"Staking is paused\");\nStaking.sol:410:        require(_amount > 0, \"Must have valid amount\");\nStaking.sol:527:        require(\nStaking.sol:572:        require(_amount > 0, \"Invalid amount\");\nStaking.sol:574:        require(\nStaking.sol:586:        require(reserveBalance >= _amount, \"Not enough funds in reserve\");\nStaking.sol:604:        require(_amount > 0, \"Invalid amount\");\nStaking.sol:605:        require(\nStaking.sol:611:        require(\nStaking.sol:644:            require(from == 1 || to == 1, \"Invalid Curve Pool\");\nStaking.sol:676:        require(!isUnstakingPaused, \"Unstaking is paused\");\nYieldy.sol:58:        require(stakingContract == address(0), \"Already Initialized\");\nYieldy.sol:59:        require(_stakingContract != address(0), \"Invalid address\");\nYieldy.sol:83:        require(_totalSupply > 0, \"Can't rebase if not circulating\");\nYieldy.sol:96:            require(rebasingCreditsPerToken > 0, \"Invalid change in supply\");\nYieldy.sol:187:        require(_to != address(0), \"Invalid address\");\nYieldy.sol:190:        require(creditAmount <= creditBalances[msg.sender], \"Not enough funds\");\nYieldy.sol:210:        require(_allowances[_from][msg.sender] >= _value, \"Allowance too low\");\nYieldy.sol:249:        require(_address != address(0), \"Mint to the zero address\");\nYieldy.sol:257:        require(_totalSupply < MAX_SUPPLY, \"Max supply\");\nYieldy.sol:279:        require(_address != address(0), \"Burn from the zero address\");\nYieldy.sol:286:        require(currentCredits >= creditAmount, \"Not enough balance\");\n```\n\n## [G-20] Functions guaranteed to revert when called by normal users can be marked `payable`\n\nIf a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided.\n\n```solidity\nBatchRequests.sol:81:    function addAddress(address _address) external onlyOwner {\nBatchRequests.sol:89:    function removeAddress(address _address) external onlyOwner {\nLiquidityReserve.sol:92:    function setFee(uint256 _fee) external onlyOwner {\nStaking.sol:141:    function transferToke(address _claimAddress) external onlyOwner {\nStaking.sol:157:    function setCurvePool(address _curvePool) external onlyOwner {\nStaking.sol:167:    function setAffiliateFee(uint256 _affiliateFee) external onlyOwner {\nStaking.sol:177:    function setAffiliateAddress(address _affiliateAddress) external onlyOwner {\nStaking.sol:187:    function shouldPauseStaking(bool _shouldPause) public onlyOwner {\nStaking.sol:197:    function shouldPauseUnstaking(bool _shouldPause) external onlyOwner {\nStaking.sol:207:    function shouldPauseInstantUnstaking(bool _shouldPause) external onlyOwner {\nStaking.sol:217:    function setEpochDuration(uint256 duration) external onlyOwner {\nStaking.sol:226:    function setWarmUpPeriod(uint256 _vestingPeriod) external onlyOwner {\nStaking.sol:235:    function setCoolDownPeriod(uint256 _vestingPeriod) external onlyOwner {\nStaking.sol:370:    function unstakeAllFromTokemak() public onlyOwner {\nStaking.sol:769:    function preSign(bytes calldata orderUid) external onlyOwner {\n```\n\n## [G-21] Use `1000` rather than exponentiation `10**3`\n\n`1000` is readable enough and the cost of the exponentiation operation would be saved here:\n\n```diff\n+ LiquidityReserveStorage.sol:9:    uint256 public constant MINIMUM_LIQUIDITY = 10**3; // lock minimum stakingTokens for initial liquidity\n- LiquidityReserveStorage.sol:9:    uint256 public constant MINIMUM_LIQUIDITY = 1000; // lock minimum stakingTokens for initial liquidity\n```\n\n**[moose-code (judge) commented](https://github.com/code-423n4/2022-06-yieldy-findings/issues/236#issuecomment-1179547089):**\n > Excellent.\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}