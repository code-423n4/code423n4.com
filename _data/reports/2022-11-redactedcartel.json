{
  "circa": {
    "title": "Redacted Cartel contest",
    "sponsor": "Redacted Cartel",
    "slug": "2022-11-redactedcartel",
    "date": "2023-01-27",
    "findings": "https://github.com/code-423n4/2022-11-redactedcartel-findings/issues",
    "contest": 183
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Redacted Cartel smart contract system written in Solidity. The audit contest took place between November 21—November 28 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>106 Wardens contributed reports to the Redacted Cartel contest:</p>\n<ol>\n<li>0x52</li>\n<li><a href=\"https://twitter.com/0xAgro\">0xAgro</a></li>\n<li>0xLad</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>0xPanda</li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>0xbepresent</li>\n<li>0xfuje</li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li>Awesome</li>\n<li>B2</li>\n<li>Bnke0x0</li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li>Diana</li>\n<li>Englave</li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>HE1M</li>\n<li><a href=\"https://jeiwan.net\">Jeiwan</a></li>\n<li>JohnSmith</li>\n<li>Josiah</li>\n<li>KingNFT</li>\n<li>Koolex</li>\n<li>Lambda</li>\n<li>PaludoX0</li>\n<li>R2</li>\n<li><a href=\"https://www.linkedin.com/in/nhan-vo-a9473019a/\">Rahoz</a></li>\n<li>RaymondFam</li>\n<li>ReyAdmirado</li>\n<li>Rolezn</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li><a href=\"https://www.linkedin.com/in/sathishkumar-p-26069915a\">Sathish9098</a></li>\n<li>Schlagatron</li>\n<li>Secureverse (imkapadia, Nsecv, and leosathya)</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li>Waze</li>\n<li>__141345__</li>\n<li><a href=\"https://github.com/romeroadrian\">adriro</a></li>\n<li>ajtra</li>\n<li>aphak5010</li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>brgltd</li>\n<li>btk</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>carrotsmuggler</li>\n<li>cccz</li>\n<li>ch0bu</li>\n<li>chaduke</li>\n<li><a href=\"https://twitter.com/codeIslight\">codeislight</a></li>\n<li>codexploder</li>\n<li>cryptoDave</li>\n<li>cryptonue</li>\n<li>cryptostellar5</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li><a href=\"https://twitter.com/daniel_yamagata\">danyams</a></li>\n<li>datapunk</li>\n<li>delfin454000</li>\n<li><a href=\"https://rafal-kalinowski.pl/\">deliriusz</a></li>\n<li><a href=\"https://twitter.com/im_Dharma09\">dharma09</a></li>\n<li>eierina</li>\n<li>erictee</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li><a href=\"https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219\">gogo</a></li>\n<li>gz627</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li>halden</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>hihen</li>\n<li>hl_</li>\n<li>imare</li>\n<li>immeas</li>\n<li>jadezti</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>karanctf</li>\n<li>keccak123</li>\n<li>koxuan</li>\n<li>kyteg</li>\n<li>ladboy233</li>\n<li><a href=\"https://github.com/martin-petrov03\">martin</a></li>\n<li>nameruse</li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li>pashov</li>\n<li><a href=\"https://twitter.com/@PavanKumarKv2\">pavankv</a></li>\n<li>peanuts</li>\n<li>pedr02b2</li>\n<li><a href=\"https://twitter.com/Pedroais2/\">pedroais</a></li>\n<li>perseverancesuccess</li>\n<li>poirots (<a href=\"https://twitter.com/DavideSilva_\">DavideSilva</a>, resende, naps62, and eighty)</li>\n<li>rbserver</li>\n<li>rotcivegaf</li>\n<li>rvierdiiev</li>\n<li>sakshamguruji</li>\n<li><a href=\"https://medium.com/@saneryee-studio\">saneryee</a></li>\n<li><a href=\"https://twitter.com/seynixyz\">seyni</a></li>\n<li>shark</li>\n<li>simon135</li>\n<li>subtle77</li>\n<li>unforgiven</li>\n<li>wagmi</li>\n<li><a href=\"https://twitter.com/xiaoming9090\">xiaoming90</a></li>\n<li>yixxas</li>\n<li>yongskiws</li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/thePicodes\">Picodes</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 18 unique vulnerabilities. Of these vulnerabilities, 6 received a risk rating in the category of HIGH severity and 12 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 60 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 33 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-11-redactedcartel\">C4 Redacted Cartel contest repository</a>, and is composed of 13 smart contracts written in the Solidity programming language and includes 1,981 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-6\" style=\"position:relative;\"><a href=\"#high-risk-findings-6\" aria-label=\"high risk findings 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (6)</h1>\n<h2 id=\"h-01-the-redeem-related-functions-are-likely-to-be-blocked\" style=\"position:relative;\"><a href=\"#h-01-the-redeem-related-functions-are-likely-to-be-blocked\" aria-label=\"h 01 the redeem related functions are likely to be blocked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/113\">[H-01] The <code>redeem</code> related functions are likely to be blocked</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/113\">KingNFT</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/186\">xiaoming90</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/161\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/110\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/62\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/58\">HE1M</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L615\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L615</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L685\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L685</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L712\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L712</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The following <code>redeem</code> related functions are likely to be blocked, users will not be able to retrieve their funds.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _redeemPxGlp(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 minOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address receiver</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function redeemPxGlpETH(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 minOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address receiver</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function redeemPxGlp(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 minOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address receiver</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">);</span></span></code></pre>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>GlpManager</code> contract of GMX has a <code>cooldownDuration</code> limit on redeem/unstake (<code>\\_removeLiquidity()</code>). While there is at least one deposit/stake (<code>\\_addLiquidity()</code>) operation in the past <code>cooldownDuration</code> time, redemption would fail. Obviously this limitation is user-based,  and <code>PirexGmx</code> contract is one such user.</p>\n<p><a href=\"https://github.com/gmx-io/gmx-contracts/blob/c3618b0d6fc1b88819393dc7e6c785e32e78c72b/contracts/core/GlpManager.sol#L234\">https://github.com/gmx-io/gmx-contracts/blob/c3618b0d6fc1b88819393dc7e6c785e32e78c72b/contracts/core/GlpManager.sol#L234</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Current setting of `cooldownDuration` is 15 minutes, the max value is 2 days.</span></span></code></pre>\n<p><a href=\"https://arbiscan.io/address/0x321f653eed006ad1c29d174e17d96351bde22649#readContract\">https://arbiscan.io/address/0x321f653eed006ad1c29d174e17d96351bde22649#readContract</a></p>\n<p>Due to the above limit, there are 3 risks that can block redemption for Pirex users.</p>\n<ol>\n<li><strong>The normal case</strong></li>\n</ol>\n<p>Let’s say there is 10% GMX users will use Pirex to manage their GLP.</p>\n<p>By checking recent history of GMX router contract, we can find the average stake interval is smaller than 1 minute\n<a href=\"https://arbiscan.io/address/0xa906f338cb21815cbc4bc87ace9e68c87ef8d8f1\">https://arbiscan.io/address/0xa906f338cb21815cbc4bc87ace9e68c87ef8d8f1</a></p>\n<p>Let’s take</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">averageStakeIntervalOfGMX = 30 seconds</span></span></code></pre>\n<p>So if Pirex has 10% of GMX users, then</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">averageStakeIntervalOfPirex = 30 ÷ 10% = 300 seconds</span></span></code></pre>\n<p>The probability of successfully redeeming is a typical Poisson distribution: <a href=\"https://en.wikipedia.org/wiki/Poisson_distribution\">https://en.wikipedia.org/wiki/Poisson_distribution</a>.</p>\n<p>With</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">λ = cooldownDuration ÷ averageStakeIntervalOfPirex = 15 * 60 ÷ 300 = 3</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">k = 0</span></span></code></pre>\n<p>So we get</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">P ≈ 1 ÷ (2.718 * 2.718 * 2.718) ≈ 0.05 </span></span></code></pre>\n<p>Conclusion</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">If Pirex has 10 % of GMX users, then the redemption will fail with 95% probability.</span></span></code></pre>\n<p>A full list of % of GMX users versus failure probability of redemption</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">1% : 26%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">5% : 78%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">10% : 95%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">20% : 99.75%</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">30% : 99.98%</span></span></code></pre>\n<ol start=\"2\">\n<li><strong>The attack case</strong></li>\n</ol>\n<p>If an attacker, such as bad competitors of similar projects, try to exploit this vulnerability. </p>\n<p>Let’s estimate the cost for attack.</p>\n<p>An attacker can deposit a very small GLP, such as 1 wei, so we can ignore the GLP cost and only focus on GAS cost.</p>\n<p>By checking the explorer history <a href=\"https://arbiscan.io\">https://arbiscan.io</a>\nWe are safe to assume the cost for calling </p>\n<p><code>depositGlpETH()</code> or <code>depositGlp</code> is</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">txCost = 0.1 USD</span></span></code></pre>\n<p>To block redemption, attacker has to execute a deposit call every 15 minutes, so</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">dailyCost = 24 * (60 / 15) * 0.1 = 9.6 USD</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">yearCost = 365 * 9.6 = 3504 USD</span></span></code></pre>\n<p>Conclusion</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">If an attacker wants to block Pirex users funds, his yearly cost is only about 3.5k USD.</span></span></code></pre>\n<ol start=\"3\">\n<li><strong>GMX adjusts protocol parameters</strong></li>\n</ol>\n<p>If GMX increases <code>cooldownDuration</code> to 2 days, it will obviously cause redemption not working.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Reserve some time range for redemption only. e.g. 1 of every 7 days.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/113\">kphed (Redacted Cartel) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-02-users-receive-less-rewards-due-to-miscalculations\" style=\"position:relative;\"><a href=\"#h-02-users-receive-less-rewards-due-to-miscalculations\" aria-label=\"h 02 users receive less rewards due to miscalculations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/177\">[H-02] Users Receive Less Rewards Due To Miscalculations</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/177\">xiaoming90</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/258\">__141345__</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L305\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L305</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L281\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L281</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L373\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L373</a></p>\n<h3 id=\"background\" style=\"position:relative;\"><a href=\"#background\" aria-label=\"background permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Background</h3>\n<p>The amount of rewards accrued by global and user states is computed by the following steps:</p>\n<ol>\n<li>Calculate seconds elapsed since the last update (<code>block.timestamp - lastUpdate</code>)</li>\n<li>Calculate the new rewards by multiplying seconds elapsed by the last supply (<code>(block.timestamp - lastUpdate) * lastSupply</code>)</li>\n<li>Append the new rewards to the existing rewards (<code>rewards = rewards + (block.timestamp - lastUpdate) * lastSupply</code>)</li>\n</ol>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L305\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L305</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Update global accrual state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">globalState</span><span class=\"mtk3\">    GlobalState  Global state of the producer token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">producerToken</span><span class=\"mtk3\">  ERC20        Producer token contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">*/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_globalAccrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">GlobalState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate rewards, the product of seconds elapsed and last supply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Only calculate and update states when needed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">lastSupply</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\">) *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">lastSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeCastTo32</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeCastTo224</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   \t..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L281\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L281</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Update user rewards accrual state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">producerToken</span><span class=\"mtk3\">  ERC20    Rewards-producing token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    </span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">user</span><span class=\"mtk3\">           address  User address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">*/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">userAccrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">) == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">user</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">UserState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">u</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">producerTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">].</span><span class=\"mtk12\">userStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate the amount of rewards accrued by the user up to this call</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">u</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> +</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">u</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastBalance</span><span class=\"mtk1\"> *</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">u</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">u</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeCastTo32</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">u</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastBalance</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeCastTo224</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">u</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>When a user claims the rewards, the number of reward tokens the user is entitled to is equal to the <code>rewardState</code> scaled by the ratio of the <code>userRewards</code> to the <code>globalRewards</code>. Refer to Line 403 below.</p>\n<p>The <code>rewardState</code> represents the total number of a specific ERC20 reward token (e.g. WETH or esGMX) held by a producer (e.g. pxGMX or pxGPL).</p>\n<p>The <code>rewardState</code> of each reward token (e.g. WETH or esGMX) will increase whenever the rewards are harvested by the producer (e.g. <code>PirexRewards.harvest</code> is called). On the other hand, the <code>rewardState</code> will decrease if the users claim the rewards.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L373\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L373</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">373</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">395</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// Transfer the proportionate reward token amounts to the recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">rLen</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">397</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">398</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardRecipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardRecipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">399</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardRecipient</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">400</span><span class=\"mtk1\">:                     ? </span><span class=\"mtk12\">rewardRecipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">401</span><span class=\"mtk1\">:                     : </span><span class=\"mtk12\">user</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">402</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">403</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">..</span><span class=\"mtk12\">SNIP</span><span class=\"mtk1\">..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">417</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h4 id=\"how-reward-tokens-are-distributed\" style=\"position:relative;\"><a href=\"#how-reward-tokens-are-distributed\" aria-label=\"how reward tokens are distributed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How reward tokens are distributed</h4>\n<p>The Multiplier Point (MP) effect will be ignored for simplicity. Assume that the emission rate is constant throughout the entire period (from T80 to T84) and the emission rate is 1 esGMX per 1 GMX staked per second.</p>\n<p>The graph below represents the amount of GMX tokens Alice and Bob staked for each second during the period.</p>\n<p>A = Alice and B = Bob; each block represents 1 GMX token staked.</p>\n<p><img src=\"https://user-images.githubusercontent.com/102820284/204132445-50422095-c02c-4f45-95d6-575667211092.png\"></p>\n<p>Based on the above graph:</p>\n<ul>\n<li>Alice staked 1 GMX token from T80 to T84. Alice will earn five (5) esGMX tokens at the end of T84.</li>\n<li>Bob staked 4 GMX tokens from T83 to T84. Bob will earn eight (8) esGMX tokens at the end of T84.</li>\n<li>A total of 13 esGMX will be harvested by <code>PirexRewards</code> contract at the end of T84</li>\n</ul>\n<p>The existing reward distribution design in the <code>PirexRewards</code> contract will work perfectly if the emission rate is constant, similar to the example above.</p>\n<p>In this case, the state variable will be as follows at the end of T84, assuming both the global and all user states have been updated and rewards have been harvested.</p>\n<ul>\n<li>rewardState = 13 esGMX tokens (5 + 8)</li>\n<li>globalRewards = 13</li>\n<li>Accrued <code>userRewards</code> of Alice = 5</li>\n<li>Accrued <code>userRewards</code> of Bob = 8</li>\n</ul>\n<p>When Alice calls the <code>PirexRewards.claim</code> function to claim her rewards at the end of T84, she will get back five (5) esGMX tokens, which is correct.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk7\">13</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">5</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">13</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>However, the fact is that the emission rate of reward tokens (e.g. esGMX or WETH) is not constant. Instead, the emission rate is dynamic and depends on various factors, such as the following:</p>\n<ul>\n<li>The number of rewards tokens allocated by GMX governance for each month. Refer to <a href=\"https://gov.gmx.io/t/esgmx-emissions/272\">https://gov.gmx.io/t/esgmx-emissions/272</a>. In some months, the number of esGMX emissions will be higher.</li>\n<li>The number of GMX/GLP tokens staked by the community. The more tokens being staked by the community users, the more diluted the rewards will be.</li>\n</ul>\n<p>The graph below represents the amount of GMX tokens Alice and Bob staked for each second during the period.</p>\n<p>A = Alice and B = Bob; each block represents 1 GMX token staked.</p>\n<p><img src=\"https://user-images.githubusercontent.com/102820284/204132445-50422095-c02c-4f45-95d6-575667211092.png\"></p>\n<p>The Multiplier Point (MP) effect will be ignored for simplicity. Assume that the emission rate is as follows:</p>\n<ul>\n<li>From T80 to 82: 2 esGMX per 1 GMX staked per second (Higher emission rate)</li>\n<li>From T83 to 84: 1 esGMX per 1 GMX staked per second (Lower emission rate)</li>\n</ul>\n<p>By manually computing the amount of esGMX reward tokens that Alice is entitled to at the end of T84:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staked</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GMX</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">T82</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">T80</span><span class=\"mtk1\">) * 2</span><span class=\"mtk12\">esGMX</span><span class=\"mtk1\">/</span><span class=\"mtk12\">sec</span><span class=\"mtk1\">] + [</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staked</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GMX</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">T84</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">T83</span><span class=\"mtk1\">) * 1</span><span class=\"mtk12\">esGMX</span><span class=\"mtk1\">/</span><span class=\"mtk12\">sec</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staked</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GMX</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">3</span><span class=\"mtk1\"> </span><span class=\"mtk12\">secs</span><span class=\"mtk1\"> * 2</span><span class=\"mtk12\">esGMX</span><span class=\"mtk1\">/</span><span class=\"mtk12\">sec</span><span class=\"mtk1\">] + [</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staked</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GMX</span><span class=\"mtk1\"> * 2</span><span class=\"mtk12\">secs</span><span class=\"mtk1\"> * 1</span><span class=\"mtk12\">esGMX</span><span class=\"mtk1\">/</span><span class=\"mtk12\">sec</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">6</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">8</span></span></span></code></pre>\n<p>Alice will be entitled to 8 esGMX reward tokens at the end of T84.</p>\n<p>By manually computing the amount of esGMX reward tokens that Bob is entitled to at the end of T84:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">[</span><span class=\"mtk7\">4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">staked</span><span class=\"mtk1\"> </span><span class=\"mtk12\">GMX</span><span class=\"mtk1\"> * 2</span><span class=\"mtk12\">secs</span><span class=\"mtk1\"> * 1</span><span class=\"mtk12\">esGMX</span><span class=\"mtk1\">/</span><span class=\"mtk12\">sec</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">8</span></span></span></code></pre>\n<p>Bob will be entitled to 8 esGMX reward tokens at the end of T84.</p>\n<p>However, the existing reward distribution design in the <code>PirexRewards</code> contract will cause Alice to get fewer reward tokens than she is entitled to and cause Bob to get more rewards than he is entitled to.</p>\n<p>The state variable will be as follows at the end of T84, assuming both the global and all user states have been updated and rewards have been harvested.</p>\n<ul>\n<li>rewardState = 16 esGMX tokens (8 + 8)</li>\n<li>globalRewards = 13</li>\n<li>Accrued <code>userRewards</code> of Alice = 5</li>\n<li>Accrued <code>userRewards</code> of Bob = 8</li>\n</ul>\n<p>When Alice calls the <code>PirexRewards.claim</code> function to claim her rewards at the end of T84, she will only get back six (6) esGMX tokens, which is less than eight (8) esGMX tokens she is entitled to or earned.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk7\">16</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">5</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">13</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">6.15</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">6</span></span></span></code></pre>\n<p>When Bob calls the <code>PirexRewards.claim</code> function to claim his rewards at the end of T84, he will get back nine (9) esGMX tokens, which is more than eight (8) esGMX tokens he is entitled to or earned.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk7\">16</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">8</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">13</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">9.85</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">9</span></span></span></code></pre>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>As shown in the PoC, some users will lose their reward tokens due to the miscalculation within the existing reward distribution design.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update the existing reward distribution design to handle the dynamic emission rate. Implement the RewardPerToken for users and global, as seen in many of the well-established reward contracts below, which are not vulnerable to this issue:</p>\n<ul>\n<li><a href=\"https://github.com/fei-protocol/flywheel-v2/blob/dbe3cb81a3dc2e46536bb8af9c2bdc585f63425e/src/FlywheelCore.sol#L226\">https://github.com/fei-protocol/flywheel-v2/blob/dbe3cb81a3dc2e46536bb8af9c2bdc585f63425e/src/FlywheelCore.sol#L226</a></li>\n<li><a href=\"https://github.com/Synthetixio/synthetix/blob/2cb4b23fe409af526de67dfbb84aae84b2b13747/contracts/StakingRewards.sol#L61\">https://github.com/Synthetixio/synthetix/blob/2cb4b23fe409af526de67dfbb84aae84b2b13747/contracts/StakingRewards.sol#L61</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/177\">kphed (Redacted Cartel) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"h-03-malicious-users-can-drain-the-assets-of-auto-compound-vault\" style=\"position:relative;\"><a href=\"#h-03-malicious-users-can-drain-the-assets-of-auto-compound-vault\" aria-label=\"h 03 malicious users can drain the assets of auto compound vault permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/178\">[H-03] Malicious Users Can Drain The Assets Of Auto Compound Vault</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/178\">xiaoming90</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/388\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/380\">adriro</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/290\">poirots</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/264\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/246\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/211\">PaludoX0</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/197\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/127\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/98\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/89\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/74\">koxuan</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/54\">8olidity</a>, and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/27\">rvierdiiev</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L156\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L156</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L199\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L199</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315</a></p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<blockquote>\n<p>Note: This issue affects both the AutoPxGmx and AutoPxGlp vaults. Since the root cause is the same, the PoC of AutoPxGlp vault is omitted for brevity.</p>\n</blockquote>\n<p>The <code>PirexERC4626.convertToShares</code> function relies on the <code>mulDivDown</code> function in Line 164 when calculating the number of shares needed in exchange for a certain number of assets. Note that the computation is rounded down, therefore, if the result is less than 1 (e.g. 0.9), Solidity will round them down to zero. Thus, it is possible that this function will return zero.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L156\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L156</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">PirexERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">157:         </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">158:         </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">159:         </span><span class=\"mtk11\">virtual</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">160:         </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">161:     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Saves an extra SLOAD if totalSupply is non-zero.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">163</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">164</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">supply</span><span class=\"mtk1\">, </span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">165</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>The <code>AutoPxGmx.previewWithdraw</code> function relies on the <code>PirexERC4626.convertToShares</code> function in Line 206. Thus, this function will also “round down”.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L199\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L199</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">199</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">previewWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">200:         </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">201:         </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">202:         </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">203:         </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">204:     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">205</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// Calculate shares based on the specified assets&#39; proportion of the pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">206</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">207</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">208</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// Save 1 SLOAD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">209</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">210</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">211</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// Factor in additional shares to fulfill withdrawal if user is not the last to withdraw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">212</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">:             (</span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">:                 ? </span><span class=\"mtk12\">shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">:                 : (</span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\">) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">:                     (</span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">withdrawalPenalty</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">217</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>The <code>AutoPxGmx.withdraw</code> function relies on the <code>AutoPxGmx.previewWithdraw</code> function. In certain conditions, the <code>AutoPxGmx.previewWithdraw</code> function in Line 323 will return zero if the withdrawal amount causes the division within the <code>PirexERC4626.convertToShares</code> function to round down to zero (usually due to a small amount of withdrawal amount).</p>\n<p>If the <code>AutoPxGmx.previewWithdraw</code> function in Line 323 returns zero, no shares will be burned at Line 332. Subsequently, in Line 336, the contract will transfer the assets to the users. As a result, the users receive the assets without burning any of their shares, effectively allowing them to receive assets for free.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">315</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">316:         </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk10\">assets</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">317:         </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">318:         </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">319</span><span class=\"mtk1\">:     ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">320</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// Compound rewards and ensure they are properly accounted for prior to withdrawal calculation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">321</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">compound</span><span class=\"mtk1\">(</span><span class=\"mtk12\">poolFee</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">322</span><span class=\"mtk1\">:         </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">323</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">previewWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// No need to check for rounding error, previewWithdraw rounds up.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">324</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">325</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">326</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">allowed</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">allowance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">]; </span><span class=\"mtk3\">// Saves gas for limited approvals.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">327</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">328</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">allowed</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">329</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">allowance</span><span class=\"mtk1\">[</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">][</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">allowed</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">330</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">331</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">332</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">333</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">334</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Withdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">, </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">335</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">336</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">337</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>Assume that the vault with the following state:</p>\n<ul>\n<li>Total Asset = 1000 WETH</li>\n<li>Total Supply = 10 shares</li>\n</ul>\n<p>Assume that Alice wants to withdraw 99 WETH from the vault. Thus, she calls the <code>AutoPxGmx.withdraw(99 WETH)</code> function.</p>\n<p>The <code>PirexERC4626.convertToShares</code> function will compute the number of shares that Alice needs to burn in exchange for 99 WETH.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">supply</span><span class=\"mtk1\">, </span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">99</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\">, 1000</span><span class=\"mtk12\">WETH</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk7\">99</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">10</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">1000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">990</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">1000</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0.99</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span></span></span></code></pre>\n<p>However, since Solidity rounds <code>0.99</code> down to <code>0</code>, Alice does not need to burn a single share. She will receive 99 WETH for free.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Malicious users can withdraw the assets from the vault for free, effectively allowing them to drain the assets of the vault.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure that at least 1 share is burned when the users withdraw their assets.</p>\n<p>This can be mitigated by updating the <code>previewWithdraw</code> function to round up instead of round down when computing the number of shares to be burned.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function previewWithdraw(uint256 assets)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tpublic</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tview</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\toverride</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\treturns (uint256)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t// Calculate shares based on the specified assets&#39; proportion of the pool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-\tuint256 shares = convertToShares(assets);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\tuint256 shares = supply == 0 ? assets : assets.mulDivUp(supply, totalAssets());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t// Save 1 SLOAD</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tuint256 _totalSupply = totalSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t// Factor in additional shares to fulfill withdrawal if user is not the last to withdraw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\treturn</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t(_totalSupply == 0 || _totalSupply - shares == 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t? shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t: (shares * FEE_DENOMINATOR) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t(FEE_DENOMINATOR - withdrawalPenalty);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/264\">kphed (Redacted Cartel) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"h-04-users-accrued-rewards-will-be-lost\" style=\"position:relative;\"><a href=\"#h-04-users-accrued-rewards-will-be-lost\" aria-label=\"h 04 users accrued rewards will be lost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/184\">[H-04] User’s Accrued Rewards Will Be Lost</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/184\">xiaoming90</a></em></p>\n<p>If the user deposits too little GMX compared to other users (or total supply of pxGMX), the user will not be able to receive rewards after calling the <code>PirexRewards.claim</code> function. Subsequently, their accrued rewards will be cleared out (set to zero), and they will lose their rewards.</p>\n<p>The amount of reward tokens that are claimable by a user is computed in Line 403 of the <code>PirexRewards.claim</code> function.</p>\n<p>If the balance of pxGMX of a user is too small compared to other users (or total supply of pxGMX), the code below will always return zero due to rounding issues within solidity.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Since the user’s accrued rewards is cleared at Line 391 within the <code>PirexRewards.claim</code> function (<code>p.userStates[user].rewards = 0;</code>), the user’s accrued rewards will be lost.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L373\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L373</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">368</span><span class=\"mtk1\">:     </span><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">369:         </span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Claim rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">370:         </span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">producerToken</span><span class=\"mtk3\">  ERC20    Producer token contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">371:         </span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">user</span><span class=\"mtk3\">           address  User</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">372:     */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">373</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">374</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">) == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">375</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">user</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">377</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">harvest</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">378</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">userAccrue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">379</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">380</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">ProducerToken</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">p</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">producerTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">381</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">userStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">383</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">384</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// Claim should be skipped and not reverted on zero global/user reward</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">385</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">386</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">387</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rLen</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">388</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">389</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// Update global and user reward states to reflect the claim</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">390</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">391</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">userStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">392</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">393</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Claim</span><span class=\"mtk1\">(</span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">394</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">395</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// Transfer the proportionate reward token amounts to the recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">396</span><span class=\"mtk1\">:             </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">rLen</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">397</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">398</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardRecipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardRecipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">399</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardRecipient</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">400</span><span class=\"mtk1\">:                     ? </span><span class=\"mtk12\">rewardRecipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">401</span><span class=\"mtk1\">:                     : </span><span class=\"mtk12\">user</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">402</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">403</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">404</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">405</span><span class=\"mtk1\">:                 </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">406</span><span class=\"mtk1\">:                     </span><span class=\"mtk3\">// Update reward state (i.e. amount) to reflect reward tokens transferred out</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">407</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">408</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">409</span><span class=\"mtk1\">:                     </span><span class=\"mtk12\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimUserReward</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">410</span><span class=\"mtk1\">:                         </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">411</span><span class=\"mtk1\">:                         </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">412</span><span class=\"mtk1\">:                         </span><span class=\"mtk12\">recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">413</span><span class=\"mtk1\">:                     );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">414</span><span class=\"mtk1\">:                 }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">415</span><span class=\"mtk1\">:             }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">416</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">417</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>The graph below represents the amount of GMX tokens Alice and Bob staked in <code>PirexGmx</code> for each second during the period. Note that the graph is not drawn proportionally.</p>\n<p>Green = Number of GMX tokens staked by Alice</p>\n<p>Blue = Number of GMX tokens staked by Bob</p>\n<p><img src=\"https://user-images.githubusercontent.com/102820284/204132852-f76c8959-5040-46bf-9529-edd0d4a98e41.png\"></p>\n<p>Based on the above graph:</p>\n<ul>\n<li>Alice staked 1 GMX token for 4 seconds (From T80 to T85)</li>\n<li>Bob staked 99999 GMX tokens for 4 seconds (From T80 to T85)</li>\n</ul>\n<p>Assume that the emission rate is 0.1 esGMX per 1 GMX staked per second.</p>\n<p>In this case, the state variable will be as follows at the end of T83, assuming both the global and all user states have been updated and rewards have been harvested.</p>\n<ul>\n<li>rewardState = 60,000 esGMX tokens (600,000 * 0.1)</li>\n<li>globalRewards = 600,000 (100,000 * 6)</li>\n<li>Accrued <code>userRewards</code> of Alice = 6</li>\n<li>Accrued <code>userRewards</code> of Bob = 599,994 (99,999 * 6)</li>\n</ul>\n<p>Following is the description of <code>rewardState</code> for reference:</p>\n<blockquote>\n<p>The <code>rewardState</code> represents the total number of a specific ERC20 reward token (e.g. WETH or esGMX) held by a producer (e.g. pxGMX or pxGPL).</p>\n<p>The <code>rewardState</code> of each reward token (e.g. WETH or esGMX) will increase whenever the rewards are harvested by the producer (e.g. <code>PirexRewards.harvest</code> is called). On the other hand, the <code>rewardState</code> will decrease if the users claim the rewards.</p>\n</blockquote>\n<p>At the end of T85, Alice should be entitled to 1.2 esGMX tokens (0.2/sec * 6).</p>\n<p>Following is the formula used in the <code>PirexRewards</code> contract to compute the number of reward tokens a user is entitled to.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>If Alice claims the rewards at the end of T85, she will get zero esGMX tokens instead of 1.2 esGMX tokens.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">,</span><span class=\"mtk7\">000</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">6</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">600</span><span class=\"mtk1\">,</span><span class=\"mtk7\">000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">360</span><span class=\"mtk1\">,</span><span class=\"mtk7\">000</span><span class=\"mtk1\">/</span><span class=\"mtk7\">600</span><span class=\"mtk1\">,</span><span class=\"mtk7\">000</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0.6</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span></span></span></code></pre>\n<p>Since Alice’s accrued rewards are cleared at Line 391 within the <code>PirexRewards.claim</code> function (<code>p.userStates[user].rewards = 0;</code>), Alice’s accrued rewards will be lost. Alice will have to start accruing the rewards from zero after calling the <code>PirexRewards.claim</code> function.</p>\n<p>Another side effect is that since the 1.2 esGMX tokens that belong to Alice are still in the contract, they will be claimed by other users.</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Users who deposit too little GMX compared to other users (or total supply of pxGMX), the user will not be able to receive rewards after calling the <code>PirexRewards.claim</code> function. Also, their accrued rewards will be cleared out (set to zero). Loss of reward tokens for the users.</p>\n<p>Additionally, the <code>PirexRewards.claim</code> function is permissionless, and anyone can trigger the claim on behalf of any user. A malicious user could call the <code>PirexRewards.claim</code> function on behalf of a victim at the right time when the victim’s accrued reward is small enough to cause a rounding error or precision loss, thus causing the victim accrued reward to be cleared out (set to zero).</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Following are some of the possible remediation actions:</p>\n<h4 id=\"1-use-rewardpertoken-approach\" style=\"position:relative;\"><a href=\"#1-use-rewardpertoken-approach\" aria-label=\"1 use rewardpertoken approach permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Use <code>RewardPerToken</code> approach</h4>\n<p>Avoid calculating the rewards that the users are entitled based on the ratio of <code>userRewards</code> and <code>globalRewards</code>.</p>\n<p>Instead, consider implementing the RewardPerToken for users and global, as seen in many of the well-established reward contracts below, which are not vulnerable to this issue:</p>\n<ul>\n<li><a href=\"https://github.com/fei-protocol/flywheel-v2/blob/dbe3cb81a3dc2e46536bb8af9c2bdc585f63425e/src/FlywheelCore.sol#L226\">https://github.com/fei-protocol/flywheel-v2/blob/dbe3cb81a3dc2e46536bb8af9c2bdc585f63425e/src/FlywheelCore.sol#L226</a></li>\n<li><a href=\"https://github.com/Synthetixio/synthetix/blob/2cb4b23fe409af526de67dfbb84aae84b2b13747/contracts/StakingRewards.sol#L61\">https://github.com/Synthetixio/synthetix/blob/2cb4b23fe409af526de67dfbb84aae84b2b13747/contracts/StakingRewards.sol#L61</a></li>\n</ul>\n<h4 id=\"2-fallback-logic-ifamount---0\" style=\"position:relative;\"><a href=\"#2-fallback-logic-ifamount---0\" aria-label=\"2 fallback logic ifamount   0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Fallback logic if<code>amount == 0</code></h4>\n<p>If the <code>amount</code> is zero, revert the transaction. Alternatively, if the <code>amount</code> is zero, do not clear out the user’s accrued reward state variable since the user did not receive anything yet.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function claim(ERC20 producerToken, address user) external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">..SNIP..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\tuint256 amount = (rewardState * userRewards) / globalRewards;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\tif (amount != 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t// Update reward state (i.e. amount) to reflect reward tokens transferred out</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\tp.rewardStates[rewardToken] = rewardState - amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\tproducer.claimUserReward(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\taddress(rewardToken),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\tamount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\trecipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t} else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t\trevert ZeroRewardTokens();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">..SNIP..</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/184\">kphed (Redacted Cartel) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"h-05-underlying-assets-stealing-in-autopxgmx-and-autopxglp-via-share-price-manipulation\" style=\"position:relative;\"><a href=\"#h-05-underlying-assets-stealing-in-autopxgmx-and-autopxglp-via-share-price-manipulation\" aria-label=\"h 05 underlying assets stealing in autopxgmx and autopxglp via share price manipulation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/275\">[H-05] Underlying assets stealing in <code>AutoPxGmx</code> and <code>AutoPxGlp</code> via share price manipulation</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/275\">Jeiwan</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/407\">seyni</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/401\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/384\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/339\">hl_</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/331\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/307\">peanuts</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/266\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/259\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/253\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/252\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/219\">JohnSmith</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/201\">R2</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/200\">Koolex</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/180\">xiaoming90</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/162\">yongskiws</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/151\">carrotsmuggler</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/128\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/109\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/90\">KingNFT</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/81\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/67\">HE1M</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/59\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/57\">koxuan</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/52\">8olidity</a>, and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/40\">0xLad</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L156-L165\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L156-L165</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L167-L176\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L167-L176</a></p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>pxGMX and pxGLP tokens can be stolen from depositors in <code>AutoPxGmx</code> and <code>AutoPxGlp</code> vaults by manipulating the price of a share.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>ERC4626 vaults are subject to a share price manipulation attack that allows an attacker to steal underlying tokens from other depositors (this is a <a href=\"https://github.com/transmissions11/solmate/issues/178\">known issue</a> of Solmate’s ERC4626 implementation). Consider this scenario (this is applicable to <code>AutoPxGmx</code> and <code>AutoPxGlp</code> vaults):</p>\n<ol>\n<li>Alice is the first depositor of the <code>AutoPxGmx</code> vault;</li>\n<li>Alice deposits 1 wei of pxGMX tokens;</li>\n<li>\n<p>in the <code>deposit</code> function (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L60\">PirexERC4626.sol#L60</a>), the amount of shares is calculated using the <code>previewDeposit</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">previewDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">virtual</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToShares</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">virtual</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Saves an extra SLOAD if totalSupply is non-zero.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> ? </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> : </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">supply</span><span class=\"mtk1\">, </span><span class=\"mtk11\">totalAssets</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n<li>Since Alice is the first depositor (totalSupply is 0), she gets 1 share (1 wei);</li>\n<li>Alice then <em>sends</em> 9999999999999999999 pxGMX tokens (10e18 - 1) to the vault;</li>\n<li>The price of 1 share is 10 pxGMX tokens now: Alice is the only depositor in the vault, she’s holding 1 wei of shares, and the balance of the pool is 10 pxGMX tokens;</li>\n<li>Bob deposits 19 pxGMX tokens and gets only 1 share due to the rounding in the <code>convertToShares</code> function: <code>19e18 * 1 / 10e18 == 1</code>;</li>\n<li>Alice redeems her share and gets a half of the deposited assets, 14.5 pxGMX tokens (less the withdrawal fee);</li>\n<li>Bob redeems his share and gets only 14.5 pxGMX (less the withdrawal fee), instead of the 19 pxGMX he deposited.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// test/AutoPxGmx.t.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testSharePriceManipulation_AUDIT</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">alice</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x31337</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bob</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x12345</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">label</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Alice&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">label</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Bob&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Resetting the withdrawal fee for cleaner amounts.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">autoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setWithdrawalPenalty</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pirexGmx</span><span class=\"mtk1\">));        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk7\">19e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">autoPxGmx</span><span class=\"mtk1\">), </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Alice deposits 1 wei of pxGMX and gets 1 wei of shares.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">autoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Alice sends 10e18-1 of pxGMX and sets the price of 1 wei of shares to 10e18 pxGMX.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">autoPxGmx</span><span class=\"mtk1\">), </span><span class=\"mtk7\">10e18</span><span class=\"mtk1\">-</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">autoPxGmx</span><span class=\"mtk1\">), </span><span class=\"mtk7\">19e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Bob deposits 19e18 of pxGMX and gets 1 wei of shares due to rounding and the price manipulation.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">autoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deposit</span><span class=\"mtk1\">(</span><span class=\"mtk7\">19e18</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Alice and Bob redeem their shares.           </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">autoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">, </span><span class=\"mtk12\">alice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">autoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">redeem</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bob</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Alice and Bob both got 14.5 pxGMX.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// But Alice deposited 10 pxGMX and Bob deposited 19 pxGMX – thus, Alice stole pxGMX tokens from Bob.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// With withdrawal fees enabled, Alice would&#39;ve been penalized more than Bob</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// (14.065 pxGMX vs 14.935 pxGMX tokens withdrawn, respectively),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// but Alice would&#39;ve still gotten more pxGMX that she deposited.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">), </span><span class=\"mtk7\">14.5e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">), </span><span class=\"mtk7\">14.5e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider either of these options:</p>\n<ol>\n<li>In the <code>deposit</code> function of <code>PirexERC4626</code>, consider requiring a reasonably high minimal amount of assets during first deposit. The amount needs to be high enough to mint many shares to reduce the rounding error and low enough to be affordable to users.</li>\n<li>On the first deposit, consider minting a fixed and high amount of shares, irrespective of the deposited amount.</li>\n<li>Consider seeding the pools during deployment. This needs to be done in the deployment transactions to avoid front-running attacks. The amount needs to be high enough to reduce the rounding error.</li>\n<li>Consider sending first 1000 wei of shares to the zero address. This will significantly increase the cost of the attack by forcing an attacker to pay 1000 times of the share price they want to set. For a well-intended user, 1000 wei of shares is a negligible amount that won’t diminish their share significantly.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/275\">Picodes (judge) increased severity to High</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/407\">kphed (Redacted Cartel) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"h-06-fee-loss-in-autopxgmx-and-autopxglp-and-reward-loss-in-autopxglp-by-calling-pirexrewardsclaimpxgmxpxgpl-autopx-directly-which-transfers-rewards-to--autopx-pool-without-compound-logic-get-executed-and-fee-calculation-logic-and-pxgmx-wouldnt-be-executed-for-those-rewards\" style=\"position:relative;\"><a href=\"#h-06-fee-loss-in-autopxgmx-and-autopxglp-and-reward-loss-in-autopxglp-by-calling-pirexrewardsclaimpxgmxpxgpl-autopx-directly-which-transfers-rewards-to--autopx-pool-without-compound-logic-get-executed-and-fee-calculation-logic-and-pxgmx-wouldnt-be-executed-for-those-rewards\" aria-label=\"h 06 fee loss in autopxgmx and autopxglp and reward loss in autopxglp by calling pirexrewardsclaimpxgmxpxgpl autopx directly which transfers rewards to  autopx pool without compound logic get executed and fee calculation logic and pxgmx wouldnt be executed for those rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/321\">[H-06] fee loss in AutoPxGmx and AutoPxGlp and reward loss in AutoPxGlp by calling <code>PirexRewards.claim(pxGmx/pxGpl, AutoPx*)</code> directly which transfers rewards to  AutoPx* pool without compound logic get executed and fee calculation logic and pxGmx wouldn’t be executed for those rewards</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/321\">unforgiven</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/247\">bin2chen</a> and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/143\">0x52</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGlp.sol#L197-L296\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGlp.sol#L197-L296</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L230-L313\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L230-L313</a></p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Function <code>compound()</code> in <code>AutoPxGmx</code> and <code>AutoPxGlp</code> contracts is for compounding <code>pxGLP</code> (and additionally <code>pxGMX</code>) rewards. it works by calling <code>PirexGmx.claim(px*, this)</code> to collect the rewards of the vault and then swap the received amount (to calculate the reward, contract save the balance of a contract in that reward token before and after the call to the <code>claim()</code> and by subtracting them finds the received reward amount) and deposit them in <code>PirexGmx</code> again for compounding and in doing so it calculates fee based on what it received and in <code>AutoPxGlp</code> case it calculates <code>pxGMX</code> rewards too based on the extra amount contract receives during the execution of <code>claim()</code>. But attacker can call <code>PirexGmx.claim(px*, PirexGlp)</code> directly and make <code>PirexGmx</code> contract to transfer (<code>gmxBaseReward</code> and <code>pxGmx</code>) rewards to <code>AutoPxGlp</code> and in this case the logics of fee calculation and reward calculation in <code>compound()</code> function won’t get executed and contract won’t get it’s fee from rewards and users won’t get their <code>pxGmx</code> reward. So this bug would cause fee loss in <code>AutoPxGmx</code> and <code>AutoPxGlp</code> for contract and <code>pxGmx</code>’s reward loss for users in <code>AutoPxGlp</code>.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The bug in <code>AutoPxGmx</code> is similar to <code>AutoPxGlp</code>, so we only give Proof of Concept for <code>AutoPxGlp</code>.</p>\n<p>This is <code>compound()</code> function code in <code>AutoPxGlp</code> contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function compound(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 minUsdg,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 minGlp,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool optOutIncentive</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        public</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 gmxBaseRewardAmountIn,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 pxGmxAmountOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 pxGlpAmountOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 totalPxGlpFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 totalPxGmxFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 pxGlpIncentive,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 pxGmxIncentive</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (minUsdg == 0) revert InvalidParam();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (minGlp == 0) revert InvalidParam();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 preClaimTotalAssets = asset.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 preClaimPxGmxAmount = pxGmx.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        PirexRewards(rewardsModule).claim(asset, address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        PirexRewards(rewardsModule).claim(pxGmx, address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Track the amount of rewards received</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        gmxBaseRewardAmountIn = gmxBaseReward.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (gmxBaseRewardAmountIn != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Deposit received rewards for pxGLP</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (, pxGlpAmountOut, ) = PirexGmx(platform).depositGlp(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(gmxBaseReward),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                gmxBaseRewardAmountIn,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minUsdg,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minGlp,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(this)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Distribute fees if the amount of vault assets increased</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 newAssets = totalAssets() - preClaimTotalAssets;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (newAssets != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            totalPxGlpFee = (newAssets * platformFee) / FEE_DENOMINATOR;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pxGlpIncentive = optOutIncentive</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                ? 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                : (totalPxGlpFee * compoundIncentive) / FEE_DENOMINATOR;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (pxGlpIncentive != 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                asset.safeTransfer(msg.sender, pxGlpIncentive);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            asset.safeTransfer(owner, totalPxGlpFee - pxGlpIncentive);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Track the amount of pxGMX received</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pxGmxAmountOut = pxGmx.balanceOf(address(this)) - preClaimPxGmxAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (pxGmxAmountOut != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Calculate and distribute pxGMX fees if the amount of pxGMX increased</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            totalPxGmxFee = (pxGmxAmountOut * platformFee) / FEE_DENOMINATOR;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pxGmxIncentive = optOutIncentive</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                ? 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                : (totalPxGmxFee * compoundIncentive) / FEE_DENOMINATOR;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (pxGmxIncentive != 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                pxGmx.safeTransfer(msg.sender, pxGmxIncentive);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pxGmx.safeTransfer(owner, totalPxGmxFee - pxGmxIncentive);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Update the pxGmx reward accrual</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _harvest(pxGmxAmountOut - totalPxGmxFee);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Required to keep the globalState up-to-date</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _globalAccrue();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Compounded(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            minGlp,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            gmxBaseRewardAmountIn,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pxGmxAmountOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pxGlpAmountOut,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            totalPxGlpFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            totalPxGmxFee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pxGlpIncentive,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            pxGmxIncentive</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see contract collects rewards by calling <code>PirexRewards.claim()</code> and in the line <code>uint256 newAssets = totalAssets() - preClaimTotalAssets;</code> contract calculates the received amount of rewards (by subtracting the balance after and before reward claim) and then calculates fee based on this amount <code>totalPxGlpFee = (newAssets * platformFee) / FEE_DENOMINATOR;</code> and then sends the fee in the line <code>asset.safeTransfer(owner, totalPxGlpFee - pxGlpIncentive)</code> for <code>owner</code>. </p>\n<p>The logic for <code>pxGmx</code> rewards are the same. As you can see the calculation of the fee is based on the rewards received, and there is no other logic in the contract to calculate and transfer the fee of protocol. So if <code>AutoPxGpl</code> receives rewards without <code>compound()</code> getting called then for those rewards fee won’t be calculated and transferred and protocol would lose it’s fee.</p>\n<p>In the line <code>_harvest(pxGmxAmountOut - totalPxGmxFee)</code> contract calls <code>_harvest()</code> function to update the <code>pxGmx</code> reward accrual and there is no call to <code>_harvest()</code> in any other place and this is the only place where <code>pxGmx</code> reward accrual gets updated. The contract uses <code>pxGmxAmountOut</code> which is the amount of <code>gmx</code> contract received during the call (code calculates it by subtracting the balance after and before reward claim: <code>pxGmxAmountOut = pxGmx.balanceOf(address(this)) - preClaimPxGmxAmount;</code>) so contract only handles accrual rewards in this function call and if some <code>pxGmx</code> rewards claimed for contract without <code>compund()</code> logic execution then those rewards won’t be used in <code>_harvest()</code> and <code>_globalAccrue()</code> calculation and users won’t receive those rewards.</p>\n<p>As mentioned attacker can call <code>PirexRewards.claim(pxGmx, AutoPxGpl)</code> directly and make <code>PirexRewads</code> contract to transfer <code>AutoPxGpl</code> rewards. This is <code>claim()</code> code in <code>PirexRewards</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function claim(ERC20 producerToken, address user) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (address(producerToken) == address(0)) revert ZeroAddress();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (user == address(0)) revert ZeroAddress();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        harvest();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        userAccrue(producerToken, user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ProducerToken storage p = producerTokens[producerToken];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 globalRewards = p.globalState.rewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 userRewards = p.userStates[user].rewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Claim should be skipped and not reverted on zero global/user reward</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (globalRewards != 0 &amp;&amp; userRewards != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ERC20[] memory rewardTokens = p.rewardTokens;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 rLen = rewardTokens.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Update global and user reward states to reflect the claim</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            p.globalState.rewards = globalRewards - userRewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            p.userStates[user].rewards = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            emit Claim(producerToken, user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Transfer the proportionate reward token amounts to the recipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            for (uint256 i; i &lt; rLen; ++i) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                ERC20 rewardToken = rewardTokens[i];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address rewardRecipient = p.rewardRecipients[user][rewardToken];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address recipient = rewardRecipient != address(0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    ? rewardRecipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    : user;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                uint256 rewardState = p.rewardStates[rewardToken];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                uint256 amount = (rewardState * userRewards) / globalRewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                if (amount != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    // Update reward state (i.e. amount) to reflect reward tokens transferred out</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    p.rewardStates[rewardToken] = rewardState - amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    producer.claimUserReward(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        address(rewardToken),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                        recipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it can be called by anyone for any user. So to perform this attack, attacker would perform these steps:</p>\n<ol>\n<li>Suppose <code>AutoPxGpl</code> has pending rewards, for example 100 <code>pxGmx</code> and 100 <code>weth</code>.</li>\n<li>Attacker would call  <code>PirexRewards.claim(pxGmx, AutoPxGpl)</code> and  <code>PirexRewards.claim(pxGpl, AutoPxGpl)</code> and <code>PirexRewards</code> contract would calculate and claim and transfer <code>pxGmx</code> rewards and <code>weth</code> rewards of <code>AutoPxGpl</code> address.</li>\n<li>Then <code>AutoPxGpl</code> has no pending rewards but the balance of <code>pxGmx</code> and <code>weth</code> of contract has been increased.</li>\n<li>If anyone calls <code>AutoPxGpl.compound()</code> because there is no pending rewards contract would receive no rewards and because contract only calculates fee and rewards based on received rewards during the call to <code>compound()</code> so contract wouldn’t calculate any fee or reward accrual for those 1000 <code>pxGmx</code> and <code>weth</code> rewards.</li>\n<li><code>owner</code> of <code>AutoPxGpl</code> would lose his fee for those rewards and users of <code>AutoPxGpl</code> would lose their claims for those 1000 <code>pxGmx</code> rewards (because the calculation for them didn’t happen).</li>\n</ol>\n<p>This bug is because of the fact that the only logic handling rewards is in <code>compound()</code> function which is only handling receiving rewards by calling <code>claim()</code> during the call to <code>compound()</code> but it’s possible to call <code>claim()</code> directly (<code>PirexRewards</code> contract allows this) and <code>AutoPxGpl</code> won’t get notified about this new rewards and the related logics won’t get executed.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Contract should keep track of it’s previous balance when <code>compound()</code> get executed and update this balance in deposits and withdraws and claims so it can detect rewards that directly transferred to contract without call to <code>compound()</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/321\">kphed (Redacted Cartel) confirmed</a></strong> </p>\n<hr>\n<h1 id=\"medium-risk-findings-12\" style=\"position:relative;\"><a href=\"#medium-risk-findings-12\" aria-label=\"medium risk findings 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (12)</h1>\n<h2 id=\"m-01-pirexgmxinitiatemigration-can-be-blocked\" style=\"position:relative;\"><a href=\"#m-01-pirexgmxinitiatemigration-can-be-blocked\" aria-label=\"m 01 pirexgmxinitiatemigration can be blocked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/61\">[M-01] <code>PirexGmx.initiateMigration</code> can be blocked</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/61\">rvierdiiev</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/198\">imare</a> and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/193\">0x52</a></em></p>\n<p><code>PirexGmx.initiateMigration</code> can be blocked so contract will not be able to migrate his funds to another contract using gmx.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>PirexGmx was designed with the thought that the current contract can be changed with another during migration.</p>\n<p><code>PirexGmx.initiateMigration</code> is the first point in this long process.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/PirexGmx.sol#L921-L935\">https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/PirexGmx.sol#L921-L935</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initiateMigration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newContract</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">whenPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">newContract</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Notify the reward router that the current/old contract is going to perform</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// full account transfer to the specified new contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gmxRewardRouterV2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">signalTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newContract</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">migratedTo</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newContract</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InitiateMigration</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newContract</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As you can see <code>gmxRewardRouterV2.signalTransfer(newContract);</code> is called to start migration.</p>\n<p>This is the code of signalTransfer function\n<a href=\"https://arbiscan.io/address/0xA906F338CB21815cBc4Bc87ace9e68c87eF8d8F1#code#F1#L282\">https://arbiscan.io/address/0xA906F338CB21815cBc4Bc87ace9e68c87eF8d8F1#code#F1#L282</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">signalTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gmxVester</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;RewardRouter: sender has vested tokens&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">glpVester</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;RewardRouter: sender has vested tokens&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_validateReceiver</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">pendingReceivers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As you can see the main condition to start migration is that PirexGmx doesn’t control any gmxVester and glpVester tokens.</p>\n<p>So attacker can <a href=\"https://arbiscan.io/address/0xa75287d2f8b217273e7fcd7e86ef07d33972042e#code#F1#L117\">deposit</a> and receive such tokens and then just transfer tokens directly to PirexGmx.</p>\n<p>As a result migration will never be possible as there is no possibility for PirexGmx to burn those gmxVester and glpVester tokens.</p>\n<p>Also in the same way, the migration receiver can also be blocked.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Think about how to make contract ensure that he doesn’t control any gmxVester and glpVester tokens before migration.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/61\">Picodes (judge) decreased severity to Medium</a></strong></p>\n<p><strong>Please note: the following comment occurred after judging and awarding were finalized.</strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/61#issuecomment-1382029037\">kphed (Redacted Cartel) commented</a>:</strong></p>\n<blockquote>\n<p>This issue is invalid and not possible to carry out as a non-GMX insider (if the GMX team and multisig were malicious, there would be many other ways in which they can steal value, so this specific vector would be the least of our concerns) for the following reasons:</p>\n<ol>\n<li>The vester token transfer methods are overridden which removes the possibility of an attacker acquiring vGMX or vGLP and transferring it to the PirexGmx contract via those methods.</li>\n</ol>\n</blockquote>\n<blockquote>\n<p>Vester.sol | Lines 246-263</p>\n<ul>\n<li><a href=\"https://arbiscan.io/address/0x199070ddfd1cfb69173aa2f7e20906f26b363004#code#F1#L246\">vGMX</a></li>\n<li>\n<p><a href=\"https://arbiscan.io/address/0xa75287d2f8b217273e7fcd7e86ef07d33972042e#code#F1#L246\">vGLP</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// empty implementation, tokens are non-transferrable</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function transfer(address /* recipient */, uint256 /* amount */) public override returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> revert(&quot;Vester: non-transferrable&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n</li>\n</ul>\n<p>…</p>\n<p>// empty implementation, tokens are non-transferrable\nfunction transferFrom(address /* sender <em>/, address /</em> recipient <em>/, uint256 /</em> amount */) public virtual override returns (bool) {\nrevert(“Vester: non-transferrable”);\n}</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">2. The `depositForAccount` method can only be called by an account set by the GMX team as a &quot;handler&quot; so an attacker can&#39;t volunteer esGMX be vested on behalf of another account. Even if `depositForAccount` were to be callable by anyone, esGMX has to first be unstaked before it can be deposited for vesting, which is never the case for our contracts.</span></span></code></pre>\n</blockquote>\n<hr>\n<h2 id=\"m-02-preventing-any-user-from-calling-the-functions-withdraw-redeem-or-depositgmx-in-contract-autopxgmx-\" style=\"position:relative;\"><a href=\"#m-02-preventing-any-user-from-calling-the-functions-withdraw-redeem-or-depositgmx-in-contract-autopxgmx-\" aria-label=\"m 02 preventing any user from calling the functions withdraw redeem or depositgmx in contract autopxgmx  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/70\">[M-02] Preventing any user from calling the functions <code>withdraw</code>, <code>redeem</code>, or <code>depositGmx</code> in contract <code>AutoPxGmx</code> </a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/70\">HE1M</a></em></p>\n<p>It is possible that an attacker can prevent any user from calling the functions <code>withdraw</code>, <code>redeem</code>, or <code>depositGmx</code> in contract <code>AutoPxGmx</code> by just manipulating the balance of token <code>gmxBaseReward</code>, so that during the function <code>compound</code> the swap will be reverted.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Whenever a user calls the functions <code>withdraw</code>, <code>redeem</code>, or <code>depositGmx</code> in contract <code>AutoPxGmx</code>, the function <code>compound</code> is called:</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L321\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L321</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L345\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L345</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L379\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L379</a></p>\n<p>The function <code>compound</code> claims token <code>gmxBaseReward</code> from <code>rewardModule</code>:\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L262\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L262</a></p>\n<p>Then, if the balance of the token <code>gmxBaseReward</code> in custodian of the contract <code>AutoPxGmx</code> is not zero, the token <code>gmxBaseReward</code> will be swapped to token <code>GMX</code> thrrough uniswap V3 by calling the function <code>exactInputSingle</code>. Then the total amount of token <code>GMX</code> in custodian of the contract <code>AutoPxGmx</code> will be deposited in the contract <code>PirexGmx</code> to receive token <code>pxGMX</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (gmxBaseRewardAmountIn != 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            gmxAmountOut = SWAP_ROUTER.exactInputSingle(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                IV3SwapRouter.ExactInputSingleParams({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    tokenIn: address(gmxBaseReward),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    tokenOut: address(gmx),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    fee: fee,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    recipient: address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    amountIn: gmxBaseRewardAmountIn,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    amountOutMinimum: amountOutMinimum,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    sqrtPriceLimitX96: sqrtPriceLimitX96</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                })</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Deposit entire GMX balance for pxGMX, increasing the asset/share amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (, pxGmxMintAmount, ) = PirexGmx(platform).depositGmx(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                gmx.balanceOf(address(this)),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                address(this)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>Whenever the function <code>compound</code> is called inside the mentioned functions, the parameters are:\n<code>compound(poolFee, 1, 0, true);</code></p>\n<ul>\n<li><code>fee = poolFee</code></li>\n<li><code>amountOutMinimum = 1</code></li>\n<li><code>sqrtPriceLimitX96 = 0</code></li>\n<li><code>optOutIncentive = true</code></li>\n</ul>\n<p>The vulnerability is the parameter <code>amountOutMinimum</code> which is equal to 1. This provides an attack surface so that if the balance of token <code>gmxBaseReward</code> in <code>AutoPxGmx</code> is nonzero and small enough that does not worth 1 token <code>GMX</code>, the swap procedure will be reverted.</p>\n<p>For example, if the balance of <code>gmxBaseReward</code> is equal to 1, then since the value of <code>gmxBaseReward</code> is lower than token <code>GMX</code>, the output amount of <code>GMX</code> after swapping <code>gmxBaseReward</code> will be zero, and as parameter <code>amountOutMinimum</code> is equal to 1, the swap will be reverted, and as a result, the compound function will be reverted.</p>\n<h4 id=\"attack-scenario\" style=\"position:relative;\"><a href=\"#attack-scenario\" aria-label=\"attack scenario permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Attack Scenario:</h4>\n<p>Suppose, recently the function compound was called, so the balance of token <code>gmxBaseReward</code> in contract <code>AutoPxGmx</code> is equal to zero. Later, Alice (honest user) would like to withdraw. So, she calls the function <code>withdraw(...)</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function withdraw(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 assets,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address receiver,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address owner</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) public override returns (uint256 shares) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Compound rewards and ensure they are properly accounted for prior to withdrawal calculation</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        compound(poolFee, 1, 0, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        shares = previewWithdraw(assets); // No need to check for rounding error, previewWithdraw rounds up.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (msg.sender != owner) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 allowed = allowance[owner][msg.sender]; // Saves gas for limited approvals.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if (allowed != type(uint256).max)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                allowance[owner][msg.sender] = allowed - shares;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _burn(owner, shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit Withdraw(msg.sender, receiver, owner, assets, shares);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        asset.safeTransfer(receiver, assets);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315</a></p>\n<p>In a normal situation, the function <code>compound</code> will be called, and since the balance of <code>gmxBaseReward</code> is zero, no swap will be executed in uniswap V3, and the rest of the code logic will be executed.</p>\n<p>But in this scenario, before Alice’s transaction, Bob transfers 1 token <code>gmxBaseReward</code> directly to contract <code>AutoPxGmx</code> . So, when Alice’s transaction is going to be executed, inside the function <code>compound</code> the swap function will be called (because the balance <code>gmxBaseReward</code> is equal to 1 now). In the function <code>exactInputSingle</code> in uniswap V3, there is a check:\n<code>require(amountOut >= params.amountOutMinimum, 'Too little received');</code>\n<a href=\"https://etherscan.io/address/0xe592427a0aece92de3edee1f18e0157c05861564#code#F1#L128\">https://etherscan.io/address/0xe592427a0aece92de3edee1f18e0157c05861564#code#F1#L128</a></p>\n<p>This check will be reverted, because 1 token of <code>gmxBaseReward</code> is worth less than 1 token of  <code>GMX</code>, so the amount out will be zero which is smaller than <code>amountOutMinimum</code>.</p>\n<p>In summary, an attacker before user’s deposit, checks the balance of token <code>gmxBaseReward</code> in <code>AutoPxGmx</code>. If this balance is equal to zero, the attacker transfers 1 token <code>gmxBaseReward</code> to contract <code>AutoPxGmx</code>, so the user’s transaction will be reverted, and user should wait until this balance reaches to the amount that worth more than or equal to 1 token <code>GMX</code>.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The parameter <code>amountOutMinimum</code> should be equal to zero when the function <code>compound</code> is called.\n<code>compound(poolFee, 0, 0, true);</code></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/70#issuecomment-1336256838\">Picodes (judge) decreased severity to Medium and  commented</a>:</strong></p>\n<blockquote>\n<p>The attack is unlikely: there is no real reason to do it as the attacker would have to pay gas, you need conditions on the price, and conditions on the reward amounts, as if rewards are accruing you won’t be able to do it, so downgrading to Medium severity.</p>\n<p>However it’s true that it may be good to set a minimum amount for the swaps that depends on the <code>amountIn</code>, or remove entirely the <code>minAmountOut</code> requirement.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/70#issuecomment-1341222030\">kphed (Redacted Cartel) commented</a>:</strong></p>\n<blockquote>\n<p>Hi @Picodes, this is going to be resolved as a side effect of issue <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/321\">#321</a> being fixed (i.e. <code>compound</code> will be updated to consider token balances w/o dependence on external factors to prevent DoS’ing of users). Wanted to flag it for your attention but ultimately up to you re: awarding. Thanks for your help ser.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-anyone-can-call-autopxgmxcompound-and-perform-sandwich-attacks-with-control-parameters\" style=\"position:relative;\"><a href=\"#m-03-anyone-can-call-autopxgmxcompound-and-perform-sandwich-attacks-with-control-parameters\" aria-label=\"m 03 anyone can call autopxgmxcompound and perform sandwich attacks with control parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/91\">[M-03] Anyone can call AutoPxGmx.compound and perform sandwich attacks with control parameters</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/91\">cccz</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/418\">Englave</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/391\">immeas</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/346\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/327\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/273\">Jeiwan</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/179\">xiaoming90</a>, and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/125\">aphak5010</a></em></p>\n<p>AutoPxGmx.compound allows anyone to call to compound the reward and get the incentive.</p>\n<p>However, AutoPxGmx.compound calls <code>SWAP_ROUTER</code>.exactInputSingle with some of the parameters provided by the caller, which allows the user to perform a sandwich attack for profit.</p>\n<p>For example, a malicious user could provide the fee parameter to make the token swap occur in a small liquid pool, and could make the amountOutMinimum parameter 1 to make the token swap accept a large slippage, thus making it easier to perform a sandwich attack.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L242-L278\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L242-L278</a></p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using poolFee as the fee and using an onchain price oracle to calculate the amountOutMinimum.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/91#issuecomment-1337106500\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Flagging as best as the warden identifies that the main risk is not the possibility to increase fees but the fact that some of the pools will be highly illiquid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/91#issuecomment-1342052424\">drahrealm (Redacted Cartel) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Please refer to:\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/185#issuecomment-1341252133\">https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/185#issuecomment-1341252133</a></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/91#issuecomment-1368089130\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It’s very likely that this attack is profitable as most of the time only 1 or 2 pools have decent liquidity, so Medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-autopxgmxmaxwithdraw-and-autopxglpmaxwithdraw-functions-calculate-asset-amount-that-is-too-big-and-cannot-be-withdrawn\" style=\"position:relative;\"><a href=\"#m-04-autopxgmxmaxwithdraw-and-autopxglpmaxwithdraw-functions-calculate-asset-amount-that-is-too-big-and-cannot-be-withdrawn\" aria-label=\"m 04 autopxgmxmaxwithdraw and autopxglpmaxwithdraw functions calculate asset amount that is too big and cannot be withdrawn permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/97\">[M-04] AutoPxGmx.maxWithdraw and AutoPxGlp.maxWithdraw functions calculate asset amount that is too big and cannot be withdrawn</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/97\">aphak5010</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L225\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L225</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L14\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L14</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGlp.sol#L14\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGlp.sol#L14</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L199\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L199</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L215-L216\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L215-L216</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L332\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L332</a></p>\n<h3 id=\"impact-6\" style=\"position:relative;\"><a href=\"#impact-6\" aria-label=\"impact 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The ERC-4626 Tokenized Vault Standard requires the <code>maxWithdraw</code> function to be implemented (<a href=\"https://ethereum.org/en/developers/docs/standards/tokens/erc-4626/#maxwithdraw\">https://ethereum.org/en/developers/docs/standards/tokens/erc-4626/#maxwithdraw</a>).</p>\n<p>This function is supposed to return “the maximum amount of underlying assets that can be withdrawn from the owner balance with a single withdraw call”.</p>\n<p>The <code>PirexERC4626</code> contract implements this function (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L225\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/PirexERC4626.sol#L225</a>).<br>\nIt is implemented correctly when <code>PirexERC4626</code> is used on its own.</p>\n<p>However in this project, the <code>PirexERC4626</code> contract is not used on its own but inherited by <code>AutoPxGmx</code> (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L14\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L14</a>) and <code>AutoPxGlp</code> (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGlp.sol#L14\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGlp.sol#L14</a>).</p>\n<p><code>AutoPxGmx</code> and <code>AutoPxGlp</code> implement a <code>withdrawalPenalty</code> i.e. a fee that is paid when a user wants to withdraw assets from the vault.</p>\n<p><code>AutoPxGmx</code> and <code>AutoPxGlp</code> do not override the <code>maxWithdraw</code> function.</p>\n<p>This causes the <code>maxWithdraw</code> function to return an amount of assets that is too big to be withdrawn.</p>\n<p>So when <code>maxWithdraw</code> is called and with the returned amount <code>withdraw</code> is called, the call to <code>withdraw</code> will revert.</p>\n<p>This can cause issues in any upstream components that rely on <code>AutoPxGmx</code> and <code>AutoPxGlp</code> to correctly implement the ERC4626 standard.</p>\n<p>For example an upstream wrapper might only allow withdrawals with the maximum amount and determine this maximum amount by calling the <code>maxWithdraw</code> function. As this function returns a value that is too big, no withdrawals will be possible.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>The <code>maxWithdraw</code> function in a <code>AutoPxGmx</code> contract is called</li>\n<li>Now the <code>withdraw</code> function is called with the value that was returned by the <code>maxWithdraw</code> function (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L315</a>)</li>\n<li>The <code>withdraw</code> function in turn calls the <code>previewWithdraw</code> function (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L199\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L199</a>)</li>\n<li>The <code>previewWithdraw</code> function will increase the amount of shares to include the <code>withdrawalPenalty</code> (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L215-L216\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L215-L216</a>) which causes the amount of shares to burn to be too large and the call to <code>burn</code> will revert (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L332\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L332</a>)</li>\n</ol>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In the <code>AutoPxGmx</code> and <code>AutoPxGlp</code> function, implement the <code>maxWithdraw</code> function that overrides the function in <code>PirexERC4626</code> and takes into account the <code>withdrawalPenalty</code>.</p>\n<p>Potential fix:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxWithdraw</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate assets based on a user&#39;s % ownership of vault shares</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">convertToAssets</span><span class=\"mtk1\">(</span><span class=\"mtk12\">shares</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate a penalty - zero if user is the last to withdraw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">_totalSupply</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">shares</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ? </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        : </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">withdrawalPenalty</span><span class=\"mtk1\">, </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Redeemable amount is the post-penalty amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/97\">drahrealm (Redacted Cartel) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"m-05-swap_router-in-autopxgmxsol-is-hardcoded-and-not-compatible-on-avalanche\" style=\"position:relative;\"><a href=\"#m-05-swap_router-in-autopxgmxsol-is-hardcoded-and-not-compatible-on-avalanche\" aria-label=\"m 05 swap_router in autopxgmxsol is hardcoded and not compatible on avalanche permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/132\">[M-05] <code>SWAP_ROUTER</code> in <code>AutoPxGmx.sol</code> is hardcoded and not compatible on Avalanche</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/132\">ladboy233</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/174\">gzeon</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L18\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L18</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L96\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L96</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L268\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L268</a></p>\n<h3 id=\"impact-7\" style=\"position:relative;\"><a href=\"#impact-7\" aria-label=\"impact 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>I want to quote from the doc:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">- </span><span class=\"mtk12\">Does</span><span class=\"mtk1\"> </span><span class=\"mtk12\">it</span><span class=\"mtk1\"> </span><span class=\"mtk12\">use</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk12\">side</span><span class=\"mtk1\">-</span><span class=\"mtk12\">chain</span><span class=\"mtk1\">? </span><span class=\"mtk12\">Yes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">- </span><span class=\"mtk12\">If</span><span class=\"mtk1\"> </span><span class=\"mtk12\">yes</span><span class=\"mtk1\">, </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">the</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sidechain</span><span class=\"mtk1\"> </span><span class=\"mtk12\">evm</span><span class=\"mtk1\">-</span><span class=\"mtk12\">compatible</span><span class=\"mtk1\">? </span><span class=\"mtk12\">Yes</span><span class=\"mtk1\">, </span><span class=\"mtk12\">Avalanche</span></span></span></code></pre>\n<p>This shows that the projects is intended to support Avalanche side-chain.</p>\n<p><code>SWAP_ROUTER</code> in the AutoPxGmx.sol is hardcoded as:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">IV3SwapRouter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SWAP_ROUTER</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk11\">IV3SwapRouter</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>But this address is the Uniswap V3 router address in arbitrium, but it is a EOA address in Avalanche,</p>\n<p><a href=\"https://snowtrace.io/address/0x68b3465833fb72a70ecdf485e0e4c7bd8665fc45\">https://snowtrace.io/address/0x68b3465833fb72a70ecdf485e0e4c7bd8665fc45</a></p>\n<p>Then the AutoPxGmx.sol is not working in Avalanche.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">gmxAmountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SWAP_ROUTER</span><span class=\"mtk1\">.</span><span class=\"mtk11\">exactInputSingle</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">IV3SwapRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ExactInputSingleParams</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">tokenIn:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">tokenOut:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gmx</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">fee:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">recipient:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">amountIn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gmxBaseRewardAmountIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">amountOutMinimum:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOutMinimum</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">sqrtPriceLimitX96:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sqrtPriceLimitX96</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The code below reverts because the EOA address on Avalanche does not have exactInputSingle method in compound method.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">gmxAmountOut</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">SWAP_ROUTER</span><span class=\"mtk1\">.</span><span class=\"mtk11\">exactInputSingle</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">IV3SwapRouter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ExactInputSingleParams</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">tokenIn:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">tokenOut:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gmx</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">fee:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">recipient:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">amountIn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gmxBaseRewardAmountIn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">amountOutMinimum:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOutMinimum</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk12\">sqrtPriceLimitX96:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sqrtPriceLimitX96</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/**</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@notice</span><span class=\"mtk3\"> Compound pxGMX rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">fee</span><span class=\"mtk3\">                    uint24   Uniswap pool tier fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">amountOutMinimum</span><span class=\"mtk3\">       uint256  Outbound token swap amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">sqrtPriceLimitX96</span><span class=\"mtk3\">      uint160  Swap price impact limit (optional)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@param</span><span class=\"mtk3\">  </span><span class=\"mtk12\">optOutIncentive</span><span class=\"mtk3\">        bool     Whether to opt out of the incentive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@return</span><span class=\"mtk3\"> gmxBaseRewardAmountIn  uint256  GMX base reward inbound swap amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@return</span><span class=\"mtk3\"> gmxAmountOut           uint256  GMX outbound swap amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@return</span><span class=\"mtk3\"> pxGmxMintAmount        uint256  pxGMX minted when depositing GMX</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@return</span><span class=\"mtk3\"> totalFee               uint256  Total platform fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">\t</span><span class=\"mtk4\">@return</span><span class=\"mtk3\"> incentive              uint256  Compound incentive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"> */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">compound</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amountOutMinimum</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">uint160</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sqrtPriceLimitX96</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">optOutIncentive</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We recommend the project not hardcode the <code>SWAP_ROUTER</code>in AutoPxGmx.sol, can pass this parameter in the constructor.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/132#issuecomment-1404064316\">kphed (Redacted Cartel) commented</a>:</strong></p>\n<blockquote>\n<p>The core set of contracts currently functions for both Arbitrum and Avalanche, but the AutoPxGmx contract does not (the auto-compounding contracts are part of the non-core “Easy Mode” offering). We’re aware of this and are holding off on completing those changes launching on Avalanche until after our Arbitrum launch goes smoothly. Thank you for participating in our C4 contest!</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-assets-may-be-lost-when-calling-unprotected-autopxglpcompound-function\" style=\"position:relative;\"><a href=\"#m-06-assets-may-be-lost-when-calling-unprotected-autopxglpcompound-function\" aria-label=\"m 06 assets may be lost when calling unprotected autopxglpcompound function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/137\">[M-06] Assets may be lost when calling unprotected <code>AutoPxGlp::compound</code> function</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/137\">deliriusz</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/416\">keccak123</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/390\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/385\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/348\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/322\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/296\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/205\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/185\">xiaoming90</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/173\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/157\">R2</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/144\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/142\">0xLad</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/141\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/140\">pedroais</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/115\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/83\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/77\">hihen</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/55\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/46\">perseverancesuccess</a>, and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/41\">Englave</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/vaults/AutoPxGlp.sol#L210\">https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/vaults/AutoPxGlp.sol#L210</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/PirexGmx.sol#L497-L516\">https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/PirexGmx.sol#L497-L516</a></p>\n<h3 id=\"impact-8\" style=\"position:relative;\"><a href=\"#impact-8\" aria-label=\"impact 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Compounded assets may be lost because <code>AutoPxGlp::compound</code> can be called by anyone and minimum amount of Glp and USDG are under caller’s control. The only check concerning minValues is that they are not zero (1 will work, however from the perspective of real tokens e.g. 1e6, or 1e18 it’s virtually zero). Additionally, internal smart contract functions use it as well with minimal possible value (e.g. <code>beforeDeposit</code> function).</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>compound</code> function calls PirexGmx::depositGlp, that uses external GMX reward router to mint and stake GLP.</p>\n<p><a href=\"https://snowtrace.io/address/0x82147c5a7e850ea4e28155df107f2590fd4ba327#code\">https://snowtrace.io/address/0x82147c5a7e850ea4e28155df107f2590fd4ba327#code</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">141</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mintAndStakeGlpETH</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minUsdg</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_minGlp</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nonReentrant</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">148</span><span class=\"mtk1\">: </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">glpAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IGlpManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">glpManager</span><span class=\"mtk1\">).</span><span class=\"mtk11\">addLiquidityForAccount</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">weth</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_minUsdg</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_minGlp</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Next <code>GlpManager::addLiquidityForAccount</code> is called\n<a href=\"https://github.com/gmx-io/gmx-contracts/blob/master/contracts/core/GlpManager.sol#L103\">https://github.com/gmx-io/gmx-contracts/blob/master/contracts/core/GlpManager.sol#L103</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function addLiquidityForAccount(address _fundingAccount, address _account, address _token, uint256 _amount, uint256 _minUsdg, uint256 _minGlp) external override nonReentrant returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _validateHandler();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return _addLiquidity(_fundingAccount, _account, _token, _amount, _minUsdg, _minGlp);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>which in turn uses vault to swap token for specific amount of USDG before adding liquidity:\n<a href=\"https://github.com/gmx-io/gmx-contracts/blob/master/contracts/core/GlpManager.sol#L217\">https://github.com/gmx-io/gmx-contracts/blob/master/contracts/core/GlpManager.sol#L217</a></p>\n<p>The amount of USGD to mint is calcualted by GMX own price feed:\n<a href=\"https://github.com/gmx-io/gmx-contracts/blob/master/contracts/core/Vault.sol#L765-L767\">https://github.com/gmx-io/gmx-contracts/blob/master/contracts/core/Vault.sol#L765-L767</a></p>\n<p>In times of market turbulence, or price oracle  manipulation, all compound value may be lost</p>\n<h3 id=\"tools-used-4\" style=\"position:relative;\"><a href=\"#tools-used-4\" aria-label=\"tools used 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code, arbiscan.io</p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Don’t depend on user passing minimum amounts of usdg and glp tokens. Use GMX oracle to get current price, and additionally check it against some other price feed (e.g. ChainLink).</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/137#issuecomment-1404076219\">kphed (Redacted Cartel) commented</a>:</strong></p>\n<blockquote>\n<p>We’re using the following combination of mechanics in order to make front-running <code>compound</code> calls economically unattractive (or, at the very least, minimally impactful) for would-be attackers:</p>\n<ul>\n<li>Compound incentives</li>\n<li>Execution as a side effect of vault functions</li>\n</ul>\n<p>Both will result in a higher frequency of the vault compounding its rewards and less resources available for potential attackers.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-deposit-feature-of-the-vault-will-break-if-update-to-a-new-platform\" style=\"position:relative;\"><a href=\"#m-07-deposit-feature-of-the-vault-will-break-if-update-to-a-new-platform\" aria-label=\"m 07 deposit feature of the vault will break if update to a new platform permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/182\">[M-07] Deposit Feature Of The Vault Will Break If Update To A New Platform</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/182\">xiaoming90</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/417\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/344\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/287\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/245\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/160\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/146\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/124\">aphak5010</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/82\">hihen</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/80\">8olidity</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/78\">cccz</a>, and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/26\">rvierdiiev</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L73\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L73</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L152\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L152</a></p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>During initialization, the <code>AutoPxGMX</code> vault will grant max allowance to the platform (PirexGMX) to spend its GMX tokens in Line 97 of the constructor method below. This is required because the vault needs to deposit GMX tokens to the platform (PirexGMX) contract. During deposit, the platform (PirexGMX) contract will pull the GMX tokens within the vault and send them to GMX protocol for staking. Otherwise, the deposit feature within the vault will not work.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L73\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L73</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">73</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">74</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_gmxBaseReward</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">75</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_gmx</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">76</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">77</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">79</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_platform</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">80</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_rewardsModule</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">81</span><span class=\"mtk1\">:     ) </span><span class=\"mtk11\">Owned</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) </span><span class=\"mtk11\">PirexERC4626</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">82</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_gmxBaseReward</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">83</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_gmx</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">84</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_asset</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">85</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">).</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidAssetParam</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">86</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">).</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidAssetParam</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">87</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_platform</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">88</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_rewardsModule</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">89</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_gmxBaseReward</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">91</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gmx</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_gmx</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">92</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">platform</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_platform</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">93</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">rewardsModule</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_rewardsModule</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">94</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">95</span><span class=\"mtk1\">:         </span><span class=\"mtk3\">// Approve the Uniswap V3 router to manage our base reward (inbound swap token)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">96</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">SWAP_ROUTER</span><span class=\"mtk1\">), </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">97</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeApprove</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_platform</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">98</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>However, when the owner calls the <code>AutoPxGmx.setPlatform</code> function to update the <code>platform</code> to a new address, it does not grant any allowance to the new platform address. As a result, the new platform (PirexGMX) will not be able to pull the GMX tokens from the vault. Thus, the deposit feature of the vault will break, and no one will be able to deposit.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L152\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGmx.sol#L152</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">152</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPlatform</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_platform</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">153</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_platform</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">155</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">platform</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_platform</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">156</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">157</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PlatformUpdated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_platform</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">158</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h3 id=\"impact-9\" style=\"position:relative;\"><a href=\"#impact-9\" aria-label=\"impact 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The deposit feature of the vault will break, and no one will be able to deposit.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Ensure that allowance is given to the new platform address so that it can pull the GMX tokens from the vault.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function setPlatform(address _platform) external onlyOwner {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (_platform == address(0)) revert ZeroAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   if (_platform == platform) revert SamePlatformAddress();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   gmx.safeApprove(platform, 0); // set the old platform approval amount to zero</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   gmx.safeApprove(_platform, type(uint256).max); // approve the new platform contract address allowance to the max</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    platform = _platform;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    emit PlatformUpdated(_platform);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/182\">kphed (Redacted Cartel) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/182#issuecomment-1368421159\">Picodes (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Changing to Medium risk as the DOS would just be temporary as the platform could be reset to its previous value, and there is no clear risk of loss of funds.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-tokens-with-fees-will-break-the-depositglp-logic\" style=\"position:relative;\"><a href=\"#m-08-tokens-with-fees-will-break-the-depositglp-logic\" aria-label=\"m 08 tokens with fees will break the depositglp logic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/196\">[M-08] Tokens with fees will break the <code>depositGlp()</code> logic</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/196\">R2</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/166\">kyteg</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGlp.sol#L367\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/vaults/AutoPxGlp.sol#L367</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L583\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L583</a></p>\n<h3 id=\"impact-10\" style=\"position:relative;\"><a href=\"#impact-10\" aria-label=\"impact 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>In <code>PirexGmx</code> and <code>AutoPxGlp</code> you have function <code>depositGlp()</code>, which accepts any ERC20 token from whitelist.</p>\n<p>Now there are 9 tokens (see here: <a href=\"https://arbiscan.io/address/0x489ee077994b6658eafa855c308275ead8097c4a#readContract\">https://arbiscan.io/address/0x489ee077994b6658eafa855c308275ead8097c4a#readContract</a>):</p>\n<p><code>WBTC, WETH, USDC, LINK, UNI, USDT, MIM, FRAX, DAI</code>\nAnd the list may extend</p>\n<p>So any user can deposit any of those tokens and receive pxGlp token:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function testUSDTDepositGlp() external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // 0 USDT TOKENS</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address myAddress = address(this);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(usdt.balanceOf(myAddress), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // The one with many USDT tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.prank(0xB6CfcF89a7B22988bfC96632aC2A9D6daB60d641);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount = 100000;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        usdt.transfer(myAddress, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // amount USDT TOKENS</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(usdt.balanceOf(myAddress), amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // DEPOSIT USDT TOKENS</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        usdt.approve(address(pirexGmx), amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        pirexGmx.depositGlp(address(usdt), amount, 1, 1, address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // SUCCESSSFULLY DEPOSITED</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(usdt.balanceOf(address(this)), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertEq(pxGlp.balanceOf(address(this)), 118890025839780442);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>But if any of these tokens will start charge fee on transfers, the logic will be broken and calls to <code>depositGlp()</code> with suck token will fail.</p>\n<p>Because here you use the amount of tokens sent from user wallet: <a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L512\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L512</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">            t.safeTransferFrom(msg.sender, address(this), tokenAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Mint and stake GLP using ERC20 tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            deposited = gmxRewardRouterV2.mintAndStakeGlp(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                tokenAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minUsdg,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minGlp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span></code></pre>\n<p>And then <code>gmxRewardRouterV2</code> tries to transfer tokens to his balance from your balance:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20(_token).safeTransferFrom(_fundingAccount, address(vault), _amount);</span></span></code></pre>\n<p>(See <a href=\"https://arbiscan.io/address/0x321f653eed006ad1c29d174e17d96351bde22649#code\">https://arbiscan.io/address/0x321f653eed006ad1c29d174e17d96351bde22649#code</a> - GlpManager and\n<a href=\"https://arbiscan.io/address/0xA906F338CB21815cBc4Bc87ace9e68c87eF8d8F1#code\">https://arbiscan.io/address/0xA906F338CB21815cBc4Bc87ace9e68c87eF8d8F1#code</a> - RewardRouterV2)</p>\n<p>But you received less than <code>tokenAmount</code> tokens because of fee. The transaction will fail.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Let’s imagine USDT in arbitrub started to charge fees 1% per transfer.</p>\n<p>Alice wants to deposit 100 USDT through <code>PirexGmx.depositGlp()</code></p>\n<p>Then you do\n<code>t.safeTransferFrom(Alice, address(this), 100);</code></p>\n<p>You will receive only 99 USDT</p>\n<p>But in the next line you will try to send 100 USDT:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">deposited = gmxRewardRouterV2.mintAndStakeGlp(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                tokenAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minUsdg,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minGlp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span></code></pre>\n<p>So transaction fails and Alice can’t get pxGlp tokens.</p>\n<h3 id=\"tools-used-5\" style=\"position:relative;\"><a href=\"#tools-used-5\" aria-label=\"tools used 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS Code</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>USDT already has fees in other blockchains.</p>\n<p>Many of these tokens use proxy pattern (and USDT too). It’s quite probably that in one day one of the tokens will start charge fees. Or you would like to add one more token to whitelist and the token will be with fees.</p>\n<p>Thats why I consider finding as Medium severity.</p>\n<p>To avoid problems, use common pattern, when you check your balance before operation and balance after, like that:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 balanceBefore = t.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            t.safeTransferFrom(msg.sender, address(this), tokenAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 balanceAfter = t.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 tokenAmount = balanceAfter - balanceBefore;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Mint and stake GLP using ERC20 tokens</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            deposited = gmxRewardRouterV2.mintAndStakeGlp(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                tokenAmount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minUsdg,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                minGlp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/196\">drahrealm (Redacted Cartel) confirmed</a></strong> </p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/196#issuecomment-1368081026\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>As USDT is already an accepted underlying token, Medium severity is appropriate.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-broken-logic-in-configuregmxstate-of-pirexgmx-contract-because-it-doesnt-properly-call-safeapprove-for-stakedgmx-address\" style=\"position:relative;\"><a href=\"#m-09-broken-logic-in-configuregmxstate-of-pirexgmx-contract-because-it-doesnt-properly-call-safeapprove-for-stakedgmx-address\" aria-label=\"m 09 broken logic in configuregmxstate of pirexgmx contract because it doesnt properly call safeapprove for stakedgmx address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/214\">[M-09] broken logic in <code>configureGmxState()</code> of PirexGmx contract because it doesn’t properly call <code>safeApprove()</code> for stakedGmx address</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/214\">unforgiven</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/415\">eierina</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/268\">Jeiwan</a>, and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/199\">imare</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L269-L293\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L269-L293</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L346-L355\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L346-L355</a></p>\n<h3 id=\"impact-11\" style=\"position:relative;\"><a href=\"#impact-11\" aria-label=\"impact 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Function <code>configureGmxState()</code> of <code>PirexGmx</code> is for configuring GMX contract state but logic is using <code>safeApprove()</code> improperly, it won’t reset approval amount for old <code>stakedGmx</code> address This would cause 4 problem:</p>\n<ol>\n<li>Different behavior in <code>setContract()</code> and <code>configureGmxState()</code> for handling <code>stakeGmx</code> address changes. in <code>setContract()</code> the logic reset approval for old address to zero but in <code>configureGmxState()</code> the logic don’t reset old address GMX spending approval.</li>\n<li>The call to this function would revert if <code>stakeGmx</code> address didn’t changed but other addresses has been changed so <code>owner</code> can’t use this to configure contract.</li>\n<li>Contract won’t reset approval for old <code>stakedGmx</code> address which is a threat because contract in that address can steal all the GMX balance any time in the future if that old address had been compromised.</li>\n<li>Contract won’t reset approval for old <code>stakedGmx</code> address, if <code>owner</code> use <code>configureGmxState()</code> to change the <code>stakeGmx</code> value then it won’t be possible to set <code>stakedGmx</code> value to previous ones by using either <code>configureGmxState()</code> or <code>setContract()</code> and contract would be in broken state.</li>\n</ol>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is <code>configureGmxState()</code> code in <code>PirexGmx</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    /**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        @notice Configure GMX contract state</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function configureGmxState() external onlyOwner whenPaused {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Variables which can be assigned by reading previously-set GMX contracts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTrackerGmx = RewardTracker(gmxRewardRouterV2.feeGmxTracker());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTrackerGlp = RewardTracker(gmxRewardRouterV2.feeGlpTracker());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        feeStakedGlp = RewardTracker(gmxRewardRouterV2.stakedGlpTracker());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        stakedGmx = RewardTracker(gmxRewardRouterV2.stakedGmxTracker());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        glpManager = gmxRewardRouterV2.glpManager();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        gmxVault = IVault(IGlpManager(glpManager).vault());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit ConfigureGmxState(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            msg.sender,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardTrackerGmx,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            rewardTrackerGlp,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            feeStakedGlp,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            stakedGmx,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            glpManager,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            gmxVault</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Approve GMX to enable staking</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        gmx.safeApprove(address(stakedGmx), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see it just sets the approval for new <code>stakeGmx</code> address and doesn’t do anything about spending approval of old <code>stakeGmx</code> address.</p>\n<p>This is part of the <code>setContract()</code> code that handels <code>stakeGmx</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (c == Contracts.StakedGmx) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Set the current stakedGmx (pending change) approval amount to 0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            gmx.safeApprove(address(stakedGmx), 0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            stakedGmx = RewardTracker(contractAddress);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Approve the new stakedGmx contract address allowance to the max</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            gmx.safeApprove(contractAddress, type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>As you can see it resets the spending approval of old <code>stakedGmx</code> address to zero and then give unlimited spending approval for new address.</p>\n<p>So the impact #1 is obvious that the code for same logic in two different functions don’t behave similarly.</p>\n<p>Function <code>configureGmxState()</code> is used for configuring GMX contract state but if <code>owner</code> uses this function one time then it won’t be possible to call this function the second time if <code>stakedGmx</code> wasn’t changed. For example in this scenario:</p>\n<ol>\n<li>Owner calls <code>configureGmxState()</code> to set values for GMX contract addresses.</li>\n<li>Then address of one of contract changes in GMX (<code>stakedGmx</code> stayed the same) and owner wants to call <code>configureGmxState()</code> to reset the values of variables to correct ones.</li>\n<li>Owner call to <code>configureGmxState()</code> would fail because <code>stakedGmx</code> address didn’t change and in the line <code>gmx.safeApprove(address(stakedGmx), type(uint256).max);</code> contract tries to set non zero approval for <code>stakedGmx</code> but it already has non zero spending allowance. (<code>safeApprove()</code> would revert if the current spending allowance is not zero and the new allowance is not zero either).</li>\n</ol>\n<p>So the impact #2 would happen and calls to this function in some scenarios would fail and it won’t be functional.</p>\n<p>Because function <code>configureGmxState()</code> doesn’t reset the old <code>stakeGmx</code> addresses GMX token spending approval to 0x0 so it would be possible to lose all GMX balance of <code>PirexGmx</code> contract if the old <code>stakeGmx</code> addresses are compromised. For example in this scenario:</p>\n<ol>\n<li>GMX protocol get hacked (either by a bug or leaking some private keys) and <code>stakeGmx</code> contract control would be in hacker’s hand.</li>\n<li>GMX deploy new contracts and <code>stakeGmx</code> address changes in <code>GMX.()</code></li>\n<li>owner of <code>PirexGmx</code> calls <code>configureGmxState()</code> to reset the values of GMX contracts addresses in <code>PirexGmx</code>.</li>\n<li>Function <code>configureGmxState()</code> logic would change the GMX contract addresses but it won’t set GMX token spending approval for old <code>stakeGmx</code> address to zero.</li>\n<li>Hacker who control the old <code>stakeGmx</code> address would use his access to that address contract to withdraw GMX balance of <code>PirexGmx</code>.</li>\n</ol>\n<p>B<code>PirexGmx</code> won’t set approval for old <code>stakeGmx</code> contract so it would be possible for that old <code>stakeGmx</code> address to transfer GMX balance of <code>PirexGmx</code> anytime in future. The bug in old <code>stakeGmx</code> contract or leakage of private keys of <code>stakeGmx</code> address (private key who can become the owner or admin of that contract) can happen after migrating GMX and Pirex contracts too. This is impact #3 scenario.</p>\n<p>In scenario #4, contract would be stuck in unrecoverable state. The problem is that if <code>configureGmxState()</code> gets used more than once and <code>stakeGmx</code> variable’s value has been changes more than once then it won’t be possible to set <code>stakeGmx</code> value to old values either with <code>configureGmxState()</code> or <code>setContract()</code> and the contract won’t be useful. The scenario is this: (<code>safeApprove()</code> won’t allow to set non-zero approval for address that has already non-zero approval amount. See the OZ implementation)</p>\n<ol>\n<li>GMX protocol changes its <code>stakeGmx</code> contract address from old address to new (for any reason, they got hacked or they are migrating or …)</li>\n<li><code>owner</code> of <code>PirexGmx</code> calls <code>configureGmxState()</code> to update GMX protocol’s contract address in <code>PirexGmx</code> contract and the logic would update the values of variables. (The GMX spending approval for old and new <code>stakeGmx</code> address would be max value).</li>\n<li>GMX protocol changes <code>stakeGmx</code> contract address from new value to old value (for any reason, they decided to roll back to old address).</li>\n<li>Owner tries to call <code>configureGmxState()</code> to reupdate GMX protocol’s address in <code>PirexGmx</code> but the call would revert because the code tries to call <code>safeApprove()</code> for address that has already non-zero allowance.</li>\n<li>Owner can’t call <code>setContract()</code> to update value of <code>stakeGmx</code> variable because this function tries to call <code>safeApprove()</code> to set non-zero approval value for address that already has non-zero allowance.</li>\n</ol>\n<p>So in this state <code>owner</code> can’t recover <code>PirexGmx</code> contract and because contract has wrong value for <code>stakeGmx</code> it won’t be functional and it would stay in broken state.</p>\n<h3 id=\"tools-used-6\" style=\"position:relative;\"><a href=\"#tools-used-6\" aria-label=\"tools used 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h4 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Like <code>setContract()</code>, function <code>configureGmxState()</code> should set approval for old <code>PirexGmx</code> to zero first.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/214#issuecomment-1342982421\">drahrealm (Redacted Cartel) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>The method was meant to be called only once (ie. right before unpausing the contract to make it live). To make it clearer, we will change the method name to <code>initializeGmxState</code> instead.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/214#issuecomment-1365204292\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Maybe you could add a flag to prevent the method from being called multiple times as well.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-_calculaterewards-in-pirexgmx-dont-handle-reward-calculation-properly-and-it-would-revert-when-totalsupply-is-zero-which-will-cause-claimrewards-to-revert-if-one-of-4-rewardtrackers-totalsupply-was-zero\" style=\"position:relative;\"><a href=\"#m-10-_calculaterewards-in-pirexgmx-dont-handle-reward-calculation-properly-and-it-would-revert-when-totalsupply-is-zero-which-will-cause-claimrewards-to-revert-if-one-of-4-rewardtrackers-totalsupply-was-zero\" aria-label=\"m 10 _calculaterewards in pirexgmx dont handle reward calculation properly and it would revert when totalsupply is zero which will cause claimrewards to revert if one of 4 rewardtrackers totalsupply was zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/237\">[M-10] <code>_calculateRewards()</code> in PirexGmx don’t handle reward calculation properly, and it would revert when <code>totalSupply()</code> is zero which will cause <code>claimRewards()</code> to revert if one of 4 rewardTracker’s totalSupply was zero</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/237\">unforgiven</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/50\">8olidity</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L733-L816\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L733-L816</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L228-L267\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L228-L267</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L332-L348\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L332-L348</a></p>\n<h3 id=\"impact-12\" style=\"position:relative;\"><a href=\"#impact-12\" aria-label=\"impact 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Function <code>claimRewards()</code> in <code>PirexGmx</code> claims WETH and esGMX rewards and multiplier points (MP) from GMX protocol. it uses <code>_calculateRewards()</code> to calculate the unclaimed reward token amounts produced for each token type. But because of the lack of checks, function <code>_calculateRewards()</code> would revert when <code>RewardTracker.distributor.totalSupply()</code> is zero so if any of the 4 <code>RewardTracker</code>s has zero <code>totalSupply()</code> then function <code>claimRewards()</code> would revert too and function <code>harvest()</code> in <code>PirexRewards</code> contract would revert too because it calls <code>PirexGmx.claimRewards()</code>. </p>\n<p><code>harvest()</code> is used in <code>claim()</code> function so <code>claim()</code> would not work too. This bug would harvest rewards for <code>PirexRewards</code> contract and claim rewards for users from <code>PirexRewards</code> when supply of one of <code>RewardTracker</code>s contracts in GMX protocol is zero.</p>\n<p>Function <code>claimRewards()</code> is written based on GMX code, but the logic is not correctly copied because  GMX protocol contract checks for <code>totalSupply()</code> and it prevents this bug from happening.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is function <code>_calculateRewards()</code>’s code in <code>PirexGmx</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">   function _calculateRewards(bool isBaseReward, bool useGmx)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        internal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        view</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (uint256)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        RewardTracker r;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (isBaseReward) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            r = useGmx ? rewardTrackerGmx : rewardTrackerGlp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            r = useGmx ? stakedGmx : feeStakedGlp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address distributor = r.distributor();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 pendingRewards = IRewardDistributor(distributor)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .pendingRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 distributorBalance = (isBaseReward ? gmxBaseReward : esGmx)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .balanceOf(distributor);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 blockReward = pendingRewards &gt; distributorBalance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ? distributorBalance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            : pendingRewards;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 precision = r.PRECISION();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 cumulativeRewardPerToken = r.cumulativeRewardPerToken() +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ((blockReward * precision) / r.totalSupply());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (cumulativeRewardPerToken == 0) return 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            r.claimableReward(address(this)) +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ((r.stakedAmounts(address(this)) *</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                (cumulativeRewardPerToken -</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    r.previousCumulatedRewardPerToken(address(this)))) /</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                precision);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>As you can see in the line <code>uint256 cumulativeRewardPerToken = r.cumulativeRewardPerToken() + ((blockReward * precision) / r.totalSupply())</code> if <code>totalSupply()</code> was zero then code would revert because of division by zero error. So if <code>RewardTracker.distributor.totalSupply()</code> was zero then function <code>_calculateRewards</code> would revert and won’t work and other function using <code>_calculateRewards()</code> would be break too.</p>\n<p>This is part of function <code>claimRewards()</code>’s code in <code>PirexGmx</code> contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function claimRewards()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        onlyPirexRewards</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ERC20[] memory producerTokens,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ERC20[] memory rewardTokens,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256[] memory rewardAmounts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Assign return values used by the PirexRewards contract</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        producerTokens = new ERC20[](4);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokens = new ERC20[](4);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardAmounts = new uint256[](4);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        producerTokens[0] = pxGmx;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        producerTokens[1] = pxGlp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        producerTokens[2] = pxGmx;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        producerTokens[3] = pxGlp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokens[0] = gmxBaseReward;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokens[1] = gmxBaseReward;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokens[2] = ERC20(pxGmx); // esGMX rewards distributed as pxGMX</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        rewardTokens[3] = ERC20(pxGmx);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Get pre-reward claim reward token balances to calculate actual amount received</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 baseRewardBeforeClaim = gmxBaseReward.balanceOf(address(this));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 esGmxBeforeClaim = stakedGmx.depositBalances(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(this),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(esGmx)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Calculate the unclaimed reward token amounts produced for each token type</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 gmxBaseRewards = _calculateRewards(true, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 glpBaseRewards = _calculateRewards(true, false);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 gmxEsGmxRewards = _calculateRewards(false, true);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 glpEsGmxRewards = _calculateRewards(false, false);</span></span></code></pre>\n<p>As you can see it calls <code>_calculateRewards()</code> to calculate  the unclaimed reward token amounts  produced for each token type in GMX protocol. so function <code>claimRewards()</code> would revert too when <code>totalSupply()</code> of one of these 4 <code>RewardTracker</code>’s distributers was zero.</p>\n<p>This is part of functions <code>harvest()</code> and <code>claim()</code> code in <code>PirexReward</code> contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function harvest()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        public</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        returns (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ERC20[] memory _producerTokens,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ERC20[] memory rewardTokens,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256[] memory rewardAmounts</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (_producerTokens, rewardTokens, rewardAmounts) = producer</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            .claimRewards();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 pLen = _producerTokens.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">.......</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">......</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">......</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function claim(ERC20 producerToken, address user) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (address(producerToken) == address(0)) revert ZeroAddress();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (user == address(0)) revert ZeroAddress();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        harvest();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        userAccrue(producerToken, user);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">....</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">....</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">....</span></span></code></pre>\n<p>As you can see <code>harvest()</code> calls <code>claimRewards()</code> and <code>claim()</code> calls <code>harvest()</code> so these two functions would revert and won’t work when <code>totalSupply()</code> of one of these 4 <code>RewardTracker</code>’s distributers in GMX protocol was zero. In that situation the protocol can’t harvest and claim rewards from GMX because of this bug and users won’t be able to claim their rewards from the protocol. The condition for this bug could happen from time to time as GMX decided to prevent it by checking the value of <code>totalSupply()</code>.</p>\n<p> This is function <code>_updateRewards()</code> code in <code>RewardTracker</code> in GMX protocol (<a href=\"https://github.com/gmx-io/gmx-contracts/blob/65e62b62aadea5baca48b8157acb9351249dbaf1/contracts/staking/RewardTracker.sol#L272-L286\">https://github.com/gmx-io/gmx-contracts/blob/65e62b62aadea5baca48b8157acb9351249dbaf1/contracts/staking/RewardTracker.sol#L272-L286</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _updateRewards(address _account) private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 blockReward = IRewardDistributor(distributor).distribute();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 supply = totalSupply;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _cumulativeRewardPerToken = cumulativeRewardPerToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (supply &gt; 0 &amp;&amp; blockReward &gt; 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _cumulativeRewardPerToken = _cumulativeRewardPerToken.add(blockReward.mul(PRECISION).div(supply));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            cumulativeRewardPerToken = _cumulativeRewardPerToken;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // cumulativeRewardPerToken can only increase</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">....</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">....</span></span></code></pre>\n<p>As you can see it checks that <code>supply > 0</code> before using it as denominator in division. So GMX protocol handles the case when <code>totalSupply()</code> is zero and contract logics won’t break when this case happens but function <code>_calculateRewards()</code>, which tries to calculate GMX protocol rewards beforehand, don’t handle this case(the case where <code>totalSupply()</code> is zero) so the logics would break when this case happens and it would cause function <code>harvest()</code> and <code>claim()</code> to be unfunctional.</p>\n<h3 id=\"tools-used-7\" style=\"position:relative;\"><a href=\"#tools-used-7\" aria-label=\"tools used 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VIM</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check that <code>totalSupply()</code> is not zero before using it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/237\">drahrealm (Redacted Cartel) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"m-11-pirexgmxmigratereward-may-cause-users-to-lose-reward\" style=\"position:relative;\"><a href=\"#m-11-pirexgmxmigratereward-may-cause-users-to-lose-reward\" aria-label=\"m 11 pirexgmxmigratereward may cause users to lose reward permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/249\">[M-11] PirexGmx#migrateReward() may cause users to lose Reward.</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/249\">bin2chen</a></em></p>\n<p><code>PirexGmx#migrateReward()</code> may cause users to lose Reward before PirexRewards.sol set new PirexGmx.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The current migration process is: <code>call # completemigration ()-> # migrateward ()</code></p>\n<p>After this method, the producer of PirexRewards.sol contract is still the old PirexGmx.</p>\n<p>At this time, if <code>AutoPxGmx#compound ()</code> is called by bot:</p>\n<p><code>AutoPxGmx#compound() -> PirexRewards#.claim() -> old_PirexGmx#claimRewards()</code></p>\n<p><code>Old_PirexGmx#claimRewards ()</code> will return zero rewards and the reward of AutopXGMX will be lost.</p>\n<p>Old PirexGmx still can execute\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L824-L828\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L824-L828</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L940-L949\">https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L940-L949</a></p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>There are two ways to solve the problem.</p>\n<ol>\n<li>Set the producer of PirexRewards to the new PirexGmx in <code>completeMigration ()</code>.</li>\n<li>In <code>#migrateReward ()</code>, set the old PirexGmx’s “pirexRewards” to <code>address(0)</code>, so that you can’t use the old PirexGmx to get rewards</li>\n</ol>\n<p>Simply use the second, such as:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">migrateReward</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenPaused</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">migratedTo</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotMigratedTo</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">gmxRewardRouterV2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">pendingReceivers</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PendingMigration</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Transfer out any remaining base reward (ie. WETH) to the new contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">migratedTo</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       </span><span class=\"mtk12\">pirexRewards</span><span class=\"mtk1\"> ==</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);   </span><span class=\"mtk3\">//*** set pirexRewards=0,Avoid claimRewards () being called by mistake.***//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/249\">drahrealm (Redacted Cartel) confirmed</a></strong> </p>\n<hr>\n<h2 id=\"m-12-reward-tokens-mismanagement-can-cause-users-losing-rewards\" style=\"position:relative;\"><a href=\"#m-12-reward-tokens-mismanagement-can-cause-users-losing-rewards\" aria-label=\"m 12 reward tokens mismanagement can cause users losing rewards permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/271\">[M-12] Reward tokens mismanagement can cause users losing rewards</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/271\">Jeiwan</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/387\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/379\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/361\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/255\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/242\">unforgiven</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/229\">cryptoDave</a>, <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/194\">Koolex</a>, and <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/100\">datapunk</a></em></p>\n<p>A user (which can also be one of the autocompounding contracts, <code>AutoPxGlp</code> or <code>AutoPxGmx</code>) can lose a reward as a result of reward tokens mismanagement by the owner.</p>\n<h3 id=\"proof-of-concept-16\" style=\"position:relative;\"><a href=\"#proof-of-concept-16\" aria-label=\"proof of concept 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The protocol defines a short list of reward tokens that are hard coded in the <code>claimRewards</code> function of the <code>PirexGmx</code> contract (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexGmx.sol#L756-L759\">PirexGmx.sol#L756-L759</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// esGMX rewards distributed as pxGMX</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">[</span><span class=\"mtk7\">3</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The fact that these addresses are hard coded means that no other reward tokens will be supported by the protocol. However, the <code>PirexRewards</code> contract maintains a different list of reward tokens, one per producer token (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L19-L31\">PirexRewards.sol#L19-L31</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProducerToken</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">GlobalState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UserState</span><span class=\"mtk1\">) </span><span class=\"mtk12\">userStates</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">rewardStates</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">address</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">rewardRecipients</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Producer tokens mapped to their data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ProducerToken</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">producerTokens</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>These reward tokens can be added (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L151\">PirexRewards.sol#L151</a>) or removed (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L179\">PirexRewards.sol#L179</a>) by the owner, which creates the possibility of mismanagement:</p>\n<ol>\n<li>The owner can mistakenly remove one of the reward tokens hard coded in the <code>PirexGmx</code> contract;</li>\n<li>The owner can add reward tokens that are not supported by the <code>PirexGmx</code> contract.</li>\n</ol>\n<p>Such mismanagement can cause users to lose rewards for two reasons:</p>\n<ol>\n<li>Reward state of a user is updated <em>before</em> their rewards are claimed;</li>\n<li>It’s the reward token addresses set by the owner of the <code>PirexRewards</code> contract that are used to transfer rewards.</li>\n</ol>\n<p>In the <code>claim</code> function:</p>\n<ol>\n<li>\n<p><code>harvest</code> is called to pull rewards from GMX (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L377\">PirexRewards.sol#L377</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">harvest</span><span class=\"mtk1\">();</span></span></span></code></pre>\n</li>\n<li>\n<p><code>claimReward</code> is called on <code>PirexGmx</code> to pull rewards from GMX and get the hard coded lists of producer tokens, reward tokens, and amounts (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L346-L347\">PirexRewards.sol#L346-L347</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">(</span><span class=\"mtk12\">_producerTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">rewardAmounts</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">producer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">.</span><span class=\"mtk11\">claimRewards</span><span class=\"mtk1\">();</span></span></span></code></pre>\n</li>\n<li>\n<p>Rewards are recorded for each of the hard coded reward token (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L361\">PirexRewards.sol#L361</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">r</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">producerState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">]] += </span><span class=\"mtk12\">r</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n<li>\n<p>Later in the <code>claim</code> function, owner-set reward tokens are read (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L386-L387\">PirexRewards.sol#L386-L387</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">ERC20</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rLen</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span></code></pre>\n</li>\n<li>\n<p>User reward state is set to 0, which means they’ve claimed their entire share of rewards (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L391\">PirexRewards.sol#L391</a>), however this is done before a reward is actually claimed:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">userStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n</li>\n<li>\n<p>The owner-set reward tokens are iterated and the previously recorded rewards are distributed (<a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/03b71a8d395c02324cb9fdaf92401357da5b19d1/src/PirexRewards.sol#L396-L415\">PirexRewards.sol#L396-L415</a>):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">rLen</span><span class=\"mtk1\">; ++</span><span class=\"mtk12\">i</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardRecipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardRecipients</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">rewardRecipient</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ? </span><span class=\"mtk12\">rewardRecipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        : </span><span class=\"mtk12\">user</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">userRewards</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">globalRewards</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Update reward state (i.e. amount) to reflect reward tokens transferred out</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewardStates</span><span class=\"mtk1\">[</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">producer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimUserReward</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">recipient</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n</ol>\n<p>In the above loop, there can be multiple reasons for rewards to not be sent:</p>\n<ol>\n<li>One of the hard coded reward tokens is missing in the owner-set reward tokens list;</li>\n<li>The owner-set reward token list contains a token that’s not supported by <code>PirexGmx</code> (i.e. it’s not in the hard coded reward tokens list);</li>\n<li>The <code>rewardTokens</code> array of a producer token turns out to be empty due to mismanagement by the owner.</li>\n</ol>\n<p>In all of the above situations, rewards won’t be sent, however user’s reward state will still be set to 0.</p>\n<p>Also, notice that calling <code>claim</code> won’t revert if reward tokens are misconfigured, and the <code>Claim</code> event will be emitted successfully, which makes reward tokens mismanagement hard to detect.</p>\n<p>The amount of lost rewards can be different depending on how much GMX a user has staked and how often they claim rewards. Of course, if a mistake isn’t detected quickly, multiple users can suffer from this issue. The autocompounding contracts (<code>AutoPxGlp</code> and <code>AutoPxGmx</code>) are also users of the protocol, and since they’re intended to hold big amounts of real users’ deposits (they’ll probably be the biggest stakers), lost rewards can be big.</p>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider having one source of reward tokens. Since they’re already hard coded in the <code>PirexGmx</code> contract, consider exposing them so that <code>PirexRewards</code> could read them in the <code>claim</code> function. This change will also mean that the <code>addRewardToken</code> and <code>removeRewardToken</code> functions won’t be needed, which makes contract management simpler.</p>\n<p>Also, in the <code>claim</code> function, consider updating global and user reward states only after ensuring that at least one reward token was distributed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/271#issuecomment-1341319775\">drahrealm (Redacted Cartel) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>To make sure this won’t be an issue, we will add the <code>whenNotPaused</code> modifier to <code>claimUserReward</code> method in <code>PirexGmx</code>. Also, as <code>migrateRewards</code> is going to be updated to also set the <code>pirexRewards</code> address to 0, it will defer any call to claim the rewards</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/271#issuecomment-1365200941\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Seems to be the mitigation for <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/249\">#249</a>.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 60 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/156\">report highlighted below</a> by <strong>0xSmartContract</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/411\">brgltd</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/408\">Deivitto</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/405\">Awesome</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/402\">eierina</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/398\">jadezti</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/396\">0xNazgul</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/381\">adriro</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/369\">danyams</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/364\">delfin454000</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/360\">rotcivegaf</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/359\">sakshamguruji</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/354\">rbserver</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/353\">Waze</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/350\">Josiah</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/347\">hansfriese</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/330\">gz627</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/326\">oyc_109</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/316\">keccak123</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/315\">B2</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/313\">ch0bu</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/309\">0xbepresent</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/308\">cryptostellar5</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/304\">Diana</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/299\">Funen</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/295\">0xfuje</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/293\">pedr02b2</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/286\">nameruse</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/282\">deliriusz</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/277\">Jeiwan</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/251\">joestakey</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/234\">unforgiven</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/233\">xiaoming90</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/230\">shark</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/225\">erictee</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/218\">JohnSmith</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/216\">0xPanda</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/213\">btk</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/208\">0xAgro</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/175\">gzeon</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/168\">hihen</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/163\">carrotsmuggler</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/158\">R2</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/154\">subtle77</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/149\">codeislight</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/129\">simon135</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/120\">Rolezn</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/119\">aphak5010</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/116\">csanuragjain</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/107\">datapunk</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/93\">martin</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/88\">Sathish9098</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/87\">yixxas</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/75\">perseverancesuccess</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/73\">fatherOfBlocks</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/60\">rvierdiiev</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/53\">codexploder</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/43\">chaduke</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/23\">Bnke0x0</a>, and\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/3\">RaymondFam</a>\n.</em></p>\n<h2 id=\"low-risk-issues-summary\" style=\"position:relative;\"><a href=\"#low-risk-issues-summary\" aria-label=\"low risk issues summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Number</th>\n<th align=\"left\">Issues Details</th>\n<th align=\"center\">Context</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[L-01]</td>\n<td align=\"left\">PirexERC4626’s implmentation is not fully up to EIP-4626’s specification</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-02]</td>\n<td align=\"left\">initialize() function can be called by anybody</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-03]</td>\n<td align=\"left\">Solmate’s SafeTransferLib doesn’t check whether the ERC20 contract exists</td>\n<td align=\"center\">19</td>\n</tr>\n<tr>\n<td align=\"center\">[L-04]</td>\n<td align=\"left\">Use <code>Ownable2StepUpgradeable</code> instead of <code>OwnableUpgradeable</code> contract</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-05]</td>\n<td align=\"left\">Owner can renounce Ownership</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-06]</td>\n<td align=\"left\">Critical Address Changes Should Use Two-step Procedure</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td align=\"center\">[L-07]</td>\n<td align=\"left\"><code>DepositGlp</code> Event arguments names are confusing</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[L-08]</td>\n<td align=\"left\">Loss of precision due to rounding</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-09]</td>\n<td align=\"left\">First value check of argument of type enum in setFee function is missing</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-10]</td>\n<td align=\"left\">Hardcode the address causes no future updates</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-11]</td>\n<td align=\"left\">Lack of Input Validation</td>\n<td align=\"center\">6</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 11 issues</p>\n<h2 id=\"l-01-pirexerc4626s-implmentation-is-not-fully-up-to-eip-4626s-specification\" style=\"position:relative;\"><a href=\"#l-01-pirexerc4626s-implmentation-is-not-fully-up-to-eip-4626s-specification\" aria-label=\"l 01 pirexerc4626s implmentation is not fully up to eip 4626s specification permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] PirexERC4626’s implmentation is not fully up to EIP-4626’s specification</h2>\n<p>Must  return the maximum amount of shares mint would allow to be deposited to receiver and not cause a revert, which must not be higher than the actual maximum that would be accepted (it should underestimate if necessary). </p>\n<p>This assumes that the user has infinite assets, i.e. must not rely on <code>balanceOf</code> of asset.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">216</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">217</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">218</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">219</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">220</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">221</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">222</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">223</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>Could cause unexpected behavior in the future due to non-compliance with EIP-4626 standard.</p>\n<p>Similar problem for Sentimentxyz:\n<a href=\"https://github.com/sentimentxyz/protocol/pull/235/files\">https://github.com/sentimentxyz/protocol/pull/235/files</a></p>\n<h3 id=\"recommended-mitigation-steps-18\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-18\" aria-label=\"recommended mitigation steps 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>maxMint()</code> and <code>maxDeposit()</code> should reflect the limitation of maxSupply.</p>\n<p>Consider changing <code>maxMint()</code> and <code>maxDeposit()</code> to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">maxSupply</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxSupply</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">maxDeposit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">convertToAssets</span><span class=\"mtk1\">(</span><span class=\"mtk11\">maxMint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"l-02-initialize-function-can-be-called-by-anybody\" style=\"position:relative;\"><a href=\"#l-02-initialize-function-can-be-called-by-anybody\" aria-label=\"l 02 initialize function can be called by anybody permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] <code>initialize()</code> function can be called by anybody</h2>\n<p><code>initialize()</code> function can be called by anybody when the contract is not initialized.</p>\n<p>More importantly, if someone else runs this function, they will have full authority because of the <code>__Ownable_init()</code> function.</p>\n<p>Here is a definition of <code>initialize()</code> function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">84</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">85</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">86</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">__Ownable_init</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">87</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-19\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-19\" aria-label=\"recommended mitigation steps 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a control that makes <code>initialize()</code> only call the Deployer Contract or EOA;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">DEPLOYER_ADDRESS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotDeployer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<h2 id=\"l-03-solmates-safetransferlib-doesnt-check-whether-the-erc20-contract-exists\" style=\"position:relative;\"><a href=\"#l-03-solmates-safetransferlib-doesnt-check-whether-the-erc20-contract-exists\" aria-label=\"l 03 solmates safetransferlib doesnt check whether the erc20 contract exists permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Solmate’s SafeTransferLib doesn’t check whether the ERC20 contract exists</h2>\n<p>Solmate’s SafeTransferLib, which is often used to interact with non-compliant/unsafe ERC20 tokens, does not check whether the ERC20 contract exists. The following code will not revert in case the token doesn’t exist (yet).</p>\n<p>This is stated in the Solmate library:\n<a href=\"https://github.com/transmissions11/solmate/blob/main/src/utils/SafeTransferLib.sol#L9\">https://github.com/transmissions11/solmate/blob/main/src/utils/SafeTransferLib.sol#L9</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">19</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexFees</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">5</span><span class=\"mtk1\">: </span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;solmate/utils/SafeTransferLib.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">114</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">treasury</span><span class=\"mtk1\">, </span><span class=\"mtk12\">treasuryDistribution</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">115</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contributors</span><span class=\"mtk1\">, </span><span class=\"mtk12\">contributorsDistribution</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">7</span><span class=\"mtk1\">: </span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;solmate/utils/SafeTransferLib.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">392</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">506</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">643</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pxGlp</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">844</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">postFeeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">847</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">pirexFees</span><span class=\"mtk1\">), </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">946</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gmxBaseReward</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGlp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">6</span><span class=\"mtk1\">: </span><span class=\"mtk12\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">} </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;solmate/utils/SafeTransferLib.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">258</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pxGlpIncentive</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">259</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">260</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalPxGlpFee</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">pxGlpIncentive</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">274</span><span class=\"mtk1\">:                 </span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pxGmxIncentive</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">275</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">276</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalPxGmxFee</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">pxGmxIncentive</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">344</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">stakedGlp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">387</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">erc20Token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">388</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">7</span><span class=\"mtk1\">: </span><span class=\"mtk12\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">} </span><span class=\"mtk12\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;solmate/utils/SafeTransferLib.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">297</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">incentive</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">incentive</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">298</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">299</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">totalFee</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">incentive</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">336</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">361</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">382</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-20\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-20\" aria-label=\"recommended mitigation steps 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a contract exist control in functions;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">isContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isContract</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">isContract</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">.</span><span class=\"mtk12\">code</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"l-04-use-ownable2stepupgradeable-instead-of-ownableupgradeable-contract\" style=\"position:relative;\"><a href=\"#l-04-use-ownable2stepupgradeable-instead-of-ownableupgradeable-contract\" aria-label=\"l 04 use ownable2stepupgradeable instead of ownableupgradeable contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Use <code>Ownable2StepUpgradeable</code> instead of <code>OwnableUpgradeable</code> contract</h2>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/PirexRewards.sol#L4\">PirexRewards.sol#L4</a></p>\n<p><code>transferOwnership</code> function is used to change Ownership from <code>OwnableUpgradeable.sol</code>.</p>\n<p>There is another Openzeppelin Ownable contract (Ownable2StepUpgradeable.sol) has  <code>transferOwnership</code> function ,  use it is more secure due to 2-stage ownership transfer.</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/master/contracts/access/Ownable2StepUpgradeable.sol\">Ownable2StepUpgradeable.sol</a></p>\n<h2 id=\"l-05-owner-can-renounce-ownership\" style=\"position:relative;\"><a href=\"#l-05-owner-can-renounce-ownership\" aria-label=\"l 05 owner can renounce ownership permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Owner can renounce Ownership</h2>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/PirexRewards.sol#L4\">PirexRewards.sol#L4</a></p>\n<p>Typically, the contract’s owner is the account that deploys the contract. As a result, the owner is able to perform certain privileged activities.</p>\n<p>The Openzeppelin’s Ownable used in this project contract implements renounceOwnership. This can represent a certain risk if the ownership is renounced for any other reason than by design. Renouncing ownership will leave the contract without an owner, thereby removing any functionality that is only available to the owner.</p>\n<p><code>onlyOwner</code> functions;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">93</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setProducer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_producer</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">151</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">addRewardToken</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardToken</span><span class=\"mtk1\">)  </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-21\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-21\" aria-label=\"recommended mitigation steps 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We recommend to either reimplement the function to disable it or to clearly specify if it is part of the contract design.</p>\n<h2 id=\"l-06-critical-address-changes-should-use-two-step-procedure\" style=\"position:relative;\"><a href=\"#l-06-critical-address-changes-should-use-two-step-procedure\" aria-label=\"l 06 critical address changes should use two step procedure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Critical Address Changes Should Use Two-step Procedure</h2>\n<p>The critical procedures should be a two-step process.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexFees</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">63</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFeeRecipient</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FeeRecipient</span><span class=\"mtk1\"> </span><span class=\"mtk12\">f</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">src</span><span class=\"mtk1\">/</span><span class=\"mtk11\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  313:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Contracts</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractAddress</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  884:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setVoteDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteDelegate</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">external</span><span class=\"mtk1\">/</span><span class=\"mtk12\">DelegateRegistry</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-22\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-22\" aria-label=\"recommended mitigation steps 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Lack of two-step procedure for critical operations leaves them error-prone. Consider adding two step procedure on the critical functions.</p>\n<h2 id=\"l-07-depositglp-event-arguments-names-are-confusing\" style=\"position:relative;\"><a href=\"#l-07-depositglp-event-arguments-names-are-confusing\" aria-label=\"l 07 depositglp event arguments names are confusing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] <code>DepositGlp</code> Event arguments names are confusing</h2>\n<p>The <code>uint256 amount</code> argument of the <code>depositFsGlp</code> function in the PirexGmx.sol contract is named <code>deposited</code> in the <code>event DepositGlp</code> parameter. In <code>emit DepositGlp</code> this causes confusion in terms of user, code readability and web pages.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">421</span><span class=\"mtk1\">       */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">422</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">depositFsGlp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  423:         </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  424:         </span><span class=\"mtk11\">whenNotPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  425:         </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  426:         </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  427:             </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  428:             </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  429:             </span><span class=\"mtk10\">uint256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">430</span><span class=\"mtk1\">:         )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> 452:         </span><span class=\"mtk11\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">DepositGlp</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  453:             </span><span class=\"mtk10\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk10\">sender</span><span class=\"mtk1\">,          \t</span><span class=\"mtk3\">// caller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  454:             </span><span class=\"mtk10\">receiver</span><span class=\"mtk1\">,          \t\t</span><span class=\"mtk3\">// receiver</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  455:             </span><span class=\"mtk10\">address</span><span class=\"mtk1\">(</span><span class=\"mtk10\">stakedGlp</span><span class=\"mtk1\">),  \t</span><span class=\"mtk3\">// token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  456:             </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,                   \t\t</span><span class=\"mtk3\">// tokenAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  457:             </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,                  \t\t </span><span class=\"mtk3\">// minUsdg</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  458:             </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,                   \t\t</span><span class=\"mtk3\">// minGlp</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  459:             </span><span class=\"mtk10\">amount</span><span class=\"mtk1\">,          \t\t </span><span class=\"mtk3\">// deposited</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  460:             </span><span class=\"mtk10\">postFeeAmount</span><span class=\"mtk1\">,      \t </span><span class=\"mtk3\">// postFeeAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  461:             </span><span class=\"mtk10\">feeAmount</span><span class=\"mtk1\">          \t </span><span class=\"mtk3\">// feeAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">462</span><span class=\"mtk1\">:         );</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-23\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-23\" aria-label=\"recommended mitigation steps 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Event-Emit parameter names must match the function arguments or the argument they take value from.</p>\n<h2 id=\"l-08-loss-of-precision-due-to-rounding\" style=\"position:relative;\"><a href=\"#l-08-loss-of-precision-due-to-rounding\" aria-label=\"l 08 loss of precision due to rounding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] Loss of precision due to rounding</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">221</span><span class=\"mtk1\">      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">222</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">f</span><span class=\"mtk1\">]) / </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">223</span><span class=\"mtk1\">          </span><span class=\"mtk12\">postFeeAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">assets</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\">;;</span></span></span></code></pre>\n<h2 id=\"l-09-first-value-check-of-argument-of-type-enum-in-setfee-function-is-missing\" style=\"position:relative;\"><a href=\"#l-09-first-value-check-of-argument-of-type-enum-in-setfee-function-is-missing\" aria-label=\"l 09 first value check of argument of type enum in setfee function is missing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] First value check of argument of type enum in setFee function is missing</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">298</span><span class=\"mtk1\">          @</span><span class=\"mtk12\">param</span><span class=\"mtk1\">  </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">  </span><span class=\"mtk12\">Fee</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">299</span><span class=\"mtk1\">:      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">300</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Fees</span><span class=\"mtk1\"> </span><span class=\"mtk12\">f</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">301</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">FEE_MAX</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidFee</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">302</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">303</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">f</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">304</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">305</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">SetFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">f</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">306</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>Leaving the enum type argument <code>Fees</code> in the setFee function empty and returning the value <code>0</code> gives the same result as returning the value <code>0</code>, this is a property of the enum type and therefore error-prone.</p>\n<h3 id=\"recommended-mitigation-steps-24\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-24\" aria-label=\"recommended mitigation steps 24 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use struck instead of enum.</p>\n<h2 id=\"l-10-hardcode-the-address-causes-no-future-updates\" style=\"position:relative;\"><a href=\"#l-10-hardcode-the-address-causes-no-future-updates\" aria-label=\"l 10 hardcode the address causes no future updates permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-10] Hardcode the address causes no future updates</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">      </span><span class=\"mtk12\">IV3SwapRouter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SWAP_ROUTER</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">19</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">IV3SwapRouter</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Router etc. In case the addresses change due to reasons such as updating their versions in the future, addresses coded as constants cannot be updated, so it is recommended to add the update option with the onlyOwner modifier.</p>\n<h2 id=\"l-11-lack-of-input-validation\" style=\"position:relative;\"><a href=\"#l-11-lack-of-input-validation\" aria-label=\"l 11 lack of input validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-11] Lack of Input Validation</h2>\n<p>For defence-in-depth purpose, it is recommended to perform additional validation against the amount that the user is attempting to deposit, mint, withdraw and redeem to ensure that the submitted amount is valid.</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/7c75b8aa89073376fb67d78a40f6d69331092c94/contracts/token/ERC20/extensions/ERC20TokenizedVault.sol#L95\">OpenZeppelinTokenizedVault.sol#L9</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">src/PirexGmx.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  429       */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  430:     function depositGmx(uint256 amount, address receiver)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  431:         external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  432:         whenNotPaused</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  433:         nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  434:         returns (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  435:             uint256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  436:             uint256,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  437:             uint256</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  438:         )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  439:     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+\t         require(amount &lt;= maxDeposit(receiver), &quot;deposit more than max&quot;);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">src/vaults/PirexERC4626.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  79  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  80:     function mint(uint256 shares, address receiver)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  81:         public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  82:         virtual</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  83:         returns (uint256 assets)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  84:     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ \t       require(shares &lt;= maxMint(receiver), &quot;mint more than max&quot;);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">src/vaults/AutoPxGlp.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  438:     function withdraw(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  439:         uint256 assets,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  440:         address receiver,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  441:         address owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  442:     ) public override returns (uint256 shares) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                require(assets &lt;= maxWithdraw(owner), &quot;withdraw more than max&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">src/vaults/AutoPxGmx.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  317:     function withdraw(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  318:         uint256 assets,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  319:         address receiver,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  320:         address owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  321:     ) public override returns (uint256 shares) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               require(assets &lt;= maxWithdraw(owner), &quot;withdraw more than max&quot;);</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"85\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">src/vaults/AutoPxGlp.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  450       */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  451:     function redeem(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  452:         uint256 shares,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  453:         address receiver,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  454:         address owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  455:     ) public override returns (uint256 assets) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               require(shares &lt;= maxRedeem(owner), &quot;redeem more than max&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">src/vaults/AutoPxGmx.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  340  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  341:     function redeem(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  342:         uint256 shares,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  343:         address receiver,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  344:         address owner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  345:     ) public override returns (uint256 assets) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                require(shares &lt;= maxRedeem(owner), &quot;redeem more than max&quot;);</span></span></span></code></pre>\n<h2 id=\"non-critical-issues-summary\" style=\"position:relative;\"><a href=\"#non-critical-issues-summary\" aria-label=\"non critical issues summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Issues Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Number</th>\n<th align=\"left\">Issues Details</th>\n<th align=\"center\">Context</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[N-01]</td>\n<td align=\"left\">Insufficient coverage</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-02]</td>\n<td align=\"left\">Not using the named return variables anywhere in the function is confusing</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-03]</td>\n<td align=\"left\">Same Constant redefined elsewhere</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td align=\"center\">[N-04]</td>\n<td align=\"left\">Omissions in Events</td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td align=\"center\">[N-05]</td>\n<td align=\"left\">Add parameter to Event-Emit</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-06]</td>\n<td align=\"left\">NatSpec is missing</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-07]</td>\n<td align=\"left\">Use <code>require</code> instead of <code>assert</code></td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-08]</td>\n<td align=\"left\">Implement some type of version counter that will be incremented automatically for contract upgrades</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-09]</td>\n<td align=\"left\">Constant values such as a call to keccak256(), should used to immutable rather than constant</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[N-10]</td>\n<td align=\"left\">For functions, follow Solidity standard naming conventions</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td align=\"center\">[N-11]</td>\n<td align=\"left\">Mark visibility of initialize(…) functions as <code>external</code></td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-12]</td>\n<td align=\"left\">No same value input control</td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td align=\"center\">[N-13]</td>\n<td align=\"left\">Include <code>return parameters</code> in <em>NatSpec comments</em></td>\n<td align=\"center\">All</td>\n</tr>\n<tr>\n<td align=\"center\">[N-14]</td>\n<td align=\"left\"><code>0 address</code> check for <code>asset</code></td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-15]</td>\n<td align=\"left\">Use a single file for all system-wide constants</td>\n<td align=\"center\">6</td>\n</tr>\n<tr>\n<td align=\"center\">[N-16]</td>\n<td align=\"left\"><code>Function writing</code> that does not comply with the <code>Solidity Style Guide</code></td>\n<td align=\"center\">All</td>\n</tr>\n<tr>\n<td align=\"center\">[N-17]</td>\n<td align=\"left\">Missing Upgrade Path for <code>PirexRewards</code> Implementation</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-18]</td>\n<td align=\"left\">No need <code>assert</code> check in <code>_computeAssetAmounts()</code></td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-19]</td>\n<td align=\"left\">Lack of event emission after critical <code>initialize()</code> functions</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-20]</td>\n<td align=\"left\">Add a timelock to critical functions</td>\n<td align=\"center\">11</td>\n</tr>\n</tbody>\n</table>\n<p>Total 19 issues</p>\n<h2 id=\"n-01-insufficient-coverage\" style=\"position:relative;\"><a href=\"#n-01-insufficient-coverage\" aria-label=\"n 01 insufficient coverage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Insufficient coverage</h2>\n<p>Testing all functions is best practice in terms of security criteria.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"86\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">File</span><span class=\"mtk1\">                              | % </span><span class=\"mtk12\">Lines</span><span class=\"mtk1\">           | % </span><span class=\"mtk12\">Statements</span><span class=\"mtk1\">      | % </span><span class=\"mtk12\">Branches</span><span class=\"mtk1\">       | % </span><span class=\"mtk12\">Funcs</span><span class=\"mtk1\">         |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">|-----------------------------------|-------------------|-------------------|------------------|-----------------|</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">              | </span><span class=\"mtk7\">98.98</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">97</span><span class=\"mtk1\">/</span><span class=\"mtk7\">98</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">99.24</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">131</span><span class=\"mtk1\">/</span><span class=\"mtk7\">132</span><span class=\"mtk1\">)  | </span><span class=\"mtk7\">94.44</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">51</span><span class=\"mtk1\">/</span><span class=\"mtk7\">54</span><span class=\"mtk1\">)   | </span><span class=\"mtk7\">94.12</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">16</span><span class=\"mtk1\">/</span><span class=\"mtk7\">17</span><span class=\"mtk1\">)  |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">                     | </span><span class=\"mtk7\">100.00</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">0</span><span class=\"mtk1\">/</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)     | </span><span class=\"mtk7\">100.00</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">0</span><span class=\"mtk1\">/</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)     | </span><span class=\"mtk7\">100.00</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">0</span><span class=\"mtk1\">/</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">0.00</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">0</span><span class=\"mtk1\">/</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)     |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGlp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">          | </span><span class=\"mtk7\">91.11</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">82</span><span class=\"mtk1\">/</span><span class=\"mtk7\">90</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">93.39</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">113</span><span class=\"mtk1\">/</span><span class=\"mtk7\">121</span><span class=\"mtk1\">)  | </span><span class=\"mtk7\">87.04</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">47</span><span class=\"mtk1\">/</span><span class=\"mtk7\">54</span><span class=\"mtk1\">)   | </span><span class=\"mtk7\">94.44</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">17</span><span class=\"mtk1\">/</span><span class=\"mtk7\">18</span><span class=\"mtk1\">)  |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">          | </span><span class=\"mtk7\">89.39</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">59</span><span class=\"mtk1\">/</span><span class=\"mtk7\">66</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">91.46</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">75</span><span class=\"mtk1\">/</span><span class=\"mtk7\">82</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">71.05</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">27</span><span class=\"mtk1\">/</span><span class=\"mtk7\">38</span><span class=\"mtk1\">)   | </span><span class=\"mtk7\">92.31</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">12</span><span class=\"mtk1\">/</span><span class=\"mtk7\">13</span><span class=\"mtk1\">)  |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">       | </span><span class=\"mtk7\">75.00</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">39</span><span class=\"mtk1\">/</span><span class=\"mtk7\">52</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">76.79</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">43</span><span class=\"mtk1\">/</span><span class=\"mtk7\">56</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">37.50</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">6</span><span class=\"mtk1\">/</span><span class=\"mtk7\">16</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">47.62</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">10</span><span class=\"mtk1\">/</span><span class=\"mtk7\">21</span><span class=\"mtk1\">)  |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PxGmxReward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">        | </span><span class=\"mtk7\">78.12</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">25</span><span class=\"mtk1\">/</span><span class=\"mtk7\">32</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">79.49</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">31</span><span class=\"mtk1\">/</span><span class=\"mtk7\">39</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">50.00</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">5</span><span class=\"mtk1\">/</span><span class=\"mtk7\">10</span><span class=\"mtk1\">)    | </span><span class=\"mtk7\">75.00</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">3</span><span class=\"mtk1\">/</span><span class=\"mtk7\">4</span><span class=\"mtk1\">)    |</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">| </span><span class=\"mtk12\">Total</span><span class=\"mtk1\">                             | </span><span class=\"mtk7\">56.72</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">523</span><span class=\"mtk1\">/</span><span class=\"mtk7\">922</span><span class=\"mtk1\">)  | </span><span class=\"mtk7\">58.93</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">660</span><span class=\"mtk1\">/</span><span class=\"mtk7\">1120</span><span class=\"mtk1\">) | </span><span class=\"mtk7\">59.95</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">241</span><span class=\"mtk1\">/</span><span class=\"mtk7\">402</span><span class=\"mtk1\">) | </span><span class=\"mtk7\">47.87</span><span class=\"mtk1\">% (</span><span class=\"mtk7\">90</span><span class=\"mtk1\">/</span><span class=\"mtk7\">188</span><span class=\"mtk1\">) |</span></span></span></code></pre>\n<p>Due to its capacity, test coverage is expected to be 100%.</p>\n<h2 id=\"n-02-not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\" style=\"position:relative;\"><a href=\"#n-02-not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\" aria-label=\"n 02 not using the named return variables anywhere in the function is confusing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Not using the named return variables anywhere in the function is confusing</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"87\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getUserState</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastBalance</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewards</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">UserState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userState</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">producerTokens</span><span class=\"mtk1\">[</span><span class=\"mtk12\">producerToken</span><span class=\"mtk1\">].</span><span class=\"mtk12\">userStates</span><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">user</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">userState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastUpdate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">userState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lastBalance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">userState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">rewards</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-25\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-25\" aria-label=\"recommended mitigation steps 25 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adopting a consistent approach to return values throughout the codebase by removing all named return variables, explicitly declaring them as local variables, and adding the necessary return statements where appropriate. This would improve both the explicitness and readability of the code, and it may also help reduce regressions during future code refactors.</p>\n<h2 id=\"n-03-same-constant-redefined-elsewhere\" style=\"position:relative;\"><a href=\"#n-03-same-constant-redefined-elsewhere\" aria-label=\"n 03 same constant redefined elsewhere permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Same Constant redefined elsewhere</h2>\n<p>Keeping the same constants in different files may cause some problems or errors, reading constants from a single file is preferable. This should also be preferred in gas optimization</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"88\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGlp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">17</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_WITHDRAWAL_PENALTY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">500</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">19</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_PLATFORM_FEE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">20</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">21</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_COMPOUND_INCENTIVE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">20</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_WITHDRAWAL_PENALTY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">500</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">21</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_PLATFORM_FEE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">22</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">23</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_COMPOUND_INCENTIVE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"n-04-omissions-in-events\" style=\"position:relative;\"><a href=\"#n-04-omissions-in-events\" aria-label=\"n 04 omissions in events permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Omissions in Events</h2>\n<p>Throughout the codebase, events are generally emitted when sensitive changes are made to the contracts. </p>\n<p>However, some events are missing important parameters.\nThe events should include the new value and old value where possible:</p>\n<p>Events with no old value;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"89\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexFees</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">63</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFeeRecipient</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FeeRecipient</span><span class=\"mtk1\"> </span><span class=\"mtk12\">f</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  83:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setTreasuryFeePercent</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_treasuryFeePercent</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">src</span><span class=\"mtk1\">/</span><span class=\"mtk11\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  300:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Fees</span><span class=\"mtk1\"> </span><span class=\"mtk12\">f</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">301</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">FEE_MAX</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidFee</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">313</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Contracts</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractAddress</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  862:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setDelegationSpace</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  863          </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegationSpace</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  884:     </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">setVoteDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">voteDelegate</span><span class=\"mtk1\">) </span><span class=\"mtk10\">external</span><span class=\"mtk1\"> </span><span class=\"mtk10\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">885</span><span class=\"mtk1\">          </span><span class=\"mtk11\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">voteDelegate</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">address</span><span class=\"mtk1\">(0)) revert </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">909</span><span class=\"mtk1\">:     </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">setPauseState</span><span class=\"mtk1\">(</span><span class=\"mtk10\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk10\">state</span><span class=\"mtk1\">) </span><span class=\"mtk10\">external</span><span class=\"mtk1\"> </span><span class=\"mtk10\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">910</span><span class=\"mtk1\">          </span><span class=\"mtk11\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">state</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">93</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setProducer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_producer</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">94</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_producer</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<h2 id=\"n-05-add-parameter-to-event-emit\" style=\"position:relative;\"><a href=\"#n-05-add-parameter-to-event-emit\" aria-label=\"n 05 add parameter to event emit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Add parameter to Event-Emit</h2>\n<p>Some event-emit description has no parameter. Add to parameter for front-end website or client app, they can see that something has happened on the blockchain.</p>\n<p>Events with no old value;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"90\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">894</span><span class=\"mtk1\">       */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">895</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">clearVoteDelegate</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">896</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ClearVoteDelegate</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<h2 id=\"n-06-natspec-is-missing\" style=\"position:relative;\"><a href=\"#n-06-natspec-is-missing\" aria-label=\"n 06 natspec is missing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] NatSpec is missing</h2>\n<p>NatSpec is missing for the following functions, constructor and modifier:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"91\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PxGmxReward</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">15</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pxGmx</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">17</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">GlobalState</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">globalState</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardState</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">19</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">UserState</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userRewardStates</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"n-07-use-require-instead-of-assert\" style=\"position:relative;\"><a href=\"#n-07-use-require-instead-of-assert\" aria-label=\"n 07 use require instead of assert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Use <code>require</code> instead of <code>assert</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"92\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">224</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">225</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">assert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">feeAmount</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">postFeeAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">assets</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">226</span><span class=\"mtk1\">      }</span></span></span></code></pre>\n<p>Assert should not be used except for tests, <code>require</code> should be used</p>\n<p>Prior to Solidity 0.8.0, pressing a confirm consumes the remainder of the process’s available gas instead of returning it, as request()/revert() did.</p>\n<p><code>assert()</code> and <code>reqire();</code></p>\n<p>The big difference between the two is that the <code>assert()</code>function when false, uses up all the remaining gas and reverts all the changes made.</p>\n<p>Meanwhile, a  <code>require()</code> function when false, also reverts back all the changes made to the contract but does refund all the remaining gas fees we offered to pay.This is the most common Solidity function used by developers for debugging and error handling.</p>\n<p><code>Assertion()</code> should be avoided even after solidity version 0.8.0, because its documentation states “The Assert function generates an error of type Panic(uint256). Code that works properly should never Panic, even on invalid external input. If this happens, you need to fix it in your contract. there’s a mistake”.</p>\n<h2 id=\"n-08-implement-some-type-of-version-counter-that-will-be-incremented-automatically-for-contract-upgrades\" style=\"position:relative;\"><a href=\"#n-08-implement-some-type-of-version-counter-that-will-be-incremented-automatically-for-contract-upgrades\" aria-label=\"n 08 implement some type of version counter that will be incremented automatically for contract upgrades permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-08] Implement some type of version counter that will be incremented automatically for contract upgrades</h2>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/PirexRewards.sol#L85\">PirexRewards.sol#L85</a></p>\n<p>I suggest implementing some kind of version counter that will be incremented automatically when you upgrade the contract.</p>\n<h3 id=\"recommended-mitigation-steps-26\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-26\" aria-label=\"recommended mitigation steps 26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"93\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">authorizeUpgradeCounter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">upgradeTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_newImplementation</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_setPendingImplementation</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_newImplementation</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       </span><span class=\"mtk12\">authorizeUpgradeCounter</span><span class=\"mtk1\">+=</span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"n-09-constant-values-such-as-a-call-to-keccak256-should-used-to-immutable-rather-than-constant\" style=\"position:relative;\"><a href=\"#n-09-constant-values-such-as-a-call-to-keccak256-should-used-to-immutable-rather-than-constant\" aria-label=\"n 09 constant values such as a call to keccak256 should used to immutable rather than constant permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-09] Constant values such as a call to <code>keccak256()</code>, should used to immutable rather than constant</h2>\n<p>There is a difference between constant variables and immutable variables, and they should each be used in their appropriate contexts.</p>\n<p>While it doesn’t save any gas because the compiler knows that developers often make this mistake, it’s still best to use the right tool for the task at hand.</p>\n<p>Constants should be used for literal values written into the code, and immutable variables should be used for expressions, or values calculated in, or passed into the constructor.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"94\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PxERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">9</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MINTER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">10</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BURNER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;BURNER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"n-10-for-functions-follow-solidity-standard-naming-conventions\" style=\"position:relative;\"><a href=\"#n-10-for-functions-follow-solidity-standard-naming-conventions\" aria-label=\"n 10 for functions follow solidity standard naming conventions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-10] For functions, follow Solidity standard naming conventions</h2>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/vaults/AutoPxGlp.sol#L487\">AutoPxGlp.sol#L487</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/vaults/AutoPxGlp.sol#L501\">AutoPxGlp.sol#L501</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/vaults/AutoPxGlp.sol#L474\">AutoPxGlp.sol#L474</a></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-redactedcartel/blob/main/src/vaults/AutoPxGlp.sol#L462\">AutoPxGlp.sol#L462</a></p>\n<p>The above codes don’t follow Solidity’s standard naming convention:</p>\n<p>internal and private functions: the mixedCase format starting with an underscore (_mixedCase starting with an underscore)</p>\n<h2 id=\"n-11-mark-visibility-of-initialize-functions-as-external\" style=\"position:relative;\"><a href=\"#n-11-mark-visibility-of-initialize-functions-as-external\" aria-label=\"n 11 mark visibility of initialize functions as external permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-11] Mark visibility of initialize(…) functions as <code>external</code></h2>\n<p><a href=\"https://github.com/code-423n4/2022-10-thegraph/blob/main/contracts/gateway/L1GraphTokenGateway.sol#L99\">L1GraphTokenGateway.sol#L99</a></p>\n<p>If someone wants to extend via inheritance, it might make more sense that the overridden initialize(…) function calls the internal {…}_init function, not the parent public initialize(…) function.</p>\n<p>External instead of public would give more the sense of the initialize(…) functions to behave like a constructor (only called on deployment, so should only be called externally)</p>\n<p>From a security point of view, it might be safer so that it cannot be called internally by accident in the child contract.</p>\n<p>It might cost a bit less gas to use external over public.</p>\n<p>It is possible to override a function from external to public (= “opening it up”) ✅</p>\n<p>But it is not possible to override a function from public to external (= “narrow it down”). ❌</p>\n<p>For above reasons you can change initialize(…) to external</p>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3750\">https://github.com/OpenZeppelin/openzeppelin-contracts/issues/3750</a></p>\n<h2 id=\"n-12-no-same-value-input-control\" style=\"position:relative;\"><a href=\"#n-12-no-same-value-input-control\" aria-label=\"n 12 no same value input control permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-12] No same value input control</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"95\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexFees</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">63</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFeeRecipient</span><span class=\"mtk1\">(</span><span class=\"mtk12\">FeeRecipient</span><span class=\"mtk1\"> </span><span class=\"mtk12\">f</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  83:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setTreasuryFeePercent</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_treasuryFeePercent</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">src</span><span class=\"mtk1\">/</span><span class=\"mtk11\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  313:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Contracts</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractAddress</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  884:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setVoteDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">voteDelegate</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">909</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPauseState</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">state</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">93</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setProducer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_producer</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">107</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setRewardRecipient</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  432:     </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">setRewardRecipientPrivileged</span><span class=\"mtk1\">(</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-27\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-27\" aria-label=\"recommended mitigation steps 27 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add code like this;\n<code>if (oracle == _oracle revert ADDRESS_SAME();</code></p>\n<h2 id=\"n-13-include-return-parameters-in-natspec-comments\" style=\"position:relative;\"><a href=\"#n-13-include-return-parameters-in-natspec-comments\" aria-label=\"n 13 include return parameters in natspec comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-13] Include <code>return parameters</code> in <em>NatSpec comments</em></h2>\n<p>It is recommended that Solidity contracts are fully annotated using NatSpec for all public interfaces (everything in the ABI). It is clearly stated in the Solidity official documentation. In complex projects such as Defi, the interpretation of all functions and their arguments and returns is important for code readability and auditability.</p>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.15/natspec-format.html\">https://docs.soliditylang.org/en/v0.8.15/natspec-format.html</a></p>\n<p>If Return parameters are declared, you must prefix them with ”/// @return”.</p>\n<p>Some code analysis programs do analysis by reading NatSpec details, if they can’t see the “@return” tag, they do incomplete analysis.</p>\n<h3 id=\"recommended-mitigation-steps-28\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-28\" aria-label=\"recommended mitigation steps 28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Include return parameters in NatSpec comments</p>\n<p>Recommendation Code Style:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"96\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">/// @notice information about what a function does</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">/// @param pageId The id of the page to get the URI for.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk3\">/// @return Returns a page&#39;s URI if it has been minted </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pageId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pageId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">pageId</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">currentId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;NOT_MINTED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">string</span><span class=\"mtk1\">.</span><span class=\"mtk11\">concat</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BASE_URI</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pageId</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span></code></pre>\n<h2 id=\"n-14-0-address-check-for-asset\" style=\"position:relative;\"><a href=\"#n-14-0-address-check-for-asset\" aria-label=\"n 14 0 address check for asset permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-14] <code>0 address</code> check for <code>asset</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"97\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexERC4626</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">47</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">48</span><span class=\"mtk1\">:     </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">49</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">50</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">51</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_symbol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">52</span><span class=\"mtk1\">:     ) </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">()) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">53</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">asset</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_asset</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">54</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>Also check of the address to protect the code from 0x0 address  problem just in case. This is best practice or instead of suggesting that they verify address != 0x0, you could add some good NatSpec comments explaining what is valid and what is invalid and what are the implications of accidentally using an invalid address.</p>\n<h3 id=\"recommended-mitigation-steps-29\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-29\" aria-label=\"recommended mitigation steps 29 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>like this;\n<code>if (_asset == address(0)) revert ADDRESS_ZERO();</code></p>\n<h2 id=\"n-15-use-a-single-file-for-all-system-wide-constants\" style=\"position:relative;\"><a href=\"#n-15-use-a-single-file-for-all-system-wide-constants\" aria-label=\"n 15 use a single file for all system wide constants permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-15] Use a single file for all system-wide constants</h2>\n<p>There are many addresses and constants used in the system. It is recommended to put the most used ones in one file (for example constants.sol, use inheritance to access these values)</p>\n<p>  This will help with readability and easier maintenance for future changes. This also helps with any issues, as some of these hard-coded values are admin addresses.</p>\n<p>constants.left</p>\n<p>Use and import this file in contracts that require access to these values. This is just a suggestion, in some use cases this may result in higher gas usage in the distribution.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"98\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">21</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">6</span><span class=\"mtk1\"> </span><span class=\"mtk12\">files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexFees</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">20</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_PERCENT_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">23</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_TREASURY_FEE_PERCENT</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">75</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">44</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1_000_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">47</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_MAX</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">200_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PxERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">9</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MINTER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;MINTER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">10</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BURNER_ROLE</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;BURNER_ROLE&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">external</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RewardTracker</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">772</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BASIS_POINTS_DIVISOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">773</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PRECISION</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e30</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">775</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint8</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGlp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_WITHDRAWAL_PENALTY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">500</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">19</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_PLATFORM_FEE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">20</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">21</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_COMPOUND_INCENTIVE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">22</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">EXPANDED_DECIMALS</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e30</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">23</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">IV3SwapRouter</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SWAP_ROUTER</span><span class=\"mtk1\"> =</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">20</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_WITHDRAWAL_PENALTY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">500</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">21</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_PLATFORM_FEE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">22</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">23</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_COMPOUND_INCENTIVE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5000</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"nc-16-function-writing-that-does-not-comply-with-the-solidity-style-guide\" style=\"position:relative;\"><a href=\"#nc-16-function-writing-that-does-not-comply-with-the-solidity-style-guide\" aria-label=\"nc 16 function writing that does not comply with the solidity style guide permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[NC-16] <code>Function writing</code> that does not comply with the <code>Solidity Style Guide</code></h2>\n<p>Order of Functions; ordering helps readers identify which functions they can call and to find the constructor and fallback definitions easier. But there are contracts in the project that do not comply with this.</p>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.17/style-guide.html\">https://docs.soliditylang.org/en/v0.8.17/style-guide.html</a></p>\n<p>Functions should be grouped according to their visibility and ordered:</p>\n<p> constructor</p>\n<p>receive function (if exists)</p>\n<p>fallback function (if exists)</p>\n<p>external</p>\n<p>public</p>\n<p>internal</p>\n<p>private</p>\n<p>within a grouping, place the view and pure functions last.</p>\n<h2 id=\"n-17-missing-upgrade-path-for-pirexrewards-implementation\" style=\"position:relative;\"><a href=\"#n-17-missing-upgrade-path-for-pirexrewards-implementation\" aria-label=\"n 17 missing upgrade path for pirexrewards implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-17] Missing Upgrade Path for <code>PirexRewards</code> Implementation</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"99\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">4</span><span class=\"mtk1\">: </span><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">OwnableUpgradeable</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;openzeppelin-contracts-upgradeable/contracts/access/OwnableUpgradeable.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">85</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p>With the current and contracts, it is not possible to upgrade the contract. </p>\n<h3 id=\"recommended-mitigation-steps-30\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-30\" aria-label=\"recommended mitigation steps 30 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Document the operational plan for contract upgrades. Also, consider using the UUPS proxy pattern to upgrade contract implementation.</p>\n<h2 id=\"n-18-no-need-assert-check-in-_computeassetamounts\" style=\"position:relative;\"><a href=\"#n-18-no-need-assert-check-in-_computeassetamounts\" aria-label=\"n 18 no need assert check in _computeassetamounts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-18] No need <code>assert</code> check in <code>_computeAssetAmounts()</code></h2>\n<p>The <code>assert</code> check in this function is not needed. Because this check will always be true because of this line:\n<code>postFeeAmount = assets - feeAmount;</code></p>\n<p><strong>Context:</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"100\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">src/PirexGmx.sol:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  216       */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  217:     function _computeAssetAmounts(Fees f, uint256 assets)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  218:         internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  219:         view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  220:         returns (uint256 postFeeAmount, uint256 feeAmount)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  221:     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  222: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  223: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  224:         feeAmount = (assets * fees[f]) / FEE_DENOMINATOR;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  225:         postFeeAmount = assets - feeAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  226: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- 227:       assert(feeAmount + postFeeAmount == assets);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  228:     }</span></span></span></code></pre>\n<h2 id=\"n-19-lack-of-event-emission-after-critical-initialize-functions\" style=\"position:relative;\"><a href=\"#n-19-lack-of-event-emission-after-critical-initialize-functions\" aria-label=\"n 19 lack of event emission after critical initialize functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-19] Lack of event emission after critical <code>initialize()</code> functions</h2>\n<p>To record the init parameters for off-chain monitoring and transparency reasons, please consider emitting an event after the <code>initialize()</code> functions:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"101\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexRewards</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">84</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">85</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">86</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">__Ownable_init</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">87</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h2 id=\"n-20-add-a-timelock-to-critical-functions\" style=\"position:relative;\"><a href=\"#n-20-add-a-timelock-to-critical-functions\" aria-label=\"n 20 add a timelock to critical functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-20] Add a timelock to critical functions</h2>\n<p>It is a good practice to give time for users to react and adjust to critical changes. A timelock provides more guarantees and reduces the level of trust required, thus decreasing risk for users. It also indicates that the project is legitimate (less risk of a malicious owner making a sandwich attack on a user).</p>\n<p>Consider adding a timelock to:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"102\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">11</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">PirexGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">351</span><span class=\"mtk1\">       */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">352</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Fees</span><span class=\"mtk1\"> </span><span class=\"mtk12\">f</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">353</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">FEE_MAX</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidFee</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">364</span><span class=\"mtk1\">       */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">365</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Contracts</span><span class=\"mtk1\"> </span><span class=\"mtk12\">c</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractAddress</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  366          </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  918       </span><span class=\"mtk4\">*</span><span class=\"mtk1\">/</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  919:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setDelegationSpace</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  920          </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegationSpace</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  940       */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  941:     </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">setVoteDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">voteDelegate</span><span class=\"mtk1\">) </span><span class=\"mtk10\">external</span><span class=\"mtk1\"> </span><span class=\"mtk10\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">942</span><span class=\"mtk1\">          </span><span class=\"mtk11\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">voteDelegate</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">address</span><span class=\"mtk1\">(0)) revert </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">965</span><span class=\"mtk1\">      */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">966</span><span class=\"mtk1\">:     </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk10\">setPauseState</span><span class=\"mtk1\">(</span><span class=\"mtk10\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk10\">state</span><span class=\"mtk1\">) </span><span class=\"mtk10\">external</span><span class=\"mtk1\"> </span><span class=\"mtk10\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">967</span><span class=\"mtk1\">          </span><span class=\"mtk11\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">state</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGlp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">94</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setWithdrawalPenalty</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk7\">95</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">penalty</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_WITHDRAWAL_PENALTY</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExceedsMax</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">106</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPlatformFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">107</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_PLATFORM_FEE</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExceedsMax</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGmx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">104</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPoolFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_poolFee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">105</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_poolFee</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAmount</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">116</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setWithdrawalPenalty</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">117</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">penalty</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_WITHDRAWAL_PENALTY</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExceedsMax</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">128</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPlatformFee</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">129</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">MAX_PLATFORM_FEE</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ExceedsMax</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">152</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPlatform</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_platform</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">153</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_platform</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ZeroAddress</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<h2 id=\"suggestions-summary\" style=\"position:relative;\"><a href=\"#suggestions-summary\" aria-label=\"suggestions summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Suggestions Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Number</th>\n<th align=\"left\">Suggestion Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[S-01]</td>\n<td align=\"left\">Generate perfect code headers every time</td>\n</tr>\n<tr>\n<td align=\"center\">[S-02]</td>\n<td align=\"left\">Add NatSpec comments to the variables defined in Storage</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 2 suggestions</p>\n<h2 id=\"s-01-generate-perfect-code-headers-every-time\" style=\"position:relative;\"><a href=\"#s-01-generate-perfect-code-headers-every-time\" aria-label=\"s 01 generate perfect code headers every time permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[S-01] Generate perfect code headers every time</h2>\n<p>I recommend using header for Solidity code layout and readability:</p>\n<p><a href=\"https://github.com/transmissions11/headers\">https://github.com/transmissions11/headers</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"103\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/*//////////////////////////////////////////////////////////////</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">                           TESTING 123</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">//////////////////////////////////////////////////////////////*/</span></span></span></code></pre>\n<h2 id=\"s-02-add-natspec-comments-to-the-variables-defined-in-storage\" style=\"position:relative;\"><a href=\"#s-02-add-natspec-comments-to-the-variables-defined-in-storage\" aria-label=\"s 02 add natspec comments to the variables defined in storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[S-02] Add NatSpec comments to the variables defined in Storage</h2>\n<p>I recommend adding NatSpec comments explaining the variables defined in Storage, their slots, their contents and definitions.</p>\n<p>This improves code readability and control quality</p>\n<p>Current Code;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"104\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">vaults</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AutoPxGlp</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">18</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_WITHDRAWAL_PENALTY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">500</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">19</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_PLATFORM_FEE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">20</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">21</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_COMPOUND_INCENTIVE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">5000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">22</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">EXPANDED_DECIMALS</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e30</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">24</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">withdrawalPenalty</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">300</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">25</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">platformFee</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">26</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">compoundIncentive</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">27</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">platform</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk7\">30</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">immutable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">rewardsModule</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Recommendation Code;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"105\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk3\">//****** Slot 0 ******//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk7\">26</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_WITHDRAWAL_PENALTY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">500</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk5\">/ /</span><span class=\"mtk1\">****** </span><span class=\"mtk12\">Slot</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> ******</span><span class=\"mtk3\">//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk7\">30</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_PLATFORM_FEE</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">//****** Slot 2 ******//</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk7\">33</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FEE_DENOMINATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">/****** End of storage ******/</span></span></span></code></pre>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 33 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/171\">report highlighted below</a> by <strong>gzeon</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/404\">Deivitto</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/382\">adriro</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/378\">Tomio</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/374\">halden</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/368\">c3phas</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/357\">cryptonue</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/352\">B2</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/341\">ajtra</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/325\">oyc_109</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/323\">karanctf</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/310\">__141345__</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/303\">Diana</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/294\">dharma09</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/260\">unforgiven</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/257\">PaludoX0</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/254\">sakshamguruji</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/250\">keccak123</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/244\">saneryee</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/217\">JohnSmith</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/215\">0xPanda</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/159\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/153\">ReyAdmirado</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/147\">codeislight</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/121\">Rolezn</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/118\">aphak5010</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/108\">datapunk</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/63\">Rahoz</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/42\">chaduke</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/34\">Schlagatron</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/29\">Secureverse</a>,\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/14\">pavankv</a>, and\n<a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/2\">RaymondFam</a>\n.</em></p>\n<p>Since GMX is on Arbitrum, a L2 rollup, it is much more important to optimize for calldata when considering gas optimization. In fact, EVM gas optimizations have minimal effect when compared to calldata optimizations. For example at 9 gwei L1 gas price and 0.1 gwei Arbitrum gas price, each byte of calldata after compression cost ~640 calldata gas. Here are some suggestions to reduce the calldata size:</p>\n<ol>\n<li>For all the functions with a <code>receiver</code> parameter (e.g. <code>depositGmx(uint256 amount, address receiver)</code>), add a helper function which default it with msg.sender. This saves 20 bytes (or 32 bytes, but those 0 will mostly be compressed away) of calldata ~= 12800 gas.</li>\n<li>For deposit and withdraw functions, allow the user to specify some magic value to deposit/withdraw max. This saves 32 bytes of calldata ~= 20480 gas.</li>\n<li>On the UI level, use more compressible value (e.g. 1024(0x400) instead of 1000(0x3E8)) for amounts like minGlp</li>\n<li>Consider integrating with <a href=\"https://developer.offchainlabs.com/arbitrum-ethereum-differences#precompiles\">ArbAddressTable</a> for token addresses and other common addresses.</li>\n</ol>\n<h3 id=\"resources\" style=\"position:relative;\"><a href=\"#resources\" aria-label=\"resources permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resources</h3>\n<ul>\n<li><a href=\"https://developer.offchainlabs.com/\">https://developer.offchainlabs.com/</a></li>\n<li><a href=\"https://l2fees.info/blog/rollup-calldata-compression\">https://l2fees.info/blog/rollup-calldata-compression</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/171#issuecomment-1343904008\">drahrealm (Redacted Cartel) commented</a>:</strong></p>\n<blockquote>\n<p>These are interesting tips 👍 .</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-redactedcartel-findings/issues/171#issuecomment-1368410277\">Picodes (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Flagging as best as I believe this was the submission providing the most value to the sponsor.</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk5 { color: #D16969; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-6\">High Risk Findings (6)</a></p>\n<ul>\n<li><a href=\"#h-01-the-redeem-related-functions-are-likely-to-be-blocked\">[H-01] The <code>redeem</code> related functions are likely to be blocked</a></li>\n<li><a href=\"#h-02-users-receive-less-rewards-due-to-miscalculations\">[H-02] Users Receive Less Rewards Due To Miscalculations</a></li>\n<li><a href=\"#h-03-malicious-users-can-drain-the-assets-of-auto-compound-vault\">[H-03] Malicious Users Can Drain The Assets Of Auto Compound Vault</a></li>\n<li><a href=\"#h-04-users-accrued-rewards-will-be-lost\">[H-04] User’s Accrued Rewards Will Be Lost</a></li>\n<li><a href=\"#h-05-underlying-assets-stealing-in-autopxgmx-and-autopxglp-via-share-price-manipulation\">[H-05] Underlying assets stealing in <code>AutoPxGmx</code> and <code>AutoPxGlp</code> via share price manipulation</a></li>\n<li><a href=\"#h-06-fee-loss-in-autopxgmx-and-autopxglp-and-reward-loss-in-autopxglp-by-calling-pirexrewardsclaimpxgmxpxgpl-autopx-directly-which-transfers-rewards-to--autopx-pool-without-compound-logic-get-executed-and-fee-calculation-logic-and-pxgmx-wouldnt-be-executed-for-those-rewards\">[H-06] fee loss in AutoPxGmx and AutoPxGlp and reward loss in AutoPxGlp by calling <code>PirexRewards.claim(pxGmx/pxGpl, AutoPx*)</code> directly which transfers rewards to  AutoPx* pool without compound logic get executed and fee calculation logic and pxGmx wouldn’t be executed for those rewards</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-12\">Medium Risk Findings (12)</a></p>\n<ul>\n<li><a href=\"#m-01-pirexgmxinitiatemigration-can-be-blocked\">[M-01] <code>PirexGmx.initiateMigration</code> can be blocked</a></li>\n<li><a href=\"#m-02-preventing-any-user-from-calling-the-functions-withdraw-redeem-or-depositgmx-in-contract-autopxgmx-\">[M-02] Preventing any user from calling the functions <code>withdraw</code>, <code>redeem</code>, or <code>depositGmx</code> in contract <code>AutoPxGmx</code> </a></li>\n<li><a href=\"#m-03-anyone-can-call-autopxgmxcompound-and-perform-sandwich-attacks-with-control-parameters\">[M-03] Anyone can call AutoPxGmx.compound and perform sandwich attacks with control parameters</a></li>\n<li><a href=\"#m-04-autopxgmxmaxwithdraw-and-autopxglpmaxwithdraw-functions-calculate-asset-amount-that-is-too-big-and-cannot-be-withdrawn\">[M-04] AutoPxGmx.maxWithdraw and AutoPxGlp.maxWithdraw functions calculate asset amount that is too big and cannot be withdrawn</a></li>\n<li><a href=\"#m-05-swap_router-in-autopxgmxsol-is-hardcoded-and-not-compatible-on-avalanche\">[M-05] <code>SWAP_ROUTER</code> in <code>AutoPxGmx.sol</code> is hardcoded and not compatible on Avalanche</a></li>\n<li><a href=\"#m-06-assets-may-be-lost-when-calling-unprotected-autopxglpcompound-function\">[M-06] Assets may be lost when calling unprotected <code>AutoPxGlp::compound</code> function</a></li>\n<li><a href=\"#m-07-deposit-feature-of-the-vault-will-break-if-update-to-a-new-platform\">[M-07] Deposit Feature Of The Vault Will Break If Update To A New Platform</a></li>\n<li><a href=\"#m-08-tokens-with-fees-will-break-the-depositglp-logic\">[M-08] Tokens with fees will break the <code>depositGlp()</code> logic</a></li>\n<li><a href=\"#m-09-broken-logic-in-configuregmxstate-of-pirexgmx-contract-because-it-doesnt-properly-call-safeapprove-for-stakedgmx-address\">[M-09] broken logic in <code>configureGmxState()</code> of PirexGmx contract because it doesn’t properly call <code>safeApprove()</code> for stakedGmx address</a></li>\n<li><a href=\"#m-10-_calculaterewards-in-pirexgmx-dont-handle-reward-calculation-properly-and-it-would-revert-when-totalsupply-is-zero-which-will-cause-claimrewards-to-revert-if-one-of-4-rewardtrackers-totalsupply-was-zero\">[M-10] <code>_calculateRewards()</code> in PirexGmx don’t handle reward calculation properly, and it would revert when <code>totalSupply()</code> is zero which will cause <code>claimRewards()</code> to revert if one of 4 rewardTracker’s totalSupply was zero</a></li>\n<li><a href=\"#m-11-pirexgmxmigratereward-may-cause-users-to-lose-reward\">[M-11] PirexGmx#migrateReward() may cause users to lose Reward.</a></li>\n<li><a href=\"#m-12-reward-tokens-mismanagement-can-cause-users-losing-rewards\">[M-12] Reward tokens mismanagement can cause users losing rewards</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk-issues-summary\">Low Risk Issues Summary</a></li>\n<li><a href=\"#l-01-pirexerc4626s-implmentation-is-not-fully-up-to-eip-4626s-specification\">L-01 PirexERC4626’s implmentation is not fully up to EIP-4626’s specification</a></li>\n<li><a href=\"#l-02-initialize-function-can-be-called-by-anybody\">L-02 <code>initialize()</code> function can be called by anybody</a></li>\n<li><a href=\"#l-03-solmates-safetransferlib-doesnt-check-whether-the-erc20-contract-exists\">L-03 Solmate’s SafeTransferLib doesn’t check whether the ERC20 contract exists</a></li>\n<li><a href=\"#l-04-use-ownable2stepupgradeable-instead-of-ownableupgradeable-contract\">L-04 Use <code>Ownable2StepUpgradeable</code> instead of <code>OwnableUpgradeable</code> contract</a></li>\n<li><a href=\"#l-05-owner-can-renounce-ownership\">L-05 Owner can renounce Ownership</a></li>\n<li><a href=\"#l-06-critical-address-changes-should-use-two-step-procedure\">L-06 Critical Address Changes Should Use Two-step Procedure</a></li>\n<li><a href=\"#l-07-depositglp-event-arguments-names-are-confusing\">L-07 <code>DepositGlp</code> Event arguments names are confusing</a></li>\n<li><a href=\"#l-08-loss-of-precision-due-to-rounding\">L-08 Loss of precision due to rounding</a></li>\n<li><a href=\"#l-09-first-value-check-of-argument-of-type-enum-in-setfee-function-is-missing\">L-09 First value check of argument of type enum in setFee function is missing</a></li>\n<li><a href=\"#l-10-hardcode-the-address-causes-no-future-updates\">L-10 Hardcode the address causes no future updates</a></li>\n<li><a href=\"#l-11-lack-of-input-validation\">L-11 Lack of Input Validation</a></li>\n<li><a href=\"#non-critical-issues-summary\">Non-Critical Issues Summary</a></li>\n<li><a href=\"#n-01-insufficient-coverage\">N-01 Insufficient coverage</a></li>\n<li><a href=\"#n-02-not-using-the-named-return-variables-anywhere-in-the-function-is-confusing\">N-02 Not using the named return variables anywhere in the function is confusing</a></li>\n<li><a href=\"#n-03-same-constant-redefined-elsewhere\">N-03 Same Constant redefined elsewhere</a></li>\n<li><a href=\"#n-04-omissions-in-events\">N-04 Omissions in Events</a></li>\n<li><a href=\"#n-05-add-parameter-to-event-emit\">N-05 Add parameter to Event-Emit</a></li>\n<li><a href=\"#n-06-natspec-is-missing\">N-06 NatSpec is missing</a></li>\n<li><a href=\"#n-07-use-require-instead-of-assert\">N-07 Use <code>require</code> instead of <code>assert</code></a></li>\n<li><a href=\"#n-08-implement-some-type-of-version-counter-that-will-be-incremented-automatically-for-contract-upgrades\">N-08 Implement some type of version counter that will be incremented automatically for contract upgrades</a></li>\n<li><a href=\"#n-09-constant-values-such-as-a-call-to-keccak256-should-used-to-immutable-rather-than-constant\">N-09 Constant values such as a call to <code>keccak256()</code>, should used to immutable rather than constant</a></li>\n<li><a href=\"#n-10-for-functions-follow-solidity-standard-naming-conventions\">N-10 For functions, follow Solidity standard naming conventions</a></li>\n<li><a href=\"#n-11-mark-visibility-of-initialize-functions-as-external\">N-11 Mark visibility of initialize(…) functions as <code>external</code></a></li>\n<li><a href=\"#n-12-no-same-value-input-control\">N-12 No same value input control</a></li>\n<li><a href=\"#n-13-include-return-parameters-in-natspec-comments\">N-13 Include <code>return parameters</code> in <em>NatSpec comments</em></a></li>\n<li><a href=\"#n-14-0-address-check-for-asset\">N-14 <code>0 address</code> check for <code>asset</code></a></li>\n<li><a href=\"#n-15-use-a-single-file-for-all-system-wide-constants\">N-15 Use a single file for all system-wide constants</a></li>\n<li><a href=\"#nc-16-function-writing-that-does-not-comply-with-the-solidity-style-guide\">NC-16 <code>Function writing</code> that does not comply with the <code>Solidity Style Guide</code></a></li>\n<li><a href=\"#n-17-missing-upgrade-path-for-pirexrewards-implementation\">N-17 Missing Upgrade Path for <code>PirexRewards</code> Implementation</a></li>\n<li><a href=\"#n-18-no-need-assert-check-in-_computeassetamounts\">N-18 No need <code>assert</code> check in <code>_computeAssetAmounts()</code></a></li>\n<li><a href=\"#n-19-lack-of-event-emission-after-critical-initialize-functions\">N-19 Lack of event emission after critical <code>initialize()</code> functions</a></li>\n<li><a href=\"#n-20-add-a-timelock-to-critical-functions\">N-20 Add a timelock to critical functions</a></li>\n<li><a href=\"#suggestions-summary\">Suggestions Summary</a></li>\n<li><a href=\"#s-01-generate-perfect-code-headers-every-time\">S-01 Generate perfect code headers every time</a></li>\n<li><a href=\"#s-02-add-natspec-comments-to-the-variables-defined-in-storage\">S-02 Add NatSpec comments to the variables defined in Storage</a></li>\n</ul>\n</li>\n<li><a href=\"#gas-optimizations\">Gas Optimizations</a></li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}