{
  "circa": {
    "title": "SKALE contest",
    "sponsor": "SKALE",
    "slug": "2022-02-skale",
    "date": "2022-11-11",
    "findings": "https://github.com/code-423n4/2022-02-skale-findings/issues",
    "contest": 88
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the SKALE smart contract system written in Solidity. The audit contest took place between February 18—March 3 2022.</p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>29 Wardens contributed reports to the SKALE contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/cmichelio\">cmichel</a></li>\n<li><a href=\"https://twitter.com/kirkthebaird\">kirk-baird</a></li>\n<li><a href=\"https://twitter.com/WatchPug_\">WatchPug</a> (<a href=\"https://github.com/jack-the-pug\">jtp</a> and <a href=\"https://github.com/mingwatch\">ming</a>)</li>\n<li><a href=\"https://twitter.com/liam_eastwood13\">leastwood</a></li>\n<li>hubble (ksk2345 and shri4net)</li>\n<li>0x1f8b</li>\n<li>IllIllI</li>\n<li>cccz</li>\n<li>kyliek</li>\n<li><a href=\"https://twitter.com/gzeon\">gzeon</a></li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li>jayjonah8</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>robee</li>\n<li><a href=\"https://twitter.com/_ye0lde\">ye0lde</a></li>\n<li>TerrierLover</li>\n<li><a href=\"https://www.instagram.com/riyan_rfa/\">rfa</a></li>\n<li>kenta</li>\n<li>saian</li>\n<li>0xwags</li>\n<li><a href=\"https://twitter.com/CertoraInc\">CertoraInc</a> (egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, and shakedwinder)</li>\n<li>m_smirnova2020</li>\n<li>d4rk</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n</ol>\n<p>This contest was judged by <a href=\"https://twitter.com/GalloDaSballo\">Alex the Entreprenerd</a>.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/itsmetechjay\">itsmetechjay</a> and <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 13 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 11 received a risk rating in the category of MEDIUM severity. Of these, 2 HIGH severity and 1 MEDIUM severity item were mitigated by SKALE.</p>\n<p>Additionally, C4 analysis included 14 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 15 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-02-skale\">C4 SKALE contest repository</a>, and is composed of 33 smart contracts written in the Solidity programming language and includes 2,679 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-reentrancy-in-messageproxyforschain-leads-to-replay-attacks\" style=\"position:relative;\"><a href=\"#h-01-reentrancy-in-messageproxyforschain-leads-to-replay-attacks\" aria-label=\"h 01 reentrancy in messageproxyforschain leads to replay attacks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/24\">[H-01] Reentrancy in <code>MessageProxyForSchain</code> leads to replay attacks</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>The <code>postIncomingMessages</code> function calls <code>_callReceiverContract(fromChainHash, messages[i], startingCounter + 1)</code> which gives control to a contract that is potentially attacker controlled <em>before</em> updating the <code>incomingMessageCounter</code>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// @audit re-entrant, can submit same postIncomingMessages again</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_callReceiverContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromChainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">startingCounter</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">fromChainHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">incomingMessageCounter</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>The attacker can re-enter into the <code>postIncomingMessages</code> function and submit the same messages again, creating a replay attack.\nNote that the <code>startingCounter</code> is the way how messages are prevented from replay attacks here, there are no further nonces.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Attacker can submit two cross-chain messages to be executed:</p>\n<ol>\n<li>Transfer 1000 USDC</li>\n<li>A call to their attacker-controlled contract, could be masked as a token contract that allows re-entrance on <code>transfer</code>.</li>\n</ol>\n<p>Some node submits the <code>postIncomingMessages(params)</code> transaction, transfers 1000 USDC, then calls the attackers contract, who can themself call <code>postIncomingMessages(params)</code> again, receive 1000 USDC a second time, and stop the recursion.</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a <code>messageInProgressLocker</code> modifier to <code>postIncomingMessages</code> as was done in <code>MessageProxyForMainnet</code>.</p>\n<p><strong>cstrangedk (SKALE) resolved:</strong></p>\n<p>Resolved via <a href=\"https://github.com/skalenetwork/IMA/pull/1054\">https://github.com/skalenetwork/IMA/pull/1054</a></p>\n<hr>\n<h2 id=\"h-02-gas-pricing-can-be-used-to-extort-funds-from-users-of-schain-owner\" style=\"position:relative;\"><a href=\"#h-02-gas-pricing-can-be-used-to-extort-funds-from-users-of-schain-owner\" aria-label=\"h 02 gas pricing can be used to extort funds from users of schain owner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/28\">[H-02] Gas pricing can be used to extort funds from users of SChain owner</a></h2>\n<p><em>Submitted by kirk-baird, also found by leastwood</em></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L82-L112\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L82-L112</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L235-L250\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L235-L250</a></p>\n<h3 id=\"impact\" style=\"position:relative;\"><a href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>The function <code>refundGasByUser()</code> can be exploited by the message sender to drain nodes and SChain owners of their balances when processing incoming messages.</p>\n<p>When a node collates a set of exits from an SChain to Ethereum, they are submitted on-chain via <code>MessageProxyForMainnet.sol</code>.  For each message to a registered contract the user is required to pay for the refund via <code>CommunityPool.refundGasByUser()</code>.</p>\n<p>The issue occurs in <code>CommunityPool.refundGasByUser()</code>  as the amount to be refunded is calculated as <code>uint amount = tx.gasprice * gas;</code>, where <code>gas</code> is the gas used by the message. Since <code>tx.gasprice</code> is set by the node and there is no upper bounds on the price. Since EIP1559 the gas price is <code>BaseFee + Tip</code> and although <code>Base</code> is predetermined <code>Tip</code> is any arbitrary non-zero integer.</p>\n<p>The attack is for a node to set an excessively high <code>tx.gasprice</code> which will be refunded out of the balance of the user who initiated the outgoing transaction or if that user has insufficient balance then from the SChain owner.  Since the node submitting the transaction is refunded for their gas they do not lose from setting a higher gas price.</p>\n<p>The impact of the attack is that the user requesting the exit and/or the SChain owner may have their ETH balances depleted to refund the submitter. The impact is worsened as if the user has insufficient balance a message will be sent to the SChain preventing them from making further exits until they have sufficient balance.</p>\n<p>Note a similar issue may be seen in <code>IWallets.refundGasBySchain()</code> depending on how the gas calculations are performed (they are not in scope but the <code>TestWallet</code> also uses <code>tx.gasprice</code> in the same manner).</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Processing incoming messages in <code>MessageProxyForMainnet.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">.</span><span class=\"mtk12\">length</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">gasTotal</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">isContractRegistered</span><span class=\"mtk1\">(</span><span class=\"mtk11\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">].</span><span class=\"mtk12\">destinationContract</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_getGasPayer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromSchainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">startingCounter</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_callReceiverContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromSchainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">startingCounter</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">notReimbursedGas</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">communityPool</span><span class=\"mtk1\">.</span><span class=\"mtk11\">refundGasByUser</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">fromSchainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    </span><span class=\"mtk12\">gasTotal</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">() + </span><span class=\"mtk12\">additionalGasPerMessage</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_callReceiverContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromSchainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">messages</span><span class=\"mtk1\">[</span><span class=\"mtk12\">i</span><span class=\"mtk1\">], </span><span class=\"mtk12\">startingCounter</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">i</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">notReimbursedGas</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">gasTotal</span><span class=\"mtk1\"> - </span><span class=\"mtk11\">gasleft</span><span class=\"mtk1\">() + </span><span class=\"mtk12\">additionalGasPerMessage</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span></code></pre>\n<p>Refunding gas in <code>CommunityPool.sol</code></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">refundGasByUser</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">node</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gas</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyMessageProxy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">node</span><span class=\"mtk1\"> != </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Node address must be set&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">activeUsers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">gas</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">gasprice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">gas</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">_userWallets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">]) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_userWallets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">_userWallets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">_userWallets</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">] - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk11\">_balanceIsSufficient</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">user</span><span class=\"mtk1\">, </span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">activeUsers</span><span class=\"mtk1\">[</span><span class=\"mtk12\">user</span><span class=\"mtk1\">][</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">messageProxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">postOutgoingMessage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">schainLinks</span><span class=\"mtk1\">[</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeLockUserMessage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">user</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">node</span><span class=\"mtk1\">.</span><span class=\"mtk11\">sendValue</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">gasprice</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">gas</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">tx</span><span class=\"mtk1\">.</span><span class=\"mtk12\">gasprice</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>One solution to avoid excessive over refunding of gas fees is to use a gas price oracle rather than <code>tx.gasprice</code>.</p>\n<p>An alternate solution is to set a maximum gas price and have some incentives for the node submitting at a gas price below the maximum.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/28#issuecomment-1176670089\">cstrangedk (SKALE) resolved</a>:</strong></p>\n<blockquote>\n<p>Resolved via <a href=\"https://github.com/skalenetwork/IMA/pull/1165/\">https://github.com/skalenetwork/IMA/pull/1165/</a></p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-11\" style=\"position:relative;\"><a href=\"#medium-risk-findings-11\" aria-label=\"medium risk findings 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (11)</h1>\n<h2 id=\"m-01-transactions-can-be-replayed-when-a-connectedchain-is-removed-and-then-reconnected\" style=\"position:relative;\"><a href=\"#m-01-transactions-can-be-replayed-when-a-connectedchain-is-removed-and-then-reconnected\" aria-label=\"m 01 transactions can be replayed when a connectedchain is removed and then reconnected permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/57\">[M-01] Transactions can be replayed when a connectedChain is removed and then reconnected</a></h2>\n<p><em>Submitted by WatchPug, also found by cmichel</em></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/MessageProxy.sol#L313-L317\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/MessageProxy.sol#L313-L317</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeConnectedChain</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyChainConnector</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">inited</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Chain is not initialized&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">delete</span><span class=\"mtk1\"> </span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/MessageProxy.sol#L402-L409\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/MessageProxy.sol#L402-L409</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_addConnectedChain</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyChainConnector</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">inited</span><span class=\"mtk1\">,</span><span class=\"mtk8\">&quot;Chain is already connected&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">ConnectedChainInfo</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">incomingMessageCounter:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">outgoingMessageCounter:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">inited:</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>In the current implementation, when a connected chain is removed, the <code>incomingMessageCounter</code> and <code>outgoingMessageCounter</code> will be deleted.</p>\n<p>And if it’s reconnected again, the <code>incomingMessageCounter</code> and <code>outgoingMessageCounter</code> will be reset to <code>0</code>.</p>\n<p>However, since the contract is using <code>connectedChains[fromChainHash].incomingMessageCounter</code> and <code>signature</code> to ensure that the message can only be processed once.</p>\n<h3 id=\"impact-1\" style=\"position:relative;\"><a href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<ol>\n<li>Once the <code>incomingMessageCounter</code> resets to <code>0</code>, all the past messages (transactions) can be replayed with the old signatures.</li>\n<li>Another impact is that, for the particular reconnected schain, both inbound and outbound messages may not be able to be processed properly, as the counter is now out of sync with the remote schain.</li>\n</ol>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/MessageProxyForSchain.sol#L212-L221\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/MessageProxyForSchain.sol#L212-L221</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_verifyMessages</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_hashedArray</span><span class=\"mtk1\">(</span><span class=\"mtk12\">messages</span><span class=\"mtk1\">, </span><span class=\"mtk12\">startingCounter</span><span class=\"mtk1\">, </span><span class=\"mtk12\">fromChainName</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">signature</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;Signature is not verified&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">startingCounter</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">fromChainHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">incomingMessageCounter</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk8\">&quot;Starting counter is not qual to incoming message counter&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<h3 id=\"recommendation\" style=\"position:relative;\"><a href=\"#recommendation\" aria-label=\"recommendation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>When removing and connecting a schain, instead of delete/reset the couter, consider leaving the counter as it is when <code>removeConnectedChain</code>, <code>_addConnectedChain</code> also should not reset the counter:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">removeConnectedChain</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">) </span><span class=\"mtk11\">public</span><span class=\"mtk1\"> </span><span class=\"mtk11\">virtual</span><span class=\"mtk1\"> </span><span class=\"mtk11\">override</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyChainConnector</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">keccak256</span><span class=\"mtk1\">(</span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodePacked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">inited</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Chain is not initialized&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetChainHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">inited</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">false</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_addConnectedChain</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">onlyChainConnector</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">inited</span><span class=\"mtk1\">,</span><span class=\"mtk8\">&quot;Chain is already connected&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">connectedChains</span><span class=\"mtk1\">[</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">].</span><span class=\"mtk12\">inited</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/57#issuecomment-1064177348\">DimaStebaev (SKALE) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged, and work is on the roadmap.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/57#issuecomment-1143788390\">GalloDaSballo (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I believe the finding to have validity, in that, a set of signed messages can be replayed if the chain is disconnected and then re-connected while maintaining the same validators.</p>\n<p>At this time I think Medium Severity (External Conditions Reliance) to be more appropriate and that the issue can be fully sidestepped by changing validators on a chain reconnect</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-when-transferring-tokens-native-on-skale-to-ethereum-with-tokenmanagererc20exittomainerc20-the-tokens-on-the-schain-will-be-frozen-on-tokenmanagererc20-but-they-will-not-receive-tokens-on-ethereum\" style=\"position:relative;\"><a href=\"#m-02-when-transferring-tokens-native-on-skale-to-ethereum-with-tokenmanagererc20exittomainerc20-the-tokens-on-the-schain-will-be-frozen-on-tokenmanagererc20-but-they-will-not-receive-tokens-on-ethereum\" aria-label=\"m 02 when transferring tokens native on skale to ethereum with tokenmanagererc20exittomainerc20 the tokens on the schain will be frozen on tokenmanagererc20 but they will not receive tokens on ethereum permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/58\">[M-02] When transferring tokens native on SKALE to Ethereum with <code>TokenManagerERC20.exitToMainERC20()</code>, the tokens on the schain will be frozen on <code>TokenManagerERC20</code>, but they will not receive tokens on Ethereum</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p>In the current implementation of <code>TokenManagerERC20</code>, it allows <code>exitToMainERC20(tokenOnSchain, amount)</code>.</p>\n<p>At L277 of <code>TokenManagerERC20.sol</code> in <code>exitToMainERC20()</code>, if <code>tokenOnSchain</code> is minted on SKALE schain natively, there are no such require statement that prevents the target chain being mainnet, eg: <code>require(chainHash != MAINNET_HASH, \"...\")</code></p>\n<p>Therefore, a user can set mainnet as the target chain, and at L298 of <code>TokenManagerERC20.sol</code>, the tokens will be transferred to the contract, and at L308,  send message to Ethereum mainnet.</p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L95-L104\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L95-L104</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">exitToMainERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractOnMainnet</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">communityLocker</span><span class=\"mtk1\">.</span><span class=\"mtk11\">checkAllowedToSendMessage</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_exit</span><span class=\"mtk1\">(</span><span class=\"mtk12\">MAINNET_HASH</span><span class=\"mtk1\">, </span><span class=\"mtk12\">depositBox</span><span class=\"mtk1\">, </span><span class=\"mtk12\">contractOnMainnet</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L264-L313\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L264-L313</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_exit</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">messageReceiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractOnMainChain</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isMainChainToken</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ERC20BurnableUpgradeable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">clonesErc20</span><span class=\"mtk1\">[</span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">][</span><span class=\"mtk12\">contractOnMainChain</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">) == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20BurnableUpgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnMainChain</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">isMainChainToken</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">).</span><span class=\"mtk11\">isContract</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;No token clone on schain&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Insufficient funds&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">.</span><span class=\"mtk11\">allowance</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            ) &gt;= </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Transfer is not approved by token holder&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeTransferErc20Message</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnMainChain</span><span class=\"mtk1\">), </span><span class=\"mtk12\">to</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isMainChainToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_receiveERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_saveTransferredAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;Transfer was failed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk8\">&quot;Transfer was failed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">.</span><span class=\"mtk11\">burn</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">messageProxy</span><span class=\"mtk1\">.</span><span class=\"mtk11\">postOutgoingMessage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">messageReceiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p>However, the <code>DepositBoxERC20</code> contract on Ethereum mainnet does not support such message from <code>TokenManagerERC20</code> on the schain:</p>\n<p>The type of the message from schain <code>TokenManagerERC20</code> is <code>TRANSFER_ERC20_AND_TOKEN_INFO</code> (see L354 of TokenManagerERC20.sol) or <code>TRANSFER_ERC20_AND_TOTAL_SUPPLY</code> (see L362 of TokenManagerERC20.sol).</p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L339-L370\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L339-L370</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_receiveERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">private</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">ERC20BurnableUpgradeable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">ERC20BurnableUpgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">.</span><span class=\"mtk11\">totalSupply</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">totalSupply</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Amount is incorrect&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isERC20AddedToSchain</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_schainToERC20</span><span class=\"mtk1\">[</span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">].</span><span class=\"mtk11\">contains</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">isERC20AddedToSchain</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">_addERC20ForSchain</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeTransferErc20AndTokenInfoMessage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_getErc20TotalSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_getErc20TokenInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        } </span><span class=\"mtk15\">else</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeTransferErc20AndTotalSupplyMessage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk11\">_getErc20TotalSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ERC20TokenReady</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><code>DepositBoxERC20</code> on Ethereum MAINNET can only process <code>TRANSFER_ERC20</code>. (see DepositBoxERC20.sol L155 and Messages.sol L270)</p>\n<p>When getting a message with the type of <code>TRANSFER_ERC20_AND_TOKEN_INFO</code> or <code>TRANSFER_ERC20_AND_TOTAL_SUPPLY</code> from schain <code>TokenManagerERC20</code>, it will revert at L270 of Messages.sol.</p>\n<p>As a result, the schain tokens will be frozen on TokenManagerERC20, but they will not receive tokens on Ethereum.</p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L143-L164\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L143-L164</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">postMessage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes32</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlyMessageProxy</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">whenNotKilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">checkReceiverChain</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">sender</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">Messages</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TransferErc20Message</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">message</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decodeTransferErc20Message</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">isContract</span><span class=\"mtk1\">(), </span><span class=\"mtk8\">&quot;Given address is not a contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">ERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">)) &gt;= </span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Not enough money&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_removeTransferredAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk11\">ERC20Upgradeable</span><span class=\"mtk1\">(</span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk8\">&quot;Transfer was failed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/Messages.sol#L267-L272\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/Messages.sol#L267-L272</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">decodeTransferErc20Message</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">bytes</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">data</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">pure</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">TransferErc20Message</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">getMessageType</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">) == </span><span class=\"mtk12\">MessageType</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TRANSFER_ERC20</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Message type is not ERC20 transfer&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">abi</span><span class=\"mtk1\">.</span><span class=\"mtk11\">decode</span><span class=\"mtk1\">(</span><span class=\"mtk12\">data</span><span class=\"mtk1\">, (</span><span class=\"mtk12\">TransferErc20Message</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3 id=\"recommendation-1\" style=\"position:relative;\"><a href=\"#recommendation-1\" aria-label=\"recommendation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider preventing moving schain native tokens to Ethereum MAINNET, for example: Add <code>require(chainHash != MAINNET_HASH, \"...\")</code> near L277 of TokenManagerERC20.sol.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/58#issuecomment-1061027228\">cstrangedk (SKALE) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Valid issue, however disagree with severity as issue relates to <code>function incorrect as to spec</code>.  Suggest <code>low severity</code>.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/58#issuecomment-1143798216\">GalloDaSballo (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Let me reason through the finding:\n-> The warden has shown a way for funds to be lost as long as a user uses a sChainNativeToken and burns them to bridge to mainnet (Potentially High)</p>\n<p>-> This is contingent on the configuration of the depositBoxErc20 (Potentially Med)</p>\n<p>I disagree with the sponsor argument in that while the code may not be as to spec, the functionality impaired as a medium to high impact.</p>\n<p>At this time I can rationalize the severity either as:\n-> It should be High because the given codebase “default” functionality has this flaw\n-> it should be Med because this is contingent on a configuration parameter</p>\n<p>Given the pre-context that the sChain could be set up by the admin to allow the misconfiguration to happen, at this time, I believe Medium Severity to be more appropriate as the impact is solely dependent upon the configuration of the chain which as explained in the readmes is mostly dependent on the admin.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/58#issuecomment-1195585103\">cstrangedk (SKALE) commented</a>:</strong></p>\n<blockquote>\n<p>Mitigated in <a href=\"https://github.com/skalenetwork/IMA/pull/1031\">skalenetwork/IMA#1031</a>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-s2s-transfer-from-the-origin-schain-to-another-schain-with-automatic-deploy-disabled-can-cause-funds-to-be-frozen\" style=\"position:relative;\"><a href=\"#m-03-s2s-transfer-from-the-origin-schain-to-another-schain-with-automatic-deploy-disabled-can-cause-funds-to-be-frozen\" aria-label=\"m 03 s2s transfer from the origin schain to another schain with automatic deploy disabled can cause funds to be frozen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/59\">[M-03] S2S Transfer from the origin schain to another schain with automatic deploy disabled can cause funds to be frozen</a></h2>\n<p><em>Submitted by WatchPug</em></p>\n<p>When moving tokens that are native on the origin schain, to another schain, <code>TokenManagerERC20.sol#transferToSchainERC20()</code> will be called, which calls <code>_exit()</code> -> <code>_receiveERC20()</code>:</p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L289-L301\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L289-L301</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">isMainChainToken</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">_receiveERC20</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_saveTransferredAmount</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk8\">&quot;Transfer was failed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L351-L361\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L351-L361</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk12\">isERC20AddedToSchain</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_schainToERC20</span><span class=\"mtk1\">[</span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">].</span><span class=\"mtk11\">contains</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (!</span><span class=\"mtk12\">isERC20AddedToSchain</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">_addERC20ForSchain</span><span class=\"mtk1\">(</span><span class=\"mtk12\">chainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">Messages</span><span class=\"mtk1\">.</span><span class=\"mtk11\">encodeTransferErc20AndTokenInfoMessage</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">erc20OnMainChain</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">to</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_getErc20TotalSupply</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">_getErc20TokenInfo</span><span class=\"mtk1\">(</span><span class=\"mtk12\">erc20</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>However, on the target schain, while handling the inbound message with <code>postMessage()</code> -> <code>_sendERC20()</code>, when <code>contractOnSchain</code> is <code>false</code>, The transaction will fail with <code>\"Automatic deploy is disabled\"</code> when <code>automaticDeploy == false</code>:</p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L227-L235\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L227-L235</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">clonesErc20</span><span class=\"mtk1\">[</span><span class=\"mtk12\">fromChainHash</span><span class=\"mtk1\">][</span><span class=\"mtk12\">token</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">) == </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">automaticDeploy</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Automatic deploy is disabled&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">ERC20OnChain</span><span class=\"mtk1\">(</span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">name</span><span class=\"mtk1\">, </span><span class=\"mtk12\">message</span><span class=\"mtk1\">.</span><span class=\"mtk12\">tokenInfo</span><span class=\"mtk1\">.</span><span class=\"mtk12\">symbol</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">clonesErc20</span><span class=\"mtk1\">[</span><span class=\"mtk12\">fromChainHash</span><span class=\"mtk1\">][</span><span class=\"mtk12\">token</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">addedClones</span><span class=\"mtk1\">[</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">] = </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ERC20TokenCreated</span><span class=\"mtk1\">(</span><span class=\"mtk12\">fromChainHash</span><span class=\"mtk1\">, </span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk12\">contractOnSchain</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>As a result, any tokens that are locked in the origin schain by the user will be frozen in the contract.</p>\n<h3 id=\"recommendation-2\" style=\"position:relative;\"><a href=\"#recommendation-2\" aria-label=\"recommendation 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommendation</h3>\n<p>Consider adding a <code>mapping</code> storage to cache whether <code>automaticDeploy</code> is enabled on a certain schain, the cache should be updated once the <code>automaticDeploy</code> is updated.</p>\n<p>And only allows S2S transfer when <code>automaticDeploy</code> is enabled on the target schain.</p>\n<p>To further avoid the edge case of: right after the user submitted the S2S transfer tx on the from schain, the target schain disabled <code>automaticDeploy</code> and the user’s tokens can be frozen in the from schain. We can introduce a 24 hrs timelock for disabling <code>automaticDeploy</code>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/59#issuecomment-1061273352\">cstrangedk (SKALE) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Issue raised is acknowledged and work is assigned on the roadmap.  SKALE Chain owners must ensure any mapped assets, either through manual or automatic mapping are compatible with their dApp(s). Manual mapping mode is the default mode for bridge operation. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/59#issuecomment-1143799500\">GalloDaSballo (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I agree with both sides of the argument, and because this is contingent on configuration and admin privilege, believe Medium Severity to be more appropriate</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-tokenmanagererc20sol-uses-transferfrom-instead-of-safetransferfrom\" style=\"position:relative;\"><a href=\"#m-04-tokenmanagererc20sol-uses-transferfrom-instead-of-safetransferfrom\" aria-label=\"m 04 tokenmanagererc20sol uses transferfrom instead of safetransferfrom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/8\">[M-04] TokenManagerERC20.sol uses transferFrom() instead of safeTransferFrom()</a></h2>\n<p><em>Submitted by jayjonah8, also found by cmichel and IllIllI</em></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L298\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L298</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L303\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L303</a></p>\n<h3 id=\"impact-2\" style=\"position:relative;\"><a href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>In TokenManagerERC20.sol the _exit() function makes use of transferFrom() instead of using safeTransferFrom().   Tokens that don’t correctly implement the latest EIP20 spec will be unusable in the protocol as they revert the transaction because of the missing return value.</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L298\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L298</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L303\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L303</a></p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>It’s recommended to use OpenZeppelin’s SafeERC20 versions with the safeTransfer and safeTransferFrom functions that handle the return value check as well as non-standard-compliant tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/8#issuecomment-1058429459\">cstrangedk (SKALE) disputed, disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Issue is acknowledged and work is pending on the roadmap. No loss of funds is possible, only revert txn. In the meantime, SKALE Chain owners at their discretion can expand the bridge compatibility to use safeTransfer functions. Owners must evaluate token compatibility.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/8#issuecomment-1143815630\">GalloDaSballo (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I believe that given the “need for configuration” the finding cannot be of High Severity. Additionally, the tx will revert as such no loss of funds is possible.</p>\n<p>The tokens that will cause a revert (e.g. USDT) will simply be unusable.</p>\n<p>While the argument for configuration is correct in de-escalating to Medium, I don’t believe it exempts the code from being properly scrutinized.</p>\n<p>If a user were to configure their chain to use TokenManagerERC20 they’d have revert on non returning tokens, for that reason I believe Medium Severity to be appropriate as this is contingent on configuration</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-schain-owners-can-rug-pull-users-funds\" style=\"position:relative;\"><a href=\"#m-05-schain-owners-can-rug-pull-users-funds\" aria-label=\"m 05 schain owners can rug pull users funds permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/71\">[M-05] Schain owners can rug pull users’ funds</a></h2>\n<p><em>Submitted by IllIllI, also found by gzeon and kirk-baird</em></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxEth.sol#L138-L142\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxEth.sol#L138-L142</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L196-L200\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L196-L200</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L183-L187\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L183-L187</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L261-L271\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L261-L271</a></p>\n<h3 id=\"impact-3\" style=\"position:relative;\"><a href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Once a chain has been killed the chain owner is able to call <code>getFunds()</code> on each of the deposit boxes and transfer funds/tokens wherever he/she wishes</p>\n<p>Even if the owner is benevolent the fact that there is a rug vector available may <a href=\"https://twitter.com/RugDocIO/status/1411732108029181960\">negatively impact the protocol’s reputation</a>. See <a href=\"https://github.com/code-423n4/2021-08-realitycards-findings/issues/73\">this</a> example where a similar finding has been flagged as a high-severity issue. I’ve downgraded these instances to be a medium since it requires cooperation of the IMA mainnet admin.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">payable</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlySchainOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">whenKilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">keccak256</span><span class=\"mtk1\">(abi.encodePacked(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">)))</span></span></span></code></pre>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxEth.sol#L138-L142\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxEth.sol#L138-L142</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc20OnMainnet</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlySchainOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">whenKilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">keccak256</span><span class=\"mtk1\">(abi.encodePacked(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">)))</span></span></span></code></pre>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L196-L200\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L196-L200</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getFunds</span><span class=\"mtk1\">(</span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc721OnMainnet</span><span class=\"mtk1\">, </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">tokenId</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlySchainOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">whenKilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">keccak256</span><span class=\"mtk1\">(abi.encodePacked(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">)))</span></span></span></code></pre>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L183-L187\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L183-L187</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getFunds</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">calldata</span><span class=\"mtk1\"> </span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">erc1155OnMainnet</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">receiver</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ids</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amounts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">onlySchainOwner</span><span class=\"mtk1\">(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk11\">whenKilled</span><span class=\"mtk1\">(</span><span class=\"mtk12\">keccak256</span><span class=\"mtk1\">(abi.encodePacked(</span><span class=\"mtk12\">schainName</span><span class=\"mtk1\">)))</span></span></span></code></pre>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L261-L271\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L261-L271</a></p>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add a long time lock for killing so users have plenty of time to get their funds out before a kill</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/71#issuecomment-1065153957\">DimaStebaev (SKALE) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged, and timelock &#x26; eventual removal has been added to the roadmap\nThis is not a vulnerability.\nWe explicitly added this functionality to prevent loosing of funds in case of technical problems with SKALE chain. It requires SKALE chain owner and SKALE foundation cooperation to run this mechanism.\nIt is going to be removed eventually after some time of stable work.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/71#issuecomment-1143867079\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>While I empathize with the sponsor’s side that the function is meant as a security mechanism, it does allow the chainOwner to pull all funds and transfer them to their own wallet.</p>\n<p>Because this is contingent on Admin Privilege, I believe Medium Severity to be appropriate</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-centralisation-risk-admin-role-of-tokenmanagereth-can-rug-pull-all-eth-from-the-bridge\" style=\"position:relative;\"><a href=\"#m-06-centralisation-risk-admin-role-of-tokenmanagereth-can-rug-pull-all-eth-from-the-bridge\" aria-label=\"m 06 centralisation risk admin role of tokenmanagereth can rug pull all eth from the bridge permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/35\">[M-06] Centralisation risk: admin role of <code>TokenManagerEth</code> can rug pull all Eth from the bridge</a></h2>\n<p><em>Submitted by kirk-baird</em></p>\n<p>There is a Centralisation risk of the bridge where the <code>DEFAULT_ADMIN_ROLE</code> of <code>TokenManagerEth.sol</code> is able to modify the ERC20 token on the SChain to any arbitrary address. This would allow the admin role to change the address to one where they have infinite supply, they could then call <code>exitToMain(amount)</code> equal to the balance of the DepositBox in the main Ethereum chain. After the message is process on the main Ethereum chain they will receive the entire Eth balance of that contract.</p>\n<p>The rug pull attack occurs because there is a <code>DEFAULT_ADMIN_ROLE</code> which is set in the intiialisation to the <code>msg.sender</code> as seen in <code>initializeTokenManager()</code> below.</p>\n<p>The <code>DEFAULT_ADMIN_ROLE</code> may then call <code>setEthErc20Address(IEthErc20 newEthErc20Address)</code>  setting <code>newEthErc20Address</code> to any arbitrary contract they control.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function setEthErc20Address(IEthErc20 newEthErc20Address) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(hasRole(DEFAULT_ADMIN_ROLE, msg.sender), &quot;Not authorized caller&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(ethErc20 != newEthErc20Address, &quot;Must be new address&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ethErc20 = newEthErc20Address;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function initializeTokenManager(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string memory newSchainName,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        IMessageProxyForSchain newMessageProxy,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ITokenManagerLinker newIMALinker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ICommunityLocker newCommunityLocker,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address newDepositBox</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        public</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        virtual</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        initializer</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(newDepositBox != address(0), &quot;DepositBox address has to be set&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        AccessControlEnumerableUpgradeable.__AccessControlEnumerable_init();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _setupRole(AUTOMATIC_DEPLOY_ROLE, msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _setupRole(TOKEN_REGISTRAR_ROLE, msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainHash = keccak256(abi.encodePacked(newSchainName));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        messageProxy = newMessageProxy;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        tokenManagerLinker = newIMALinker;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        communityLocker = newCommunityLocker;        </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        depositBox = newDepositBox;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        emit DepositBoxWasChanged(address(0), newDepositBox);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider removing the function <code>setEthErc20Address()</code> as <code>ethErc20</code> is set in the <code>initialize()</code> function and does not need to be changed.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/35#issuecomment-1064199292\">DimaStebaev (SKALE) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged, and this can be done only by SKALE chain owner. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/35#issuecomment-1144015873\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Agree that the admin has the ability to rug users and agree with Med Severity</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-transferredamount-on-mainnet-can-be-drained-if-a-malicious-account-can-mint-more-tokens-on-schain\" style=\"position:relative;\"><a href=\"#m-07-transferredamount-on-mainnet-can-be-drained-if-a-malicious-account-can-mint-more-tokens-on-schain\" aria-label=\"m 07 transferredamount on mainnet can be drained if a malicious account can mint more tokens on schain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/38\">[M-07] <code>transferredAmount</code> on mainnet can be drained if a malicious account can mint more tokens on Schain</a></h2>\n<p><em>Submitted by kyliek, also found by cccz</em></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L45\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L45</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/tokens/ERC20OnChain.sol#L49-L50\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/tokens/ERC20OnChain.sol#L49-L50</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L95\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L95</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/tokens/ERC20OnChain.sol#L60-L63\">https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/tokens/ERC20OnChain.sol#L60-L63</a></p>\n<h3 id=\"impact-4\" style=\"position:relative;\"><a href=\"#impact-4\" aria-label=\"impact 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Anyone on Schain that is able to mint more tokens, other than the mint action from <code>postMessage</code> in <code>tokenManagerERC20</code> by bridging tokens over, can potentially drain the locked tokens in <code>transferredAmount</code> in <code>depositBoxERC20</code> on mainnet by calling exit with the same amount of tokens in <code>transferredAmount[schainHash][token]</code>.</p>\n<p>This will trap other users’ funds on sChain and lost those funds on mainnet to the malicious attacker.</p>\n<p>An example of proof of concept using <code>ERC20OnChian</code> is given below. This case may seem to be special as the deployer of the clone contract is malicious.  However, this is a potential risk that generalises to other custom contracts with any <code>mint</code> functionality.</p>\n<h3 id=\"proof-of-concept-with-erc20\" style=\"position:relative;\"><a href=\"#proof-of-concept-with-erc20\" aria-label=\"proof of concept with erc20 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept (with ERC20)</h3>\n<ul>\n<li>Malicious account deploys an ERC20 clone <code>ERC20OnChain</code> on Schain.</li>\n<li>By deployment, the malicious account is assigned the MINTER_ROLE on <code>ERC20OnChain</code> in the constructor.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    constructor(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string memory contractName,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string memory contractSymbol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    ) initializer</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        AccessControlEnumerableUpgradeable.__AccessControlEnumerable_init();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ERC20Upgradeable.__ERC20_init(contractName, contractSymbol);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        ERC20BurnableUpgradeable.__ERC20Burnable_init();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _setRoleAdmin(MINTER_ROLE, MINTER_ROLE);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _setupRole(MINTER_ROLE, _msgSender());</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<ul>\n<li>This ERC20 clone get registered on <code>tokenMangagerERC20.sol</code> by function <code>addERC20TokenByOwner</code>.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function addERC20TokenByOwner(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string calldata targetChainName,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address erc20OnMainChain,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address erc20OnSchain</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">     )</span></span></code></pre>\n<ul>\n<li>The malicious account wait for more users to deposit tokens on <code>depositBoxERC20.depositERC20</code>, which will increase the amount in <code>transferredAmount[schainHash][token]</code></li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function depositERC20(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        string calldata schainName,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address erc20OnMainnet,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span></code></pre>\n<ul>\n<li>Malicious account mint to his account the amount equal to <code>transferredAmount[schainHash][token]</code> on <code>ERC20OnChain</code></li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function mint(address account, uint256 value) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(hasRole(MINTER_ROLE, _msgSender()), &quot;Sender is not a Minter&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _mint(account, value);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<ul>\n<li>Malicious account calls <code>exitToMainERC20</code> in <code>TokenManagerERC20</code>.</li>\n</ul>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function exitToMainERC20(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        address contractOnMainnet,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 amount</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    )</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        external</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        override</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        communityLocker.checkAllowedToSendMessage(msg.sender);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _exit(MAINNET_HASH, depositBox, contractOnMainnet, msg.sender, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<ul>\n<li><code>transferredAmount[schainHash][token]</code> is drained to the malicious account on mainnet and victims’ tokens get stranded on schain.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Disable minting function to be called directly in <code>ERC20OnChain</code>. Only allow minting when bridging tokens over.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/38#issuecomment-1058709283\">cstrangedk (SKALE) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Issue is acknowledged and work is pending on the roadmap.  SKALE Chain owners must carefully manage MINTER_ROLE, and end-users carefully monitor role.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/38#issuecomment-1143850380\">GalloDaSballo (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>I believe the sponsor reply sheds further light into how the system will be used in 99% of cases.</p>\n<p>That said we have to judge the codebase for how it could be exploited and used by malicious actors, and I do agree with he warden that if the MINTER_ROLE is granted to someone (let’s say the admin) then they could use it to drain funds from the mainnet side of the bridge.</p>\n<p>Because this is contingent on setup and Admin Privilege, I believe Medium Severity to be more appropriate.</p>\n<p>Switching from a role based system to an immutable Minter Address (the bridge contract) can be used as mitigation, alternatively sChain end users will have to monitor for these types of changes and act accordingly</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-burner_role-can-burn-any-amount-of-etherc20-from-an-arbitrary-address\" style=\"position:relative;\"><a href=\"#m-08-burner_role-can-burn-any-amount-of-etherc20-from-an-arbitrary-address\" aria-label=\"m 08 burner_role can burn any amount of etherc20 from an arbitrary address permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/16\">[M-08] <code>BURNER_ROLE</code> can burn any amount of EthErc20 from an arbitrary address</a></h2>\n<p><em>Submitted by cccz, also found by 0x1f8b</em></p>\n<h3 id=\"impact-5\" style=\"position:relative;\"><a href=\"#impact-5\" aria-label=\"impact 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Impact</h3>\n<p>Same as  <a href=\"https://github.com/code-423n4/2022-01-livepeer-findings/issues/194\">https://github.com/code-423n4/2022-01-livepeer-findings/issues/194</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function forceBurn(address account, uint256 amount) external override {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(hasRole(BURNER_ROLE, _msgSender()), &quot;BURNER role is required&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        _burn(account, amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span></code></pre>\n<p>Using the forceBurn() function of EthErc20, an address with BURNER_ROLE can burn an arbitrary amount of tokens from any address.</p>\n<p>We believe this is unnecessary and poses a serious centralization risk.</p>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/tokens/EthErc20.sol#L64-L67\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/tokens/EthErc20.sol#L64-L67</a></p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Update forceBurn function for only owner can burn his tokens.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/16#issuecomment-1058516461\">cstrangedk (SKALE) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Issue is acknowledged and work is pending on the roadmap.  SKALE chain owners must carefully manage BURNER_ROLE, and end-users carefully monitor role.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/16#issuecomment-1143855354\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This finding boils down to the flexibility of the role system against a more immutable address being set on the constructor, ultimately the role is contingent on configuration and as such I believe the finding to be valid and of medium severity.</p>\n<p>In the majority of configurations this will be a non-issue, however end users may want to monitor how roles are set and how they change over time to avoid their tokens being burned</p>\n</blockquote>\n<hr>\n<h2 id=\"m-09-not-compatible-with-rebasingdeflationaryinflationary-tokens\" style=\"position:relative;\"><a href=\"#m-09-not-compatible-with-rebasingdeflationaryinflationary-tokens\" aria-label=\"m 09 not compatible with rebasingdeflationaryinflationary tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/50\">[M-09] Not compatible with Rebasing/Deflationary/Inflationary tokens</a></h2>\n<p><em>Submitted by 0x1f8b, also found by cmichel, kirk-baird, gzeon, and IllIllI</em></p>\n<p>The <code>DepositBoxERC20</code> contract do not appear to support rebasing/deflationary/inflationary tokens whose balance changes during transfers or over time. The necessary checks include at least verifying the amount of tokens transferred to contracts before and after the actual transfer to infer any fees/interest.</p>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Add support in contracts for such tokens before accepting user-supplied tokens\nConsider to check before/after balance on the vault.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/50#issuecomment-1062060382\">cstrangedk (SKALE) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Issue is acknowledged and is contingent on SKALE Chain owner configuration and evaluation of compatibile tokens.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/50#issuecomment-1143858483\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Because this is reliant on configuration, I believe the finding to be valid and of medium severity.</p>\n<p>End users can verify if the DepositBoxes are properly handling rebasing tokens at the time they wish to bridge</p>\n</blockquote>\n<hr>\n<h2 id=\"m-10-nft-owner-can-change-token-uri\" style=\"position:relative;\"><a href=\"#m-10-nft-owner-can-change-token-uri\" aria-label=\"m 10 nft owner can change token uri permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/26\">[M-10] NFT owner can change token URI</a></h2>\n<p><em>Submitted by cmichel</em></p>\n<p>In the <code>ERC721OnChain</code> implementation the <em>token owner</em> can set the token’s URI using <code>setTokenURI</code>.</p>\n<p>Usually, this is token URI points to data defining the NFT (attributes, images, etc.).\nIt’s usually set by the <em>contract</em> owner.\nA user that owns an NFT can just spoof any other NFT data by changing the token URI to any of the other NFTs.</p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Disallow the owner of an NFT to change its token URI</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/26#issuecomment-1064987630\">DimaStebaev (SKALE) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Acknowledged,<code>ERC721OnChain</code> is a default implementation. If the token is sensitive to URI change SKALE chain owner can use another one.\nNot all ERC721 require that URI can’t be changed.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/26#issuecomment-1143990919\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Because the argument for this being a setting can be made I am excluding a high severity.</p>\n<p>However the code was brought into scope, the implementation under scrutiny does allow the owner to change the URI which is a known admin privilege.</p>\n<p>For those reasons I believe the finding to be valid and of medium severity</p>\n</blockquote>\n<hr>\n<h2 id=\"m-11-loss-of-pending-messages-if-any-in-case-removeconnectedchain-is-called\" style=\"position:relative;\"><a href=\"#m-11-loss-of-pending-messages-if-any-in-case-removeconnectedchain-is-called\" aria-label=\"m 11 loss of pending messages if any in case removeconnectedchain is called permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/63\">[M-11] Loss of pending messages (if any) in case removeConnectedChain is called</a></h2>\n<p><em>Submitted by hubble</em></p>\n<p>If there are any unprocessed messages to be executed or processed, while removeConnectedChain is called, then they may be stuck from getting processed on the other end.\nIf these messages have transactions for any token transfer then it will get stuck or lost.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Contract : MessageProxy.sol\nLine : 313</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">    function removeConnectedChain(string memory schainName) public virtual override onlyChainConnector {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes32 schainHash = keccak256(abi.encodePacked(schainName));</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(connectedChains[schainHash].inited, &quot;Chain is not initialized&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        delete connectedChains[schainHash];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    } </span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Check if there are any pending or unprocessed messages while removeConnectedChain is called and revert in that case.\nBetter to implement some functionality like pause just locally for the chain to be removed, before the actual removeConnectedChain is called.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/63#issuecomment-1065005687\">DimaStebaev (SKALE) commented</a>:</strong></p>\n<blockquote>\n<p>It duplicates #57 </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/63#issuecomment-1144000708\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>I don’t believe this to be a duplicate.</p>\n<p>I think the finding is valid in that because of the synchronicity of broadcasting messages, the chain could be removed before it receives all messages.</p>\n<p>This is a risk that end users do face when interacting with the system and the only use case I could think of would be for a malicious admin to deny certain operations.</p>\n<p>That said I don’t believe there’s any easy solution as this would have to be addressed at the meta level.</p>\n<p>I do think the finding is valid and of medium severity</p>\n</blockquote>\n<p>cstrangedk (SKALE) commented:\nIssue is acknowledged and work is pending on the roadmap to prevent improper use of removeConnectedChain.</p>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 14 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/67\">report highlighted below</a> by <strong>defsec</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/34\">kirk-baird</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/29\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/51\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/45\">kyliek</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/56\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/2\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/32\">ye0lde</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/23\">cmichel</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/77\">0xwags</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/9\">jayjonah8</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/81\">leastwood</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/66\">rfa</a>, and <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/78\">kenta</a>.</em></p>\n<h2 id=\"l-01-front-runnable-initializers\" style=\"position:relative;\"><a href=\"#l-01-front-runnable-initializers\" aria-label=\"l 01 front runnable initializers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Front-runnable Initializers</h2>\n<p>All contract <strong>initializers</strong> were missing access controls, allowing any user to initialize the contract. By front-running the contract deployers to initialize the contract, the incorrect parameters may be supplied, leaving the contract needing to be redeployed.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Navigate to the following contracts.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"59\"></span><span class=\"grvsc-source\">https:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"60\"></span><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"54\"></span><span class=\"grvsc-source\">https:</span></span></code></pre>\n<ol start=\"2\">\n<li>initialize functions does not have access control. They are vulnerable to front-running.</li>\n</ol>\n<h3 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>While the code that can be run in contract constructors is limited, setting the owner in the contract’s constructor to the <code>msg.sender</code> and adding the <code>onlyOwner</code> modifier to all <strong>initializers</strong> would be a sufficient level of access control.</p>\n<h2 id=\"l-02-initializer-reentrancy-may-lead-to-double-initialization\" style=\"position:relative;\"><a href=\"#l-02-initializer-reentrancy-may-lead-to-double-initialization\" aria-label=\"l 02 initializer reentrancy may lead to double initialization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] Initializer reentrancy may lead to double initialization</h2>\n<p>Initializer functions that are invoked separate from contract creation (the most prominent example being minimal proxies) may be reentered if they make an untrusted non-view external call.</p>\n<p>Once an initializer has finished running it can never be re-executed. However, an exception put in place to support multiple inheritance made reentrancy possible in the scenario described above, breaking the expectation that there is a single execution.</p>\n<p>Note that upgradeable proxies are commonly initialized together with contract creation, where reentrancy is not feasible, so the impact of this issue is believed to be minor.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Go to contracts directory.</li>\n<li>On the package.json, openzeppelin 4.3.2 is defined.</li>\n</ol>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/package.json\">https://github.com/skalenetwork/ima-c4-audit/blob/main/package.json</a></p>\n<h3 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Avoid untrusted external calls during initialization.</p>\n<p>A fix is included in the version v4.4.1 of @openzeppelin/contracts and @openzeppelin/contracts-upgradeable.</p>\n<h3 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-9c22-pwxw-p6hx\">https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-9c22-pwxw-p6hx</a></p>\n<h2 id=\"l-03-erc1155supply-vulnerability-in-openzeppelin-contracts\" style=\"position:relative;\"><a href=\"#l-03-erc1155supply-vulnerability-in-openzeppelin-contracts\" aria-label=\"l 03 erc1155supply vulnerability in openzeppelin contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] ERC1155Supply vulnerability in OpenZeppelin Contracts</h2>\n<p>When ERC1155 tokens are minted, a callback is invoked on the receiver of those tokens, as required by the spec. When including the ERC1155Supply extension, total supply is not updated until after the callback, thus during the callback the reported total supply is lower than the real number of tokens in circulation.</p>\n<p>If a system relies on accurately reported supply, an attacker may be able to mint tokens and invoke that system after receiving the token balance but before the supply is updated.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Go to contracts directory.</li>\n<li>On the package.json, openzeppelin 4.3.2 is defined.</li>\n</ol>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/package.json\">https://github.com/skalenetwork/ima-c4-audit/blob/main/package.json</a></p>\n<h3 id=\"recommended-mitigation-steps-12\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-12\" aria-label=\"recommended mitigation steps 12 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>A fix is included in version 4.3.3 of @openzeppelin/contracts and @openzeppelin/contracts-upgradeable.</p>\n<h3 id=\"reference-1\" style=\"position:relative;\"><a href=\"#reference-1\" aria-label=\"reference 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h3>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-wmpv-c2jp-j2xg\">https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-wmpv-c2jp-j2xg</a></p>\n<h2 id=\"l-04-missing-zero-address-check-in-the-setter-functions-and-initialize-functions\" style=\"position:relative;\"><a href=\"#l-04-missing-zero-address-check-in-the-setter-functions-and-initialize-functions\" aria-label=\"l 04 missing zero address check in the setter functions and initialize functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-04] Missing zero-address check in the setter functions and initialize functions</h2>\n<p>Missing checks for zero-addresses may lead to infunctional protocol, if the variable addresses are updated incorrectly.</p>\n<h3 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Navigate to the following contracts.</li>\n</ol>\n<!---->\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-gutter-pad\"></span><span class=\"grvsc-gutter grvsc-line-number\" aria-hidden=\"true\" data-content=\"253\"></span><span class=\"grvsc-source\">https:</span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-13\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-13\" aria-label=\"recommended mitigation steps 13 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Consider adding zero-address checks in the discussed constructors:\nrequire(newAddr != address(0));.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/67#issuecomment-1066886133\">DimaStebaev (SKALE) commented</a>:</strong></p>\n<blockquote>\n<p>L-01 and L-02 is described in #2\nL-02: only SKALE chain owner are able to deploy smart contracts on it’s SKALE chain and this actor is assumed as trusted.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/67#issuecomment-1118619134\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<h3 id=\"l-01--front-runnable-initializers\" style=\"position:relative;\"><a href=\"#l-01--front-runnable-initializers\" aria-label=\"l 01  front runnable initializers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>L-01 : Front-runnable Initializers</h3>\n<p>Agree with finding in lack of any mitigation am marking this valid.\nFor the sponsor, this is how you can deploy and set data in one tx: <a href=\"https://github.com/Badger-Finance/badger-strategy-mix-v1/blob/c97eda8cb60d0dcfd62be956a2aab4c86353de65/contracts/proxy/AdminUpgradeabilityProxy.sol#L225\">https://github.com/Badger-Finance/badger-strategy-mix-v1/blob/c97eda8cb60d0dcfd62be956a2aab4c86353de65/contracts/proxy/AdminUpgradeabilityProxy.sol#L225</a></p>\n<h3 id=\"l-02--initializer-reentrancy-may-lead-to-double-initialization\" style=\"position:relative;\"><a href=\"#l-02--initializer-reentrancy-may-lead-to-double-initialization\" aria-label=\"l 02  initializer reentrancy may lead to double initialization permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>L-02 : Initializer reentrancy may lead to double initialization</h3>\n<p>Finding is valid, and mitigation is to upgrade to newer OZ code</p>\n<h3 id=\"l-03--erc1155supply-vulnerability-in-openzeppelin-contracts\" style=\"position:relative;\"><a href=\"#l-03--erc1155supply-vulnerability-in-openzeppelin-contracts\" aria-label=\"l 03  erc1155supply vulnerability in openzeppelin contracts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>L-03 : ERC1155Supply vulnerability in OpenZeppelin Contracts</h3>\n<p>Valid</p>\n<h3 id=\"l-04--missing-zero-address-check-in-the-setter-functions-and-initialize-functions\" style=\"position:relative;\"><a href=\"#l-04--missing-zero-address-check-in-the-setter-functions-and-initialize-functions\" aria-label=\"l 04  missing zero address check in the setter functions and initialize functions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>L-04 : Missing zero-address check in the setter functions and initialize functions</h3>\n<p>Agree</p>\n<p>e.g. -> Vulnerability in OZ -> See disclosure -> Upgrade to xyz</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/67#issuecomment-1147571670\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Making this the winner of QA Reports, mostly because it offers some unique findings in a proper QA Format.</p>\n<p>In terms of Findings Kirk-Baird is basically there, I ended up making this report win as it was submitted as QA rather than an aggregate of downgraded findings.</p>\n<p>That said I believe this report could have had a couple extra findings to make it truly a winner.</p>\n<p>L-01: Front-runnable Initializers -> Low</p>\n<p>L-02 : Initializer reentrancy may lead to double initialization -> Low</p>\n<p>L-03 : ERC1155Supply vulnerability in OpenZeppelin Contracts -> Low</p>\n<p>L-04 : Missing zero-address check in the setter functions and initialize functions -> Low</p>\n</blockquote>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 15 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/74\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/30\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/47\">TerrierLover</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/65\">saian</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/48\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/3\">robee</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/13\">m_smirnova2020</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/75\">rfa</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/60\">WatchPug</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/5\">d4rk</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/31\">ye0lde</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/55\">gzeon</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/61\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/79\">kenta</a>, and <a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/41\">kyliek</a>.</em></p>\n<p>To check the actual size of the reduction, <code>hardhat-gas-reporter</code> is used. ( <a href=\"https://www.npmjs.com/package/hardhat-gas-reporter\">https://www.npmjs.com/package/hardhat-gas-reporter</a> ). At each result, it lists how many size of the gas is reduced after the change.</p>\n<hr>\n<h4 id=\"mainnetcommunitypoolsol\" style=\"position:relative;\"><a href=\"#mainnetcommunitypoolsol\" aria-label=\"mainnetcommunitypoolsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>mainnet/CommunityPool.sol</code></h4>\n<hr>\n<h2 id=\"g-01-refundgasbyuser-function-can-use-unchecked-directory-and-slight-refactor-may-reduce-gas-fee\" style=\"position:relative;\"><a href=\"#g-01-refundgasbyuser-function-can-use-unchecked-directory-and-slight-refactor-may-reduce-gas-fee\" aria-label=\"g 01 refundgasbyuser function can use unchecked directory and slight refactor may reduce gas fee permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-01] <code>refundGasByUser</code> function can use unchecked directory and slight refactor may reduce gas fee.</h2>\n<p>By refactoring following code, it can reduce gas cost of <code>CommunityPool.sol</code>.\n<a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L97-L111\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L97-L111</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint amount = tx.gasprice * gas;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (amount &gt; _userWallets[user][schainHash]) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    amount = _userWallets[user][schainHash];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_userWallets[user][schainHash] = _userWallets[user][schainHash] - amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (!_balanceIsSufficient(schainHash, user, 0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    activeUsers[user][schainHash] = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    messageProxy.postOutgoingMessage(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainHash,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainLinks[schainHash],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Messages.encodeLockUserMessage(user)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">node.sendValue(amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">return (tx.gasprice * gas - amount) / tx.gasprice;</span></span></code></pre>\n<p>First, <code>_userWallets[user][schainHash] - amount</code> will never be less than 0 so can be wrapped by unchecked, since <code>amount</code> is always equal to or less than <code>_userWallets[user][schainHash]</code>.\nSecond, <code>(tx.gasprice * gas - amount) / tx.gasprice</code> will not underflown so can be wrapped by unchecked directory, since <code>tx.gasprice * gas - amount</code> will be equal to or more than 0.</p>\n<p>Here is an example of the modified code:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">uint amount = tx.gasprice * gas;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (amount &gt; _userWallets[user][schainHash]) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    amount = _userWallets[user][schainHash];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _userWallets[user][schainHash] = _userWallets[user][schainHash] - amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">if (!_balanceIsSufficient(schainHash, user, 0)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    activeUsers[user][schainHash] = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    messageProxy.postOutgoingMessage(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainHash,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainLinks[schainHash],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Messages.encodeLockUserMessage(user)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">node.sendValue(amount);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    return (tx.gasprice * gas - amount) / tx.gasprice;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>It simply wraps the above mentioned code with unchecked directory.</p>\n<p>Here is the comparison of the gas cost at CommunityPool.sol</p>\n<ul>\n<li>Before: 2114911</li>\n<li>After: 2100269</li>\n<li>Before - After: 14642 (About 0.6% reduction)</li>\n</ul>\n<hr>\n<h2 id=\"g-02-withdrawfunds-function-can-reduce-the-gas-cost-by-reordering-the-condition-of-if-statement\" style=\"position:relative;\"><a href=\"#g-02-withdrawfunds-function-can-reduce-the-gas-cost-by-reordering-the-condition-of-if-statement\" aria-label=\"g 02 withdrawfunds function can reduce the gas cost by reordering the condition of if statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-02] <code>withdrawFunds</code> function can reduce the gas cost by reordering the condition of if statement.</h2>\n<p>In the if statement, it calls <code>_balanceIsSufficient</code> function first.  But it can check <code>activeUsers[msg.sender][schainHash]</code> to reduce the gas cost slightly.\n<a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L174-L184\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L174-L184</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    !_balanceIsSufficient(schainHash, msg.sender, 0) &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    activeUsers[msg.sender][schainHash]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    activeUsers[msg.sender][schainHash] = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    messageProxy.postOutgoingMessage(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainHash,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainLinks[schainHash],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Messages.encodeLockUserMessage(msg.sender)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Here is an example of the modification.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">if (</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    activeUsers[msg.sender][schainHash] &amp;&amp;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    !_balanceIsSufficient(schainHash, msg.sender, 0)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    activeUsers[msg.sender][schainHash] = false;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    messageProxy.postOutgoingMessage(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainHash,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        schainLinks[schainHash],</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        Messages.encodeLockUserMessage(msg.sender)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Here is the comparison of the gas cost at CommunityPool.sol</p>\n<ul>\n<li>Before: 2114911</li>\n<li>After: 2113003</li>\n<li>Before - After: 1908 (About 0.09% reduction)</li>\n</ul>\n<hr>\n<h2 id=\"g-03-withdrawfunds-function-can-reduce-gas-cost-by-using-unchecked\" style=\"position:relative;\"><a href=\"#g-03-withdrawfunds-function-can-reduce-gas-cost-by-using-unchecked\" aria-label=\"g 03 withdrawfunds function can reduce gas cost by using unchecked permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-03] <code>withdrawFunds</code> function can reduce gas cost by using unchecked</h2>\n<p><code>_userWallets[msg.sender][schainHash] - amount</code> will never be less than 0, since it checks <code>amount &#x3C;= _userWallets[msg.sender][schainHash]</code> at require function.</p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L171-L173\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L171-L173</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(amount &lt;= _userWallets[msg.sender][schainHash], &quot;Balance is too low&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">require(!messageProxy.messageInProgress(), &quot;Message is in progress&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">_userWallets[msg.sender][schainHash] = _userWallets[msg.sender][schainHash] - amount;</span></span></code></pre>\n<p>Here is an example of the modification.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">require(amount &lt;= _userWallets[msg.sender][schainHash], &quot;Balance is too low&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">require(!messageProxy.messageInProgress(), &quot;Message is in progress&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    _userWallets[msg.sender][schainHash] = _userWallets[msg.sender][schainHash] - amount;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Here is the comparison of the gas cost at CommunityPool.sol</p>\n<ul>\n<li>Before: 2114911</li>\n<li>After: 2107176</li>\n<li>Before - After: 7735 (About 0.36% reduction)</li>\n</ul>\n<hr>\n<h4 id=\"mainnetmessageproxysol\" style=\"position:relative;\"><a href=\"#mainnetmessageproxysol\" aria-label=\"mainnetmessageproxysol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>mainnet/MessageProxy.sol</code></h4>\n<hr>\n<h2 id=\"g-04-i-can-be-wrapped-by-unchecked-directory\" style=\"position:relative;\"><a href=\"#g-04-i-can-be-wrapped-by-unchecked-directory\" aria-label=\"g 04 i can be wrapped by unchecked directory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G-04] <code>i++</code> can be wrapped by <code>unchecked</code> directory.</h2>\n<p><code>mainnet/MessageProxy.sol</code> and <code>mainnet/MessageProxyForMainnet.sol</code> contains for loop, but <code>i++</code> can be wrapped by unchecked directory to decrease the gas cost.</p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/MessageProxy.sol#L221\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/MessageProxy.sol#L221</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/MessageProxy.sol#L515\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/MessageProxy.sol#L515</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L118\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L118</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L235\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L235</a></p>\n<p>Here is an example of the modification.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">for (uint256 i = 0; i &lt; messages.length; ) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    data = abi.encodePacked(</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        data,</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes32(bytes20(messages[i].sender)),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        bytes32(bytes20(messages[i].destinationContract)),</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        messages[i].data</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    );</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    unchecked {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        i++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<p>Here is the comparison of the gas cost at MessageProxyForMainnet.sol</p>\n<ul>\n<li>Before: 3403300</li>\n<li>After: 3388788</li>\n<li>Before - After: 14512 (About 0.4% reduction)</li>\n</ul>\n<p>In addition to MessageProxy.sol, here are other opportunities to decrease gas cost by wrapping <code>i++</code> by unchecked directory at following files:</p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L175\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L175</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L100\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L100</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L100\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L100</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L276\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L276</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L76\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L76</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L260\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L260</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L79\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L79</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L275\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L275</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L398\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L398</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L444\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L444</a></p>\n<p><a href=\"https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L459\">https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L459</a></p>\n<hr>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/46#issuecomment-1066996556\">yavrsky (SKALE) commented</a>:</strong></p>\n<blockquote>\n<p>We prefer not to use “unchecked” for security reasons, even if it is applicable there. Also only marginal gas improvements.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/46#issuecomment-1112616638\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>To add #47 which is valued at 62500</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-02-skale-findings/issues/46#issuecomment-1118593584\">GalloDaSballo (judge) commented</a>:</strong></p>\n<blockquote>\n<p>G-01: Unchecked should save 20 gas per operation * 4 = 80 gas</p>\n<p>G-02: Valid but ultimately saves gas on the “bad path”</p>\n<p>G-03: Saves 20 gas</p>\n<p>G-04\nSaves 20 gas per iteration * 4 = 80</p>\n<p>11 * 20 = 220</p>\n<p>Additional gas saved:\n400</p>\n<p>Total Combined:\n62900</p>\n</blockquote>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-reentrancy-in-messageproxyforschain-leads-to-replay-attacks\">[H-01] Reentrancy in <code>MessageProxyForSchain</code> leads to replay attacks</a></li>\n<li><a href=\"#h-02-gas-pricing-can-be-used-to-extort-funds-from-users-of-schain-owner\">[H-02] Gas pricing can be used to extort funds from users of SChain owner</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-11\">Medium Risk Findings (11)</a></p>\n<ul>\n<li><a href=\"#m-01-transactions-can-be-replayed-when-a-connectedchain-is-removed-and-then-reconnected\">[M-01] Transactions can be replayed when a connectedChain is removed and then reconnected</a></li>\n<li><a href=\"#m-02-when-transferring-tokens-native-on-skale-to-ethereum-with-tokenmanagererc20exittomainerc20-the-tokens-on-the-schain-will-be-frozen-on-tokenmanagererc20-but-they-will-not-receive-tokens-on-ethereum\">[M-02] When transferring tokens native on SKALE to Ethereum with <code>TokenManagerERC20.exitToMainERC20()</code>, the tokens on the schain will be frozen on <code>TokenManagerERC20</code>, but they will not receive tokens on Ethereum</a></li>\n<li><a href=\"#m-03-s2s-transfer-from-the-origin-schain-to-another-schain-with-automatic-deploy-disabled-can-cause-funds-to-be-frozen\">[M-03] S2S Transfer from the origin schain to another schain with automatic deploy disabled can cause funds to be frozen</a></li>\n<li><a href=\"#m-04-tokenmanagererc20sol-uses-transferfrom-instead-of-safetransferfrom\">[M-04] TokenManagerERC20.sol uses transferFrom() instead of safeTransferFrom()</a></li>\n<li><a href=\"#m-05-schain-owners-can-rug-pull-users-funds\">[M-05] Schain owners can rug pull users’ funds</a></li>\n<li><a href=\"#m-06-centralisation-risk-admin-role-of-tokenmanagereth-can-rug-pull-all-eth-from-the-bridge\">[M-06] Centralisation risk: admin role of <code>TokenManagerEth</code> can rug pull all Eth from the bridge</a></li>\n<li><a href=\"#m-07-transferredamount-on-mainnet-can-be-drained-if-a-malicious-account-can-mint-more-tokens-on-schain\">[M-07] <code>transferredAmount</code> on mainnet can be drained if a malicious account can mint more tokens on Schain</a></li>\n<li><a href=\"#m-08-burner_role-can-burn-any-amount-of-etherc20-from-an-arbitrary-address\">[M-08] <code>BURNER_ROLE</code> can burn any amount of EthErc20 from an arbitrary address</a></li>\n<li><a href=\"#m-09-not-compatible-with-rebasingdeflationaryinflationary-tokens\">[M-09] Not compatible with Rebasing/Deflationary/Inflationary tokens</a></li>\n<li><a href=\"#m-10-nft-owner-can-change-token-uri\">[M-10] NFT owner can change token URI</a></li>\n<li><a href=\"#m-11-loss-of-pending-messages-if-any-in-case-removeconnectedchain-is-called\">[M-11] Loss of pending messages (if any) in case removeConnectedChain is called</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-front-runnable-initializers\">L-01 Front-runnable Initializers</a></li>\n<li><a href=\"#l-02-initializer-reentrancy-may-lead-to-double-initialization\">L-02 Initializer reentrancy may lead to double initialization</a></li>\n<li><a href=\"#l-03-erc1155supply-vulnerability-in-openzeppelin-contracts\">L-03 ERC1155Supply vulnerability in OpenZeppelin Contracts</a></li>\n<li><a href=\"#l-04-missing-zero-address-check-in-the-setter-functions-and-initialize-functions\">L-04 Missing zero-address check in the setter functions and initialize functions</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#g-01-refundgasbyuser-function-can-use-unchecked-directory-and-slight-refactor-may-reduce-gas-fee\">G-01 <code>refundGasByUser</code> function can use unchecked directory and slight refactor may reduce gas fee.</a></li>\n<li><a href=\"#g-02-withdrawfunds-function-can-reduce-the-gas-cost-by-reordering-the-condition-of-if-statement\">G-02 <code>withdrawFunds</code> function can reduce the gas cost by reordering the condition of if statement.</a></li>\n<li><a href=\"#g-03-withdrawfunds-function-can-reduce-gas-cost-by-using-unchecked\">G-03 <code>withdrawFunds</code> function can reduce gas cost by using unchecked</a></li>\n<li><a href=\"#g-04-i-can-be-wrapped-by-unchecked-directory\">G-04 <code>i++</code> can be wrapped by <code>unchecked</code> directory.</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the SKALE smart contract system written in Solidity. The audit contest took place between February 18—March 3 2022.\n\n## Wardens\n\n29 Wardens contributed reports to the SKALE contest:\n\n  1. [cmichel](https://twitter.com/cmichelio)\n  1. [kirk-baird](https://twitter.com/kirkthebaird)\n  1. [WatchPug](https://twitter.com/WatchPug_) ([jtp](https://github.com/jack-the-pug) and [ming](https://github.com/mingwatch))\n  1. [leastwood](https://twitter.com/liam_eastwood13)\n  1. hubble (ksk2345 and shri4net)\n  1. 0x1f8b\n  1. IllIllI\n  1. cccz\n  1. kyliek\n  1. [gzeon](https://twitter.com/gzeon)\n  1. [defsec](https://twitter.com/defsec_)\n  1. jayjonah8\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. robee\n  1. [ye0lde](https://twitter.com/_ye0lde)\n  1. TerrierLover\n  1. [rfa](https://www.instagram.com/riyan_rfa/)\n  1. kenta\n  1. saian\n  1. 0xwags\n  1. [CertoraInc](https://twitter.com/CertoraInc) (egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, and shakedwinder)\n  1. m_smirnova2020\n  1. d4rk\n  1. [Tomio](https://twitter.com/meidhiwirara)\n\nThis contest was judged by [Alex the Entreprenerd](https://twitter.com/GalloDaSballo).\n\nFinal report assembled by [itsmetechjay](https://twitter.com/itsmetechjay) and [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 13 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 11 received a risk rating in the category of MEDIUM severity. Of these, 2 HIGH severity and 1 MEDIUM severity item were mitigated by SKALE.\n\nAdditionally, C4 analysis included 14 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 15 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 SKALE contest repository](https://github.com/code-423n4/2022-02-skale), and is composed of 33 smart contracts written in the Solidity programming language and includes 2,679 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (2)\n## [[H-01] Reentrancy in `MessageProxyForSchain` leads to replay attacks](https://github.com/code-423n4/2022-02-skale-findings/issues/24)\n_Submitted by cmichel_\n\nThe `postIncomingMessages` function calls `_callReceiverContract(fromChainHash, messages[i], startingCounter + 1)` which gives control to a contract that is potentially attacker controlled *before* updating the `incomingMessageCounter`.\n\n```solidity\nfor (uint256 i = 0; i < messages.length; i++) {\n    // @audit re-entrant, can submit same postIncomingMessages again\n    _callReceiverContract(fromChainHash, messages[i], startingCounter + 1);\n}\nconnectedChains[fromChainHash].incomingMessageCounter += messages.length;\n```\n\nThe attacker can re-enter into the `postIncomingMessages` function and submit the same messages again, creating a replay attack.\nNote that the `startingCounter` is the way how messages are prevented from replay attacks here, there are no further nonces.\n\n### Proof of Concept\n\nAttacker can submit two cross-chain messages to be executed:\n\n1.  Transfer 1000 USDC\n2.  A call to their attacker-controlled contract, could be masked as a token contract that allows re-entrance on `transfer`.\n\nSome node submits the `postIncomingMessages(params)` transaction, transfers 1000 USDC, then calls the attackers contract, who can themself call `postIncomingMessages(params)` again, receive 1000 USDC a second time, and stop the recursion.\n\n### Recommended Mitigation Steps\n\nAdd a `messageInProgressLocker` modifier to `postIncomingMessages` as was done in `MessageProxyForMainnet`.\n\n**cstrangedk (SKALE) resolved:**\n\nResolved via https://github.com/skalenetwork/IMA/pull/1054\n\n\n***\n\n## [[H-02] Gas pricing can be used to extort funds from users of SChain owner](https://github.com/code-423n4/2022-02-skale-findings/issues/28)\n_Submitted by kirk-baird, also found by leastwood_\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L82-L112>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L235-L250>\n\n### Impact\n\nThe function `refundGasByUser()` can be exploited by the message sender to drain nodes and SChain owners of their balances when processing incoming messages.\n\nWhen a node collates a set of exits from an SChain to Ethereum, they are submitted on-chain via `MessageProxyForMainnet.sol`.  For each message to a registered contract the user is required to pay for the refund via `CommunityPool.refundGasByUser()`.\n\nThe issue occurs in `CommunityPool.refundGasByUser()`  as the amount to be refunded is calculated as `uint amount = tx.gasprice * gas;`, where `gas` is the gas used by the message. Since `tx.gasprice` is set by the node and there is no upper bounds on the price. Since EIP1559 the gas price is `BaseFee + Tip` and although `Base` is predetermined `Tip` is any arbitrary non-zero integer.\n\nThe attack is for a node to set an excessively high `tx.gasprice` which will be refunded out of the balance of the user who initiated the outgoing transaction or if that user has insufficient balance then from the SChain owner.  Since the node submitting the transaction is refunded for their gas they do not lose from setting a higher gas price.\n\nThe impact of the attack is that the user requesting the exit and/or the SChain owner may have their ETH balances depleted to refund the submitter. The impact is worsened as if the user has insufficient balance a message will be sent to the SChain preventing them from making further exits until they have sufficient balance.\n\nNote a similar issue may be seen in `IWallets.refundGasBySchain()` depending on how the gas calculations are performed (they are not in scope but the `TestWallet` also uses `tx.gasprice` in the same manner).\n\n### Proof of Concept\n\nProcessing incoming messages in `MessageProxyForMainnet.sol`\n\n```solidity\n        for (uint256 i = 0; i < messages.length; i++) {\n            gasTotal = gasleft();\n            if (isContractRegistered(bytes32(0), messages[i].destinationContract)) {\n                address receiver = _getGasPayer(fromSchainHash, messages[i], startingCounter + i);\n                _callReceiverContract(fromSchainHash, messages[i], startingCounter + i);\n                notReimbursedGas += communityPool.refundGasByUser(\n                    fromSchainHash,\n                    payable(msg.sender),\n                    receiver,\n                    gasTotal - gasleft() + additionalGasPerMessage\n                );\n            } else {\n                _callReceiverContract(fromSchainHash, messages[i], startingCounter + i);\n                notReimbursedGas += gasTotal - gasleft() + additionalGasPerMessage;\n            }\n        }\n```\n\nRefunding gas in `CommunityPool.sol`\n\n```solidity\n    function refundGasByUser(\n        bytes32 schainHash,\n        address payable node,\n        address user,\n        uint gas\n    )\n        external\n        override\n        onlyMessageProxy\n        returns (uint)\n    {\n        require(node != address(0), \"Node address must be set\");\n        if (!activeUsers[user][schainHash]) {\n            return gas;\n        }\n        uint amount = tx.gasprice * gas;\n        if (amount > _userWallets[user][schainHash]) {\n            amount = _userWallets[user][schainHash];\n        }\n        _userWallets[user][schainHash] = _userWallets[user][schainHash] - amount;\n        if (!_balanceIsSufficient(schainHash, user, 0)) {\n            activeUsers[user][schainHash] = false;\n            messageProxy.postOutgoingMessage(\n                schainHash,\n                schainLinks[schainHash],\n                Messages.encodeLockUserMessage(user)\n            );\n        }\n        node.sendValue(amount);\n        return (tx.gasprice * gas - amount) / tx.gasprice;\n    }\n```\n\n### Recommended Mitigation Steps\n\nOne solution to avoid excessive over refunding of gas fees is to use a gas price oracle rather than `tx.gasprice`.\n\nAn alternate solution is to set a maximum gas price and have some incentives for the node submitting at a gas price below the maximum.\n\n**[cstrangedk (SKALE) resolved](https://github.com/code-423n4/2022-02-skale-findings/issues/28#issuecomment-1176670089):**\n > Resolved via https://github.com/skalenetwork/IMA/pull/1165/\n***\n\n \n# Medium Risk Findings (11)\n## [[M-01] Transactions can be replayed when a connectedChain is removed and then reconnected](https://github.com/code-423n4/2022-02-skale-findings/issues/57)\n_Submitted by WatchPug, also found by cmichel_\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/MessageProxy.sol#L313-L317>\n\n```solidity\nfunction removeConnectedChain(string memory schainName) public virtual override onlyChainConnector {\n    bytes32 schainHash = keccak256(abi.encodePacked(schainName));\n    require(connectedChains[schainHash].inited, \"Chain is not initialized\");\n    delete connectedChains[schainHash];\n}\n```\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/MessageProxy.sol#L402-L409>\n\n```solidity\nfunction _addConnectedChain(bytes32 schainHash) internal onlyChainConnector {\n    require(!connectedChains[schainHash].inited,\"Chain is already connected\");\n    connectedChains[schainHash] = ConnectedChainInfo({\n        incomingMessageCounter: 0,\n        outgoingMessageCounter: 0,\n        inited: true\n    });\n}\n```\n\nIn the current implementation, when a connected chain is removed, the `incomingMessageCounter` and `outgoingMessageCounter` will be deleted.\n\nAnd if it's reconnected again, the `incomingMessageCounter` and `outgoingMessageCounter` will be reset to `0`.\n\nHowever, since the contract is using `connectedChains[fromChainHash].incomingMessageCounter` and `signature` to ensure that the message can only be processed once.\n\n### Impact\n\n1.  Once the `incomingMessageCounter` resets to `0`, all the past messages (transactions) can be replayed with the old signatures.\n\n2.  Another impact is that, for the particular reconnected schain, both inbound and outbound messages may not be able to be processed properly, as the counter is now out of sync with the remote schain.\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/MessageProxyForSchain.sol#L212-L221>\n\n```solidity\nrequire(\n    _verifyMessages(\n        _hashedArray(messages, startingCounter, fromChainName),\n        signature\n    ),\n    \"Signature is not verified\"\n);\nrequire(\n    startingCounter == connectedChains[fromChainHash].incomingMessageCounter,\n    \"Starting counter is not qual to incoming message counter\");\n```\n\n### Recommendation\n\nWhen removing and connecting a schain, instead of delete/reset the couter, consider leaving the counter as it is when `removeConnectedChain`, `_addConnectedChain` also should not reset the counter:\n\n```solidity\nfunction removeConnectedChain(string memory schainName) public virtual override onlyChainConnector {\n    bytes32 schainHash = keccak256(abi.encodePacked(schainName));\n    require(connectedChains[schainHash].inited, \"Chain is not initialized\");\n    connectedChains[targetChainHash].inited = false;\n}\n```\n\n```solidity\nfunction _addConnectedChain(bytes32 schainHash) internal onlyChainConnector {\n    require(!connectedChains[schainHash].inited,\"Chain is already connected\");\n    connectedChains[schainHash].inited = true;\n}\n```\n**[DimaStebaev (SKALE) disagreed with severity and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/57#issuecomment-1064177348):**\n> Acknowledged, and work is on the roadmap.\n\n**[GalloDaSballo (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/57#issuecomment-1143788390):**\n > I believe the finding to have validity, in that, a set of signed messages can be replayed if the chain is disconnected and then re-connected while maintaining the same validators.\n> \n> At this time I think Medium Severity (External Conditions Reliance) to be more appropriate and that the issue can be fully sidestepped by changing validators on a chain reconnect\n\n\n\n***\n\n## [[M-02] When transferring tokens native on SKALE to Ethereum with `TokenManagerERC20.exitToMainERC20()`, the tokens on the schain will be frozen on `TokenManagerERC20`, but they will not receive tokens on Ethereum](https://github.com/code-423n4/2022-02-skale-findings/issues/58)\n_Submitted by WatchPug_\n\nIn the current implementation of `TokenManagerERC20`, it allows `exitToMainERC20(tokenOnSchain, amount)`.\n\nAt L277 of `TokenManagerERC20.sol` in `exitToMainERC20()`, if `tokenOnSchain` is minted on SKALE schain natively, there are no such require statement that prevents the target chain being mainnet, eg: `require(chainHash != MAINNET_HASH, \"...\")`\n\nTherefore, a user can set mainnet as the target chain, and at L298 of `TokenManagerERC20.sol`, the tokens will be transferred to the contract, and at L308,  send message to Ethereum mainnet.\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L95-L104>\n\n```solidity\n    function exitToMainERC20(\n        address contractOnMainnet,\n        uint256 amount\n    )\n        external\n        override\n    {\n        communityLocker.checkAllowedToSendMessage(msg.sender);\n        _exit(MAINNET_HASH, depositBox, contractOnMainnet, msg.sender, amount);\n    }\n```\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L264-L313>\n\n```solidity\n    function _exit(\n        bytes32 chainHash,\n        address messageReceiver,\n        address contractOnMainChain,\n        address to,\n        uint256 amount\n    )\n        private\n    {\n        bool isMainChainToken;\n        ERC20BurnableUpgradeable contractOnSchain = clonesErc20[chainHash][contractOnMainChain];\n        if (address(contractOnSchain) == address(0)) {\n            contractOnSchain = ERC20BurnableUpgradeable(contractOnMainChain);\n            isMainChainToken = true;\n        }\n        require(address(contractOnSchain).isContract(), \"No token clone on schain\");\n        require(contractOnSchain.balanceOf(msg.sender) >= amount, \"Insufficient funds\");\n        require(\n            contractOnSchain.allowance(\n                msg.sender,\n                address(this)\n            ) >= amount,\n            \"Transfer is not approved by token holder\"\n        );\n        bytes memory data = Messages.encodeTransferErc20Message(address(contractOnMainChain), to, amount);\n        if (isMainChainToken) {\n            data = _receiveERC20(\n                chainHash,\n                address(contractOnSchain),\n                msg.sender,\n                amount\n            );\n            _saveTransferredAmount(chainHash, address(contractOnSchain), amount);\n            require(\n                contractOnSchain.transferFrom(msg.sender, address(this), amount),\n                \"Transfer was failed\"\n            );\n        } else {\n            require(\n                contractOnSchain.transferFrom(msg.sender, address(this), amount),\n                \"Transfer was failed\"\n            );\n            contractOnSchain.burn(amount);\n        }\n        messageProxy.postOutgoingMessage(\n            chainHash,\n            messageReceiver,\n            data\n        );\n    }\n```\n\nHowever, the `DepositBoxERC20` contract on Ethereum mainnet does not support such message from `TokenManagerERC20` on the schain:\n\nThe type of the message from schain `TokenManagerERC20` is `TRANSFER_ERC20_AND_TOKEN_INFO` (see L354 of TokenManagerERC20.sol) or `TRANSFER_ERC20_AND_TOTAL_SUPPLY` (see L362 of TokenManagerERC20.sol).\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L339-L370>\n\n```solidity\n    function _receiveERC20(\n        bytes32 chainHash,\n        address erc20OnMainChain,\n        address to,\n        uint256 amount\n    )\n        private\n        returns (bytes memory data)\n    {\n        ERC20BurnableUpgradeable erc20 = ERC20BurnableUpgradeable(erc20OnMainChain);\n        uint256 totalSupply = erc20.totalSupply();\n        require(amount <= totalSupply, \"Amount is incorrect\");\n        bool isERC20AddedToSchain = _schainToERC20[chainHash].contains(erc20OnMainChain);\n        if (!isERC20AddedToSchain) {\n            _addERC20ForSchain(chainHash, erc20OnMainChain);\n            data = Messages.encodeTransferErc20AndTokenInfoMessage(\n                erc20OnMainChain,\n                to,\n                amount,\n                _getErc20TotalSupply(erc20),\n                _getErc20TokenInfo(erc20)\n            );\n        } else {\n            data = Messages.encodeTransferErc20AndTotalSupplyMessage(\n                erc20OnMainChain,\n                to,\n                amount,\n                _getErc20TotalSupply(erc20)\n            );\n        }\n        emit ERC20TokenReady(chainHash, erc20OnMainChain, amount);\n    }\n```\n\n`DepositBoxERC20` on Ethereum MAINNET can only process `TRANSFER_ERC20`. (see DepositBoxERC20.sol L155 and Messages.sol L270)\n\nWhen getting a message with the type of `TRANSFER_ERC20_AND_TOKEN_INFO` or `TRANSFER_ERC20_AND_TOTAL_SUPPLY` from schain `TokenManagerERC20`, it will revert at L270 of Messages.sol.\n\nAs a result, the schain tokens will be frozen on TokenManagerERC20, but they will not receive tokens on Ethereum.\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L143-L164>\n\n```solidity\n    function postMessage(\n        bytes32 schainHash,\n        address sender,\n        bytes calldata data\n    )\n        external\n        override\n        onlyMessageProxy\n        whenNotKilled(schainHash)\n        checkReceiverChain(schainHash, sender)\n        returns (address)\n    {\n        Messages.TransferErc20Message memory message = Messages.decodeTransferErc20Message(data);\n        require(message.token.isContract(), \"Given address is not a contract\");\n        require(ERC20Upgradeable(message.token).balanceOf(address(this)) >= message.amount, \"Not enough money\");\n        _removeTransferredAmount(schainHash, message.token, message.amount);\n        require(\n            ERC20Upgradeable(message.token).transfer(message.receiver, message.amount),\n            \"Transfer was failed\"\n        );\n        return message.receiver;\n    }\n```\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/Messages.sol#L267-L272>\n\n```solidity\n    function decodeTransferErc20Message(\n        bytes calldata data\n    ) internal pure returns (TransferErc20Message memory) {\n        require(getMessageType(data) == MessageType.TRANSFER_ERC20, \"Message type is not ERC20 transfer\");\n        return abi.decode(data, (TransferErc20Message));\n    }\n```\n\n### Recommendation\n\nConsider preventing moving schain native tokens to Ethereum MAINNET, for example: Add `require(chainHash != MAINNET_HASH, \"...\")` near L277 of TokenManagerERC20.sol.\n\n\n**[cstrangedk (SKALE) disagreed with severity and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/58#issuecomment-1061027228):**\n > Valid issue, however disagree with severity as issue relates to `function incorrect as to spec`.  Suggest `low severity`.\n\n**[GalloDaSballo (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/58#issuecomment-1143798216):**\n > Let me reason through the finding:\n> -> The warden has shown a way for funds to be lost as long as a user uses a sChainNativeToken and burns them to bridge to mainnet (Potentially High)\n> \n> -> This is contingent on the configuration of the depositBoxErc20 (Potentially Med)\n> \n> I disagree with the sponsor argument in that while the code may not be as to spec, the functionality impaired as a medium to high impact.\n> \n> At this time I can rationalize the severity either as:\n> -> It should be High because the given codebase \"default\" functionality has this flaw\n> -> it should be Med because this is contingent on a configuration parameter\n> \n> Given the pre-context that the sChain could be set up by the admin to allow the misconfiguration to happen, at this time, I believe Medium Severity to be more appropriate as the impact is solely dependent upon the configuration of the chain which as explained in the readmes is mostly dependent on the admin.\n\n**[cstrangedk (SKALE) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/58#issuecomment-1195585103):**\n > Mitigated in [skalenetwork/IMA#1031](https://github.com/skalenetwork/IMA/pull/1031).\n\n\n\n***\n\n## [[M-03] S2S Transfer from the origin schain to another schain with automatic deploy disabled can cause funds to be frozen](https://github.com/code-423n4/2022-02-skale-findings/issues/59)\n_Submitted by WatchPug_\n\nWhen moving tokens that are native on the origin schain, to another schain, `TokenManagerERC20.sol#transferToSchainERC20()` will be called, which calls `_exit()` -> `_receiveERC20()`:\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L289-L301>\n\n```solidity\nif (isMainChainToken) {\n    data = _receiveERC20(\n        chainHash,\n        address(contractOnSchain),\n        msg.sender,\n        amount\n    );\n    _saveTransferredAmount(chainHash, address(contractOnSchain), amount);\n    require(\n        contractOnSchain.transferFrom(msg.sender, address(this), amount),\n        \"Transfer was failed\"\n    );\n}\n```\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L351-L361>\n\n```solidity\nbool isERC20AddedToSchain = _schainToERC20[chainHash].contains(erc20OnMainChain);\nif (!isERC20AddedToSchain) {\n    _addERC20ForSchain(chainHash, erc20OnMainChain);\n    data = Messages.encodeTransferErc20AndTokenInfoMessage(\n        erc20OnMainChain,\n        to,\n        amount,\n        _getErc20TotalSupply(erc20),\n        _getErc20TokenInfo(erc20)\n    );\n}\n```\n\nHowever, on the target schain, while handling the inbound message with `postMessage()` -> `_sendERC20()`, when `contractOnSchain` is `false`, The transaction will fail with `\"Automatic deploy is disabled\"` when `automaticDeploy == false`:\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/TokenManagers/TokenManagerERC20.sol#L227-L235>\n\n```solidity\n contractOnSchain = clonesErc20[fromChainHash][token];\n\nif (address(contractOnSchain) == address(0)) {\n    require(automaticDeploy, \"Automatic deploy is disabled\");\n    contractOnSchain = new ERC20OnChain(message.tokenInfo.name, message.tokenInfo.symbol);\n    clonesErc20[fromChainHash][token] = contractOnSchain;\n    addedClones[contractOnSchain] = true;\n    emit ERC20TokenCreated(fromChainHash, token, address(contractOnSchain));\n}\n```\n\nAs a result, any tokens that are locked in the origin schain by the user will be frozen in the contract.\n\n### Recommendation\n\nConsider adding a `mapping` storage to cache whether `automaticDeploy` is enabled on a certain schain, the cache should be updated once the `automaticDeploy` is updated.\n\nAnd only allows S2S transfer when `automaticDeploy` is enabled on the target schain.\n\nTo further avoid the edge case of: right after the user submitted the S2S transfer tx on the from schain, the target schain disabled `automaticDeploy` and the user's tokens can be frozen in the from schain. We can introduce a 24 hrs timelock for disabling `automaticDeploy`.\n\n**[cstrangedk (SKALE) disputed and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/59#issuecomment-1061273352):**\n> Issue raised is acknowledged and work is assigned on the roadmap.  SKALE Chain owners must ensure any mapped assets, either through manual or automatic mapping are compatible with their dApp(s). Manual mapping mode is the default mode for bridge operation. \n\n\n**[GalloDaSballo (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/59#issuecomment-1143799500):**\n > I agree with both sides of the argument, and because this is contingent on configuration and admin privilege, believe Medium Severity to be more appropriate\n\n\n\n***\n\n## [[M-04] TokenManagerERC20.sol uses transferFrom() instead of safeTransferFrom()](https://github.com/code-423n4/2022-02-skale-findings/issues/8)\n_Submitted by jayjonah8, also found by cmichel and IllIllI_\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L298>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L303>\n\n### Impact\n\nIn TokenManagerERC20.sol the \\_exit() function makes use of transferFrom() instead of using safeTransferFrom().   Tokens that don’t correctly implement the latest EIP20 spec will be unusable in the protocol as they revert the transaction because of the missing return value.\n\n### Proof of Concept\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L298>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/TokenManagers/TokenManagerERC20.sol#L303>\n\n### Recommended Mitigation Steps\n\nIt's recommended to use OpenZeppelin’s SafeERC20 versions with the safeTransfer and safeTransferFrom functions that handle the return value check as well as non-standard-compliant tokens.\n\n\n**[cstrangedk (SKALE) disputed, disagreed with severity and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/8#issuecomment-1058429459):**\n > Issue is acknowledged and work is pending on the roadmap. No loss of funds is possible, only revert txn. In the meantime, SKALE Chain owners at their discretion can expand the bridge compatibility to use safeTransfer functions. Owners must evaluate token compatibility.\n\n**[GalloDaSballo (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/8#issuecomment-1143815630):**\n > I believe that given the \"need for configuration\" the finding cannot be of High Severity. Additionally, the tx will revert as such no loss of funds is possible.\n> \n> The tokens that will cause a revert (e.g. USDT) will simply be unusable.\n> \n> While the argument for configuration is correct in de-escalating to Medium, I don't believe it exempts the code from being properly scrutinized.\n> \n> If a user were to configure their chain to use TokenManagerERC20 they'd have revert on non returning tokens, for that reason I believe Medium Severity to be appropriate as this is contingent on configuration\n\n\n\n***\n\n## [[M-05] Schain owners can rug pull users' funds](https://github.com/code-423n4/2022-02-skale-findings/issues/71)\n_Submitted by IllIllI, also found by gzeon and kirk-baird_\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxEth.sol#L138-L142>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L196-L200>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L183-L187>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L261-L271>\n\n### Impact\n\nOnce a chain has been killed the chain owner is able to call `getFunds()` on each of the deposit boxes and transfer funds/tokens wherever he/she wishes\n\nEven if the owner is benevolent the fact that there is a rug vector available may [negatively impact the protocol's reputation](https://twitter.com/RugDocIO/status/1411732108029181960). See [this](https://github.com/code-423n4/2021-08-realitycards-findings/issues/73) example where a similar finding has been flagged as a high-severity issue. I've downgraded these instances to be a medium since it requires cooperation of the IMA mainnet admin.\n\n### Proof of Concept\n\n```solidity\n    function getFunds(string calldata schainName, address payable receiver, uint amount)\n        external\n        override\n        onlySchainOwner(schainName)\n        whenKilled(keccak256(abi.encodePacked(schainName)))\n```\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxEth.sol#L138-L142>\n\n```solidity\n    function getFunds(string calldata schainName, address erc20OnMainnet, address receiver, uint amount)\n        external\n        override\n        onlySchainOwner(schainName)\n        whenKilled(keccak256(abi.encodePacked(schainName)))\n```\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L196-L200>\n\n```solidity\n    function getFunds(string calldata schainName, address erc721OnMainnet, address receiver, uint tokenId)\n        external\n        override\n        onlySchainOwner(schainName)\n        whenKilled(keccak256(abi.encodePacked(schainName)))\n```\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L183-L187>\n\n```solidity\n    function getFunds(\n        string calldata schainName,\n        address erc1155OnMainnet,\n        address receiver,\n        uint256[] memory ids,\n        uint256[] memory amounts\n    )\n        external\n        override\n        onlySchainOwner(schainName)\n        whenKilled(keccak256(abi.encodePacked(schainName)))\n```\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L261-L271>\n\n### Recommended Mitigation Steps\n\nAdd a long time lock for killing so users have plenty of time to get their funds out before a kill\n\n\n**[DimaStebaev (SKALE) disputed and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/71#issuecomment-1065153957):**\n > Acknowledged, and timelock & eventual removal has been added to the roadmap\n > This is not a vulnerability.\n> We explicitly added this functionality to prevent loosing of funds in case of technical problems with SKALE chain. It requires SKALE chain owner and SKALE foundation cooperation to run this mechanism.\n> It is going to be removed eventually after some time of stable work.\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/71#issuecomment-1143867079):**\n > While I empathize with the sponsor's side that the function is meant as a security mechanism, it does allow the chainOwner to pull all funds and transfer them to their own wallet.\n> \n> Because this is contingent on Admin Privilege, I believe Medium Severity to be appropriate\n\n\n\n***\n\n## [[M-06] Centralisation risk: admin role of `TokenManagerEth` can rug pull all Eth from the bridge](https://github.com/code-423n4/2022-02-skale-findings/issues/35)\n_Submitted by kirk-baird_\n\nThere is a Centralisation risk of the bridge where the `DEFAULT_ADMIN_ROLE` of `TokenManagerEth.sol` is able to modify the ERC20 token on the SChain to any arbitrary address. This would allow the admin role to change the address to one where they have infinite supply, they could then call `exitToMain(amount)` equal to the balance of the DepositBox in the main Ethereum chain. After the message is process on the main Ethereum chain they will receive the entire Eth balance of that contract.\n\nThe rug pull attack occurs because there is a `DEFAULT_ADMIN_ROLE` which is set in the intiialisation to the `msg.sender` as seen in `initializeTokenManager()` below.\n\nThe `DEFAULT_ADMIN_ROLE` may then call `setEthErc20Address(IEthErc20 newEthErc20Address)`  setting `newEthErc20Address` to any arbitrary contract they control.\n\n### Proof of Concept\n\n        function setEthErc20Address(IEthErc20 newEthErc20Address) external override {\n            require(hasRole(DEFAULT_ADMIN_ROLE, msg.sender), \"Not authorized caller\");\n            require(ethErc20 != newEthErc20Address, \"Must be new address\");\n            ethErc20 = newEthErc20Address;\n        }\n\n<!---->\n\n        function initializeTokenManager(\n            string memory newSchainName,\n            IMessageProxyForSchain newMessageProxy,\n            ITokenManagerLinker newIMALinker,\n            ICommunityLocker newCommunityLocker,\n            address newDepositBox\n        )\n            public\n            virtual\n            initializer\n        {\n            require(newDepositBox != address(0), \"DepositBox address has to be set\");\n\n            AccessControlEnumerableUpgradeable.__AccessControlEnumerable_init();\n            _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);\n            _setupRole(AUTOMATIC_DEPLOY_ROLE, msg.sender);\n            _setupRole(TOKEN_REGISTRAR_ROLE, msg.sender);\n\n            schainHash = keccak256(abi.encodePacked(newSchainName));\n            messageProxy = newMessageProxy;\n            tokenManagerLinker = newIMALinker;\n            communityLocker = newCommunityLocker;        \n            depositBox = newDepositBox;\n\n            emit DepositBoxWasChanged(address(0), newDepositBox);\n        }\n\n### Recommended Mitigation Steps\n\nConsider removing the function `setEthErc20Address()` as `ethErc20` is set in the `initialize()` function and does not need to be changed.\n\n\n**[DimaStebaev (SKALE) disagreed with severity and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/35#issuecomment-1064199292):**\n > Acknowledged, and this can be done only by SKALE chain owner. \n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/35#issuecomment-1144015873):**\n > Agree that the admin has the ability to rug users and agree with Med Severity\n\n\n\n***\n\n## [[M-07] `transferredAmount` on mainnet can be drained if a malicious account can mint more tokens on Schain](https://github.com/code-423n4/2022-02-skale-findings/issues/38)\n_Submitted by kyliek, also found by cccz_\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L45>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/tokens/ERC20OnChain.sol#L49-L50>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L95>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/11d6a6ae5bf16af552edd75183791375e501915f/contracts/schain/tokens/ERC20OnChain.sol#L60-L63>\n\n### Impact\n\nAnyone on Schain that is able to mint more tokens, other than the mint action from `postMessage` in `tokenManagerERC20` by bridging tokens over, can potentially drain the locked tokens in `transferredAmount` in `depositBoxERC20` on mainnet by calling exit with the same amount of tokens in `transferredAmount[schainHash][token]`.\n\nThis will trap other users' funds on sChain and lost those funds on mainnet to the malicious attacker.\n\nAn example of proof of concept using `ERC20OnChian` is given below. This case may seem to be special as the deployer of the clone contract is malicious.  However, this is a potential risk that generalises to other custom contracts with any `mint` functionality.\n\n### Proof of Concept (with ERC20)\n\n*   Malicious account deploys an ERC20 clone `ERC20OnChain` on Schain.\n\n*   By deployment, the malicious account is assigned the MINTER_ROLE on `ERC20OnChain` in the constructor.\n\n<!---->\n\n        constructor(\n            string memory contractName,\n            string memory contractSymbol\n        ) initializer\n        {\n            AccessControlEnumerableUpgradeable.__AccessControlEnumerable_init();\n            ERC20Upgradeable.__ERC20_init(contractName, contractSymbol);\n            ERC20BurnableUpgradeable.__ERC20Burnable_init();\n            _setRoleAdmin(MINTER_ROLE, MINTER_ROLE);\n            _setupRole(MINTER_ROLE, _msgSender());\n        }\n\n*   This ERC20 clone get registered on `tokenMangagerERC20.sol` by function `addERC20TokenByOwner`.\n\n<!---->\n\n        function addERC20TokenByOwner(\n            string calldata targetChainName,\n            address erc20OnMainChain,\n            address erc20OnSchain\n         )\n\n*   The malicious account wait for more users to deposit tokens on `depositBoxERC20.depositERC20`, which will increase the amount in `transferredAmount[schainHash][token]`\n\n<!---->\n\n        function depositERC20(\n            string calldata schainName,\n            address erc20OnMainnet,\n            uint256 amount\n        )\n\n*   Malicious account mint to his account the amount equal to `transferredAmount[schainHash][token]` on `ERC20OnChain`\n\n<!---->\n\n        function mint(address account, uint256 value) external override {\n            require(hasRole(MINTER_ROLE, _msgSender()), \"Sender is not a Minter\");\n            _mint(account, value);\n        }\n\n*   Malicious account calls `exitToMainERC20` in `TokenManagerERC20`.\n\n<!---->\n\n        function exitToMainERC20(\n            address contractOnMainnet,\n            uint256 amount\n        )\n            external\n            override\n        {\n            communityLocker.checkAllowedToSendMessage(msg.sender);\n            _exit(MAINNET_HASH, depositBox, contractOnMainnet, msg.sender, amount);\n        }\n\n*   `transferredAmount[schainHash][token]` is drained to the malicious account on mainnet and victims' tokens get stranded on schain.\n\n### Recommended Mitigation Steps\n\nDisable minting function to be called directly in `ERC20OnChain`. Only allow minting when bridging tokens over.\n\n\n**[cstrangedk (SKALE) disputed and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/38#issuecomment-1058709283):**\n > Issue is acknowledged and work is pending on the roadmap.  SKALE Chain owners must carefully manage MINTER_ROLE, and end-users carefully monitor role.\n\n\n**[GalloDaSballo (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/38#issuecomment-1143850380):**\n > I believe the sponsor reply sheds further light into how the system will be used in 99% of cases.\n> \n> That said we have to judge the codebase for how it could be exploited and used by malicious actors, and I do agree with he warden that if the MINTER_ROLE is granted to someone (let's say the admin) then they could use it to drain funds from the mainnet side of the bridge.\n> \n> Because this is contingent on setup and Admin Privilege, I believe Medium Severity to be more appropriate.\n> \n> Switching from a role based system to an immutable Minter Address (the bridge contract) can be used as mitigation, alternatively sChain end users will have to monitor for these types of changes and act accordingly\n\n\n\n***\n\n## [[M-08] `BURNER_ROLE` can burn any amount of EthErc20 from an arbitrary address](https://github.com/code-423n4/2022-02-skale-findings/issues/16)\n_Submitted by cccz, also found by 0x1f8b_\n\n### Impact\n\nSame as  <https://github.com/code-423n4/2022-01-livepeer-findings/issues/194>\n\n        function forceBurn(address account, uint256 amount) external override {\n            require(hasRole(BURNER_ROLE, _msgSender()), \"BURNER role is required\");\n            _burn(account, amount);\n        }\n\nUsing the forceBurn() function of EthErc20, an address with BURNER_ROLE can burn an arbitrary amount of tokens from any address.\n\nWe believe this is unnecessary and poses a serious centralization risk.\n\n### Proof of Concept\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/tokens/EthErc20.sol#L64-L67>\n\n### Recommended Mitigation Steps\n\nUpdate forceBurn function for only owner can burn his tokens.\n\n\n**[cstrangedk (SKALE) disputed and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/16#issuecomment-1058516461):**\n > Issue is acknowledged and work is pending on the roadmap.  SKALE chain owners must carefully manage BURNER_ROLE, and end-users carefully monitor role.\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/16#issuecomment-1143855354):**\n > This finding boils down to the flexibility of the role system against a more immutable address being set on the constructor, ultimately the role is contingent on configuration and as such I believe the finding to be valid and of medium severity.\n> \n> In the majority of configurations this will be a non-issue, however end users may want to monitor how roles are set and how they change over time to avoid their tokens being burned\n\n\n\n***\n\n## [[M-09] Not compatible with Rebasing/Deflationary/Inflationary tokens](https://github.com/code-423n4/2022-02-skale-findings/issues/50)\n_Submitted by 0x1f8b, also found by cmichel, kirk-baird, gzeon, and IllIllI_\n\nThe `DepositBoxERC20` contract do not appear to support rebasing/deflationary/inflationary tokens whose balance changes during transfers or over time. The necessary checks include at least verifying the amount of tokens transferred to contracts before and after the actual transfer to infer any fees/interest.\n\n### Recommended Mitigation Steps\n\nAdd support in contracts for such tokens before accepting user-supplied tokens\nConsider to check before/after balance on the vault.\n\n**[cstrangedk (SKALE) disputed and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/50#issuecomment-1062060382):**\n > Issue is acknowledged and is contingent on SKALE Chain owner configuration and evaluation of compatibile tokens.\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/50#issuecomment-1143858483):**\n > Because this is reliant on configuration, I believe the finding to be valid and of medium severity.\n> \n> End users can verify if the DepositBoxes are properly handling rebasing tokens at the time they wish to bridge\n\n\n\n***\n\n## [[M-10] NFT owner can change token URI](https://github.com/code-423n4/2022-02-skale-findings/issues/26)\n_Submitted by cmichel_\n\nIn the `ERC721OnChain` implementation the *token owner* can set the token's URI using `setTokenURI`.\n\nUsually, this is token URI points to data defining the NFT (attributes, images, etc.).\nIt's usually set by the *contract* owner.\nA user that owns an NFT can just spoof any other NFT data by changing the token URI to any of the other NFTs.\n\n### Recommended Mitigation Steps\n\nDisallow the owner of an NFT to change its token URI\n\n\n**[DimaStebaev (SKALE) disputed and commented](https://github.com/code-423n4/2022-02-skale-findings/issues/26#issuecomment-1064987630):**\n > Acknowledged,`ERC721OnChain` is a default implementation. If the token is sensitive to URI change SKALE chain owner can use another one.\n> Not all ERC721 require that URI can't be changed.\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/26#issuecomment-1143990919):**\n > Because the argument for this being a setting can be made I am excluding a high severity.\n> \n> However the code was brought into scope, the implementation under scrutiny does allow the owner to change the URI which is a known admin privilege.\n> \n> For those reasons I believe the finding to be valid and of medium severity\n\n\n\n***\n\n## [[M-11] Loss of pending messages (if any) in case removeConnectedChain is called](https://github.com/code-423n4/2022-02-skale-findings/issues/63)\n_Submitted by hubble_\n\nIf there are any unprocessed messages to be executed or processed, while removeConnectedChain is called, then they may be stuck from getting processed on the other end.\nIf these messages have transactions for any token transfer then it will get stuck or lost.\n\n### Proof of Concept\n\nContract : MessageProxy.sol\nLine : 313\n\n        function removeConnectedChain(string memory schainName) public virtual override onlyChainConnector {\n            bytes32 schainHash = keccak256(abi.encodePacked(schainName));\n            require(connectedChains[schainHash].inited, \"Chain is not initialized\");\n            delete connectedChains[schainHash];\n        } \n\n### Recommended Mitigation Steps\n\nCheck if there are any pending or unprocessed messages while removeConnectedChain is called and revert in that case.\nBetter to implement some functionality like pause just locally for the chain to be removed, before the actual removeConnectedChain is called.\n\n\n**[DimaStebaev (SKALE) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/63#issuecomment-1065005687):**\n > It duplicates #57 \n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/63#issuecomment-1144000708):**\n > I don't believe this to be a duplicate.\n> \n> I think the finding is valid in that because of the synchronicity of broadcasting messages, the chain could be removed before it receives all messages.\n> \n> This is a risk that end users do face when interacting with the system and the only use case I could think of would be for a malicious admin to deny certain operations.\n> \n> That said I don't believe there's any easy solution as this would have to be addressed at the meta level.\n> \n> I do think the finding is valid and of medium severity\n\ncstrangedk (SKALE) commented:\nIssue is acknowledged and work is pending on the roadmap to prevent improper use of removeConnectedChain.\n\n\n\n\n***\n\n\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 14 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-02-skale-findings/issues/67) by **defsec** received the top score from the judge.\n\n*The following wardens also submitted reports: [kirk-baird](https://github.com/code-423n4/2022-02-skale-findings/issues/34), [0x1f8b](https://github.com/code-423n4/2022-02-skale-findings/issues/29), [csanuragjain](https://github.com/code-423n4/2022-02-skale-findings/issues/51), [kyliek](https://github.com/code-423n4/2022-02-skale-findings/issues/45), [gzeon](https://github.com/code-423n4/2022-02-skale-findings/issues/56), [robee](https://github.com/code-423n4/2022-02-skale-findings/issues/2), [ye0lde](https://github.com/code-423n4/2022-02-skale-findings/issues/32), [cmichel](https://github.com/code-423n4/2022-02-skale-findings/issues/23), [0xwags](https://github.com/code-423n4/2022-02-skale-findings/issues/77), [jayjonah8](https://github.com/code-423n4/2022-02-skale-findings/issues/9), [leastwood](https://github.com/code-423n4/2022-02-skale-findings/issues/81), [rfa](https://github.com/code-423n4/2022-02-skale-findings/issues/66), and [kenta](https://github.com/code-423n4/2022-02-skale-findings/issues/78).*\n\n## [L-01] Front-runnable Initializers\n\nAll contract **initializers** were missing access controls, allowing any user to initialize the contract. By front-running the contract deployers to initialize the contract, the incorrect parameters may be supplied, leaving the contract needing to be redeployed.\n\n### Proof of Concept\n\n1.  Navigate to the following contracts.\n\n```\nhttps://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L59\n\nhttps://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/SkaleManagerClient.sol#L54\n\n```\n\n2.  initialize functions does not have access control. They are vulnerable to front-running.\n\n### Recommended Mitigation Steps\n\nWhile the code that can be run in contract constructors is limited, setting the owner in the contract's constructor to the `msg.sender` and adding the `onlyOwner` modifier to all **initializers** would be a sufficient level of access control.\n\n## [L-02] Initializer reentrancy may lead to double initialization\n\nInitializer functions that are invoked separate from contract creation (the most prominent example being minimal proxies) may be reentered if they make an untrusted non-view external call.\n\nOnce an initializer has finished running it can never be re-executed. However, an exception put in place to support multiple inheritance made reentrancy possible in the scenario described above, breaking the expectation that there is a single execution.\n\nNote that upgradeable proxies are commonly initialized together with contract creation, where reentrancy is not feasible, so the impact of this issue is believed to be minor.\n\n### Proof of Concept\n\n1.  Go to contracts directory.\n\n2.  On the package.json, openzeppelin 4.3.2 is defined.\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/package.json>\n\n### Recommended Mitigation Steps\n\nAvoid untrusted external calls during initialization.\n\nA fix is included in the version v4.4.1 of @openzeppelin/contracts and @openzeppelin/contracts-upgradeable.\n\n### Reference\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-9c22-pwxw-p6hx>\n\n## [L-03] ERC1155Supply vulnerability in OpenZeppelin Contracts\n\nWhen ERC1155 tokens are minted, a callback is invoked on the receiver of those tokens, as required by the spec. When including the ERC1155Supply extension, total supply is not updated until after the callback, thus during the callback the reported total supply is lower than the real number of tokens in circulation.\n\nIf a system relies on accurately reported supply, an attacker may be able to mint tokens and invoke that system after receiving the token balance but before the supply is updated.\n\n### Proof of Concept\n\n1.  Go to contracts directory.\n\n2.  On the package.json, openzeppelin 4.3.2 is defined.\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/package.json>\n\n\n### Recommended Mitigation Steps\n\nA fix is included in version 4.3.3 of @openzeppelin/contracts and @openzeppelin/contracts-upgradeable.\n\n### Reference\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-wmpv-c2jp-j2xg>\n\n## [L-04] Missing zero-address check in the setter functions and initialize functions\n\nMissing checks for zero-addresses may lead to infunctional protocol, if the variable addresses are updated incorrectly.\n\n### Proof of Concept\n\n1.  Navigate to the following contracts.\n\n<!---->\n\n    https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/schain/CommunityLocker.sol#L253\n\n### Recommended Mitigation Steps\n\nConsider adding zero-address checks in the discussed constructors:\nrequire(newAddr != address(0));.\n\n**[DimaStebaev (SKALE) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/67#issuecomment-1066886133):**\n > L-01 and L-02 is described in #2 \n> L-02: only SKALE chain owner are able to deploy smart contracts on it's SKALE chain and this actor is assumed as trusted.\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/67#issuecomment-1118619134):**\n> ### L-01 : Front-runnable Initializers\n> Agree with finding in lack of any mitigation am marking this valid.\n> For the sponsor, this is how you can deploy and set data in one tx: https://github.com/Badger-Finance/badger-strategy-mix-v1/blob/c97eda8cb60d0dcfd62be956a2aab4c86353de65/contracts/proxy/AdminUpgradeabilityProxy.sol#L225\n> \n> ### L-02 : Initializer reentrancy may lead to double initialization\n> Finding is valid, and mitigation is to upgrade to newer OZ code\n> \n> \n> ### L-03 : ERC1155Supply vulnerability in OpenZeppelin Contracts\n> Valid\n> \n> \n> ### L-04 : Missing zero-address check in the setter functions and initialize functions\n> Agree\n> \n> e.g. -> Vulnerability in OZ -> See disclosure -> Upgrade to xyz\n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/67#issuecomment-1147571670):**\n > Making this the winner of QA Reports, mostly because it offers some unique findings in a proper QA Format.\n> \n> In terms of Findings Kirk-Baird is basically there, I ended up making this report win as it was submitted as QA rather than an aggregate of downgraded findings.\n> \n> That said I believe this report could have had a couple extra findings to make it truly a winner.\n> \n> L-01: Front-runnable Initializers -> Low\n> \n> L-02 : Initializer reentrancy may lead to double initialization -> Low\n> \n> L-03 : ERC1155Supply vulnerability in OpenZeppelin Contracts -> Low\n> \n> L-04 : Missing zero-address check in the setter functions and initialize functions -> Low\n\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 15 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-02-skale-findings/issues/74) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [0x1f8b](https://github.com/code-423n4/2022-02-skale-findings/issues/30), [TerrierLover](https://github.com/code-423n4/2022-02-skale-findings/issues/47), [saian](https://github.com/code-423n4/2022-02-skale-findings/issues/65), [CertoraInc](https://github.com/code-423n4/2022-02-skale-findings/issues/48), [robee](https://github.com/code-423n4/2022-02-skale-findings/issues/3), [m_smirnova2020](https://github.com/code-423n4/2022-02-skale-findings/issues/13), [rfa](https://github.com/code-423n4/2022-02-skale-findings/issues/75), [WatchPug](https://github.com/code-423n4/2022-02-skale-findings/issues/60), [d4rk](https://github.com/code-423n4/2022-02-skale-findings/issues/5), [ye0lde](https://github.com/code-423n4/2022-02-skale-findings/issues/31), [gzeon](https://github.com/code-423n4/2022-02-skale-findings/issues/55), [Tomio](https://github.com/code-423n4/2022-02-skale-findings/issues/61), [kenta](https://github.com/code-423n4/2022-02-skale-findings/issues/79), and [kyliek](https://github.com/code-423n4/2022-02-skale-findings/issues/41).*\n\nTo check the actual size of the reduction, `hardhat-gas-reporter` is used. ( <https://www.npmjs.com/package/hardhat-gas-reporter> ). At each result, it lists how many size of the gas is reduced after the change.\n\n***\n\n#### `mainnet/CommunityPool.sol`\n\n***\n\n## [G-01] `refundGasByUser` function can use unchecked directory and slight refactor may reduce gas fee.\n\nBy refactoring following code, it can reduce gas cost of `CommunityPool.sol`.\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L97-L111>\n\n    uint amount = tx.gasprice * gas;\n    if (amount > _userWallets[user][schainHash]) {\n        amount = _userWallets[user][schainHash];\n    }\n    _userWallets[user][schainHash] = _userWallets[user][schainHash] - amount;\n    if (!_balanceIsSufficient(schainHash, user, 0)) {\n        activeUsers[user][schainHash] = false;\n        messageProxy.postOutgoingMessage(\n            schainHash,\n            schainLinks[schainHash],\n            Messages.encodeLockUserMessage(user)\n        );\n    }\n    node.sendValue(amount);\n    return (tx.gasprice * gas - amount) / tx.gasprice;\n\nFirst, `_userWallets[user][schainHash] - amount` will never be less than 0 so can be wrapped by unchecked, since `amount` is always equal to or less than `_userWallets[user][schainHash]`.\nSecond, `(tx.gasprice * gas - amount) / tx.gasprice` will not underflown so can be wrapped by unchecked directory, since `tx.gasprice * gas - amount` will be equal to or more than 0.\n\nHere is an example of the modified code:\n\n    uint amount = tx.gasprice * gas;\n    if (amount > _userWallets[user][schainHash]) {\n        amount = _userWallets[user][schainHash];\n    }\n    unchecked {\n        _userWallets[user][schainHash] = _userWallets[user][schainHash] - amount;\n    }\n    if (!_balanceIsSufficient(schainHash, user, 0)) {\n        activeUsers[user][schainHash] = false;\n        messageProxy.postOutgoingMessage(\n            schainHash,\n            schainLinks[schainHash],\n            Messages.encodeLockUserMessage(user)\n        );\n    }\n    node.sendValue(amount);\n    unchecked {\n        return (tx.gasprice * gas - amount) / tx.gasprice;\n    }\n\nIt simply wraps the above mentioned code with unchecked directory.\n\nHere is the comparison of the gas cost at CommunityPool.sol\n\n*   Before: 2114911\n*   After: 2100269\n*   Before - After: 14642 (About 0.6% reduction)\n\n***\n\n## [G-02] `withdrawFunds` function can reduce the gas cost by reordering the condition of if statement.\n\nIn the if statement, it calls `_balanceIsSufficient` function first.  But it can check `activeUsers[msg.sender][schainHash]` to reduce the gas cost slightly.\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L174-L184>\n\n    if (\n        !_balanceIsSufficient(schainHash, msg.sender, 0) &&\n        activeUsers[msg.sender][schainHash]\n    ) {\n        activeUsers[msg.sender][schainHash] = false;\n        messageProxy.postOutgoingMessage(\n            schainHash,\n            schainLinks[schainHash],\n            Messages.encodeLockUserMessage(msg.sender)\n        );\n    }\n\nHere is an example of the modification.\n\n    if (\n        activeUsers[msg.sender][schainHash] &&\n        !_balanceIsSufficient(schainHash, msg.sender, 0)\n    ) {\n        activeUsers[msg.sender][schainHash] = false;\n        messageProxy.postOutgoingMessage(\n            schainHash,\n            schainLinks[schainHash],\n            Messages.encodeLockUserMessage(msg.sender)\n        );\n    }\n\nHere is the comparison of the gas cost at CommunityPool.sol\n\n*   Before: 2114911\n*   After: 2113003\n*   Before - After: 1908 (About 0.09% reduction)\n\n***\n\n## [G-03] `withdrawFunds` function can reduce gas cost by using unchecked\n\n`_userWallets[msg.sender][schainHash] - amount` will never be less than 0, since it checks `amount <= _userWallets[msg.sender][schainHash]` at require function.\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/CommunityPool.sol#L171-L173>\n\n    require(amount <= _userWallets[msg.sender][schainHash], \"Balance is too low\");\n    require(!messageProxy.messageInProgress(), \"Message is in progress\");\n    _userWallets[msg.sender][schainHash] = _userWallets[msg.sender][schainHash] - amount;\n\nHere is an example of the modification.\n\n    require(amount <= _userWallets[msg.sender][schainHash], \"Balance is too low\");\n    require(!messageProxy.messageInProgress(), \"Message is in progress\");\n    unchecked {\n        _userWallets[msg.sender][schainHash] = _userWallets[msg.sender][schainHash] - amount;\n    }\n\nHere is the comparison of the gas cost at CommunityPool.sol\n\n*   Before: 2114911\n*   After: 2107176\n*   Before - After: 7735 (About 0.36% reduction)\n\n***\n\n#### `mainnet/MessageProxy.sol`\n\n***\n\n## [G-04] `i++` can be wrapped by `unchecked` directory.\n\n`mainnet/MessageProxy.sol` and `mainnet/MessageProxyForMainnet.sol` contains for loop, but `i++` can be wrapped by unchecked directory to decrease the gas cost.\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/MessageProxy.sol#L221>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/MessageProxy.sol#L515>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L118>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/MessageProxyForMainnet.sol#L235>\n\nHere is an example of the modification.\n\n    for (uint256 i = 0; i < messages.length; ) {\n        data = abi.encodePacked(\n            data,\n            bytes32(bytes20(messages[i].sender)),\n            bytes32(bytes20(messages[i].destinationContract)),\n            messages[i].data\n        );\n        unchecked {\n            i++;\n        }\n    }\n\nHere is the comparison of the gas cost at MessageProxyForMainnet.sol\n\n*   Before: 3403300\n*   After: 3388788\n*   Before - After: 14512 (About 0.4% reduction)\n\nIn addition to MessageProxy.sol, here are other opportunities to decrease gas cost by wrapping `i++` by unchecked directory at following files:\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L175>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L100>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/Linker.sol#L100>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC20.sol#L276>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L76>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC721.sol#L260>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L79>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L275>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L398>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L444>\n\n<https://github.com/skalenetwork/ima-c4-audit/blob/main/contracts/mainnet/DepositBoxes/DepositBoxERC1155.sol#L459>\n\n***\n\n**[yavrsky (SKALE) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/46#issuecomment-1066996556):**\n > We prefer not to use \"unchecked\" for security reasons, even if it is applicable there. Also only marginal gas improvements.\n> \n> \n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/46#issuecomment-1112616638):**\n > To add #47 which is valued at 62500\n> \n> \n\n**[GalloDaSballo (judge) commented](https://github.com/code-423n4/2022-02-skale-findings/issues/46#issuecomment-1118593584):**\n > G-01: Unchecked should save 20 gas per operation * 4 = 80 gas\n> \n> G-02: Valid but ultimately saves gas on the \"bad path\"\n> \n> G-03: Saves 20 gas\n> \n> G-04\n> Saves 20 gas per iteration * 4 = 80\n> \n> 11 * 20 = 220\n> \n> Additional gas saved:\n> 400\n> \n> Total Combined:\n> 62900\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}