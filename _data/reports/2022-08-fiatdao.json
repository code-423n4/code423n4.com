{
  "circa": {
    "title": "FIAT DAO veFDT contest",
    "sponsor": "FIAT DAO",
    "slug": "2022-08-fiatdao",
    "date": "2022-10-03",
    "findings": "https://github.com/code-423n4/2022-08-fiatdao-findings/issues",
    "contest": 154
  },
  "html": "<h1 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h1>\n<h2 id=\"about-c4\" style=\"position:relative;\"><a href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>About C4</h2>\n<p>Code4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.</p>\n<p>A C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>\n<p>During the audit contest outlined in this document, C4 conducted an analysis of the FIAT DAO veFDT smart contract system written in Solidity. The audit contest took place between August 12—August 15 2022.</p>\n<p>Following the C4 audit contest, warden IllIllI reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit contest report. </p>\n<h2 id=\"wardens\" style=\"position:relative;\"><a href=\"#wardens\" aria-label=\"wardens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wardens</h2>\n<p>135 Wardens contributed reports to the FIAT DAO veFDT contest:</p>\n<ol>\n<li><a href=\"https://twitter.com/RespxR\">Respx</a></li>\n<li><a href=\"https://twitter.com/CertoraInc\">CertoraInc</a> (egjlmn1, <a href=\"https://twitter.com/ori_dabush\">OriDabush</a>, ItayG, shakedwinder, and RoiEvenHaim)</li>\n<li>scaraven</li>\n<li>ak1</li>\n<li><a href=\"https://twitter.com/jonataspvt\">jonatascm</a></li>\n<li><a href=\"https://twitter.com/andyfeili\">oyc_109</a></li>\n<li>reassor</li>\n<li>KIntern_NA (TrungOre and duc)</li>\n<li>cryptphi</li>\n<li>JohnSmith</li>\n<li>PwnedNoMore (<a href=\"https://www.cs.purdue.edu/homes/zhan3299/index.html\">izhuer</a>, ItsNio, and papr1ka2)</li>\n<li>0x1f8b</li>\n<li><a href=\"https://twitter.com/csanuragjain\">csanuragjain</a></li>\n<li>DecorativePineapple</li>\n<li><a href=\"twitter.com/rokinot\">rokinot</a></li>\n<li>CodingNameKiki</li>\n<li>0xSky</li>\n<li>cccz</li>\n<li>ayeslick</li>\n<li>Noah3o6</li>\n<li>Waze</li>\n<li>pedr02b2</li>\n<li>peritoflores</li>\n<li>IllIllI</li>\n<li>cRat1st0s</li>\n<li>ladboy233</li>\n<li>rvierdiiev</li>\n<li>robee</li>\n<li>d3e4</li>\n<li><a href=\"https://twitter.com/CAA1994\">carlitox477</a></li>\n<li><a href=\"https://twitter.com/JoeStakey\">joestakey</a></li>\n<li><a href=\"https://twitter.com/BowTiedDravee\">Dravee</a></li>\n<li><a href=\"https://github.com/Aymen1001\">Aymen0909</a></li>\n<li><a href=\"https://twitter.com/Deivitto\">Deivitto</a></li>\n<li>auditor0517</li>\n<li><a href=\"https://twitter.com/bin2chen\">bin2chen</a></li>\n<li>wagmi</li>\n<li>0xf15ers (remora and twojoy)</li>\n<li><a href=\"https://twitter.com/tabishjshaikh\">tabish</a></li>\n<li>yixxas</li>\n<li><a href=\"https://twitter.com/defsec_\">defsec</a></li>\n<li>ajtra</li>\n<li><a href=\"https://milotruck.github.io/\">MiloTruck</a></li>\n<li>bobirichman</li>\n<li><a href=\"https://t.me/pfahard\">pfapostol</a></li>\n<li>Bnke0x0</li>\n<li><a href=\"https://twitter.com/0xNazgul\">0xNazgul</a></li>\n<li><a href=\"https://twitter.com/ret2basic\">ret2basic</a></li>\n<li>Rolezn</li>\n<li><a href=\"https://twitter.com/gallodasballo\">GalloDaSballo</a></li>\n<li>ellahi</li>\n<li><a href=\"https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219\">gogo</a></li>\n<li><a href=\"https://twitter.com/sm4rtcontr4ct\">JC</a></li>\n<li>ReyAdmirado</li>\n<li><a href=\"https://twitter.com/c3ph_\">c3phas</a></li>\n<li><a href=\"https://mobile.twitter.com/tomj_bb\">TomJ</a></li>\n<li>PaludoX0</li>\n<li>0xLovesleep</li>\n<li>0xDjango</li>\n<li>paribus</li>\n<li>RedOneN</li>\n<li>ElKu</li>\n<li>Junnon</li>\n<li>sikorico</li>\n<li>__141345__</li>\n<li>mics</li>\n<li><a href=\"https://github.com/lyciumlee\">durianSausage</a></li>\n<li>brgltd</li>\n<li><a href=\"https://instagram.com/vanensurya\">Funen</a></li>\n<li>rbserver</li>\n<li>simon135</li>\n<li>LeoS</li>\n<li>erictee</li>\n<li><a href=\"https://twitter.com/mehmeddukov\">medikko</a></li>\n<li><a href=\"https://twitter.com/Sm4rty_\">Sm4rty</a></li>\n<li>apostle0x01</li>\n<li><a href=\"https://chom.dev\">Chom</a></li>\n<li>0xNineDec</li>\n<li>delfin454000</li>\n<li><a href=\"https://twitter.com/a12jmx\">a12jmx</a></li>\n<li>0xbepresent</li>\n<li><a href=\"https://twitter.com/0xruhum\">Ruhum</a></li>\n<li>djxploit</li>\n<li><a href=\"https://twitter.com/natzuu33\">natzuu</a></li>\n<li>asutorufos</li>\n<li>sach1r0</li>\n<li>bulej93</li>\n<li><a href=\"https://twitter.com/ROHANJH56009256\">Rohan16</a></li>\n<li>Yiko</li>\n<li><a href=\"https://twitter.com/father0fBl0cks\">fatherOfBlocks</a></li>\n<li>0x52</li>\n<li>Bahurum</li>\n<li>RoiEvenHaim</li>\n<li>neumo</li>\n<li>0xmatt</li>\n<li><a href=\"https://twitter.com/seynixyz\">seyni</a></li>\n<li>p_crypt0</li>\n<li><a href=\"https://medium.com/@saneryee-studio\">saneryee</a></li>\n<li>Vexjon</li>\n<li><a href=\"https://github.com/exd0tpy\">exd0tpy</a></li>\n<li>Lambda</li>\n<li>0xsolstars (<a href=\"twitter.com/versatile_crypt\">Varun_Verma</a> and masterchief)</li>\n<li>byndooa</li>\n<li><a href=\"http://seanseefried.org/blog\">sseefried</a></li>\n<li><a href=\"https://twitter.com/WahWaste\">wastewa</a></li>\n<li><a href=\"https://t.me/Road220\">m_Rassska</a></li>\n<li>newfork01</li>\n<li><a href=\"https://twitter.com/meidhiwirara\">Tomio</a></li>\n<li><a href=\"https://twitter.com/0xSmartContract\">0xSmartContract</a></li>\n<li>Amithuddar</li>\n<li>jag</li>\n<li>0x040</li>\n<li>Metatron</li>\n<li>saian</li>\n<li>sashik_eth</li>\n<li>0xHarry</li>\n<li>2997ms</li>\n<li><a href=\"https://twitter.com/0xheynacho\">ignacio</a></li>\n<li>SooYa</li>\n<li><a href=\"https://twitter.com/GerdusM\">gerdusx</a></li>\n<li>SpaceCake</li>\n<li>0xackermann</li>\n<li>chrisdior4</li>\n<li>CRYP70</li>\n<li><a href=\"https://twitter.com/fitraldys\">Fitraldys</a></li>\n<li>NoamYakov</li>\n</ol>\n<p>This contest was judged by <a href=\"https://github.com/gititGoro\">Justin Goro</a>.</p>\n<p>Mitigations reviewed by IllIllI.</p>\n<p>Final report assembled by <a href=\"https://twitter.com/liveactionllama\">liveactionllama</a>.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>The C4 analysis yielded an aggregated total of 10 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 8 received a risk rating in the category of MEDIUM severity.</p>\n<p>Additionally, C4 analysis included 93 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 93 reports recommending gas optimizations.</p>\n<p>All of the issues presented here are linked back to their original finding.</p>\n<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope</h1>\n<p>The code under review can be found within the <a href=\"https://github.com/code-423n4/2022-08-fiatdao\">C4 FIAT DAO veFDT contest repository</a>, and is composed of 5 smart contracts and interfaces written in the Solidity programming language and includes 746 lines of Solidity code.</p>\n<h1 id=\"severity-criteria\" style=\"position:relative;\"><a href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Severity Criteria</h1>\n<p>C4 assesses the severity of disclosed vulnerabilities according to a methodology based on <a href=\"https://owasp.org/www-community/OWASP_Risk_Rating_Methodology\">OWASP standards</a>.</p>\n<p>Vulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.</p>\n<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>\n<ul>\n<li>Malicious Input Handling</li>\n<li>Escalation of privileges</li>\n<li>Arithmetic</li>\n<li>Gas use</li>\n</ul>\n<p>Further information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href=\"https://code4rena.com\">the C4 website</a>.</p>\n<h1 id=\"high-risk-findings-2\" style=\"position:relative;\"><a href=\"#high-risk-findings-2\" aria-label=\"high risk findings 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Risk Findings (2)</h1>\n<h2 id=\"h-01-unsafe-usage-of-erc20-transfer-and-transferfrom-\" style=\"position:relative;\"><a href=\"#h-01-unsafe-usage-of-erc20-transfer-and-transferfrom-\" aria-label=\"h 01 unsafe usage of erc20 transfer and transferfrom  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231\">[H-01] Unsafe usage of ERC20 transfer and transferFrom </a></h2>\n<p><em>Submitted by CertoraInc, also found by 0x1f8b, 0xSky, CodingNameKiki, DecorativePineapple, jonatascm, Noah3o6, oyc_109, pedr02b2, peritoflores, and Waze</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L425-L428\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L425-L428</a><br>\n<a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L485-L488\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L485-L488</a><br>\n<a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L546\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L546</a><br>\n<a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L657\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L657</a><br>\n<a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L676\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L676</a><br></p>\n<p>Some ERC20 tokens functions don’t return a boolean, for example USDT, BNB, OMG. So the <code>VotingEscrow</code> contract simply won’t work with tokens like that as the <code>token</code>.</p>\n<h3 id=\"proof-of-concept\" style=\"position:relative;\"><a href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The USDT’s <code>transfer</code> and <code>transferFrom</code> functions doesn’t return a bool, so the call to these functions will revert although the user has enough balance and the <code>VotingEscrow</code> contract won’t work, assuming that token is USDT.</p>\n<h3 id=\"tools-used\" style=\"position:relative;\"><a href=\"#tools-used\" aria-label=\"tools used permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual auditing - VS Code, some hardhat tests and me :)</p>\n<h3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Use the OpenZepplin’s <code>safeTransfer</code> and <code>safeTransferFrom</code> functions.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1216336341\">lacoop6tu (FIAT DAO) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>In our case the token is a BalancerV2 Pool Token which returns the boolean</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1232382424\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This should be acknowledged, not disputed, since there is nothing in documentation suggesting the token is inherently safe to use. </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1241595744\">elnilz (FIAT DAO) commented</a>:</strong></p>\n<blockquote>\n<p>@Justin Goro it’s a no-issue in our specific case bc we will use VotingEscrow in combination with <code>token</code> which returns bool upon transfer/transferFrom. So at best this is a QA issue bc we should document that. some wardens actually asked us about what token we will be using pointing out the issue.</p>\n<p>Now even if you’d want to award wardens who reported the issue it should then be a Med Risk bc if VotingEscrow is deployed with an unsafe <code>token</code> ppl would simply not be able to deposit into the contract but no funds would be at risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1242096432\">elnilz (FIAT DAO) commented</a>:</strong></p>\n<blockquote>\n<p>Fyi, even though we don’t think this is an issue, we will make use of safeTransfer and safeTransferFrom so its a helpful submission nonetheless.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1242900816\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>It’s tokens like BNB that led me to maintain the high risk rating. For BNB, transferFrom returns a bool but transfer doesn’t. In other words, users can stake but not unstake on any protocol that doesn’t use safeTransfer.</p>\n<p>I agree that wardens should contact sponsors but it’s not a channel we can really monitor. So although the net result is a documentation fix rather than a bug fix, it’s a documentation fix informed by the identification of a potentially show stopping bug rather than something like “Comment typo: it should be Bitcoin, not bit coin”.</p>\n</blockquote>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor disputed the issue because the token it’s planned to be used with does correctly return a boolean. However, the sponsor decided to make a change to address the finding as <a href=\"https://github.com/fiatdao/veFDT/pull/19/files/9d532c58e30e9730050fe26dd82bb4c293691001\">Issue 18</a>. The fix properly replaces the <code>require()</code> statements that check for successful transfers, with calls to OpenZeppelin’s <code>safeTransfer()</code>. The PR also replaces the internal definition of the <code>IERC20</code> interface with OpenZeppelin’s version. The prior version of the code’s <code>IERC20</code> included the function <code>decimals()</code>, which is not one of the required functions for the interface, so it’s possible for the code to encounter a token without this function, but it would be immediately apparent what happened because the constructor is the function that calls <code>decimals()</code>. The change to using OpenZeppelin required making this distinction more visible due to the fact that they’re defined separately as <code>IERC20</code> and <code>IERC20Metadata</code>. The new code is not checking that the token actually supports the function (e.g. using a <code>safeDecimals()</code>-like function), but it is not any worse off that it had been prior to the change.</p>\n</blockquote>\n<hr>\n<h2 id=\"h-02-delegators-can-avoid-lock-commitments-if-they-can-reliably-get-themselves-blocked-when-needed\" style=\"position:relative;\"><a href=\"#h-02-delegators-can-avoid-lock-commitments-if-they-can-reliably-get-themselves-blocked-when-needed\" aria-label=\"h 02 delegators can avoid lock commitments if they can reliably get themselves blocked when needed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204\">[H-02] Delegators can Avoid Lock Commitments if they can Reliably get Themselves Blocked when Needed</a></h2>\n<p><em>Submitted by Respx</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L526-L625\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L526-L625</a><br></p>\n<p>Users can enjoy the voting power of long lock times whilst not committing their tokens. This could cause the entire system to break down as the incentives don’t work any more.</p>\n<h3 id=\"exploit-method\" style=\"position:relative;\"><a href=\"#exploit-method\" aria-label=\"exploit method permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploit Method</h3>\n<p>This exploit only works if a user is able to use the system and reliably get themselves blocked. Blocking policies are not in scope, so I am assuming there would be a list of bannable offences, and thus this condition could be fulfilled.<br>\nConsider a user with two accounts, called Rider and Horse.<br>\nRider has 100,000 tokens.<br>\nHorse has 1 token.<br>\nRider is a smart contract (required for an account to be bannable).<br>\nRider locks for 1 week.<br>\nHorse locks for 52 weeks.<br>\nRider delegates to Horse.<br>\nHorse can continue to extend its lock period and enjoy the maximised voting power.<br>\nWhenever the user wants their tokens back, they simply need to get the Rider account blocked.<br>\nWhen Rider is blocked, <code>Blocklist.block(RiderAddress)</code> is called, which in turn calls <code>ve.forceUndelegate(RiderAddress)</code>.<br>\nRider is now an undelegated account with an expired lock. It can call <code>ve.withdraw()</code> to get its tokens back.<br>\nThe user can repeat this process with a fresh account taking the role of Rider.</p>\n<h3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p><code>forceUndelegate()</code> could be made to set <code>locked_.end = fromLocked.end</code>. This would mean that blocked users are still locked into the system for the period they delegated for. However, this does have the downside of tokens being locked in the system without the full rights of the system which other users enjoy.<br>\nAlternatively, this might be addressable through not blocking users that seem to be doing this, but of course that might have other undersirable consequences.</p>\n<h3 id=\"proof-of-concept-1\" style=\"position:relative;\"><a href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Please see warden’s <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204\">full report</a> for proof of concept.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204#issuecomment-1217847907\">lacoop6tu (FIAT DAO) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p><code>2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204#issuecomment-1236040176\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Well spotted by warden! The inflation of voting points may lead to an exploit, depending on possible proposals. Severity maintained.</p>\n</blockquote>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor disagreed with the severity and the judge updated the issue to be of Medium risk, and I agree with that severity. The finding was addressed via the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/11/files/01aa495c4127d44025e442421a2d58256ee36f06\">Issue 6</a> where the sponsor implemented the suggestion of the warden, to use the delegatee’s lock endpoint in the re-delegation to self, rather than using the delegator’s existing endpoint, since that endpoint may be far in the past. The delegate() and undelegate() functions have checks to ensure that the target for the votes always has at least as long a duration as the source of the votes. The fix enforces the same requirement for <code>forceUndelegate()</code> by assigning a longer duration.</p>\n</blockquote>\n<blockquote>\n<p>There are only two places in the code that change <code>LockedBalance.end</code> to a smaller value, which could possibly violate the contract invariants: in <a href=\"https://github.com/fiatdao/veFDT/blob/01aa495c4127d44025e442421a2d58256ee36f06/contracts/VotingEscrow.sol#L646-L651\"><code>quitLock()</code></a> where the struct is never written back to storage, and in <a href=\"https://github.com/fiatdao/veFDT/blob/01aa495c4127d44025e442421a2d58256ee36f06/contracts/VotingEscrow.sol#L537-L541\"><code>withdraw()</code></a> where it is indeed written back to storage. However, if the delegatee was able to withdraw, that means the delegator already would have been able to withdraw (since the delegatee’s timestamp must always be greater than or equal to the delegator’s when <a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md#delegate\">delegating</a> or <a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md#increaseamount\">increasing</a>), and therefore the mitigation is correct. The only extra wrinkle that the change makes, is that it now allows a malicious delegatee to front-run a delegator’s block with an <code>increaseUnlock(MAXTIME)</code>, but it’s not clear what advantage that would give the delegatee, and furthermore, the delegator already put his/her trust in the delegatee, so it’s something that could have occurred anyway, even without a call to <code>forceUndelegate()</code>.</p>\n</blockquote>\n<hr>\n<h1 id=\"medium-risk-findings-8\" style=\"position:relative;\"><a href=\"#medium-risk-findings-8\" aria-label=\"medium risk findings 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Medium Risk Findings (8)</h1>\n<h2 id=\"m-01-the-current-implementation-of-the-votingescrow-contract-doesnt-support-fee-on-transfer-tokens\" style=\"position:relative;\"><a href=\"#m-01-the-current-implementation-of-the-votingescrow-contract-doesnt-support-fee-on-transfer-tokens\" aria-label=\"m 01 the current implementation of the votingescrow contract doesnt support fee on transfer tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229\">[M-01] The current implementation of the VotingEscrow contract doesn’t support fee on transfer tokens</a></h2>\n<p><em>Submitted by CertoraInc, also found by cccz, csanuragjain, jonatascm, and scaraven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L418\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L418</a></p>\n<p>Some ERC20 tokens implemented so a fee is taken when transferring them, for example <code>STA</code> and <code>PAXG</code>. The current implementation of the <code>VotingEscrow</code> contract will mess up the accounting of the locked amounts if <code>token</code> will be a token like that, what will lead to a state where users won’t be able to receive their funds.</p>\n<p>This will happen because the value that is added to the locked amount is not the actual value received by the contract, but the value supplied by the user (the value which the fee is taken from).</p>\n<h3 id=\"proof-of-concept-2\" style=\"position:relative;\"><a href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The <code>STA</code> token burns 1% of the value provided to the <code>transfer</code> function, which means the recipient gets only 99% of the transferred asset. Let’s assume that <code>token</code> is the address of the <code>STA</code> token.</p>\n<ol>\n<li>Bob wants to lock 100 STA tokens and calls <code>createLock(100 * 10**18, unlockTime)</code>.</li>\n<li>The addition to the locked amount variable is done with <code>100 * 10**18</code>, while the actual amount that was received by the contract is <code>99 * 10**18</code>.</li>\n<li>When the lock expires Bob will try to withdraw his tokens, and the transfer function will be called with the accounted locked amount (which is <code>100 * 10**18</code>). This might succeed due to other users locking too, so the transferred tokens will be taken from “their tokens”, but in the end there will be users left without an option to withdraw their funds, because the balance of the contract will be less than the locked amount that the contract is trying to transfer.</li>\n</ol>\n<h3 id=\"tools-used-1\" style=\"position:relative;\"><a href=\"#tools-used-1\" aria-label=\"tools used 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual auditing - VS Code and me :)</p>\n<h3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Calculate the amount to add to the locked amount by the difference between the balances before and after the transfer instead of using the supplied value.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229#issuecomment-1216715477\">lacoop6tu (FIAT DAO) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>In our case, the token will be BalancerV2 Pool Token , which has no fee on transfer, in case someone else would like to fork this contract and use it, that fix will be required.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229#issuecomment-1234997044\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Given that the warden couldn’t know the use of Balancer only tokens, the severity will still be upheld.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229#issuecomment-1241715801\">elnilz (FIAT DAO) commented</a>:</strong></p>\n<blockquote>\n<p>@Justin Goro so should we explicitly exclude all weird implementations of e.g. ERC20 in the future in the contest docs? I mean there are other wild examples of ERC20 implementations that someone could point out would cause problems with this contract. I am not trying to discount the work of any warden here but I think the correct response here as well as for #231 would be to improve docs stating which ERC20 implementations are safe to use in combination with VotingEscrow.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229#issuecomment-1242816667\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>@elnilz This topic is very important to get right and the more it’s debated, the more it’s clear that there is no one size fits all answer. When I sponsored a contest, I only figured out after the fact the sorts of things that would have reduced unhelpful warden submissions, through no fault of C4. </p>\n<p>My suggestion is that we curate an open source optional questionnaire for sponsors. The more detail the sponsor gives a priori, the more we can mark unhelpful issues as invalid. As an example, the tools I use to deploy my dapps do not allow me to accidentally omit addresses in constructor arguments. So wardens who warn me that I don’t check for the zero address in my constructors are not helping me. The questionnaire would cover many common case submissions such as that. </p>\n<p>In your case, I had to dance a bit of a fine line: on the one hand, the wardens are not wrong in the event that you’re unaware of token design nuance and so they shouldn’t be penalized. On the other hand, this is a DAO and the wardens should at least suspect that the choice of token is a central decision. In the end, since both parties have good points to make and there’s no clear decider, I chose to side with the wardens since it doesn’t incur any additional cost to you as the sponsor and since it would seem unfair to penalize the wardens for an honest report with no flaws at the correct severity level. </p>\n</blockquote>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor disputed the issue because the Balancer V2 Pool tokens it’s planned to be used with do not implement a fee-on-transfer mechanic. The tokens do not appear to be <a href=\"https://github.com/balancer-labs/balancer-v2-monorepo/blob/4085a05d5e42684a10a0b7b2caba454bd907ce22/pkg/pool-utils/contracts/BalancerPoolToken.sol#L35\">upgradeable</a> so there is no risk of fees being added to existing tokens via upgrade. Without more information about how which pool tokens are chosen/allowed/used, and what prevents future pool tokens that implement such a mechanic from being used with the same contract, I have to agree with the warden and judge that this is a Medium risk issue. The suggested mitigation is to measure the balance of the token that the contract holds before the <code>transferFrom()</code> call is made, and afterwards, and use the difference as the value, rather than the amount the user states. You could also add a <code>require()</code> enforcing the invariant that the change in balance must equal the stated amount, which would <em>prevent</em> fee-on-transfer tokens from being used.</p>\n</blockquote>\n<blockquote>\n<p>In the final PR, the sponsor has acknowledged the issue and added a code comment saying that fee-on-transfer tokens are not supported.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-02-attacker-contract-can-avoid-being-blocked-by-blocklistsol\" style=\"position:relative;\"><a href=\"#m-02-attacker-contract-can-avoid-being-blocked-by-blocklistsol\" aria-label=\"m 02 attacker contract can avoid being blocked by blocklistsol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75\">[M-02] Attacker contract can avoid being blocked by BlockList.sol</a></h2>\n<p><em>Submitted by JohnSmith, also found by ayeslick, reassor, rokinot, and scaraven</em></p>\n<p>To block an address it must pass the <code>isContract(address)</code> check:<br>\n<a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/features/Blocklist.sol#L25\">https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/features/Blocklist.sol#L25</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/features/Blocklist.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">25:         require(_isContract(addr), &quot;Only contracts&quot;);</span></span></code></pre>\n<p>Which just checks code length at the address provided.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">contracts/features/Blocklist.sol</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">37:     function _isContract(address addr) internal view returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">38:         uint256 size;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">39:         assembly {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">40:             size := extcodesize(addr)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">41:         }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">42:         return size &gt; 0;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">43:     }</span></span></code></pre>\n<p>Attacker can interact with the system and selfdestruct his contract, and with help of CREATE2 recreate it at same address when he needs to interact with the system again.</p>\n<h3 id=\"proof-of-concept-3\" style=\"position:relative;\"><a href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of concept</h3>\n<p>Below is a simple example of salted contract creation, which you can test against <code>_isContract(address)</code> function.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">15</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">BlockList</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_isContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">size</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">assembly</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            size := </span><span class=\"mtk11\">extcodesize</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">size</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AttackerContract</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">destroy</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">selfdestruct</span><span class=\"mtk1\">(</span><span class=\"mtk11\">payable</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">AttackerFactory</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">deploy</span><span class=\"mtk1\">() </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">address</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">AttackerContract</span><span class=\"mtk1\">{</span><span class=\"mtk12\">salt</span><span class=\"mtk1\">: </span><span class=\"mtk10\">bytes32</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;123&quot;</span><span class=\"mtk1\">)}());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>One of the goals of Ethereum is for humans and smart contracts to both be treated equally. This leads into a future where smart contracts interact seamlessly with humans and other contracts. It might change in the future , but for now an arbitrary address is ambiguous.<br>\nWe should consider blacklisting addresses without checking if they are contracts.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1217810274\">lacoop6tu (FIAT DAO) commented</a>:</strong></p>\n<blockquote>\n<p>Duplicate of <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/168\">#168</a> </p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232222354\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>This is a valid attack vector that undermines the blocking mechanism and is not a duplicate of #168.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232403488\">lacoop6tu (FIAT DAO) commented</a>:</strong></p>\n<blockquote>\n<p>IMO this is more acknowledged in this case, the only interaction possible is locking LP tokens first so if someone then selfdestructs, another attacker could create a contract with that address and take ownership (and quitLock for example) similar to what happened with optimism and wintermute.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232415680\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The reason it’s maintained as a medium risk is because there is a bit of circumventing of protocol restrictions. But as you indicated, it’s not serious enough that marking it acknowledged is irresponsible.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75\">elnilz (FIAT DAO) acknowledged</a></strong></p>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor acknowledges that the <code>BlockList</code> can be bypassed, but <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232403488\">states</a> that “the only interaction possible is locking LP tokens first”. However, looking at the code, the <code>checkBlocklist</code> modifier is applied to not just <code>createLock()</code>, but <code>increaseAmount()</code>, <code>increaseUnlockTime()</code>, and <code>delegate()</code>. An attacker can bypass the block list for every one of these functions by making their SmartWallet a specially-constructed <code>create2()</code> contract that does external calls to an other contract in its constructor, for instructions on what to execute, before self-destructing. Whenever the attacker wants to interact with the token, they update their external instruction-providing contract with the action to take, re-create the attack contract. It’s not clear why the block list is only for contracts, and if it can be bypassed by using this method, or by transferring the tokens to an EOA.</p>\n</blockquote>\n<blockquote>\n<p>In discussions of the issue, the sponsor clarified that the <code>BlockList</code>’s purpose is to prevent lock tokenization, and acknowledged that using an updated <code>BlockList</code> that blocks specific EOAs may be required if an attacker uses the features described above to work around being blocked.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-03-inconsistent-logic-of-increase-unlock-time-to-the-expired-locks\" style=\"position:relative;\"><a href=\"#m-03-inconsistent-logic-of-increase-unlock-time-to-the-expired-locks\" aria-label=\"m 03 inconsistent logic of increase unlock time to the expired locks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254\">[M-03] Inconsistent logic of increase unlock time to the expired locks</a></h2>\n<p><em>Submitted by KIntern_NA, also found by ak1, cryptphi, and scaraven</em></p>\n<p>Can not prevent expired locks being extended.</p>\n<h3 id=\"proof-of-concept-4\" style=\"position:relative;\"><a href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L493-L523\">https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L493-L523</a></p>\n<p>Call function function <code>increaseUnlockTime()</code> with an expired lock (locked[msg.sender].end &#x3C; block.timestamp)</p>\n<ul>\n<li>Case 1: if sender’s lock was not delegated to another address, function will be revert because of the requirement</li>\n</ul>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L511\">https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L511</a></p>\n<ul>\n<li>Case 2: if sender’s lock was delegated to another address, function will not check anything and the lock can be extended.</li>\n</ul>\n<p>But in case 1, sender’s lock was not delegated to another, the sender can delegate to new address with end time of lock equal to new end time. After that he can call <code>increaseUnlockTime()</code> and move to case 2. Then sender can undelegate and the lock will be extended, and sender will take back vote power.</p>\n<p>Here is the script :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"typescript\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk11\">describe</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;voting escrow&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">it</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;increase unlock time issue&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">createSnapshot</span><span class=\"mtk1\">(</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">//alice creates lock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lockTime</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getTimestamp</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">).</span><span class=\"mtk11\">createLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lockAmount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">lockTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// bob creates lock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">lockTime</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">50</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> + (</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getTimestamp</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">).</span><span class=\"mtk11\">createLock</span><span class=\"mtk1\">(</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk7\">8</span><span class=\"mtk1\">, </span><span class=\"mtk12\">lockTime</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">//pass 1 week, alice&#39;s lock is expired</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ethers</span><span class=\"mtk1\">.</span><span class=\"mtk12\">provider</span><span class=\"mtk1\">.</span><span class=\"mtk11\">send</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;evm_mine&quot;</span><span class=\"mtk1\">, [</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getTimestamp</span><span class=\"mtk1\">() + </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">eq</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">//alice can not increase unlock timme</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">).</span><span class=\"mtk11\">increaseUnlockTime</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lockTime</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk11\">revertedWith</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;Lock expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">//alice delegate to bob then can increase unlock time</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">).</span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">bob</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">).</span><span class=\"mtk11\">increaseUnlockTime</span><span class=\"mtk1\">(</span><span class=\"mtk12\">lockTime</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk12\">not</span><span class=\"mtk1\">.</span><span class=\"mtk12\">be</span><span class=\"mtk1\">.</span><span class=\"mtk12\">reverted</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">//alice delegate back herself</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">connect</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">).</span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk11\">expect</span><span class=\"mtk1\">(</span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ve</span><span class=\"mtk1\">.</span><span class=\"mtk11\">balanceOf</span><span class=\"mtk1\">(</span><span class=\"mtk12\">alice</span><span class=\"mtk1\">.</span><span class=\"mtk12\">address</span><span class=\"mtk1\">)).</span><span class=\"mtk12\">to</span><span class=\"mtk1\">.</span><span class=\"mtk11\">gt</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    });</span></span></span></code></pre>\n<h3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>In every cases, expired locks should able to be extended -> should remove line <a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L511\">VotingEscrow.sol#L511</a>.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254\">lacoop6tu (FIAT DAO) confirmed</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254#issuecomment-1236020440\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>Very good report, especially because of that script.</p>\n</blockquote>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor addressed the finding with the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/14/files/b9afd265fac9b3b3a3dc1440d47f421a41ff9639\">Issue 4</a>. The fix chosen was to not allow the increasing of lock time or non-self re-delegation if the delegatee’s lock has expired. The fix didn’t require the undelegate flavor to duplicate the blocklist check  since <code>msg.sender</code> is already checked by the <code>checkBlocklist</code> modifier. The refactored code properly re-used some variables rather than duplicating the allocations done in the delegation/re-delegation case in order to save some gas. The refactoring introduced a new issue, [M.N-01], described below in the Mitigation Review section.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-04-error-in-updating-_checkpoint-in-the-increaseunlocktime-function\" style=\"position:relative;\"><a href=\"#m-04-error-in-updating-_checkpoint-in-the-increaseunlocktime-function\" aria-label=\"m 04 error in updating _checkpoint in the increaseunlocktime function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/217\">[M-04] Error in Updating <code>_checkpoint</code> in the <code>increaseUnlockTime</code> Function</a></h2>\n<p><em>Submitted by Aymen0909, also found by 0xf15ers, 0xSky, auditor0517, bin2chen, CertoraInc, csanuragjain, JohnSmith, scaraven, tabish, wagmi, and yixxas</em></p>\n<p>The potentiel impact of this error are :</p>\n<ul>\n<li>Give wrong voting power to a user at a given block.</li>\n<li>Give wrong total voting power at a given block.</li>\n<li>Give wrong total voting power.</li>\n</ul>\n<h3 id=\"proof-of-concept-5\" style=\"position:relative;\"><a href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The error occured in this line :\n<a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L513\">https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L513</a></p>\n<p>In the <strong>increaseUnlockTime</strong> function the oldLocked.end passed to the function <strong>_checkpoint</strong> is wrong as it is the same as the new newLock end time (called unlock_time) instead of being equal to <strong>oldUnlockTime</strong> .</p>\n<p>In the given CheckpointMath.md file it is stated that checkpoint details for  <strong>increaseUnlockTime</strong> function should be :</p>\n<table>\n<thead>\n<tr>\n<th>Lock</th>\n<th align=\"center\">amount</th>\n<th align=\"center\">end</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>old</td>\n<td align=\"center\">owner.delegated</td>\n<td align=\"center\">owner.end</td>\n</tr>\n<tr>\n<td>new</td>\n<td align=\"center\">owner.delegated</td>\n<td align=\"center\">T</td>\n</tr>\n</tbody>\n</table>\n<p>BUT with this error  you get a different checkpoint details :</p>\n<table>\n<thead>\n<tr>\n<th>Lock</th>\n<th align=\"center\">amount</th>\n<th align=\"center\">end</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>old</td>\n<td align=\"center\">owner.delegated</td>\n<td align=\"center\">T</td>\n</tr>\n<tr>\n<td>new</td>\n<td align=\"center\">owner.delegated</td>\n<td align=\"center\">T</td>\n</tr>\n</tbody>\n</table>\n<p>The error is illustrated in the code below :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">        LockedBalance memory locked_ = locked[msg.sender];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 unlock_time = _floorToWeek(_unlockTime); // Locktime is rounded down to weeks</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /* @audit comment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                 the unlock_time represent the newLock end time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Validate inputs</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(locked_.amount &gt; 0, &quot;No lock&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(unlock_time &gt; locked_.end, &quot;Only increase lock end&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        require(unlock_time &lt;= block.timestamp + MAXTIME, &quot;Exceeds maxtime&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        // Update lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        uint256 oldUnlockTime = locked_.end;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        locked_.end = unlock_time;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        /* @audit comment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                 The locked_ end time is update from  oldUnlockTime  ==&gt;  unlock_time</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        locked[msg.sender] = locked_;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        if (locked_.delegatee == msg.sender) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            // Undelegated lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            require(oldUnlockTime &gt; block.timestamp, &quot;Lock expired&quot;);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            LockedBalance memory oldLocked = _copyLock(locked_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            oldLocked.end = unlock_time;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            /* @audit comment</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">                 The oldLocked.end is set to unlock_time instead of   oldUnlockTime </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            */</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">            _checkpoint(msg.sender, oldLocked, locked_);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        }</span></span></code></pre>\n<p>The impact of this is when calculating the <strong>userOldPoint.bias</strong> in the <strong>_checkpoint</strong> function you get an incorrect value equal to <strong>userNewPoint.bias</strong> (because oldLocked.end == _newLocked.end which is wrong).</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">240        userOldPoint.bias =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">241                    userOldPoint.slope *</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">242                    int128(int256(_oldLocked.end - block.timestamp));</span></span></code></pre>\n<p>The wrong <strong>userOldPoint.bias</strong> value is later used to calculate and update the bias value for the new point in <strong>PointHistory</strong>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">359       lastPoint.bias =</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">360                  lastPoint.bias +</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">361                  userNewPoint.bias -</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">362                  userOldPoint.bias;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">372       pointHistory[epoch] = lastPoint;</span></span></code></pre>\n<p>And added to that the wrong <strong>oldLocked.end</strong> is used to get oldSlopeDelta value which is used to update the <strong>slopeChanges</strong>.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">271       oldSlopeDelta = slopeChanges[_oldLocked.end];</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">380       oldSlopeDelta = oldSlopeDelta + userOldPoint.slope;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">381       if (_newLocked.end == _oldLocked.end) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">382                  oldSlopeDelta = oldSlopeDelta - userNewPoint.slope; // It was a new deposit, not extension</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">383        }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">384       slopeChanges[_oldLocked.end] = oldSlopeDelta;</span></span></code></pre>\n<p>As the <strong>PointHistory</strong> and the <strong>slopeChanges</strong> values are used inside the functions <strong>balanceOfAt()</strong> ,  <strong>_supplyAt()</strong>,  <strong>totalSupply()</strong>,  <strong>totalSupplyAt()</strong> to calculate the voting power, <strong>this error could give wrong voting power at a given block of a user or can give wrong total voting power</strong>.</p>\n<h3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>The line 513 in the VotingEscrow.sol contract :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">      513      oldLocked.end = unlock_time;</span></span></code></pre>\n<p>Need to be replaced with the following :</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">      513      oldLocked.end = oldUnlockTime;</span></span></code></pre>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/217#issuecomment-1217845853\">lacoop6tu (FIAT DAO) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>As majority of wardens reported, this is Medium finding<br>\n<code>2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/217#issuecomment-1234976983\">Justin Goro (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>The severity will be downgraded but otherwise a good report.</p>\n</blockquote>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor addressed the finding with the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/9/files/c96d67be01305e95711b7eac33fde484f562bb7a\">Issue 5</a>. The fix properly changes the code to match the invariants <a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md\">specification</a>, and matches the logical expectation that the ‘old’ field uses the ‘old’ timestamp.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-05-unsafe-casting-from-int128-can-cause-wrong-accounting-of-locked-amounts\" style=\"position:relative;\"><a href=\"#m-05-unsafe-casting-from-int128-can-cause-wrong-accounting-of-locked-amounts\" aria-label=\"m 05 unsafe casting from int128 can cause wrong accounting of locked amounts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/228\">[M-05] Unsafe casting from int128 can cause wrong accounting of locked amounts</a></h2>\n<p><em>Submitted by CertoraInc, also found by 0x1f8b, carlitox477, cRat1st0s, DecorativePineapple, joestakey, ladboy233, reassor, and rvierdiiev</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L418\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L418</a><br></p>\n<p>The unsafe casting to int128 variable can cause its value to be different from the correct value. For example in the createLock function, the addition to the locked amount variable is done by <code>locked_.amount += int128(int256(_value))</code>. In that case, if <code>_value</code> is greater than <code>type(int128).max</code> which is <code>2**127 - 1</code>, then the accounting will be wrong and the amount that will be added to <code>locked_.amount</code> will be less than the amount of token that will be transferred from the user. Then the user won’t be able to withdraw the tokens that he transferred, and they’ll be stuck in the contract forever.</p>\n<h3 id=\"proof-of-concept-6\" style=\"position:relative;\"><a href=\"#proof-of-concept-6\" aria-label=\"proof of concept 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<ol>\n<li>Alice tries to lock <code>2**128</code> tokens. She calls <code>createLock(2**128, unlockTime)</code> with the time she wants to lock for.</li>\n<li>The addition of the given value is done by <code>locked_.amount += int128(int256(_value))</code>, which actually does nothing to the <code>locked_.amount</code> variable and it remains 0. That’s because when casting <code>int128(int256(2**128))</code> truncates to 0, and that leaves the locked amount unchanged but the tokens are transferred.</li>\n</ol>\n<h3 id=\"tools-used-2\" style=\"position:relative;\"><a href=\"#tools-used-2\" aria-label=\"tools used 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual auditing - VS Code and me :)</p>\n<h3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Make sure that the values fit in the variables you are trying to assign them to when casting variables to smaller types.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/228#issuecomment-1216343000\">lacoop6tu (FIAT DAO) acknowledged and commented</a>:</strong></p>\n<blockquote>\n<p>This is true but doesn’t apply in our case, we use a BalV2 Pool Token which would never reach those values in terms of existing supply.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/228#issuecomment-1234923047\">Justin Goro (judge) decreased severity and commented</a>:</strong></p>\n<blockquote>\n<p>The use of Balancer tokens doesn’t preclude numbers above 128bit. In the BalancerV2 source code, all amounts are in uint256. However, the widespread practice of standard Ethereum tokens makes the likelihood of even encountering a token balance above 128 bits is negligible and Balancer does scale down big tokens if the other tokens in the pool are lower when minting. </p>\n<p>Marking this as high risk is simply not realistic. This and its duplicates will be downgraded to medium risk (2) as it’s a type of technicality that will have no bite in reality.</p>\n</blockquote>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor acknowledges that overflow is technically possible, but considers this as unlikely to happen in practice.</p>\n<p>In the final PR, the sponsor added a code comment saying that the contract does not support tokens where <code>maxSupply>2^128-10^[decimals]</code>.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-06-increaseunlocktime-missing-_checkpoint-for-delegated-values\" style=\"position:relative;\"><a href=\"#m-06-increaseunlocktime-missing-_checkpoint-for-delegated-values\" aria-label=\"m 06 increaseunlocktime missing _checkpoint for delegated values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/318\">[M-06] <code>increaseUnlockTime</code> missing <code>_checkpoint</code> for delegated values</a></h2>\n<p><em>Submitted by PwnedNoMore, also found by ak1, CertoraInc, and scaraven</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L509-L515\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L509-L515</a><br></p>\n<p>In the VotingEscrow contract, users can increase their voting power by:</p>\n<ul>\n<li>Adding more funds to their delegated value</li>\n<li>Increasing the time of their lock</li>\n<li>Being delegated by another user</li>\n</ul>\n<p>Specifically, when users are delegated by other users through the <code>delegate</code> function, the delegated user gains control over the delegate funds from the delegating user.</p>\n<p>The delegated user can further increase this power by increasing the time that the delegated funds are locked by calling <code>increaseUnlockTime</code>, resulting in ALL the delegated funds controlled by the delegated user, including those that do not originate from the delegated user, being used to increase the voting power of the user.</p>\n<p>The issue lies in the following scenario: If user A delegates to user B, and then user B delegates to user C, user B loses the ability to extend his or her voting power by <code>increaseUnlockTime</code> due to a missing <code>_checkpoint</code> operation. If user B calls the <code>increaseUnlockTime</code> function, the <code>_checkpoint</code> operation will not proceed, as user B is delegating to user C. However, B still owns delegated funds, in the form of the funds delegated from user A. Therefore, user B should still gain voting power from <code>increaseUnlockTime</code>, even though user B is delegating.</p>\n<h3 id=\"proof-of-concept-7\" style=\"position:relative;\"><a href=\"#proof-of-concept-7\" aria-label=\"proof of concept 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>Assume three users, Alice, Bob, and Carol, who each possess <code>locks</code> with 10 units of <code>delegate</code> value. Also assume that the unlock time is 1 week.</p>\n<ul>\n<li>Alice delegates her 10 units to Bob.</li>\n<li>Bob then delegates his 10 units to Carol.</li>\n<li>At this point, Alice has 0 <code>delegate</code>, value, Bob has 10 <code>delegate</code> value, and Carol has 20 <code>delegate</code> value.</li>\n<li>Carol calls <code>increaseUnlockTime</code> to 2 weeks, resulting in <code>_checkpoint</code> raising her voting power accordingly.</li>\n<li>Bob calls <code>increaseUnlockTime</code> to 2 weeks, resulting in no change in his voting power, even though he has 10 units of <code>delegate</code> value.</li>\n</ul>\n<h3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Move the <code>_checkpoint</code> outside of the <code>if</code> statement on line 514.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/318#issuecomment-1217846548\">lacoop6tu (FIAT DAO) confirmed, but disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>As most of wardens reported in duplicated, this is Medium finding<br>\n<code>2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.</code></p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/318\">Justin Goro (judge) decreased severity to Medium</a></strong></p>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor addressed the finding with the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/13/files/f84fc5d43e2ad29fea031fe020913acc52507671\">Issue 2</a>. In cases where a user is both a delegator and a delegatee, the original code did not create a checkpoint for calls to <code>increaseUnlockTime()</code>. Self-delegation and being delegated to both increase the <code>LockedBalance.delegated</code> field, so the change to the condition of the if-statement now includes both cases. The code will not get to the if-statement if the user has already withdrawn, due to a <code>require()</code>, so a user that has delegates but has withdrawn, cannot increase their now-zero unlock time. <code>increaseAmount()</code> has a similar if-statement and comment, but the else-block is already covered by a checkpoint, so there is no analogous issue there.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-07-blocking-through-change-of-blocklist-could-trap-tokens\" style=\"position:relative;\"><a href=\"#m-07-blocking-through-change-of-blocklist-could-trap-tokens\" aria-label=\"m 07 blocking through change of blocklist could trap tokens permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200\">[M-07] Blocking Through Change of Blocklist Could Trap Tokens</a></h2>\n<p><em>Submitted by Respx</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L27\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L27</a>\n<a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L531\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L531</a>\n<a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L637\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L637</a></p>\n<p>In the normal flow, an account that is blocked is protected from having its funds locked by a call to <code>forceUndelegate()</code>, as occurs on line 27 of <code>Blocklist.sol</code>.<br>\nHowever, this protection could potentially be circumvented if the value of <code>blocklist</code> is changed to an address which returns <code>True</code> for <code>isBlocked()</code> (as tested in the modifier <code>checkBlocklist()</code>) and if this account was not previously blocked (ie. <code>forceUndelegate()</code> was never called on it).<br>\nIn this situation, if the account has delegated, its tokens will be rendered irretrievable.</p>\n<h3 id=\"proof-of-concept-8\" style=\"position:relative;\"><a href=\"#proof-of-concept-8\" aria-label=\"proof of concept 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>The blocked account would not be able to call <code>wthdraw()</code> successfully because of the check on line 531.<br>\nThe blocked account would not be able to call <code>quitLock()</code> successfully because of the check on line 637.<br>\nThe blocked account would not be able to call <code>delegate()</code> to undelegate and thereby allow it to make these calls because <code>delegate()</code> uses the <code>checkBlocklist</code> modifier.<br>\n<code>Blocklist</code> has no unblock functionality, so the only way to release the tokens would be through a redeployment of <code>Blocklist</code>.<br></p>\n<h3 id=\"recommended-mitigation-steps-8\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-8\" aria-label=\"recommended mitigation steps 8 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>This situation is most likely to occur as an error during a blocklist migration. In that case, it could be mitigated by adding an unblock functionality to the blocklist contract.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200\">lacoop6tu (FIAT DAO) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200#issuecomment-1219308780\">elnilz (FIAT DAO) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>Not High Risk as no funds at risk. In the scenario outlined above, a clear path to restoring user’s access to the blocked tokens exists.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200#issuecomment-1232373516\">Justin Goro (judge) decreased severity to Meidum and commented</a>:</strong></p>\n<blockquote>\n<p>Severity downgraded.</p>\n</blockquote>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor acknowledges the possible rug vector. It is common for admin rug vectors to not be addressed.</p>\n</blockquote>\n<hr>\n<h2 id=\"m-08-attackers-can-abuse-the-quitlock-function-to-get-a-very-large-amount-of-votes\" style=\"position:relative;\"><a href=\"#m-08-attackers-can-abuse-the-quitlock-function-to-get-a-very-large-amount-of-votes\" aria-label=\"m 08 attackers can abuse the quitlock function to get a very large amount of votes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237\">[M-08] Attackers can abuse the <code>quitLock</code> function to get a very large amount of votes</a></h2>\n<p><em>Submitted by CertoraInc</em></p>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L632-L659\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L632-L659</a></p>\n<p>An attacker can use a flashloan and the quitLock function to achieve a large amount of votes for one transaction. It can, depends on the implementation of the modules that will use this contract, be used to pass malicious proposals or exploit any feature that depends on the voting balance.</p>\n<h3 id=\"proof-of-concept-9\" style=\"position:relative;\"><a href=\"#proof-of-concept-9\" aria-label=\"proof of concept 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h3>\n<p>We assume here that there is a contract that provides a flashloan (for simplicity without fees, but can also work with fees, just requires the attacker to provide a larger amount of tokens) for the token that is used by the VotingEscrow contract.</p>\n<ol>\n<li>The attacker deploys a smart contract that implements the following logic and approves the contract for the token that is used in the <code>VotingEscrow</code> contract (of course assigning all the values of the variables).</li>\n<li>The attacker calls the <code>attack</code> function with the amount he wants to take as a flashloan (he will need to cover a penalty based on that amount).</li>\n<li>The <code>attack</code> function calculates the penalty and transfers it from the attacker.</li>\n<li>The <code>flashloan</code> function is called, which provides the tokens to the contract and then calls the <code>flashloanCallback</code> with the lent amount.</li>\n<li>The <code>flashloanCallback</code> function creates a lock with the amount received from the flashloan for a week (the unlock time can be changed to achieve larger votes balance, but it must be considered when calculating the penalty).</li>\n<li>The attacker can do whatever he wants with the amount of votes the contract currently has.</li>\n<li>The quitLock function is called to get back the funds (excluding the penalty), and the loan is payed back.</li>\n</ol>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"sol\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VotingEscrowAttack</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(0</span><span class=\"mtk12\">x</span><span class=\"mtk1\">...); </span><span class=\"mtk3\">// the token used in the VotingEscrow contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IVotingEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">votingEscrow</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IVotingEscrow</span><span class=\"mtk1\">(0</span><span class=\"mtk12\">x</span><span class=\"mtk1\">...); </span><span class=\"mtk3\">// the address of the VotingEscrow contract</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">1</span><span class=\"mtk1\"> </span><span class=\"mtk12\">weeks</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAXTIME</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAXPENALTY</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PENALTY_RATE</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">MAXPENALTY</span><span class=\"mtk1\">) / </span><span class=\"mtk12\">MAXTIME</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">IFlashLoan</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">flashloanContract</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IFlashLoan</span><span class=\"mtk1\">(0</span><span class=\"mtk12\">x</span><span class=\"mtk1\">...); </span><span class=\"mtk3\">// the address of the flashloan provider</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">attack</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) </span><span class=\"mtk11\">external</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> * </span><span class=\"mtk12\">PENALTY_RATE</span><span class=\"mtk1\">) / (</span><span class=\"mtk7\">10</span><span class=\"mtk1\"> ** </span><span class=\"mtk7\">18</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">penalty</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// assuming no flashloan fee</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">IFlashLoan</span><span class=\"mtk1\">.</span><span class=\"mtk11\">flashloan</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">flashloanCallback</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createLock</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// create a lock for a week with a very large of token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// do whatever you want with your large amount of votes</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">votingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk11\">quitLock</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// pay back the flashloan</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>The function names, arguments and return values might not be accurate and might change depends on the used flashloan platform, but this contract is just to give a general idea of an attack vector.</li>\n</ul>\n<h3 id=\"tools-used-3\" style=\"position:relative;\"><a href=\"#tools-used-3\" aria-label=\"tools used 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tools Used</h3>\n<p>Manual auditing - VS Code and me :)</p>\n<h3 id=\"recommended-mitigation-steps-9\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-9\" aria-label=\"recommended mitigation steps 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h3>\n<p>Think about implementing a mechanism that prevents users from creating a lock and quitting it in the same transaction, that way attackers won’t be able to use flashloan in order to achieve large voting power. However, regular loans will still be a problem with that fix, and if this isn’t a wanted behavior, additional fix is needed to be thought of.</p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237\">lacoop6tu (FIAT DAO) acknowledged</a></strong></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1219290756\">elnilz (FIAT DAO) disagreed with severity and commented</a>:</strong></p>\n<blockquote>\n<p>We actually could mitigate the issue by restricting increasing voting power and quitting in the same block. This would make the implementation safer.</p>\n<p>But even then, the severity is rather 2 as funds are not directly at risk.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1236035557\">Justin Goro (judge) commented</a>:</strong></p>\n<blockquote>\n<p>The scope of voting power is unclear. It may be that a proposal becomes possible that enables large funds transfers. For this reason, severity is maintained.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1241689850\">elnilz (FIAT DAO) disputed and commented</a>:</strong></p>\n<blockquote>\n<p>Did review the economics of this attack and they are the same than without quitLock:</p>\n<p>First, note that both balanceOf (voting power) and fee paid in quitLock are proportional to <code>(locked.end-block.timestamp)/MAXTIME</code> or remaining lock duration. In other words, in order to gain voting power, user also accepts higher quitLock fee.</p>\n<p>For max voting power user locks with MAXTIME. When quitting, this also results in the loss of all her locked tokens. Because the voting power decreases linearly with remaining lock duration, the amount of tokens that need be locked in order to achieve same voting power increases with lower lock durations. This results in the same quitLock fee as if the user would chose max lock duration or if user would not be able to quit at all.</p>\n<p>See this interactive graph and play with the t (remaining lock duration) and N (tokens locked) sliders: <a href=\"https://www.desmos.com/calculator/yjby9zempb\">https://www.desmos.com/calculator/yjby9zempb</a></p>\n<p>Thus, quitLock doesn’t change the economics of governance attacks and so we dispute this issue.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1242815658\">Justin Goro (judge) decreased severity to Medium and commented</a>:</strong></p>\n<blockquote>\n<p>Upon reconsideration, it appears the dampening effect of the penalty ensures that this FlashLoan attack is only really viable at very low impact levels. The larger the attack, the more the cost of the attack will exceed any benefit. The only case where this wouldn’t be the case is when a small vote can tip the balance of an important decision which is unlikely in a gauge style vote. But even if a threshold emerges, the attacker may as well just get the votes through normal channels. </p>\n<p>Nonetheless, the vector is only dampened, not eradicated and so I’ll be downgrading this to Medium severity.</p>\n</blockquote>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1243314912\">elnilz (FIAT DAO) commented</a>:</strong></p>\n<blockquote>\n<p>Thanks for reconsidering. I’d also be curious about feedback from CertoraInc as it’s been reported by the user.</p>\n<p>The implications of the above analysis are, however, that the cost of an attack is the same as with Curve’s VotingEscrow which doesn’t implement a quitLock function. So unless the attack vector on Curve itself is also a medium severity this issue should be invalidated.</p>\n</blockquote>\n<p><strong>IllIllI (warden) reviewed mitigation:</strong></p>\n<blockquote>\n<p>The sponsor disputed the issue on the basis of an economic analysis of the penalty taken vs the votes gained, the outcome of which was that the penalty always covers the votes gained. I spoke with the sponsor and the sponsor explained that for the original Curve Finance code, the number of votes one gets is not equal one-for-one to the number of tokens locked: locking for the maximum duration will get you close to one-for-one, but every second under that number, the locking user gets fewer and fewer votes. Therefore in veFTD, the penalty is always chosen such that when the penalty is subtracted from the votes gained, the number of votes a user is left with after quitting is equal to the number of votes they would have been given had they used the quit time as their lock end time instead. In other words, the votes one would get for locking for the week the warden mentions, would be equal to the penalty they gather ahead of time, so the flash loan does not help the attacker.</p>\n<p>To verify all of this, I wrote two tests that make use of hardhat’s ability to mine specific blocks with specific times. The <a href=\"https://gist.github.com/IllIllI000/e7d44c6bf21155c5cc076d3ace69d47f\">first</a> test confirmed that indeed, when one subtracts the penalty from the number of votes gained, the remaining number of votes is less than the number of votes a separate user gains for locking for the shorter duration, so it’s always better to specify the correct lock time rather and unlocking early. The <a href=\"https://gist.github.com/IllIllI000/16c7883c13ec35fd8c050aa25791a163\">second</a> test verifies that the same is true even if one quits the second after the lock is created. Finally, I wrote a <a href=\"https://gist.github.com/IllIllI000/67e2d48aa8b2cc33859d4ec962638c98\">test</a> that specifically does the flash loan scenario the warden outlined, and was able to show that when the attacking contract checks its balance between locking and quitting for the previous block, the votes are zero, and for the current block, the penalty is larger than the votes gained (and one cannot query vote balances for future blocks). Once the contract’s attack call completes, checks for the votes for same blocks show zero votes for both, so I believe the warden’s finding is invalid.</p>\n</blockquote>\n<hr>\n<h1 id=\"low-risk-and-non-critical-issues\" style=\"position:relative;\"><a href=\"#low-risk-and-non-critical-issues\" aria-label=\"low risk and non critical issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk and Non-Critical Issues</h1>\n<p>For this contest, 93 reports were submitted by wardens detailing low risk and non-critical issues. The <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/9\">report highlighted below</a> by <strong>oyc_109</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/313\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/147\">robee</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/266\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/2\">CodingNameKiki</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/222\">IllIllI</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/301\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/35\">bobirichman</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/255\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/197\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/56\">pfapostol</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/283\">GalloDaSballo</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/5\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/48\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/120\">0x52</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/84\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/192\">Respx</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/179\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/264\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/324\">JC</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/138\">PaludoX0</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/262\">Bahurum</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/187\">ret2basic</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/219\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/132\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/135\">Junnon</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/100\">RedOneN</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/55\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/51\">RoiEvenHaim</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/41\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/95\">cRat1st0s</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/196\">auditor0517</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/47\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/77\">JohnSmith</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/278\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/186\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/39\">mics</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/142\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/312\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/146\">bin2chen</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/285\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/291\">Funen</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/104\">Noah3o6</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/154\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/245\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/11\">erictee</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/81\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/57\">neumo</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/111\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/28\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/72\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/289\">apostle0x01</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/167\">0xmatt</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/277\">seyni</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/250\">0xNineDec</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/65\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/207\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/242\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/320\">a12jmx</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/241\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/177\">LeoS</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/274\">KIntern_NA</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/105\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/214\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/23\">p_crypt0</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/294\">wagmi</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/233\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/155\">saneryee</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/272\">Vexjon</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/297\">bulej93</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/61\">cryptphi</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/259\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/71\">exd0tpy</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/311\">natzuu</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/244\">0xLovesleep</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/19\">Lambda</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/116\">paribus</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/305\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/45\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/309\">0xsolstars</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/31\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/175\">DecorativePineapple</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/16\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/166\">jonatascm</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/319\">medikko</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/258\">Rohan16</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/110\">rokinot</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/127\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/328\">byndooa</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/133\">sseefried</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/53\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/205\">Yiko</a>, and <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/170\">wastewa</a>.</em></p>\n<h2 id=\"l-01-upgrade-open-zeppelin-contract-dependency\" style=\"position:relative;\"><a href=\"#l-01-upgrade-open-zeppelin-contract-dependency\" aria-label=\"l 01 upgrade open zeppelin contract dependency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-01] Upgrade Open Zeppelin contract dependency</h2>\n<p>An outdated OZ version is used (which has known vulnerabilities, see <a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories\">https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories</a>).</p>\n<p>The solution uses:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">&quot;@openzeppelin/contracts&quot;: &quot;^4.4.2&quot;,</span></span></code></pre>\n<h2 id=\"l-02-no-transfer-ownership-pattern\" style=\"position:relative;\"><a href=\"#l-02-no-transfer-ownership-pattern\" aria-label=\"l 02 no transfer ownership pattern permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-02] No Transfer Ownership Pattern</h2>\n<p>Recommend considering implementing a two step process where the owner or admin nominates an account and the nominated account needs to call an acceptOwnership() function for the transfer of ownership to fully succeed. This ensures the nominated EOA account is a valid and active account.</p>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L139-L143\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L139-L143</a></p>\n<h2 id=\"l-03-unspecific-compiler-version-pragma\" style=\"position:relative;\"><a href=\"#l-03-unspecific-compiler-version-pragma\" aria-label=\"l 03 unspecific compiler version pragma permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[L-03] Unspecific Compiler Version Pragma</h2>\n<p>Avoid floating pragmas for non-library contracts.</p>\n<p>While floating pragmas make sense for libraries to allow them to be included with multiple different versions of applications, it may be a security risk for application implementations.</p>\n<p>A known vulnerable compiler version may accidentally be selected or security tools might fall-back to an older compiler version ending up checking a different EVM compilation that is ultimately deployed on the blockchain.</p>\n<p>It is recommended to pin to a concrete compiler version.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Blocklist.sol::2 =&gt; pragma solidity ^0.8.3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">IBlocklist.sol::2 =&gt; pragma solidity ^0.8.3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20.sol::2 =&gt; pragma solidity ^0.8.3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">IVotingEscrow.sol::2 =&gt; pragma solidity ^0.8.3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::2 =&gt; pragma solidity ^0.8.3;</span></span></code></pre>\n<h2 id=\"n-01-use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#n-01-use-a-more-recent-version-of-solidity\" aria-label=\"n 01 use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-01] Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.4 to get bytes.concat() instead of abi.encodePacked(<bytes>,<bytes>)\nUse a solidity version of at least 0.8.12 to get string.concat() instead of abi.encodePacked(<str>,<str>)\nUse a solidity version of at least 0.8.13 to get the ability to use using for with a list of free functions</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Blocklist.sol::2 =&gt; pragma solidity ^0.8.3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">IBlocklist.sol::2 =&gt; pragma solidity ^0.8.3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20.sol::2 =&gt; pragma solidity ^0.8.3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">IVotingEscrow.sol::2 =&gt; pragma solidity ^0.8.3;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::2 =&gt; pragma solidity ^0.8.3;</span></span></code></pre>\n<h2 id=\"n-02-large-multiples-of-ten-should-use-scientific-notation\" style=\"position:relative;\"><a href=\"#n-02-large-multiples-of-ten-should-use-scientific-notation\" aria-label=\"n 02 large multiples of ten should use scientific notation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-02] Large multiples of ten should use scientific notation</h2>\n<p>Use (e.g. 1e6) rather than decimal literals (e.g. 1000000), for better code readability</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::57 =&gt; Point[1000000000000000000] public pointHistory; // 1e9 * userPointHistory-length, so sufficient for 1e9 users</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::58 =&gt; mapping(address =&gt; Point[1000000000]) public userPointHistory;</span></span></code></pre>\n<h2 id=\"n-03-use-scientific-notation-eg-1e18-rather-than-exponentiation-eg-1018\" style=\"position:relative;\"><a href=\"#n-03-use-scientific-notation-eg-1e18-rather-than-exponentiation-eg-1018\" aria-label=\"n 03 use scientific notation eg 1e18 rather than exponentiation eg 1018 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-03] Use scientific notation (e.g. 1e18) rather than exponentiation (e.g. 10**18)</h2>\n<p>Scientific notation should be used for better code readability</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"15\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::48 =&gt; uint256 public constant MULTIPLIER = 10**18;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::51 =&gt; uint256 public maxPenalty = 10**18; // penalty for quitters with MAXTIME remaining lock</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::653 =&gt; uint256 penaltyAmount = (value * penaltyRate) / 10**18; // quitlock_penalty is in 18 decimals precision</span></span></code></pre>\n<h2 id=\"n-04-event-is-missing-indexed-fields\" style=\"position:relative;\"><a href=\"#n-04-event-is-missing-indexed-fields\" aria-label=\"n 04 event is missing indexed fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-04] Event is missing indexed fields</h2>\n<p>Each event should use three indexed fields if there are three or more fields</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"16\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::38 =&gt; event TransferOwnership(address owner);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::39 =&gt; event UpdateBlocklist(address blocklist);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::40 =&gt; event UpdatePenaltyRecipient(address recipient);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::41 =&gt; event CollectPenalty(uint256 amount, address recipient);</span></span></code></pre>\n<h2 id=\"n-05-missing-natspec\" style=\"position:relative;\"><a href=\"#n-05-missing-natspec\" aria-label=\"n 05 missing natspec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-05] Missing NatSpec</h2>\n<p>Code should include NatSpec</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"17\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">IERC20.sol::1 =&gt; // SPDX-License-Identifier: Apache-2.0</span></span></code></pre>\n<h2 id=\"n-06-constants-should-be-defined-rather-than-using-magic-numbers\" style=\"position:relative;\"><a href=\"#n-06-constants-should-be-defined-rather-than-using-magic-numbers\" aria-label=\"n 06 constants should be defined rather than using magic numbers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-06] Constants should be defined rather than using magic numbers</h2>\n<p>It is bad practice to use numbers directly in code without explanation</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"18\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::309 =&gt; for (uint256 i = 0; i &lt; 255; i++) {</span></span></code></pre>\n<h2 id=\"n-07-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" style=\"position:relative;\"><a href=\"#n-07-public-functions-not-called-by-the-contract-should-be-declared-external-instead\" aria-label=\"n 07 public functions not called by the contract should be declared external instead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[N-07] Public functions not called by the contract should be declared external instead</h2>\n<p>Contracts are allowed to override their parents’ functions and change the visibility from external to public.</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"19\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">Blocklist.sol::33 =&gt; function isBlocked(address addr) public view returns (bool) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::754 =&gt; function balanceOf(address _owner) public view override returns (uint256) {</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">VotingEscrow.sol::864 =&gt; function totalSupply() public view override returns (uint256) {</span></span></code></pre>\n<hr>\n<h1 id=\"gas-optimizations\" style=\"position:relative;\"><a href=\"#gas-optimizations\" aria-label=\"gas optimizations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gas Optimizations</h1>\n<p>For this contest, 93 reports were submitted by wardens detailing gas optimizations. The <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/223\">report highlighted below</a> by <strong>IllIllI</strong> received the top score from the judge.</p>\n<p><em>The following wardens also submitted reports: <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/235\">Dravee</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/78\">JohnSmith</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/25\">0x1f8b</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/304\">ajtra</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/80\">MiloTruck</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/73\">Bnke0x0</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/265\">Deivitto</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/50\">ret2basic</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/29\">pfapostol</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/8\">oyc_109</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/220\">Aymen0909</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/252\">m_Rassska</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/303\">defsec</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/299\">c3phas</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/54\">ReyAdmirado</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/14\">CodingNameKiki</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/82\">gogo</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/321\">JC</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/215\">TomJ</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/226\">0xLovesleep</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/141\">0xDjango</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/115\">paribus</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/6\">Rolezn</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/260\">CertoraInc</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/173\">newfork01</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/148\">robee</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/210\">Tomio</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/70\">__141345__</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/327\">0xSmartContract</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/195\">0xNazgul</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/93\">cRat1st0s</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/15\">durianSausage</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/46\">reassor</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/99\">RedOneN</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/275\">Amithuddar</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/129\">jag</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/64\">rbserver</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/317\">0x040</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/286\">brgltd</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/130\">ElKu</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/178\">LeoS</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/112\">simon135</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/225\">Waze</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/287\">medikko</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/211\">Metatron</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/209\">saian</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/213\">Sm4rty</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/249\">Chom</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/284\">GalloDaSballo</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/103\">Noah3o6</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/306\">sashik_eth</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/24\">0xHarry</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/109\">rokinot</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/44\">0xbepresent</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/119\">2997ms</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/33\">bobirichman</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/3\">ignacio</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/310\">SooYa</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/37\">mics</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/144\">ak1</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/300\">asutorufos</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/256\">djxploit</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/128\">Junnon</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/308\">natzuu</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/137\">PaludoX0</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/106\">Ruhum</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/126\">sach1r0</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/290\">apostle0x01</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/293\">bulej93</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/307\">d3e4</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/238\">delfin454000</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/314\">gerdusx</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/183\">ladboy233</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/208\">rvierdiiev</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/159\">SpaceCake</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/212\">0xackermann</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/251\">0xNineDec</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/161\">carlitox477</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/151\">chrisdior4</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/98\">CRYP70</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/40\">sikorico</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/322\">a12jmx</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/30\">csanuragjain</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/190\">Respx</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/257\">Rohan16</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/203\">Yiko</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/49\">ellahi</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/10\">erictee</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/52\">fatherOfBlocks</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/276\">Fitraldys</a>, <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/292\">Funen</a>, and <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/323\">NoamYakov</a>.</em></p>\n<h2 id=\"summary-1\" style=\"position:relative;\"><a href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"left\">Issue</th>\n<th align=\"center\">Instances</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[G‑01]</td>\n<td align=\"left\">Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G‑02]</td>\n<td align=\"left\">State variables only set in the constructor should be declared <code>immutable</code></td>\n<td align=\"center\">14</td>\n</tr>\n<tr>\n<td>[G‑03]</td>\n<td align=\"left\">Structs can be packed into fewer storage slots</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G‑04]</td>\n<td align=\"left\">Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G‑05]</td>\n<td align=\"left\">Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</td>\n<td align=\"center\">9</td>\n</tr>\n<tr>\n<td>[G‑06]</td>\n<td align=\"left\">Avoid contract existence checks by using solidity version 0.8.10 or later</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G‑07]</td>\n<td align=\"left\">State variables should be cached in stack variables rather than re-reading them from storage</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G‑08]</td>\n<td align=\"left\"><code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G‑09]</td>\n<td align=\"left\"><code>internal</code> functions only called once can be inlined to save gas</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G‑10]</td>\n<td align=\"left\">Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G‑11]</td>\n<td align=\"left\"><code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td>[G‑12]</td>\n<td align=\"left\">Optimize names to save gas</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td>[G‑13]</td>\n<td align=\"left\">Using <code>bool</code>s for storage incurs overhead</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G‑14]</td>\n<td align=\"left\">Use a more recent version of solidity</td>\n<td align=\"center\">5</td>\n</tr>\n<tr>\n<td>[G‑15]</td>\n<td align=\"left\">Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G‑16]</td>\n<td align=\"left\"><code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</td>\n<td align=\"center\">4</td>\n</tr>\n<tr>\n<td>[G‑17]</td>\n<td align=\"left\">Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G‑18]</td>\n<td align=\"left\">Using <code>private</code> rather than <code>public</code> for constants, saves gas</td>\n<td align=\"center\">3</td>\n</tr>\n<tr>\n<td>[G‑19]</td>\n<td align=\"left\">Division by two should use bit shifting</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G‑20]</td>\n<td align=\"left\">Stack variable used as a cheaper cache for a state variable is only used once</td>\n<td align=\"center\">1</td>\n</tr>\n<tr>\n<td>[G‑21]</td>\n<td align=\"left\"><code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G‑22]</td>\n<td align=\"left\">Superfluous event fields</td>\n<td align=\"center\">2</td>\n</tr>\n<tr>\n<td>[G‑23]</td>\n<td align=\"left\">Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</td>\n<td align=\"center\">42</td>\n</tr>\n</tbody>\n</table>\n<p>Total: 114 instances over 23 issues</p>\n<h2 id=\"g01--multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\" style=\"position:relative;\"><a href=\"#g01--multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\" aria-label=\"g01  multiple addressid mappings can be combined into a single mapping of an addressid to a struct where appropriate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑01]  Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</h2>\n<p>Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (<strong>20000 gas</strong>) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save <strong>~42 gas per access</strong> due to <a href=\"https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0\">not having to recalculate the key’s keccak256 hash</a> (Gkeccak256 - 30 gas) and that calculation’s associated stack operations.</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"20\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">58</span><span class=\"mtk1\">        </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Point</span><span class=\"mtk1\">[</span><span class=\"mtk7\">1000000000</span><span class=\"mtk1\">]) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userPointHistory</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">59</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">) </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userPointEpoch</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L58-L59\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L58-L59</a></p>\n<h2 id=\"g02--state-variables-only-set-in-the-constructor-should-be-declared-immutable\" style=\"position:relative;\"><a href=\"#g02--state-variables-only-set-in-the-constructor-should-be-declared-immutable\" aria-label=\"g02  state variables only set in the constructor should be declared immutable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑02]  State variables only set in the constructor should be declared <code>immutable</code></h2>\n<p>Avoids a Gsset (<strong>20000 gas</strong>) in the constructor, and replaces the first access in each transaction (Gcoldsload - <strong>2100 gas</strong>) and each access thereafter (Gwarmacces - <strong>100 gas</strong>) with a <code>PUSH32</code> (<strong>3 gas</strong>).</p>\n<p><em>There are 14 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"21\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">features</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Blocklist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit manager (constructor)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">15</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">manager</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_manager</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit manager (access)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">manager</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only manager&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit ve (constructor)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">16</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">ve</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_ve</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit ve (access)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">27</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">IVotingEscrow</span><span class=\"mtk1\">(</span><span class=\"mtk12\">ve</span><span class=\"mtk1\">).</span><span class=\"mtk11\">forceUndelegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L15\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L15</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"22\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token (constructor)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">107</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">token</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token (access)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">426</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token (access)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">486</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token (access)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">546</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">value</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token (access)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">657</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">remainingAmount</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit token (access)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">676</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">penaltyRecipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit name (constructor)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">118</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">name</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit symbol (constructor)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">119</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">symbol</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">_symbol</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit decimals (constructor)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit decimals (access)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Exceeds max decimals&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L107\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L107</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"23\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/VotingEscrow.sol b/contracts/VotingEscrow.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index f15781a..d2c7666 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/VotingEscrow.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/VotingEscrow.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -42,7 +42,7 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     event Unlock();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Shared global state</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    IERC20 public token;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    IERC20 public immutable token;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 public constant WEEK = 7 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 public constant MAXTIME = 365 days;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     uint256 public constant MULTIPLIER = 10**18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -61,9 +61,9 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     mapping(address =&gt; LockedBalance) public locked;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Voting token</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    string public name;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    string public symbol;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    uint256 public decimals = 18;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string public constant name = &quot;veFDT&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    string public constant symbol = &quot;veFDT&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    uint256 public immutable decimals;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Structs</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     struct Point {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -112,11 +112,10 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             blk: block.number</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        decimals = IERC20(_token).decimals();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        require(decimals &lt;= 18, &quot;Exceeds max decimals&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        uint256 _dec = IERC20(_token).decimals();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        require(_dec &lt;= 18, &quot;Exceeds max decimals&quot;);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        decimals = _dec;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        name = _name;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        symbol = _symbol;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         owner = _owner;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         penaltyRecipient = _penaltyRecipient;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/features/Blocklist.sol b/contracts/features/Blocklist.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 27db9b0..ca3a226 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/features/Blocklist.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/features/Blocklist.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -8,8 +8,8 @@ import { IVotingEscrow } from &quot;../interfaces/IVotingEscrow.sol&quot;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> /// @dev This is a basic implementation using a mapping for address =&gt; bool</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> contract Blocklist {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     mapping(address =&gt; bool) private _blocklist;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address public manager;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    address public ve;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address public immutable manager;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    address public immutable ve;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     constructor(address _manager, address _ve) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         manager = _manager;</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"24\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/tmp/gas_before b/tmp/gas_after</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3deb415..cf71599 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/tmp/gas_before</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/tmp/gas_after</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -167,7 +167,7 @@ No need to generate any newer typings.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  Contract         ·  Method              ·  Min        ·  Max        ·  Avg          ·  # calls      ·  eur (avg)  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  Blocklist        ·  block               ·      45000  ·     409628  ·       198815  ·            5  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  Blocklist        ·  block               ·      40797  ·     405425  ·       194612  ·            5  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockERC20        ·  approve             ·      46176  ·      46200  ·        46196  ·           96  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -177,46 +177,46 @@ No need to generate any newer typings.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockERC20        ·  transfer            ·      51588  ·      51612  ·        51606  ·           83  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  MockSmartWallet  ·  createLock          ·     334002  ·     378450  ·       355494  ·            7  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  MockSmartWallet  ·  createLock          ·     331896  ·     376344  ·       353388  ·            7  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockSmartWallet  ·  delegate            ·          -  ·          -  ·       340388  ·            2  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockSmartWallet  ·  increaseUnlockTime  ·          -  ·          -  ·       208859  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  MockSmartWallet  ·  quitLock            ·     131158  ·     256210  ·       201886  ·            4  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  MockSmartWallet  ·  quitLock            ·     129058  ·     254110  ·       199786  ·            4  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  MockSmartWallet  ·  withdraw            ·          -  ·          -  ·       666280  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  MockSmartWallet  ·  withdraw            ·          -  ·          -  ·       664174  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  VotingEscrow     ·  checkpoint          ·      82307  ·    3715511  ·      1272491  ·           10  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  collectPenalty      ·          -  ·          -  ·        49948  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  collectPenalty      ·          -  ·          -  ·        47863  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  createLock          ·     293060  ·    3978208  ·       414348  ·           60  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  createLock          ·     290954  ·    3976102  ·       412242  ·           60  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  VotingEscrow     ·  delegate            ·     246709  ·    4048411  ·       650225  ·           33  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  increaseAmount      ·     234777  ·    1077801  ·       448554  ·            4  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  increaseAmount      ·     232671  ·    1075695  ·       446448  ·            4  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  VotingEscrow     ·  increaseUnlockTime  ·      46794  ·     416024  ·       143186  ·           23  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  quitLock            ·     127639  ·    1605731  ·       375486  ·           13  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  quitLock            ·     125539  ·    1603631  ·       373386  ·           13  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  VotingEscrow     ·  unlock              ·          -  ·          -  ·        14596  ·            3  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  VotingEscrow     ·  updateBlocklist     ·          -  ·          -  ·        47186  ·           14  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  withdraw            ·     106462  ·    3752666  ·       610141  ·           33  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  withdraw            ·     104356  ·    3750560  ·       608035  ·           33  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  Deployments                             ·                                           ·  % of limit   ·             │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ···········································|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  Blocklist                               ·     278212  ·     278236  ·       278231  ·        2.2 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  Blocklist                               ·     248613  ·     248637  ·       248632  ·          2 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ···········································|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockERC20                               ·          -  ·          -  ·      1278169  ·       10.3 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ···········································|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockSmartWallet                         ·          -  ·          -  ·       416156  ·        3.3 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ···········································|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow                            ·    4374338  ·    4374350  ·      4374350  ·       35.1 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow                            ·    4280168  ·    4280180  ·      4280180  ·       34.4 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ·------------------------------------------|-------------|-------------|---------------|---------------|-------------·</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  117 passing (48s)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  117 passing (46s)</span></span></span></code></pre>\n<h2 id=\"g03--structs-can-be-packed-into-fewer-storage-slots\" style=\"position:relative;\"><a href=\"#g03--structs-can-be-packed-into-fewer-storage-slots\" aria-label=\"g03  structs can be packed into fewer storage slots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑03]  Structs can be packed into fewer storage slots</h2>\n<p>Each slot saved can avoid an extra Gsset (<strong>20000 gas</strong>) for the first setting of the struct. Subsequent reads as well as writes have smaller gas savings</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"25\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit Variable ordering with 3 slots instead of the current 4:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">///           uint256(32):end, address(20):delegatee, int128(16):amount, int128(16):delegated</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">75</span><span class=\"mtk1\">        </span><span class=\"mtk12\">struct</span><span class=\"mtk1\"> </span><span class=\"mtk12\">LockedBalance</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">76</span><span class=\"mtk1\">            </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">77</span><span class=\"mtk1\">            </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">end</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">78</span><span class=\"mtk1\">            </span><span class=\"mtk12\">int128</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegated</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">79</span><span class=\"mtk1\">            </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">80</span><span class=\"mtk1\">:       }</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L75-L80\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L75-L80</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"26\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/contracts/VotingEscrow.sol b/contracts/VotingEscrow.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index f15781a..0318bc3 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/contracts/VotingEscrow.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/contracts/VotingEscrow.sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -73,10 +73,10 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 blk;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     struct LockedBalance {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        int128 amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         uint256 end;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        int128 delegated;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         address delegatee;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        int128 amount;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        int128 delegated;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     // Miscellaneous</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -420,7 +420,7 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         locked_.delegated += int128(int256(_value));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         locked_.delegatee = msg.sender;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         locked[msg.sender] = locked_;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        _checkpoint(msg.sender, LockedBalance(0, 0, 0, address(0)), locked_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        _checkpoint(msg.sender, LockedBalance({amount:0, end:0, delegated:0, delegatee:address(0)}), locked_);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Deposit locked tokens</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         require(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">             token.transferFrom(msg.sender, address(this), _value),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/votingEscrowDelegationMathTest.ts b/test/votingEscrowDelegationMathTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 5e43096..088fb9c 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/votingEscrowDelegationMathTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/votingEscrowDelegationMathTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -138,10 +138,10 @@ describe(&quot;VotingEscrow Delegation Math test&quot;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   interface LockedBalance {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    amount: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     end: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    delegated: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     delegatee: string;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    amount: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    delegated: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   interface Point {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -173,10 +173,10 @@ describe(&quot;VotingEscrow Delegation Math test&quot;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       epoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       userEpoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       userLocked: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        amount: locked[0],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        end: locked[1],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        delegated: locked[2],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        delegatee: locked[3],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        end: locked[0],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delegatee: locked[1],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        amount: locked[2],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delegated: locked[3],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       userLastPoint: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bias: userLastPoint[0],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/votingEscrowGasTest.ts b/test/votingEscrowGasTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index d6d03fd..af94f35 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/votingEscrowGasTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/votingEscrowGasTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -174,10 +174,10 @@ describe(&quot;Gas usage tests&quot;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       epoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       userEpoch,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       userLocked: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        amount: locked[0],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        end: locked[1],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        delegated: locked[2],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        delegatee: locked[3],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        end: locked[0],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delegatee: locked[1],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        amount: locked[2],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delegated: locked[3],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       userLastPoint: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bias: userLastPoint[0],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/test/votingEscrowMathTest.ts b/test/votingEscrowMathTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 9d0b9b6..e084b30 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/test/votingEscrowMathTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/test/votingEscrowMathTest.ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -207,8 +207,10 @@ describe(&quot;VotingEscrow Math test&quot;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   interface LockedBalance {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-    amount: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     end: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    delegatee: string;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    amount: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+    delegated: BN;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   interface Point {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -252,8 +254,10 @@ describe(&quot;VotingEscrow Math test&quot;, () =&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       //totalStaticWeight: await votingLockup.totalStaticWeight(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       // userStaticWeight: await votingLockup.staticBalanceOf(sender.address),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       userLocked: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        amount: locked[0],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-        end: locked[1],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        end: locked[0],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delegatee: locked[1],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        amount: locked[2],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+        delegated: locked[3],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">       userLastPoint: {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         bias: userLastPoint[0],</span></span></span></code></pre>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"27\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">diff --git a/tmp/gas_before b/tmp/gas_after</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">index 3deb415..09dd64b 100644</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">--- a/tmp/gas_before</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">+++ b/tmp/gas_after</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -167,7 +167,7 @@ No need to generate any newer typings.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  Contract         ·  Method              ·  Min        ·  Max        ·  Avg          ·  # calls      ·  eur (avg)  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  Blocklist        ·  block               ·      45000  ·     409628  ·       198815  ·            5  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  Blocklist        ·  block               ·      42887  ·     387472  ·       188685  ·            5  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockERC20        ·  approve             ·      46176  ·      46200  ·        46196  ·           96  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -177,35 +177,35 @@ No need to generate any newer typings.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockERC20        ·  transfer            ·      51588  ·      51612  ·        51606  ·           83  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  MockSmartWallet  ·  createLock          ·     334002  ·     378450  ·       355494  ·            7  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  MockSmartWallet  ·  createLock          ·     311601  ·     356043  ·       333090  ·            7  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  MockSmartWallet  ·  delegate            ·          -  ·          -  ·       340388  ·            2  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  MockSmartWallet  ·  delegate            ·          -  ·          -  ·       350371  ·            2  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  MockSmartWallet  ·  increaseUnlockTime  ·          -  ·          -  ·       208859  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  MockSmartWallet  ·  increaseUnlockTime  ·          -  ·          -  ·       206298  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  MockSmartWallet  ·  quitLock            ·     131158  ·     256210  ·       201886  ·            4  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  MockSmartWallet  ·  quitLock            ·     140849  ·     265907  ·       211580  ·            4  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  MockSmartWallet  ·  withdraw            ·          -  ·          -  ·       666280  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  MockSmartWallet  ·  withdraw            ·          -  ·          -  ·       676067  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  checkpoint          ·      82307  ·    3715511  ·      1272491  ·           10  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  checkpoint          ·      82319  ·    3715835  ·      1272603  ·           10  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  VotingEscrow     ·  collectPenalty      ·          -  ·          -  ·        49948  ·            1  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  createLock          ·     293060  ·    3978208  ·       414348  ·           60  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  createLock          ·     270653  ·    3956119  ·       391951  ·           60  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  delegate            ·     246709  ·    4048411  ·       650225  ·           33  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  delegate            ·     224688  ·    4026678  ·       646994  ·           33  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  increaseAmount      ·     234777  ·    1077801  ·       448554  ·            4  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  increaseAmount      ·     229422  ·    1072518  ·       443303  ·            4  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  increaseUnlockTime  ·      46794  ·     416024  ·       143186  ·           23  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  increaseUnlockTime  ·      44338  ·     413481  ·       140686  ·           23  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  quitLock            ·     127639  ·    1605731  ·       375486  ·           13  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  quitLock            ·     137330  ·    1615548  ·       385196  ·           13  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  VotingEscrow     ·  unlock              ·          -  ·          -  ·        14596  ·            3  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  VotingEscrow     ·  updateBlocklist     ·          -  ·          -  ·        47186  ·           14  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow     ·  withdraw            ·     106462  ·    3752666  ·       610141  ·           33  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow     ·  withdraw            ·     116189  ·    3762705  ·       619911  ·           33  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ····················|······················|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  Deployments                             ·                                           ·  % of limit   ·             │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ···········································|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@@ -215,8 +215,8 @@ No need to generate any newer typings.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ···········································|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> |  MockSmartWallet                         ·          -  ·          -  ·       416156  ·        3.3 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ···········································|·············|·············|···············|···············|··············</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-|  VotingEscrow                            ·    4374338  ·    4374350  ·      4374350  ·       35.1 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+|  VotingEscrow                            ·    4245313  ·    4245325  ·      4245325  ·       34.1 %  ·          -  │</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> ·------------------------------------------|-------------|-------------|---------------|---------------|-------------·</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-  117 passing (48s)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+  117 passing (44s)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span></span></span></code></pre>\n<h2 id=\"g04--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" style=\"position:relative;\"><a href=\"#g04--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\" aria-label=\"g04  using calldata instead of memory for read only arguments in external functions saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑04]  Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</h2>\n<p>When a function with a <code>memory</code> array is called externally, the <code>abi.decode()</code> step has to use a for-loop to copy each index of the <code>calldata</code> to the <code>memory</code> index. <strong>Each iteration of this for-loop costs at least 60 gas</strong> (i.e. <code>60 * &#x3C;mem_array>.length</code>). Using <code>calldata</code> directly, obliviates the need for such a loop in the contract code and runtime execution. Note that even if an interface defines a function as having <code>memory</code> arguments, it’s still valid for implementation contracs to use <code>calldata</code> arguments instead.</p>\n<p>If the array is passed to an <code>internal</code> function which passes the array to another internal function where the array is modified and therefore <code>memory</code> is used in the <code>external</code> call, it’s still more gass-efficient to use <code>calldata</code> when the <code>external</code> function uses modifiers, since the modifiers may prevent the internal functions from being called. Structs have the same overhead as an array of length one</p>\n<p>Note that I’ve also flagged instances where the function is <code>public</code> but can be marked as <code>external</code> since it’s not called by the contract, and cases where a constructor is involved</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"28\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _name</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit _symbol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">100</span><span class=\"mtk1\">       </span><span class=\"mtk11\">constructor</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">101</span><span class=\"mtk1\">           </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_owner</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">102</span><span class=\"mtk1\">           </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_penaltyRecipient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">103</span><span class=\"mtk1\">           </span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_token</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">104</span><span class=\"mtk1\">           </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_name</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">105</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_symbol</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L100-L105\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L100-L105</a></p>\n<h2 id=\"g05--using-storage-instead-of-memory-for-structsarrays-saves-gas\" style=\"position:relative;\"><a href=\"#g05--using-storage-instead-of-memory-for-structsarrays-saves-gas\" aria-label=\"g05  using storage instead of memory for structsarrays saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑05]  Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</h2>\n<p>When fetching data from a storage location, assigning the data to a <code>memory</code> variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (<strong>2100 gas</strong>) for <em>each</em> field of the struct/array. If the fields are read from the new memory variable, they incur an additional <code>MLOAD</code> rather than a cheap stack read. Instead of declearing the variable with the <code>memory</code> keyword, declaring the variable with the <code>storage</code> keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incuring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a <code>memory</code> variable, is if the full struct/array is being returned by the function, is being passed to a function that requires <code>memory</code>, or if the array/struct is being read from another <code>memory</code> array/struct</p>\n<p><em>There are 9 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"29\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">410</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">LockedBalance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">locked</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">446</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">LockedBalance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">locked</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">499</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">LockedBalance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">locked</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">527</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">LockedBalance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">locked</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">561</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">LockedBalance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">locked</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">633</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">LockedBalance</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">locked</span><span class=\"mtk1\">[</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">788</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">Point</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">point0</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pointHistory</span><span class=\"mtk1\">[</span><span class=\"mtk12\">epoch</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">866</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">Point</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lastPoint</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pointHistory</span><span class=\"mtk1\">[</span><span class=\"mtk12\">epoch_</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">882</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">Point</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">point</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pointHistory</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetEpoch</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L410\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L410</a></p>\n<h2 id=\"g06--avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\" style=\"position:relative;\"><a href=\"#g06--avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\" aria-label=\"g06  avoid contract existence checks by using solidity version 0810 or later permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑06]  Avoid contract existence checks by using solidity version 0.8.10 or later</h2>\n<p>Prior to 0.8.10 the compiler inserted extra code, including <code>EXTCODESIZE</code> (<strong>100 gas</strong>), to check for contract existence for external calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"30\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit decimals()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">115</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">IERC20</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_token</span><span class=\"mtk1\">).</span><span class=\"mtk11\">decimals</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit isBlocked()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">126</span><span class=\"mtk1\">:              !</span><span class=\"mtk11\">IBlocklist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">blocklist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">isBlocked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit isBlocked()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">563</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk11\">IBlocklist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">blocklist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">isBlocked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Blocked contract&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L115\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L115</a></p>\n<h2 id=\"g07--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" style=\"position:relative;\"><a href=\"#g07--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\" aria-label=\"g07  state variables should be cached in stack variables rather than re reading them from storage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑07]  State variables should be cached in stack variables rather than re-reading them from storage</h2>\n<p>The instances below point to the second+ access of a state variable within a function. Caching of a state variable replace each Gwarmaccess (<strong>100 gas</strong>) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"31\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit penaltyRecipient on line 676</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">677</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">emit</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CollectPenalty</span><span class=\"mtk1\">(</span><span class=\"mtk12\">amount</span><span class=\"mtk1\">, </span><span class=\"mtk12\">penaltyRecipient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit pointHistory on line 788</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">796</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">Point</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">point1</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pointHistory</span><span class=\"mtk1\">[</span><span class=\"mtk12\">epoch</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit pointHistory on line 882</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">891</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">Point</span><span class=\"mtk1\"> </span><span class=\"mtk12\">memory</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pointNext</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">pointHistory</span><span class=\"mtk1\">[</span><span class=\"mtk12\">targetEpoch</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">];</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L677\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L677</a></p>\n<h2 id=\"g08--x--y-costs-more-gas-than-x--x--y-for-state-variables\" style=\"position:relative;\"><a href=\"#g08--x--y-costs-more-gas-than-x--x--y-for-state-variables\" aria-label=\"g08  x  y costs more gas than x  x  y for state variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑08]  <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</h2>\n<p>Using the addition operator instead of plus-equals saves <strong><a href=\"https://gist.github.com/IllIllI000/cbbfb267425b898e5be734d4008d4fe8\">113 gas</a></strong></p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"32\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">654</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">penaltyAccumulated</span><span class=\"mtk1\"> += </span><span class=\"mtk12\">penaltyAmount</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L654\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L654</a></p>\n<h2 id=\"g09--internal-functions-only-called-once-can-be-inlined-to-save-gas\" style=\"position:relative;\"><a href=\"#g09--internal-functions-only-called-once-can-be-inlined-to-save-gas\" aria-label=\"g09  internal functions only called once can be inlined to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑09]  <code>internal</code> functions only called once can be inlined to save gas</h2>\n<p>Not inlining costs <strong>20 to 40 gas</strong> because of two extra <code>JUMP</code> instructions and additional stack operations needed for function calls.</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"33\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">features</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Blocklist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">37</span><span class=\"mtk1\">:       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_isContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">addr</span><span class=\"mtk1\">) </span><span class=\"mtk11\">internal</span><span class=\"mtk1\"> </span><span class=\"mtk11\">view</span><span class=\"mtk1\"> </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L37\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L37</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"34\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">662</span><span class=\"mtk1\">       </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_calculatePenaltyRate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">end</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">663           </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">664           </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">665:          </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">732       </span><span class=\"mtk11\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_findUserBlockEpoch</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">, </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_block</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">733           </span><span class=\"mtk11\">internal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">734           </span><span class=\"mtk11\">view</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">735:          </span><span class=\"mtk11\">returns</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L662-L665\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L662-L665</a></p>\n<h2 id=\"g10--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" style=\"position:relative;\"><a href=\"#g10--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\" aria-label=\"g10  add unchecked  for subtractions where the operands cannot underflow because of a previous require or if statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑10]  Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</h2>\n<p><code>require(a &#x3C;= b); x = b - a</code> => <code>require(a &#x3C;= b); unchecked { x = b - a }</code></p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"35\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit if-condition on line 299</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">301</span><span class=\"mtk1\">:                  (</span><span class=\"mtk12\">MULTIPLIER</span><span class=\"mtk1\"> * (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">blk</span><span class=\"mtk1\">)) /</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit if-condition on line 299</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">302</span><span class=\"mtk1\">:                  (</span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">lastPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ts</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L301\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L301</a></p>\n<h2 id=\"g11--ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" style=\"position:relative;\"><a href=\"#g11--ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\" aria-label=\"g11  ii should be uncheckediuncheckedi when it is not possible for them to overflow as is the case when used in for  and while loops permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑11]  <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</h2>\n<p>The <code>unchecked</code> keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves <strong>30-40 gas <a href=\"https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked\">per loop</a></strong></p>\n<p><em>There are 4 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"36\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">309</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">255</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">717</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">128</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">739</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">128</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">834</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">255</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L309\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L309</a></p>\n<h2 id=\"g12--optimize-names-to-save-gas\" style=\"position:relative;\"><a href=\"#g12--optimize-names-to-save-gas\" aria-label=\"g12  optimize names to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑12]  Optimize names to save gas</h2>\n<p><code>public</code>/<code>external</code> function names and <code>public</code> member variable names can be optimized to save gas. See <a href=\"https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9\">this</a> link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save <strong>128 gas</strong> each during deployment, and renaming functions to have lower method IDs will save <strong>22 gas</strong> per call, <a href=\"https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92\">per sorted position shifted</a></p>\n<p><em>There are 4 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"37\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">features</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Blocklist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit block(), isBlocked()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">9</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Blocklist</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L9\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L9</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"38\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IBlocklist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit isBlocked()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">6</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">interface</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IBlocklist</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IBlocklist.sol#L6\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IBlocklist.sol#L6</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"39\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IVotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit createLock(), increaseAmount(), increaseUnlockTime(), withdraw(), quitLock(), balanceOfAt(), totalSupplyAt(), forceUndelegate()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">4</span><span class=\"mtk1\">:    </span><span class=\"mtk4\">interface</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IVotingEscrow</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IVotingEscrow.sol#L4\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IVotingEscrow.sol#L4</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"40\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit updateBlocklist(), updatePenaltyRecipient(), unlock(), lockEnd(), getLastUserPoint(), checkpoint(), collectPenalty()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">23</span><span class=\"mtk1\">:   </span><span class=\"mtk12\">contract</span><span class=\"mtk1\"> </span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\"> </span><span class=\"mtk12\">is</span><span class=\"mtk1\"> </span><span class=\"mtk12\">IVotingEscrow</span><span class=\"mtk1\">, </span><span class=\"mtk12\">ReentrancyGuard</span><span class=\"mtk1\"> {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L23\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L23</a></p>\n<h2 id=\"g13--using-bools-for-storage-incurs-overhead\" style=\"position:relative;\"><a href=\"#g13--using-bools-for-storage-incurs-overhead\" aria-label=\"g13  using bools for storage incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑13]  Using <code>bool</code>s for storage incurs overhead</h2>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"41\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Booleans are more expensive than uint256 or any type that takes up a full</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// word because each write operation emits an extra SLOAD to first read the</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// slot&#39;s contents, replace the bits taken up by the boolean, and then write</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// back. This is the compiler&#39;s defense against contract upgrades and</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// pointer aliasing, and it cannot be disabled.</span></span></span></code></pre>\n<p><a href=\"https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27\">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27</a>\nUse <code>uint256(1)</code> and <code>uint256(2)</code> for true/false to avoid a Gwarmaccess (<strong><a href=\"https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058\">100 gas</a></strong>) for the extra SLOAD, and to avoid Gsset (<strong>20000 gas</strong>) when changing from <code>false</code> to <code>true</code>, after having been <code>true</code> in the past</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"42\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">features</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Blocklist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">10</span><span class=\"mtk1\">:       </span><span class=\"mtk11\">mapping</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">bool</span><span class=\"mtk1\">) </span><span class=\"mtk12\">private</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_blocklist</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L10\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L10</a></p>\n<h2 id=\"g14--use-a-more-recent-version-of-solidity\" style=\"position:relative;\"><a href=\"#g14--use-a-more-recent-version-of-solidity\" aria-label=\"g14  use a more recent version of solidity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑14]  Use a more recent version of solidity</h2>\n<p>Use a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than <code>revert()/require()</code> strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value</p>\n<p><em>There are 5 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"43\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">features</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Blocklist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">3</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L2\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"44\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IBlocklist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">3</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IBlocklist.sol#L2\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IBlocklist.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"45\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IERC20</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">3</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IERC20.sol#L2\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IERC20.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"46\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">interfaces</span><span class=\"mtk1\">/</span><span class=\"mtk12\">IVotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">3</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IVotingEscrow.sol#L2\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IVotingEscrow.sol#L2</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"47\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">2</span><span class=\"mtk1\">:    </span><span class=\"mtk12\">pragma</span><span class=\"mtk1\"> </span><span class=\"mtk12\">solidity</span><span class=\"mtk1\"> ^</span><span class=\"mtk7\">0.8</span><span class=\"mtk1\">.</span><span class=\"mtk7\">3</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L2\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L2</a></p>\n<h2 id=\"g15--using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\" style=\"position:relative;\"><a href=\"#g15--using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\" aria-label=\"g15  using  0 costs more gas than  0 when used on a uint in a require statement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑15]  Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</h2>\n<p>This change saves <strong><a href=\"https://aws1.discourse-cdn.com/business6/uploads/zeppelin/original/2X/3/363a367d6d68851f27d2679d10706cd16d788b96.png\">6 gas</a></strong> per instance. The optimization works until solidity version <a href=\"https://gist.github.com/IllIllI000/bf2c3120f24a69e489f12b3213c06c94\">0.8.13</a> where there is a regression in gas costs.</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"48\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">412</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only non zero amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">448</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only non zero amount&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L412\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L412</a></p>\n<h2 id=\"g16--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" style=\"position:relative;\"><a href=\"#g16--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\" aria-label=\"g16  i costs less gas than i especially when its used in for loops   ii   too permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑16]  <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</h2>\n<p>Saves <strong>5 gas per loop</strong></p>\n<p><em>There are 4 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"49\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">309</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">255</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">717</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">128</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">739</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">128</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">834</span><span class=\"mtk1\">:          </span><span class=\"mtk15\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\"> &lt; </span><span class=\"mtk7\">255</span><span class=\"mtk1\">; </span><span class=\"mtk12\">i</span><span class=\"mtk1\">++) {</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L309\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L309</a></p>\n<h2 id=\"g17--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" style=\"position:relative;\"><a href=\"#g17--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\" aria-label=\"g17  usage of uintsints smaller than 32 bytes 256 bits incurs overhead permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑17]  Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</h2>\n<blockquote>\n<p>When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</p>\n</blockquote>\n<p><a href=\"https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html\">https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html</a>\nEach operation involving a <code>uint8</code> costs an extra <a href=\"https://gist.github.com/IllIllI000/9388d20c70f9a4632eb3ca7836f54977\"><strong>22-28 gas</strong></a> (depending on whether the other operand is also a variable of type <code>uint8</code>) as compared to ones involving <code>uint256</code>, due to the compiler having to clear the higher bits of the memory word before operating on the <code>uint8</code>, as well as the associated stack operations of doing so. Use a larger size then downcast where needed</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"50\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit int128 oldSlopeDelta</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">380</span><span class=\"mtk1\">:                  </span><span class=\"mtk12\">oldSlopeDelta</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">oldSlopeDelta</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">userOldPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit int128 oldSlopeDelta</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">382</span><span class=\"mtk1\">:                      </span><span class=\"mtk12\">oldSlopeDelta</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">oldSlopeDelta</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">userNewPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// It was a new deposit, not extension</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit int128 newSlopeDelta</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">388</span><span class=\"mtk1\">:                      </span><span class=\"mtk12\">newSlopeDelta</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">newSlopeDelta</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">userNewPoint</span><span class=\"mtk1\">.</span><span class=\"mtk12\">slope</span><span class=\"mtk1\">; </span><span class=\"mtk3\">// old slope disappeared at this point</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L380\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L380</a></p>\n<h2 id=\"g18--using-private-rather-than-public-for-constants-saves-gas\" style=\"position:relative;\"><a href=\"#g18--using-private-rather-than-public-for-constants-saves-gas\" aria-label=\"g18  using private rather than public for constants saves gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑18]  Using <code>private</code> rather than <code>public</code> for constants, saves gas</h2>\n<p>If needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that returns a tuple of the values of all currently-public constants. Saves <strong>3406-3606 gas</strong> in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it’s used, and not adding another entry to the method ID table</p>\n<p><em>There are 3 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"51\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">46</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">WEEK</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">7</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">47</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MAXTIME</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">365</span><span class=\"mtk1\"> </span><span class=\"mtk12\">days</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">48</span><span class=\"mtk1\">:       </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">public</span><span class=\"mtk1\"> </span><span class=\"mtk12\">constant</span><span class=\"mtk1\"> </span><span class=\"mtk12\">MULTIPLIER</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">10</span><span class=\"mtk1\">**</span><span class=\"mtk7\">18</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L46\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L46</a></p>\n<h2 id=\"g19--division-by-two-should-use-bit-shifting\" style=\"position:relative;\"><a href=\"#g19--division-by-two-should-use-bit-shifting\" aria-label=\"g19  division by two should use bit shifting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑19]  Division by two should use bit shifting</h2>\n<p><code>&#x3C;x> / 2</code> is the same as <code>&#x3C;x> >> 1</code>. While the compiler uses the <code>SHR</code> opcode to accomplish both, the version that uses division incurs an overhead of <a href=\"https://gist.github.com/IllIllI000/ec0e4e6c4f52a6bca158f137a3afd4ff\"><strong>20 gas</strong></a> due to <code>JUMP</code>s to and from a compiler utility function that introduces checks which can be avoided by using <code>unchecked {}</code> around the division by two</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"52\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">719</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mid</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">min</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">max</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">743</span><span class=\"mtk1\">:              </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">mid</span><span class=\"mtk1\"> = (</span><span class=\"mtk12\">min</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">max</span><span class=\"mtk1\"> + </span><span class=\"mtk7\">1</span><span class=\"mtk1\">) / </span><span class=\"mtk7\">2</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L719\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L719</a></p>\n<h2 id=\"g20--stack-variable-used-as-a-cheaper-cache-for-a-state-variable-is-only-used-once\" style=\"position:relative;\"><a href=\"#g20--stack-variable-used-as-a-cheaper-cache-for-a-state-variable-is-only-used-once\" aria-label=\"g20  stack variable used as a cheaper cache for a state variable is only used once permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑20]  Stack variable used as a cheaper cache for a state variable is only used once</h2>\n<p>If the variable is only accessed once, it’s cheaper to use the state variable directly that one time, and save the <strong>3 gas</strong> the extra stack assignment would spend</p>\n<p><em>There is 1 instance of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"53\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">865</span><span class=\"mtk1\">:          </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">epoch_</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">globalEpoch</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L865\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L865</a></p>\n<h2 id=\"g21--require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" style=\"position:relative;\"><a href=\"#g21--require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\" aria-label=\"g21  require or revert statements that check input arguments should be at the top of the function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑21]  <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</h2>\n<p>Checks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (<strong>2100 gas</strong>*) in a function that may ultimately revert in the unhappy case.</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"54\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit expensive op on line 410</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">412</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only non zero amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/// @audit expensive op on line 446</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">448</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only non zero amount&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L412\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L412</a></p>\n<h2 id=\"g22--superfluous-event-fields\" style=\"position:relative;\"><a href=\"#g22--superfluous-event-fields\" aria-label=\"g22  superfluous event fields permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑22]  Superfluous event fields</h2>\n<p><code>block.timestamp</code> and <code>block.number</code> are added to event information by default so adding them manually wastes gas</p>\n<p><em>There are 2 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"55\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">30</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ts</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">36</span><span class=\"mtk1\">:           </span><span class=\"mtk12\">uint256</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ts</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L30\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L30</a></p>\n<h2 id=\"g23--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" style=\"position:relative;\"><a href=\"#g23--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\" aria-label=\"g23  use custom errors rather than revertrequire strings to save gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[G‑23]  Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</h2>\n<p>Custom errors are available from solidity version 0.8.4. Custom errors save <a href=\"https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746\"><strong>~50 gas</strong></a> each time they’re hit by <a href=\"https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth\">avoiding having to allocate and store the revert string</a>. Not defining the strings also save deployment gas</p>\n<p><em>There are 42 instances of this issue:</em></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"56\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">features</span><span class=\"mtk1\">/</span><span class=\"mtk12\">Blocklist</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">24</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">manager</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only manager&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">25</span><span class=\"mtk1\">:           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">_isContract</span><span class=\"mtk1\">(</span><span class=\"mtk12\">addr</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Only contracts&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L24\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L24</a></p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"57\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">File: </span><span class=\"mtk12\">contracts</span><span class=\"mtk1\">/</span><span class=\"mtk12\">VotingEscrow</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sol</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">116</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">decimals</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk7\">18</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Exceeds max decimals&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">125</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">126</span><span class=\"mtk1\">               !</span><span class=\"mtk11\">IBlocklist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">blocklist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">isBlocked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">127</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;Blocked contract&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">128</span><span class=\"mtk1\">:          );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">140</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">147</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">154</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">162</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">owner</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only owner&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">171</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">blocklist</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only Blocklist&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">412</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only non zero amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">413</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> == </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lock exists&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">414</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">unlock_time</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only increase lock end&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// from using quitLock, user should increaseAmount instead</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">415</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">unlock_time</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only future lock end&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">416</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">unlock_time</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">MAXTIME</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Exceeds maxtime&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">425</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">426</span><span class=\"mtk1\">               </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">427</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">428</span><span class=\"mtk1\">:          );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">448</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_value</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only non zero amount&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">449</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;No lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">450</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lock expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">469</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Delegatee has no lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">470</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Delegatee lock expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">485</span><span class=\"mtk1\">           </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">486</span><span class=\"mtk1\">               </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">487</span><span class=\"mtk1\">               </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">488</span><span class=\"mtk1\">:          );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">502</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;No lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">503</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">unlock_time</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only increase lock end&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">504</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">unlock_time</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">MAXTIME</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Exceeds maxtime&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">511</span><span class=\"mtk1\">:              </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">oldUnlockTime</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lock expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">529</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;No lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">530</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lock not expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">531</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lock delegated&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">546</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">value</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">563</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(!</span><span class=\"mtk11\">IBlocklist</span><span class=\"mtk1\">(</span><span class=\"mtk12\">blocklist</span><span class=\"mtk1\">).</span><span class=\"mtk11\">isBlocked</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Blocked contract&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">564</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;No lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">565</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\"> != </span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Already delegated&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">587</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Delegatee has no lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">588</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Delegatee lock expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">589</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">toLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt;= </span><span class=\"mtk12\">fromLocked</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only delegate to longer lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">635</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">amount</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk7\">0</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;No lock&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">636</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">end</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">timestamp</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lock expired&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">637</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">locked_</span><span class=\"mtk1\">.</span><span class=\"mtk12\">delegatee</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Lock delegated&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">657</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">remainingAmount</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">676</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">transfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">penaltyRecipient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">amount</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&quot;Transfer failed&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">776</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_blockNumber</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only past block number&quot;</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">877</span><span class=\"mtk1\">:          </span><span class=\"mtk11\">require</span><span class=\"mtk1\">(</span><span class=\"mtk12\">_blockNumber</span><span class=\"mtk1\"> &lt;= </span><span class=\"mtk12\">block</span><span class=\"mtk1\">.</span><span class=\"mtk12\">number</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&quot;Only past block number&quot;</span><span class=\"mtk1\">);</span></span></span></code></pre>\n<p><a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L116\">https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L116</a></p>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/223#issuecomment-1228644893\">lacoop6tu (FIAT DAO) commented</a>:</strong></p>\n<blockquote>\n<p>Good one</p>\n</blockquote>\n<hr>\n<h1 id=\"mitigation-review\" style=\"position:relative;\"><a href=\"#mitigation-review\" aria-label=\"mitigation review permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation Review</h1>\n<p><em>Mitigation review by IllIllI</em></p>\n<p><strong>Contest repository commit:</strong> <a href=\"https://github.com/code-423n4/2022-08-fiatdao/tree/fece3bdb79ccacb501099c24b60312cd0b2e4bb2\">https://github.com/code-423n4/2022-08-fiatdao/tree/fece3bdb79ccacb501099c24b60312cd0b2e4bb2</a><br>\n<strong>Project repository commit:</strong> <a href=\"https://github.com/fiatdao/veFDT/tree/8e88edb452b73bbe3461a8f4a5ed502db140322a\">https://github.com/fiatdao/veFDT/tree/8e88edb452b73bbe3461a8f4a5ed502db140322a</a><br>\n<strong>Final commit:</strong> <a href=\"https://github.com/fiatdao/veFDT/tree/3f822125e05e2927eab0a3a3e797508b363083ab\">https://github.com/fiatdao/veFDT/tree/3f822125e05e2927eab0a3a3e797508b363083ab</a><br></p>\n<h2 id=\"mitigation-prs-reviewed\" style=\"position:relative;\"><a href=\"#mitigation-prs-reviewed\" aria-label=\"mitigation prs reviewed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation PRs reviewed:</h2>\n<ul>\n<li><a href=\"https://github.com/fiatdao/veFDT/pull/13/files/f84fc5d43e2ad29fea031fe020913acc52507671\">Issue 2: _checkpoint function won’t be called for a user which is both a delegator and a delegatee in increaseUnlockTime</a></li>\n<li><a href=\"https://github.com/fiatdao/veFDT/pull/10/files/6b31b2535ba68c47dd4cafed7ce0d3e5fa07f64e\">Issue 3: Unnecessary if statement in _checkpoint</a></li>\n<li><a href=\"https://github.com/fiatdao/veFDT/pull/14/files/b9afd265fac9b3b3a3dc1440d47f421a41ff9639\">Issue 4: Lock owner can delegate after lock expiration</a></li>\n<li><a href=\"https://github.com/fiatdao/veFDT/pull/9/files/c96d67be01305e95711b7eac33fde484f562bb7a\">Issue 5: increaseUnlockTime uses wrong unlock time for old lock.</a></li>\n<li><a href=\"https://github.com/fiatdao/veFDT/pull/11/files/01aa495c4127d44025e442421a2d58256ee36f06\">Issue 6: Delegators can Avoid Lock Commitments if they can Reliably get Themselves Blocked when Needed</a></li>\n<li><a href=\"https://github.com/fiatdao/veFDT/pull/15/files/0909da169892a76de0b481ecc2c0e6087deebe02\">Issues 7 &#x26; 8: QA and gas optimization</a></li>\n<li><a href=\"https://github.com/fiatdao/veFDT/pull/19/files/9d532c58e30e9730050fe26dd82bb4c293691001\">Issue 18: Use safe transfer methods</a></li>\n</ul>\n<h2 id=\"intro\" style=\"position:relative;\"><a href=\"#intro\" aria-label=\"intro permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intro</h2>\n<p>veFDT is a solidity implementation of Curve’s voting-escrow, enhanced to give users the ability to delegate their locked tokens, to quit their locks early for a penalty, and to have their smart wallets optimistically approved.</p>\n<h3 id=\"disclaimer\" style=\"position:relative;\"><a href=\"#disclaimer\" aria-label=\"disclaimer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclaimer</h3>\n<p>This mitigation review does not guarantee the absence of any further vulnerabilities, being, however, the result of exercising the reviewer’s best efforts. At the time of the review, the final judging report was not yet available, so in addition to covering the resolved issues, the review also included an investigation of the disputed and acknowledged issues, as well as the issues downgraded to QA.</p>\n<h2 id=\"contest-issues-overview\" style=\"position:relative;\"><a href=\"#contest-issues-overview\" aria-label=\"contest issues overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Contest issues overview</h2>\n<p>The following is a high-level overview of the issues identified during FiatDAO’s August 2022 Code4rena audit contest, and any potential changes/feedback provided by the project sponsors in both the contest issue comments as well as the PRs listed above.</p>\n<h3 id=\"high-and-medium-risk-issues\" style=\"position:relative;\"><a href=\"#high-and-medium-risk-issues\" aria-label=\"high and medium risk issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High and Medium Risk Issues</h3>\n<ul>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231\">[H-01]</a> - Unsafe usage of ERC20 transfer and transferFrom</strong> (sponsor disputed)</p>\n<p>The sponsor disputed the issue because the token it’s planned to be used with does correctly return a boolean. However, the sponsor decided to make a change to address the finding as <a href=\"https://github.com/fiatdao/veFDT/pull/19/files/9d532c58e30e9730050fe26dd82bb4c293691001\">Issue 18</a>. The fix properly replaces the <code>require()</code> statements that check for successful transfers, with calls to OpenZeppelin’s <code>safeTransfer()</code>. The PR also replaces the internal definition of the <code>IERC20</code> interface with OpenZeppelin’s version. The prior version of the code’s <code>IERC20</code> included the function <code>decimals()</code>, which is not one of the required functions for the interface, so it’s possible for the code to encounter a token without this function, but it would be immediately apparent what happened because the constructor is the function that calls <code>decimals()</code>. The change to using OpenZeppelin required making this distinction more visible due to the fact that they’re defined separately as <code>IERC20</code> and <code>IERC20Metadata</code>. The new code is not checking that the token actually supports the function (e.g. using a <code>safeDecimals()</code>-like function), but it is not any worse off that it had been prior to the change.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204\">[H-02]</a> - Delegators can Avoid Lock Commitments if they can Reliably get Themselves Blocked when Needed</strong> (sponsor confirmed, severity disagreement)</p>\n<p>The sponsor disagreed with the severity and the judge updated the issue to be of Medium risk, and I agree with that severity. The finding was addressed via the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/11/files/01aa495c4127d44025e442421a2d58256ee36f06\">Issue 6</a> where the sponsor implemented the suggestion of the warden, to use the delegatee’s lock endpoint in the re-delegation to self, rather than using the delegator’s existing endpoint, since that endpoint may be far in the past. The delegate() and undelegate() functions have checks to ensure that the target for the votes always has at least as long a duration as the source of the votes. The fix enforces the same requirement for <code>forceUndelegate()</code> by assigning a longer duration.</p>\n<p>There are only two places in the code that change <code>LockedBalance.end</code> to a smaller value, which could possibly violate the contract invariants: in <a href=\"https://github.com/fiatdao/veFDT/blob/01aa495c4127d44025e442421a2d58256ee36f06/contracts/VotingEscrow.sol#L646-L651\"><code>quitLock()</code></a> where the struct is never written back to storage, and in <a href=\"https://github.com/fiatdao/veFDT/blob/01aa495c4127d44025e442421a2d58256ee36f06/contracts/VotingEscrow.sol#L537-L541\"><code>withdraw()</code></a> where it is indeed written back to storage. However, if the delegatee was able to withdraw, that means the delegator already would have been able to withdraw (since the delegatee’s timestamp must always be greater than or equal to the delegator’s when <a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md#delegate\">delegating</a> or <a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md#increaseamount\">increasing</a>), and therefore the mitigation is correct. The only extra wrinkle that the change makes, is that it now allows a malicious delegatee to front-run a delegator’s block with an <code>increaseUnlock(MAXTIME)</code>, but it’s not clear what advantage that would give the delegatee, and furthermore, the delegator already put his/her trust in the delegatee, so it’s something that could have occurred anyway, even without a call to <code>forceUndelegate()</code>.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229\">[M-01]</a> - The current implementation of the VotingEscrow contract doesn’t support fee on transfer tokens</strong> (sponsor disputed)</p>\n<p>The sponsor disputed the issue because the Balancer V2 Pool tokens it’s planned to be used with do not implement a fee-on-transfer mechanic. The tokens do not appear to be <a href=\"https://github.com/balancer-labs/balancer-v2-monorepo/blob/4085a05d5e42684a10a0b7b2caba454bd907ce22/pkg/pool-utils/contracts/BalancerPoolToken.sol#L35\">upgradeable</a> so there is no risk of fees being added to existing tokens via upgrade. Without more information about how which pool tokens are chosen/allowed/used, and what prevents future pool tokens that implement such a mechanic from being used with the same contract, I have to agree with the warden and judge that this is a Medium risk issue. The suggested mitigation is to measure the balance of the token that the contract holds before the <code>transferFrom()</code> call is made, and afterwards, and use the difference as the value, rather than the amount the user states. You could also add a <code>require()</code> enforcing the invariant that the change in balance must equal the stated amount, which would <em>prevent</em> fee-on-transfer tokens from being used.</p>\n<p>In the final PR, the sponsor has acknowledged the issue and added a code comment saying that fee-on-transfer tokens are not supported.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75\">[M-02]</a> - Attacker contract can avoid being blocked by BlockList.sol</strong> (sponsor acknowledged)</p>\n<p>The sponsor acknowledges that the <code>BlockList</code> can be bypassed, but <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232403488\">states</a> that “the only interaction possible is locking LP tokens first”. However, looking at the code, the <code>checkBlocklist</code> modifier is applied to not just <code>createLock()</code>, but <code>increaseAmount()</code>, <code>increaseUnlockTime()</code>, and <code>delegate()</code>. An attacker can bypass the block list for every one of these functions by making their SmartWallet a specially-constructed <code>create2()</code> contract that does external calls to an other contract in its constructor, for instructions on what to execute, before self-destructing. Whenever the attacker wants to interact with the token, they update their external instruction-providing contract with the action to take, re-create the attack contract. It’s not clear why the block list is only for contracts, and if it can be bypassed by using this method, or by transferring the tokens to an EOA.</p>\n<p>In discussions of the issue, the sponsor clarified that the <code>BlockList</code>’s purpose is to prevent lock tokenization, and acknowledged that using an updated <code>BlockList</code> that blocks specific EOAs may be required if an attacker uses the features described above to work around being blocked.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254\">[M-03]</a> - Inconsistent logic of increase unlock time to the expired locks</strong> (sponsor confirmed)</p>\n<p>The sponsor addressed the finding with the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/14/files/b9afd265fac9b3b3a3dc1440d47f421a41ff9639\">Issue 4</a>. The fix chosen was to not allow the increasing of lock time or non-self re-delegation if the delegatee’s lock has expired. The fix didn’t require the undelegate flavor to duplicate the blocklist check  since <code>msg.sender</code> is already checked by the <code>checkBlocklist</code> modifier. The refactored code properly re-used some variables rather than duplicating the allocations done in the delegation/re-delegation case in order to save some gas. The refactoring introduced a new issue, [M.N-01], described below.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/217\">[M-04]</a> - ERROR IN UPDATING  <code>_checkpoint</code> IN THE <code>increaseUnlockTime</code> FUNCTION</strong> (sponsor confirmed)</p>\n<p>The sponsor addressed the finding with the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/9/files/c96d67be01305e95711b7eac33fde484f562bb7a\">Issue 5</a>. The fix properly changes the code to match the invariants <a href=\"https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md\">specification</a>, and matches the logical expectation that the ‘old’ field uses the ‘old’ timestamp.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/228\">[M-05]</a> - Unsafe casting from int128 can cause wrong accounting of locked amounts</strong> (sponsor acknowledged)</p>\n<p>The sponsor acknowledges that overflow is technically possible, but considers this as unlikely to happen in practice.</p>\n<p>In the final PR, the sponsor added a code comment saying that the contract does not support tokens where <code>maxSupply>2^128-10^[decimals]</code>.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/318\">[M-06]</a> - <code>increaseUnlockTime</code> missing <code>_checkpoint</code> for delegated values</strong> (sponsor confirmed)</p>\n<p>The sponsor addressed the finding with the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/13/files/f84fc5d43e2ad29fea031fe020913acc52507671\">Issue 2</a>. In cases where a user is both a delegator and a delegatee, the original code did not create a checkpoint for calls to <code>increaseUnlockTime()</code>. Self-delegation and being delegated to both increase the <code>LockedBalance.delegated</code> field, so the change to the condition of the if-statement now includes both cases. The code will not get to the if-statement if the user has already withdrawn, due to a <code>require()</code>, so a user that has delegates but has withdrawn, cannot increase their now-zero unlock time. <code>increaseAmount()</code> has a similar if-statement and comment, but the else-block is already covered by a checkpoint, so there is no analogous issue there.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200\">[M-07]</a> - Blocking Through Change of Blocklist Could Trap Tokens</strong> (sponsor acknowledged)</p>\n<p>The sponsor acknowledges the possible rug vector. It is common for admin rug vectors to not be addressed.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237\">[M-08]</a> - Attackers can abuse the quitLock function to get a very large amount of votes</strong> (sponsor disputed)</p>\n<p>The sponsor disputed the issue on the basis of an economic analysis of the penalty taken vs the votes gained, the outcome of which was that the penalty always covers the votes gained. I spoke with the sponsor and the sponsor explained that for the original Curve Finance code, the number of votes one gets is not equal one-for-one to the number of tokens locked: locking for the maximum duration will get you close to one-for-one, but every second under that number, the locking user gets fewer and fewer votes. Therefore in veFTD, the penalty is always chosen such that when the penalty is subtracted from the votes gained, the number of votes a user is left with after quitting is equal to the number of votes they would have been given had they used the quit time as their lock end time instead. In other words, the votes one would get for locking for the week the warden mentions, would be equal to the penalty they gather ahead of time, so the flash loan does not help the attacker.</p>\n<p>To verify all of this, I wrote two tests that make use of hardhat’s ability to mine specific blocks with specific times. The <a href=\"https://gist.github.com/IllIllI000/e7d44c6bf21155c5cc076d3ace69d47f\">first</a> test confirmed that indeed, when one subtracts the penalty from the number of votes gained, the remaining number of votes is less than the number of votes a separate user gains for locking for the shorter duration, so it’s always better to specify the correct lock time rather and unlocking early. The <a href=\"https://gist.github.com/IllIllI000/16c7883c13ec35fd8c050aa25791a163\">second</a> test verifies that the same is true even if one quits the second after the lock is created. Finally, I wrote a <a href=\"https://gist.github.com/IllIllI000/67e2d48aa8b2cc33859d4ec962638c98\">test</a> that specifically does the flash loan scenario the warden outlined, and was able to show that when the attacking contract checks its balance between locking and quitting for the previous block, the votes are zero, and for the current block, the penalty is larger than the votes gained (and one cannot query vote balances for future blocks). Once the contract’s attack call completes, checks for the votes for same blocks show zero votes for both, so I believe the warden’s finding is invalid.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/227\">[Issue 227]</a> - Wrong penalty allocation computation</strong> (invalid)</p>\n<p>The sponsor walks though an example where a user is able to quit without a penalty, given a specific number of decimals, due to loss of precision. While having a smaller number of decimals can increase the value of each unit to the point where one wei is a worth-while amount, another way for each wei to increase in value is for the majority of the outstanding tokens to be burned. Yet another way to take advantage of the incorrect penalty is to split a large number of tokens into separate smaller chunks. As long as the gas cost to transfer the tokens, lock them, then unlock them is smaller than the economic value gained from the votes, it will be worth while to do the attack.</p>\n<p>I was able to write a <a href=\"https://gist.github.com/IllIllI000/63e170b9a07a321ceec79938ac804aa5\">test</a> that shows that by distributing tokens among nyms, an attacker is able to pay zero penalty on tiny amounts of wei because the loss of precision favors the quitter rather than the penalty recipient. In addition to fixing the loss of precision mentioned in Q-67 below, this advantage given to users that split their tokens among multiple addresses can be further mitigated by always ceil-ing fractional amounts:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"58\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">- uint256 penaltyAmount = (value * penaltyRate) / 10**18; // quitlock_penalty is in 18 decimals precision</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+ uint256 penaltyAmount = (value * penaltyRate + (10**18 - 1)) / 10**18; // quitlock_penalty is in 18 decimals precision</span></span></span></code></pre>\n<p>A simpler alternative is to just add a penalty of one wei to all quits.</p>\n<p>The sponsor disputes the part of the issue relating to a user being able to avoid paying any penalties on the basis of the fact that it only makes economic sense to do the attack if the value of one wei of the token is larger than the gas cost to create and quit a lock, otherwise the attacker would be better off losing the locked tokens to a penalty instead. The sponsor acknowledges that the rounding is done in the favor of the user having the penalty applied, rather than in the favor of the penalty recipient.</p>\n</li>\n</ul>\n<h3 id=\"low-risk-non-critical-and-gas\" style=\"position:relative;\"><a href=\"#low-risk-non-critical-and-gas\" aria-label=\"low risk non critical and gas permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Low Risk, Non-Critical, and Gas</h3>\n<ul>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/230\">[Issue 230]</a> - Divide before multiply in slope calculations</strong> (sponsor acknowledged)</p>\n<p>The sponsor acknowledges the possible rounding issue, but points out that if there is one, it’s in the Curve code base too. Curve, however, uses <a href=\"https://github.com/curvefi/curve-dao-contracts/blob/3bee979b7b6293c9e7654ee7dfbf5cc9ff40ca58/contracts/VotingEscrow.vy#L85\">four</a> years rather than veFTD’s one year, so the math may be slightly different.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/60\">[Issue 60]</a> - Delegation would be successful when delegatee lock expiration is same as delegator’s lock expiration.</strong> (sponsor disputed)</p>\n<p>The sponsor states that the documentation is wrong, not the code. Agreed, but there is no documentation change in the provided PRs.</p>\n<p>The sponsor provided a followup <a href=\"https://github.com/fiatdao/veFDT/pull/20/commits/0ff1b23caff9a774cac611f9189f10e1e4511dd9\">PR</a> that properly updates the documentation.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/248\">[Issue 248]</a> - First <code>userPointHistory</code> is never recorded</strong> (duplicate of Issue 294)</p>\n<p>Duplicate of [Issue 294] below</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/162\">[Issue 162]</a> - Miscalculation in <code>_calculatePenaltyRate</code> function</strong> (sponsor confirmed)</p>\n<p>The issue is that the 365-day <code>MAXTIME</code> is not divisible cleanly by <code>WEEK</code> (52<em>7 = 364), so due to the flooring that takes place, a user can never get his/her maximum voting power. I confirmed with a test that calling `createLock((WEEK</em>53)-1)` results in a lock duration of 364 days. This issue has not been addressed by any of the PRs provided by the sponsor.</p>\n<p>In discussions with the sponsor, the sponsor acknowledges the issue and will let the values remain as-is, since the issue only means that users are more disincentivized to quit early, since they will pay a slightly higher fee than if the two values were cleanly divisible.</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/114\">[Issue 114]</a> - penaltyAmount is deflated and remainingAmount is inflated when calling quitLock function of VotingEscrow contract according to current implementation</strong> (sponsor acknowledged)</p>\n<p>The sponsor acknowledges loss of precision leading to dust amounts not being accounted for properly, due to multiplication after division</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/117\">[Issue 117]</a> - VotingEscrow implementation does not match specification</strong> (sponsor disputed)</p>\n<p>Same as [Issue 60] above</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/152\">[Issue 152]</a> - The unlockTime ≥ owner.end in createLock function is inconsistent with design.</strong> (sponsor disputed)</p>\n<p>Same as [Issue 60] above</p>\n</li>\n<li>\n<p><strong><a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/294\">[Issue 294]</a> - Wrong logic in <code>_checkpoint()</code> function might lead to wrong value of <code>balanceOfAt()</code>, <code>totalSupplyAt()</code></strong> (sponsor confirmed)</p>\n<p>The sponsor addressed the finding with the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/10/files/6b31b2535ba68c47dd4cafed7ce0d3e5fa07f64e\">Issue 3</a>. The fix removes the setting of the first epoch, which is safe to do since everywhere that the contract references the <code>userPointHistory</code>, index zero is always special-cased to zero. Furthermore, there is no case where a <code>Point</code> is written with non-zero values, which would cause the public function <code>userPointHistory(addr,0)</code> to return wrong values. I would also note that the code prior to the fix was using <code>uEpoch + 1</code> whereas it should have been using <code>uEpoch</code> instead.</p>\n</li>\n<li>\n<p><strong>Miscellaneous</strong></p>\n<p>The sponsor addressed a subset of the QA and gas findings with the fix for <a href=\"https://github.com/fiatdao/veFDT/pull/15/files/0909da169892a76de0b481ecc2c0e6087deebe02\">Issues 7 &#x26; 8</a>. Some of the gas fixes were related to <code>for</code>-loops, splitting <code>+=</code>, state variable caching, <code>!=</code> in <code>require()</code>s, converting storage to immutables, removing casts where not necessary, and adding comments explaining the safety of mathematical operations, all of which were done properly. The PR also switched the rest of the code from using internal definitions of the ERC-20 interface, to using the OpenZeppelin versions (the changes started as a part of <a href=\"https://github.com/fiatdao/veFDT/pull/19/files/9d532c58e30e9730050fe26dd82bb4c293691001\">Issue 18</a>), and renamed the <code>block()</code> function.</p>\n</li>\n</ul>\n<h2 id=\"findings\" style=\"position:relative;\"><a href=\"#findings\" aria-label=\"findings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Findings</h2>\n<p>Findings are labeled with the following notation <code>M.S-N</code>, representing <code>Mitigation.Severity-Number</code>.</p>\n<h3 id=\"ml-01-code-does-not-follow-check-effects-interaction-best-practice\" style=\"position:relative;\"><a href=\"#ml-01-code-does-not-follow-check-effects-interaction-best-practice\" aria-label=\"ml 01 code does not follow check effects interaction best practice permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M.L-01] Code does not follow check-effects-interaction best practice</h3>\n<p>  One of the PRs under review for this mitigation, not tied to any issue identified during the contest, was <a href=\"https://github.com/fiatdao/veFDT/pull/22/commits/51f0001fd0576049341cfc8b9146cde9b9378797\">PR 22</a> where the sponsor introduced a new state variable that tracks the net number of tokens held by the contract, excluding any tokens externally transferred to the contract. While the code does properly track the net number (not including any discrepancies due to fee-on-transfer tokens already excluded by the sponsor), it does so by updating the state after the external calls that handle the transfer of tokens into and out of the contract. The best practice of <a href=\"https://docs.soliditylang.org/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern\">check-effects-interaction</a> requires that one perform all state updates (effects) <em>before</em> any external calls (interactions), so that the state is not vulnerable to re-entrancy attacks.</p>\n<p>While no funds are at risk, since the new variable is never used by the contract in any calculations, if Balancer LP tokens ever introduce transfer hooks, it would be possible for an attacker to get the contract to give the wrong answer about its balance, which may affect calculations that other contracts make.</p>\n<h4 id=\"proof-of-concept-10\" style=\"position:relative;\"><a href=\"#proof-of-concept-10\" aria-label=\"proof of concept 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<p>Each place that modifies the new <code>supply</code> variable, does so after a call that may be re-enterable in the future</p>\n<p><code>createLock()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"59\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">451</span><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">452</span><span class=\"mtk1\">        </span><span class=\"mtk3\">// Total supply of token deposited</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">453</span><span class=\"mtk1\">        </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L451-L453\">https://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L451-L453</a></p>\n<p><code>increaseAmount()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"60\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">517</span><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransferFrom</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk11\">address</span><span class=\"mtk1\">(</span><span class=\"mtk4\">this</span><span class=\"mtk1\">), </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">518</span><span class=\"mtk1\">        </span><span class=\"mtk3\">// Total supply of token deposited</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">519</span><span class=\"mtk1\">        </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> + </span><span class=\"mtk12\">_value</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L517-L519\">https://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L517-L519</a></p>\n<p><code>withdraw()</code>:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"61\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">583</span><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">value</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">584</span><span class=\"mtk1\">        </span><span class=\"mtk3\">// Total supply of token deposited</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">585</span><span class=\"mtk1\">        </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">value</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L583-L585\">https://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L583-L585</a></p>\n<p><code>quitLock()</code> (assumes penalty is deducted immediately):</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"62\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">715</span><span class=\"mtk1\">        </span><span class=\"mtk12\">token</span><span class=\"mtk1\">.</span><span class=\"mtk11\">safeTransfer</span><span class=\"mtk1\">(</span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">, </span><span class=\"mtk12\">remainingAmount</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">716</span><span class=\"mtk1\">        </span><span class=\"mtk3\">// Total supply of token deposited</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">717</span><span class=\"mtk1\">        </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">supply</span><span class=\"mtk1\"> - </span><span class=\"mtk12\">value</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p><a href=\"https://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L715-L717\">https://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L715-L717</a></p>\n<h4 id=\"recommended-mitigation-steps-10\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-10\" aria-label=\"recommended mitigation steps 10 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Move the update of the <code>supply</code> state variable so that it occurs before each external call</p>\n<h4 id=\"remediation\" style=\"position:relative;\"><a href=\"#remediation\" aria-label=\"remediation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Remediation</h4>\n<p>The sponsor properly addressed the issue with <a href=\"https://github.com/fiatdao/veFDT/pull/22/commits/0447eb9049e4d7d330185b9fdd22e4e471bf907b\">this</a> commit.</p>\n<h3 id=\"mn-01-mitigation-of-m-03issue-4-uses-non-standard-return-behaviors\" style=\"position:relative;\"><a href=\"#mn-01-mitigation-of-m-03issue-4-uses-non-standard-return-behaviors\" aria-label=\"mn 01 mitigation of m 03issue 4 uses non standard return behaviors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[M.N-01] Mitigation of [M-03/Issue 4] uses non-standard return behaviors</h3>\n<p>The fix in <a href=\"https://github.com/fiatdao/veFDT/pull/14/files/b9afd265fac9b3b3a3dc1440d47f421a41ff9639\">PR 14</a> for <a href=\"https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254\">M-03</a> incorrectly returns the result of a non-return-valued function in another non-return-valued function. While the code compiles and works, it’s confusing to see a function returning the result of a function that has no return values.</p>\n<h4 id=\"proof-of-concept-11\" style=\"position:relative;\"><a href=\"#proof-of-concept-11\" aria-label=\"proof of concept 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Proof of Concept</h4>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"63\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">554</span><span class=\"mtk1\">      </span><span class=\"mtk3\">// See IVotingEscrow for documentation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">555</span><span class=\"mtk1\">      </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">delegate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">address</span><span class=\"mtk1\"> </span><span class=\"mtk12\">_addr</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">556          </span><span class=\"mtk11\">external</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">557          </span><span class=\"mtk11\">override</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">558          </span><span class=\"mtk11\">nonReentrant</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">559          </span><span class=\"mtk11\">checkBlocklist</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">560      {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">561</span><span class=\"mtk1\">          </span><span class=\"mtk3\">// Different restrictions apply to undelegation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">562</span><span class=\"mtk1\">          </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">_addr</span><span class=\"mtk1\"> == </span><span class=\"mtk12\">msg</span><span class=\"mtk1\">.</span><span class=\"mtk12\">sender</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">563</span><span class=\"mtk1\">               </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">_undelegate</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">564</span><span class=\"mtk1\">          }</span></span></span></code></pre>\n<p><a href=\"https://github.com/fiatdao/veFDT/blob/b9afd265fac9b3b3a3dc1440d47f421a41ff9639/contracts/VotingEscrow.sol#L554-L564\">https://github.com/fiatdao/veFDT/blob/b9afd265fac9b3b3a3dc1440d47f421a41ff9639/contracts/VotingEscrow.sol#L554-L564</a></p>\n<h4 id=\"recommended-mitigation-steps-11\" style=\"position:relative;\"><a href=\"#recommended-mitigation-steps-11\" aria-label=\"recommended mitigation steps 11 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recommended Mitigation Steps</h4>\n<p>Move the return to after the function call:</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"diff\" data-index=\"64\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         // Different restrictions apply to undelegation</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         if (_addr == msg.sender) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">-             return _undelegate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+             _undelegate();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">+             return;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">         }</span></span></span></code></pre>\n<h4 id=\"remediation-1\" style=\"position:relative;\"><a href=\"#remediation-1\" aria-label=\"remediation 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Remediation</h4>\n<p>The sponsor properly addressed the issue with <a href=\"https://github.com/fiatdao/veFDT/pull/20/commits/0ff1b23caff9a774cac611f9189f10e1e4511dd9\">PR 20</a>.</p>\n<h2 id=\"final-changes\" style=\"position:relative;\"><a href=\"#final-changes\" aria-label=\"final changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final changes</h2>\n<p>All of the contest-related issue commits were properly combined into <a href=\"https://github.com/fiatdao/veFDT/pull/21/files/e2bb845795c9204842f5d3328925d864cb6f31ab\">PR 21</a>, along with some minor, correct, comment changes, and appear as <a href=\"https://github.com/fiatdao/veFDT/commit/4e80f80786bd8143c2e5b59ac2f66f99bb589094\">https://github.com/fiatdao/veFDT/commit/4e80f80786bd8143c2e5b59ac2f66f99bb589094</a>. The PRs for the non-contest issues and their mitigations were combined into <a href=\"https://github.com/fiatdao/veFDT/pull/22/commits/0447eb9049e4d7d330185b9fdd22e4e471bf907b\">PR 22</a>, and the final repository state is <a href=\"https://github.com/fiatdao/veFDT/tree/3f822125e05e2927eab0a3a3e797508b363083ab\">https://github.com/fiatdao/veFDT/tree/3f822125e05e2927eab0a3a3e797508b363083ab</a>.</p>\n<hr>\n<h1 id=\"disclosures\" style=\"position:relative;\"><a href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disclosures</h1>\n<p>C4 is an open organization governed by participants in the community.</p>\n<p>C4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>\n<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>",
  "toc": "<ul>\n<li>\n<p><a href=\"#overview\">Overview</a></p>\n<ul>\n<li><a href=\"#about-c4\">About C4</a></li>\n<li><a href=\"#wardens\">Wardens</a></li>\n</ul>\n</li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#scope\">Scope</a></li>\n<li><a href=\"#severity-criteria\">Severity Criteria</a></li>\n<li>\n<p><a href=\"#high-risk-findings-2\">High Risk Findings (2)</a></p>\n<ul>\n<li><a href=\"#h-01-unsafe-usage-of-erc20-transfer-and-transferfrom-\">[H-01] Unsafe usage of ERC20 transfer and transferFrom </a></li>\n<li><a href=\"#h-02-delegators-can-avoid-lock-commitments-if-they-can-reliably-get-themselves-blocked-when-needed\">[H-02] Delegators can Avoid Lock Commitments if they can Reliably get Themselves Blocked when Needed</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#medium-risk-findings-8\">Medium Risk Findings (8)</a></p>\n<ul>\n<li><a href=\"#m-01-the-current-implementation-of-the-votingescrow-contract-doesnt-support-fee-on-transfer-tokens\">[M-01] The current implementation of the VotingEscrow contract doesn’t support fee on transfer tokens</a></li>\n<li><a href=\"#m-02-attacker-contract-can-avoid-being-blocked-by-blocklistsol\">[M-02] Attacker contract can avoid being blocked by BlockList.sol</a></li>\n<li><a href=\"#m-03-inconsistent-logic-of-increase-unlock-time-to-the-expired-locks\">[M-03] Inconsistent logic of increase unlock time to the expired locks</a></li>\n<li><a href=\"#m-04-error-in-updating-_checkpoint-in-the-increaseunlocktime-function\">[M-04] Error in Updating <code>_checkpoint</code> in the <code>increaseUnlockTime</code> Function</a></li>\n<li><a href=\"#m-05-unsafe-casting-from-int128-can-cause-wrong-accounting-of-locked-amounts\">[M-05] Unsafe casting from int128 can cause wrong accounting of locked amounts</a></li>\n<li><a href=\"#m-06-increaseunlocktime-missing-_checkpoint-for-delegated-values\">[M-06] <code>increaseUnlockTime</code> missing <code>_checkpoint</code> for delegated values</a></li>\n<li><a href=\"#m-07-blocking-through-change-of-blocklist-could-trap-tokens\">[M-07] Blocking Through Change of Blocklist Could Trap Tokens</a></li>\n<li><a href=\"#m-08-attackers-can-abuse-the-quitlock-function-to-get-a-very-large-amount-of-votes\">[M-08] Attackers can abuse the <code>quitLock</code> function to get a very large amount of votes</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#low-risk-and-non-critical-issues\">Low Risk and Non-Critical Issues</a></p>\n<ul>\n<li><a href=\"#l-01-upgrade-open-zeppelin-contract-dependency\">L-01 Upgrade Open Zeppelin contract dependency</a></li>\n<li><a href=\"#l-02-no-transfer-ownership-pattern\">L-02 No Transfer Ownership Pattern</a></li>\n<li><a href=\"#l-03-unspecific-compiler-version-pragma\">L-03 Unspecific Compiler Version Pragma</a></li>\n<li><a href=\"#n-01-use-a-more-recent-version-of-solidity\">N-01 Use a more recent version of solidity</a></li>\n<li><a href=\"#n-02-large-multiples-of-ten-should-use-scientific-notation\">N-02 Large multiples of ten should use scientific notation</a></li>\n<li><a href=\"#n-03-use-scientific-notation-eg-1e18-rather-than-exponentiation-eg-1018\">N-03 Use scientific notation (e.g. 1e18) rather than exponentiation (e.g. 10**18)</a></li>\n<li><a href=\"#n-04-event-is-missing-indexed-fields\">N-04 Event is missing indexed fields</a></li>\n<li><a href=\"#n-05-missing-natspec\">N-05 Missing NatSpec</a></li>\n<li><a href=\"#n-06-constants-should-be-defined-rather-than-using-magic-numbers\">N-06 Constants should be defined rather than using magic numbers</a></li>\n<li><a href=\"#n-07-public-functions-not-called-by-the-contract-should-be-declared-external-instead\">N-07 Public functions not called by the contract should be declared external instead</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#gas-optimizations\">Gas Optimizations</a></p>\n<ul>\n<li><a href=\"#summary-1\">Summary</a></li>\n<li><a href=\"#g01--multiple-addressid-mappings-can-be-combined-into-a-single-mapping-of-an-addressid-to-a-struct-where-appropriate\">G‑01  Multiple <code>address</code>/ID mappings can be combined into a single <code>mapping</code> of an <code>address</code>/ID to a <code>struct</code>, where appropriate</a></li>\n<li><a href=\"#g02--state-variables-only-set-in-the-constructor-should-be-declared-immutable\">G‑02  State variables only set in the constructor should be declared <code>immutable</code></a></li>\n<li><a href=\"#g03--structs-can-be-packed-into-fewer-storage-slots\">G‑03  Structs can be packed into fewer storage slots</a></li>\n<li><a href=\"#g04--using-calldata-instead-of-memory-for-read-only-arguments-in-external-functions-saves-gas\">G‑04  Using <code>calldata</code> instead of <code>memory</code> for read-only arguments in <code>external</code> functions saves gas</a></li>\n<li><a href=\"#g05--using-storage-instead-of-memory-for-structsarrays-saves-gas\">G‑05  Using <code>storage</code> instead of <code>memory</code> for structs/arrays saves gas</a></li>\n<li><a href=\"#g06--avoid-contract-existence-checks-by-using-solidity-version-0810-or-later\">G‑06  Avoid contract existence checks by using solidity version 0.8.10 or later</a></li>\n<li><a href=\"#g07--state-variables-should-be-cached-in-stack-variables-rather-than-re-reading-them-from-storage\">G‑07  State variables should be cached in stack variables rather than re-reading them from storage</a></li>\n<li><a href=\"#g08--x--y-costs-more-gas-than-x--x--y-for-state-variables\">G‑08  <code>&#x3C;x> += &#x3C;y></code> costs more gas than <code>&#x3C;x> = &#x3C;x> + &#x3C;y></code> for state variables</a></li>\n<li><a href=\"#g09--internal-functions-only-called-once-can-be-inlined-to-save-gas\">G‑09  <code>internal</code> functions only called once can be inlined to save gas</a></li>\n<li><a href=\"#g10--add-unchecked--for-subtractions-where-the-operands-cannot-underflow-because-of-a-previous-require-or-if-statement\">G‑10  Add <code>unchecked {}</code> for subtractions where the operands cannot underflow because of a previous <code>require()</code> or <code>if</code>-statement</a></li>\n<li><a href=\"#g11--ii-should-be-uncheckediuncheckedi-when-it-is-not-possible-for-them-to-overflow-as-is-the-case-when-used-in-for--and-while-loops\">G‑11  <code>++i</code>/<code>i++</code> should be <code>unchecked{++i}</code>/<code>unchecked{i++}</code> when it is not possible for them to overflow, as is the case when used in <code>for</code>- and <code>while</code>-loops</a></li>\n<li><a href=\"#g12--optimize-names-to-save-gas\">G‑12  Optimize names to save gas</a></li>\n<li><a href=\"#g13--using-bools-for-storage-incurs-overhead\">G‑13  Using <code>bool</code>s for storage incurs overhead</a></li>\n<li><a href=\"#g14--use-a-more-recent-version-of-solidity\">G‑14  Use a more recent version of solidity</a></li>\n<li><a href=\"#g15--using--0-costs-more-gas-than--0-when-used-on-a-uint-in-a-require-statement\">G‑15  Using <code>> 0</code> costs more gas than <code>!= 0</code> when used on a <code>uint</code> in a <code>require()</code> statement</a></li>\n<li><a href=\"#g16--i-costs-less-gas-than-i-especially-when-its-used-in-for-loops---ii---too\">G‑16  <code>++i</code> costs less gas than <code>i++</code>, especially when it’s used in <code>for</code>-loops (<code>--i</code>/<code>i--</code> too)</a></li>\n<li><a href=\"#g17--usage-of-uintsints-smaller-than-32-bytes-256-bits-incurs-overhead\">G‑17  Usage of <code>uints</code>/<code>ints</code> smaller than 32 bytes (256 bits) incurs overhead</a></li>\n<li><a href=\"#g18--using-private-rather-than-public-for-constants-saves-gas\">G‑18  Using <code>private</code> rather than <code>public</code> for constants, saves gas</a></li>\n<li><a href=\"#g19--division-by-two-should-use-bit-shifting\">G‑19  Division by two should use bit shifting</a></li>\n<li><a href=\"#g20--stack-variable-used-as-a-cheaper-cache-for-a-state-variable-is-only-used-once\">G‑20  Stack variable used as a cheaper cache for a state variable is only used once</a></li>\n<li><a href=\"#g21--require-or-revert-statements-that-check-input-arguments-should-be-at-the-top-of-the-function\">G‑21  <code>require()</code> or <code>revert()</code> statements that check input arguments should be at the top of the function</a></li>\n<li><a href=\"#g22--superfluous-event-fields\">G‑22  Superfluous event fields</a></li>\n<li><a href=\"#g23--use-custom-errors-rather-than-revertrequire-strings-to-save-gas\">G‑23  Use custom errors rather than <code>revert()</code>/<code>require()</code> strings to save gas</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#mitigation-review\">Mitigation Review</a></p>\n<ul>\n<li><a href=\"#mitigation-prs-reviewed\">Mitigation PRs reviewed:</a></li>\n<li><a href=\"#intro\">Intro</a></li>\n<li><a href=\"#contest-issues-overview\">Contest issues overview</a></li>\n<li><a href=\"#findings\">Findings</a></li>\n<li><a href=\"#final-changes\">Final changes</a></li>\n</ul>\n</li>\n<li><a href=\"#disclosures\">Disclosures</a></li>\n</ul>",
  "md": "\n# Overview\n\n## About C4\n\nCode4rena (C4) is an open organization consisting of security researchers, auditors, developers, and individuals with domain expertise in smart contracts.\n\nA C4 audit contest is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\n\nDuring the audit contest outlined in this document, C4 conducted an analysis of the FIAT DAO veFDT smart contract system written in Solidity. The audit contest took place between August 12—August 15 2022.\n\nFollowing the C4 audit contest, warden IllIllI reviewed the mitigations for all identified issues; the mitigation review report is appended below the audit contest report. \n\n## Wardens\n\n135 Wardens contributed reports to the FIAT DAO veFDT contest:\n\n  1. [Respx](https://twitter.com/RespxR)\n  1. [CertoraInc](https://twitter.com/CertoraInc) (egjlmn1, [OriDabush](https://twitter.com/ori_dabush), ItayG, shakedwinder, and RoiEvenHaim)\n  1. scaraven\n  1. ak1\n  1. [jonatascm](https://twitter.com/jonataspvt)\n  1. [oyc&#95;109](https://twitter.com/andyfeili)\n  1. reassor\n  1. KIntern&#95;NA (TrungOre and duc)\n  1. cryptphi\n  1. JohnSmith\n  1. PwnedNoMore ([izhuer](https://www.cs.purdue.edu/homes/zhan3299/index.html), ItsNio, and papr1ka2)\n  1. 0x1f8b\n  1. [csanuragjain](https://twitter.com/csanuragjain)\n  1. DecorativePineapple\n  1. [rokinot](twitter.com/rokinot)\n  1. CodingNameKiki\n  1. 0xSky\n  1. cccz\n  1. ayeslick\n  1. Noah3o6\n  1. Waze\n  1. pedr02b2\n  1. peritoflores\n  1. IllIllI\n  1. cRat1st0s\n  1. ladboy233\n  1. rvierdiiev\n  1. robee\n  1. d3e4\n  1. [carlitox477](https://twitter.com/CAA1994)\n  1. [joestakey](https://twitter.com/JoeStakey)\n  1. [Dravee](https://twitter.com/BowTiedDravee)\n  1. [Aymen0909](https://github.com/Aymen1001)\n  1. [Deivitto](https://twitter.com/Deivitto)\n  1. auditor0517\n  1. [bin2chen](https://twitter.com/bin2chen)\n  1. wagmi\n  1. 0xf15ers (remora and twojoy)\n  1. [tabish](https://twitter.com/tabishjshaikh)\n  1. yixxas\n  1. [defsec](https://twitter.com/defsec_)\n  1. ajtra\n  1. [MiloTruck](https://milotruck.github.io/)\n  1. bobirichman\n  1. [pfapostol](https://t.me/pfahard)\n  1. Bnke0x0\n  1. [0xNazgul](https://twitter.com/0xNazgul)\n  1. [ret2basic](https://twitter.com/ret2basic)\n  1. Rolezn\n  1. [GalloDaSballo](https://twitter.com/gallodasballo)\n  1. ellahi\n  1. [gogo](https://www.linkedin.com/in/georgi-nikolaev-georgiev-978253219)\n  1. [JC](https://twitter.com/sm4rtcontr4ct)\n  1. ReyAdmirado\n  1. [c3phas](https://twitter.com/c3ph_)\n  1. [TomJ](https://mobile.twitter.com/tomj_bb)\n  1. PaludoX0\n  1. 0xLovesleep\n  1. 0xDjango\n  1. paribus\n  1. RedOneN\n  1. ElKu\n  1. Junnon\n  1. sikorico\n  1. &#95;&#95;141345&#95;&#95;\n  1. mics\n  1. [durianSausage](https://github.com/lyciumlee)\n  1. brgltd\n  1. [Funen](https://instagram.com/vanensurya)\n  1. rbserver\n  1. simon135\n  1. LeoS\n  1. erictee\n  1. [medikko](https://twitter.com/mehmeddukov)\n  1. [Sm4rty](https://twitter.com/Sm4rty_)\n  1. apostle0x01\n  1. [Chom](https://chom.dev)\n  1. 0xNineDec\n  1. delfin454000\n  1. [a12jmx](https://twitter.com/a12jmx)\n  1. 0xbepresent\n  1. [Ruhum](https://twitter.com/0xruhum)\n  1. djxploit\n  1. [natzuu](https://twitter.com/natzuu33)\n  1. asutorufos\n  1. sach1r0\n  1. bulej93\n  1. [Rohan16](https://twitter.com/ROHANJH56009256)\n  1. Yiko\n  1. [fatherOfBlocks](https://twitter.com/father0fBl0cks)\n  1. 0x52\n  1. Bahurum\n  1. RoiEvenHaim\n  1. neumo\n  1. 0xmatt\n  1. [seyni](https://twitter.com/seynixyz)\n  1. p&#95;crypt0\n  1. [saneryee](https://medium.com/@saneryee-studio)\n  1. Vexjon\n  1. [exd0tpy](https://github.com/exd0tpy)\n  1. Lambda\n  1. 0xsolstars ([Varun&#95;Verma](twitter.com/versatile_crypt) and masterchief)\n  1. byndooa\n  1. [sseefried](http://seanseefried.org/blog)\n  1. [wastewa](https://twitter.com/WahWaste)\n  1. [m&#95;Rassska](https://t.me/Road220)\n  1. newfork01\n  1. [Tomio](https://twitter.com/meidhiwirara)\n  1. [0xSmartContract](https://twitter.com/0xSmartContract)\n  1. Amithuddar\n  1. jag\n  1. 0x040\n  1. Metatron\n  1. saian\n  1. sashik&#95;eth\n  1. 0xHarry\n  1. 2997ms\n  1. [ignacio](https://twitter.com/0xheynacho)\n  1. SooYa\n  1. [gerdusx](https://twitter.com/GerdusM)\n  1. SpaceCake\n  1. 0xackermann\n  1. chrisdior4\n  1. CRYP70\n  1. [Fitraldys](https://twitter.com/fitraldys)\n  1. NoamYakov\n\nThis contest was judged by [Justin Goro](https://github.com/gititGoro).\n\nMitigations reviewed by IllIllI.\n\nFinal report assembled by [liveactionllama](https://twitter.com/liveactionllama).\n\n# Summary\n\nThe C4 analysis yielded an aggregated total of 10 unique vulnerabilities. Of these vulnerabilities, 2 received a risk rating in the category of HIGH severity and 8 received a risk rating in the category of MEDIUM severity.\n\nAdditionally, C4 analysis included 93 reports detailing issues with a risk rating of LOW severity or non-critical. There were also 93 reports recommending gas optimizations.\n\nAll of the issues presented here are linked back to their original finding.\n\n# Scope\n\nThe code under review can be found within the [C4 FIAT DAO veFDT contest repository](https://github.com/code-423n4/2022-08-fiatdao), and is composed of 5 smart contracts and interfaces written in the Solidity programming language and includes 746 lines of Solidity code.\n\n# Severity Criteria\n\nC4 assesses the severity of disclosed vulnerabilities according to a methodology based on [OWASP standards](https://owasp.org/www-community/OWASP_Risk_Rating_Methodology).\n\nVulnerabilities are divided into three primary risk categories: high, medium, and low/non-critical.\n\nHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\n\n- Malicious Input Handling\n- Escalation of privileges\n- Arithmetic\n- Gas use\n\nFurther information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on [the C4 website](https://code4rena.com).\n\n# High Risk Findings (2)\n## [[H-01] Unsafe usage of ERC20 transfer and transferFrom ](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231)\n_Submitted by CertoraInc, also found by 0x1f8b, 0xSky, CodingNameKiki, DecorativePineapple, jonatascm, Noah3o6, oyc&#95;109, pedr02b2, peritoflores, and Waze_\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L425-L428><br>\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L485-L488><br>\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L546><br>\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L657><br>\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L676><br>\n\nSome ERC20 tokens functions don't return a boolean, for example USDT, BNB, OMG. So the `VotingEscrow` contract simply won't work with tokens like that as the `token`.\n\n### Proof of Concept\n\nThe USDT's `transfer` and `transferFrom` functions doesn't return a bool, so the call to these functions will revert although the user has enough balance and the `VotingEscrow` contract won't work, assuming that token is USDT.\n\n### Tools Used\n\nManual auditing - VS Code, some hardhat tests and me :)\n\n### Recommended Mitigation Steps\n\nUse the OpenZepplin's `safeTransfer` and `safeTransferFrom` functions.\n\n**[lacoop6tu (FIAT DAO) disputed and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1216336341):**\n > In our case the token is a BalancerV2 Pool Token which returns the boolean\n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1232382424):**\n > This should be acknowledged, not disputed, since there is nothing in documentation suggesting the token is inherently safe to use. \n\n**[elnilz (FIAT DAO) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1241595744):**\n > @Justin Goro it's a no-issue in our specific case bc we will use VotingEscrow in combination with `token` which returns bool upon transfer/transferFrom. So at best this is a QA issue bc we should document that. some wardens actually asked us about what token we will be using pointing out the issue.\n> \n> Now even if you'd want to award wardens who reported the issue it should then be a Med Risk bc if VotingEscrow is deployed with an unsafe `token` ppl would simply not be able to deposit into the contract but no funds would be at risk.\n\n**[elnilz (FIAT DAO) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1242096432):**\n > Fyi, even though we don't think this is an issue, we will make use of safeTransfer and safeTransferFrom so its a helpful submission nonetheless.\n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231#issuecomment-1242900816):**\n > It's tokens like BNB that led me to maintain the high risk rating. For BNB, transferFrom returns a bool but transfer doesn't. In other words, users can stake but not unstake on any protocol that doesn't use safeTransfer.\n> \n> I agree that wardens should contact sponsors but it's not a channel we can really monitor. So although the net result is a documentation fix rather than a bug fix, it's a documentation fix informed by the identification of a potentially show stopping bug rather than something like \"Comment typo: it should be Bitcoin, not bit coin\".\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor disputed the issue because the token it's planned to be used with does correctly return a boolean. However, the sponsor decided to make a change to address the finding as [Issue 18](https://github.com/fiatdao/veFDT/pull/19/files/9d532c58e30e9730050fe26dd82bb4c293691001). The fix properly replaces the `require()` statements that check for successful transfers, with calls to OpenZeppelin's `safeTransfer()`. The PR also replaces the internal definition of the `IERC20` interface with OpenZeppelin's version. The prior version of the code's `IERC20` included the function `decimals()`, which is not one of the required functions for the interface, so it's possible for the code to encounter a token without this function, but it would be immediately apparent what happened because the constructor is the function that calls `decimals()`. The change to using OpenZeppelin required making this distinction more visible due to the fact that they're defined separately as `IERC20` and `IERC20Metadata`. The new code is not checking that the token actually supports the function (e.g. using a `safeDecimals()`-like function), but it is not any worse off that it had been prior to the change.\n\n\n\n***\n\n## [[H-02] Delegators can Avoid Lock Commitments if they can Reliably get Themselves Blocked when Needed](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204)\n_Submitted by Respx_\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L526-L625><br>\n\nUsers can enjoy the voting power of long lock times whilst not committing their tokens. This could cause the entire system to break down as the incentives don't work any more.\n\n### Exploit Method\n\nThis exploit only works if a user is able to use the system and reliably get themselves blocked. Blocking policies are not in scope, so I am assuming there would be a list of bannable offences, and thus this condition could be fulfilled.<br>\nConsider a user with two accounts, called Rider and Horse.<br>\nRider has 100,000 tokens.<br>\nHorse has 1 token.<br>\nRider is a smart contract (required for an account to be bannable).<br>\nRider locks for 1 week.<br>\nHorse locks for 52 weeks.<br>\nRider delegates to Horse.<br>\nHorse can continue to extend its lock period and enjoy the maximised voting power.<br>\nWhenever the user wants their tokens back, they simply need to get the Rider account blocked.<br>\nWhen Rider is blocked, `Blocklist.block(RiderAddress)` is called, which in turn calls `ve.forceUndelegate(RiderAddress)`.<br>\nRider is now an undelegated account with an expired lock. It can call `ve.withdraw()` to get its tokens back.<br>\nThe user can repeat this process with a fresh account taking the role of Rider.\n\n### Recommended Mitigation Steps\n\n`forceUndelegate()` could be made to set `locked_.end = fromLocked.end`. This would mean that blocked users are still locked into the system for the period they delegated for. However, this does have the downside of tokens being locked in the system without the full rights of the system which other users enjoy.<br>\nAlternatively, this might be addressable through not blocking users that seem to be doing this, but of course that might have other undersirable consequences.\n\n### Proof of Concept\n\nPlease see warden's [full report](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204) for proof of concept.\n\n**[lacoop6tu (FIAT DAO) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204#issuecomment-1217847907):**\n > `2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.`\n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204#issuecomment-1236040176):**\n > Well spotted by warden! The inflation of voting points may lead to an exploit, depending on possible proposals. Severity maintained.\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor disagreed with the severity and the judge updated the issue to be of Medium risk, and I agree with that severity. The finding was addressed via the fix for [Issue 6](https://github.com/fiatdao/veFDT/pull/11/files/01aa495c4127d44025e442421a2d58256ee36f06) where the sponsor implemented the suggestion of the warden, to use the delegatee's lock endpoint in the re-delegation to self, rather than using the delegator's existing endpoint, since that endpoint may be far in the past. The delegate() and undelegate() functions have checks to ensure that the target for the votes always has at least as long a duration as the source of the votes. The fix enforces the same requirement for `forceUndelegate()` by assigning a longer duration.\n  \n > There are only two places in the code that change `LockedBalance.end` to a smaller value, which could possibly violate the contract invariants: in [`quitLock()`](https://github.com/fiatdao/veFDT/blob/01aa495c4127d44025e442421a2d58256ee36f06/contracts/VotingEscrow.sol#L646-L651) where the struct is never written back to storage, and in [`withdraw()`](https://github.com/fiatdao/veFDT/blob/01aa495c4127d44025e442421a2d58256ee36f06/contracts/VotingEscrow.sol#L537-L541) where it is indeed written back to storage. However, if the delegatee was able to withdraw, that means the delegator already would have been able to withdraw (since the delegatee's timestamp must always be greater than or equal to the delegator's when [delegating](https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md#delegate) or [increasing](https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md#increaseamount)), and therefore the mitigation is correct. The only extra wrinkle that the change makes, is that it now allows a malicious delegatee to front-run a delegator's block with an `increaseUnlock(MAXTIME)`, but it's not clear what advantage that would give the delegatee, and furthermore, the delegator already put his/her trust in the delegatee, so it's something that could have occurred anyway, even without a call to `forceUndelegate()`.\n\n\n\n***\n \n# Medium Risk Findings (8)\n## [[M-01] The current implementation of the VotingEscrow contract doesn't support fee on transfer tokens](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229)\n_Submitted by CertoraInc, also found by cccz, csanuragjain, jonatascm, and scaraven_\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L418>\n\nSome ERC20 tokens implemented so a fee is taken when transferring them, for example `STA` and `PAXG`. The current implementation of the `VotingEscrow` contract will mess up the accounting of the locked amounts if `token` will be a token like that, what will lead to a state where users won't be able to receive their funds.\n\nThis will happen because the value that is added to the locked amount is not the actual value received by the contract, but the value supplied by the user (the value which the fee is taken from).\n\n### Proof of Concept\n\nThe `STA` token burns 1% of the value provided to the `transfer` function, which means the recipient gets only 99% of the transferred asset. Let's assume that `token` is the address of the `STA` token.\n\n1.  Bob wants to lock 100 STA tokens and calls `createLock(100 * 10**18, unlockTime)`.\n2.  The addition to the locked amount variable is done with `100 * 10**18`, while the actual amount that was received by the contract is `99 * 10**18`.\n3.  When the lock expires Bob will try to withdraw his tokens, and the transfer function will be called with the accounted locked amount (which is `100 * 10**18`). This might succeed due to other users locking too, so the transferred tokens will be taken from \"their tokens\", but in the end there will be users left without an option to withdraw their funds, because the balance of the contract will be less than the locked amount that the contract is trying to transfer.\n\n### Tools Used\n\nManual auditing - VS Code and me :)\n\n### Recommended Mitigation Steps\n\nCalculate the amount to add to the locked amount by the difference between the balances before and after the transfer instead of using the supplied value.\n\n**[lacoop6tu (FIAT DAO) disputed and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229#issuecomment-1216715477):**\n > In our case, the token will be BalancerV2 Pool Token , which has no fee on transfer, in case someone else would like to fork this contract and use it, that fix will be required.\n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229#issuecomment-1234997044):**\n > Given that the warden couldn't know the use of Balancer only tokens, the severity will still be upheld.\n\n**[elnilz (FIAT DAO) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229#issuecomment-1241715801):**\n > @Justin Goro so should we explicitly exclude all weird implementations of e.g. ERC20 in the future in the contest docs? I mean there are other wild examples of ERC20 implementations that someone could point out would cause problems with this contract. I am not trying to discount the work of any warden here but I think the correct response here as well as for #231 would be to improve docs stating which ERC20 implementations are safe to use in combination with VotingEscrow.\n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229#issuecomment-1242816667):**\n > @elnilz This topic is very important to get right and the more it's debated, the more it's clear that there is no one size fits all answer. When I sponsored a contest, I only figured out after the fact the sorts of things that would have reduced unhelpful warden submissions, through no fault of C4. \n>\n> My suggestion is that we curate an open source optional questionnaire for sponsors. The more detail the sponsor gives a priori, the more we can mark unhelpful issues as invalid. As an example, the tools I use to deploy my dapps do not allow me to accidentally omit addresses in constructor arguments. So wardens who warn me that I don't check for the zero address in my constructors are not helping me. The questionnaire would cover many common case submissions such as that. \n> \n> In your case, I had to dance a bit of a fine line: on the one hand, the wardens are not wrong in the event that you're unaware of token design nuance and so they shouldn't be penalized. On the other hand, this is a DAO and the wardens should at least suspect that the choice of token is a central decision. In the end, since both parties have good points to make and there's no clear decider, I chose to side with the wardens since it doesn't incur any additional cost to you as the sponsor and since it would seem unfair to penalize the wardens for an honest report with no flaws at the correct severity level. \n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor disputed the issue because the Balancer V2 Pool tokens it's planned to be used with do not implement a fee-on-transfer mechanic. The tokens do not appear to be [upgradeable](https://github.com/balancer-labs/balancer-v2-monorepo/blob/4085a05d5e42684a10a0b7b2caba454bd907ce22/pkg/pool-utils/contracts/BalancerPoolToken.sol#L35) so there is no risk of fees being added to existing tokens via upgrade. Without more information about how which pool tokens are chosen/allowed/used, and what prevents future pool tokens that implement such a mechanic from being used with the same contract, I have to agree with the warden and judge that this is a Medium risk issue. The suggested mitigation is to measure the balance of the token that the contract holds before the `transferFrom()` call is made, and afterwards, and use the difference as the value, rather than the amount the user states. You could also add a `require()` enforcing the invariant that the change in balance must equal the stated amount, which would _prevent_ fee-on-transfer tokens from being used.\n  \n > In the final PR, the sponsor has acknowledged the issue and added a code comment saying that fee-on-transfer tokens are not supported.\n\n\n\n***\n\n## [[M-02] Attacker contract can avoid being blocked by BlockList.sol](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75)\n_Submitted by JohnSmith, also found by ayeslick, reassor, rokinot, and scaraven_\n\nTo block an address it must pass the `isContract(address)` check:<br>\n<https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/features/Blocklist.sol#L25>\n\n    contracts/features/Blocklist.sol\n    25:         require(_isContract(addr), \"Only contracts\");\n\nWhich just checks code length at the address provided.\n\n    contracts/features/Blocklist.sol\n    37:     function _isContract(address addr) internal view returns (bool) {\n    38:         uint256 size;\n    39:         assembly {\n    40:             size := extcodesize(addr)\n    41:         }\n    42:         return size > 0;\n    43:     }\n\nAttacker can interact with the system and selfdestruct his contract, and with help of CREATE2 recreate it at same address when he needs to interact with the system again.\n\n### Proof of concept\n\nBelow is a simple example of salted contract creation, which you can test against `_isContract(address)` function.\n\n```solidity\npragma solidity 0.8.15;\n\ncontract BlockList {\n    function _isContract(address addr) external view returns (bool) {\n        uint256 size;\n        assembly {\n            size := extcodesize(addr)\n        }\n        return size > 0;\n    }\n}\n\ncontract AttackerContract {\n  function destroy() external {\n    selfdestruct(payable(0));\n  }\n}\n\ncontract AttackerFactory {\n    function deploy() external returns (address) {\n        return address(new AttackerContract{salt: bytes32(\"123\")}());\n    }\n}\n```\n\n### Recommended Mitigation Steps\n\nOne of the goals of Ethereum is for humans and smart contracts to both be treated equally. This leads into a future where smart contracts interact seamlessly with humans and other contracts. It might change in the future , but for now an arbitrary address is ambiguous.<br>\nWe should consider blacklisting addresses without checking if they are contracts.\n\n**[lacoop6tu (FIAT DAO) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1217810274):**\n > Duplicate of [#168](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/168) \n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232222354):**\n > This is a valid attack vector that undermines the blocking mechanism and is not a duplicate of #168.\n\n**[lacoop6tu (FIAT DAO) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232403488):**\n > IMO this is more acknowledged in this case, the only interaction possible is locking LP tokens first so if someone then selfdestructs, another attacker could create a contract with that address and take ownership (and quitLock for example) similar to what happened with optimism and wintermute.\n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232415680):**\n > The reason it's maintained as a medium risk is because there is a bit of circumventing of protocol restrictions. But as you indicated, it's not serious enough that marking it acknowledged is irresponsible.\n\n**[elnilz (FIAT DAO) acknowledged](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75)**\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor acknowledges that the `BlockList` can be bypassed, but [states](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232403488) that \"the only interaction possible is locking LP tokens first\". However, looking at the code, the `checkBlocklist` modifier is applied to not just `createLock()`, but `increaseAmount()`, `increaseUnlockTime()`, and `delegate()`. An attacker can bypass the block list for every one of these functions by making their SmartWallet a specially-constructed `create2()` contract that does external calls to an other contract in its constructor, for instructions on what to execute, before self-destructing. Whenever the attacker wants to interact with the token, they update their external instruction-providing contract with the action to take, re-create the attack contract. It's not clear why the block list is only for contracts, and if it can be bypassed by using this method, or by transferring the tokens to an EOA.\n\n > In discussions of the issue, the sponsor clarified that the `BlockList`'s purpose is to prevent lock tokenization, and acknowledged that using an updated `BlockList` that blocks specific EOAs may be required if an attacker uses the features described above to work around being blocked.\n\n\n\n***\n\n## [[M-03] Inconsistent logic of increase unlock time to the expired locks](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254)\n_Submitted by KIntern&#95;NA, also found by ak1, cryptphi, and scaraven_\n\nCan not prevent expired locks being extended.\n\n### Proof of Concept\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L493-L523>\n\nCall function function `increaseUnlockTime()` with an expired lock (locked\\[msg.sender].end < block.timestamp)\n\n*   Case 1: if sender's lock was not delegated to another address, function will be revert because of the requirement\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L511>\n\n*   Case 2: if sender's lock was delegated to another address, function will not check anything and the lock can be extended.\n\nBut in case 1, sender’s lock was not delegated to another, the sender can delegate to new address with end time of lock equal to new end time. After that he can call `increaseUnlockTime()` and move to case 2. Then sender can undelegate and the lock will be extended, and sender will take back vote power.\n\nHere is the script :\n\n```typescript\ndescribe(\"voting escrow\", async () => {\n    it(\"increase unlock time issue\", async () => {\n      await createSnapshot(provider);\n      //alice creates lock\n      let lockTime = WEEK + (await getTimestamp());\n      await ve.connect(alice).createLock(lockAmount, lockTime);\n      // bob creates lock\n      lockTime = 50 * WEEK + (await getTimestamp());\n      await ve.connect(bob).createLock(10 ** 8, lockTime);\n      //pass 1 week, alice's lock is expired\n      await ethers.provider.send(\"evm_mine\", [await getTimestamp() + WEEK]);\n      expect(await ve.balanceOf(alice.address)).to.eq(0);\n      //alice can not increase unlock timme\n      await expect(ve.connect(alice).increaseUnlockTime(lockTime)).to.be.revertedWith(\"Lock expired\");\n      //alice delegate to bob then can increase unlock time\n      await ve.connect(alice).delegate(bob.address);\n      await expect(ve.connect(alice).increaseUnlockTime(lockTime)).to.not.be.reverted;\n      //alice delegate back herself\n      await ve.connect(alice).delegate(alice.address);\n      expect(await ve.balanceOf(alice.address)).to.gt(0);\n    });\n```\n\n### Recommended Mitigation Steps\n\nIn every cases, expired locks should able to be extended -> should remove line [VotingEscrow.sol#L511](https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L511).\n\n**[lacoop6tu (FIAT DAO) confirmed](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254)**\n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254#issuecomment-1236020440):**\n > Very good report, especially because of that script.\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor addressed the finding with the fix for [Issue 4](https://github.com/fiatdao/veFDT/pull/14/files/b9afd265fac9b3b3a3dc1440d47f421a41ff9639). The fix chosen was to not allow the increasing of lock time or non-self re-delegation if the delegatee's lock has expired. The fix didn't require the undelegate flavor to duplicate the blocklist check  since `msg.sender` is already checked by the `checkBlocklist` modifier. The refactored code properly re-used some variables rather than duplicating the allocations done in the delegation/re-delegation case in order to save some gas. The refactoring introduced a new issue, [M.N-01], described below in the Mitigation Review section.\n\n\n\n***\n\n## [[M-04] Error in Updating `_checkpoint` in the `increaseUnlockTime` Function](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/217)\n_Submitted by Aymen0909, also found by 0xf15ers, 0xSky, auditor0517, bin2chen, CertoraInc, csanuragjain, JohnSmith, scaraven, tabish, wagmi, and yixxas_\n\nThe potentiel impact of this error are :\n\n*   Give wrong voting power to a user at a given block.\n*   Give wrong total voting power at a given block.\n*   Give wrong total voting power.\n\n### Proof of Concept\n\nThe error occured in this line :\n<https://github.com/code-423n4/2022-08-fiatdao/blob/main/contracts/VotingEscrow.sol#L513>\n\nIn the **increaseUnlockTime** function the oldLocked.end passed to the function **\\_checkpoint** is wrong as it is the same as the new newLock end time (called unlock_time) instead of being equal to **oldUnlockTime** .\n\nIn the given CheckpointMath.md file it is stated that checkpoint details for  **increaseUnlockTime** function should be :\n\n| Lock |      amount     |    end    |\n| ---- | :-------------: | :-------: |\n| old  | owner.delegated | owner.end |\n| new  | owner.delegated |     T     |\n\nBUT with this error  you get a different checkpoint details :\n\n| Lock |      amount     | end |\n| ---- | :-------------: | :-: |\n| old  | owner.delegated |  T  |\n| new  | owner.delegated |  T  |\n\nThe error is illustrated in the code below :\n\n            LockedBalance memory locked_ = locked[msg.sender];\n            uint256 unlock_time = _floorToWeek(_unlockTime); // Locktime is rounded down to weeks\n            /* @audit comment\n                     the unlock_time represent the newLock end time\n            */\n            // Validate inputs\n            require(locked_.amount > 0, \"No lock\");\n            require(unlock_time > locked_.end, \"Only increase lock end\");\n            require(unlock_time <= block.timestamp + MAXTIME, \"Exceeds maxtime\");\n            // Update lock\n            uint256 oldUnlockTime = locked_.end;\n            locked_.end = unlock_time;\n            /* @audit comment\n                     The locked_ end time is update from  oldUnlockTime  ==>  unlock_time\n            */\n            locked[msg.sender] = locked_;\n            if (locked_.delegatee == msg.sender) {\n                // Undelegated lock\n                require(oldUnlockTime > block.timestamp, \"Lock expired\");\n                LockedBalance memory oldLocked = _copyLock(locked_);\n                oldLocked.end = unlock_time;\n                /* @audit comment\n                     The oldLocked.end is set to unlock_time instead of   oldUnlockTime \n                */\n                _checkpoint(msg.sender, oldLocked, locked_);\n            }\n\nThe impact of this is when calculating the **userOldPoint.bias** in the **\\_checkpoint** function you get an incorrect value equal to **userNewPoint.bias** (because oldLocked.end == \\_newLocked.end which is wrong).\n\n    240        userOldPoint.bias =\n    241                    userOldPoint.slope *\n    242                    int128(int256(_oldLocked.end - block.timestamp));\n\nThe wrong **userOldPoint.bias** value is later used to calculate and update the bias value for the new point in **PointHistory**.\n\n    359       lastPoint.bias =\n    360                  lastPoint.bias +\n    361                  userNewPoint.bias -\n    362                  userOldPoint.bias;\n\n    372       pointHistory[epoch] = lastPoint;\n\nAnd added to that the wrong **oldLocked.end** is used to get oldSlopeDelta value which is used to update the **slopeChanges**.\n\n    271       oldSlopeDelta = slopeChanges[_oldLocked.end];\n\n    380       oldSlopeDelta = oldSlopeDelta + userOldPoint.slope;\n    381       if (_newLocked.end == _oldLocked.end) {\n    382                  oldSlopeDelta = oldSlopeDelta - userNewPoint.slope; // It was a new deposit, not extension\n    383        }\n    384       slopeChanges[_oldLocked.end] = oldSlopeDelta;\n\nAs the **PointHistory** and the **slopeChanges** values are used inside the functions **balanceOfAt()** ,  **\\_supplyAt()**,  **totalSupply()**,  **totalSupplyAt()** to calculate the voting power, **this error could give wrong voting power at a given block of a user or can give wrong total voting power**.\n\n### Recommended Mitigation Steps\n\nThe line 513 in the VotingEscrow\\.sol contract :\n\n          513      oldLocked.end = unlock_time;\n\nNeed to be replaced with the following :\n\n          513      oldLocked.end = oldUnlockTime;\n\n**[lacoop6tu (FIAT DAO) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/217#issuecomment-1217845853):**\n > As majority of wardens reported, this is Medium finding<br>\n> `2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.`\n\n**[Justin Goro (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/217#issuecomment-1234976983):**\n > The severity will be downgraded but otherwise a good report.\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor addressed the finding with the fix for [Issue 5](https://github.com/fiatdao/veFDT/pull/9/files/c96d67be01305e95711b7eac33fde484f562bb7a). The fix properly changes the code to match the invariants [specification](https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md), and matches the logical expectation that the 'old' field uses the 'old' timestamp.\n\n\n\n***\n\n## [[M-05] Unsafe casting from int128 can cause wrong accounting of locked amounts](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/228)\n_Submitted by CertoraInc, also found by 0x1f8b, carlitox477, cRat1st0s, DecorativePineapple, joestakey, ladboy233, reassor, and rvierdiiev_\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L418><br>\n\nThe unsafe casting to int128 variable can cause its value to be different from the correct value. For example in the createLock function, the addition to the locked amount variable is done by `locked_.amount += int128(int256(_value))`. In that case, if `_value` is greater than `type(int128).max` which is `2**127 - 1`, then the accounting will be wrong and the amount that will be added to `locked_.amount` will be less than the amount of token that will be transferred from the user. Then the user won't be able to withdraw the tokens that he transferred, and they'll be stuck in the contract forever.\n\n### Proof of Concept\n\n1.  Alice tries to lock `2**128` tokens. She calls `createLock(2**128, unlockTime)` with the time she wants to lock for.\n2.  The addition of the given value is done by `locked_.amount += int128(int256(_value))`, which actually does nothing to the `locked_.amount` variable and it remains 0. That's because when casting `int128(int256(2**128))` truncates to 0, and that leaves the locked amount unchanged but the tokens are transferred.\n\n### Tools Used\n\nManual auditing - VS Code and me :)\n\n### Recommended Mitigation Steps\n\nMake sure that the values fit in the variables you are trying to assign them to when casting variables to smaller types.\n\n**[lacoop6tu (FIAT DAO) acknowledged and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/228#issuecomment-1216343000):**\n > This is true but doesn't apply in our case, we use a BalV2 Pool Token which would never reach those values in terms of existing supply.\n\n**[Justin Goro (judge) decreased severity and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/228#issuecomment-1234923047):**\n > The use of Balancer tokens doesn't preclude numbers above 128bit. In the BalancerV2 source code, all amounts are in uint256. However, the widespread practice of standard Ethereum tokens makes the likelihood of even encountering a token balance above 128 bits is negligible and Balancer does scale down big tokens if the other tokens in the pool are lower when minting. \n> \n> Marking this as high risk is simply not realistic. This and its duplicates will be downgraded to medium risk (2) as it's a type of technicality that will have no bite in reality.\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor acknowledges that overflow is technically possible, but considers this as unlikely to happen in practice.\n>\n > In the final PR, the sponsor added a code comment saying that the contract does not support tokens where `maxSupply>2^128-10^[decimals]`.\n\n\n***\n\n## [[M-06] `increaseUnlockTime` missing `_checkpoint` for delegated values](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/318)\n_Submitted by PwnedNoMore, also found by ak1, CertoraInc, and scaraven_\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L509-L515><br>\n\nIn the VotingEscrow contract, users can increase their voting power by:\n\n*   Adding more funds to their delegated value\n*   Increasing the time of their lock\n*   Being delegated by another user\n\nSpecifically, when users are delegated by other users through the `delegate` function, the delegated user gains control over the delegate funds from the delegating user.\n\nThe delegated user can further increase this power by increasing the time that the delegated funds are locked by calling `increaseUnlockTime`, resulting in ALL the delegated funds controlled by the delegated user, including those that do not originate from the delegated user, being used to increase the voting power of the user.\n\nThe issue lies in the following scenario: If user A delegates to user B, and then user B delegates to user C, user B loses the ability to extend his or her voting power by `increaseUnlockTime` due to a missing `_checkpoint` operation. If user B calls the `increaseUnlockTime` function, the `_checkpoint` operation will not proceed, as user B is delegating to user C. However, B still owns delegated funds, in the form of the funds delegated from user A. Therefore, user B should still gain voting power from `increaseUnlockTime`, even though user B is delegating.\n\n### Proof of Concept\n\nAssume three users, Alice, Bob, and Carol, who each possess `locks` with 10 units of `delegate` value. Also assume that the unlock time is 1 week.\n\n*   Alice delegates her 10 units to Bob.\n*   Bob then delegates his 10 units to Carol.\n*   At this point, Alice has 0 `delegate`, value, Bob has 10 `delegate` value, and Carol has 20 `delegate` value.\n*   Carol calls `increaseUnlockTime` to 2 weeks, resulting in `_checkpoint` raising her voting power accordingly.\n*   Bob calls `increaseUnlockTime` to 2 weeks, resulting in no change in his voting power, even though he has 10 units of `delegate` value.\n\n### Recommended Mitigation Steps\n\nMove the `_checkpoint` outside of the `if` statement on line 514.\n\n**[lacoop6tu (FIAT DAO) confirmed, but disagreed with severity and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/318#issuecomment-1217846548):**\n > As most of wardens reported in duplicated, this is Medium finding<br>\n> `2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.`\n\n**[Justin Goro (judge) decreased severity to Medium](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/318)**\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor addressed the finding with the fix for [Issue 2](https://github.com/fiatdao/veFDT/pull/13/files/f84fc5d43e2ad29fea031fe020913acc52507671). In cases where a user is both a delegator and a delegatee, the original code did not create a checkpoint for calls to `increaseUnlockTime()`. Self-delegation and being delegated to both increase the `LockedBalance.delegated` field, so the change to the condition of the if-statement now includes both cases. The code will not get to the if-statement if the user has already withdrawn, due to a `require()`, so a user that has delegates but has withdrawn, cannot increase their now-zero unlock time. `increaseAmount()` has a similar if-statement and comment, but the else-block is already covered by a checkpoint, so there is no analogous issue there.\n\n\n\n***\n\n## [[M-07] Blocking Through Change of Blocklist Could Trap Tokens](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200)\n_Submitted by Respx_\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L27>\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L531>\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L637>\n\nIn the normal flow, an account that is blocked is protected from having its funds locked by a call to `forceUndelegate()`, as occurs on line 27 of `Blocklist.sol`.<br>\nHowever, this protection could potentially be circumvented if the value of `blocklist` is changed to an address which returns `True` for `isBlocked()` (as tested in the modifier `checkBlocklist()`) and if this account was not previously blocked (ie. `forceUndelegate()` was never called on it).<br>\nIn this situation, if the account has delegated, its tokens will be rendered irretrievable.\n\n### Proof of Concept\n\nThe blocked account would not be able to call `wthdraw()` successfully because of the check on line 531.<br>\nThe blocked account would not be able to call `quitLock()` successfully because of the check on line 637.<br>\nThe blocked account would not be able to call `delegate()` to undelegate and thereby allow it to make these calls because `delegate()` uses the `checkBlocklist` modifier.<br>\n`Blocklist` has no unblock functionality, so the only way to release the tokens would be through a redeployment of `Blocklist`.<br>\n\n### Recommended Mitigation Steps\n\nThis situation is most likely to occur as an error during a blocklist migration. In that case, it could be mitigated by adding an unblock functionality to the blocklist contract.\n\n**[lacoop6tu (FIAT DAO) acknowledged](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200)**\n\n**[elnilz (FIAT DAO) disagreed with severity and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200#issuecomment-1219308780):**\n > Not High Risk as no funds at risk. In the scenario outlined above, a clear path to restoring user's access to the blocked tokens exists.\n\n**[Justin Goro (judge) decreased severity to Meidum and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200#issuecomment-1232373516):**\n > Severity downgraded.\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor acknowledges the possible rug vector. It is common for admin rug vectors to not be addressed.\n\n\n\n***\n\n## [[M-08] Attackers can abuse the `quitLock` function to get a very large amount of votes](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237)\n_Submitted by CertoraInc_\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L632-L659>\n\nAn attacker can use a flashloan and the quitLock function to achieve a large amount of votes for one transaction. It can, depends on the implementation of the modules that will use this contract, be used to pass malicious proposals or exploit any feature that depends on the voting balance.\n\n### Proof of Concept\n\nWe assume here that there is a contract that provides a flashloan (for simplicity without fees, but can also work with fees, just requires the attacker to provide a larger amount of tokens) for the token that is used by the VotingEscrow contract.\n\n1.  The attacker deploys a smart contract that implements the following logic and approves the contract for the token that is used in the `VotingEscrow` contract (of course assigning all the values of the variables).\n2.  The attacker calls the `attack` function with the amount he wants to take as a flashloan (he will need to cover a penalty based on that amount).\n3.  The `attack` function calculates the penalty and transfers it from the attacker.\n4.  The `flashloan` function is called, which provides the tokens to the contract and then calls the `flashloanCallback` with the lent amount.\n5.  The `flashloanCallback` function creates a lock with the amount received from the flashloan for a week (the unlock time can be changed to achieve larger votes balance, but it must be considered when calculating the penalty).\n6.  The attacker can do whatever he wants with the amount of votes the contract currently has.\n7.  The quitLock function is called to get back the funds (excluding the penalty), and the loan is payed back.\n\n```sol\ncontract VotingEscrowAttack {\n    IERC20 constant token = IERC20(0x...); // the token used in the VotingEscrow contract\n    IVotingEscrow constant votingEscrow = IVotingEscrow(0x...); // the address of the VotingEscrow contract\n\n    uint constant WEEK = 1 weeks;\n    uint constant MAXTIME = 365 days;\n    uint constant MAXPENALTY = 10**18;\n\n    uint constant PENALTY_RATE = (WEEK * MAXPENALTY) / MAXTIME;\n\n    IFlashLoan constant flashloanContract = IFlashLoan(0x...); // the address of the flashloan provider\n\n    function attack(uint amount) external {\n        uint penalty = (amount * PENALTY_RATE) / (10 ** 18);\n        token.transferFrom(msg.sender, penalty); // assuming no flashloan fee\n        IFlashLoan.flashloan(token, amount);\n    }\n\n    function flashloanCallback(uint amount) {\n        votingEscrow.createLock(amount, block.timestamp + WEEK); // create a lock for a week with a very large of token\n\n        // do whatever you want with your large amount of votes\n        \n        votingEscrow.quitLock();\n        token.transfer(msg.sender, amount); // pay back the flashloan\n    }\n}\n```\n\n*   The function names, arguments and return values might not be accurate and might change depends on the used flashloan platform, but this contract is just to give a general idea of an attack vector.\n\n### Tools Used\n\nManual auditing - VS Code and me :)\n\n### Recommended Mitigation Steps\n\nThink about implementing a mechanism that prevents users from creating a lock and quitting it in the same transaction, that way attackers won't be able to use flashloan in order to achieve large voting power. However, regular loans will still be a problem with that fix, and if this isn't a wanted behavior, additional fix is needed to be thought of.\n\n**[lacoop6tu (FIAT DAO) acknowledged](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237)**\n\n**[elnilz (FIAT DAO) disagreed with severity and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1219290756):**\n > We actually could mitigate the issue by restricting increasing voting power and quitting in the same block. This would make the implementation safer.\n> \n> But even then, the severity is rather 2 as funds are not directly at risk.\n\n**[Justin Goro (judge) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1236035557):**\n > The scope of voting power is unclear. It may be that a proposal becomes possible that enables large funds transfers. For this reason, severity is maintained.\n\n**[elnilz (FIAT DAO) disputed and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1241689850):**\n > Did review the economics of this attack and they are the same than without quitLock:\n> \n> First, note that both balanceOf (voting power) and fee paid in quitLock are proportional to `(locked.end-block.timestamp)/MAXTIME` or remaining lock duration. In other words, in order to gain voting power, user also accepts higher quitLock fee.\n> \n> For max voting power user locks with MAXTIME. When quitting, this also results in the loss of all her locked tokens. Because the voting power decreases linearly with remaining lock duration, the amount of tokens that need be locked in order to achieve same voting power increases with lower lock durations. This results in the same quitLock fee as if the user would chose max lock duration or if user would not be able to quit at all.\n> \n> See this interactive graph and play with the t (remaining lock duration) and N (tokens locked) sliders: https://www.desmos.com/calculator/yjby9zempb\n> \n> Thus, quitLock doesn't change the economics of governance attacks and so we dispute this issue.\n\n**[Justin Goro (judge) decreased severity to Medium and commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1242815658):**\n > Upon reconsideration, it appears the dampening effect of the penalty ensures that this FlashLoan attack is only really viable at very low impact levels. The larger the attack, the more the cost of the attack will exceed any benefit. The only case where this wouldn't be the case is when a small vote can tip the balance of an important decision which is unlikely in a gauge style vote. But even if a threshold emerges, the attacker may as well just get the votes through normal channels. \n> \n> Nonetheless, the vector is only dampened, not eradicated and so I'll be downgrading this to Medium severity.\n\n**[elnilz (FIAT DAO) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237#issuecomment-1243314912):**\n > Thanks for reconsidering. I'd also be curious about feedback from CertoraInc as it's been reported by the user.\n> \n> The implications of the above analysis are, however, that the cost of an attack is the same as with Curve's VotingEscrow which doesn't implement a quitLock function. So unless the attack vector on Curve itself is also a medium severity this issue should be invalidated.\n\n**IllIllI (warden) reviewed mitigation:**\n > The sponsor disputed the issue on the basis of an economic analysis of the penalty taken vs the votes gained, the outcome of which was that the penalty always covers the votes gained. I spoke with the sponsor and the sponsor explained that for the original Curve Finance code, the number of votes one gets is not equal one-for-one to the number of tokens locked: locking for the maximum duration will get you close to one-for-one, but every second under that number, the locking user gets fewer and fewer votes. Therefore in veFTD, the penalty is always chosen such that when the penalty is subtracted from the votes gained, the number of votes a user is left with after quitting is equal to the number of votes they would have been given had they used the quit time as their lock end time instead. In other words, the votes one would get for locking for the week the warden mentions, would be equal to the penalty they gather ahead of time, so the flash loan does not help the attacker.\n>  \n > To verify all of this, I wrote two tests that make use of hardhat's ability to mine specific blocks with specific times. The [first](https://gist.github.com/IllIllI000/e7d44c6bf21155c5cc076d3ace69d47f) test confirmed that indeed, when one subtracts the penalty from the number of votes gained, the remaining number of votes is less than the number of votes a separate user gains for locking for the shorter duration, so it's always better to specify the correct lock time rather and unlocking early. The [second](https://gist.github.com/IllIllI000/16c7883c13ec35fd8c050aa25791a163) test verifies that the same is true even if one quits the second after the lock is created. Finally, I wrote a [test](https://gist.github.com/IllIllI000/67e2d48aa8b2cc33859d4ec962638c98) that specifically does the flash loan scenario the warden outlined, and was able to show that when the attacking contract checks its balance between locking and quitting for the previous block, the votes are zero, and for the current block, the penalty is larger than the votes gained (and one cannot query vote balances for future blocks). Once the contract's attack call completes, checks for the votes for same blocks show zero votes for both, so I believe the warden's finding is invalid.\n\n\n\n***\n\n# Low Risk and Non-Critical Issues\n\nFor this contest, 93 reports were submitted by wardens detailing low risk and non-critical issues. The [report highlighted below](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/9) by **oyc&#95;109** received the top score from the judge.\n\n*The following wardens also submitted reports: [d3e4](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/313), [robee](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/147), [Deivitto](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/266), [CodingNameKiki](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/2), [IllIllI](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/222), [defsec](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/301), [bobirichman](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/35), [Dravee](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/255), [0xNazgul](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/197), [pfapostol](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/56), [GalloDaSballo](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/283), [Rolezn](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/5), [ellahi](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/48), [0x52](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/120), [gogo](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/84), [Respx](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/192), [Bnke0x0](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/179), [Aymen0909](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/264), [JC](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/324), [PaludoX0](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/138), [Bahurum](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/262), [ret2basic](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/187), [TomJ](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/219), [ElKu](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/132), [Junnon](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/135), [RedOneN](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/100), [ReyAdmirado](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/55), [RoiEvenHaim](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/51), [sikorico](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/41), [cRat1st0s](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/95), [auditor0517](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/196), [reassor](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/47), [JohnSmith](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/77), [c3phas](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/278), [ladboy233](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/186), [mics](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/39), [0xDjango](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/142), [ajtra](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/312), [bin2chen](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/146), [brgltd](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/285), [Funen](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/291), [Noah3o6](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/104), [ak1](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/154), [CertoraInc](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/245), [erictee](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/11), [MiloTruck](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/81), [neumo](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/57), [simon135](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/111), [0x1f8b](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/28), [&#95;&#95;141345&#95;&#95;](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/72), [apostle0x01](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/289), [0xmatt](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/167), [seyni](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/277), [0xNineDec](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/250), [rbserver](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/65), [rvierdiiev](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/207), [Waze](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/242), [a12jmx](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/320), [delfin454000](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/241), [LeoS](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/177), [KIntern&#95;NA](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/274), [Ruhum](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/105), [Sm4rty](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/214), [p&#95;crypt0](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/23), [wagmi](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/294), [Chom](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/233), [saneryee](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/155), [Vexjon](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/272), [bulej93](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/297), [cryptphi](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/61), [djxploit](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/259), [exd0tpy](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/71), [natzuu](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/311), [0xLovesleep](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/244), [Lambda](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/19), [paribus](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/116), [asutorufos](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/305), [0xbepresent](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/45), [0xsolstars](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/309), [csanuragjain](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/31), [DecorativePineapple](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/175), [durianSausage](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/16), [jonatascm](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/166), [medikko](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/319), [Rohan16](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/258), [rokinot](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/110), [sach1r0](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/127), [byndooa](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/328), [sseefried](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/133), [fatherOfBlocks](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/53), [Yiko](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/205), and [wastewa](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/170).*\n\n## [L-01] Upgrade Open Zeppelin contract dependency\n\nAn outdated OZ version is used (which has known vulnerabilities, see <https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories>).\n\nThe solution uses:\n\n    \"@openzeppelin/contracts\": \"^4.4.2\",\n\n## [L-02] No Transfer Ownership Pattern\n\nRecommend considering implementing a two step process where the owner or admin nominates an account and the nominated account needs to call an acceptOwnership() function for the transfer of ownership to fully succeed. This ensures the nominated EOA account is a valid and active account.\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L139-L143>\n\n## [L-03] Unspecific Compiler Version Pragma\n\nAvoid floating pragmas for non-library contracts.\n\nWhile floating pragmas make sense for libraries to allow them to be included with multiple different versions of applications, it may be a security risk for application implementations.\n\nA known vulnerable compiler version may accidentally be selected or security tools might fall-back to an older compiler version ending up checking a different EVM compilation that is ultimately deployed on the blockchain.\n\nIt is recommended to pin to a concrete compiler version.\n\n    Blocklist.sol::2 => pragma solidity ^0.8.3;\n    IBlocklist.sol::2 => pragma solidity ^0.8.3;\n    IERC20.sol::2 => pragma solidity ^0.8.3;\n    IVotingEscrow.sol::2 => pragma solidity ^0.8.3;\n    VotingEscrow.sol::2 => pragma solidity ^0.8.3;\n\n## [N-01] Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.4 to get bytes.concat() instead of abi.encodePacked(<bytes>,<bytes>)\nUse a solidity version of at least 0.8.12 to get string.concat() instead of abi.encodePacked(<str>,<str>)\nUse a solidity version of at least 0.8.13 to get the ability to use using for with a list of free functions\n\n    Blocklist.sol::2 => pragma solidity ^0.8.3;\n    IBlocklist.sol::2 => pragma solidity ^0.8.3;\n    IERC20.sol::2 => pragma solidity ^0.8.3;\n    IVotingEscrow.sol::2 => pragma solidity ^0.8.3;\n    VotingEscrow.sol::2 => pragma solidity ^0.8.3;\n\n## [N-02] Large multiples of ten should use scientific notation\n\nUse (e.g. 1e6) rather than decimal literals (e.g. 1000000), for better code readability\n\n    VotingEscrow.sol::57 => Point[1000000000000000000] public pointHistory; // 1e9 * userPointHistory-length, so sufficient for 1e9 users\n    VotingEscrow.sol::58 => mapping(address => Point[1000000000]) public userPointHistory;\n\n## [N-03] Use scientific notation (e.g. 1e18) rather than exponentiation (e.g. 10&ast;&ast;18)\n\nScientific notation should be used for better code readability\n\n    VotingEscrow.sol::48 => uint256 public constant MULTIPLIER = 10**18;\n    VotingEscrow.sol::51 => uint256 public maxPenalty = 10**18; // penalty for quitters with MAXTIME remaining lock\n    VotingEscrow.sol::653 => uint256 penaltyAmount = (value * penaltyRate) / 10**18; // quitlock_penalty is in 18 decimals precision\n\n## [N-04] Event is missing indexed fields\n\nEach event should use three indexed fields if there are three or more fields\n\n    VotingEscrow.sol::38 => event TransferOwnership(address owner);\n    VotingEscrow.sol::39 => event UpdateBlocklist(address blocklist);\n    VotingEscrow.sol::40 => event UpdatePenaltyRecipient(address recipient);\n    VotingEscrow.sol::41 => event CollectPenalty(uint256 amount, address recipient);\n\n## [N-05] Missing NatSpec\n\nCode should include NatSpec\n\n    IERC20.sol::1 => // SPDX-License-Identifier: Apache-2.0\n\n## [N-06] Constants should be defined rather than using magic numbers\n\nIt is bad practice to use numbers directly in code without explanation\n\n    VotingEscrow.sol::309 => for (uint256 i = 0; i < 255; i++) {\n\n## [N-07] Public functions not called by the contract should be declared external instead\n\nContracts are allowed to override their parents' functions and change the visibility from external to public.\n\n    Blocklist.sol::33 => function isBlocked(address addr) public view returns (bool) {\n    VotingEscrow.sol::754 => function balanceOf(address _owner) public view override returns (uint256) {\n    VotingEscrow.sol::864 => function totalSupply() public view override returns (uint256) {\n\n\n\n***\n\n# Gas Optimizations\n\nFor this contest, 93 reports were submitted by wardens detailing gas optimizations. The [report highlighted below](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/223) by **IllIllI** received the top score from the judge.\n\n*The following wardens also submitted reports: [Dravee](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/235), [JohnSmith](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/78), [0x1f8b](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/25), [ajtra](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/304), [MiloTruck](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/80), [Bnke0x0](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/73), [Deivitto](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/265), [ret2basic](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/50), [pfapostol](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/29), [oyc&#95;109](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/8), [Aymen0909](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/220), [m&#95;Rassska](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/252), [defsec](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/303), [c3phas](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/299), [ReyAdmirado](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/54), [CodingNameKiki](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/14), [gogo](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/82), [JC](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/321), [TomJ](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/215), [0xLovesleep](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/226), [0xDjango](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/141), [paribus](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/115), [Rolezn](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/6), [CertoraInc](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/260), [newfork01](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/173), [robee](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/148), [Tomio](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/210), [&#95;&#95;141345&#95;&#95;](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/70), [0xSmartContract](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/327), [0xNazgul](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/195), [cRat1st0s](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/93), [durianSausage](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/15), [reassor](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/46), [RedOneN](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/99), [Amithuddar](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/275), [jag](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/129), [rbserver](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/64), [0x040](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/317), [brgltd](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/286), [ElKu](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/130), [LeoS](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/178), [simon135](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/112), [Waze](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/225), [medikko](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/287), [Metatron](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/211), [saian](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/209), [Sm4rty](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/213), [Chom](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/249), [GalloDaSballo](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/284), [Noah3o6](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/103), [sashik&#95;eth](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/306), [0xHarry](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/24), [rokinot](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/109), [0xbepresent](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/44), [2997ms](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/119), [bobirichman](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/33), [ignacio](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/3), [SooYa](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/310), [mics](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/37), [ak1](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/144), [asutorufos](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/300), [djxploit](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/256), [Junnon](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/128), [natzuu](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/308), [PaludoX0](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/137), [Ruhum](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/106), [sach1r0](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/126), [apostle0x01](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/290), [bulej93](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/293), [d3e4](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/307), [delfin454000](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/238), [gerdusx](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/314), [ladboy233](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/183), [rvierdiiev](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/208), [SpaceCake](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/159), [0xackermann](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/212), [0xNineDec](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/251), [carlitox477](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/161), [chrisdior4](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/151), [CRYP70](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/98), [sikorico](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/40), [a12jmx](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/322), [csanuragjain](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/30), [Respx](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/190), [Rohan16](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/257), [Yiko](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/203), [ellahi](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/49), [erictee](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/10), [fatherOfBlocks](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/52), [Fitraldys](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/276), [Funen](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/292), and [NoamYakov](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/323).*\n\n## Summary\n\n|        | Issue                                                                                                                                                      | Instances |\n| ------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------: |\n| [G‑01] | Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, where appropriate                                 |     1     |\n| [G‑02] | State variables only set in the constructor should be declared `immutable`                                                                                 |     14    |\n| [G‑03] | Structs can be packed into fewer storage slots                                                                                                             |     1     |\n| [G‑04] | Using `calldata` instead of `memory` for read-only arguments in `external` functions saves gas                                                             |     2     |\n| [G‑05] | Using `storage` instead of `memory` for structs/arrays saves gas                                                                                           |     9     |\n| [G‑06] | Avoid contract existence checks by using solidity version 0.8.10 or later                                                                                  |     3     |\n| [G‑07] | State variables should be cached in stack variables rather than re-reading them from storage                                                               |     3     |\n| [G‑08] | `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables                                                                                     |     1     |\n| [G‑09] | `internal` functions only called once can be inlined to save gas                                                                                           |     3     |\n| [G‑10] | Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if`-statement                                |     2     |\n| [G‑11] | `++i`/`i++` should be `unchecked{++i}`/`unchecked{i++}` when it is not possible for them to overflow, as is the case when used in `for`- and `while`-loops |     4     |\n| [G‑12] | Optimize names to save gas                                                                                                                                 |     4     |\n| [G‑13] | Using `bool`s for storage incurs overhead                                                                                                                  |     1     |\n| [G‑14] | Use a more recent version of solidity                                                                                                                      |     5     |\n| [G‑15] | Using `> 0` costs more gas than `!= 0` when used on a `uint` in a `require()` statement                                                                    |     2     |\n| [G‑16] | `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)                                                                |     4     |\n| [G‑17] | Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead                                                                                   |     3     |\n| [G‑18] | Using `private` rather than `public` for constants, saves gas                                                                                              |     3     |\n| [G‑19] | Division by two should use bit shifting                                                                                                                    |     2     |\n| [G‑20] | Stack variable used as a cheaper cache for a state variable is only used once                                                                              |     1     |\n| [G‑21] | `require()` or `revert()` statements that check input arguments should be at the top of the function                                                       |     2     |\n| [G‑22] | Superfluous event fields                                                                                                                                   |     2     |\n| [G‑23] | Use custom errors rather than `revert()`/`require()` strings to save gas                                                                                   |     42    |\n\nTotal: 114 instances over 23 issues\n\n## [G‑01]  Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, where appropriate\n\nSaves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (**20000 gas**) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save **\\~42 gas per access** due to [not having to recalculate the key's keccak256 hash](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0) (Gkeccak256 - 30 gas) and that calculation's associated stack operations.\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n58        mapping(address => Point[1000000000]) public userPointHistory;\n59:       mapping(address => uint256) public userPointEpoch;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L58-L59>\n\n## [G‑02]  State variables only set in the constructor should be declared `immutable`\n\nAvoids a Gsset (**20000 gas**) in the constructor, and replaces the first access in each transaction (Gcoldsload - **2100 gas**) and each access thereafter (Gwarmacces - **100 gas**) with a `PUSH32` (**3 gas**).\n\n*There are 14 instances of this issue:*\n\n```solidity\nFile: contracts/features/Blocklist.sol\n\n/// @audit manager (constructor)\n15:           manager = _manager;\n\n/// @audit manager (access)\n24:           require(msg.sender == manager, \"Only manager\");\n\n/// @audit ve (constructor)\n16:           ve = _ve;\n\n/// @audit ve (access)\n27:           IVotingEscrow(ve).forceUndelegate(addr);\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L15>\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit token (constructor)\n107:          token = IERC20(_token);\n\n/// @audit token (access)\n426:              token.transferFrom(msg.sender, address(this), _value),\n\n/// @audit token (access)\n486:              token.transferFrom(msg.sender, address(this), _value),\n\n/// @audit token (access)\n546:          require(token.transfer(msg.sender, value), \"Transfer failed\");\n\n/// @audit token (access)\n657:          require(token.transfer(msg.sender, remainingAmount), \"Transfer failed\");\n\n/// @audit token (access)\n676:          require(token.transfer(penaltyRecipient, amount), \"Transfer failed\");\n\n/// @audit name (constructor)\n118:          name = _name;\n\n/// @audit symbol (constructor)\n119:          symbol = _symbol;\n\n/// @audit decimals (constructor)\n115:          decimals = IERC20(_token).decimals();\n\n/// @audit decimals (access)\n116:          require(decimals <= 18, \"Exceeds max decimals\");\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L107>\n\n```diff\ndiff --git a/contracts/VotingEscrow.sol b/contracts/VotingEscrow.sol\nindex f15781a..d2c7666 100644\n--- a/contracts/VotingEscrow.sol\n+++ b/contracts/VotingEscrow.sol\n@@ -42,7 +42,7 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {\n     event Unlock();\n \n     // Shared global state\n-    IERC20 public token;\n+    IERC20 public immutable token;\n     uint256 public constant WEEK = 7 days;\n     uint256 public constant MAXTIME = 365 days;\n     uint256 public constant MULTIPLIER = 10**18;\n@@ -61,9 +61,9 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {\n     mapping(address => LockedBalance) public locked;\n \n     // Voting token\n-    string public name;\n-    string public symbol;\n-    uint256 public decimals = 18;\n+    string public constant name = \"veFDT\";\n+    string public constant symbol = \"veFDT\";\n+    uint256 public immutable decimals;\n \n     // Structs\n     struct Point {\n@@ -112,11 +112,10 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {\n             blk: block.number\n         });\n \n-        decimals = IERC20(_token).decimals();\n-        require(decimals <= 18, \"Exceeds max decimals\");\n+        uint256 _dec = IERC20(_token).decimals();\n+        require(_dec <= 18, \"Exceeds max decimals\");\n+        decimals = _dec;\n \n-        name = _name;\n-        symbol = _symbol;\n         owner = _owner;\n         penaltyRecipient = _penaltyRecipient;\n     }\ndiff --git a/contracts/features/Blocklist.sol b/contracts/features/Blocklist.sol\nindex 27db9b0..ca3a226 100644\n--- a/contracts/features/Blocklist.sol\n+++ b/contracts/features/Blocklist.sol\n@@ -8,8 +8,8 @@ import { IVotingEscrow } from \"../interfaces/IVotingEscrow.sol\";\n /// @dev This is a basic implementation using a mapping for address => bool\n contract Blocklist {\n     mapping(address => bool) private _blocklist;\n-    address public manager;\n-    address public ve;\n+    address public immutable manager;\n+    address public immutable ve;\n \n     constructor(address _manager, address _ve) {\n         manager = _manager;\n```\n\n```diff\ndiff --git a/tmp/gas_before b/tmp/gas_after\nindex 3deb415..cf71599 100644\n--- a/tmp/gas_before\n+++ b/tmp/gas_after\n@@ -167,7 +167,7 @@ No need to generate any newer typings.\n ····················|······················|·············|·············|···············|···············|··············\n |  Contract         ·  Method              ·  Min        ·  Max        ·  Avg          ·  # calls      ·  eur (avg)  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  Blocklist        ·  block               ·      45000  ·     409628  ·       198815  ·            5  ·          -  │\n+|  Blocklist        ·  block               ·      40797  ·     405425  ·       194612  ·            5  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  MockERC20        ·  approve             ·      46176  ·      46200  ·        46196  ·           96  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n@@ -177,46 +177,46 @@ No need to generate any newer typings.\n ····················|······················|·············|·············|···············|···············|··············\n |  MockERC20        ·  transfer            ·      51588  ·      51612  ·        51606  ·           83  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  MockSmartWallet  ·  createLock          ·     334002  ·     378450  ·       355494  ·            7  ·          -  │\n+|  MockSmartWallet  ·  createLock          ·     331896  ·     376344  ·       353388  ·            7  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  MockSmartWallet  ·  delegate            ·          -  ·          -  ·       340388  ·            2  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  MockSmartWallet  ·  increaseUnlockTime  ·          -  ·          -  ·       208859  ·            1  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  MockSmartWallet  ·  quitLock            ·     131158  ·     256210  ·       201886  ·            4  ·          -  │\n+|  MockSmartWallet  ·  quitLock            ·     129058  ·     254110  ·       199786  ·            4  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  MockSmartWallet  ·  withdraw            ·          -  ·          -  ·       666280  ·            1  ·          -  │\n+|  MockSmartWallet  ·  withdraw            ·          -  ·          -  ·       664174  ·            1  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  VotingEscrow     ·  checkpoint          ·      82307  ·    3715511  ·      1272491  ·           10  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  collectPenalty      ·          -  ·          -  ·        49948  ·            1  ·          -  │\n+|  VotingEscrow     ·  collectPenalty      ·          -  ·          -  ·        47863  ·            1  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  createLock          ·     293060  ·    3978208  ·       414348  ·           60  ·          -  │\n+|  VotingEscrow     ·  createLock          ·     290954  ·    3976102  ·       412242  ·           60  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  VotingEscrow     ·  delegate            ·     246709  ·    4048411  ·       650225  ·           33  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  increaseAmount      ·     234777  ·    1077801  ·       448554  ·            4  ·          -  │\n+|  VotingEscrow     ·  increaseAmount      ·     232671  ·    1075695  ·       446448  ·            4  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  VotingEscrow     ·  increaseUnlockTime  ·      46794  ·     416024  ·       143186  ·           23  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  quitLock            ·     127639  ·    1605731  ·       375486  ·           13  ·          -  │\n+|  VotingEscrow     ·  quitLock            ·     125539  ·    1603631  ·       373386  ·           13  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  VotingEscrow     ·  unlock              ·          -  ·          -  ·        14596  ·            3  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  VotingEscrow     ·  updateBlocklist     ·          -  ·          -  ·        47186  ·           14  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  withdraw            ·     106462  ·    3752666  ·       610141  ·           33  ·          -  │\n+|  VotingEscrow     ·  withdraw            ·     104356  ·    3750560  ·       608035  ·           33  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  Deployments                             ·                                           ·  % of limit   ·             │\n ···········································|·············|·············|···············|···············|··············\n-|  Blocklist                               ·     278212  ·     278236  ·       278231  ·        2.2 %  ·          -  │\n+|  Blocklist                               ·     248613  ·     248637  ·       248632  ·          2 %  ·          -  │\n ···········································|·············|·············|···············|···············|··············\n |  MockERC20                               ·          -  ·          -  ·      1278169  ·       10.3 %  ·          -  │\n ···········································|·············|·············|···············|···············|··············\n |  MockSmartWallet                         ·          -  ·          -  ·       416156  ·        3.3 %  ·          -  │\n ···········································|·············|·············|···············|···············|··············\n-|  VotingEscrow                            ·    4374338  ·    4374350  ·      4374350  ·       35.1 %  ·          -  │\n+|  VotingEscrow                            ·    4280168  ·    4280180  ·      4280180  ·       34.4 %  ·          -  │\n ·------------------------------------------|-------------|-------------|---------------|---------------|-------------·\n \n-  117 passing (48s)\n+  117 passing (46s)\n\n```\n\n## [G‑03]  Structs can be packed into fewer storage slots\n\nEach slot saved can avoid an extra Gsset (**20000 gas**) for the first setting of the struct. Subsequent reads as well as writes have smaller gas savings\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit Variable ordering with 3 slots instead of the current 4:\n///           uint256(32):end, address(20):delegatee, int128(16):amount, int128(16):delegated\n75        struct LockedBalance {\n76            int128 amount;\n77            uint256 end;\n78            int128 delegated;\n79            address delegatee;\n80:       }\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L75-L80>\n\n```diff\ndiff --git a/contracts/VotingEscrow.sol b/contracts/VotingEscrow.sol\nindex f15781a..0318bc3 100644\n--- a/contracts/VotingEscrow.sol\n+++ b/contracts/VotingEscrow.sol\n@@ -73,10 +73,10 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {\n         uint256 blk;\n     }\n     struct LockedBalance {\n-        int128 amount;\n         uint256 end;\n-        int128 delegated;\n         address delegatee;\n+        int128 amount;\n+        int128 delegated;\n     }\n \n     // Miscellaneous\n@@ -420,7 +420,7 @@ contract VotingEscrow is IVotingEscrow, ReentrancyGuard {\n         locked_.delegated += int128(int256(_value));\n         locked_.delegatee = msg.sender;\n         locked[msg.sender] = locked_;\n-        _checkpoint(msg.sender, LockedBalance(0, 0, 0, address(0)), locked_);\n+        _checkpoint(msg.sender, LockedBalance({amount:0, end:0, delegated:0, delegatee:address(0)}), locked_);\n         // Deposit locked tokens\n         require(\n             token.transferFrom(msg.sender, address(this), _value),\ndiff --git a/test/votingEscrowDelegationMathTest.ts b/test/votingEscrowDelegationMathTest.ts\nindex 5e43096..088fb9c 100644\n--- a/test/votingEscrowDelegationMathTest.ts\n+++ b/test/votingEscrowDelegationMathTest.ts\n@@ -138,10 +138,10 @@ describe(\"VotingEscrow Delegation Math test\", () => {\n   };\n \n   interface LockedBalance {\n-    amount: BN;\n     end: BN;\n-    delegated: BN;\n     delegatee: string;\n+    amount: BN;\n+    delegated: BN;\n   }\n \n   interface Point {\n@@ -173,10 +173,10 @@ describe(\"VotingEscrow Delegation Math test\", () => {\n       epoch,\n       userEpoch,\n       userLocked: {\n-        amount: locked[0],\n-        end: locked[1],\n-        delegated: locked[2],\n-        delegatee: locked[3],\n+        end: locked[0],\n+        delegatee: locked[1],\n+        amount: locked[2],\n+        delegated: locked[3],\n       },\n       userLastPoint: {\n         bias: userLastPoint[0],\ndiff --git a/test/votingEscrowGasTest.ts b/test/votingEscrowGasTest.ts\nindex d6d03fd..af94f35 100644\n--- a/test/votingEscrowGasTest.ts\n+++ b/test/votingEscrowGasTest.ts\n@@ -174,10 +174,10 @@ describe(\"Gas usage tests\", () => {\n       epoch,\n       userEpoch,\n       userLocked: {\n-        amount: locked[0],\n-        end: locked[1],\n-        delegated: locked[2],\n-        delegatee: locked[3],\n+        end: locked[0],\n+        delegatee: locked[1],\n+        amount: locked[2],\n+        delegated: locked[3],\n       },\n       userLastPoint: {\n         bias: userLastPoint[0],\ndiff --git a/test/votingEscrowMathTest.ts b/test/votingEscrowMathTest.ts\nindex 9d0b9b6..e084b30 100644\n--- a/test/votingEscrowMathTest.ts\n+++ b/test/votingEscrowMathTest.ts\n@@ -207,8 +207,10 @@ describe(\"VotingEscrow Math test\", () => {\n   });\n \n   interface LockedBalance {\n-    amount: BN;\n     end: BN;\n+    delegatee: string;\n+    amount: BN;\n+    delegated: BN;\n   }\n \n   interface Point {\n@@ -252,8 +254,10 @@ describe(\"VotingEscrow Math test\", () => {\n       //totalStaticWeight: await votingLockup.totalStaticWeight(),\n       // userStaticWeight: await votingLockup.staticBalanceOf(sender.address),\n       userLocked: {\n-        amount: locked[0],\n-        end: locked[1],\n+        end: locked[0],\n+        delegatee: locked[1],\n+        amount: locked[2],\n+        delegated: locked[3],\n       },\n       userLastPoint: {\n         bias: userLastPoint[0],\n```\n\n```diff\ndiff --git a/tmp/gas_before b/tmp/gas_after\nindex 3deb415..09dd64b 100644\n--- a/tmp/gas_before\n+++ b/tmp/gas_after\n@@ -167,7 +167,7 @@ No need to generate any newer typings.\n ····················|······················|·············|·············|···············|···············|··············\n |  Contract         ·  Method              ·  Min        ·  Max        ·  Avg          ·  # calls      ·  eur (avg)  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  Blocklist        ·  block               ·      45000  ·     409628  ·       198815  ·            5  ·          -  │\n+|  Blocklist        ·  block               ·      42887  ·     387472  ·       188685  ·            5  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  MockERC20        ·  approve             ·      46176  ·      46200  ·        46196  ·           96  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n@@ -177,35 +177,35 @@ No need to generate any newer typings.\n ····················|······················|·············|·············|···············|···············|··············\n |  MockERC20        ·  transfer            ·      51588  ·      51612  ·        51606  ·           83  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  MockSmartWallet  ·  createLock          ·     334002  ·     378450  ·       355494  ·            7  ·          -  │\n+|  MockSmartWallet  ·  createLock          ·     311601  ·     356043  ·       333090  ·            7  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  MockSmartWallet  ·  delegate            ·          -  ·          -  ·       340388  ·            2  ·          -  │\n+|  MockSmartWallet  ·  delegate            ·          -  ·          -  ·       350371  ·            2  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  MockSmartWallet  ·  increaseUnlockTime  ·          -  ·          -  ·       208859  ·            1  ·          -  │\n+|  MockSmartWallet  ·  increaseUnlockTime  ·          -  ·          -  ·       206298  ·            1  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  MockSmartWallet  ·  quitLock            ·     131158  ·     256210  ·       201886  ·            4  ·          -  │\n+|  MockSmartWallet  ·  quitLock            ·     140849  ·     265907  ·       211580  ·            4  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  MockSmartWallet  ·  withdraw            ·          -  ·          -  ·       666280  ·            1  ·          -  │\n+|  MockSmartWallet  ·  withdraw            ·          -  ·          -  ·       676067  ·            1  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  checkpoint          ·      82307  ·    3715511  ·      1272491  ·           10  ·          -  │\n+|  VotingEscrow     ·  checkpoint          ·      82319  ·    3715835  ·      1272603  ·           10  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  VotingEscrow     ·  collectPenalty      ·          -  ·          -  ·        49948  ·            1  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  createLock          ·     293060  ·    3978208  ·       414348  ·           60  ·          -  │\n+|  VotingEscrow     ·  createLock          ·     270653  ·    3956119  ·       391951  ·           60  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  delegate            ·     246709  ·    4048411  ·       650225  ·           33  ·          -  │\n+|  VotingEscrow     ·  delegate            ·     224688  ·    4026678  ·       646994  ·           33  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  increaseAmount      ·     234777  ·    1077801  ·       448554  ·            4  ·          -  │\n+|  VotingEscrow     ·  increaseAmount      ·     229422  ·    1072518  ·       443303  ·            4  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  increaseUnlockTime  ·      46794  ·     416024  ·       143186  ·           23  ·          -  │\n+|  VotingEscrow     ·  increaseUnlockTime  ·      44338  ·     413481  ·       140686  ·           23  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  quitLock            ·     127639  ·    1605731  ·       375486  ·           13  ·          -  │\n+|  VotingEscrow     ·  quitLock            ·     137330  ·    1615548  ·       385196  ·           13  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  VotingEscrow     ·  unlock              ·          -  ·          -  ·        14596  ·            3  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  VotingEscrow     ·  updateBlocklist     ·          -  ·          -  ·        47186  ·           14  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n-|  VotingEscrow     ·  withdraw            ·     106462  ·    3752666  ·       610141  ·           33  ·          -  │\n+|  VotingEscrow     ·  withdraw            ·     116189  ·    3762705  ·       619911  ·           33  ·          -  │\n ····················|······················|·············|·············|···············|···············|··············\n |  Deployments                             ·                                           ·  % of limit   ·             │\n ···········································|·············|·············|···············|···············|··············\n@@ -215,8 +215,8 @@ No need to generate any newer typings.\n ···········································|·············|·············|···············|···············|··············\n |  MockSmartWallet                         ·          -  ·          -  ·       416156  ·        3.3 %  ·          -  │\n ···········································|·············|·············|···············|···············|··············\n-|  VotingEscrow                            ·    4374338  ·    4374350  ·      4374350  ·       35.1 %  ·          -  │\n+|  VotingEscrow                            ·    4245313  ·    4245325  ·      4245325  ·       34.1 %  ·          -  │\n ·------------------------------------------|-------------|-------------|---------------|---------------|-------------·\n \n-  117 passing (48s)\n+  117 passing (44s)\n \n```\n\n## [G‑04]  Using `calldata` instead of `memory` for read-only arguments in `external` functions saves gas\n\nWhen a function with a `memory` array is called externally, the `abi.decode()` step has to use a for-loop to copy each index of the `calldata` to the `memory` index. **Each iteration of this for-loop costs at least 60 gas** (i.e. `60 * <mem_array>.length`). Using `calldata` directly, obliviates the need for such a loop in the contract code and runtime execution. Note that even if an interface defines a function as having `memory` arguments, it's still valid for implementation contracs to use `calldata` arguments instead.\n\nIf the array is passed to an `internal` function which passes the array to another internal function where the array is modified and therefore `memory` is used in the `external` call, it's still more gass-efficient to use `calldata` when the `external` function uses modifiers, since the modifiers may prevent the internal functions from being called. Structs have the same overhead as an array of length one\n\nNote that I've also flagged instances where the function is `public` but can be marked as `external` since it's not called by the contract, and cases where a constructor is involved\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit _name\n/// @audit _symbol\n100       constructor(\n101           address _owner,\n102           address _penaltyRecipient,\n103           address _token,\n104           string memory _name,\n105:          string memory _symbol\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L100-L105>\n\n## [G‑05]  Using `storage` instead of `memory` for structs/arrays saves gas\n\nWhen fetching data from a storage location, assigning the data to a `memory` variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (**2100 gas**) for *each* field of the struct/array. If the fields are read from the new memory variable, they incur an additional `MLOAD` rather than a cheap stack read. Instead of declearing the variable with the `memory` keyword, declaring the variable with the `storage` keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incuring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a `memory` variable, is if the full struct/array is being returned by the function, is being passed to a function that requires `memory`, or if the array/struct is being read from another `memory` array/struct\n\n*There are 9 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n410:          LockedBalance memory locked_ = locked[msg.sender];\n\n446:          LockedBalance memory locked_ = locked[msg.sender];\n\n499:          LockedBalance memory locked_ = locked[msg.sender];\n\n527:          LockedBalance memory locked_ = locked[msg.sender];\n\n561:          LockedBalance memory locked_ = locked[msg.sender];\n\n633:          LockedBalance memory locked_ = locked[msg.sender];\n\n788:          Point memory point0 = pointHistory[epoch];\n\n866:          Point memory lastPoint = pointHistory[epoch_];\n\n882:          Point memory point = pointHistory[targetEpoch];\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L410>\n\n## [G‑06]  Avoid contract existence checks by using solidity version 0.8.10 or later\n\nPrior to 0.8.10 the compiler inserted extra code, including `EXTCODESIZE` (**100 gas**), to check for contract existence for external calls. In more recent solidity versions, the compiler will not insert these checks if the external call has a return value\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit decimals()\n115:          decimals = IERC20(_token).decimals();\n\n/// @audit isBlocked()\n126:              !IBlocklist(blocklist).isBlocked(msg.sender),\n\n/// @audit isBlocked()\n563:          require(!IBlocklist(blocklist).isBlocked(_addr), \"Blocked contract\");\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L115>\n\n## [G‑07]  State variables should be cached in stack variables rather than re-reading them from storage\n\nThe instances below point to the second+ access of a state variable within a function. Caching of a state variable replace each Gwarmaccess (**100 gas**) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit penaltyRecipient on line 676\n677:          emit CollectPenalty(amount, penaltyRecipient);\n\n/// @audit pointHistory on line 788\n796:              Point memory point1 = pointHistory[epoch + 1];\n\n/// @audit pointHistory on line 882\n891:              Point memory pointNext = pointHistory[targetEpoch + 1];\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L677>\n\n## [G‑08]  `<x> += <y>` costs more gas than `<x> = <x> + <y>` for state variables\n\nUsing the addition operator instead of plus-equals saves **[113 gas](https://gist.github.com/IllIllI000/cbbfb267425b898e5be734d4008d4fe8)**\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n654:          penaltyAccumulated += penaltyAmount;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L654>\n\n## [G‑09]  `internal` functions only called once can be inlined to save gas\n\nNot inlining costs **20 to 40 gas** because of two extra `JUMP` instructions and additional stack operations needed for function calls.\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: contracts/features/Blocklist.sol\n\n37:       function _isContract(address addr) internal view returns (bool) {\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L37>\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n662       function _calculatePenaltyRate(uint256 end)\n663           internal\n664           view\n665:          returns (uint256)\n\n732       function _findUserBlockEpoch(address _addr, uint256 _block)\n733           internal\n734           view\n735:          returns (uint256)\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L662-L665>\n\n## [G‑10]  Add `unchecked {}` for subtractions where the operands cannot underflow because of a previous `require()` or `if`-statement\n\n`require(a <= b); x = b - a` => `require(a <= b); unchecked { x = b - a }`\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit if-condition on line 299\n301:                  (MULTIPLIER * (block.number - lastPoint.blk)) /\n\n/// @audit if-condition on line 299\n302:                  (block.timestamp - lastPoint.ts);\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L301>\n\n## [G‑11]  `++i`/`i++` should be `unchecked{++i}`/`unchecked{i++}` when it is not possible for them to overflow, as is the case when used in `for`- and `while`-loops\n\nThe `unchecked` keyword is new in solidity version 0.8.0, so this only applies to that version or higher, which these instances are. This saves **30-40 gas [per loop](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#the-increment-in-for-loop-post-condition-can-be-made-unchecked)**\n\n*There are 4 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n309:          for (uint256 i = 0; i < 255; i++) {\n\n717:          for (uint256 i = 0; i < 128; i++) {\n\n739:          for (uint256 i = 0; i < 128; i++) {\n\n834:          for (uint256 i = 0; i < 255; i++) {\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L309>\n\n## [G‑12]  Optimize names to save gas\n\n`public`/`external` function names and `public` member variable names can be optimized to save gas. See [this](https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9) link for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save **128 gas** each during deployment, and renaming functions to have lower method IDs will save **22 gas** per call, [per sorted position shifted](https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92)\n\n*There are 4 instances of this issue:*\n\n```solidity\nFile: contracts/features/Blocklist.sol\n\n/// @audit block(), isBlocked()\n9:    contract Blocklist {\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L9>\n\n```solidity\nFile: contracts/interfaces/IBlocklist.sol\n\n/// @audit isBlocked()\n6:    interface IBlocklist {\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IBlocklist.sol#L6>\n\n```solidity\nFile: contracts/interfaces/IVotingEscrow.sol\n\n/// @audit createLock(), increaseAmount(), increaseUnlockTime(), withdraw(), quitLock(), balanceOfAt(), totalSupplyAt(), forceUndelegate()\n4:    interface IVotingEscrow {\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IVotingEscrow.sol#L4>\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit updateBlocklist(), updatePenaltyRecipient(), unlock(), lockEnd(), getLastUserPoint(), checkpoint(), collectPenalty()\n23:   contract VotingEscrow is IVotingEscrow, ReentrancyGuard {\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L23>\n\n## [G‑13]  Using `bool`s for storage incurs overhead\n\n```solidity\n    // Booleans are more expensive than uint256 or any type that takes up a full\n    // word because each write operation emits an extra SLOAD to first read the\n    // slot's contents, replace the bits taken up by the boolean, and then write\n    // back. This is the compiler's defense against contract upgrades and\n    // pointer aliasing, and it cannot be disabled.\n```\n\n<https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27>\nUse `uint256(1)` and `uint256(2)` for true/false to avoid a Gwarmaccess (**[100 gas](https://gist.github.com/IllIllI000/1b70014db712f8572a72378321250058)**) for the extra SLOAD, and to avoid Gsset (**20000 gas**) when changing from `false` to `true`, after having been `true` in the past\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts/features/Blocklist.sol\n\n10:       mapping(address => bool) private _blocklist;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L10>\n\n## [G‑14]  Use a more recent version of solidity\n\nUse a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than `revert()/require()` strings\nUse a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value\n\n*There are 5 instances of this issue:*\n\n```solidity\nFile: contracts/features/Blocklist.sol\n\n2:    pragma solidity ^0.8.3;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L2>\n\n```solidity\nFile: contracts/interfaces/IBlocklist.sol\n\n2:    pragma solidity ^0.8.3;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IBlocklist.sol#L2>\n\n```solidity\nFile: contracts/interfaces/IERC20.sol\n\n2:    pragma solidity ^0.8.3;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IERC20.sol#L2>\n\n```solidity\nFile: contracts/interfaces/IVotingEscrow.sol\n\n2:    pragma solidity ^0.8.3;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/interfaces/IVotingEscrow.sol#L2>\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n2:    pragma solidity ^0.8.3;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L2>\n\n## [G‑15]  Using `> 0` costs more gas than `!= 0` when used on a `uint` in a `require()` statement\n\nThis change saves **[6 gas](https://aws1.discourse-cdn.com/business6/uploads/zeppelin/original/2X/3/363a367d6d68851f27d2679d10706cd16d788b96.png)** per instance. The optimization works until solidity version [0.8.13](https://gist.github.com/IllIllI000/bf2c3120f24a69e489f12b3213c06c94) where there is a regression in gas costs.\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n412:          require(_value > 0, \"Only non zero amount\");\n\n448:          require(_value > 0, \"Only non zero amount\");\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L412>\n\n## [G‑16]  `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)\n\nSaves **5 gas per loop**\n\n*There are 4 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n309:          for (uint256 i = 0; i < 255; i++) {\n\n717:          for (uint256 i = 0; i < 128; i++) {\n\n739:          for (uint256 i = 0; i < 128; i++) {\n\n834:          for (uint256 i = 0; i < 255; i++) {\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L309>\n\n## [G‑17]  Usage of `uints`/`ints` smaller than 32 bytes (256 bits) incurs overhead\n\n> When using elements that are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.\n\n<https://docs.soliditylang.org/en/v0.8.11/internals/layout_in_storage.html>\nEach operation involving a `uint8` costs an extra [**22-28 gas**](https://gist.github.com/IllIllI000/9388d20c70f9a4632eb3ca7836f54977) (depending on whether the other operand is also a variable of type `uint8`) as compared to ones involving `uint256`, due to the compiler having to clear the higher bits of the memory word before operating on the `uint8`, as well as the associated stack operations of doing so. Use a larger size then downcast where needed\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit int128 oldSlopeDelta\n380:                  oldSlopeDelta = oldSlopeDelta + userOldPoint.slope;\n\n/// @audit int128 oldSlopeDelta\n382:                      oldSlopeDelta = oldSlopeDelta - userNewPoint.slope; // It was a new deposit, not extension\n\n/// @audit int128 newSlopeDelta\n388:                      newSlopeDelta = newSlopeDelta - userNewPoint.slope; // old slope disappeared at this point\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L380>\n\n## [G‑18]  Using `private` rather than `public` for constants, saves gas\n\nIf needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that returns a tuple of the values of all currently-public constants. Saves **3406-3606 gas** in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it's used, and not adding another entry to the method ID table\n\n*There are 3 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n46:       uint256 public constant WEEK = 7 days;\n\n47:       uint256 public constant MAXTIME = 365 days;\n\n48:       uint256 public constant MULTIPLIER = 10**18;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L46>\n\n## [G‑19]  Division by two should use bit shifting\n\n`<x> / 2` is the same as `<x> >> 1`. While the compiler uses the `SHR` opcode to accomplish both, the version that uses division incurs an overhead of [**20 gas**](https://gist.github.com/IllIllI000/ec0e4e6c4f52a6bca158f137a3afd4ff) due to `JUMP`s to and from a compiler utility function that introduces checks which can be avoided by using `unchecked {}` around the division by two\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n719:              uint256 mid = (min + max + 1) / 2;\n\n743:              uint256 mid = (min + max + 1) / 2;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L719>\n\n## [G‑20]  Stack variable used as a cheaper cache for a state variable is only used once\n\nIf the variable is only accessed once, it's cheaper to use the state variable directly that one time, and save the **3 gas** the extra stack assignment would spend\n\n*There is 1 instance of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n865:          uint256 epoch_ = globalEpoch;\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L865>\n\n## [G‑21]  `require()` or `revert()` statements that check input arguments should be at the top of the function\n\nChecks that involve constants should come before checks that involve state variables, function calls, and calculations. By doing these checks first, the function is able to revert before wasting a Gcoldsload (**2100 gas**&ast;) in a function that may ultimately revert in the unhappy case.\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n/// @audit expensive op on line 410\n412:          require(_value > 0, \"Only non zero amount\");\n\n/// @audit expensive op on line 446\n448:          require(_value > 0, \"Only non zero amount\");\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L412>\n\n## [G‑22]  Superfluous event fields\n\n`block.timestamp` and `block.number` are added to event information by default so adding them manually wastes gas\n\n*There are 2 instances of this issue:*\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n30:           uint256 ts\n\n36:           uint256 ts\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L30>\n\n## [G‑23]  Use custom errors rather than `revert()`/`require()` strings to save gas\n\nCustom errors are available from solidity version 0.8.4. Custom errors save [**\\~50 gas**](https://gist.github.com/IllIllI000/ad1bd0d29a0101b25e57c293b4b0c746) each time they're hit by [avoiding having to allocate and store the revert string](https://blog.soliditylang.org/2021/04/21/custom-errors/#errors-in-depth). Not defining the strings also save deployment gas\n\n*There are 42 instances of this issue:*\n\n```solidity\nFile: contracts/features/Blocklist.sol\n\n24:           require(msg.sender == manager, \"Only manager\");\n\n25:           require(_isContract(addr), \"Only contracts\");\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/features/Blocklist.sol#L24>\n\n```solidity\nFile: contracts/VotingEscrow.sol\n\n116:          require(decimals <= 18, \"Exceeds max decimals\");\n\n125           require(\n126               !IBlocklist(blocklist).isBlocked(msg.sender),\n127               \"Blocked contract\"\n128:          );\n\n140:          require(msg.sender == owner, \"Only owner\");\n\n147:          require(msg.sender == owner, \"Only owner\");\n\n154:          require(msg.sender == owner, \"Only owner\");\n\n162:          require(msg.sender == owner, \"Only owner\");\n\n171:          require(msg.sender == blocklist, \"Only Blocklist\");\n\n412:          require(_value > 0, \"Only non zero amount\");\n\n413:          require(locked_.amount == 0, \"Lock exists\");\n\n414:          require(unlock_time >= locked_.end, \"Only increase lock end\"); // from using quitLock, user should increaseAmount instead\n\n415:          require(unlock_time > block.timestamp, \"Only future lock end\");\n\n416:          require(unlock_time <= block.timestamp + MAXTIME, \"Exceeds maxtime\");\n\n425           require(\n426               token.transferFrom(msg.sender, address(this), _value),\n427               \"Transfer failed\"\n428:          );\n\n448:          require(_value > 0, \"Only non zero amount\");\n\n449:          require(locked_.amount > 0, \"No lock\");\n\n450:          require(locked_.end > block.timestamp, \"Lock expired\");\n\n469:              require(locked_.amount > 0, \"Delegatee has no lock\");\n\n470:              require(locked_.end > block.timestamp, \"Delegatee lock expired\");\n\n485           require(\n486               token.transferFrom(msg.sender, address(this), _value),\n487               \"Transfer failed\"\n488:          );\n\n502:          require(locked_.amount > 0, \"No lock\");\n\n503:          require(unlock_time > locked_.end, \"Only increase lock end\");\n\n504:          require(unlock_time <= block.timestamp + MAXTIME, \"Exceeds maxtime\");\n\n511:              require(oldUnlockTime > block.timestamp, \"Lock expired\");\n\n529:          require(locked_.amount > 0, \"No lock\");\n\n530:          require(locked_.end <= block.timestamp, \"Lock not expired\");\n\n531:          require(locked_.delegatee == msg.sender, \"Lock delegated\");\n\n546:          require(token.transfer(msg.sender, value), \"Transfer failed\");\n\n563:          require(!IBlocklist(blocklist).isBlocked(_addr), \"Blocked contract\");\n\n564:          require(locked_.amount > 0, \"No lock\");\n\n565:          require(locked_.delegatee != _addr, \"Already delegated\");\n\n587:          require(toLocked.amount > 0, \"Delegatee has no lock\");\n\n588:          require(toLocked.end > block.timestamp, \"Delegatee lock expired\");\n\n589:          require(toLocked.end >= fromLocked.end, \"Only delegate to longer lock\");\n\n635:          require(locked_.amount > 0, \"No lock\");\n\n636:          require(locked_.end > block.timestamp, \"Lock expired\");\n\n637:          require(locked_.delegatee == msg.sender, \"Lock delegated\");\n\n657:          require(token.transfer(msg.sender, remainingAmount), \"Transfer failed\");\n\n676:          require(token.transfer(penaltyRecipient, amount), \"Transfer failed\");\n\n776:          require(_blockNumber <= block.number, \"Only past block number\");\n\n877:          require(_blockNumber <= block.number, \"Only past block number\");\n\n```\n\n<https://github.com/code-423n4/2022-08-fiatdao/blob/fece3bdb79ccacb501099c24b60312cd0b2e4bb2/contracts/VotingEscrow.sol#L116>\n\n**[lacoop6tu (FIAT DAO) commented](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/223#issuecomment-1228644893):**\n > Good one\n\n\n\n***\n\n# Mitigation Review\n\n*Mitigation review by IllIllI*\n\n**Contest repository commit:** https://github.com/code-423n4/2022-08-fiatdao/tree/fece3bdb79ccacb501099c24b60312cd0b2e4bb2<br>\n**Project repository commit:** https://github.com/fiatdao/veFDT/tree/8e88edb452b73bbe3461a8f4a5ed502db140322a<br>\n**Final commit:** https://github.com/fiatdao/veFDT/tree/3f822125e05e2927eab0a3a3e797508b363083ab<br>\n\n## Mitigation PRs reviewed:\n- [Issue 2: _checkpoint function won't be called for a user which is both a delegator and a delegatee in increaseUnlockTime](https://github.com/fiatdao/veFDT/pull/13/files/f84fc5d43e2ad29fea031fe020913acc52507671)\n- [Issue 3: Unnecessary if statement in _checkpoint](https://github.com/fiatdao/veFDT/pull/10/files/6b31b2535ba68c47dd4cafed7ce0d3e5fa07f64e)\n- [Issue 4: Lock owner can delegate after lock expiration](https://github.com/fiatdao/veFDT/pull/14/files/b9afd265fac9b3b3a3dc1440d47f421a41ff9639)\n- [Issue 5: increaseUnlockTime uses wrong unlock time for old lock.](https://github.com/fiatdao/veFDT/pull/9/files/c96d67be01305e95711b7eac33fde484f562bb7a)\n- [Issue 6: Delegators can Avoid Lock Commitments if they can Reliably get Themselves Blocked when Needed](https://github.com/fiatdao/veFDT/pull/11/files/01aa495c4127d44025e442421a2d58256ee36f06)\n- [Issues 7 & 8: QA and gas optimization](https://github.com/fiatdao/veFDT/pull/15/files/0909da169892a76de0b481ecc2c0e6087deebe02)\n- [Issue 18: Use safe transfer methods](https://github.com/fiatdao/veFDT/pull/19/files/9d532c58e30e9730050fe26dd82bb4c293691001)\n\n## Intro\nveFDT is a solidity implementation of Curve's voting-escrow, enhanced to give users the ability to delegate their locked tokens, to quit their locks early for a penalty, and to have their smart wallets optimistically approved.\n\n### Disclaimer\n\nThis mitigation review does not guarantee the absence of any further vulnerabilities, being, however, the result of exercising the reviewer's best efforts. At the time of the review, the final judging report was not yet available, so in addition to covering the resolved issues, the review also included an investigation of the disputed and acknowledged issues, as well as the issues downgraded to QA.\n\n## Contest issues overview\nThe following is a high-level overview of the issues identified during FiatDAO's August 2022 Code4rena audit contest, and any potential changes/feedback provided by the project sponsors in both the contest issue comments as well as the PRs listed above.\n\n### High and Medium Risk Issues\n\n- **[[H-01]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/231) - Unsafe usage of ERC20 transfer and transferFrom** (sponsor disputed)\n  \n  The sponsor disputed the issue because the token it's planned to be used with does correctly return a boolean. However, the sponsor decided to make a change to address the finding as [Issue 18](https://github.com/fiatdao/veFDT/pull/19/files/9d532c58e30e9730050fe26dd82bb4c293691001). The fix properly replaces the `require()` statements that check for successful transfers, with calls to OpenZeppelin's `safeTransfer()`. The PR also replaces the internal definition of the `IERC20` interface with OpenZeppelin's version. The prior version of the code's `IERC20` included the function `decimals()`, which is not one of the required functions for the interface, so it's possible for the code to encounter a token without this function, but it would be immediately apparent what happened because the constructor is the function that calls `decimals()`. The change to using OpenZeppelin required making this distinction more visible due to the fact that they're defined separately as `IERC20` and `IERC20Metadata`. The new code is not checking that the token actually supports the function (e.g. using a `safeDecimals()`-like function), but it is not any worse off that it had been prior to the change.\n  \n- **[[H-02]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/204) - Delegators can Avoid Lock Commitments if they can Reliably get Themselves Blocked when Needed** (sponsor confirmed, severity disagreement)\n  \n  The sponsor disagreed with the severity and the judge updated the issue to be of Medium risk, and I agree with that severity. The finding was addressed via the fix for [Issue 6](https://github.com/fiatdao/veFDT/pull/11/files/01aa495c4127d44025e442421a2d58256ee36f06) where the sponsor implemented the suggestion of the warden, to use the delegatee's lock endpoint in the re-delegation to self, rather than using the delegator's existing endpoint, since that endpoint may be far in the past. The delegate() and undelegate() functions have checks to ensure that the target for the votes always has at least as long a duration as the source of the votes. The fix enforces the same requirement for `forceUndelegate()` by assigning a longer duration.\n  \n  There are only two places in the code that change `LockedBalance.end` to a smaller value, which could possibly violate the contract invariants: in [`quitLock()`](https://github.com/fiatdao/veFDT/blob/01aa495c4127d44025e442421a2d58256ee36f06/contracts/VotingEscrow.sol#L646-L651) where the struct is never written back to storage, and in [`withdraw()`](https://github.com/fiatdao/veFDT/blob/01aa495c4127d44025e442421a2d58256ee36f06/contracts/VotingEscrow.sol#L537-L541) where it is indeed written back to storage. However, if the delegatee was able to withdraw, that means the delegator already would have been able to withdraw (since the delegatee's timestamp must always be greater than or equal to the delegator's when [delegating](https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md#delegate) or [increasing](https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md#increaseamount)), and therefore the mitigation is correct. The only extra wrinkle that the change makes, is that it now allows a malicious delegatee to front-run a delegator's block with an `increaseUnlock(MAXTIME)`, but it's not clear what advantage that would give the delegatee, and furthermore, the delegator already put his/her trust in the delegatee, so it's something that could have occurred anyway, even without a call to `forceUndelegate()`.\n  \n- **[[M-01]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/229) - The current implementation of the VotingEscrow contract doesn't support fee on transfer tokens** (sponsor disputed)\n  \n  The sponsor disputed the issue because the Balancer V2 Pool tokens it's planned to be used with do not implement a fee-on-transfer mechanic. The tokens do not appear to be [upgradeable](https://github.com/balancer-labs/balancer-v2-monorepo/blob/4085a05d5e42684a10a0b7b2caba454bd907ce22/pkg/pool-utils/contracts/BalancerPoolToken.sol#L35) so there is no risk of fees being added to existing tokens via upgrade. Without more information about how which pool tokens are chosen/allowed/used, and what prevents future pool tokens that implement such a mechanic from being used with the same contract, I have to agree with the warden and judge that this is a Medium risk issue. The suggested mitigation is to measure the balance of the token that the contract holds before the `transferFrom()` call is made, and afterwards, and use the difference as the value, rather than the amount the user states. You could also add a `require()` enforcing the invariant that the change in balance must equal the stated amount, which would _prevent_ fee-on-transfer tokens from being used.\n  \n  In the final PR, the sponsor has acknowledged the issue and added a code comment saying that fee-on-transfer tokens are not supported.\n  \n- **[[M-02]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75) - Attacker contract can avoid being blocked by BlockList.sol** (sponsor acknowledged)\n  \n  The sponsor acknowledges that the `BlockList` can be bypassed, but [states](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/75#issuecomment-1232403488) that \"the only interaction possible is locking LP tokens first\". However, looking at the code, the `checkBlocklist` modifier is applied to not just `createLock()`, but `increaseAmount()`, `increaseUnlockTime()`, and `delegate()`. An attacker can bypass the block list for every one of these functions by making their SmartWallet a specially-constructed `create2()` contract that does external calls to an other contract in its constructor, for instructions on what to execute, before self-destructing. Whenever the attacker wants to interact with the token, they update their external instruction-providing contract with the action to take, re-create the attack contract. It's not clear why the block list is only for contracts, and if it can be bypassed by using this method, or by transferring the tokens to an EOA.\n  \n  In discussions of the issue, the sponsor clarified that the `BlockList`'s purpose is to prevent lock tokenization, and acknowledged that using an updated `BlockList` that blocks specific EOAs may be required if an attacker uses the features described above to work around being blocked.\n  \n- **[[M-03]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254) - Inconsistent logic of increase unlock time to the expired locks** (sponsor confirmed)\n  \n  The sponsor addressed the finding with the fix for [Issue 4](https://github.com/fiatdao/veFDT/pull/14/files/b9afd265fac9b3b3a3dc1440d47f421a41ff9639). The fix chosen was to not allow the increasing of lock time or non-self re-delegation if the delegatee's lock has expired. The fix didn't require the undelegate flavor to duplicate the blocklist check  since `msg.sender` is already checked by the `checkBlocklist` modifier. The refactored code properly re-used some variables rather than duplicating the allocations done in the delegation/re-delegation case in order to save some gas. The refactoring introduced a new issue, [M.N-01], described below.\n  \n- **[[M-04]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/217) - ERROR IN UPDATING  `_checkpoint` IN THE `increaseUnlockTime` FUNCTION** (sponsor confirmed)\n  \n  The sponsor addressed the finding with the fix for [Issue 5](https://github.com/fiatdao/veFDT/pull/9/files/c96d67be01305e95711b7eac33fde484f562bb7a). The fix properly changes the code to match the invariants [specification](https://github.com/code-423n4/2022-08-fiatdao/blob/main/CheckpointMath.md), and matches the logical expectation that the 'old' field uses the 'old' timestamp.\n\n- **[[M-05]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/228) - Unsafe casting from int128 can cause wrong accounting of locked amounts** (sponsor acknowledged)\n  \n  The sponsor acknowledges that overflow is technically possible, but considers this as unlikely to happen in practice.\n  \n  In the final PR, the sponsor added a code comment saying that the contract does not support tokens where `maxSupply>2^128-10^[decimals]`.\n\n- **[[M-06]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/318) - `increaseUnlockTime` missing `_checkpoint` for delegated values** (sponsor confirmed)\n  \n   The sponsor addressed the finding with the fix for [Issue 2](https://github.com/fiatdao/veFDT/pull/13/files/f84fc5d43e2ad29fea031fe020913acc52507671). In cases where a user is both a delegator and a delegatee, the original code did not create a checkpoint for calls to `increaseUnlockTime()`. Self-delegation and being delegated to both increase the `LockedBalance.delegated` field, so the change to the condition of the if-statement now includes both cases. The code will not get to the if-statement if the user has already withdrawn, due to a `require()`, so a user that has delegates but has withdrawn, cannot increase their now-zero unlock time. `increaseAmount()` has a similar if-statement and comment, but the else-block is already covered by a checkpoint, so there is no analogous issue there.\n\n- **[[M-07]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/200) - Blocking Through Change of Blocklist Could Trap Tokens** (sponsor acknowledged)\n  \n  The sponsor acknowledges the possible rug vector. It is common for admin rug vectors to not be addressed.\n\n- **[[M-08]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/237) - Attackers can abuse the quitLock function to get a very large amount of votes** (sponsor disputed)\n  \n  The sponsor disputed the issue on the basis of an economic analysis of the penalty taken vs the votes gained, the outcome of which was that the penalty always covers the votes gained. I spoke with the sponsor and the sponsor explained that for the original Curve Finance code, the number of votes one gets is not equal one-for-one to the number of tokens locked: locking for the maximum duration will get you close to one-for-one, but every second under that number, the locking user gets fewer and fewer votes. Therefore in veFTD, the penalty is always chosen such that when the penalty is subtracted from the votes gained, the number of votes a user is left with after quitting is equal to the number of votes they would have been given had they used the quit time as their lock end time instead. In other words, the votes one would get for locking for the week the warden mentions, would be equal to the penalty they gather ahead of time, so the flash loan does not help the attacker.\n  \n  To verify all of this, I wrote two tests that make use of hardhat's ability to mine specific blocks with specific times. The [first](https://gist.github.com/IllIllI000/e7d44c6bf21155c5cc076d3ace69d47f) test confirmed that indeed, when one subtracts the penalty from the number of votes gained, the remaining number of votes is less than the number of votes a separate user gains for locking for the shorter duration, so it's always better to specify the correct lock time rather and unlocking early. The [second](https://gist.github.com/IllIllI000/16c7883c13ec35fd8c050aa25791a163) test verifies that the same is true even if one quits the second after the lock is created. Finally, I wrote a [test](https://gist.github.com/IllIllI000/67e2d48aa8b2cc33859d4ec962638c98) that specifically does the flash loan scenario the warden outlined, and was able to show that when the attacking contract checks its balance between locking and quitting for the previous block, the votes are zero, and for the current block, the penalty is larger than the votes gained (and one cannot query vote balances for future blocks). Once the contract's attack call completes, checks for the votes for same blocks show zero votes for both, so I believe the warden's finding is invalid.\n\n- **[[Issue 227]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/227) - Wrong penalty allocation computation** (invalid)\n  \n  The sponsor walks though an example where a user is able to quit without a penalty, given a specific number of decimals, due to loss of precision. While having a smaller number of decimals can increase the value of each unit to the point where one wei is a worth-while amount, another way for each wei to increase in value is for the majority of the outstanding tokens to be burned. Yet another way to take advantage of the incorrect penalty is to split a large number of tokens into separate smaller chunks. As long as the gas cost to transfer the tokens, lock them, then unlock them is smaller than the economic value gained from the votes, it will be worth while to do the attack.\n  \n  I was able to write a [test](https://gist.github.com/IllIllI000/63e170b9a07a321ceec79938ac804aa5) that shows that by distributing tokens among nyms, an attacker is able to pay zero penalty on tiny amounts of wei because the loss of precision favors the quitter rather than the penalty recipient. In addition to fixing the loss of precision mentioned in Q-67 below, this advantage given to users that split their tokens among multiple addresses can be further mitigated by always ceil-ing fractional amounts:\n  ```diff\n  - uint256 penaltyAmount = (value * penaltyRate) / 10**18; // quitlock_penalty is in 18 decimals precision\n  + uint256 penaltyAmount = (value * penaltyRate + (10**18 - 1)) / 10**18; // quitlock_penalty is in 18 decimals precision\n  ```\n  A simpler alternative is to just add a penalty of one wei to all quits.\n  \n  The sponsor disputes the part of the issue relating to a user being able to avoid paying any penalties on the basis of the fact that it only makes economic sense to do the attack if the value of one wei of the token is larger than the gas cost to create and quit a lock, otherwise the attacker would be better off losing the locked tokens to a penalty instead. The sponsor acknowledges that the rounding is done in the favor of the user having the penalty applied, rather than in the favor of the penalty recipient.\n\n### Low Risk, Non-Critical, and Gas\n\n- **[[Issue 230]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/230) - Divide before multiply in slope calculations** (sponsor acknowledged)\n  \n  The sponsor acknowledges the possible rounding issue, but points out that if there is one, it's in the Curve code base too. Curve, however, uses [four](https://github.com/curvefi/curve-dao-contracts/blob/3bee979b7b6293c9e7654ee7dfbf5cc9ff40ca58/contracts/VotingEscrow.vy#L85) years rather than veFTD's one year, so the math may be slightly different.\n\n- **[[Issue 60]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/60) - Delegation would be successful when delegatee lock expiration is same as delegator's lock expiration.** (sponsor disputed)\n  \n  The sponsor states that the documentation is wrong, not the code. Agreed, but there is no documentation change in the provided PRs.\n  \n  The sponsor provided a followup [PR](https://github.com/fiatdao/veFDT/pull/20/commits/0ff1b23caff9a774cac611f9189f10e1e4511dd9) that properly updates the documentation.\n  \n- **[[Issue 248]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/248) - First `userPointHistory` is never recorded** (duplicate of Issue 294)\n  \n  Duplicate of [Issue 294] below\n\n- **[[Issue 162]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/162) - Miscalculation in `_calculatePenaltyRate` function** (sponsor confirmed)\n  \n  The issue is that the 365-day `MAXTIME` is not divisible cleanly by `WEEK` (52*7 = 364), so due to the flooring that takes place, a user can never get his/her maximum voting power. I confirmed with a test that calling `createLock((WEEK*53)-1)` results in a lock duration of 364 days. This issue has not been addressed by any of the PRs provided by the sponsor.\n  \n  In discussions with the sponsor, the sponsor acknowledges the issue and will let the values remain as-is, since the issue only means that users are more disincentivized to quit early, since they will pay a slightly higher fee than if the two values were cleanly divisible.\n\n- **[[Issue 114]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/114) - penaltyAmount is deflated and remainingAmount is inflated when calling quitLock function of VotingEscrow contract according to current implementation** (sponsor acknowledged)\n  \n  The sponsor acknowledges loss of precision leading to dust amounts not being accounted for properly, due to multiplication after division\n\n- **[[Issue 117]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/117) - VotingEscrow implementation does not match specification** (sponsor disputed)\n  \n  Same as [Issue 60] above\n\n- **[[Issue 152]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/152) - The unlockTime ≥ owner.end in createLock function is inconsistent with design.** (sponsor disputed)\n  \n  Same as [Issue 60] above\n\n- **[[Issue 294]](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/294) - Wrong logic in `_checkpoint()` function might lead to wrong value of `balanceOfAt()`, `totalSupplyAt()`** (sponsor confirmed)\n  \n  The sponsor addressed the finding with the fix for [Issue 3](https://github.com/fiatdao/veFDT/pull/10/files/6b31b2535ba68c47dd4cafed7ce0d3e5fa07f64e). The fix removes the setting of the first epoch, which is safe to do since everywhere that the contract references the `userPointHistory`, index zero is always special-cased to zero. Furthermore, there is no case where a `Point` is written with non-zero values, which would cause the public function `userPointHistory(addr,0)` to return wrong values. I would also note that the code prior to the fix was using `uEpoch + 1` whereas it should have been using `uEpoch` instead.\n\n- **Miscellaneous**\n  \n  The sponsor addressed a subset of the QA and gas findings with the fix for [Issues 7 & 8](https://github.com/fiatdao/veFDT/pull/15/files/0909da169892a76de0b481ecc2c0e6087deebe02). Some of the gas fixes were related to `for`-loops, splitting `+=`, state variable caching, `!=` in `require()`s, converting storage to immutables, removing casts where not necessary, and adding comments explaining the safety of mathematical operations, all of which were done properly. The PR also switched the rest of the code from using internal definitions of the ERC-20 interface, to using the OpenZeppelin versions (the changes started as a part of [Issue 18](https://github.com/fiatdao/veFDT/pull/19/files/9d532c58e30e9730050fe26dd82bb4c293691001)), and renamed the `block()` function.\n\n## Findings\n\nFindings are labeled with the following notation `M.S-N`, representing `Mitigation.Severity-Number`.\n\n### [M.L-01] Code does not follow check-effects-interaction best practice\n  One of the PRs under review for this mitigation, not tied to any issue identified during the contest, was [PR 22](https://github.com/fiatdao/veFDT/pull/22/commits/51f0001fd0576049341cfc8b9146cde9b9378797) where the sponsor introduced a new state variable that tracks the net number of tokens held by the contract, excluding any tokens externally transferred to the contract. While the code does properly track the net number (not including any discrepancies due to fee-on-transfer tokens already excluded by the sponsor), it does so by updating the state after the external calls that handle the transfer of tokens into and out of the contract. The best practice of [check-effects-interaction](https://docs.soliditylang.org/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern) requires that one perform all state updates (effects) _before_ any external calls (interactions), so that the state is not vulnerable to re-entrancy attacks.\n\nWhile no funds are at risk, since the new variable is never used by the contract in any calculations, if Balancer LP tokens ever introduce transfer hooks, it would be possible for an attacker to get the contract to give the wrong answer about its balance, which may affect calculations that other contracts make.\n\n#### Proof of Concept\nEach place that modifies the new `supply` variable, does so after a call that may be re-enterable in the future\n\n`createLock()`:\n```solidity\n451        token.safeTransferFrom(msg.sender, address(this), _value);\n452        // Total supply of token deposited\n453        supply = supply + _value;\n```\nhttps://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L451-L453\n\n`increaseAmount()`:\n```solidity\n517        token.safeTransferFrom(msg.sender, address(this), _value);\n518        // Total supply of token deposited\n519        supply = supply + _value;\n```\nhttps://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L517-L519\n\n`withdraw()`:\n```solidity\n583        token.safeTransfer(msg.sender, value);\n584        // Total supply of token deposited\n585        supply = supply - value;\n```\nhttps://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L583-L585\n\n`quitLock()` (assumes penalty is deducted immediately):\n```solidity\n715        token.safeTransfer(msg.sender, remainingAmount);\n716        // Total supply of token deposited\n717        supply = supply - value;\n```\nhttps://github.com/fiatdao/veFDT/blob/51f0001fd0576049341cfc8b9146cde9b9378797/contracts/VotingEscrow.sol#L715-L717\n\n#### Recommended Mitigation Steps\nMove the update of the `supply` state variable so that it occurs before each external call\n\n#### Remediation\nThe sponsor properly addressed the issue with [this](https://github.com/fiatdao/veFDT/pull/22/commits/0447eb9049e4d7d330185b9fdd22e4e471bf907b) commit.\n\n### [M.N-01] Mitigation of [M-03/Issue 4] uses non-standard return behaviors\nThe fix in [PR 14](https://github.com/fiatdao/veFDT/pull/14/files/b9afd265fac9b3b3a3dc1440d47f421a41ff9639) for [M-03](https://github.com/code-423n4/2022-08-fiatdao-findings/issues/254) incorrectly returns the result of a non-return-valued function in another non-return-valued function. While the code compiles and works, it's confusing to see a function returning the result of a function that has no return values.\n\n#### Proof of Concept\n```solidity\n554      // See IVotingEscrow for documentation\n555      function delegate(address _addr)\n556          external\n557          override\n558          nonReentrant\n559          checkBlocklist\n560      {\n561          // Different restrictions apply to undelegation\n562          if (_addr == msg.sender) {\n563               return _undelegate();\n564          }\n```\nhttps://github.com/fiatdao/veFDT/blob/b9afd265fac9b3b3a3dc1440d47f421a41ff9639/contracts/VotingEscrow.sol#L554-L564\n\n#### Recommended Mitigation Steps\nMove the return to after the function call:\n```diff\n         // Different restrictions apply to undelegation\n         if (_addr == msg.sender) {\n-             return _undelegate();\n+             _undelegate();\n+             return;\n         }\n```\n\n#### Remediation\nThe sponsor properly addressed the issue with [PR 20](https://github.com/fiatdao/veFDT/pull/20/commits/0ff1b23caff9a774cac611f9189f10e1e4511dd9).\n\n## Final changes\nAll of the contest-related issue commits were properly combined into [PR 21](https://github.com/fiatdao/veFDT/pull/21/files/e2bb845795c9204842f5d3328925d864cb6f31ab), along with some minor, correct, comment changes, and appear as https://github.com/fiatdao/veFDT/commit/4e80f80786bd8143c2e5b59ac2f66f99bb589094. The PRs for the non-contest issues and their mitigations were combined into [PR 22](https://github.com/fiatdao/veFDT/pull/22/commits/0447eb9049e4d7d330185b9fdd22e4e471bf907b), and the final repository state is https://github.com/fiatdao/veFDT/tree/3f822125e05e2927eab0a3a3e797508b363083ab.\n\n\n\n***\n\n# Disclosures\n\nC4 is an open organization governed by participants in the community.\n\nC4 Contests incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Contest submissions are judged by a knowledgeable security researcher and solidity developer and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\n\nC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\n"
}